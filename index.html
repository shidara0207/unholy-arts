<!DOCTYPE html>
<html data-init="no-js">
<head>
<meta charset="UTF-8" />
<title>Unholy Arts v0.3</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!--

SugarCube (v2.30.0): A free (gratis and libre) story format.

Copyright © 2013–2019 Thomas Michael Edwards <thomasmedwards@gmail.com>.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

1. Redistributions of source code must retain the above copyright notice, this
   list of conditions and the following disclaimer.
2. Redistributions in binary form must reproduce the above copyright notice,
   this list of conditions and the following disclaimer in the documentation
   and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

-->
<script id="script-libraries" type="text/javascript">
if(document.head&&document.addEventListener&&document.querySelector&&Object.create&&Object.freeze&&JSON){document.documentElement.setAttribute("data-init", "loading");
/*! @source http://purl.eligrey.com/github/classList.js/blob/master/classList.js */
if("document" in self){if(!("classList" in document.createElement("_"))){(function(j){"use strict";if(!("Element" in j)){return}var a="classList",f="prototype",m=j.Element[f],b=Object,k=String[f].trim||function(){return this.replace(/^\s+|\s+$/g,"")},c=Array[f].indexOf||function(q){var p=0,o=this.length;for(;p<o;p++){if(p in this&&this[p]===q){return p}}return -1},n=function(o,p){this.name=o;this.code=DOMException[o];this.message=p},g=function(p,o){if(o===""){throw new n("SYNTAX_ERR","An invalid or illegal string was specified")}if(/\s/.test(o)){throw new n("INVALID_CHARACTER_ERR","String contains an invalid character")}return c.call(p,o)},d=function(s){var r=k.call(s.getAttribute("class")||""),q=r?r.split(/\s+/):[],p=0,o=q.length;for(;p<o;p++){this.push(q[p])}this._updateClassName=function(){s.setAttribute("class",this.toString())}},e=d[f]=[],i=function(){return new d(this)};n[f]=Error[f];e.item=function(o){return this[o]||null};e.contains=function(o){o+="";return g(this,o)!==-1};e.add=function(){var s=arguments,r=0,p=s.length,q,o=false;do{q=s[r]+"";if(g(this,q)===-1){this.push(q);o=true}}while(++r<p);if(o){this._updateClassName()}};e.remove=function(){var t=arguments,s=0,p=t.length,r,o=false,q;do{r=t[s]+"";q=g(this,r);while(q!==-1){this.splice(q,1);o=true;q=g(this,r)}}while(++s<p);if(o){this._updateClassName()}};e.toggle=function(p,q){p+="";var o=this.contains(p),r=o?q!==true&&"remove":q!==false&&"add";if(r){this[r](p)}if(q===true||q===false){return q}else{return !o}};e.toString=function(){return this.join(" ")};if(b.defineProperty){var l={get:i,enumerable:true,configurable:true};try{b.defineProperty(m,a,l)}catch(h){if(h.number===-2146823252){l.enumerable=false;b.defineProperty(m,a,l)}}}else{if(b[f].__defineGetter__){m.__defineGetter__(a,i)}}}(self))}else{(function(){var b=document.createElement("_");b.classList.add("c1","c2");if(!b.classList.contains("c2")){var c=function(e){var d=DOMTokenList.prototype[e];DOMTokenList.prototype[e]=function(h){var g,f=arguments.length;for(g=0;g<f;g++){h=arguments[g];d.call(this,h)}}};c("add");c("remove")}b.classList.toggle("c3",false);if(b.classList.contains("c3")){var a=DOMTokenList.prototype.toggle;DOMTokenList.prototype.toggle=function(d,e){if(1 in arguments&&!this.contains(d)===!e){return e}else{return a.call(this,d)}}}b=null}())}};
/*!
 * https://github.com/es-shims/es5-shim
 * @license es5-shim Copyright 2009-2015 by contributors, MIT License
 * see https://github.com/es-shims/es5-shim/blob/v4.5.13/LICENSE
 */
(function(t,r){"use strict";if(typeof define==="function"&&define.amd){define(r)}else if(typeof exports==="object"){module.exports=r()}else{t.returnExports=r()}})(this,function(){var t=Array;var r=t.prototype;var e=Object;var n=e.prototype;var i=Function;var a=i.prototype;var o=String;var f=o.prototype;var u=Number;var l=u.prototype;var s=r.slice;var c=r.splice;var v=r.push;var h=r.unshift;var p=r.concat;var y=r.join;var d=a.call;var g=a.apply;var w=Math.max;var b=Math.min;var T=n.toString;var m=typeof Symbol==="function"&&typeof Symbol.toStringTag==="symbol";var D;var S=Function.prototype.toString,x=/^\s*class /,O=function isES6ClassFn(t){try{var r=S.call(t);var e=r.replace(/\/\/.*\n/g,"");var n=e.replace(/\/\*[.\s\S]*\*\//g,"");var i=n.replace(/\n/gm," ").replace(/ {2}/g," ");return x.test(i)}catch(a){return false}},E=function tryFunctionObject(t){try{if(O(t)){return false}S.call(t);return true}catch(r){return false}},j="[object Function]",I="[object GeneratorFunction]",D=function isCallable(t){if(!t){return false}if(typeof t!=="function"&&typeof t!=="object"){return false}if(m){return E(t)}if(O(t)){return false}var r=T.call(t);return r===j||r===I};var M;var U=RegExp.prototype.exec,$=function tryRegexExec(t){try{U.call(t);return true}catch(r){return false}},F="[object RegExp]";M=function isRegex(t){if(typeof t!=="object"){return false}return m?$(t):T.call(t)===F};var N;var C=String.prototype.valueOf,k=function tryStringObject(t){try{C.call(t);return true}catch(r){return false}},A="[object String]";N=function isString(t){if(typeof t==="string"){return true}if(typeof t!=="object"){return false}return m?k(t):T.call(t)===A};var R=e.defineProperty&&function(){try{var t={};e.defineProperty(t,"x",{enumerable:false,value:t});for(var r in t){return false}return t.x===t}catch(n){return false}}();var P=function(t){var r;if(R){r=function(t,r,n,i){if(!i&&r in t){return}e.defineProperty(t,r,{configurable:true,enumerable:false,writable:true,value:n})}}else{r=function(t,r,e,n){if(!n&&r in t){return}t[r]=e}}return function defineProperties(e,n,i){for(var a in n){if(t.call(n,a)){r(e,a,n[a],i)}}}}(n.hasOwnProperty);var J=function isPrimitive(t){var r=typeof t;return t===null||r!=="object"&&r!=="function"};var Y=u.isNaN||function isActualNaN(t){return t!==t};var z={ToInteger:function ToInteger(t){var r=+t;if(Y(r)){r=0}else if(r!==0&&r!==1/0&&r!==-(1/0)){r=(r>0||-1)*Math.floor(Math.abs(r))}return r},ToPrimitive:function ToPrimitive(t){var r,e,n;if(J(t)){return t}e=t.valueOf;if(D(e)){r=e.call(t);if(J(r)){return r}}n=t.toString;if(D(n)){r=n.call(t);if(J(r)){return r}}throw new TypeError},ToObject:function(t){if(t==null){throw new TypeError("can't convert "+t+" to object")}return e(t)},ToUint32:function ToUint32(t){return t>>>0}};var Z=function Empty(){};P(a,{bind:function bind(t){var r=this;if(!D(r)){throw new TypeError("Function.prototype.bind called on incompatible "+r)}var n=s.call(arguments,1);var a;var o=function(){if(this instanceof a){var i=g.call(r,this,p.call(n,s.call(arguments)));if(e(i)===i){return i}return this}else{return g.call(r,t,p.call(n,s.call(arguments)))}};var f=w(0,r.length-n.length);var u=[];for(var l=0;l<f;l++){v.call(u,"$"+l)}a=i("binder","return function ("+y.call(u,",")+"){ return binder.apply(this, arguments); }")(o);if(r.prototype){Z.prototype=r.prototype;a.prototype=new Z;Z.prototype=null}return a}});var G=d.bind(n.hasOwnProperty);var H=d.bind(n.toString);var W=d.bind(s);var B=g.bind(s);if(typeof document==="object"&&document&&document.documentElement){try{W(document.documentElement.childNodes)}catch(X){var L=W;var q=B;W=function arraySliceIE(t){var r=[];var e=t.length;while(e-- >0){r[e]=t[e]}return q(r,L(arguments,1))};B=function arraySliceApplyIE(t,r){return q(W(t),r)}}}var K=d.bind(f.slice);var Q=d.bind(f.split);var V=d.bind(f.indexOf);var _=d.bind(v);var tt=d.bind(n.propertyIsEnumerable);var rt=d.bind(r.sort);var et=t.isArray||function isArray(t){return H(t)==="[object Array]"};var nt=[].unshift(0)!==1;P(r,{unshift:function(){h.apply(this,arguments);return this.length}},nt);P(t,{isArray:et});var it=e("a");var at=it[0]!=="a"||!(0 in it);var ot=function properlyBoxed(t){var r=true;var e=true;var n=false;if(t){try{t.call("foo",function(t,e,n){if(typeof n!=="object"){r=false}});t.call([1],function(){"use strict";e=typeof this==="string"},"x")}catch(i){n=true}}return!!t&&!n&&r&&e};P(r,{forEach:function forEach(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=-1;var i=z.ToUint32(e.length);var a;if(arguments.length>1){a=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.forEach callback must be a function")}while(++n<i){if(n in e){if(typeof a==="undefined"){t(e[n],n,r)}else{t.call(a,e[n],n,r)}}}}},!ot(r.forEach));P(r,{map:function map(r){var e=z.ToObject(this);var n=at&&N(this)?Q(this,""):e;var i=z.ToUint32(n.length);var a=t(i);var o;if(arguments.length>1){o=arguments[1]}if(!D(r)){throw new TypeError("Array.prototype.map callback must be a function")}for(var f=0;f<i;f++){if(f in n){if(typeof o==="undefined"){a[f]=r(n[f],f,e)}else{a[f]=r.call(o,n[f],f,e)}}}return a}},!ot(r.map));P(r,{filter:function filter(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);var i=[];var a;var o;if(arguments.length>1){o=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.filter callback must be a function")}for(var f=0;f<n;f++){if(f in e){a=e[f];if(typeof o==="undefined"?t(a,f,r):t.call(o,a,f,r)){_(i,a)}}}return i}},!ot(r.filter));P(r,{every:function every(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);var i;if(arguments.length>1){i=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.every callback must be a function")}for(var a=0;a<n;a++){if(a in e&&!(typeof i==="undefined"?t(e[a],a,r):t.call(i,e[a],a,r))){return false}}return true}},!ot(r.every));P(r,{some:function some(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);var i;if(arguments.length>1){i=arguments[1]}if(!D(t)){throw new TypeError("Array.prototype.some callback must be a function")}for(var a=0;a<n;a++){if(a in e&&(typeof i==="undefined"?t(e[a],a,r):t.call(i,e[a],a,r))){return true}}return false}},!ot(r.some));var ft=false;if(r.reduce){ft=typeof r.reduce.call("es5",function(t,r,e,n){return n})==="object"}P(r,{reduce:function reduce(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);if(!D(t)){throw new TypeError("Array.prototype.reduce callback must be a function")}if(n===0&&arguments.length===1){throw new TypeError("reduce of empty array with no initial value")}var i=0;var a;if(arguments.length>=2){a=arguments[1]}else{do{if(i in e){a=e[i++];break}if(++i>=n){throw new TypeError("reduce of empty array with no initial value")}}while(true)}for(;i<n;i++){if(i in e){a=t(a,e[i],i,r)}}return a}},!ft);var ut=false;if(r.reduceRight){ut=typeof r.reduceRight.call("es5",function(t,r,e,n){return n})==="object"}P(r,{reduceRight:function reduceRight(t){var r=z.ToObject(this);var e=at&&N(this)?Q(this,""):r;var n=z.ToUint32(e.length);if(!D(t)){throw new TypeError("Array.prototype.reduceRight callback must be a function")}if(n===0&&arguments.length===1){throw new TypeError("reduceRight of empty array with no initial value")}var i;var a=n-1;if(arguments.length>=2){i=arguments[1]}else{do{if(a in e){i=e[a--];break}if(--a<0){throw new TypeError("reduceRight of empty array with no initial value")}}while(true)}if(a<0){return i}do{if(a in e){i=t(i,e[a],a,r)}}while(a--);return i}},!ut);var lt=r.indexOf&&[0,1].indexOf(1,2)!==-1;P(r,{indexOf:function indexOf(t){var r=at&&N(this)?Q(this,""):z.ToObject(this);var e=z.ToUint32(r.length);if(e===0){return-1}var n=0;if(arguments.length>1){n=z.ToInteger(arguments[1])}n=n>=0?n:w(0,e+n);for(;n<e;n++){if(n in r&&r[n]===t){return n}}return-1}},lt);var st=r.lastIndexOf&&[0,1].lastIndexOf(0,-3)!==-1;P(r,{lastIndexOf:function lastIndexOf(t){var r=at&&N(this)?Q(this,""):z.ToObject(this);var e=z.ToUint32(r.length);if(e===0){return-1}var n=e-1;if(arguments.length>1){n=b(n,z.ToInteger(arguments[1]))}n=n>=0?n:e-Math.abs(n);for(;n>=0;n--){if(n in r&&t===r[n]){return n}}return-1}},st);var ct=function(){var t=[1,2];var r=t.splice();return t.length===2&&et(r)&&r.length===0}();P(r,{splice:function splice(t,r){if(arguments.length===0){return[]}else{return c.apply(this,arguments)}}},!ct);var vt=function(){var t={};r.splice.call(t,0,0,1);return t.length===1}();P(r,{splice:function splice(t,r){if(arguments.length===0){return[]}var e=arguments;this.length=w(z.ToInteger(this.length),0);if(arguments.length>0&&typeof r!=="number"){e=W(arguments);if(e.length<2){_(e,this.length-t)}else{e[1]=z.ToInteger(r)}}return c.apply(this,e)}},!vt);var ht=function(){var r=new t(1e5);r[8]="x";r.splice(1,1);return r.indexOf("x")===7}();var pt=function(){var t=256;var r=[];r[t]="a";r.splice(t+1,0,"b");return r[t]==="a"}();P(r,{splice:function splice(t,r){var e=z.ToObject(this);var n=[];var i=z.ToUint32(e.length);var a=z.ToInteger(t);var f=a<0?w(i+a,0):b(a,i);var u=b(w(z.ToInteger(r),0),i-f);var l=0;var s;while(l<u){s=o(f+l);if(G(e,s)){n[l]=e[s]}l+=1}var c=W(arguments,2);var v=c.length;var h;if(v<u){l=f;var p=i-u;while(l<p){s=o(l+u);h=o(l+v);if(G(e,s)){e[h]=e[s]}else{delete e[h]}l+=1}l=i;var y=i-u+v;while(l>y){delete e[l-1];l-=1}}else if(v>u){l=i-u;while(l>f){s=o(l+u-1);h=o(l+v-1);if(G(e,s)){e[h]=e[s]}else{delete e[h]}l-=1}}l=f;for(var d=0;d<c.length;++d){e[l]=c[d];l+=1}e.length=i-u+v;return n}},!ht||!pt);var yt=r.join;var dt;try{dt=Array.prototype.join.call("123",",")!=="1,2,3"}catch(X){dt=true}if(dt){P(r,{join:function join(t){var r=typeof t==="undefined"?",":t;return yt.call(N(this)?Q(this,""):this,r)}},dt)}var gt=[1,2].join(undefined)!=="1,2";if(gt){P(r,{join:function join(t){var r=typeof t==="undefined"?",":t;return yt.call(this,r)}},gt)}var wt=function push(t){var r=z.ToObject(this);var e=z.ToUint32(r.length);var n=0;while(n<arguments.length){r[e+n]=arguments[n];n+=1}r.length=e+n;return e+n};var bt=function(){var t={};var r=Array.prototype.push.call(t,undefined);return r!==1||t.length!==1||typeof t[0]!=="undefined"||!G(t,0)}();P(r,{push:function push(t){if(et(this)){return v.apply(this,arguments)}return wt.apply(this,arguments)}},bt);var Tt=function(){var t=[];var r=t.push(undefined);return r!==1||t.length!==1||typeof t[0]!=="undefined"||!G(t,0)}();P(r,{push:wt},Tt);P(r,{slice:function(t,r){var e=N(this)?Q(this,""):this;return B(e,arguments)}},at);var mt=function(){try{[1,2].sort(null)}catch(t){try{[1,2].sort({})}catch(r){return false}}return true}();var Dt=function(){try{[1,2].sort(/a/);return false}catch(t){}return true}();var St=function(){try{[1,2].sort(undefined);return true}catch(t){}return false}();P(r,{sort:function sort(t){if(typeof t==="undefined"){return rt(this)}if(!D(t)){throw new TypeError("Array.prototype.sort callback must be a function")}return rt(this,t)}},mt||!St||!Dt);var xt=!tt({toString:null},"toString");var Ot=tt(function(){},"prototype");var Et=!G("x","0");var jt=function(t){var r=t.constructor;return r&&r.prototype===t};var It={$applicationCache:true,$console:true,$external:true,$frame:true,$frameElement:true,$frames:true,$innerHeight:true,$innerWidth:true,$onmozfullscreenchange:true,$onmozfullscreenerror:true,$outerHeight:true,$outerWidth:true,$pageXOffset:true,$pageYOffset:true,$parent:true,$scrollLeft:true,$scrollTop:true,$scrollX:true,$scrollY:true,$self:true,$webkitIndexedDB:true,$webkitStorageInfo:true,$window:true,$width:true,$height:true,$top:true,$localStorage:true};var Mt=function(){if(typeof window==="undefined"){return false}for(var t in window){try{if(!It["$"+t]&&G(window,t)&&window[t]!==null&&typeof window[t]==="object"){jt(window[t])}}catch(r){return true}}return false}();var Ut=function(t){if(typeof window==="undefined"||!Mt){return jt(t)}try{return jt(t)}catch(r){return false}};var $t=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];var Ft=$t.length;var Nt=function isArguments(t){return H(t)==="[object Arguments]"};var Ct=function isArguments(t){return t!==null&&typeof t==="object"&&typeof t.length==="number"&&t.length>=0&&!et(t)&&D(t.callee)};var kt=Nt(arguments)?Nt:Ct;P(e,{keys:function keys(t){var r=D(t);var e=kt(t);var n=t!==null&&typeof t==="object";var i=n&&N(t);if(!n&&!r&&!e){throw new TypeError("Object.keys called on a non-object")}var a=[];var f=Ot&&r;if(i&&Et||e){for(var u=0;u<t.length;++u){_(a,o(u))}}if(!e){for(var l in t){if(!(f&&l==="prototype")&&G(t,l)){_(a,o(l))}}}if(xt){var s=Ut(t);for(var c=0;c<Ft;c++){var v=$t[c];if(!(s&&v==="constructor")&&G(t,v)){_(a,v)}}}return a}});var At=e.keys&&function(){return e.keys(arguments).length===2}(1,2);var Rt=e.keys&&function(){var t=e.keys(arguments);return arguments.length!==1||t.length!==1||t[0]!==1}(1);var Pt=e.keys;P(e,{keys:function keys(t){if(kt(t)){return Pt(W(t))}else{return Pt(t)}}},!At||Rt);var Jt=new Date(-0xc782b5b342b24).getUTCMonth()!==0;var Yt=new Date(-0x55d318d56a724);var zt=new Date(14496624e5);var Zt=Yt.toUTCString()!=="Mon, 01 Jan -45875 11:59:59 GMT";var Gt;var Ht;var Wt=Yt.getTimezoneOffset();if(Wt<-720){Gt=Yt.toDateString()!=="Tue Jan 02 -45875";Ht=!/^Thu Dec 10 2015 \d\d:\d\d:\d\d GMT[-+]\d\d\d\d(?: |$)/.test(String(zt))}else{Gt=Yt.toDateString()!=="Mon Jan 01 -45875";Ht=!/^Wed Dec 09 2015 \d\d:\d\d:\d\d GMT[-+]\d\d\d\d(?: |$)/.test(String(zt))}var Bt=d.bind(Date.prototype.getFullYear);var Xt=d.bind(Date.prototype.getMonth);var Lt=d.bind(Date.prototype.getDate);var qt=d.bind(Date.prototype.getUTCFullYear);var Kt=d.bind(Date.prototype.getUTCMonth);var Qt=d.bind(Date.prototype.getUTCDate);var Vt=d.bind(Date.prototype.getUTCDay);var _t=d.bind(Date.prototype.getUTCHours);var tr=d.bind(Date.prototype.getUTCMinutes);var rr=d.bind(Date.prototype.getUTCSeconds);var er=d.bind(Date.prototype.getUTCMilliseconds);var nr=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var ir=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var ar=function daysInMonth(t,r){return Lt(new Date(r,t,0))};P(Date.prototype,{getFullYear:function getFullYear(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);if(t<0&&Xt(this)>11){return t+1}return t},getMonth:function getMonth(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);var r=Xt(this);if(t<0&&r>11){return 0}return r},getDate:function getDate(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Bt(this);var r=Xt(this);var e=Lt(this);if(t<0&&r>11){if(r===12){return e}var n=ar(0,t+1);return n-e+1}return e},getUTCFullYear:function getUTCFullYear(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=qt(this);if(t<0&&Kt(this)>11){return t+1}return t},getUTCMonth:function getUTCMonth(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=qt(this);var r=Kt(this);if(t<0&&r>11){return 0}return r},getUTCDate:function getUTCDate(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=qt(this);var r=Kt(this);var e=Qt(this);if(t<0&&r>11){if(r===12){return e}var n=ar(0,t+1);return n-e+1}return e}},Jt);P(Date.prototype,{toUTCString:function toUTCString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=Vt(this);var r=Qt(this);var e=Kt(this);var n=qt(this);var i=_t(this);var a=tr(this);var o=rr(this);return nr[t]+", "+(r<10?"0"+r:r)+" "+ir[e]+" "+n+" "+(i<10?"0"+i:i)+":"+(a<10?"0"+a:a)+":"+(o<10?"0"+o:o)+" GMT"}},Jt||Zt);P(Date.prototype,{toDateString:function toDateString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=this.getDay();var r=this.getDate();var e=this.getMonth();var n=this.getFullYear();return nr[t]+" "+ir[e]+" "+(r<10?"0"+r:r)+" "+n}},Jt||Gt);if(Jt||Ht){Date.prototype.toString=function toString(){if(!this||!(this instanceof Date)){throw new TypeError("this is not a Date object.")}var t=this.getDay();var r=this.getDate();var e=this.getMonth();var n=this.getFullYear();var i=this.getHours();var a=this.getMinutes();var o=this.getSeconds();var f=this.getTimezoneOffset();var u=Math.floor(Math.abs(f)/60);var l=Math.floor(Math.abs(f)%60);return nr[t]+" "+ir[e]+" "+(r<10?"0"+r:r)+" "+n+" "+(i<10?"0"+i:i)+":"+(a<10?"0"+a:a)+":"+(o<10?"0"+o:o)+" GMT"+(f>0?"-":"+")+(u<10?"0"+u:u)+(l<10?"0"+l:l)};if(R){e.defineProperty(Date.prototype,"toString",{configurable:true,enumerable:false,writable:true})}}var or=-621987552e5;var fr="-000001";var ur=Date.prototype.toISOString&&new Date(or).toISOString().indexOf(fr)===-1;var lr=Date.prototype.toISOString&&new Date(-1).toISOString()!=="1969-12-31T23:59:59.999Z";var sr=d.bind(Date.prototype.getTime);P(Date.prototype,{toISOString:function toISOString(){if(!isFinite(this)||!isFinite(sr(this))){throw new RangeError("Date.prototype.toISOString called on non-finite value.")}var t=qt(this);var r=Kt(this);t+=Math.floor(r/12);r=(r%12+12)%12;var e=[r+1,Qt(this),_t(this),tr(this),rr(this)];t=(t<0?"-":t>9999?"+":"")+K("00000"+Math.abs(t),0<=t&&t<=9999?-4:-6);for(var n=0;n<e.length;++n){e[n]=K("00"+e[n],-2)}return t+"-"+W(e,0,2).join("-")+"T"+W(e,2).join(":")+"."+K("000"+er(this),-3)+"Z"}},ur||lr);var cr=function(){try{return Date.prototype.toJSON&&new Date(NaN).toJSON()===null&&new Date(or).toJSON().indexOf(fr)!==-1&&Date.prototype.toJSON.call({toISOString:function(){return true}})}catch(t){return false}}();if(!cr){Date.prototype.toJSON=function toJSON(t){var r=e(this);var n=z.ToPrimitive(r);if(typeof n==="number"&&!isFinite(n)){return null}var i=r.toISOString;if(!D(i)){throw new TypeError("toISOString property is not callable")}return i.call(r)}}var vr=Date.parse("+033658-09-27T01:46:40.000Z")===1e15;var hr=!isNaN(Date.parse("2012-04-04T24:00:00.500Z"))||!isNaN(Date.parse("2012-11-31T23:59:59.000Z"))||!isNaN(Date.parse("2012-12-31T23:59:60.000Z"));var pr=isNaN(Date.parse("2000-01-01T00:00:00.000Z"));if(pr||hr||!vr){var yr=Math.pow(2,31)-1;var dr=Y(new Date(1970,0,1,0,0,0,yr+1).getTime());Date=function(t){var r=function Date(e,n,i,a,f,u,l){var s=arguments.length;var c;if(this instanceof t){var v=u;var h=l;if(dr&&s>=7&&l>yr){var p=Math.floor(l/yr)*yr;var y=Math.floor(p/1e3);v+=y;h-=y*1e3}c=s===1&&o(e)===e?new t(r.parse(e)):s>=7?new t(e,n,i,a,f,v,h):s>=6?new t(e,n,i,a,f,v):s>=5?new t(e,n,i,a,f):s>=4?new t(e,n,i,a):s>=3?new t(e,n,i):s>=2?new t(e,n):s>=1?new t(e instanceof t?+e:e):new t}else{c=t.apply(this,arguments)}if(!J(c)){P(c,{constructor:r},true)}return c};var e=new RegExp("^"+"(\\d{4}|[+-]\\d{6})"+"(?:-(\\d{2})"+"(?:-(\\d{2})"+"(?:"+"T(\\d{2})"+":(\\d{2})"+"(?:"+":(\\d{2})"+"(?:(\\.\\d{1,}))?"+")?"+"("+"Z|"+"(?:"+"([-+])"+"(\\d{2})"+":(\\d{2})"+")"+")?)?)?)?"+"$");var n=[0,31,59,90,120,151,181,212,243,273,304,334,365];var i=function dayFromMonth(t,r){var e=r>1?1:0;return n[r]+Math.floor((t-1969+e)/4)-Math.floor((t-1901+e)/100)+Math.floor((t-1601+e)/400)+365*(t-1970)};var a=function toUTC(r){var e=0;var n=r;if(dr&&n>yr){var i=Math.floor(n/yr)*yr;var a=Math.floor(i/1e3);e+=a;n-=a*1e3}return u(new t(1970,0,1,0,0,e,n))};for(var f in t){if(G(t,f)){r[f]=t[f]}}P(r,{now:t.now,UTC:t.UTC},true);r.prototype=t.prototype;P(r.prototype,{constructor:r},true);var l=function parse(r){var n=e.exec(r);if(n){var o=u(n[1]),f=u(n[2]||1)-1,l=u(n[3]||1)-1,s=u(n[4]||0),c=u(n[5]||0),v=u(n[6]||0),h=Math.floor(u(n[7]||0)*1e3),p=Boolean(n[4]&&!n[8]),y=n[9]==="-"?1:-1,d=u(n[10]||0),g=u(n[11]||0),w;var b=c>0||v>0||h>0;if(s<(b?24:25)&&c<60&&v<60&&h<1e3&&f>-1&&f<12&&d<24&&g<60&&l>-1&&l<i(o,f+1)-i(o,f)){w=((i(o,f)+l)*24+s+d*y)*60;w=((w+c+g*y)*60+v)*1e3+h;if(p){w=a(w)}if(-864e13<=w&&w<=864e13){return w}}return NaN}return t.parse.apply(this,arguments)};P(r,{parse:l});return r}(Date)}if(!Date.now){Date.now=function now(){return(new Date).getTime()}}var gr=l.toFixed&&(8e-5.toFixed(3)!=="0.000"||.9.toFixed(0)!=="1"||1.255.toFixed(2)!=="1.25"||(1000000000000000128).toFixed(0)!=="1000000000000000128");var wr={base:1e7,size:6,data:[0,0,0,0,0,0],multiply:function multiply(t,r){var e=-1;var n=r;while(++e<wr.size){n+=t*wr.data[e];wr.data[e]=n%wr.base;n=Math.floor(n/wr.base)}},divide:function divide(t){var r=wr.size;var e=0;while(--r>=0){e+=wr.data[r];wr.data[r]=Math.floor(e/t);e=e%t*wr.base}},numToString:function numToString(){var t=wr.size;var r="";while(--t>=0){if(r!==""||t===0||wr.data[t]!==0){var e=o(wr.data[t]);if(r===""){r=e}else{r+=K("0000000",0,7-e.length)+e}}}return r},pow:function pow(t,r,e){return r===0?e:r%2===1?pow(t,r-1,e*t):pow(t*t,r/2,e)},log:function log(t){var r=0;var e=t;while(e>=4096){r+=12;e/=4096}while(e>=2){r+=1;e/=2}return r}};var br=function toFixed(t){var r,e,n,i,a,f,l,s;r=u(t);r=Y(r)?0:Math.floor(r);if(r<0||r>20){throw new RangeError("Number.toFixed called with invalid number of decimals")}e=u(this);if(Y(e)){return"NaN"}if(e<=-1e21||e>=1e21){return o(e)}n="";if(e<0){n="-";e=-e}i="0";if(e>1e-21){a=wr.log(e*wr.pow(2,69,1))-69;f=a<0?e*wr.pow(2,-a,1):e/wr.pow(2,a,1);f*=4503599627370496;a=52-a;if(a>0){wr.multiply(0,f);l=r;while(l>=7){wr.multiply(1e7,0);l-=7}wr.multiply(wr.pow(10,l,1),0);l=a-1;while(l>=23){wr.divide(1<<23);l-=23}wr.divide(1<<l);wr.multiply(1,1);wr.divide(2);i=wr.numToString()}else{wr.multiply(0,f);wr.multiply(1<<-a,0);i=wr.numToString()+K("0.00000000000000000000",2,2+r)}}if(r>0){s=i.length;if(s<=r){i=n+K("0.0000000000000000000",0,r-s+2)+i}else{i=n+K(i,0,s-r)+"."+K(i,s-r)}}else{i=n+i}return i};P(l,{toFixed:br},gr);var Tr=function(){try{return 1..toPrecision(undefined)==="1"}catch(t){return true}}();var mr=l.toPrecision;P(l,{toPrecision:function toPrecision(t){return typeof t==="undefined"?mr.call(this):mr.call(this,t)}},Tr);if("ab".split(/(?:ab)*/).length!==2||".".split(/(.?)(.?)/).length!==4||"tesst".split(/(s)*/)[1]==="t"||"test".split(/(?:)/,-1).length!==4||"".split(/.?/).length||".".split(/()()/).length>1){(function(){var t=typeof/()??/.exec("")[1]==="undefined";var r=Math.pow(2,32)-1;f.split=function(e,n){var i=String(this);if(typeof e==="undefined"&&n===0){return[]}if(!M(e)){return Q(this,e,n)}var a=[];var o=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),f=0,u,l,s,c;var h=new RegExp(e.source,o+"g");if(!t){u=new RegExp("^"+h.source+"$(?!\\s)",o)}var p=typeof n==="undefined"?r:z.ToUint32(n);l=h.exec(i);while(l){s=l.index+l[0].length;if(s>f){_(a,K(i,f,l.index));if(!t&&l.length>1){l[0].replace(u,function(){for(var t=1;t<arguments.length-2;t++){if(typeof arguments[t]==="undefined"){l[t]=void 0}}})}if(l.length>1&&l.index<i.length){v.apply(a,W(l,1))}c=l[0].length;f=s;if(a.length>=p){break}}if(h.lastIndex===l.index){h.lastIndex++}l=h.exec(i)}if(f===i.length){if(c||!h.test("")){_(a,"")}}else{_(a,K(i,f))}return a.length>p?W(a,0,p):a}})()}else if("0".split(void 0,0).length){f.split=function split(t,r){if(typeof t==="undefined"&&r===0){return[]}return Q(this,t,r)}}var Dr=f.replace;var Sr=function(){var t=[];"x".replace(/x(.)?/g,function(r,e){_(t,e)});return t.length===1&&typeof t[0]==="undefined"}();if(!Sr){f.replace=function replace(t,r){var e=D(r);var n=M(t)&&/\)[*?]/.test(t.source);if(!e||!n){return Dr.call(this,t,r)}else{var i=function(e){var n=arguments.length;var i=t.lastIndex;t.lastIndex=0;var a=t.exec(e)||[];t.lastIndex=i;_(a,arguments[n-2],arguments[n-1]);return r.apply(this,a)};return Dr.call(this,t,i)}}}var xr=f.substr;var Or="".substr&&"0b".substr(-1)!=="b";P(f,{substr:function substr(t,r){var e=t;if(t<0){e=w(this.length+t,0)}return xr.call(this,e,r)}},Or);var Er="\t\n\x0B\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003"+"\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028"+"\u2029\ufeff";var jr="\u200b";var Ir="["+Er+"]";var Mr=new RegExp("^"+Ir+Ir+"*");var Ur=new RegExp(Ir+Ir+"*$");var $r=f.trim&&(Er.trim()||!jr.trim());P(f,{trim:function trim(){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}return o(this).replace(Mr,"").replace(Ur,"")}},$r);var Fr=d.bind(String.prototype.trim);var Nr=f.lastIndexOf&&"abc\u3042\u3044".lastIndexOf("\u3042\u3044",2)!==-1;P(f,{lastIndexOf:function lastIndexOf(t){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}var r=o(this);var e=o(t);var n=arguments.length>1?u(arguments[1]):NaN;var i=Y(n)?Infinity:z.ToInteger(n);var a=b(w(i,0),r.length);var f=e.length;var l=a+f;while(l>0){l=w(0,l-f);var s=V(K(r,l,a+f),e);if(s!==-1){return l+s}}return-1}},Nr);var Cr=f.lastIndexOf;P(f,{lastIndexOf:function lastIndexOf(t){return Cr.apply(this,arguments)}},f.lastIndexOf.length!==1);if(parseInt(Er+"08")!==8||parseInt(Er+"0x16")!==22){parseInt=function(t){var r=/^[-+]?0[xX]/;return function parseInt(e,n){if(typeof e==="symbol"){""+e}var i=Fr(String(e));var a=u(n)||(r.test(i)?16:10);return t(i,a)}}(parseInt)}if(1/parseFloat("-0")!==-Infinity){parseFloat=function(t){return function parseFloat(r){var e=Fr(String(r));var n=t(e);return n===0&&K(e,0,1)==="-"?-0:n}}(parseFloat)}if(String(new RangeError("test"))!=="RangeError: test"){var kr=function toString(){if(typeof this==="undefined"||this===null){throw new TypeError("can't convert "+this+" to object")}var t=this.name;if(typeof t==="undefined"){t="Error"}else if(typeof t!=="string"){t=o(t)}var r=this.message;if(typeof r==="undefined"){r=""}else if(typeof r!=="string"){r=o(r)}if(!t){return r}if(!r){return t}return t+": "+r};Error.prototype.toString=kr}if(R){var Ar=function(t,r){if(tt(t,r)){var e=Object.getOwnPropertyDescriptor(t,r);if(e.configurable){e.enumerable=false;Object.defineProperty(t,r,e)}}};Ar(Error.prototype,"message");if(Error.prototype.message!==""){Error.prototype.message=""}Ar(Error.prototype,"name")}if(String(/a/gim)!=="/a/gim"){var Rr=function toString(){var t="/"+this.source+"/";if(this.global){t+="g"}if(this.ignoreCase){t+="i"}if(this.multiline){t+="m"}return t};RegExp.prototype.toString=Rr}});
//# sourceMappingURL=es5-shim.map
/*!
 * https://github.com/paulmillr/es6-shim
 * @license es6-shim Copyright 2013-2016 by Paul Miller (http://paulmillr.com)
 *   and contributors,  MIT License
 * es6-shim: v0.35.4
 * see https://github.com/paulmillr/es6-shim/blob/0.35.4/LICENSE
 * Details and documentation:
 * https://github.com/paulmillr/es6-shim/
 */
(function(e,t){if(typeof define==="function"&&define.amd){define(t)}else if(typeof exports==="object"){module.exports=t()}else{e.returnExports=t()}})(this,function(){"use strict";var e=Function.call.bind(Function.apply);var t=Function.call.bind(Function.call);var r=Array.isArray;var n=Object.keys;var o=function notThunker(t){return function notThunk(){return!e(t,this,arguments)}};var i=function(e){try{e();return false}catch(t){return true}};var a=function valueOrFalseIfThrows(e){try{return e()}catch(t){return false}};var u=o(i);var f=function(){return!i(function(){return Object.defineProperty({},"x",{get:function(){}})})};var s=!!Object.defineProperty&&f();var c=function foo(){}.name==="foo";var l=Function.call.bind(Array.prototype.forEach);var p=Function.call.bind(Array.prototype.reduce);var v=Function.call.bind(Array.prototype.filter);var y=Function.call.bind(Array.prototype.some);var h=function(e,t,r,n){if(!n&&t in e){return}if(s){Object.defineProperty(e,t,{configurable:true,enumerable:false,writable:true,value:r})}else{e[t]=r}};var b=function(e,t,r){l(n(t),function(n){var o=t[n];h(e,n,o,!!r)})};var g=Function.call.bind(Object.prototype.toString);var d=typeof/abc/==="function"?function IsCallableSlow(e){return typeof e==="function"&&g(e)==="[object Function]"}:function IsCallableFast(e){return typeof e==="function"};var m={getter:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}Object.defineProperty(e,t,{configurable:true,enumerable:false,get:r})},proxy:function(e,t,r){if(!s){throw new TypeError("getters require true ES5 support")}var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,{configurable:n.configurable,enumerable:n.enumerable,get:function getKey(){return e[t]},set:function setKey(r){e[t]=r}})},redefine:function(e,t,r){if(s){var n=Object.getOwnPropertyDescriptor(e,t);n.value=r;Object.defineProperty(e,t,n)}else{e[t]=r}},defineByDescriptor:function(e,t,r){if(s){Object.defineProperty(e,t,r)}else if("value"in r){e[t]=r.value}},preserveToString:function(e,t){if(t&&d(t.toString)){h(e,"toString",t.toString.bind(t),true)}}};var O=Object.create||function(e,t){var r=function Prototype(){};r.prototype=e;var o=new r;if(typeof t!=="undefined"){n(t).forEach(function(e){m.defineByDescriptor(o,e,t[e])})}return o};var w=function(e,t){if(!Object.setPrototypeOf){return false}return a(function(){var r=function Subclass(t){var r=new e(t);Object.setPrototypeOf(r,Subclass.prototype);return r};Object.setPrototypeOf(r,e);r.prototype=O(e.prototype,{constructor:{value:r}});return t(r)})};var j=function(){if(typeof self!=="undefined"){return self}if(typeof window!=="undefined"){return window}if(typeof global!=="undefined"){return global}throw new Error("unable to locate global object")};var S=j();var T=S.isFinite;var I=Function.call.bind(String.prototype.indexOf);var E=Function.apply.bind(Array.prototype.indexOf);var P=Function.call.bind(Array.prototype.concat);var C=Function.call.bind(String.prototype.slice);var M=Function.call.bind(Array.prototype.push);var x=Function.apply.bind(Array.prototype.push);var N=Function.call.bind(Array.prototype.shift);var A=Math.max;var R=Math.min;var _=Math.floor;var k=Math.abs;var L=Math.exp;var F=Math.log;var D=Math.sqrt;var z=Function.call.bind(Object.prototype.hasOwnProperty);var q;var W=function(){};var G=S.Map;var H=G&&G.prototype["delete"];var V=G&&G.prototype.get;var B=G&&G.prototype.has;var U=G&&G.prototype.set;var $=S.Symbol||{};var J=$.species||"@@species";var X=Number.isNaN||function isNaN(e){return e!==e};var K=Number.isFinite||function isFinite(e){return typeof e==="number"&&T(e)};var Z=d(Math.sign)?Math.sign:function sign(e){var t=Number(e);if(t===0){return t}if(X(t)){return t}return t<0?-1:1};var Y=function log1p(e){var t=Number(e);if(t<-1||X(t)){return NaN}if(t===0||t===Infinity){return t}if(t===-1){return-Infinity}return 1+t-1===0?t:t*(F(1+t)/(1+t-1))};var Q=function isArguments(e){return g(e)==="[object Arguments]"};var ee=function isArguments(e){return e!==null&&typeof e==="object"&&typeof e.length==="number"&&e.length>=0&&g(e)!=="[object Array]"&&g(e.callee)==="[object Function]"};var te=Q(arguments)?Q:ee;var re={primitive:function(e){return e===null||typeof e!=="function"&&typeof e!=="object"},string:function(e){return g(e)==="[object String]"},regex:function(e){return g(e)==="[object RegExp]"},symbol:function(e){return typeof S.Symbol==="function"&&typeof e==="symbol"}};var ne=function overrideNative(e,t,r){var n=e[t];h(e,t,r,true);m.preserveToString(e[t],n)};var oe=typeof $==="function"&&typeof $["for"]==="function"&&re.symbol($());var ie=re.symbol($.iterator)?$.iterator:"_es6-shim iterator_";if(S.Set&&typeof(new S.Set)["@@iterator"]==="function"){ie="@@iterator"}if(!S.Reflect){h(S,"Reflect",{},true)}var ae=S.Reflect;var ue=String;var fe=typeof document==="undefined"||!document?null:document.all;var se=fe==null?function isNullOrUndefined(e){return e==null}:function isNullOrUndefinedAndNotDocumentAll(e){return e==null&&e!==fe};var ce={Call:function Call(t,r){var n=arguments.length>2?arguments[2]:[];if(!ce.IsCallable(t)){throw new TypeError(t+" is not a function")}return e(t,r,n)},RequireObjectCoercible:function(e,t){if(se(e)){throw new TypeError(t||"Cannot call method on "+e)}return e},TypeIsObject:function(e){if(e===void 0||e===null||e===true||e===false){return false}return typeof e==="function"||typeof e==="object"||e===fe},ToObject:function(e,t){return Object(ce.RequireObjectCoercible(e,t))},IsCallable:d,IsConstructor:function(e){return ce.IsCallable(e)},ToInt32:function(e){return ce.ToNumber(e)>>0},ToUint32:function(e){return ce.ToNumber(e)>>>0},ToNumber:function(e){if(g(e)==="[object Symbol]"){throw new TypeError("Cannot convert a Symbol value to a number")}return+e},ToInteger:function(e){var t=ce.ToNumber(e);if(X(t)){return 0}if(t===0||!K(t)){return t}return(t>0?1:-1)*_(k(t))},ToLength:function(e){var t=ce.ToInteger(e);if(t<=0){return 0}if(t>Number.MAX_SAFE_INTEGER){return Number.MAX_SAFE_INTEGER}return t},SameValue:function(e,t){if(e===t){if(e===0){return 1/e===1/t}return true}return X(e)&&X(t)},SameValueZero:function(e,t){return e===t||X(e)&&X(t)},IsIterable:function(e){return ce.TypeIsObject(e)&&(typeof e[ie]!=="undefined"||te(e))},GetIterator:function(e){if(te(e)){return new q(e,"value")}var t=ce.GetMethod(e,ie);if(!ce.IsCallable(t)){throw new TypeError("value is not an iterable")}var r=ce.Call(t,e);if(!ce.TypeIsObject(r)){throw new TypeError("bad iterator")}return r},GetMethod:function(e,t){var r=ce.ToObject(e)[t];if(se(r)){return void 0}if(!ce.IsCallable(r)){throw new TypeError("Method not callable: "+t)}return r},IteratorComplete:function(e){return!!e.done},IteratorClose:function(e,t){var r=ce.GetMethod(e,"return");if(r===void 0){return}var n,o;try{n=ce.Call(r,e)}catch(i){o=i}if(t){return}if(o){throw o}if(!ce.TypeIsObject(n)){throw new TypeError("Iterator's return method returned a non-object.")}},IteratorNext:function(e){var t=arguments.length>1?e.next(arguments[1]):e.next();if(!ce.TypeIsObject(t)){throw new TypeError("bad iterator")}return t},IteratorStep:function(e){var t=ce.IteratorNext(e);var r=ce.IteratorComplete(t);return r?false:t},Construct:function(e,t,r,n){var o=typeof r==="undefined"?e:r;if(!n&&ae.construct){return ae.construct(e,t,o)}var i=o.prototype;if(!ce.TypeIsObject(i)){i=Object.prototype}var a=O(i);var u=ce.Call(e,a,t);return ce.TypeIsObject(u)?u:a},SpeciesConstructor:function(e,t){var r=e.constructor;if(r===void 0){return t}if(!ce.TypeIsObject(r)){throw new TypeError("Bad constructor")}var n=r[J];if(se(n)){return t}if(!ce.IsConstructor(n)){throw new TypeError("Bad @@species")}return n},CreateHTML:function(e,t,r,n){var o=ce.ToString(e);var i="<"+t;if(r!==""){var a=ce.ToString(n);var u=a.replace(/"/g,"&quot;");i+=" "+r+'="'+u+'"'}var f=i+">";var s=f+o;return s+"</"+t+">"},IsRegExp:function IsRegExp(e){if(!ce.TypeIsObject(e)){return false}var t=e[$.match];if(typeof t!=="undefined"){return!!t}return re.regex(e)},ToString:function ToString(e){return ue(e)}};if(s&&oe){var le=function defineWellKnownSymbol(e){if(re.symbol($[e])){return $[e]}var t=$["for"]("Symbol."+e);Object.defineProperty($,e,{configurable:false,enumerable:false,writable:false,value:t});return t};if(!re.symbol($.search)){var pe=le("search");var ve=String.prototype.search;h(RegExp.prototype,pe,function search(e){return ce.Call(ve,e,[this])});var ye=function search(e){var t=ce.RequireObjectCoercible(this);if(!se(e)){var r=ce.GetMethod(e,pe);if(typeof r!=="undefined"){return ce.Call(r,e,[t])}}return ce.Call(ve,t,[ce.ToString(e)])};ne(String.prototype,"search",ye)}if(!re.symbol($.replace)){var he=le("replace");var be=String.prototype.replace;h(RegExp.prototype,he,function replace(e,t){return ce.Call(be,e,[this,t])});var ge=function replace(e,t){var r=ce.RequireObjectCoercible(this);if(!se(e)){var n=ce.GetMethod(e,he);if(typeof n!=="undefined"){return ce.Call(n,e,[r,t])}}return ce.Call(be,r,[ce.ToString(e),t])};ne(String.prototype,"replace",ge)}if(!re.symbol($.split)){var de=le("split");var me=String.prototype.split;h(RegExp.prototype,de,function split(e,t){return ce.Call(me,e,[this,t])});var Oe=function split(e,t){var r=ce.RequireObjectCoercible(this);if(!se(e)){var n=ce.GetMethod(e,de);if(typeof n!=="undefined"){return ce.Call(n,e,[r,t])}}return ce.Call(me,r,[ce.ToString(e),t])};ne(String.prototype,"split",Oe)}var we=re.symbol($.match);var je=we&&function(){var e={};e[$.match]=function(){return 42};return"a".match(e)!==42}();if(!we||je){var Se=le("match");var Te=String.prototype.match;h(RegExp.prototype,Se,function match(e){return ce.Call(Te,e,[this])});var Ie=function match(e){var t=ce.RequireObjectCoercible(this);if(!se(e)){var r=ce.GetMethod(e,Se);if(typeof r!=="undefined"){return ce.Call(r,e,[t])}}return ce.Call(Te,t,[ce.ToString(e)])};ne(String.prototype,"match",Ie)}}var Ee=function wrapConstructor(e,t,r){m.preserveToString(t,e);if(Object.setPrototypeOf){Object.setPrototypeOf(e,t)}if(s){l(Object.getOwnPropertyNames(e),function(n){if(n in W||r[n]){return}m.proxy(e,n,t)})}else{l(Object.keys(e),function(n){if(n in W||r[n]){return}t[n]=e[n]})}t.prototype=e.prototype;m.redefine(e.prototype,"constructor",t)};var Pe=function(){return this};var Ce=function(e){if(s&&!z(e,J)){m.getter(e,J,Pe)}};var Me=function(e,t){var r=t||function iterator(){return this};h(e,ie,r);if(!e[ie]&&re.symbol(ie)){e[ie]=r}};var xe=function createDataProperty(e,t,r){if(s){Object.defineProperty(e,t,{configurable:true,enumerable:true,writable:true,value:r})}else{e[t]=r}};var Ne=function createDataPropertyOrThrow(e,t,r){xe(e,t,r);if(!ce.SameValue(e[t],r)){throw new TypeError("property is nonconfigurable")}};var Ae=function(e,t,r,n){if(!ce.TypeIsObject(e)){throw new TypeError("Constructor requires `new`: "+t.name)}var o=t.prototype;if(!ce.TypeIsObject(o)){o=r}var i=O(o);for(var a in n){if(z(n,a)){var u=n[a];h(i,a,u,true)}}return i};if(String.fromCodePoint&&String.fromCodePoint.length!==1){var Re=String.fromCodePoint;ne(String,"fromCodePoint",function fromCodePoint(e){return ce.Call(Re,this,arguments)})}var _e={fromCodePoint:function fromCodePoint(e){var t=[];var r;for(var n=0,o=arguments.length;n<o;n++){r=Number(arguments[n]);if(!ce.SameValue(r,ce.ToInteger(r))||r<0||r>1114111){throw new RangeError("Invalid code point "+r)}if(r<65536){M(t,String.fromCharCode(r))}else{r-=65536;M(t,String.fromCharCode((r>>10)+55296));M(t,String.fromCharCode(r%1024+56320))}}return t.join("")},raw:function raw(e){var t=ce.ToObject(e,"bad callSite");var r=ce.ToObject(t.raw,"bad raw value");var n=r.length;var o=ce.ToLength(n);if(o<=0){return""}var i=[];var a=0;var u,f,s,c;while(a<o){u=ce.ToString(a);s=ce.ToString(r[u]);M(i,s);if(a+1>=o){break}f=a+1<arguments.length?arguments[a+1]:"";c=ce.ToString(f);M(i,c);a+=1}return i.join("")}};if(String.raw&&String.raw({raw:{0:"x",1:"y",length:2}})!=="xy"){ne(String,"raw",_e.raw)}b(String,_e);var ke=function repeat(e,t){if(t<1){return""}if(t%2){return repeat(e,t-1)+e}var r=repeat(e,t/2);return r+r};var Le=Infinity;var Fe={repeat:function repeat(e){var t=ce.ToString(ce.RequireObjectCoercible(this));var r=ce.ToInteger(e);if(r<0||r>=Le){throw new RangeError("repeat count must be less than infinity and not overflow maximum string size")}return ke(t,r)},startsWith:function startsWith(e){var t=ce.ToString(ce.RequireObjectCoercible(this));if(ce.IsRegExp(e)){throw new TypeError('Cannot call method "startsWith" with a regex')}var r=ce.ToString(e);var n;if(arguments.length>1){n=arguments[1]}var o=A(ce.ToInteger(n),0);return C(t,o,o+r.length)===r},endsWith:function endsWith(e){var t=ce.ToString(ce.RequireObjectCoercible(this));if(ce.IsRegExp(e)){throw new TypeError('Cannot call method "endsWith" with a regex')}var r=ce.ToString(e);var n=t.length;var o;if(arguments.length>1){o=arguments[1]}var i=typeof o==="undefined"?n:ce.ToInteger(o);var a=R(A(i,0),n);return C(t,a-r.length,a)===r},includes:function includes(e){if(ce.IsRegExp(e)){throw new TypeError('"includes" does not accept a RegExp')}var t=ce.ToString(e);var r;if(arguments.length>1){r=arguments[1]}return I(this,t,r)!==-1},codePointAt:function codePointAt(e){var t=ce.ToString(ce.RequireObjectCoercible(this));var r=ce.ToInteger(e);var n=t.length;if(r>=0&&r<n){var o=t.charCodeAt(r);var i=r+1===n;if(o<55296||o>56319||i){return o}var a=t.charCodeAt(r+1);if(a<56320||a>57343){return o}return(o-55296)*1024+(a-56320)+65536}}};if(String.prototype.includes&&"a".includes("a",Infinity)!==false){ne(String.prototype,"includes",Fe.includes)}if(String.prototype.startsWith&&String.prototype.endsWith){var De=i(function(){return"/a/".startsWith(/a/)});var ze=a(function(){return"abc".startsWith("a",Infinity)===false});if(!De||!ze){ne(String.prototype,"startsWith",Fe.startsWith);ne(String.prototype,"endsWith",Fe.endsWith)}}if(oe){var qe=a(function(){var e=/a/;e[$.match]=false;return"/a/".startsWith(e)});if(!qe){ne(String.prototype,"startsWith",Fe.startsWith)}var We=a(function(){var e=/a/;e[$.match]=false;return"/a/".endsWith(e)});if(!We){ne(String.prototype,"endsWith",Fe.endsWith)}var Ge=a(function(){var e=/a/;e[$.match]=false;return"/a/".includes(e)});if(!Ge){ne(String.prototype,"includes",Fe.includes)}}b(String.prototype,Fe);var He=["\t\n\x0B\f\r \xa0\u1680\u180e\u2000\u2001\u2002\u2003","\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u202f\u205f\u3000\u2028","\u2029\ufeff"].join("");var Ve=new RegExp("(^["+He+"]+)|(["+He+"]+$)","g");var Be=function trim(){return ce.ToString(ce.RequireObjectCoercible(this)).replace(Ve,"")};var Ue=["\x85","\u200b","\ufffe"].join("");var $e=new RegExp("["+Ue+"]","g");var Je=/^[-+]0x[0-9a-f]+$/i;var Xe=Ue.trim().length!==Ue.length;h(String.prototype,"trim",Be,Xe);var Ke=function(e){return{value:e,done:arguments.length===0}};var Ze=function(e){ce.RequireObjectCoercible(e);this._s=ce.ToString(e);this._i=0};Ze.prototype.next=function(){var e=this._s;var t=this._i;if(typeof e==="undefined"||t>=e.length){this._s=void 0;return Ke()}var r=e.charCodeAt(t);var n,o;if(r<55296||r>56319||t+1===e.length){o=1}else{n=e.charCodeAt(t+1);o=n<56320||n>57343?1:2}this._i=t+o;return Ke(e.substr(t,o))};Me(Ze.prototype);Me(String.prototype,function(){return new Ze(this)});var Ye={from:function from(e){var r=this;var n;if(arguments.length>1){n=arguments[1]}var o,i;if(typeof n==="undefined"){o=false}else{if(!ce.IsCallable(n)){throw new TypeError("Array.from: when provided, the second argument must be a function")}if(arguments.length>2){i=arguments[2]}o=true}var a=typeof(te(e)||ce.GetMethod(e,ie))!=="undefined";var u,f,s;if(a){f=ce.IsConstructor(r)?Object(new r):[];var c=ce.GetIterator(e);var l,p;s=0;while(true){l=ce.IteratorStep(c);if(l===false){break}p=l.value;try{if(o){p=typeof i==="undefined"?n(p,s):t(n,i,p,s)}f[s]=p}catch(v){ce.IteratorClose(c,true);throw v}s+=1}u=s}else{var y=ce.ToObject(e);u=ce.ToLength(y.length);f=ce.IsConstructor(r)?Object(new r(u)):new Array(u);var h;for(s=0;s<u;++s){h=y[s];if(o){h=typeof i==="undefined"?n(h,s):t(n,i,h,s)}Ne(f,s,h)}}f.length=u;return f},of:function of(){var e=arguments.length;var t=this;var n=r(t)||!ce.IsCallable(t)?new Array(e):ce.Construct(t,[e]);for(var o=0;o<e;++o){Ne(n,o,arguments[o])}n.length=e;return n}};b(Array,Ye);Ce(Array);q=function(e,t){this.i=0;this.array=e;this.kind=t};b(q.prototype,{next:function(){var e=this.i;var t=this.array;if(!(this instanceof q)){throw new TypeError("Not an ArrayIterator")}if(typeof t!=="undefined"){var r=ce.ToLength(t.length);for(;e<r;e++){var n=this.kind;var o;if(n==="key"){o=e}else if(n==="value"){o=t[e]}else if(n==="entry"){o=[e,t[e]]}this.i=e+1;return Ke(o)}}this.array=void 0;return Ke()}});Me(q.prototype);var Qe=Array.of===Ye.of||function(){var e=function Foo(e){this.length=e};e.prototype=[];var t=Array.of.apply(e,[1,2]);return t instanceof e&&t.length===2}();if(!Qe){ne(Array,"of",Ye.of)}var et={copyWithin:function copyWithin(e,t){var r=ce.ToObject(this);var n=ce.ToLength(r.length);var o=ce.ToInteger(e);var i=ce.ToInteger(t);var a=o<0?A(n+o,0):R(o,n);var u=i<0?A(n+i,0):R(i,n);var f;if(arguments.length>2){f=arguments[2]}var s=typeof f==="undefined"?n:ce.ToInteger(f);var c=s<0?A(n+s,0):R(s,n);var l=R(c-u,n-a);var p=1;if(u<a&&a<u+l){p=-1;u+=l-1;a+=l-1}while(l>0){if(u in r){r[a]=r[u]}else{delete r[a]}u+=p;a+=p;l-=1}return r},fill:function fill(e){var t;if(arguments.length>1){t=arguments[1]}var r;if(arguments.length>2){r=arguments[2]}var n=ce.ToObject(this);var o=ce.ToLength(n.length);t=ce.ToInteger(typeof t==="undefined"?0:t);r=ce.ToInteger(typeof r==="undefined"?o:r);var i=t<0?A(o+t,0):R(t,o);var a=r<0?o+r:r;for(var u=i;u<o&&u<a;++u){n[u]=e}return n},find:function find(e){var r=ce.ToObject(this);var n=ce.ToLength(r.length);if(!ce.IsCallable(e)){throw new TypeError("Array#find: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0,a;i<n;i++){a=r[i];if(o){if(t(e,o,a,i,r)){return a}}else if(e(a,i,r)){return a}}},findIndex:function findIndex(e){var r=ce.ToObject(this);var n=ce.ToLength(r.length);if(!ce.IsCallable(e)){throw new TypeError("Array#findIndex: predicate must be a function")}var o=arguments.length>1?arguments[1]:null;for(var i=0;i<n;i++){if(o){if(t(e,o,r[i],i,r)){return i}}else if(e(r[i],i,r)){return i}}return-1},keys:function keys(){return new q(this,"key")},values:function values(){return new q(this,"value")},entries:function entries(){return new q(this,"entry")}};if(Array.prototype.keys&&!ce.IsCallable([1].keys().next)){delete Array.prototype.keys}if(Array.prototype.entries&&!ce.IsCallable([1].entries().next)){delete Array.prototype.entries}if(Array.prototype.keys&&Array.prototype.entries&&!Array.prototype.values&&Array.prototype[ie]){b(Array.prototype,{values:Array.prototype[ie]});if(re.symbol($.unscopables)){Array.prototype[$.unscopables].values=true}}if(c&&Array.prototype.values&&Array.prototype.values.name!=="values"){var tt=Array.prototype.values;ne(Array.prototype,"values",function values(){return ce.Call(tt,this,arguments)});h(Array.prototype,ie,Array.prototype.values,true)}b(Array.prototype,et);if(1/[true].indexOf(true,-0)<0){h(Array.prototype,"indexOf",function indexOf(e){var t=E(this,arguments);if(t===0&&1/t<0){return 0}return t},true)}Me(Array.prototype,function(){return this.values()});if(Object.getPrototypeOf){Me(Object.getPrototypeOf([].values()))}var rt=function(){return a(function(){return Array.from({length:-1}).length===0})}();var nt=function(){var e=Array.from([0].entries());return e.length===1&&r(e[0])&&e[0][0]===0&&e[0][1]===0}();if(!rt||!nt){ne(Array,"from",Ye.from)}var ot=function(){return a(function(){return Array.from([0],void 0)})}();if(!ot){var it=Array.from;ne(Array,"from",function from(e){if(arguments.length>1&&typeof arguments[1]!=="undefined"){return ce.Call(it,this,arguments)}else{return t(it,this,e)}})}var at=-(Math.pow(2,32)-1);var ut=function(e,r){var n={length:at};n[r?(n.length>>>0)-1:0]=true;return a(function(){t(e,n,function(){throw new RangeError("should not reach here")},[]);return true})};if(!ut(Array.prototype.forEach)){var ft=Array.prototype.forEach;ne(Array.prototype,"forEach",function forEach(e){return ce.Call(ft,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.map)){var st=Array.prototype.map;ne(Array.prototype,"map",function map(e){return ce.Call(st,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.filter)){var ct=Array.prototype.filter;ne(Array.prototype,"filter",function filter(e){return ce.Call(ct,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.some)){var lt=Array.prototype.some;ne(Array.prototype,"some",function some(e){return ce.Call(lt,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.every)){var pt=Array.prototype.every;ne(Array.prototype,"every",function every(e){return ce.Call(pt,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.reduce)){var vt=Array.prototype.reduce;ne(Array.prototype,"reduce",function reduce(e){return ce.Call(vt,this.length>=0?this:[],arguments)},true)}if(!ut(Array.prototype.reduceRight,true)){var yt=Array.prototype.reduceRight;ne(Array.prototype,"reduceRight",function reduceRight(e){return ce.Call(yt,this.length>=0?this:[],arguments)},true)}var ht=Number("0o10")!==8;var bt=Number("0b10")!==2;var gt=y(Ue,function(e){return Number(e+0+e)===0});if(ht||bt||gt){var dt=Number;var mt=/^0b[01]+$/i;var Ot=/^0o[0-7]+$/i;var wt=mt.test.bind(mt);var jt=Ot.test.bind(Ot);var St=function(e){var t;if(typeof e.valueOf==="function"){t=e.valueOf();if(re.primitive(t)){return t}}if(typeof e.toString==="function"){t=e.toString();if(re.primitive(t)){return t}}throw new TypeError("No default value")};var Tt=$e.test.bind($e);var It=Je.test.bind(Je);var Et=function(){var e=function Number(t){var r;if(arguments.length>0){r=re.primitive(t)?t:St(t,"number")}else{r=0}if(typeof r==="string"){r=ce.Call(Be,r);if(wt(r)){r=parseInt(C(r,2),2)}else if(jt(r)){r=parseInt(C(r,2),8)}else if(Tt(r)||It(r)){r=NaN}}var n=this;var o=a(function(){dt.prototype.valueOf.call(n);return true});if(n instanceof e&&!o){return new dt(r)}return dt(r)};return e}();Ee(dt,Et,{});b(Et,{NaN:dt.NaN,MAX_VALUE:dt.MAX_VALUE,MIN_VALUE:dt.MIN_VALUE,NEGATIVE_INFINITY:dt.NEGATIVE_INFINITY,POSITIVE_INFINITY:dt.POSITIVE_INFINITY});Number=Et;m.redefine(S,"Number",Et)}var Pt=Math.pow(2,53)-1;b(Number,{MAX_SAFE_INTEGER:Pt,MIN_SAFE_INTEGER:-Pt,EPSILON:2.220446049250313e-16,parseInt:S.parseInt,parseFloat:S.parseFloat,isFinite:K,isInteger:function isInteger(e){return K(e)&&ce.ToInteger(e)===e},isSafeInteger:function isSafeInteger(e){return Number.isInteger(e)&&k(e)<=Number.MAX_SAFE_INTEGER},isNaN:X});h(Number,"parseInt",S.parseInt,Number.parseInt!==S.parseInt);if([,1].find(function(){return true})===1){ne(Array.prototype,"find",et.find)}if([,1].findIndex(function(){return true})!==0){ne(Array.prototype,"findIndex",et.findIndex)}var Ct=Function.bind.call(Function.bind,Object.prototype.propertyIsEnumerable);var Mt=function ensureEnumerable(e,t){if(s&&Ct(e,t)){Object.defineProperty(e,t,{enumerable:false})}};var xt=function sliceArgs(){var e=Number(this);var t=arguments.length;var r=t-e;var n=new Array(r<0?0:r);for(var o=e;o<t;++o){n[o-e]=arguments[o]}return n};var Nt=function assignTo(e){return function assignToSource(t,r){t[r]=e[r];return t}};var At=function(e,t){var r=n(Object(t));var o;if(ce.IsCallable(Object.getOwnPropertySymbols)){o=v(Object.getOwnPropertySymbols(Object(t)),Ct(t))}return p(P(r,o||[]),Nt(t),e)};var Rt={assign:function(e,t){var r=ce.ToObject(e,"Cannot convert undefined or null to object");return p(ce.Call(xt,1,arguments),At,r)},is:function is(e,t){return ce.SameValue(e,t)}};var _t=Object.assign&&Object.preventExtensions&&function(){var e=Object.preventExtensions({1:2});try{Object.assign(e,"xy")}catch(t){return e[1]==="y"}}();if(_t){ne(Object,"assign",Rt.assign)}b(Object,Rt);if(s){var kt={setPrototypeOf:function(e,r){var n;var o=function(e,t){if(!ce.TypeIsObject(e)){throw new TypeError("cannot set prototype on a non-object")}if(!(t===null||ce.TypeIsObject(t))){throw new TypeError("can only set prototype to an object or null"+t)}};var i=function(e,r){o(e,r);t(n,e,r);return e};try{n=e.getOwnPropertyDescriptor(e.prototype,r).set;t(n,{},null)}catch(a){if(e.prototype!=={}[r]){return}n=function(e){this[r]=e};i.polyfill=i(i({},null),e.prototype)instanceof e}return i}(Object,"__proto__")};b(Object,kt)}if(Object.setPrototypeOf&&Object.getPrototypeOf&&Object.getPrototypeOf(Object.setPrototypeOf({},null))!==null&&Object.getPrototypeOf(Object.create(null))===null){(function(){var e=Object.create(null);var t=Object.getPrototypeOf;var r=Object.setPrototypeOf;Object.getPrototypeOf=function(r){var n=t(r);return n===e?null:n};Object.setPrototypeOf=function(t,n){var o=n===null?e:n;return r(t,o)};Object.setPrototypeOf.polyfill=false})()}var Lt=!i(function(){return Object.keys("foo")});if(!Lt){var Ft=Object.keys;ne(Object,"keys",function keys(e){return Ft(ce.ToObject(e))});n=Object.keys}var Dt=i(function(){return Object.keys(/a/g)});if(Dt){var zt=Object.keys;ne(Object,"keys",function keys(e){if(re.regex(e)){var t=[];for(var r in e){if(z(e,r)){M(t,r)}}return t}return zt(e)});n=Object.keys}if(Object.getOwnPropertyNames){var qt=!i(function(){return Object.getOwnPropertyNames("foo")});if(!qt){var Wt=typeof window==="object"?Object.getOwnPropertyNames(window):[];var Gt=Object.getOwnPropertyNames;ne(Object,"getOwnPropertyNames",function getOwnPropertyNames(e){var t=ce.ToObject(e);if(g(t)==="[object Window]"){try{return Gt(t)}catch(r){return P([],Wt)}}return Gt(t)})}}if(Object.getOwnPropertyDescriptor){var Ht=!i(function(){return Object.getOwnPropertyDescriptor("foo","bar")});if(!Ht){var Vt=Object.getOwnPropertyDescriptor;ne(Object,"getOwnPropertyDescriptor",function getOwnPropertyDescriptor(e,t){return Vt(ce.ToObject(e),t)})}}if(Object.seal){var Bt=!i(function(){return Object.seal("foo")});if(!Bt){var Ut=Object.seal;ne(Object,"seal",function seal(e){if(!ce.TypeIsObject(e)){return e}return Ut(e)})}}if(Object.isSealed){var $t=!i(function(){return Object.isSealed("foo")});if(!$t){var Jt=Object.isSealed;ne(Object,"isSealed",function isSealed(e){if(!ce.TypeIsObject(e)){return true}return Jt(e)})}}if(Object.freeze){var Xt=!i(function(){return Object.freeze("foo")});if(!Xt){var Kt=Object.freeze;ne(Object,"freeze",function freeze(e){if(!ce.TypeIsObject(e)){return e}return Kt(e)})}}if(Object.isFrozen){var Zt=!i(function(){return Object.isFrozen("foo")});if(!Zt){var Yt=Object.isFrozen;ne(Object,"isFrozen",function isFrozen(e){if(!ce.TypeIsObject(e)){return true}return Yt(e)})}}if(Object.preventExtensions){var Qt=!i(function(){return Object.preventExtensions("foo")});if(!Qt){var er=Object.preventExtensions;ne(Object,"preventExtensions",function preventExtensions(e){if(!ce.TypeIsObject(e)){return e}return er(e)})}}if(Object.isExtensible){var tr=!i(function(){return Object.isExtensible("foo")});if(!tr){var rr=Object.isExtensible;ne(Object,"isExtensible",function isExtensible(e){if(!ce.TypeIsObject(e)){return false}return rr(e)})}}if(Object.getPrototypeOf){var nr=!i(function(){return Object.getPrototypeOf("foo")});if(!nr){var or=Object.getPrototypeOf;ne(Object,"getPrototypeOf",function getPrototypeOf(e){return or(ce.ToObject(e))})}}var ir=s&&function(){var e=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags");return e&&ce.IsCallable(e.get)}();if(s&&!ir){var ar=function flags(){if(!ce.TypeIsObject(this)){throw new TypeError("Method called on incompatible type: must be an object.")}var e="";if(this.global){e+="g"}if(this.ignoreCase){e+="i"}if(this.multiline){e+="m"}if(this.unicode){e+="u"}if(this.sticky){e+="y"}return e};m.getter(RegExp.prototype,"flags",ar)}var ur=s&&a(function(){return String(new RegExp(/a/g,"i"))==="/a/i"});var fr=oe&&s&&function(){var e=/./;e[$.match]=false;return RegExp(e)===e}();var sr=a(function(){return RegExp.prototype.toString.call({source:"abc"})==="/abc/"});var cr=sr&&a(function(){return RegExp.prototype.toString.call({source:"a",flags:"b"})==="/a/b"});if(!sr||!cr){var lr=RegExp.prototype.toString;h(RegExp.prototype,"toString",function toString(){var e=ce.RequireObjectCoercible(this);if(re.regex(e)){return t(lr,e)}var r=ue(e.source);var n=ue(e.flags);return"/"+r+"/"+n},true);m.preserveToString(RegExp.prototype.toString,lr)}if(s&&(!ur||fr)){var pr=Object.getOwnPropertyDescriptor(RegExp.prototype,"flags").get;var vr=Object.getOwnPropertyDescriptor(RegExp.prototype,"source")||{};var yr=function(){return this.source};var hr=ce.IsCallable(vr.get)?vr.get:yr;var br=RegExp;var gr=function(){return function RegExp(e,t){var r=ce.IsRegExp(e);var n=this instanceof RegExp;if(!n&&r&&typeof t==="undefined"&&e.constructor===RegExp){return e}var o=e;var i=t;if(re.regex(e)){o=ce.Call(hr,e);i=typeof t==="undefined"?ce.Call(pr,e):t;return new RegExp(o,i)}else if(r){o=e.source;i=typeof t==="undefined"?e.flags:t}return new br(e,t)}}();Ee(br,gr,{$input:true});RegExp=gr;m.redefine(S,"RegExp",gr)}if(s){var dr={input:"$_",lastMatch:"$&",lastParen:"$+",leftContext:"$`",rightContext:"$'"};l(n(dr),function(e){if(e in RegExp&&!(dr[e]in RegExp)){m.getter(RegExp,dr[e],function get(){return RegExp[e]})}})}Ce(RegExp);var mr=1/Number.EPSILON;var Or=function roundTiesToEven(e){return e+mr-mr};var wr=Math.pow(2,-23);var jr=Math.pow(2,127)*(2-wr);var Sr=Math.pow(2,-126);var Tr=Math.E;var Ir=Math.LOG2E;var Er=Math.LOG10E;var Pr=Number.prototype.clz;delete Number.prototype.clz;var Cr={acosh:function acosh(e){var t=Number(e);if(X(t)||e<1){return NaN}if(t===1){return 0}if(t===Infinity){return t}var r=1/(t*t);if(t<2){return Y(t-1+D(1-r)*t)}var n=t/2;return Y(n+D(1-r)*n-1)+1/Ir},asinh:function asinh(e){var t=Number(e);if(t===0||!T(t)){return t}var r=k(t);var n=r*r;var o=Z(t);if(r<1){return o*Y(r+n/(D(n+1)+1))}return o*(Y(r/2+D(1+1/n)*r/2-1)+1/Ir)},atanh:function atanh(e){var t=Number(e);if(t===0){return t}if(t===-1){return-Infinity}if(t===1){return Infinity}if(X(t)||t<-1||t>1){return NaN}var r=k(t);return Z(t)*Y(2*r/(1-r))/2},cbrt:function cbrt(e){var t=Number(e);if(t===0){return t}var r=t<0;var n;if(r){t=-t}if(t===Infinity){n=Infinity}else{n=L(F(t)/3);n=(t/(n*n)+2*n)/3}return r?-n:n},clz32:function clz32(e){var t=Number(e);var r=ce.ToUint32(t);if(r===0){return 32}return Pr?ce.Call(Pr,r):31-_(F(r+.5)*Ir)},cosh:function cosh(e){var t=Number(e);if(t===0){return 1}if(X(t)){return NaN}if(!T(t)){return Infinity}var r=L(k(t)-1);return(r+1/(r*Tr*Tr))*(Tr/2)},expm1:function expm1(e){var t=Number(e);if(t===-Infinity){return-1}if(!T(t)||t===0){return t}if(k(t)>.5){return L(t)-1}var r=t;var n=0;var o=1;while(n+r!==n){n+=r;o+=1;r*=t/o}return n},hypot:function hypot(e,t){var r=0;var n=0;for(var o=0;o<arguments.length;++o){var i=k(Number(arguments[o]));if(n<i){r*=n/i*(n/i);r+=1;n=i}else{r+=i>0?i/n*(i/n):i}}return n===Infinity?Infinity:n*D(r)},log2:function log2(e){return F(e)*Ir},log10:function log10(e){return F(e)*Er},log1p:Y,sign:Z,sinh:function sinh(e){var t=Number(e);if(!T(t)||t===0){return t}var r=k(t);if(r<1){var n=Math.expm1(r);return Z(t)*n*(1+1/(n+1))/2}var o=L(r-1);return Z(t)*(o-1/(o*Tr*Tr))*(Tr/2)},tanh:function tanh(e){var t=Number(e);if(X(t)||t===0){return t}if(t>=20){return 1}if(t<=-20){return-1}return(Math.expm1(t)-Math.expm1(-t))/(L(t)+L(-t))},trunc:function trunc(e){var t=Number(e);return t<0?-_(-t):_(t)},imul:function imul(e,t){var r=ce.ToUint32(e);var n=ce.ToUint32(t);var o=r>>>16&65535;var i=r&65535;var a=n>>>16&65535;var u=n&65535;return i*u+(o*u+i*a<<16>>>0)|0},fround:function fround(e){var t=Number(e);if(t===0||t===Infinity||t===-Infinity||X(t)){return t}var r=Z(t);var n=k(t);if(n<Sr){return r*Or(n/Sr/wr)*Sr*wr}var o=(1+wr/Number.EPSILON)*n;var i=o-(o-n);if(i>jr||X(i)){return r*Infinity}return r*i}};var Mr=function withinULPDistance(e,t,r){return k(1-e/t)/Number.EPSILON<(r||8)};b(Math,Cr);h(Math,"sinh",Cr.sinh,Math.sinh(710)===Infinity);h(Math,"cosh",Cr.cosh,Math.cosh(710)===Infinity);h(Math,"log1p",Cr.log1p,Math.log1p(-1e-17)!==-1e-17);h(Math,"asinh",Cr.asinh,Math.asinh(-1e7)!==-Math.asinh(1e7));h(Math,"asinh",Cr.asinh,Math.asinh(1e300)===Infinity);h(Math,"atanh",Cr.atanh,Math.atanh(1e-300)===0);h(Math,"tanh",Cr.tanh,Math.tanh(-2e-17)!==-2e-17);
h(Math,"acosh",Cr.acosh,Math.acosh(Number.MAX_VALUE)===Infinity);h(Math,"acosh",Cr.acosh,!Mr(Math.acosh(1+Number.EPSILON),Math.sqrt(2*Number.EPSILON)));h(Math,"cbrt",Cr.cbrt,!Mr(Math.cbrt(1e-300),1e-100));h(Math,"sinh",Cr.sinh,Math.sinh(-2e-17)!==-2e-17);var xr=Math.expm1(10);h(Math,"expm1",Cr.expm1,xr>22025.465794806718||xr<22025.465794806718);var Nr=Math.round;var Ar=Math.round(.5-Number.EPSILON/4)===0&&Math.round(-.5+Number.EPSILON/3.99)===1;var Rr=mr+1;var _r=2*mr-1;var kr=[Rr,_r].every(function(e){return Math.round(e)===e});h(Math,"round",function round(e){var t=_(e);var r=t===-1?-0:t+1;return e-t<.5?t:r},!Ar||!kr);m.preserveToString(Math.round,Nr);var Lr=Math.imul;if(Math.imul(4294967295,5)!==-5){Math.imul=Cr.imul;m.preserveToString(Math.imul,Lr)}if(Math.imul.length!==2){ne(Math,"imul",function imul(e,t){return ce.Call(Lr,Math,arguments)})}var Fr=function(){var e=S.setTimeout;if(typeof e!=="function"&&typeof e!=="object"){return}ce.IsPromise=function(e){if(!ce.TypeIsObject(e)){return false}if(typeof e._promise==="undefined"){return false}return true};var r=function(e){if(!ce.IsConstructor(e)){throw new TypeError("Bad promise constructor")}var t=this;var r=function(e,r){if(t.resolve!==void 0||t.reject!==void 0){throw new TypeError("Bad Promise implementation!")}t.resolve=e;t.reject=r};t.resolve=void 0;t.reject=void 0;t.promise=new e(r);if(!(ce.IsCallable(t.resolve)&&ce.IsCallable(t.reject))){throw new TypeError("Bad promise constructor")}};var n;if(typeof window!=="undefined"&&ce.IsCallable(window.postMessage)){n=function(){var e=[];var t="zero-timeout-message";var r=function(r){M(e,r);window.postMessage(t,"*")};var n=function(r){if(r.source===window&&r.data===t){r.stopPropagation();if(e.length===0){return}var n=N(e);n()}};window.addEventListener("message",n,true);return r}}var o=function(){var e=S.Promise;var t=e&&e.resolve&&e.resolve();return t&&function(e){return t.then(e)}};var i=ce.IsCallable(S.setImmediate)?S.setImmediate:typeof process==="object"&&process.nextTick?process.nextTick:o()||(ce.IsCallable(n)?n():function(t){e(t,0)});var a=function(e){return e};var u=function(e){throw e};var f=0;var s=1;var c=2;var l=0;var p=1;var v=2;var y={};var h=function(e,t,r){i(function(){g(e,t,r)})};var g=function(e,t,r){var n,o;if(t===y){return e(r)}try{n=e(r);o=t.resolve}catch(i){n=i;o=t.reject}o(n)};var d=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.fulfillReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+l],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=s;r.reactionLength=0};var m=function(e,t){var r=e._promise;var n=r.reactionLength;if(n>0){h(r.rejectReactionHandler0,r.reactionCapability0,t);r.fulfillReactionHandler0=void 0;r.rejectReactions0=void 0;r.reactionCapability0=void 0;if(n>1){for(var o=1,i=0;o<n;o++,i+=3){h(r[i+p],r[i+v],t);e[i+l]=void 0;e[i+p]=void 0;e[i+v]=void 0}}}r.result=t;r.state=c;r.reactionLength=0};var O=function(e){var t=false;var r=function(r){var n;if(t){return}t=true;if(r===e){return m(e,new TypeError("Self resolution"))}if(!ce.TypeIsObject(r)){return d(e,r)}try{n=r.then}catch(o){return m(e,o)}if(!ce.IsCallable(n)){return d(e,r)}i(function(){j(e,r,n)})};var n=function(r){if(t){return}t=true;return m(e,r)};return{resolve:r,reject:n}};var w=function(e,r,n,o){if(e===I){t(e,r,n,o,y)}else{t(e,r,n,o)}};var j=function(e,t,r){var n=O(e);var o=n.resolve;var i=n.reject;try{w(r,t,o,i)}catch(a){i(a)}};var T,I;var E=function(){var e=function Promise(t){if(!(this instanceof e)){throw new TypeError('Constructor Promise requires "new"')}if(this&&this._promise){throw new TypeError("Bad construction")}if(!ce.IsCallable(t)){throw new TypeError("not a valid resolver")}var r=Ae(this,e,T,{_promise:{result:void 0,state:f,reactionLength:0,fulfillReactionHandler0:void 0,rejectReactionHandler0:void 0,reactionCapability0:void 0}});var n=O(r);var o=n.reject;try{t(n.resolve,o)}catch(i){o(i)}return r};return e}();T=E.prototype;var P=function(e,t,r,n){var o=false;return function(i){if(o){return}o=true;t[e]=i;if(--n.count===0){var a=r.resolve;a(t)}}};var C=function(e,t,r){var n=e.iterator;var o=[];var i={count:1};var a,u;var f=0;while(true){try{a=ce.IteratorStep(n);if(a===false){e.done=true;break}u=a.value}catch(s){e.done=true;throw s}o[f]=void 0;var c=t.resolve(u);var l=P(f,o,r,i);i.count+=1;w(c.then,c,l,r.reject);f+=1}if(--i.count===0){var p=r.resolve;p(o)}return r.promise};var x=function(e,t,r){var n=e.iterator;var o,i,a;while(true){try{o=ce.IteratorStep(n);if(o===false){e.done=true;break}i=o.value}catch(u){e.done=true;throw u}a=t.resolve(i);w(a.then,a,r.resolve,r.reject)}return r.promise};b(E,{all:function all(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=ce.GetIterator(e);i={iterator:o,done:false};return C(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{ce.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},race:function race(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Promise is not object")}var n=new r(t);var o,i;try{o=ce.GetIterator(e);i={iterator:o,done:false};return x(i,t,n)}catch(a){var u=a;if(i&&!i.done){try{ce.IteratorClose(o,true)}catch(f){u=f}}var s=n.reject;s(u);return n.promise}},reject:function reject(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}var n=new r(t);var o=n.reject;o(e);return n.promise},resolve:function resolve(e){var t=this;if(!ce.TypeIsObject(t)){throw new TypeError("Bad promise constructor")}if(ce.IsPromise(e)){var n=e.constructor;if(n===t){return e}}var o=new r(t);var i=o.resolve;i(e);return o.promise}});b(T,{"catch":function(e){return this.then(null,e)},then:function then(e,t){var n=this;if(!ce.IsPromise(n)){throw new TypeError("not a promise")}var o=ce.SpeciesConstructor(n,E);var i;var b=arguments.length>2&&arguments[2]===y;if(b&&o===E){i=y}else{i=new r(o)}var g=ce.IsCallable(e)?e:a;var d=ce.IsCallable(t)?t:u;var m=n._promise;var O;if(m.state===f){if(m.reactionLength===0){m.fulfillReactionHandler0=g;m.rejectReactionHandler0=d;m.reactionCapability0=i}else{var w=3*(m.reactionLength-1);m[w+l]=g;m[w+p]=d;m[w+v]=i}m.reactionLength+=1}else if(m.state===s){O=m.result;h(g,i,O)}else if(m.state===c){O=m.result;h(d,i,O)}else{throw new TypeError("unexpected Promise state")}return i.promise}});y=new r(E);I=T.then;return E}();if(S.Promise){delete S.Promise.accept;delete S.Promise.defer;delete S.Promise.prototype.chain}if(typeof Fr==="function"){b(S,{Promise:Fr});var Dr=w(S.Promise,function(e){return e.resolve(42).then(function(){})instanceof e});var zr=!i(function(){return S.Promise.reject(42).then(null,5).then(null,W)});var qr=i(function(){return S.Promise.call(3,W)});var Wr=function(e){var t=e.resolve(5);t.constructor={};var r=e.resolve(t);try{r.then(null,W).then(null,W)}catch(n){return true}return t===r}(S.Promise);var Gr=s&&function(){var e=0;var t=Object.defineProperty({},"then",{get:function(){e+=1}});Promise.resolve(t);return e===1}();var Hr=function BadResolverPromise(e){var t=new Promise(e);e(3,function(){});this.then=t.then;this.constructor=BadResolverPromise};Hr.prototype=Promise.prototype;Hr.all=Promise.all;var Vr=a(function(){return!!Hr.all([1,2])});if(!Dr||!zr||!qr||Wr||!Gr||Vr){Promise=Fr;ne(S,"Promise",Fr)}if(Promise.all.length!==1){var Br=Promise.all;ne(Promise,"all",function all(e){return ce.Call(Br,this,arguments)})}if(Promise.race.length!==1){var Ur=Promise.race;ne(Promise,"race",function race(e){return ce.Call(Ur,this,arguments)})}if(Promise.resolve.length!==1){var $r=Promise.resolve;ne(Promise,"resolve",function resolve(e){return ce.Call($r,this,arguments)})}if(Promise.reject.length!==1){var Jr=Promise.reject;ne(Promise,"reject",function reject(e){return ce.Call(Jr,this,arguments)})}Mt(Promise,"all");Mt(Promise,"race");Mt(Promise,"resolve");Mt(Promise,"reject");Ce(Promise)}var Xr=function(e){var t=n(p(e,function(e,t){e[t]=true;return e},{}));return e.join(":")===t.join(":")};var Kr=Xr(["z","a","bb"]);var Zr=Xr(["z",1,"a","3",2]);if(s){var Yr=function fastkey(e,t){if(!t&&!Kr){return null}if(se(e)){return"^"+ce.ToString(e)}else if(typeof e==="string"){return"$"+e}else if(typeof e==="number"){if(!Zr){return"n"+e}return e}else if(typeof e==="boolean"){return"b"+e}return null};var Qr=function emptyObject(){return Object.create?Object.create(null):{}};var en=function addIterableToMap(e,n,o){if(r(o)||re.string(o)){l(o,function(e){if(!ce.TypeIsObject(e)){throw new TypeError("Iterator value "+e+" is not an entry object")}n.set(e[0],e[1])})}else if(o instanceof e){t(e.prototype.forEach,o,function(e,t){n.set(t,e)})}else{var i,a;if(!se(o)){a=n.set;if(!ce.IsCallable(a)){throw new TypeError("bad map")}i=ce.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=ce.IteratorStep(i);if(u===false){break}var f=u.value;try{if(!ce.TypeIsObject(f)){throw new TypeError("Iterator value "+f+" is not an entry object")}t(a,n,f[0],f[1])}catch(s){ce.IteratorClose(i,true);throw s}}}}};var tn=function addIterableToSet(e,n,o){if(r(o)||re.string(o)){l(o,function(e){n.add(e)})}else if(o instanceof e){t(e.prototype.forEach,o,function(e){n.add(e)})}else{var i,a;if(!se(o)){a=n.add;if(!ce.IsCallable(a)){throw new TypeError("bad set")}i=ce.GetIterator(o)}if(typeof i!=="undefined"){while(true){var u=ce.IteratorStep(i);if(u===false){break}var f=u.value;try{t(a,n,f)}catch(s){ce.IteratorClose(i,true);throw s}}}}};var rn={Map:function(){var e={};var r=function MapEntry(e,t){this.key=e;this.value=t;this.next=null;this.prev=null};r.prototype.isRemoved=function isRemoved(){return this.key===e};var n=function isMap(e){return!!e._es6map};var o=function requireMapSlot(e,t){if(!ce.TypeIsObject(e)||!n(e)){throw new TypeError("Method Map.prototype."+t+" called on incompatible receiver "+ce.ToString(e))}};var i=function MapIterator(e,t){o(e,"[[MapIterator]]");this.head=e._head;this.i=this.head;this.kind=t};i.prototype={isMapIterator:true,next:function next(){if(!this.isMapIterator){throw new TypeError("Not a MapIterator")}var e=this.i;var t=this.kind;var r=this.head;if(typeof this.i==="undefined"){return Ke()}while(e.isRemoved()&&e!==r){e=e.prev}var n;while(e.next!==r){e=e.next;if(!e.isRemoved()){if(t==="key"){n=e.key}else if(t==="value"){n=e.value}else{n=[e.key,e.value]}this.i=e;return Ke(n)}}this.i=void 0;return Ke()}};Me(i.prototype);var a;var u=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}if(this&&this._es6map){throw new TypeError("Bad construction")}var e=Ae(this,Map,a,{_es6map:true,_head:null,_map:G?new G:null,_size:0,_storage:Qr()});var t=new r(null,null);t.next=t.prev=t;e._head=t;if(arguments.length>0){en(Map,e,arguments[0])}return e};a=u.prototype;m.getter(a,"size",function(){if(typeof this._size==="undefined"){throw new TypeError("size method called on incompatible Map")}return this._size});b(a,{get:function get(e){o(this,"get");var t;var r=Yr(e,true);if(r!==null){t=this._storage[r];if(t){return t.value}else{return}}if(this._map){t=V.call(this._map,e);if(t){return t.value}else{return}}var n=this._head;var i=n;while((i=i.next)!==n){if(ce.SameValueZero(i.key,e)){return i.value}}},has:function has(e){o(this,"has");var t=Yr(e,true);if(t!==null){return typeof this._storage[t]!=="undefined"}if(this._map){return B.call(this._map,e)}var r=this._head;var n=r;while((n=n.next)!==r){if(ce.SameValueZero(n.key,e)){return true}}return false},set:function set(e,t){o(this,"set");var n=this._head;var i=n;var a;var u=Yr(e,true);if(u!==null){if(typeof this._storage[u]!=="undefined"){this._storage[u].value=t;return this}else{a=this._storage[u]=new r(e,t);i=n.prev}}else if(this._map){if(B.call(this._map,e)){V.call(this._map,e).value=t}else{a=new r(e,t);U.call(this._map,e,a);i=n.prev}}while((i=i.next)!==n){if(ce.SameValueZero(i.key,e)){i.value=t;return this}}a=a||new r(e,t);if(ce.SameValue(-0,e)){a.key=+0}a.next=this._head;a.prev=this._head.prev;a.prev.next=a;a.next.prev=a;this._size+=1;return this},"delete":function(t){o(this,"delete");var r=this._head;var n=r;var i=Yr(t,true);if(i!==null){if(typeof this._storage[i]==="undefined"){return false}n=this._storage[i].prev;delete this._storage[i]}else if(this._map){if(!B.call(this._map,t)){return false}n=V.call(this._map,t).prev;H.call(this._map,t)}while((n=n.next)!==r){if(ce.SameValueZero(n.key,t)){n.key=e;n.value=e;n.prev.next=n.next;n.next.prev=n.prev;this._size-=1;return true}}return false},clear:function clear(){o(this,"clear");this._map=G?new G:null;this._size=0;this._storage=Qr();var t=this._head;var r=t;var n=r.next;while((r=n)!==t){r.key=e;r.value=e;n=r.next;r.next=r.prev=t}t.next=t.prev=t},keys:function keys(){o(this,"keys");return new i(this,"key")},values:function values(){o(this,"values");return new i(this,"value")},entries:function entries(){o(this,"entries");return new i(this,"key+value")},forEach:function forEach(e){o(this,"forEach");var r=arguments.length>1?arguments[1]:null;var n=this.entries();for(var i=n.next();!i.done;i=n.next()){if(r){t(e,r,i.value[1],i.value[0],this)}else{e(i.value[1],i.value[0],this)}}}});Me(a,a.entries);return u}(),Set:function(){var e=function isSet(e){return e._es6set&&typeof e._storage!=="undefined"};var r=function requireSetSlot(t,r){if(!ce.TypeIsObject(t)||!e(t)){throw new TypeError("Set.prototype."+r+" called on incompatible receiver "+ce.ToString(t))}};var o;var i=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}if(this&&this._es6set){throw new TypeError("Bad construction")}var e=Ae(this,Set,o,{_es6set:true,"[[SetData]]":null,_storage:Qr()});if(!e._es6set){throw new TypeError("bad set")}if(arguments.length>0){tn(Set,e,arguments[0])}return e};o=i.prototype;var a=function(e){var t=e;if(t==="^null"){return null}else if(t==="^undefined"){return void 0}else{var r=t.charAt(0);if(r==="$"){return C(t,1)}else if(r==="n"){return+C(t,1)}else if(r==="b"){return t==="btrue"}}return+t};var u=function ensureMap(e){if(!e["[[SetData]]"]){var t=new rn.Map;e["[[SetData]]"]=t;l(n(e._storage),function(e){var r=a(e);t.set(r,r)});e["[[SetData]]"]=t}e._storage=null};m.getter(i.prototype,"size",function(){r(this,"size");if(this._storage){return n(this._storage).length}u(this);return this["[[SetData]]"].size});b(i.prototype,{has:function has(e){r(this,"has");var t;if(this._storage&&(t=Yr(e))!==null){return!!this._storage[t]}u(this);return this["[[SetData]]"].has(e)},add:function add(e){r(this,"add");var t;if(this._storage&&(t=Yr(e))!==null){this._storage[t]=true;return this}u(this);this["[[SetData]]"].set(e,e);return this},"delete":function(e){r(this,"delete");var t;if(this._storage&&(t=Yr(e))!==null){var n=z(this._storage,t);return delete this._storage[t]&&n}u(this);return this["[[SetData]]"]["delete"](e)},clear:function clear(){r(this,"clear");if(this._storage){this._storage=Qr()}if(this["[[SetData]]"]){this["[[SetData]]"].clear()}},values:function values(){r(this,"values");u(this);return new f(this["[[SetData]]"].values())},entries:function entries(){r(this,"entries");u(this);return new f(this["[[SetData]]"].entries())},forEach:function forEach(e){r(this,"forEach");var n=arguments.length>1?arguments[1]:null;var o=this;u(o);this["[[SetData]]"].forEach(function(r,i){if(n){t(e,n,i,i,o)}else{e(i,i,o)}})}});h(i.prototype,"keys",i.prototype.values,true);Me(i.prototype,i.prototype.values);var f=function SetIterator(e){this.it=e};f.prototype={isSetIterator:true,next:function next(){if(!this.isSetIterator){throw new TypeError("Not a SetIterator")}return this.it.next()}};Me(f.prototype);return i}()};var nn=S.Set&&!Set.prototype["delete"]&&Set.prototype.remove&&Set.prototype.items&&Set.prototype.map&&Array.isArray((new Set).keys);if(nn){S.Set=rn.Set}if(S.Map||S.Set){var on=a(function(){return new Map([[1,2]]).get(1)===2});if(!on){S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new G;if(arguments.length>0){en(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,S.Map.prototype);return e};S.Map.prototype=O(G.prototype);h(S.Map.prototype,"constructor",S.Map,true);m.preserveToString(S.Map,G)}var an=new Map;var un=function(){var e=new Map([[1,0],[2,0],[3,0],[4,0]]);e.set(-0,e);return e.get(0)===e&&e.get(-0)===e&&e.has(0)&&e.has(-0)}();var fn=an.set(1,2)===an;if(!un||!fn){ne(Map.prototype,"set",function set(e,r){t(U,this,e===0?0:e,r);return this})}if(!un){b(Map.prototype,{get:function get(e){return t(V,this,e===0?0:e)},has:function has(e){return t(B,this,e===0?0:e)}},true);m.preserveToString(Map.prototype.get,V);m.preserveToString(Map.prototype.has,B)}var sn=new Set;var cn=Set.prototype["delete"]&&Set.prototype.add&&Set.prototype.has&&function(e){e["delete"](0);e.add(-0);return!e.has(0)}(sn);var ln=sn.add(1)===sn;if(!cn||!ln){var pn=Set.prototype.add;Set.prototype.add=function add(e){t(pn,this,e===0?0:e);return this};m.preserveToString(Set.prototype.add,pn)}if(!cn){var vn=Set.prototype.has;Set.prototype.has=function has(e){return t(vn,this,e===0?0:e)};m.preserveToString(Set.prototype.has,vn);var yn=Set.prototype["delete"];Set.prototype["delete"]=function SetDelete(e){return t(yn,this,e===0?0:e)};m.preserveToString(Set.prototype["delete"],yn)}var hn=w(S.Map,function(e){var t=new e([]);t.set(42,42);return t instanceof e});var bn=Object.setPrototypeOf&&!hn;var gn=function(){try{return!(S.Map()instanceof S.Map)}catch(e){return e instanceof TypeError}}();if(S.Map.length!==0||bn||!gn){S.Map=function Map(){if(!(this instanceof Map)){throw new TypeError('Constructor Map requires "new"')}var e=new G;if(arguments.length>0){en(Map,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Map.prototype);return e};S.Map.prototype=G.prototype;h(S.Map.prototype,"constructor",S.Map,true);m.preserveToString(S.Map,G)}var dn=w(S.Set,function(e){var t=new e([]);t.add(42,42);return t instanceof e});var mn=Object.setPrototypeOf&&!dn;var On=function(){try{return!(S.Set()instanceof S.Set)}catch(e){return e instanceof TypeError}}();if(S.Set.length!==0||mn||!On){var wn=S.Set;S.Set=function Set(){if(!(this instanceof Set)){throw new TypeError('Constructor Set requires "new"')}var e=new wn;if(arguments.length>0){tn(Set,e,arguments[0])}delete e.constructor;Object.setPrototypeOf(e,Set.prototype);return e};S.Set.prototype=wn.prototype;h(S.Set.prototype,"constructor",S.Set,true);m.preserveToString(S.Set,wn)}var jn=new S.Map;var Sn=!a(function(){return jn.keys().next().done});if(typeof S.Map.prototype.clear!=="function"||(new S.Set).size!==0||jn.size!==0||typeof S.Map.prototype.keys!=="function"||typeof S.Set.prototype.keys!=="function"||typeof S.Map.prototype.forEach!=="function"||typeof S.Set.prototype.forEach!=="function"||u(S.Map)||u(S.Set)||typeof jn.keys().next!=="function"||Sn||!hn){b(S,{Map:rn.Map,Set:rn.Set},true)}if(S.Set.prototype.keys!==S.Set.prototype.values){h(S.Set.prototype,"keys",S.Set.prototype.values,true)}Me(Object.getPrototypeOf((new S.Map).keys()));Me(Object.getPrototypeOf((new S.Set).keys()));if(c&&S.Set.prototype.has.name!=="has"){var Tn=S.Set.prototype.has;ne(S.Set.prototype,"has",function has(e){return t(Tn,this,e)})}}b(S,rn);Ce(S.Map);Ce(S.Set)}var In=function throwUnlessTargetIsObject(e){if(!ce.TypeIsObject(e)){throw new TypeError("target must be an object")}};var En={apply:function apply(){return ce.Call(ce.Call,null,arguments)},construct:function construct(e,t){if(!ce.IsConstructor(e)){throw new TypeError("First argument must be a constructor.")}var r=arguments.length>2?arguments[2]:e;if(!ce.IsConstructor(r)){throw new TypeError("new.target must be a constructor.")}return ce.Construct(e,t,r,"internal")},deleteProperty:function deleteProperty(e,t){In(e);if(s){var r=Object.getOwnPropertyDescriptor(e,t);if(r&&!r.configurable){return false}}return delete e[t]},has:function has(e,t){In(e);return t in e}};if(Object.getOwnPropertyNames){Object.assign(En,{ownKeys:function ownKeys(e){In(e);var t=Object.getOwnPropertyNames(e);if(ce.IsCallable(Object.getOwnPropertySymbols)){x(t,Object.getOwnPropertySymbols(e))}return t}})}var Pn=function ConvertExceptionToBoolean(e){return!i(e)};if(Object.preventExtensions){Object.assign(En,{isExtensible:function isExtensible(e){In(e);return Object.isExtensible(e)},preventExtensions:function preventExtensions(e){In(e);return Pn(function(){return Object.preventExtensions(e)})}})}if(s){var Cn=function get(e,t,r){var n=Object.getOwnPropertyDescriptor(e,t);if(!n){var o=Object.getPrototypeOf(e);if(o===null){return void 0}return Cn(o,t,r)}if("value"in n){return n.value}if(n.get){return ce.Call(n.get,r)}return void 0};var Mn=function set(e,r,n,o){var i=Object.getOwnPropertyDescriptor(e,r);if(!i){var a=Object.getPrototypeOf(e);if(a!==null){return Mn(a,r,n,o)}i={value:void 0,writable:true,enumerable:true,configurable:true}}if("value"in i){if(!i.writable){return false}if(!ce.TypeIsObject(o)){return false}var u=Object.getOwnPropertyDescriptor(o,r);if(u){return ae.defineProperty(o,r,{value:n})}else{return ae.defineProperty(o,r,{value:n,writable:true,enumerable:true,configurable:true})}}if(i.set){t(i.set,o,n);return true}return false};Object.assign(En,{defineProperty:function defineProperty(e,t,r){In(e);return Pn(function(){return Object.defineProperty(e,t,r)})},getOwnPropertyDescriptor:function getOwnPropertyDescriptor(e,t){In(e);return Object.getOwnPropertyDescriptor(e,t)},get:function get(e,t){In(e);var r=arguments.length>2?arguments[2]:e;return Cn(e,t,r)},set:function set(e,t,r){In(e);var n=arguments.length>3?arguments[3]:e;return Mn(e,t,r,n)}})}if(Object.getPrototypeOf){var xn=Object.getPrototypeOf;En.getPrototypeOf=function getPrototypeOf(e){In(e);return xn(e)}}if(Object.setPrototypeOf&&En.getPrototypeOf){var Nn=function(e,t){var r=t;while(r){if(e===r){return true}r=En.getPrototypeOf(r)}return false};Object.assign(En,{setPrototypeOf:function setPrototypeOf(e,t){In(e);if(t!==null&&!ce.TypeIsObject(t)){throw new TypeError("proto must be an object or null")}if(t===ae.getPrototypeOf(e)){return true}if(ae.isExtensible&&!ae.isExtensible(e)){return false}if(Nn(e,t)){return false}Object.setPrototypeOf(e,t);return true}})}var An=function(e,t){if(!ce.IsCallable(S.Reflect[e])){h(S.Reflect,e,t)}else{var r=a(function(){S.Reflect[e](1);S.Reflect[e](NaN);S.Reflect[e](true);return true});if(r){ne(S.Reflect,e,t)}}};Object.keys(En).forEach(function(e){An(e,En[e])});var Rn=S.Reflect.getPrototypeOf;if(c&&Rn&&Rn.name!=="getPrototypeOf"){ne(S.Reflect,"getPrototypeOf",function getPrototypeOf(e){return t(Rn,S.Reflect,e)})}if(S.Reflect.setPrototypeOf){if(a(function(){S.Reflect.setPrototypeOf(1,{});return true})){ne(S.Reflect,"setPrototypeOf",En.setPrototypeOf)}}if(S.Reflect.defineProperty){if(!a(function(){var e=!S.Reflect.defineProperty(1,"test",{value:1});var t=typeof Object.preventExtensions!=="function"||!S.Reflect.defineProperty(Object.preventExtensions({}),"test",{});return e&&t})){ne(S.Reflect,"defineProperty",En.defineProperty)}}if(S.Reflect.construct){if(!a(function(){var e=function F(){};return S.Reflect.construct(function(){},[],e)instanceof e})){ne(S.Reflect,"construct",En.construct)}}if(String(new Date(NaN))!=="Invalid Date"){var _n=Date.prototype.toString;var kn=function toString(){var e=+this;if(e!==e){return"Invalid Date"}return ce.Call(_n,this)};ne(Date.prototype,"toString",kn)}var Ln={anchor:function anchor(e){return ce.CreateHTML(this,"a","name",e)},big:function big(){return ce.CreateHTML(this,"big","","")},blink:function blink(){return ce.CreateHTML(this,"blink","","")},bold:function bold(){return ce.CreateHTML(this,"b","","")},fixed:function fixed(){return ce.CreateHTML(this,"tt","","")},fontcolor:function fontcolor(e){return ce.CreateHTML(this,"font","color",e)},fontsize:function fontsize(e){return ce.CreateHTML(this,"font","size",e)},italics:function italics(){return ce.CreateHTML(this,"i","","")},link:function link(e){return ce.CreateHTML(this,"a","href",e)},small:function small(){return ce.CreateHTML(this,"small","","")},strike:function strike(){return ce.CreateHTML(this,"strike","","")},sub:function sub(){return ce.CreateHTML(this,"sub","","")},sup:function sub(){return ce.CreateHTML(this,"sup","","")}};l(Object.keys(Ln),function(e){var r=String.prototype[e];var n=false;if(ce.IsCallable(r)){var o=t(r,"",' " ');var i=P([],o.match(/"/g)).length;n=o!==o.toLowerCase()||i>2}else{n=true}if(n){ne(String.prototype,e,Ln[e])}});var Fn=function(){if(!oe){return false}var e=typeof JSON==="object"&&typeof JSON.stringify==="function"?JSON.stringify:null;if(!e){return false}if(typeof e($())!=="undefined"){return true}if(e([$()])!=="[null]"){return true}var t={a:$()};t[$()]=true;if(e(t)!=="{}"){return true}return false}();var Dn=a(function(){if(!oe){return true}return JSON.stringify(Object($()))==="{}"&&JSON.stringify([Object($())])==="[{}]"});if(Fn||!Dn){var zn=JSON.stringify;ne(JSON,"stringify",function stringify(e){if(typeof e==="symbol"){return}var n;if(arguments.length>1){n=arguments[1]}var o=[e];if(!r(n)){var i=ce.IsCallable(n)?n:null;var a=function(e,r){var n=i?t(i,this,e,r):r;if(typeof n!=="symbol"){if(re.symbol(n)){return Nt({})(n)}else{return n}}};o.push(a)}else{o.push(n)}if(arguments.length>2){o.push(arguments[2])}return zn.apply(this,o)})}return S});
//# sourceMappingURL=es6-shim.map
/*! jQuery v3.4.1 | (c) JS Foundation and other contributors | jquery.org/license */
!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(C,e){"use strict";var t=[],E=C.document,r=Object.getPrototypeOf,s=t.slice,g=t.concat,u=t.push,i=t.indexOf,n={},o=n.toString,v=n.hasOwnProperty,a=v.toString,l=a.call(Object),y={},m=function(e){return"function"==typeof e&&"number"!=typeof e.nodeType},x=function(e){return null!=e&&e===e.window},c={type:!0,src:!0,nonce:!0,noModule:!0};function b(e,t,n){var r,i,o=(n=n||E).createElement("script");if(o.text=e,t)for(r in c)(i=t[r]||t.getAttribute&&t.getAttribute(r))&&o.setAttribute(r,i);n.head.appendChild(o).parentNode.removeChild(o)}function w(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?n[o.call(e)]||"object":typeof e}var f="3.4.1",k=function(e,t){return new k.fn.init(e,t)},p=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;function d(e){var t=!!e&&"length"in e&&e.length,n=w(e);return!m(e)&&!x(e)&&("array"===n||0===t||"number"==typeof t&&0<t&&t-1 in e)}k.fn=k.prototype={jquery:f,constructor:k,length:0,toArray:function(){return s.call(this)},get:function(e){return null==e?s.call(this):e<0?this[e+this.length]:this[e]},pushStack:function(e){var t=k.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return k.each(this,e)},map:function(n){return this.pushStack(k.map(this,function(e,t){return n.call(e,t,e)}))},slice:function(){return this.pushStack(s.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(0<=n&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:u,sort:t.sort,splice:t.splice},k.extend=k.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||m(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)r=e[t],"__proto__"!==t&&a!==r&&(l&&r&&(k.isPlainObject(r)||(i=Array.isArray(r)))?(n=a[t],o=i&&!Array.isArray(n)?[]:i||k.isPlainObject(n)?n:{},i=!1,a[t]=k.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},k.extend({expando:"jQuery"+(f+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==o.call(e))&&(!(t=r(e))||"function"==typeof(n=v.call(t,"constructor")&&t.constructor)&&a.call(n)===l)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},globalEval:function(e,t){b(e,{nonce:t&&t.nonce})},each:function(e,t){var n,r=0;if(d(e)){for(n=e.length;r<n;r++)if(!1===t.call(e[r],r,e[r]))break}else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},trim:function(e){return null==e?"":(e+"").replace(p,"")},makeArray:function(e,t){var n=t||[];return null!=e&&(d(Object(e))?k.merge(n,"string"==typeof e?[e]:e):u.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:i.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,a=[];if(d(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&a.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&a.push(i);return g.apply([],a)},guid:1,support:y}),"function"==typeof Symbol&&(k.fn[Symbol.iterator]=t[Symbol.iterator]),k.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){n["[object "+t+"]"]=t.toLowerCase()});var h=function(n){var e,d,b,o,i,h,f,g,w,u,l,T,C,a,E,v,s,c,y,k="sizzle"+1*new Date,m=n.document,S=0,r=0,p=ue(),x=ue(),N=ue(),A=ue(),D=function(e,t){return e===t&&(l=!0),0},j={}.hasOwnProperty,t=[],q=t.pop,L=t.push,H=t.push,O=t.slice,P=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},R="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",M="[\\x20\\t\\r\\n\\f]",I="(?:\\\\.|[\\w-]|[^\0-\\xa0])+",W="\\["+M+"*("+I+")(?:"+M+"*([*^$|!~]?=)"+M+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+I+"))|)"+M+"*\\]",$=":("+I+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+W+")*)|.*)\\)|)",F=new RegExp(M+"+","g"),B=new RegExp("^"+M+"+|((?:^|[^\\\\])(?:\\\\.)*)"+M+"+$","g"),_=new RegExp("^"+M+"*,"+M+"*"),z=new RegExp("^"+M+"*([>+~]|"+M+")"+M+"*"),U=new RegExp(M+"|>"),X=new RegExp($),V=new RegExp("^"+I+"$"),G={ID:new RegExp("^#("+I+")"),CLASS:new RegExp("^\\.("+I+")"),TAG:new RegExp("^("+I+"|[*])"),ATTR:new RegExp("^"+W),PSEUDO:new RegExp("^"+$),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+M+"*(even|odd|(([+-]|)(\\d*)n|)"+M+"*(?:([+-]|)"+M+"*(\\d+)|))"+M+"*\\)|)","i"),bool:new RegExp("^(?:"+R+")$","i"),needsContext:new RegExp("^"+M+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+M+"*((?:-\\d)?\\d*)"+M+"*\\)|)(?=[^-]|$)","i")},Y=/HTML$/i,Q=/^(?:input|select|textarea|button)$/i,J=/^h\d$/i,K=/^[^{]+\{\s*\[native \w/,Z=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ee=/[+~]/,te=new RegExp("\\\\([\\da-f]{1,6}"+M+"?|("+M+")|.)","ig"),ne=function(e,t,n){var r="0x"+t-65536;return r!=r||n?t:r<0?String.fromCharCode(r+65536):String.fromCharCode(r>>10|55296,1023&r|56320)},re=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\0-\x1f\x7f-\uFFFF\w-]/g,ie=function(e,t){return t?"\0"===e?"\ufffd":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},oe=function(){T()},ae=be(function(e){return!0===e.disabled&&"fieldset"===e.nodeName.toLowerCase()},{dir:"parentNode",next:"legend"});try{H.apply(t=O.call(m.childNodes),m.childNodes),t[m.childNodes.length].nodeType}catch(e){H={apply:t.length?function(e,t){L.apply(e,O.call(t))}:function(e,t){var n=e.length,r=0;while(e[n++]=t[r++]);e.length=n-1}}}function se(t,e,n,r){var i,o,a,s,u,l,c,f=e&&e.ownerDocument,p=e?e.nodeType:9;if(n=n||[],"string"!=typeof t||!t||1!==p&&9!==p&&11!==p)return n;if(!r&&((e?e.ownerDocument||e:m)!==C&&T(e),e=e||C,E)){if(11!==p&&(u=Z.exec(t)))if(i=u[1]){if(9===p){if(!(a=e.getElementById(i)))return n;if(a.id===i)return n.push(a),n}else if(f&&(a=f.getElementById(i))&&y(e,a)&&a.id===i)return n.push(a),n}else{if(u[2])return H.apply(n,e.getElementsByTagName(t)),n;if((i=u[3])&&d.getElementsByClassName&&e.getElementsByClassName)return H.apply(n,e.getElementsByClassName(i)),n}if(d.qsa&&!A[t+" "]&&(!v||!v.test(t))&&(1!==p||"object"!==e.nodeName.toLowerCase())){if(c=t,f=e,1===p&&U.test(t)){(s=e.getAttribute("id"))?s=s.replace(re,ie):e.setAttribute("id",s=k),o=(l=h(t)).length;while(o--)l[o]="#"+s+" "+xe(l[o]);c=l.join(","),f=ee.test(t)&&ye(e.parentNode)||e}try{return H.apply(n,f.querySelectorAll(c)),n}catch(e){A(t,!0)}finally{s===k&&e.removeAttribute("id")}}}return g(t.replace(B,"$1"),e,n,r)}function ue(){var r=[];return function e(t,n){return r.push(t+" ")>b.cacheLength&&delete e[r.shift()],e[t+" "]=n}}function le(e){return e[k]=!0,e}function ce(e){var t=C.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function fe(e,t){var n=e.split("|"),r=n.length;while(r--)b.attrHandle[n[r]]=t}function pe(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(r)return r;if(n)while(n=n.nextSibling)if(n===t)return-1;return e?1:-1}function de(t){return function(e){return"input"===e.nodeName.toLowerCase()&&e.type===t}}function he(n){return function(e){var t=e.nodeName.toLowerCase();return("input"===t||"button"===t)&&e.type===n}}function ge(t){return function(e){return"form"in e?e.parentNode&&!1===e.disabled?"label"in e?"label"in e.parentNode?e.parentNode.disabled===t:e.disabled===t:e.isDisabled===t||e.isDisabled!==!t&&ae(e)===t:e.disabled===t:"label"in e&&e.disabled===t}}function ve(a){return le(function(o){return o=+o,le(function(e,t){var n,r=a([],e.length,o),i=r.length;while(i--)e[n=r[i]]&&(e[n]=!(t[n]=e[n]))})})}function ye(e){return e&&"undefined"!=typeof e.getElementsByTagName&&e}for(e in d=se.support={},i=se.isXML=function(e){var t=e.namespaceURI,n=(e.ownerDocument||e).documentElement;return!Y.test(t||n&&n.nodeName||"HTML")},T=se.setDocument=function(e){var t,n,r=e?e.ownerDocument||e:m;return r!==C&&9===r.nodeType&&r.documentElement&&(a=(C=r).documentElement,E=!i(C),m!==C&&(n=C.defaultView)&&n.top!==n&&(n.addEventListener?n.addEventListener("unload",oe,!1):n.attachEvent&&n.attachEvent("onunload",oe)),d.attributes=ce(function(e){return e.className="i",!e.getAttribute("className")}),d.getElementsByTagName=ce(function(e){return e.appendChild(C.createComment("")),!e.getElementsByTagName("*").length}),d.getElementsByClassName=K.test(C.getElementsByClassName),d.getById=ce(function(e){return a.appendChild(e).id=k,!C.getElementsByName||!C.getElementsByName(k).length}),d.getById?(b.filter.ID=function(e){var t=e.replace(te,ne);return function(e){return e.getAttribute("id")===t}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&E){var n=t.getElementById(e);return n?[n]:[]}}):(b.filter.ID=function(e){var n=e.replace(te,ne);return function(e){var t="undefined"!=typeof e.getAttributeNode&&e.getAttributeNode("id");return t&&t.value===n}},b.find.ID=function(e,t){if("undefined"!=typeof t.getElementById&&E){var n,r,i,o=t.getElementById(e);if(o){if((n=o.getAttributeNode("id"))&&n.value===e)return[o];i=t.getElementsByName(e),r=0;while(o=i[r++])if((n=o.getAttributeNode("id"))&&n.value===e)return[o]}return[]}}),b.find.TAG=d.getElementsByTagName?function(e,t){return"undefined"!=typeof t.getElementsByTagName?t.getElementsByTagName(e):d.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){while(n=o[i++])1===n.nodeType&&r.push(n);return r}return o},b.find.CLASS=d.getElementsByClassName&&function(e,t){if("undefined"!=typeof t.getElementsByClassName&&E)return t.getElementsByClassName(e)},s=[],v=[],(d.qsa=K.test(C.querySelectorAll))&&(ce(function(e){a.appendChild(e).innerHTML="<a id='"+k+"'></a><select id='"+k+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&v.push("[*^$]="+M+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||v.push("\\["+M+"*(?:value|"+R+")"),e.querySelectorAll("[id~="+k+"-]").length||v.push("~="),e.querySelectorAll(":checked").length||v.push(":checked"),e.querySelectorAll("a#"+k+"+*").length||v.push(".#.+[+~]")}),ce(function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=C.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&v.push("name"+M+"*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&v.push(":enabled",":disabled"),a.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&v.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),v.push(",.*:")})),(d.matchesSelector=K.test(c=a.matches||a.webkitMatchesSelector||a.mozMatchesSelector||a.oMatchesSelector||a.msMatchesSelector))&&ce(function(e){d.disconnectedMatch=c.call(e,"*"),c.call(e,"[s!='']:x"),s.push("!=",$)}),v=v.length&&new RegExp(v.join("|")),s=s.length&&new RegExp(s.join("|")),t=K.test(a.compareDocumentPosition),y=t||K.test(a.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)while(t=t.parentNode)if(t===e)return!0;return!1},D=t?function(e,t){if(e===t)return l=!0,0;var n=!e.compareDocumentPosition-!t.compareDocumentPosition;return n||(1&(n=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!d.sortDetached&&t.compareDocumentPosition(e)===n?e===C||e.ownerDocument===m&&y(m,e)?-1:t===C||t.ownerDocument===m&&y(m,t)?1:u?P(u,e)-P(u,t):0:4&n?-1:1)}:function(e,t){if(e===t)return l=!0,0;var n,r=0,i=e.parentNode,o=t.parentNode,a=[e],s=[t];if(!i||!o)return e===C?-1:t===C?1:i?-1:o?1:u?P(u,e)-P(u,t):0;if(i===o)return pe(e,t);n=e;while(n=n.parentNode)a.unshift(n);n=t;while(n=n.parentNode)s.unshift(n);while(a[r]===s[r])r++;return r?pe(a[r],s[r]):a[r]===m?-1:s[r]===m?1:0}),C},se.matches=function(e,t){return se(e,null,null,t)},se.matchesSelector=function(e,t){if((e.ownerDocument||e)!==C&&T(e),d.matchesSelector&&E&&!A[t+" "]&&(!s||!s.test(t))&&(!v||!v.test(t)))try{var n=c.call(e,t);if(n||d.disconnectedMatch||e.document&&11!==e.document.nodeType)return n}catch(e){A(t,!0)}return 0<se(t,C,null,[e]).length},se.contains=function(e,t){return(e.ownerDocument||e)!==C&&T(e),y(e,t)},se.attr=function(e,t){(e.ownerDocument||e)!==C&&T(e);var n=b.attrHandle[t.toLowerCase()],r=n&&j.call(b.attrHandle,t.toLowerCase())?n(e,t,!E):void 0;return void 0!==r?r:d.attributes||!E?e.getAttribute(t):(r=e.getAttributeNode(t))&&r.specified?r.value:null},se.escape=function(e){return(e+"").replace(re,ie)},se.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},se.uniqueSort=function(e){var t,n=[],r=0,i=0;if(l=!d.detectDuplicates,u=!d.sortStable&&e.slice(0),e.sort(D),l){while(t=e[i++])t===e[i]&&(r=n.push(i));while(r--)e.splice(n[r],1)}return u=null,e},o=se.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=o(e)}else if(3===i||4===i)return e.nodeValue}else while(t=e[r++])n+=o(t);return n},(b=se.selectors={cacheLength:50,createPseudo:le,match:G,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(te,ne),e[3]=(e[3]||e[4]||e[5]||"").replace(te,ne),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||se.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&se.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return G.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&X.test(n)&&(t=h(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(te,ne).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=p[e+" "];return t||(t=new RegExp("(^|"+M+")"+e+"("+M+"|$)"))&&p(e,function(e){return t.test("string"==typeof e.className&&e.className||"undefined"!=typeof e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(n,r,i){return function(e){var t=se.attr(e,n);return null==t?"!="===r:!r||(t+="","="===r?t===i:"!="===r?t!==i:"^="===r?i&&0===t.indexOf(i):"*="===r?i&&-1<t.indexOf(i):"$="===r?i&&t.slice(-i.length)===i:"~="===r?-1<(" "+t.replace(F," ")+" ").indexOf(i):"|="===r&&(t===i||t.slice(0,i.length+1)===i+"-"))}},CHILD:function(h,e,t,g,v){var y="nth"!==h.slice(0,3),m="last"!==h.slice(-4),x="of-type"===e;return 1===g&&0===v?function(e){return!!e.parentNode}:function(e,t,n){var r,i,o,a,s,u,l=y!==m?"nextSibling":"previousSibling",c=e.parentNode,f=x&&e.nodeName.toLowerCase(),p=!n&&!x,d=!1;if(c){if(y){while(l){a=e;while(a=a[l])if(x?a.nodeName.toLowerCase()===f:1===a.nodeType)return!1;u=l="only"===h&&!u&&"nextSibling"}return!0}if(u=[m?c.firstChild:c.lastChild],m&&p){d=(s=(r=(i=(o=(a=c)[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===S&&r[1])&&r[2],a=s&&c.childNodes[s];while(a=++s&&a&&a[l]||(d=s=0)||u.pop())if(1===a.nodeType&&++d&&a===e){i[h]=[S,s,d];break}}else if(p&&(d=s=(r=(i=(o=(a=e)[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]||[])[0]===S&&r[1]),!1===d)while(a=++s&&a&&a[l]||(d=s=0)||u.pop())if((x?a.nodeName.toLowerCase()===f:1===a.nodeType)&&++d&&(p&&((i=(o=a[k]||(a[k]={}))[a.uniqueID]||(o[a.uniqueID]={}))[h]=[S,d]),a===e))break;return(d-=v)===g||d%g==0&&0<=d/g}}},PSEUDO:function(e,o){var t,a=b.pseudos[e]||b.setFilters[e.toLowerCase()]||se.error("unsupported pseudo: "+e);return a[k]?a(o):1<a.length?(t=[e,e,"",o],b.setFilters.hasOwnProperty(e.toLowerCase())?le(function(e,t){var n,r=a(e,o),i=r.length;while(i--)e[n=P(e,r[i])]=!(t[n]=r[i])}):function(e){return a(e,0,t)}):a}},pseudos:{not:le(function(e){var r=[],i=[],s=f(e.replace(B,"$1"));return s[k]?le(function(e,t,n,r){var i,o=s(e,null,r,[]),a=e.length;while(a--)(i=o[a])&&(e[a]=!(t[a]=i))}):function(e,t,n){return r[0]=e,s(r,null,n,i),r[0]=null,!i.pop()}}),has:le(function(t){return function(e){return 0<se(t,e).length}}),contains:le(function(t){return t=t.replace(te,ne),function(e){return-1<(e.textContent||o(e)).indexOf(t)}}),lang:le(function(n){return V.test(n||"")||se.error("unsupported lang: "+n),n=n.replace(te,ne).toLowerCase(),function(e){var t;do{if(t=E?e.lang:e.getAttribute("xml:lang")||e.getAttribute("lang"))return(t=t.toLowerCase())===n||0===t.indexOf(n+"-")}while((e=e.parentNode)&&1===e.nodeType);return!1}}),target:function(e){var t=n.location&&n.location.hash;return t&&t.slice(1)===e.id},root:function(e){return e===a},focus:function(e){return e===C.activeElement&&(!C.hasFocus||C.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:ge(!1),disabled:ge(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!b.pseudos.empty(e)},header:function(e){return J.test(e.nodeName)},input:function(e){return Q.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:ve(function(){return[0]}),last:ve(function(e,t){return[t-1]}),eq:ve(function(e,t,n){return[n<0?n+t:n]}),even:ve(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:ve(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:ve(function(e,t,n){for(var r=n<0?n+t:t<n?t:n;0<=--r;)e.push(r);return e}),gt:ve(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=b.pseudos.eq,{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})b.pseudos[e]=de(e);for(e in{submit:!0,reset:!0})b.pseudos[e]=he(e);function me(){}function xe(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function be(s,e,t){var u=e.dir,l=e.next,c=l||u,f=t&&"parentNode"===c,p=r++;return e.first?function(e,t,n){while(e=e[u])if(1===e.nodeType||f)return s(e,t,n);return!1}:function(e,t,n){var r,i,o,a=[S,p];if(n){while(e=e[u])if((1===e.nodeType||f)&&s(e,t,n))return!0}else while(e=e[u])if(1===e.nodeType||f)if(i=(o=e[k]||(e[k]={}))[e.uniqueID]||(o[e.uniqueID]={}),l&&l===e.nodeName.toLowerCase())e=e[u]||e;else{if((r=i[c])&&r[0]===S&&r[1]===p)return a[2]=r[2];if((i[c]=a)[2]=s(e,t,n))return!0}return!1}}function we(i){return 1<i.length?function(e,t,n){var r=i.length;while(r--)if(!i[r](e,t,n))return!1;return!0}:i[0]}function Te(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function Ce(d,h,g,v,y,e){return v&&!v[k]&&(v=Ce(v)),y&&!y[k]&&(y=Ce(y,e)),le(function(e,t,n,r){var i,o,a,s=[],u=[],l=t.length,c=e||function(e,t,n){for(var r=0,i=t.length;r<i;r++)se(e,t[r],n);return n}(h||"*",n.nodeType?[n]:n,[]),f=!d||!e&&h?c:Te(c,s,d,n,r),p=g?y||(e?d:l||v)?[]:t:f;if(g&&g(f,p,n,r),v){i=Te(p,u),v(i,[],n,r),o=i.length;while(o--)(a=i[o])&&(p[u[o]]=!(f[u[o]]=a))}if(e){if(y||d){if(y){i=[],o=p.length;while(o--)(a=p[o])&&i.push(f[o]=a);y(null,p=[],i,r)}o=p.length;while(o--)(a=p[o])&&-1<(i=y?P(e,a):s[o])&&(e[i]=!(t[i]=a))}}else p=Te(p===t?p.splice(l,p.length):p),y?y(null,t,p,r):H.apply(t,p)})}function Ee(e){for(var i,t,n,r=e.length,o=b.relative[e[0].type],a=o||b.relative[" "],s=o?1:0,u=be(function(e){return e===i},a,!0),l=be(function(e){return-1<P(i,e)},a,!0),c=[function(e,t,n){var r=!o&&(n||t!==w)||((i=t).nodeType?u(e,t,n):l(e,t,n));return i=null,r}];s<r;s++)if(t=b.relative[e[s].type])c=[be(we(c),t)];else{if((t=b.filter[e[s].type].apply(null,e[s].matches))[k]){for(n=++s;n<r;n++)if(b.relative[e[n].type])break;return Ce(1<s&&we(c),1<s&&xe(e.slice(0,s-1).concat({value:" "===e[s-2].type?"*":""})).replace(B,"$1"),t,s<n&&Ee(e.slice(s,n)),n<r&&Ee(e=e.slice(n)),n<r&&xe(e))}c.push(t)}return we(c)}return me.prototype=b.filters=b.pseudos,b.setFilters=new me,h=se.tokenize=function(e,t){var n,r,i,o,a,s,u,l=x[e+" "];if(l)return t?0:l.slice(0);a=e,s=[],u=b.preFilter;while(a){for(o in n&&!(r=_.exec(a))||(r&&(a=a.slice(r[0].length)||a),s.push(i=[])),n=!1,(r=z.exec(a))&&(n=r.shift(),i.push({value:n,type:r[0].replace(B," ")}),a=a.slice(n.length)),b.filter)!(r=G[o].exec(a))||u[o]&&!(r=u[o](r))||(n=r.shift(),i.push({value:n,type:o,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?se.error(e):x(e,s).slice(0)},f=se.compile=function(e,t){var n,v,y,m,x,r,i=[],o=[],a=N[e+" "];if(!a){t||(t=h(e)),n=t.length;while(n--)(a=Ee(t[n]))[k]?i.push(a):o.push(a);(a=N(e,(v=o,m=0<(y=i).length,x=0<v.length,r=function(e,t,n,r,i){var o,a,s,u=0,l="0",c=e&&[],f=[],p=w,d=e||x&&b.find.TAG("*",i),h=S+=null==p?1:Math.random()||.1,g=d.length;for(i&&(w=t===C||t||i);l!==g&&null!=(o=d[l]);l++){if(x&&o){a=0,t||o.ownerDocument===C||(T(o),n=!E);while(s=v[a++])if(s(o,t||C,n)){r.push(o);break}i&&(S=h)}m&&((o=!s&&o)&&u--,e&&c.push(o))}if(u+=l,m&&l!==u){a=0;while(s=y[a++])s(c,f,t,n);if(e){if(0<u)while(l--)c[l]||f[l]||(f[l]=q.call(r));f=Te(f)}H.apply(r,f),i&&!e&&0<f.length&&1<u+y.length&&se.uniqueSort(r)}return i&&(S=h,w=p),c},m?le(r):r))).selector=e}return a},g=se.select=function(e,t,n,r){var i,o,a,s,u,l="function"==typeof e&&e,c=!r&&h(e=l.selector||e);if(n=n||[],1===c.length){if(2<(o=c[0]=c[0].slice(0)).length&&"ID"===(a=o[0]).type&&9===t.nodeType&&E&&b.relative[o[1].type]){if(!(t=(b.find.ID(a.matches[0].replace(te,ne),t)||[])[0]))return n;l&&(t=t.parentNode),e=e.slice(o.shift().value.length)}i=G.needsContext.test(e)?0:o.length;while(i--){if(a=o[i],b.relative[s=a.type])break;if((u=b.find[s])&&(r=u(a.matches[0].replace(te,ne),ee.test(o[0].type)&&ye(t.parentNode)||t))){if(o.splice(i,1),!(e=r.length&&xe(o)))return H.apply(n,r),n;break}}}return(l||f(e,c))(r,t,!E,n,!t||ee.test(e)&&ye(t.parentNode)||t),n},d.sortStable=k.split("").sort(D).join("")===k,d.detectDuplicates=!!l,T(),d.sortDetached=ce(function(e){return 1&e.compareDocumentPosition(C.createElement("fieldset"))}),ce(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||fe("type|href|height|width",function(e,t,n){if(!n)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),d.attributes&&ce(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||fe("value",function(e,t,n){if(!n&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),ce(function(e){return null==e.getAttribute("disabled")})||fe(R,function(e,t,n){var r;if(!n)return!0===e[t]?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null}),se}(C);k.find=h,k.expr=h.selectors,k.expr[":"]=k.expr.pseudos,k.uniqueSort=k.unique=h.uniqueSort,k.text=h.getText,k.isXMLDoc=h.isXML,k.contains=h.contains,k.escapeSelector=h.escape;var T=function(e,t,n){var r=[],i=void 0!==n;while((e=e[t])&&9!==e.nodeType)if(1===e.nodeType){if(i&&k(e).is(n))break;r.push(e)}return r},S=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},N=k.expr.match.needsContext;function A(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()}var D=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function j(e,n,r){return m(n)?k.grep(e,function(e,t){return!!n.call(e,t,e)!==r}):n.nodeType?k.grep(e,function(e){return e===n!==r}):"string"!=typeof n?k.grep(e,function(e){return-1<i.call(n,e)!==r}):k.filter(n,e,r)}k.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?k.find.matchesSelector(r,e)?[r]:[]:k.find.matches(e,k.grep(t,function(e){return 1===e.nodeType}))},k.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(k(e).filter(function(){for(t=0;t<r;t++)if(k.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)k.find(e,i[t],n);return 1<r?k.uniqueSort(n):n},filter:function(e){return this.pushStack(j(this,e||[],!1))},not:function(e){return this.pushStack(j(this,e||[],!0))},is:function(e){return!!j(this,"string"==typeof e&&N.test(e)?k(e):e||[],!1).length}});var q,L=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(k.fn.init=function(e,t,n){var r,i;if(!e)return this;if(n=n||q,"string"==typeof e){if(!(r="<"===e[0]&&">"===e[e.length-1]&&3<=e.length?[null,e,null]:L.exec(e))||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof k?t[0]:t,k.merge(this,k.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:E,!0)),D.test(r[1])&&k.isPlainObject(t))for(r in t)m(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return(i=E.getElementById(r[2]))&&(this[0]=i,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):m(e)?void 0!==n.ready?n.ready(e):e(k):k.makeArray(e,this)}).prototype=k.fn,q=k(E);var H=/^(?:parents|prev(?:Until|All))/,O={children:!0,contents:!0,next:!0,prev:!0};function P(e,t){while((e=e[t])&&1!==e.nodeType);return e}k.fn.extend({has:function(e){var t=k(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(k.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&k(e);if(!N.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?-1<a.index(n):1===n.nodeType&&k.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(1<o.length?k.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?i.call(k(e),this[0]):i.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(k.uniqueSort(k.merge(this.get(),k(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),k.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return T(e,"parentNode")},parentsUntil:function(e,t,n){return T(e,"parentNode",n)},next:function(e){return P(e,"nextSibling")},prev:function(e){return P(e,"previousSibling")},nextAll:function(e){return T(e,"nextSibling")},prevAll:function(e){return T(e,"previousSibling")},nextUntil:function(e,t,n){return T(e,"nextSibling",n)},prevUntil:function(e,t,n){return T(e,"previousSibling",n)},siblings:function(e){return S((e.parentNode||{}).firstChild,e)},children:function(e){return S(e.firstChild)},contents:function(e){return"undefined"!=typeof e.contentDocument?e.contentDocument:(A(e,"template")&&(e=e.content||e),k.merge([],e.childNodes))}},function(r,i){k.fn[r]=function(e,t){var n=k.map(this,i,e);return"Until"!==r.slice(-5)&&(t=e),t&&"string"==typeof t&&(n=k.filter(t,n)),1<this.length&&(O[r]||k.uniqueSort(n),H.test(r)&&n.reverse()),this.pushStack(n)}});var R=/[^\x20\t\r\n\f]+/g;function M(e){return e}function I(e){throw e}function W(e,t,n,r){var i;try{e&&m(i=e.promise)?i.call(e).done(t).fail(n):e&&m(i=e.then)?i.call(e,t,n):t.apply(void 0,[e].slice(r))}catch(e){n.apply(void 0,[e])}}k.Callbacks=function(r){var e,n;r="string"==typeof r?(e=r,n={},k.each(e.match(R)||[],function(e,t){n[t]=!0}),n):k.extend({},r);var i,t,o,a,s=[],u=[],l=-1,c=function(){for(a=a||r.once,o=i=!0;u.length;l=-1){t=u.shift();while(++l<s.length)!1===s[l].apply(t[0],t[1])&&r.stopOnFalse&&(l=s.length,t=!1)}r.memory||(t=!1),i=!1,a&&(s=t?[]:"")},f={add:function(){return s&&(t&&!i&&(l=s.length-1,u.push(t)),function n(e){k.each(e,function(e,t){m(t)?r.unique&&f.has(t)||s.push(t):t&&t.length&&"string"!==w(t)&&n(t)})}(arguments),t&&!i&&c()),this},remove:function(){return k.each(arguments,function(e,t){var n;while(-1<(n=k.inArray(t,s,n)))s.splice(n,1),n<=l&&l--}),this},has:function(e){return e?-1<k.inArray(e,s):0<s.length},empty:function(){return s&&(s=[]),this},disable:function(){return a=u=[],s=t="",this},disabled:function(){return!s},lock:function(){return a=u=[],t||i||(s=t=""),this},locked:function(){return!!a},fireWith:function(e,t){return a||(t=[e,(t=t||[]).slice?t.slice():t],u.push(t),i||c()),this},fire:function(){return f.fireWith(this,arguments),this},fired:function(){return!!o}};return f},k.extend({Deferred:function(e){var o=[["notify","progress",k.Callbacks("memory"),k.Callbacks("memory"),2],["resolve","done",k.Callbacks("once memory"),k.Callbacks("once memory"),0,"resolved"],["reject","fail",k.Callbacks("once memory"),k.Callbacks("once memory"),1,"rejected"]],i="pending",a={state:function(){return i},always:function(){return s.done(arguments).fail(arguments),this},"catch":function(e){return a.then(null,e)},pipe:function(){var i=arguments;return k.Deferred(function(r){k.each(o,function(e,t){var n=m(i[t[4]])&&i[t[4]];s[t[1]](function(){var e=n&&n.apply(this,arguments);e&&m(e.promise)?e.promise().progress(r.notify).done(r.resolve).fail(r.reject):r[t[0]+"With"](this,n?[e]:arguments)})}),i=null}).promise()},then:function(t,n,r){var u=0;function l(i,o,a,s){return function(){var n=this,r=arguments,e=function(){var e,t;if(!(i<u)){if((e=a.apply(n,r))===o.promise())throw new TypeError("Thenable self-resolution");t=e&&("object"==typeof e||"function"==typeof e)&&e.then,m(t)?s?t.call(e,l(u,o,M,s),l(u,o,I,s)):(u++,t.call(e,l(u,o,M,s),l(u,o,I,s),l(u,o,M,o.notifyWith))):(a!==M&&(n=void 0,r=[e]),(s||o.resolveWith)(n,r))}},t=s?e:function(){try{e()}catch(e){k.Deferred.exceptionHook&&k.Deferred.exceptionHook(e,t.stackTrace),u<=i+1&&(a!==I&&(n=void 0,r=[e]),o.rejectWith(n,r))}};i?t():(k.Deferred.getStackHook&&(t.stackTrace=k.Deferred.getStackHook()),C.setTimeout(t))}}return k.Deferred(function(e){o[0][3].add(l(0,e,m(r)?r:M,e.notifyWith)),o[1][3].add(l(0,e,m(t)?t:M)),o[2][3].add(l(0,e,m(n)?n:I))}).promise()},promise:function(e){return null!=e?k.extend(e,a):a}},s={};return k.each(o,function(e,t){var n=t[2],r=t[5];a[t[1]]=n.add,r&&n.add(function(){i=r},o[3-e][2].disable,o[3-e][3].disable,o[0][2].lock,o[0][3].lock),n.add(t[3].fire),s[t[0]]=function(){return s[t[0]+"With"](this===s?void 0:this,arguments),this},s[t[0]+"With"]=n.fireWith}),a.promise(s),e&&e.call(s,s),s},when:function(e){var n=arguments.length,t=n,r=Array(t),i=s.call(arguments),o=k.Deferred(),a=function(t){return function(e){r[t]=this,i[t]=1<arguments.length?s.call(arguments):e,--n||o.resolveWith(r,i)}};if(n<=1&&(W(e,o.done(a(t)).resolve,o.reject,!n),"pending"===o.state()||m(i[t]&&i[t].then)))return o.then();while(t--)W(i[t],a(t),o.reject);return o.promise()}});var $=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;k.Deferred.exceptionHook=function(e,t){C.console&&C.console.warn&&e&&$.test(e.name)&&C.console.warn("jQuery.Deferred exception: "+e.message,e.stack,t)},k.readyException=function(e){C.setTimeout(function(){throw e})};var F=k.Deferred();function B(){E.removeEventListener("DOMContentLoaded",B),C.removeEventListener("load",B),k.ready()}k.fn.ready=function(e){return F.then(e)["catch"](function(e){k.readyException(e)}),this},k.extend({isReady:!1,readyWait:1,ready:function(e){(!0===e?--k.readyWait:k.isReady)||(k.isReady=!0)!==e&&0<--k.readyWait||F.resolveWith(E,[k])}}),k.ready.then=F.then,"complete"===E.readyState||"loading"!==E.readyState&&!E.documentElement.doScroll?C.setTimeout(k.ready):(E.addEventListener("DOMContentLoaded",B),C.addEventListener("load",B));var _=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===w(n))for(s in i=!0,n)_(e,t,s,n[s],!0,o,a);else if(void 0!==r&&(i=!0,m(r)||(a=!0),l&&(a?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(k(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},z=/^-ms-/,U=/-([a-z])/g;function X(e,t){return t.toUpperCase()}function V(e){return e.replace(z,"ms-").replace(U,X)}var G=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};function Y(){this.expando=k.expando+Y.uid++}Y.uid=1,Y.prototype={cache:function(e){var t=e[this.expando];return t||(t={},G(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[V(t)]=n;else for(r in t)i[V(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][V(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=Array.isArray(t)?t.map(V):(t=V(t))in r?[t]:t.match(R)||[]).length;while(n--)delete r[t[n]]}(void 0===t||k.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!k.isEmptyObject(t)}};var Q=new Y,J=new Y,K=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,Z=/[A-Z]/g;function ee(e,t,n){var r,i;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(Z,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===(i=n)||"false"!==i&&("null"===i?null:i===+i+""?+i:K.test(i)?JSON.parse(i):i)}catch(e){}J.set(e,t,n)}else n=void 0;return n}k.extend({hasData:function(e){return J.hasData(e)||Q.hasData(e)},data:function(e,t,n){return J.access(e,t,n)},removeData:function(e,t){J.remove(e,t)},_data:function(e,t,n){return Q.access(e,t,n)},_removeData:function(e,t){Q.remove(e,t)}}),k.fn.extend({data:function(n,e){var t,r,i,o=this[0],a=o&&o.attributes;if(void 0===n){if(this.length&&(i=J.get(o),1===o.nodeType&&!Q.get(o,"hasDataAttrs"))){t=a.length;while(t--)a[t]&&0===(r=a[t].name).indexOf("data-")&&(r=V(r.slice(5)),ee(o,r,i[r]));Q.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof n?this.each(function(){J.set(this,n)}):_(this,function(e){var t;if(o&&void 0===e)return void 0!==(t=J.get(o,n))?t:void 0!==(t=ee(o,n))?t:void 0;this.each(function(){J.set(this,n,e)})},null,e,1<arguments.length,null,!0)},removeData:function(e){return this.each(function(){J.remove(this,e)})}}),k.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=Q.get(e,t),n&&(!r||Array.isArray(n)?r=Q.access(e,t,k.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=k.queue(e,t),r=n.length,i=n.shift(),o=k._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){k.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return Q.get(e,n)||Q.access(e,n,{empty:k.Callbacks("once memory").add(function(){Q.remove(e,[t+"queue",n])})})}}),k.fn.extend({queue:function(t,n){var e=2;return"string"!=typeof t&&(n=t,t="fx",e--),arguments.length<e?k.queue(this[0],t):void 0===n?this:this.each(function(){var e=k.queue(this,t,n);k._queueHooks(this,t),"fx"===t&&"inprogress"!==e[0]&&k.dequeue(this,t)})},dequeue:function(e){return this.each(function(){k.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=k.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};"string"!=typeof e&&(t=e,e=void 0),e=e||"fx";while(a--)(n=Q.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var te=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,ne=new RegExp("^(?:([+-])=|)("+te+")([a-z%]*)$","i"),re=["Top","Right","Bottom","Left"],ie=E.documentElement,oe=function(e){return k.contains(e.ownerDocument,e)},ae={composed:!0};ie.getRootNode&&(oe=function(e){return k.contains(e.ownerDocument,e)||e.getRootNode(ae)===e.ownerDocument});var se=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&oe(e)&&"none"===k.css(e,"display")},ue=function(e,t,n,r){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];for(o in i=n.apply(e,r||[]),t)e.style[o]=a[o];return i};function le(e,t,n,r){var i,o,a=20,s=r?function(){return r.cur()}:function(){return k.css(e,t,"")},u=s(),l=n&&n[3]||(k.cssNumber[t]?"":"px"),c=e.nodeType&&(k.cssNumber[t]||"px"!==l&&+u)&&ne.exec(k.css(e,t));if(c&&c[3]!==l){u/=2,l=l||c[3],c=+u||1;while(a--)k.style(e,t,c+l),(1-o)*(1-(o=s()/u||.5))<=0&&(a=0),c/=o;c*=2,k.style(e,t,c+l),n=n||[]}return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}var ce={};function fe(e,t){for(var n,r,i,o,a,s,u,l=[],c=0,f=e.length;c<f;c++)(r=e[c]).style&&(n=r.style.display,t?("none"===n&&(l[c]=Q.get(r,"display")||null,l[c]||(r.style.display="")),""===r.style.display&&se(r)&&(l[c]=(u=a=o=void 0,a=(i=r).ownerDocument,s=i.nodeName,(u=ce[s])||(o=a.body.appendChild(a.createElement(s)),u=k.css(o,"display"),o.parentNode.removeChild(o),"none"===u&&(u="block"),ce[s]=u)))):"none"!==n&&(l[c]="none",Q.set(r,"display",n)));for(c=0;c<f;c++)null!=l[c]&&(e[c].style.display=l[c]);return e}k.fn.extend({show:function(){return fe(this,!0)},hide:function(){return fe(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){se(this)?k(this).show():k(this).hide()})}});var pe=/^(?:checkbox|radio)$/i,de=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,he=/^$|^module$|\/(?:java|ecma)script/i,ge={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};function ve(e,t){var n;return n="undefined"!=typeof e.getElementsByTagName?e.getElementsByTagName(t||"*"):"undefined"!=typeof e.querySelectorAll?e.querySelectorAll(t||"*"):[],void 0===t||t&&A(e,t)?k.merge([e],n):n}function ye(e,t){for(var n=0,r=e.length;n<r;n++)Q.set(e[n],"globalEval",!t||Q.get(t[n],"globalEval"))}ge.optgroup=ge.option,ge.tbody=ge.tfoot=ge.colgroup=ge.caption=ge.thead,ge.th=ge.td;var me,xe,be=/<|&#?\w+;/;function we(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),p=[],d=0,h=e.length;d<h;d++)if((o=e[d])||0===o)if("object"===w(o))k.merge(p,o.nodeType?[o]:o);else if(be.test(o)){a=a||f.appendChild(t.createElement("div")),s=(de.exec(o)||["",""])[1].toLowerCase(),u=ge[s]||ge._default,a.innerHTML=u[1]+k.htmlPrefilter(o)+u[2],c=u[0];while(c--)a=a.lastChild;k.merge(p,a.childNodes),(a=f.firstChild).textContent=""}else p.push(t.createTextNode(o));f.textContent="",d=0;while(o=p[d++])if(r&&-1<k.inArray(o,r))i&&i.push(o);else if(l=oe(o),a=ve(f.appendChild(o),"script"),l&&ye(a),n){c=0;while(o=a[c++])he.test(o.type||"")&&n.push(o)}return f}me=E.createDocumentFragment().appendChild(E.createElement("div")),(xe=E.createElement("input")).setAttribute("type","radio"),xe.setAttribute("checked","checked"),xe.setAttribute("name","t"),me.appendChild(xe),y.checkClone=me.cloneNode(!0).cloneNode(!0).lastChild.checked,me.innerHTML="<textarea>x</textarea>",y.noCloneChecked=!!me.cloneNode(!0).lastChild.defaultValue;var Te=/^key/,Ce=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,Ee=/^([^.]*)(?:\.(.+)|)/;function ke(){return!0}function Se(){return!1}function Ne(e,t){return e===function(){try{return E.activeElement}catch(e){}}()==("focus"===t)}function Ae(e,t,n,r,i,o){var a,s;if("object"==typeof t){for(s in"string"!=typeof n&&(r=r||n,n=void 0),t)Ae(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=Se;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return k().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=k.guid++)),e.each(function(){k.event.add(this,t,i,r,n)})}function De(e,i,o){o?(Q.set(e,i,!1),k.event.add(e,i,{namespace:!1,handler:function(e){var t,n,r=Q.get(this,i);if(1&e.isTrigger&&this[i]){if(r.length)(k.event.special[i]||{}).delegateType&&e.stopPropagation();else if(r=s.call(arguments),Q.set(this,i,r),t=o(this,i),this[i](),r!==(n=Q.get(this,i))||t?Q.set(this,i,!1):n={},r!==n)return e.stopImmediatePropagation(),e.preventDefault(),n.value}else r.length&&(Q.set(this,i,{value:k.event.trigger(k.extend(r[0],k.Event.prototype),r.slice(1),this)}),e.stopImmediatePropagation())}})):void 0===Q.get(e,i)&&k.event.add(e,i,ke)}k.event={global:{},add:function(t,e,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=Q.get(t);if(v){n.handler&&(n=(o=n).handler,i=o.selector),i&&k.find.matchesSelector(ie,i),n.guid||(n.guid=k.guid++),(u=v.events)||(u=v.events={}),(a=v.handle)||(a=v.handle=function(e){return"undefined"!=typeof k&&k.event.triggered!==e.type?k.event.dispatch.apply(t,arguments):void 0}),l=(e=(e||"").match(R)||[""]).length;while(l--)d=g=(s=Ee.exec(e[l])||[])[1],h=(s[2]||"").split(".").sort(),d&&(f=k.event.special[d]||{},d=(i?f.delegateType:f.bindType)||d,f=k.event.special[d]||{},c=k.extend({type:d,origType:g,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&k.expr.match.needsContext.test(i),namespace:h.join(".")},o),(p=u[d])||((p=u[d]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(t,r,h,a)||t.addEventListener&&t.addEventListener(d,a)),f.add&&(f.add.call(t,c),c.handler.guid||(c.handler.guid=n.guid)),i?p.splice(p.delegateCount++,0,c):p.push(c),k.event.global[d]=!0)}},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,p,d,h,g,v=Q.hasData(e)&&Q.get(e);if(v&&(u=v.events)){l=(t=(t||"").match(R)||[""]).length;while(l--)if(d=g=(s=Ee.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),d){f=k.event.special[d]||{},p=u[d=(r?f.delegateType:f.bindType)||d]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=p.length;while(o--)c=p[o],!i&&g!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(p.splice(o,1),c.selector&&p.delegateCount--,f.remove&&f.remove.call(e,c));a&&!p.length&&(f.teardown&&!1!==f.teardown.call(e,h,v.handle)||k.removeEvent(e,d,v.handle),delete u[d])}else for(d in u)k.event.remove(e,d+t[l],n,r,!0);k.isEmptyObject(u)&&Q.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=k.event.fix(e),u=new Array(arguments.length),l=(Q.get(this,"events")||{})[s.type]||[],c=k.event.special[s.type]||{};for(u[0]=s,t=1;t<arguments.length;t++)u[t]=arguments[t];if(s.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,s)){a=k.event.handlers.call(this,s,l),t=0;while((i=a[t++])&&!s.isPropagationStopped()){s.currentTarget=i.elem,n=0;while((o=i.handlers[n++])&&!s.isImmediatePropagationStopped())s.rnamespace&&!1!==o.namespace&&!s.rnamespace.test(o.namespace)||(s.handleObj=o,s.data=o.data,void 0!==(r=((k.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,u))&&!1===(s.result=r)&&(s.preventDefault(),s.stopPropagation()))}return c.postDispatch&&c.postDispatch.call(this,s),s.result}},handlers:function(e,t){var n,r,i,o,a,s=[],u=t.delegateCount,l=e.target;if(u&&l.nodeType&&!("click"===e.type&&1<=e.button))for(;l!==this;l=l.parentNode||this)if(1===l.nodeType&&("click"!==e.type||!0!==l.disabled)){for(o=[],a={},n=0;n<u;n++)void 0===a[i=(r=t[n]).selector+" "]&&(a[i]=r.needsContext?-1<k(i,this).index(l):k.find(i,this,null,[l]).length),a[i]&&o.push(r);o.length&&s.push({elem:l,handlers:o})}return l=this,u<t.length&&s.push({elem:l,handlers:t.slice(u)}),s},addProp:function(t,e){Object.defineProperty(k.Event.prototype,t,{enumerable:!0,configurable:!0,get:m(e)?function(){if(this.originalEvent)return e(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[t]},set:function(e){Object.defineProperty(this,t,{enumerable:!0,configurable:!0,writable:!0,value:e})}})},fix:function(e){return e[k.expando]?e:new k.Event(e)},special:{load:{noBubble:!0},click:{setup:function(e){var t=this||e;return pe.test(t.type)&&t.click&&A(t,"input")&&De(t,"click",ke),!1},trigger:function(e){var t=this||e;return pe.test(t.type)&&t.click&&A(t,"input")&&De(t,"click"),!0},_default:function(e){var t=e.target;return pe.test(t.type)&&t.click&&A(t,"input")&&Q.get(t,"click")||A(t,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},k.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},k.Event=function(e,t){if(!(this instanceof k.Event))return new k.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?ke:Se,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&k.extend(this,t),this.timeStamp=e&&e.timeStamp||Date.now(),this[k.expando]=!0},k.Event.prototype={constructor:k.Event,isDefaultPrevented:Se,isPropagationStopped:Se,isImmediatePropagationStopped:Se,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=ke,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=ke,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=ke,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},k.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,"char":!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:function(e){var t=e.button;return null==e.which&&Te.test(e.type)?null!=e.charCode?e.charCode:e.keyCode:!e.which&&void 0!==t&&Ce.test(e.type)?1&t?1:2&t?3:4&t?2:0:e.which}},k.event.addProp),k.each({focus:"focusin",blur:"focusout"},function(e,t){k.event.special[e]={setup:function(){return De(this,e,Ne),!1},trigger:function(){return De(this,e),!0},delegateType:t}}),k.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,i){k.event.special[e]={delegateType:i,bindType:i,handle:function(e){var t,n=e.relatedTarget,r=e.handleObj;return n&&(n===this||k.contains(this,n))||(e.type=r.origType,t=r.handler.apply(this,arguments),e.type=i),t}}}),k.fn.extend({on:function(e,t,n,r){return Ae(this,e,t,n,r)},one:function(e,t,n,r){return Ae(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,k(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=Se),this.each(function(){k.event.remove(this,e,n,t)})}});var je=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\/\0>\x20\t\r\n\f]*)[^>]*)\/>/gi,qe=/<script|<style|<link/i,Le=/checked\s*(?:[^=]|=\s*.checked.)/i,He=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;function Oe(e,t){return A(e,"table")&&A(11!==t.nodeType?t:t.firstChild,"tr")&&k(e).children("tbody")[0]||e}function Pe(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function Re(e){return"true/"===(e.type||"").slice(0,5)?e.type=e.type.slice(5):e.removeAttribute("type"),e}function Me(e,t){var n,r,i,o,a,s,u,l;if(1===t.nodeType){if(Q.hasData(e)&&(o=Q.access(e),a=Q.set(t,o),l=o.events))for(i in delete a.handle,a.events={},l)for(n=0,r=l[i].length;n<r;n++)k.event.add(t,i,l[i][n]);J.hasData(e)&&(s=J.access(e),u=k.extend({},s),J.set(t,u))}}function Ie(n,r,i,o){r=g.apply([],r);var e,t,a,s,u,l,c=0,f=n.length,p=f-1,d=r[0],h=m(d);if(h||1<f&&"string"==typeof d&&!y.checkClone&&Le.test(d))return n.each(function(e){var t=n.eq(e);h&&(r[0]=d.call(this,e,t.html())),Ie(t,r,i,o)});if(f&&(t=(e=we(r,n[0].ownerDocument,!1,n,o)).firstChild,1===e.childNodes.length&&(e=t),t||o)){for(s=(a=k.map(ve(e,"script"),Pe)).length;c<f;c++)u=e,c!==p&&(u=k.clone(u,!0,!0),s&&k.merge(a,ve(u,"script"))),i.call(n[c],u,c);if(s)for(l=a[a.length-1].ownerDocument,k.map(a,Re),c=0;c<s;c++)u=a[c],he.test(u.type||"")&&!Q.access(u,"globalEval")&&k.contains(l,u)&&(u.src&&"module"!==(u.type||"").toLowerCase()?k._evalUrl&&!u.noModule&&k._evalUrl(u.src,{nonce:u.nonce||u.getAttribute("nonce")}):b(u.textContent.replace(He,""),u,l))}return n}function We(e,t,n){for(var r,i=t?k.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||k.cleanData(ve(r)),r.parentNode&&(n&&oe(r)&&ye(ve(r,"script")),r.parentNode.removeChild(r));return e}k.extend({htmlPrefilter:function(e){return e.replace(je,"<$1></$2>")},clone:function(e,t,n){var r,i,o,a,s,u,l,c=e.cloneNode(!0),f=oe(e);if(!(y.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||k.isXMLDoc(e)))for(a=ve(c),r=0,i=(o=ve(e)).length;r<i;r++)s=o[r],u=a[r],void 0,"input"===(l=u.nodeName.toLowerCase())&&pe.test(s.type)?u.checked=s.checked:"input"!==l&&"textarea"!==l||(u.defaultValue=s.defaultValue);if(t)if(n)for(o=o||ve(e),a=a||ve(c),r=0,i=o.length;r<i;r++)Me(o[r],a[r]);else Me(e,c);return 0<(a=ve(c,"script")).length&&ye(a,!f&&ve(e,"script")),c},cleanData:function(e){for(var t,n,r,i=k.event.special,o=0;void 0!==(n=e[o]);o++)if(G(n)){if(t=n[Q.expando]){if(t.events)for(r in t.events)i[r]?k.event.remove(n,r):k.removeEvent(n,r,t.handle);n[Q.expando]=void 0}n[J.expando]&&(n[J.expando]=void 0)}}}),k.fn.extend({detach:function(e){return We(this,e,!0)},remove:function(e){return We(this,e)},text:function(e){return _(this,function(e){return void 0===e?k.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return Ie(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||Oe(this,e).appendChild(e)})},prepend:function(){return Ie(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=Oe(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return Ie(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return Ie(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(k.cleanData(ve(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return k.clone(this,e,t)})},html:function(e){return _(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!qe.test(e)&&!ge[(de.exec(e)||["",""])[1].toLowerCase()]){e=k.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(k.cleanData(ve(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var n=[];return Ie(this,arguments,function(e){var t=this.parentNode;k.inArray(this,n)<0&&(k.cleanData(ve(this)),t&&t.replaceChild(e,this))},n)}}),k.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,a){k.fn[e]=function(e){for(var t,n=[],r=k(e),i=r.length-1,o=0;o<=i;o++)t=o===i?this:this.clone(!0),k(r[o])[a](t),u.apply(n,t.get());return this.pushStack(n)}});var $e=new RegExp("^("+te+")(?!px)[a-z%]+$","i"),Fe=function(e){var t=e.ownerDocument.defaultView;return t&&t.opener||(t=C),t.getComputedStyle(e)},Be=new RegExp(re.join("|"),"i");function _e(e,t,n){var r,i,o,a,s=e.style;return(n=n||Fe(e))&&(""!==(a=n.getPropertyValue(t)||n[t])||oe(e)||(a=k.style(e,t)),!y.pixelBoxStyles()&&$e.test(a)&&Be.test(t)&&(r=s.width,i=s.minWidth,o=s.maxWidth,s.minWidth=s.maxWidth=s.width=a,a=n.width,s.width=r,s.minWidth=i,s.maxWidth=o)),void 0!==a?a+"":a}function ze(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}!function(){function e(){if(u){s.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",u.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",ie.appendChild(s).appendChild(u);var e=C.getComputedStyle(u);n="1%"!==e.top,a=12===t(e.marginLeft),u.style.right="60%",o=36===t(e.right),r=36===t(e.width),u.style.position="absolute",i=12===t(u.offsetWidth/3),ie.removeChild(s),u=null}}function t(e){return Math.round(parseFloat(e))}var n,r,i,o,a,s=E.createElement("div"),u=E.createElement("div");u.style&&(u.style.backgroundClip="content-box",u.cloneNode(!0).style.backgroundClip="",y.clearCloneStyle="content-box"===u.style.backgroundClip,k.extend(y,{boxSizingReliable:function(){return e(),r},pixelBoxStyles:function(){return e(),o},pixelPosition:function(){return e(),n},reliableMarginLeft:function(){return e(),a},scrollboxSize:function(){return e(),i}}))}();var Ue=["Webkit","Moz","ms"],Xe=E.createElement("div").style,Ve={};function Ge(e){var t=k.cssProps[e]||Ve[e];return t||(e in Xe?e:Ve[e]=function(e){var t=e[0].toUpperCase()+e.slice(1),n=Ue.length;while(n--)if((e=Ue[n]+t)in Xe)return e}(e)||e)}var Ye=/^(none|table(?!-c[ea]).+)/,Qe=/^--/,Je={position:"absolute",visibility:"hidden",display:"block"},Ke={letterSpacing:"0",fontWeight:"400"};function Ze(e,t,n){var r=ne.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function et(e,t,n,r,i,o){var a="width"===t?1:0,s=0,u=0;if(n===(r?"border":"content"))return 0;for(;a<4;a+=2)"margin"===n&&(u+=k.css(e,n+re[a],!0,i)),r?("content"===n&&(u-=k.css(e,"padding"+re[a],!0,i)),"margin"!==n&&(u-=k.css(e,"border"+re[a]+"Width",!0,i))):(u+=k.css(e,"padding"+re[a],!0,i),"padding"!==n?u+=k.css(e,"border"+re[a]+"Width",!0,i):s+=k.css(e,"border"+re[a]+"Width",!0,i));return!r&&0<=o&&(u+=Math.max(0,Math.ceil(e["offset"+t[0].toUpperCase()+t.slice(1)]-o-u-s-.5))||0),u}function tt(e,t,n){var r=Fe(e),i=(!y.boxSizingReliable()||n)&&"border-box"===k.css(e,"boxSizing",!1,r),o=i,a=_e(e,t,r),s="offset"+t[0].toUpperCase()+t.slice(1);if($e.test(a)){if(!n)return a;a="auto"}return(!y.boxSizingReliable()&&i||"auto"===a||!parseFloat(a)&&"inline"===k.css(e,"display",!1,r))&&e.getClientRects().length&&(i="border-box"===k.css(e,"boxSizing",!1,r),(o=s in e)&&(a=e[s])),(a=parseFloat(a)||0)+et(e,t,n||(i?"border":"content"),o,r,a)+"px"}function nt(e,t,n,r,i){return new nt.prototype.init(e,t,n,r,i)}k.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=_e(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=V(t),u=Qe.test(t),l=e.style;if(u||(t=Ge(s)),a=k.cssHooks[t]||k.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:l[t];"string"===(o=typeof n)&&(i=ne.exec(n))&&i[1]&&(n=le(e,t,i),o="number"),null!=n&&n==n&&("number"!==o||u||(n+=i&&i[3]||(k.cssNumber[s]?"":"px")),y.clearCloneStyle||""!==n||0!==t.indexOf("background")||(l[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u?l.setProperty(t,n):l[t]=n))}},css:function(e,t,n,r){var i,o,a,s=V(t);return Qe.test(t)||(t=Ge(s)),(a=k.cssHooks[t]||k.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=_e(e,t,r)),"normal"===i&&t in Ke&&(i=Ke[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),k.each(["height","width"],function(e,u){k.cssHooks[u]={get:function(e,t,n){if(t)return!Ye.test(k.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?tt(e,u,n):ue(e,Je,function(){return tt(e,u,n)})},set:function(e,t,n){var r,i=Fe(e),o=!y.scrollboxSize()&&"absolute"===i.position,a=(o||n)&&"border-box"===k.css(e,"boxSizing",!1,i),s=n?et(e,u,n,a,i):0;return a&&o&&(s-=Math.ceil(e["offset"+u[0].toUpperCase()+u.slice(1)]-parseFloat(i[u])-et(e,u,"border",!1,i)-.5)),s&&(r=ne.exec(t))&&"px"!==(r[3]||"px")&&(e.style[u]=t,t=k.css(e,u)),Ze(0,t,s)}}}),k.cssHooks.marginLeft=ze(y.reliableMarginLeft,function(e,t){if(t)return(parseFloat(_e(e,"marginLeft"))||e.getBoundingClientRect().left-ue(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),k.each({margin:"",padding:"",border:"Width"},function(i,o){k.cssHooks[i+o]={expand:function(e){for(var t=0,n={},r="string"==typeof e?e.split(" "):[e];t<4;t++)n[i+re[t]+o]=r[t]||r[t-2]||r[0];return n}},"margin"!==i&&(k.cssHooks[i+o].set=Ze)}),k.fn.extend({css:function(e,t){return _(this,function(e,t,n){var r,i,o={},a=0;if(Array.isArray(t)){for(r=Fe(e),i=t.length;a<i;a++)o[t[a]]=k.css(e,t[a],!1,r);return o}return void 0!==n?k.style(e,t,n):k.css(e,t)},e,t,1<arguments.length)}}),((k.Tween=nt).prototype={constructor:nt,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||k.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(k.cssNumber[n]?"":"px")},cur:function(){var e=nt.propHooks[this.prop];return e&&e.get?e.get(this):nt.propHooks._default.get(this)},run:function(e){var t,n=nt.propHooks[this.prop];return this.options.duration?this.pos=t=k.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):nt.propHooks._default.set(this),this}}).init.prototype=nt.prototype,(nt.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=k.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){k.fx.step[e.prop]?k.fx.step[e.prop](e):1!==e.elem.nodeType||!k.cssHooks[e.prop]&&null==e.elem.style[Ge(e.prop)]?e.elem[e.prop]=e.now:k.style(e.elem,e.prop,e.now+e.unit)}}}).scrollTop=nt.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},k.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},k.fx=nt.prototype.init,k.fx.step={};var rt,it,ot,at,st=/^(?:toggle|show|hide)$/,ut=/queueHooks$/;function lt(){it&&(!1===E.hidden&&C.requestAnimationFrame?C.requestAnimationFrame(lt):C.setTimeout(lt,k.fx.interval),k.fx.tick())}function ct(){return C.setTimeout(function(){rt=void 0}),rt=Date.now()}function ft(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=re[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function pt(e,t,n){for(var r,i=(dt.tweeners[t]||[]).concat(dt.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function dt(o,e,t){var n,a,r=0,i=dt.prefilters.length,s=k.Deferred().always(function(){delete u.elem}),u=function(){if(a)return!1;for(var e=rt||ct(),t=Math.max(0,l.startTime+l.duration-e),n=1-(t/l.duration||0),r=0,i=l.tweens.length;r<i;r++)l.tweens[r].run(n);return s.notifyWith(o,[l,n,t]),n<1&&i?t:(i||s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l]),!1)},l=s.promise({elem:o,props:k.extend({},e),opts:k.extend(!0,{specialEasing:{},easing:k.easing._default},t),originalProperties:e,originalOptions:t,startTime:rt||ct(),duration:t.duration,tweens:[],createTween:function(e,t){var n=k.Tween(o,l.opts,e,t,l.opts.specialEasing[e]||l.opts.easing);return l.tweens.push(n),n},stop:function(e){var t=0,n=e?l.tweens.length:0;if(a)return this;for(a=!0;t<n;t++)l.tweens[t].run(1);return e?(s.notifyWith(o,[l,1,0]),s.resolveWith(o,[l,e])):s.rejectWith(o,[l,e]),this}}),c=l.props;for(!function(e,t){var n,r,i,o,a;for(n in e)if(i=t[r=V(n)],o=e[n],Array.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=k.cssHooks[r])&&"expand"in a)for(n in o=a.expand(o),delete e[r],o)n in e||(e[n]=o[n],t[n]=i);else t[r]=i}(c,l.opts.specialEasing);r<i;r++)if(n=dt.prefilters[r].call(l,o,c,l.opts))return m(n.stop)&&(k._queueHooks(l.elem,l.opts.queue).stop=n.stop.bind(n)),n;return k.map(c,pt,l),m(l.opts.start)&&l.opts.start.call(o,l),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always),k.fx.timer(k.extend(u,{elem:o,anim:l,queue:l.opts.queue})),l}k.Animation=k.extend(dt,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return le(n.elem,e,ne.exec(t),n),n}]},tweener:function(e,t){m(e)?(t=e,e=["*"]):e=e.match(R);for(var n,r=0,i=e.length;r<i;r++)n=e[r],dt.tweeners[n]=dt.tweeners[n]||[],dt.tweeners[n].unshift(t)},prefilters:[function(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,p=this,d={},h=e.style,g=e.nodeType&&se(e),v=Q.get(e,"fxshow");for(r in n.queue||(null==(a=k._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,p.always(function(){p.always(function(){a.unqueued--,k.queue(e,"fx").length||a.empty.fire()})})),t)if(i=t[r],st.test(i)){if(delete t[r],o=o||"toggle"===i,i===(g?"hide":"show")){if("show"!==i||!v||void 0===v[r])continue;g=!0}d[r]=v&&v[r]||k.style(e,r)}if((u=!k.isEmptyObject(t))||!k.isEmptyObject(d))for(r in f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=v&&v.display)&&(l=Q.get(e,"display")),"none"===(c=k.css(e,"display"))&&(l?c=l:(fe([e],!0),l=e.style.display||l,c=k.css(e,"display"),fe([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===k.css(e,"float")&&(u||(p.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",p.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1,d)u||(v?"hidden"in v&&(g=v.hidden):v=Q.access(e,"fxshow",{display:l}),o&&(v.hidden=!g),g&&fe([e],!0),p.done(function(){for(r in g||fe([e]),Q.remove(e,"fxshow"),d)k.style(e,r,d[r])})),u=pt(g?v[r]:0,r,p),r in v||(v[r]=u.start,g&&(u.end=u.start,u.start=0))}],prefilter:function(e,t){t?dt.prefilters.unshift(e):dt.prefilters.push(e)}}),k.speed=function(e,t,n){var r=e&&"object"==typeof e?k.extend({},e):{complete:n||!n&&t||m(e)&&e,duration:e,easing:n&&t||t&&!m(t)&&t};return k.fx.off?r.duration=0:"number"!=typeof r.duration&&(r.duration in k.fx.speeds?r.duration=k.fx.speeds[r.duration]:r.duration=k.fx.speeds._default),null!=r.queue&&!0!==r.queue||(r.queue="fx"),r.old=r.complete,r.complete=function(){m(r.old)&&r.old.call(this),r.queue&&k.dequeue(this,r.queue)},r},k.fn.extend({fadeTo:function(e,t,n,r){return this.filter(se).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(t,e,n,r){var i=k.isEmptyObject(t),o=k.speed(e,n,r),a=function(){var e=dt(this,k.extend({},t),o);(i||Q.get(this,"finish"))&&e.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(i,e,o){var a=function(e){var t=e.stop;delete e.stop,t(o)};return"string"!=typeof i&&(o=e,e=i,i=void 0),e&&!1!==i&&this.queue(i||"fx",[]),this.each(function(){var e=!0,t=null!=i&&i+"queueHooks",n=k.timers,r=Q.get(this);if(t)r[t]&&r[t].stop&&a(r[t]);else for(t in r)r[t]&&r[t].stop&&ut.test(t)&&a(r[t]);for(t=n.length;t--;)n[t].elem!==this||null!=i&&n[t].queue!==i||(n[t].anim.stop(o),e=!1,n.splice(t,1));!e&&o||k.dequeue(this,i)})},finish:function(a){return!1!==a&&(a=a||"fx"),this.each(function(){var e,t=Q.get(this),n=t[a+"queue"],r=t[a+"queueHooks"],i=k.timers,o=n?n.length:0;for(t.finish=!0,k.queue(this,a,[]),r&&r.stop&&r.stop.call(this,!0),e=i.length;e--;)i[e].elem===this&&i[e].queue===a&&(i[e].anim.stop(!0),i.splice(e,1));for(e=0;e<o;e++)n[e]&&n[e].finish&&n[e].finish.call(this);delete t.finish})}}),k.each(["toggle","show","hide"],function(e,r){var i=k.fn[r];k.fn[r]=function(e,t,n){return null==e||"boolean"==typeof e?i.apply(this,arguments):this.animate(ft(r,!0),e,t,n)}}),k.each({slideDown:ft("show"),slideUp:ft("hide"),slideToggle:ft("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,r){k.fn[e]=function(e,t,n){return this.animate(r,e,t,n)}}),k.timers=[],k.fx.tick=function(){var e,t=0,n=k.timers;for(rt=Date.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||k.fx.stop(),rt=void 0},k.fx.timer=function(e){k.timers.push(e),k.fx.start()},k.fx.interval=13,k.fx.start=function(){it||(it=!0,lt())},k.fx.stop=function(){it=null},k.fx.speeds={slow:600,fast:200,_default:400},k.fn.delay=function(r,e){return r=k.fx&&k.fx.speeds[r]||r,e=e||"fx",this.queue(e,function(e,t){var n=C.setTimeout(e,r);t.stop=function(){C.clearTimeout(n)}})},ot=E.createElement("input"),at=E.createElement("select").appendChild(E.createElement("option")),ot.type="checkbox",y.checkOn=""!==ot.value,y.optSelected=at.selected,(ot=E.createElement("input")).value="t",ot.type="radio",y.radioValue="t"===ot.value;var ht,gt=k.expr.attrHandle;k.fn.extend({attr:function(e,t){return _(this,k.attr,e,t,1<arguments.length)},removeAttr:function(e){return this.each(function(){k.removeAttr(this,e)})}}),k.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return"undefined"==typeof e.getAttribute?k.prop(e,t,n):(1===o&&k.isXMLDoc(e)||(i=k.attrHooks[t.toLowerCase()]||(k.expr.match.bool.test(t)?ht:void 0)),void 0!==n?null===n?void k.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=k.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!y.radioValue&&"radio"===t&&A(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(R);if(i&&1===e.nodeType)while(n=i[r++])e.removeAttribute(n)}}),ht={set:function(e,t,n){return!1===t?k.removeAttr(e,n):e.setAttribute(n,n),n}},k.each(k.expr.match.bool.source.match(/\w+/g),function(e,t){var a=gt[t]||k.find.attr;gt[t]=function(e,t,n){var r,i,o=t.toLowerCase();return n||(i=gt[o],gt[o]=r,r=null!=a(e,t,n)?o:null,gt[o]=i),r}});var vt=/^(?:input|select|textarea|button)$/i,yt=/^(?:a|area)$/i;function mt(e){return(e.match(R)||[]).join(" ")}function xt(e){return e.getAttribute&&e.getAttribute("class")||""}function bt(e){return Array.isArray(e)?e:"string"==typeof e&&e.match(R)||[]}k.fn.extend({prop:function(e,t){return _(this,k.prop,e,t,1<arguments.length)},removeProp:function(e){return this.each(function(){delete this[k.propFix[e]||e]})}}),k.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&k.isXMLDoc(e)||(t=k.propFix[t]||t,i=k.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=k.find.attr(e,"tabindex");return t?parseInt(t,10):vt.test(e.nodeName)||yt.test(e.nodeName)&&e.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),y.optSelected||(k.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),k.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){k.propFix[this.toLowerCase()]=this}),k.fn.extend({addClass:function(t){var e,n,r,i,o,a,s,u=0;if(m(t))return this.each(function(e){k(this).addClass(t.call(this,e,xt(this)))});if((e=bt(t)).length)while(n=this[u++])if(i=xt(n),r=1===n.nodeType&&" "+mt(i)+" "){a=0;while(o=e[a++])r.indexOf(" "+o+" ")<0&&(r+=o+" ");i!==(s=mt(r))&&n.setAttribute("class",s)}return this},removeClass:function(t){var e,n,r,i,o,a,s,u=0;if(m(t))return this.each(function(e){k(this).removeClass(t.call(this,e,xt(this)))});if(!arguments.length)return this.attr("class","");if((e=bt(t)).length)while(n=this[u++])if(i=xt(n),r=1===n.nodeType&&" "+mt(i)+" "){a=0;while(o=e[a++])while(-1<r.indexOf(" "+o+" "))r=r.replace(" "+o+" "," ");i!==(s=mt(r))&&n.setAttribute("class",s)}return this},toggleClass:function(i,t){var o=typeof i,a="string"===o||Array.isArray(i);return"boolean"==typeof t&&a?t?this.addClass(i):this.removeClass(i):m(i)?this.each(function(e){k(this).toggleClass(i.call(this,e,xt(this),t),t)}):this.each(function(){var e,t,n,r;if(a){t=0,n=k(this),r=bt(i);while(e=r[t++])n.hasClass(e)?n.removeClass(e):n.addClass(e)}else void 0!==i&&"boolean"!==o||((e=xt(this))&&Q.set(this,"__className__",e),this.setAttribute&&this.setAttribute("class",e||!1===i?"":Q.get(this,"__className__")||""))})},hasClass:function(e){var t,n,r=0;t=" "+e+" ";while(n=this[r++])if(1===n.nodeType&&-1<(" "+mt(xt(n))+" ").indexOf(t))return!0;return!1}});var wt=/\r/g;k.fn.extend({val:function(n){var r,e,i,t=this[0];return arguments.length?(i=m(n),this.each(function(e){var t;1===this.nodeType&&(null==(t=i?n.call(this,e,k(this).val()):n)?t="":"number"==typeof t?t+="":Array.isArray(t)&&(t=k.map(t,function(e){return null==e?"":e+""})),(r=k.valHooks[this.type]||k.valHooks[this.nodeName.toLowerCase()])&&"set"in r&&void 0!==r.set(this,t,"value")||(this.value=t))})):t?(r=k.valHooks[t.type]||k.valHooks[t.nodeName.toLowerCase()])&&"get"in r&&void 0!==(e=r.get(t,"value"))?e:"string"==typeof(e=t.value)?e.replace(wt,""):null==e?"":e:void 0}}),k.extend({valHooks:{option:{get:function(e){var t=k.find.attr(e,"value");return null!=t?t:mt(k.text(e))}},select:{get:function(e){var t,n,r,i=e.options,o=e.selectedIndex,a="select-one"===e.type,s=a?null:[],u=a?o+1:i.length;for(r=o<0?u:a?o:0;r<u;r++)if(((n=i[r]).selected||r===o)&&!n.disabled&&(!n.parentNode.disabled||!A(n.parentNode,"optgroup"))){if(t=k(n).val(),a)return t;s.push(t)}return s},set:function(e,t){var n,r,i=e.options,o=k.makeArray(t),a=i.length;while(a--)((r=i[a]).selected=-1<k.inArray(k.valHooks.option.get(r),o))&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),k.each(["radio","checkbox"],function(){k.valHooks[this]={set:function(e,t){if(Array.isArray(t))return e.checked=-1<k.inArray(k(e).val(),t)}},y.checkOn||(k.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})}),y.focusin="onfocusin"in C;var Tt=/^(?:focusinfocus|focusoutblur)$/,Ct=function(e){e.stopPropagation()};k.extend(k.event,{trigger:function(e,t,n,r){var i,o,a,s,u,l,c,f,p=[n||E],d=v.call(e,"type")?e.type:e,h=v.call(e,"namespace")?e.namespace.split("."):[];if(o=f=a=n=n||E,3!==n.nodeType&&8!==n.nodeType&&!Tt.test(d+k.event.triggered)&&(-1<d.indexOf(".")&&(d=(h=d.split(".")).shift(),h.sort()),u=d.indexOf(":")<0&&"on"+d,(e=e[k.expando]?e:new k.Event(d,"object"==typeof e&&e)).isTrigger=r?2:3,e.namespace=h.join("."),e.rnamespace=e.namespace?new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,e.result=void 0,e.target||(e.target=n),t=null==t?[e]:k.makeArray(t,[e]),c=k.event.special[d]||{},r||!c.trigger||!1!==c.trigger.apply(n,t))){if(!r&&!c.noBubble&&!x(n)){for(s=c.delegateType||d,Tt.test(s+d)||(o=o.parentNode);o;o=o.parentNode)p.push(o),a=o;a===(n.ownerDocument||E)&&p.push(a.defaultView||a.parentWindow||C)}i=0;while((o=p[i++])&&!e.isPropagationStopped())f=o,e.type=1<i?s:c.bindType||d,(l=(Q.get(o,"events")||{})[e.type]&&Q.get(o,"handle"))&&l.apply(o,t),(l=u&&o[u])&&l.apply&&G(o)&&(e.result=l.apply(o,t),!1===e.result&&e.preventDefault());return e.type=d,r||e.isDefaultPrevented()||c._default&&!1!==c._default.apply(p.pop(),t)||!G(n)||u&&m(n[d])&&!x(n)&&((a=n[u])&&(n[u]=null),k.event.triggered=d,e.isPropagationStopped()&&f.addEventListener(d,Ct),n[d](),e.isPropagationStopped()&&f.removeEventListener(d,Ct),k.event.triggered=void 0,a&&(n[u]=a)),e.result}},simulate:function(e,t,n){var r=k.extend(new k.Event,n,{type:e,isSimulated:!0});k.event.trigger(r,null,t)}}),k.fn.extend({trigger:function(e,t){return this.each(function(){k.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return k.event.trigger(e,t,n,!0)}}),y.focusin||k.each({focus:"focusin",blur:"focusout"},function(n,r){var i=function(e){k.event.simulate(r,e.target,k.event.fix(e))};k.event.special[r]={setup:function(){var e=this.ownerDocument||this,t=Q.access(e,r);t||e.addEventListener(n,i,!0),Q.access(e,r,(t||0)+1)},teardown:function(){var e=this.ownerDocument||this,t=Q.access(e,r)-1;t?Q.access(e,r,t):(e.removeEventListener(n,i,!0),Q.remove(e,r))}}});var Et=C.location,kt=Date.now(),St=/\?/;k.parseXML=function(e){var t;if(!e||"string"!=typeof e)return null;try{t=(new C.DOMParser).parseFromString(e,"text/xml")}catch(e){t=void 0}return t&&!t.getElementsByTagName("parsererror").length||k.error("Invalid XML: "+e),t};var Nt=/\[\]$/,At=/\r?\n/g,Dt=/^(?:submit|button|image|reset|file)$/i,jt=/^(?:input|select|textarea|keygen)/i;function qt(n,e,r,i){var t;if(Array.isArray(e))k.each(e,function(e,t){r||Nt.test(n)?i(n,t):qt(n+"["+("object"==typeof t&&null!=t?e:"")+"]",t,r,i)});else if(r||"object"!==w(e))i(n,e);else for(t in e)qt(n+"["+t+"]",e[t],r,i)}k.param=function(e,t){var n,r=[],i=function(e,t){var n=m(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(null==e)return"";if(Array.isArray(e)||e.jquery&&!k.isPlainObject(e))k.each(e,function(){i(this.name,this.value)});else for(n in e)qt(n,e[n],t,i);return r.join("&")},k.fn.extend({serialize:function(){return k.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=k.prop(this,"elements");return e?k.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!k(this).is(":disabled")&&jt.test(this.nodeName)&&!Dt.test(e)&&(this.checked||!pe.test(e))}).map(function(e,t){var n=k(this).val();return null==n?null:Array.isArray(n)?k.map(n,function(e){return{name:t.name,value:e.replace(At,"\r\n")}}):{name:t.name,value:n.replace(At,"\r\n")}}).get()}});var Lt=/%20/g,Ht=/#.*$/,Ot=/([?&])_=[^&]*/,Pt=/^(.*?):[ \t]*([^\r\n]*)$/gm,Rt=/^(?:GET|HEAD)$/,Mt=/^\/\//,It={},Wt={},$t="*/".concat("*"),Ft=E.createElement("a");function Bt(o){return function(e,t){"string"!=typeof e&&(t=e,e="*");var n,r=0,i=e.toLowerCase().match(R)||[];if(m(t))while(n=i[r++])"+"===n[0]?(n=n.slice(1)||"*",(o[n]=o[n]||[]).unshift(t)):(o[n]=o[n]||[]).push(t)}}function _t(t,i,o,a){var s={},u=t===Wt;function l(e){var r;return s[e]=!0,k.each(t[e]||[],function(e,t){var n=t(i,o,a);return"string"!=typeof n||u||s[n]?u?!(r=n):void 0:(i.dataTypes.unshift(n),l(n),!1)}),r}return l(i.dataTypes[0])||!s["*"]&&l("*")}function zt(e,t){var n,r,i=k.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&k.extend(!0,e,r),e}Ft.href=Et.href,k.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Et.href,type:"GET",isLocal:/^(?:about|app|app-storage|.+-extension|file|res|widget):$/.test(Et.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":$t,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":k.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?zt(zt(e,k.ajaxSettings),t):zt(k.ajaxSettings,e)},ajaxPrefilter:Bt(It),ajaxTransport:Bt(Wt),ajax:function(e,t){"object"==typeof e&&(t=e,e=void 0),t=t||{};var c,f,p,n,d,r,h,g,i,o,v=k.ajaxSetup({},t),y=v.context||v,m=v.context&&(y.nodeType||y.jquery)?k(y):k.event,x=k.Deferred(),b=k.Callbacks("once memory"),w=v.statusCode||{},a={},s={},u="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(h){if(!n){n={};while(t=Pt.exec(p))n[t[1].toLowerCase()+" "]=(n[t[1].toLowerCase()+" "]||[]).concat(t[2])}t=n[e.toLowerCase()+" "]}return null==t?null:t.join(", ")},getAllResponseHeaders:function(){return h?p:null},setRequestHeader:function(e,t){return null==h&&(e=s[e.toLowerCase()]=s[e.toLowerCase()]||e,a[e]=t),this},overrideMimeType:function(e){return null==h&&(v.mimeType=e),this},statusCode:function(e){var t;if(e)if(h)T.always(e[T.status]);else for(t in e)w[t]=[w[t],e[t]];return this},abort:function(e){var t=e||u;return c&&c.abort(t),l(0,t),this}};if(x.promise(T),v.url=((e||v.url||Et.href)+"").replace(Mt,Et.protocol+"//"),v.type=t.method||t.type||v.method||v.type,v.dataTypes=(v.dataType||"*").toLowerCase().match(R)||[""],null==v.crossDomain){r=E.createElement("a");try{r.href=v.url,r.href=r.href,v.crossDomain=Ft.protocol+"//"+Ft.host!=r.protocol+"//"+r.host}catch(e){v.crossDomain=!0}}if(v.data&&v.processData&&"string"!=typeof v.data&&(v.data=k.param(v.data,v.traditional)),_t(It,v,t,T),h)return T;for(i in(g=k.event&&v.global)&&0==k.active++&&k.event.trigger("ajaxStart"),v.type=v.type.toUpperCase(),v.hasContent=!Rt.test(v.type),f=v.url.replace(Ht,""),v.hasContent?v.data&&v.processData&&0===(v.contentType||"").indexOf("application/x-www-form-urlencoded")&&(v.data=v.data.replace(Lt,"+")):(o=v.url.slice(f.length),v.data&&(v.processData||"string"==typeof v.data)&&(f+=(St.test(f)?"&":"?")+v.data,delete v.data),!1===v.cache&&(f=f.replace(Ot,"$1"),o=(St.test(f)?"&":"?")+"_="+kt+++o),v.url=f+o),v.ifModified&&(k.lastModified[f]&&T.setRequestHeader("If-Modified-Since",k.lastModified[f]),k.etag[f]&&T.setRequestHeader("If-None-Match",k.etag[f])),(v.data&&v.hasContent&&!1!==v.contentType||t.contentType)&&T.setRequestHeader("Content-Type",v.contentType),T.setRequestHeader("Accept",v.dataTypes[0]&&v.accepts[v.dataTypes[0]]?v.accepts[v.dataTypes[0]]+("*"!==v.dataTypes[0]?", "+$t+"; q=0.01":""):v.accepts["*"]),v.headers)T.setRequestHeader(i,v.headers[i]);if(v.beforeSend&&(!1===v.beforeSend.call(y,T,v)||h))return T.abort();if(u="abort",b.add(v.complete),T.done(v.success),T.fail(v.error),c=_t(Wt,v,t,T)){if(T.readyState=1,g&&m.trigger("ajaxSend",[T,v]),h)return T;v.async&&0<v.timeout&&(d=C.setTimeout(function(){T.abort("timeout")},v.timeout));try{h=!1,c.send(a,l)}catch(e){if(h)throw e;l(-1,e)}}else l(-1,"No Transport");function l(e,t,n,r){var i,o,a,s,u,l=t;h||(h=!0,d&&C.clearTimeout(d),c=void 0,p=r||"",T.readyState=0<e?4:0,i=200<=e&&e<300||304===e,n&&(s=function(e,t,n){var r,i,o,a,s=e.contents,u=e.dataTypes;while("*"===u[0])u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}(v,T,n)),s=function(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];o=c.shift();while(o)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e["throws"])t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}(v,s,T,i),i?(v.ifModified&&((u=T.getResponseHeader("Last-Modified"))&&(k.lastModified[f]=u),(u=T.getResponseHeader("etag"))&&(k.etag[f]=u)),204===e||"HEAD"===v.type?l="nocontent":304===e?l="notmodified":(l=s.state,o=s.data,i=!(a=s.error))):(a=l,!e&&l||(l="error",e<0&&(e=0))),T.status=e,T.statusText=(t||l)+"",i?x.resolveWith(y,[o,l,T]):x.rejectWith(y,[T,l,a]),T.statusCode(w),w=void 0,g&&m.trigger(i?"ajaxSuccess":"ajaxError",[T,v,i?o:a]),b.fireWith(y,[T,l]),g&&(m.trigger("ajaxComplete",[T,v]),--k.active||k.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return k.get(e,t,n,"json")},getScript:function(e,t){return k.get(e,void 0,t,"script")}}),k.each(["get","post"],function(e,i){k[i]=function(e,t,n,r){return m(t)&&(r=r||n,n=t,t=void 0),k.ajax(k.extend({url:e,type:i,dataType:r,data:t,success:n},k.isPlainObject(e)&&e))}}),k._evalUrl=function(e,t){return k.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(e){k.globalEval(e,t)}})},k.fn.extend({wrapAll:function(e){var t;return this[0]&&(m(e)&&(e=e.call(this[0])),t=k(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstElementChild)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(n){return m(n)?this.each(function(e){k(this).wrapInner(n.call(this,e))}):this.each(function(){var e=k(this),t=e.contents();t.length?t.wrapAll(n):e.append(n)})},wrap:function(t){var n=m(t);return this.each(function(e){k(this).wrapAll(n?t.call(this,e):t)})},unwrap:function(e){return this.parent(e).not("body").each(function(){k(this).replaceWith(this.childNodes)}),this}}),k.expr.pseudos.hidden=function(e){return!k.expr.pseudos.visible(e)},k.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},k.ajaxSettings.xhr=function(){try{return new C.XMLHttpRequest}catch(e){}};var Ut={0:200,1223:204},Xt=k.ajaxSettings.xhr();y.cors=!!Xt&&"withCredentials"in Xt,y.ajax=Xt=!!Xt,k.ajaxTransport(function(i){var o,a;if(y.cors||Xt&&!i.crossDomain)return{send:function(e,t){var n,r=i.xhr();if(r.open(i.type,i.url,i.async,i.username,i.password),i.xhrFields)for(n in i.xhrFields)r[n]=i.xhrFields[n];for(n in i.mimeType&&r.overrideMimeType&&r.overrideMimeType(i.mimeType),i.crossDomain||e["X-Requested-With"]||(e["X-Requested-With"]="XMLHttpRequest"),e)r.setRequestHeader(n,e[n]);o=function(e){return function(){o&&(o=a=r.onload=r.onerror=r.onabort=r.ontimeout=r.onreadystatechange=null,"abort"===e?r.abort():"error"===e?"number"!=typeof r.status?t(0,"error"):t(r.status,r.statusText):t(Ut[r.status]||r.status,r.statusText,"text"!==(r.responseType||"text")||"string"!=typeof r.responseText?{binary:r.response}:{text:r.responseText},r.getAllResponseHeaders()))}},r.onload=o(),a=r.onerror=r.ontimeout=o("error"),void 0!==r.onabort?r.onabort=a:r.onreadystatechange=function(){4===r.readyState&&C.setTimeout(function(){o&&a()})},o=o("abort");try{r.send(i.hasContent&&i.data||null)}catch(e){if(o)throw e}},abort:function(){o&&o()}}}),k.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),k.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return k.globalEval(e),e}}}),k.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),k.ajaxTransport("script",function(n){var r,i;if(n.crossDomain||n.scriptAttrs)return{send:function(e,t){r=k("<script>").attr(n.scriptAttrs||{}).prop({charset:n.scriptCharset,src:n.url}).on("load error",i=function(e){r.remove(),i=null,e&&t("error"===e.type?404:200,e.type)}),E.head.appendChild(r[0])},abort:function(){i&&i()}}});var Vt,Gt=[],Yt=/(=)\?(?=&|$)|\?\?/;k.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Gt.pop()||k.expando+"_"+kt++;return this[e]=!0,e}}),k.ajaxPrefilter("json jsonp",function(e,t,n){var r,i,o,a=!1!==e.jsonp&&(Yt.test(e.url)?"url":"string"==typeof e.data&&0===(e.contentType||"").indexOf("application/x-www-form-urlencoded")&&Yt.test(e.data)&&"data");if(a||"jsonp"===e.dataTypes[0])return r=e.jsonpCallback=m(e.jsonpCallback)?e.jsonpCallback():e.jsonpCallback,a?e[a]=e[a].replace(Yt,"$1"+r):!1!==e.jsonp&&(e.url+=(St.test(e.url)?"&":"?")+e.jsonp+"="+r),e.converters["script json"]=function(){return o||k.error(r+" was not called"),o[0]},e.dataTypes[0]="json",i=C[r],C[r]=function(){o=arguments},n.always(function(){void 0===i?k(C).removeProp(r):C[r]=i,e[r]&&(e.jsonpCallback=t.jsonpCallback,Gt.push(r)),o&&m(i)&&i(o[0]),o=i=void 0}),"script"}),y.createHTMLDocument=((Vt=E.implementation.createHTMLDocument("").body).innerHTML="<form></form><form></form>",2===Vt.childNodes.length),k.parseHTML=function(e,t,n){return"string"!=typeof e?[]:("boolean"==typeof t&&(n=t,t=!1),t||(y.createHTMLDocument?((r=(t=E.implementation.createHTMLDocument("")).createElement("base")).href=E.location.href,t.head.appendChild(r)):t=E),o=!n&&[],(i=D.exec(e))?[t.createElement(i[1])]:(i=we([e],t,o),o&&o.length&&k(o).remove(),k.merge([],i.childNodes)));var r,i,o},k.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return-1<s&&(r=mt(e.slice(s)),e=e.slice(0,s)),m(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),0<a.length&&k.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?k("<div>").append(k.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},k.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){k.fn[t]=function(e){return this.on(t,e)}}),k.expr.pseudos.animated=function(t){return k.grep(k.timers,function(e){return t===e.elem}).length},k.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=k.css(e,"position"),c=k(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=k.css(e,"top"),u=k.css(e,"left"),("absolute"===l||"fixed"===l)&&-1<(o+u).indexOf("auto")?(a=(r=c.position()).top,i=r.left):(a=parseFloat(o)||0,i=parseFloat(u)||0),m(t)&&(t=t.call(e,n,k.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},k.fn.extend({offset:function(t){if(arguments.length)return void 0===t?this:this.each(function(e){k.offset.setOffset(this,t,e)});var e,n,r=this[0];return r?r.getClientRects().length?(e=r.getBoundingClientRect(),n=r.ownerDocument.defaultView,{top:e.top+n.pageYOffset,left:e.left+n.pageXOffset}):{top:0,left:0}:void 0},position:function(){if(this[0]){var e,t,n,r=this[0],i={top:0,left:0};if("fixed"===k.css(r,"position"))t=r.getBoundingClientRect();else{t=this.offset(),n=r.ownerDocument,e=r.offsetParent||n.documentElement;while(e&&(e===n.body||e===n.documentElement)&&"static"===k.css(e,"position"))e=e.parentNode;e&&e!==r&&1===e.nodeType&&((i=k(e).offset()).top+=k.css(e,"borderTopWidth",!0),i.left+=k.css(e,"borderLeftWidth",!0))}return{top:t.top-i.top-k.css(r,"marginTop",!0),left:t.left-i.left-k.css(r,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent;while(e&&"static"===k.css(e,"position"))e=e.offsetParent;return e||ie})}}),k.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,i){var o="pageYOffset"===i;k.fn[t]=function(e){return _(this,function(e,t,n){var r;if(x(e)?r=e:9===e.nodeType&&(r=e.defaultView),void 0===n)return r?r[i]:e[t];r?r.scrollTo(o?r.pageXOffset:n,o?n:r.pageYOffset):e[t]=n},t,e,arguments.length)}}),k.each(["top","left"],function(e,n){k.cssHooks[n]=ze(y.pixelPosition,function(e,t){if(t)return t=_e(e,n),$e.test(t)?k(e).position()[n]+"px":t})}),k.each({Height:"height",Width:"width"},function(a,s){k.each({padding:"inner"+a,content:s,"":"outer"+a},function(r,o){k.fn[o]=function(e,t){var n=arguments.length&&(r||"boolean"!=typeof e),i=r||(!0===e||!0===t?"margin":"border");return _(this,function(e,t,n){var r;return x(e)?0===o.indexOf("outer")?e["inner"+a]:e.document.documentElement["client"+a]:9===e.nodeType?(r=e.documentElement,Math.max(e.body["scroll"+a],r["scroll"+a],e.body["offset"+a],r["offset"+a],r["client"+a])):void 0===n?k.css(e,t,i):k.style(e,t,n,i)},s,n?e:void 0,n)}})}),k.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,n){k.fn[n]=function(e,t){return 0<arguments.length?this.on(n,null,e,t):this.trigger(n)}}),k.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),k.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}}),k.proxy=function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),m(e))return r=s.call(arguments,2),(i=function(){return e.apply(t||this,r.concat(s.call(arguments)))}).guid=e.guid=e.guid||k.guid++,i},k.holdReady=function(e){e?k.readyWait++:k.ready(!0)},k.isArray=Array.isArray,k.parseJSON=JSON.parse,k.nodeName=A,k.isFunction=m,k.isWindow=x,k.camelCase=V,k.type=w,k.now=Date.now,k.isNumeric=function(e){var t=k.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},"function"==typeof define&&define.amd&&define("jquery",[],function(){return k});var Qt=C.jQuery,Jt=C.$;return k.noConflict=function(e){return C.$===k&&(C.$=Jt),e&&C.jQuery===k&&(C.jQuery=Qt),k},e||(C.jQuery=C.$=k),k});
/*
 * jQuery throttle / debounce - v1.1 - 3/7/2010
 * http://benalman.com/projects/jquery-throttle-debounce-plugin/
 * 
 * Copyright (c) 2010 "Cowboy" Ben Alman
 * Dual licensed under the MIT and GPL licenses.
 * http://benalman.com/about/license/
 */
(function(b,c){var $=b.jQuery||b.Cowboy||(b.Cowboy={}),a;$.throttle=a=function(e,f,j,i){var h,d=0;if(typeof f!=="boolean"){i=j;j=f;f=c}function g(){var o=this,m=+new Date()-d,n=arguments;function l(){d=+new Date();j.apply(o,n)}function k(){h=c}if(i&&!h){l()}h&&clearTimeout(h);if(i===c&&m>e){l()}else{if(f!==true){h=setTimeout(i?k:l,i===c?e-m:e)}}}if($.guid){g.guid=j.guid=j.guid||$.guid++}return g};$.debounce=function(d,e,f){return f===c?a(d,e,false):a(d,f,e!==false)}})(this);
/*!
 * imagesLoaded PACKAGED v4.1.0
 * JavaScript is all like "You images are done yet or what?"
 * MIT License
 */
!function(t,e){"function"==typeof define&&define.amd?define("ev-emitter/ev-emitter",e):"object"==typeof module&&module.exports?module.exports=e():t.EvEmitter=e()}(this,function(){function t(){}var e=t.prototype;return e.on=function(t,e){if(t&&e){var i=this._events=this._events||{},n=i[t]=i[t]||[];return-1==n.indexOf(e)&&n.push(e),this}},e.once=function(t,e){if(t&&e){this.on(t,e);var i=this._onceEvents=this._onceEvents||{},n=i[t]=i[t]||[];return n[e]=!0,this}},e.off=function(t,e){var i=this._events&&this._events[t];if(i&&i.length){var n=i.indexOf(e);return-1!=n&&i.splice(n,1),this}},e.emitEvent=function(t,e){var i=this._events&&this._events[t];if(i&&i.length){var n=0,o=i[n];e=e||[];for(var r=this._onceEvents&&this._onceEvents[t];o;){var s=r&&r[o];s&&(this.off(t,o),delete r[o]),o.apply(this,e),n+=s?0:1,o=i[n]}return this}},t}),function(t,e){"use strict";"function"==typeof define&&define.amd?define(["ev-emitter/ev-emitter"],function(i){return e(t,i)}):"object"==typeof module&&module.exports?module.exports=e(t,require("ev-emitter")):t.imagesLoaded=e(t,t.EvEmitter)}(window,function(t,e){function i(t,e){for(var i in e)t[i]=e[i];return t}function n(t){var e=[];if(Array.isArray(t))e=t;else if("number"==typeof t.length)for(var i=0;i<t.length;i++)e.push(t[i]);else e.push(t);return e}function o(t,e,r){return this instanceof o?("string"==typeof t&&(t=document.querySelectorAll(t)),this.elements=n(t),this.options=i({},this.options),"function"==typeof e?r=e:i(this.options,e),r&&this.on("always",r),this.getImages(),h&&(this.jqDeferred=new h.Deferred),void setTimeout(function(){this.check()}.bind(this))):new o(t,e,r)}function r(t){this.img=t}function s(t,e){this.url=t,this.element=e,this.img=new Image}var h=t.jQuery,a=t.console;o.prototype=Object.create(e.prototype),o.prototype.options={},o.prototype.getImages=function(){this.images=[],this.elements.forEach(this.addElementImages,this)},o.prototype.addElementImages=function(t){"IMG"==t.nodeName&&this.addImage(t),this.options.background===!0&&this.addElementBackgroundImages(t);var e=t.nodeType;if(e&&d[e]){for(var i=t.querySelectorAll("img"),n=0;n<i.length;n++){var o=i[n];this.addImage(o)}if("string"==typeof this.options.background){var r=t.querySelectorAll(this.options.background);for(n=0;n<r.length;n++){var s=r[n];this.addElementBackgroundImages(s)}}}};var d={1:!0,9:!0,11:!0};return o.prototype.addElementBackgroundImages=function(t){var e=getComputedStyle(t);if(e)for(var i=/url\((['"])?(.*?)\1\)/gi,n=i.exec(e.backgroundImage);null!==n;){var o=n&&n[2];o&&this.addBackground(o,t),n=i.exec(e.backgroundImage)}},o.prototype.addImage=function(t){var e=new r(t);this.images.push(e)},o.prototype.addBackground=function(t,e){var i=new s(t,e);this.images.push(i)},o.prototype.check=function(){function t(t,i,n){setTimeout(function(){e.progress(t,i,n)})}var e=this;return this.progressedCount=0,this.hasAnyBroken=!1,this.images.length?void this.images.forEach(function(e){e.once("progress",t),e.check()}):void this.complete()},o.prototype.progress=function(t,e,i){this.progressedCount++,this.hasAnyBroken=this.hasAnyBroken||!t.isLoaded,this.emitEvent("progress",[this,t,e]),this.jqDeferred&&this.jqDeferred.notify&&this.jqDeferred.notify(this,t),this.progressedCount==this.images.length&&this.complete(),this.options.debug&&a&&a.log("progress: "+i,t,e)},o.prototype.complete=function(){var t=this.hasAnyBroken?"fail":"done";if(this.isComplete=!0,this.emitEvent(t,[this]),this.emitEvent("always",[this]),this.jqDeferred){var e=this.hasAnyBroken?"reject":"resolve";this.jqDeferred[e](this)}},r.prototype=Object.create(e.prototype),r.prototype.check=function(){var t=this.getIsImageComplete();return t?void this.confirm(0!==this.img.naturalWidth,"naturalWidth"):(this.proxyImage=new Image,this.proxyImage.addEventListener("load",this),this.proxyImage.addEventListener("error",this),this.img.addEventListener("load",this),this.img.addEventListener("error",this),void(this.proxyImage.src=this.img.src))},r.prototype.getIsImageComplete=function(){return this.img.complete&&void 0!==this.img.naturalWidth},r.prototype.confirm=function(t,e){this.isLoaded=t,this.emitEvent("progress",[this,this.img,e])},r.prototype.handleEvent=function(t){var e="on"+t.type;this[e]&&this[e](t)},r.prototype.onload=function(){this.confirm(!0,"onload"),this.unbindEvents()},r.prototype.onerror=function(){this.confirm(!1,"onerror"),this.unbindEvents()},r.prototype.unbindEvents=function(){this.proxyImage.removeEventListener("load",this),this.proxyImage.removeEventListener("error",this),this.img.removeEventListener("load",this),this.img.removeEventListener("error",this)},s.prototype=Object.create(r.prototype),s.prototype.check=function(){this.img.addEventListener("load",this),this.img.addEventListener("error",this),this.img.src=this.url;var t=this.getIsImageComplete();t&&(this.confirm(0!==this.img.naturalWidth,"naturalWidth"),this.unbindEvents())},s.prototype.unbindEvents=function(){this.img.removeEventListener("load",this),this.img.removeEventListener("error",this)},s.prototype.confirm=function(t,e){this.isLoaded=t,this.emitEvent("progress",[this,this.element,e])},o.makeJQueryPlugin=function(e){e=e||t.jQuery,e&&(h=e,h.fn.imagesLoaded=function(t,e){var i=new o(this,t,e);return i.jqDeferred.promise(h(this))})},o.makeJQueryPlugin(),o});
/*! lz-string-1.3.3-min.js | (c) 2013 Pieroxy | Licensed under a WTFPL license */
var LZString={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",_f:String.fromCharCode,compressToBase64:function(e){if(e==null)return"";var t="";var n,r,i,s,o,u,a;var f=0;e=LZString.compress(e);while(f<e.length*2){if(f%2==0){n=e.charCodeAt(f/2)>>8;r=e.charCodeAt(f/2)&255;if(f/2+1<e.length)i=e.charCodeAt(f/2+1)>>8;else i=NaN}else{n=e.charCodeAt((f-1)/2)&255;if((f+1)/2<e.length){r=e.charCodeAt((f+1)/2)>>8;i=e.charCodeAt((f+1)/2)&255}else r=i=NaN}f+=3;s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+LZString._keyStr.charAt(s)+LZString._keyStr.charAt(o)+LZString._keyStr.charAt(u)+LZString._keyStr.charAt(a)}return t},decompressFromBase64:function(e){if(e==null)return"";var t="",n=0,r,i,s,o,u,a,f,l,c=0,h=LZString._f;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(c<e.length){u=LZString._keyStr.indexOf(e.charAt(c++));a=LZString._keyStr.indexOf(e.charAt(c++));f=LZString._keyStr.indexOf(e.charAt(c++));l=LZString._keyStr.indexOf(e.charAt(c++));i=u<<2|a>>4;s=(a&15)<<4|f>>2;o=(f&3)<<6|l;if(n%2==0){r=i<<8;if(f!=64){t+=h(r|s)}if(l!=64){r=o<<8}}else{t=t+h(r|i);if(f!=64){r=s<<8}if(l!=64){t+=h(r|o)}}n+=3}return LZString.decompress(t)},compressToUTF16:function(e){if(e==null)return"";var t="",n,r,i,s=0,o=LZString._f;e=LZString.compress(e);for(n=0;n<e.length;n++){r=e.charCodeAt(n);switch(s++){case 0:t+=o((r>>1)+32);i=(r&1)<<14;break;case 1:t+=o(i+(r>>2)+32);i=(r&3)<<13;break;case 2:t+=o(i+(r>>3)+32);i=(r&7)<<12;break;case 3:t+=o(i+(r>>4)+32);i=(r&15)<<11;break;case 4:t+=o(i+(r>>5)+32);i=(r&31)<<10;break;case 5:t+=o(i+(r>>6)+32);i=(r&63)<<9;break;case 6:t+=o(i+(r>>7)+32);i=(r&127)<<8;break;case 7:t+=o(i+(r>>8)+32);i=(r&255)<<7;break;case 8:t+=o(i+(r>>9)+32);i=(r&511)<<6;break;case 9:t+=o(i+(r>>10)+32);i=(r&1023)<<5;break;case 10:t+=o(i+(r>>11)+32);i=(r&2047)<<4;break;case 11:t+=o(i+(r>>12)+32);i=(r&4095)<<3;break;case 12:t+=o(i+(r>>13)+32);i=(r&8191)<<2;break;case 13:t+=o(i+(r>>14)+32);i=(r&16383)<<1;break;case 14:t+=o(i+(r>>15)+32,(r&32767)+32);s=0;break}}return t+o(i+32)},decompressFromUTF16:function(e){if(e==null)return"";var t="",n,r,i=0,s=0,o=LZString._f;while(s<e.length){r=e.charCodeAt(s)-32;switch(i++){case 0:n=r<<1;break;case 1:t+=o(n|r>>14);n=(r&16383)<<2;break;case 2:t+=o(n|r>>13);n=(r&8191)<<3;break;case 3:t+=o(n|r>>12);n=(r&4095)<<4;break;case 4:t+=o(n|r>>11);n=(r&2047)<<5;break;case 5:t+=o(n|r>>10);n=(r&1023)<<6;break;case 6:t+=o(n|r>>9);n=(r&511)<<7;break;case 7:t+=o(n|r>>8);n=(r&255)<<8;break;case 8:t+=o(n|r>>7);n=(r&127)<<9;break;case 9:t+=o(n|r>>6);n=(r&63)<<10;break;case 10:t+=o(n|r>>5);n=(r&31)<<11;break;case 11:t+=o(n|r>>4);n=(r&15)<<12;break;case 12:t+=o(n|r>>3);n=(r&7)<<13;break;case 13:t+=o(n|r>>2);n=(r&3)<<14;break;case 14:t+=o(n|r>>1);n=(r&1)<<15;break;case 15:t+=o(n|r);i=0;break}s++}return LZString.decompress(t)},compress:function(e){if(e==null)return"";var t,n,r={},i={},s="",o="",u="",a=2,f=3,l=2,c="",h=0,p=0,d,v=LZString._f;for(d=0;d<e.length;d+=1){s=e.charAt(d);if(!Object.prototype.hasOwnProperty.call(r,s)){r[s]=f++;i[s]=true}o=u+s;if(Object.prototype.hasOwnProperty.call(r,o)){u=o}else{if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(t=0;t<l;t++){h=h<<1;if(p==15){p=0;c+=v(h);h=0}else{p++}}n=u.charCodeAt(0);for(t=0;t<8;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}else{n=1;for(t=0;t<l;t++){h=h<<1|n;if(p==15){p=0;c+=v(h);h=0}else{p++}n=0}n=u.charCodeAt(0);for(t=0;t<16;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}delete i[u]}else{n=r[u];for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}r[o]=f++;u=String(s)}}if(u!==""){if(Object.prototype.hasOwnProperty.call(i,u)){if(u.charCodeAt(0)<256){for(t=0;t<l;t++){h=h<<1;if(p==15){p=0;c+=v(h);h=0}else{p++}}n=u.charCodeAt(0);for(t=0;t<8;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}else{n=1;for(t=0;t<l;t++){h=h<<1|n;if(p==15){p=0;c+=v(h);h=0}else{p++}n=0}n=u.charCodeAt(0);for(t=0;t<16;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}delete i[u]}else{n=r[u];for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}}a--;if(a==0){a=Math.pow(2,l);l++}}n=2;for(t=0;t<l;t++){h=h<<1|n&1;if(p==15){p=0;c+=v(h);h=0}else{p++}n=n>>1}while(true){h=h<<1;if(p==15){c+=v(h);break}else p++}return c},decompress:function(e){if(e==null)return"";if(e=="")return null;var t=[],n,r=4,i=4,s=3,o="",u="",a,f,l,c,h,p,d,v=LZString._f,m={string:e,val:e.charCodeAt(0),position:32768,index:1};for(a=0;a<3;a+=1){t[a]=a}l=0;h=Math.pow(2,2);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}switch(n=l){case 0:l=0;h=Math.pow(2,8);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}d=v(l);break;case 1:l=0;h=Math.pow(2,16);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}d=v(l);break;case 2:return""}t[3]=d;f=u=d;while(true){if(m.index>m.string.length){return""}l=0;h=Math.pow(2,s);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}switch(d=l){case 0:l=0;h=Math.pow(2,8);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}t[i++]=v(l);d=i-1;r--;break;case 1:l=0;h=Math.pow(2,16);p=1;while(p!=h){c=m.val&m.position;m.position>>=1;if(m.position==0){m.position=32768;m.val=m.string.charCodeAt(m.index++)}l|=(c>0?1:0)*p;p<<=1}t[i++]=v(l);d=i-1;r--;break;case 2:return u}if(r==0){r=Math.pow(2,s);s++}if(t[d]){o=t[d]}else{if(d===i){o=f+f.charAt(0)}else{return null}}u+=o;t[i++]=f+o.charAt(0);r--;f=o;if(r==0){r=Math.pow(2,s);s++}}}};if(typeof module!=="undefined"&&module!=null){module.exports=LZString}
/*! @source http://purl.eligrey.com/github/FileSaver.js/blob/master/FileSaver.js */
var saveAs=saveAs||navigator.msSaveBlob&&navigator.msSaveBlob.bind(navigator)||function(e){"use strict";var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=e.URL||e.webkitURL||e,i=t.createElementNS("http://www.w3.org/1999/xhtml","a"),s="download"in i,o=function(n){var r=t.createEvent("MouseEvents");r.initMouseEvent("click",true,false,e,0,0,0,0,0,false,false,false,false,0,null);n.dispatchEvent(r)},u=e.webkitRequestFileSystem,a=e.requestFileSystem||u||e.mozRequestFileSystem,f=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},l="application/octet-stream",c=0,h=[],p=function(){var e=h.length;while(e--){var t=h[e];if(typeof t==="string"){r.revokeObjectURL(t)}else{t.remove()}}h.length=0},d=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var i=e["on"+t[r]];if(typeof i==="function"){try{i.call(e,n||e)}catch(s){f(s)}}}},v=function(t,r){var f=this,p=t.type,v=false,m,g,y=function(){var e=n().createObjectURL(t);h.push(e);return e},b=function(){d(f,"writestart progress write writeend".split(" "))},w=function(){if(v||!m){m=y(t)}if(g){g.location.href=m}else{window.open(m,"_blank")}f.readyState=f.DONE;b()},E=function(e){return function(){if(f.readyState!==f.DONE){return e.apply(this,arguments)}}},S={create:true,exclusive:false},x;f.readyState=f.INIT;if(!r){r="download"}if(s){m=y(t);i.href=m;i.download=r;o(i);f.readyState=f.DONE;b();return}if(e.chrome&&p&&p!==l){x=t.slice||t.webkitSlice;t=x.call(t,0,t.size,l);v=true}if(u&&r!=="download"){r+=".download"}if(p===l||u){g=e}if(!a){w();return}c+=t.size;a(e.TEMPORARY,c,E(function(e){e.root.getDirectory("saved",S,E(function(e){var n=function(){e.getFile(r,S,E(function(e){e.createWriter(E(function(n){n.onwriteend=function(t){g.location.href=e.toURL();h.push(e);f.readyState=f.DONE;d(f,"writeend",t)};n.onerror=function(){var e=n.error;if(e.code!==e.ABORT_ERR){w()}};"writestart progress write abort".split(" ").forEach(function(e){n["on"+e]=f["on"+e]});n.write(t);f.abort=function(){n.abort();f.readyState=f.DONE};f.readyState=f.WRITING}),w)}),w)};e.getFile(r,{create:false},E(function(e){e.remove();n()}),E(function(e){if(e.code===e.NOT_FOUND_ERR){n()}else{w()}}))}),w)}),w)},m=v.prototype,g=function(e,t){return new v(e,t)};m.abort=function(){var e=this;e.readyState=e.DONE;d(e,"abort")};m.readyState=m.INIT=0;m.WRITING=1;m.DONE=2;m.error=m.onwritestart=m.onprogress=m.onwrite=m.onabort=m.onerror=m.onwriteend=null;e.addEventListener("unload",p,false);return g}(self)
/*! seedrandom.js v2.3.3 | (c) 2013 David Bau, all rights reserved. | Licensed under a BSD-style license */
!function(a,b,c,d,e,f,g,h,i){function j(a){var b,c=a.length,e=this,f=0,g=e.i=e.j=0,h=e.S=[];for(c||(a=[c++]);d>f;)h[f]=f++;for(f=0;d>f;f++)h[f]=h[g=r&g+a[f%c]+(b=h[f])],h[g]=b;(e.g=function(a){for(var b,c=0,f=e.i,g=e.j,h=e.S;a--;)b=h[f=r&f+1],c=c*d+h[r&(h[f]=h[g=r&g+b])+(h[g]=b)];return e.i=f,e.j=g,c})(d)}function k(a,b){var c,d=[],e=typeof a;if(b&&"object"==e)for(c in a)try{d.push(k(a[c],b-1))}catch(f){}return d.length?d:"string"==e?a:a+"\0"}function l(a,b){for(var c,d=a+"",e=0;e<d.length;)b[r&e]=r&(c^=19*b[r&e])+d.charCodeAt(e++);return n(b)}function m(c){try{return a.crypto.getRandomValues(c=new Uint8Array(d)),n(c)}catch(e){return[+new Date,a,(c=a.navigator)&&c.plugins,a.screen,n(b)]}}function n(a){return String.fromCharCode.apply(0,a)}var o=c.pow(d,e),p=c.pow(2,f),q=2*p,r=d-1,s=c["seed"+i]=function(a,f,g){var h=[],r=l(k(f?[a,n(b)]:null==a?m():a,3),h),s=new j(h);return l(n(s.S),b),(g||function(a,b,d){return d?(c[i]=a,b):a})(function(){for(var a=s.g(e),b=o,c=0;p>a;)a=(a+c)*d,b*=d,c=s.g(1);for(;a>=q;)a/=2,b/=2,c>>>=1;return(a+c)/b},r,this==c)};l(c[i](),b),g&&g.exports?g.exports=s:h&&h.amd&&h(function(){return s})}(this,[],Math,256,6,52,"object"==typeof module&&module,"function"==typeof define&&define,"random");
/*! console_hack.js | (c) 2015 Thomas Michael Edwards | Licensed under SugarCube's Simple BSD license */
!function(){for(var methods=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeline","timelineEnd","timeStamp","trace","warn"],length=methods.length,noop=function(){},console=window.console=window.console||{};length--;){var method=methods[length];console[method]||(console[method]=noop)}}();
}else{document.documentElement.setAttribute("data-init", "lacking");}
</script>
<style id="style-normalize" type="text/css">/*! normalize.css v3.0.3 | MIT License | github.com/necolas/normalize.css */html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}</style>
<style id="style-init-screen" type="text/css">@-webkit-keyframes init-loading-spin{0%{-webkit-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@-o-keyframes init-loading-spin{0%{-o-transform:rotate(0);transform:rotate(0)}100%{-o-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes init-loading-spin{0%{-webkit-transform:rotate(0);-o-transform:rotate(0);transform:rotate(0)}100%{-webkit-transform:rotate(360deg);-o-transform:rotate(360deg);transform:rotate(360deg)}}#init-screen{display:none;z-index:100000;position:fixed;top:0;left:0;height:100%;width:100%;font:28px/1 Helmet,Freesans,sans-serif;font-weight:700;color:#eee;background-color:#111;text-align:center}#init-screen>div{display:none;position:relative;margin:0 auto;max-width:1136px;top:25%}html[data-init=lacking] #init-screen,html[data-init=loading] #init-screen,html[data-init=no-js] #init-screen{display:block}html[data-init=lacking] #init-lacking,html[data-init=no-js] #init-no-js{display:block;padding:0 1em}html[data-init=no-js] #init-no-js{color:red}html[data-init=loading] #init-loading{display:block;border:24px solid transparent;border-radius:50%;border-top-color:#7f7f7f;border-bottom-color:#7f7f7f;width:100px;height:100px;-webkit-animation:init-loading-spin 2s linear infinite;-o-animation:init-loading-spin 2s linear infinite;animation:init-loading-spin 2s linear infinite}html[data-init=loading] #init-loading>div{text-indent:9999em;overflow:hidden;white-space:nowrap}html[data-init=loading] #passages,html[data-init=loading] #ui-bar{display:none}</style>
<style id="style-font" type="text/css">@font-face{font-family:tme-fa-icons;src:url(data:application/octet-stream;base64,d09GRgABAAAAACWoAA4AAAAAQhQAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABPUy8yAAABRAAAAEQAAABWPihI/2NtYXAAAAGIAAAAOgAAAUrQXRm3Y3Z0IAAAAcQAAAAKAAAACgAAAABmcGdtAAAB0AAABZQAAAtwiJCQWWdhc3AAAAdkAAAACAAAAAgAAAAQZ2x5ZgAAB2wAABjCAAAq+uJ4WNtoZWFkAAAgMAAAADQAAAA2BZlJs2hoZWEAACBkAAAAIAAAACQIJwQZaG10eAAAIIQAAABuAAABOPTeAABsb2NhAAAg9AAAAJ4AAACeojKW6m1heHAAACGUAAAAIAAAACAA6gvwbmFtZQAAIbQAAAGPAAAC/eLsyKlwb3N0AAAjRAAAAfwAAAM0412SIHByZXAAACVAAAAAZQAAAHvdawOFeJxjYGRWYZzAwMrAwVTFtIeBgaEHQjM+YDBkZGJgYGJgZWbACgLSXFMYHF4wvPBhDvqfxRDFHMQwDSjMCJIDANLeC6V4nGNgYGBmgGAZBkYGEHAB8hjBfBYGDSDNBqQZGZgYGF74/P8PUvCCAURLMELVAwEjG8OIBwC4Ywb6AAAAAAAAAAAAAAAAAAB4nK1WaXMTRxCd1WHLNj6CDxI2gVnGcox2VpjLCBDG7EoW4BzylexCjl1Ldu6LT/wG/ZpekVSRb/y0vB4d2GAnVVQoSv2m9+1M9+ueXpPQksReWI+k3HwpprY2aWTnSUg3bFqO4kPZ2QspU0z+LoiCaLXUvu04JCISgap1hSWC2PfI0iTjQ48yWrYlvWpSbulJd9kaD+qt+vbT0FGO3QklNZuhQ+uRLanCqBJFMu2RkjYtw9VfSVrh5yvMfNUMJYLoJJLGm2EMj+Rn44xWGa3GdhxFkU2WG0WKRDM8iCKPslpin1wxQUD5oBlSXvk0onyEH5EVe5TTCnHJdprf9yU/6R3OvyTieouyJQf+QHZkB3unK/ki0toK46adbEehivB0fSfEI5uT6p/sUV7TaOB2RaYnzQiWyleQWPkJZfYPyWrhfMqXPBrVkoOcCFovc2Jf8g60HkdMiWsmyILujk6IoO6XnKHYY/q4+OO9XSwXIQTIOJb1jkq4EEYpYbOaJG0EOYiSskWV1HpHTJzyOi3iLWG/Tu3oS2e0Sag7MZ6th46tnKjkeDSp00ymTu2k5tGUBlFKOhM85tcBlB/RJK+2sZrEyqNpbDNjJJFQoIVzaSqIZSeWNAXRPJrRm7thmmvXokWaPFDPPXpPb26Fmzs9p+3AP2v8Z3UqpoO9MJ2eDshKfJp2uUnRun56hn8m8UPWAiqRLTbDlMVDtn4H5eVjS47CawNs957zK+h99kTIpIH4G/AeL9UpBUyFmFVQC9201rUsy9RqVotUZOq7IU0rX9ZpAk05Dn1jX8Y4/q+ZGUtMCd/vxOnZEZeeufYlyDSH3GZdj+Z1arFdgM5sz+k0y/Z9nebYfqDTPNvzOh1ha+t0lO2HOi2w/UinY2wvaEGT7jsEchGBXMAGEoGwdRAI20sIhK1CIGwXEQjbIgJhu4RA2H6MQNguIxC2l7Wsmn4qaRw7E8sARYgDoznuyGVuKldTyaUSrotGpzbkKXKrpKJ4Vv0rA/3ikTesgbVAukTW/IpJrnxUleOPrmh508S5Ao5Vf3tzXJ8TD2W/WPhT8L/amqqkV6x5ZHIVeSPQk+NE1yYVj67p8rmqR9f/i4oOa4F+A6UQC0VZlg2+mZDwUafTUA1c5RAzGzMP1/W6Zc3P4fybGCEL6H78NxQaC9yDTllJWe1gr9XXj2W5twflsCdYkmK+zOtb4YuMzEr7RWYpez7yecAVMCqVYasNXK3gzXsS85DpTfJMELcVZYOkjceZILGBYx4wb76TICRMXbWB2imcsIG8YMwp2O+EQ1RvlOVwe6F9Ho2Uf2tX7MgZFU0Q+G32Rtjrs1DyW6yBhCe/1NdAVSFNxbipgEsj5YZq8GFcrdtGMk6gr6jYDcuyig8fR9x3So5lIPlIEatHRz+tvUKd1Ln9yihu3zv9CIJBaWL+9r6Z4qCUd7WSZVZtA1O3GpVT15rDxasO3c2j7nvH2Sdy1jTddE/c9L6mVbeDg7lZEO3bHJSlTC6o68MOG6jLzaXQ6mVckt52DzAsMKDfoRUb/1f3cfg8V6oKo+NIvZ2oH6PPYgzyDzh/R/UF6OcxTLmGlOd7lxOfbtzD2TJdxV2sn+LfwKy15mbpGnBD0w2Yh6xaHbrKDXynBjo90tyO9BDwse4K8QBgE8Bi8InuWsbzKYDxfMYcH+Bz5jBoMofBFnMYbDNnDWCHOQx2mcNgjzkMvmDOOsCXzGEQModBxBwGT5gTADxlDoOvmMPga+Yw+IY59wG+ZQ6DmDkMEuYw2Nd0ayhzixd0F6htUBXowPQTFvewONRUGbK/44Vhf28Qs38wiKk/aro9pP7EC0P92SCm/mIQU3/VdGdI/Y0Xhvq7QUz9wyCmPtMvxnKZwV9GvkuFA8ouNp/z98T7B8IaQLYAAQAB//8AD3icrToNcBzVefe9/b3dvd29u909/dyd7ke6k86yLEunOyHJsrCxJWyJGmEcLMDYxBhHNsZQBzOAkjQmFDrGIq5gHEIcCILOAGZq3IQO04RkIGkgaUMKMbQznSlJW0wgJtOQHxRr1e+93TvJwq7JTD3y2/f//bzvfX/vAhAIzL3KPcYNBFIB8UR9EJYuAcuAqGNbOiwDSczkuorlaJ6WTeVSRwMIDveY8aN20GztjzMhW4P2H+kNUPM5NaVNQE0K3tWM77vv8rJqgnT33VJE4WWIfd/QbKHZjcXcZiFAqjCDgUJA/mZTWOIIwi0vAwNiUjkW9THIZs6DAbnj6ffGP/P+0y2vv+5SXGLKuXHJPJH92c+yT7x3883wnI9W/DxI4T9+bm7uOL+MUwNywAg0BJYFQgNKa2NDzFBEjqeM0SFXLHU4YKe7yjFoSmdEKWw5nemOUj5czMXCliilM7lyuFgqp3HaDf1j/fhH+s6cfm4MEpA8c0BSQBO5CUkD5fJi05kDjSUoNnETTUUSXtpPVm0aGHDdmV0nNkPiMUWeHZMVRSZPSlp0dqypCKVG8iT9IK5AEeamyZGAjecW5tm5SSBm8ojiSqBsYoXDTRtuymw13V8axjB+p2EPlsMGcRzTTRkGOLRpmk/AzSZ+A97ecx+QN8g9gUbc26F7N+GJiN5pLGMA8hUo7EQcHI455A0PwrS3I37N+bZhTE8bex1aeeIJ4+MTjTY6gcH+iIvgGWQRdh2TR9sS81kspCzytguLfBcyuBOLXuhwYnZnh8NFUs6plLPLScGpWBKwkYztwsop7Hie9r7rYK/9brWXTg9U+RiBX+GJiyc0rgIv7UNJe3vPjrFdyZOV/byNUkyW/0AuIi/h+h6U5a64SmW5ieGcya2AYimG+EUtnZN08ImgveV+KOYykiiJVMrbkI+dHUkC9+nyPUFdD94j639r1uTq7FiSNrR1hXS8uLbGapYUSbpaJvzmp5aODbU9iJNBU1gJa5LFTCqihNpDigmWWtc2GjUy7Y2m3hHk14qmPJXp2cTInZudO85dhzw2AuXAJQHl+Yt7l0RVjkO8u4q5JZARE2A5yNxStNgGWcQSj7izA1HucCgJOsRsb7xYWgn9XAwvRqaN4HAS4ENF3kXFFovJ/muW3zsYDK3jxaCQbOouOPXZPmBDNZG4krS0N2/9wakf7hHv+IcPX/jcaGWZAp9fvrFtv66UeSlXn4zYdZo5kLNwIJJRTbEu3jz62Zf37Xv5l7RAeugZfAQ7kJ5koA3PoJB1eP8MpHRVWqpygyITpiKz4DCoHMENlun+wrDA0bNZ9jmJZdZwhhx9UnewMKztg2yAlie9j6O7Lzrks7tYdRdOO4u/FJ9e5G93RyFTJ1f5G17IZDs7z25uEfuFBYwlvYpUUuTnKJO6umg5IymD88yGGxbycjN2JOkIVk6wUoEzm/0O5T/Owb92Jg8NyL/6qFrl30IZ5nSgMp3nch7DkvOMCaMeoQ1U4JZxQncenmAMmcAei/S7V9CvAccW8mczwtMCceSQ8nwhXWuKAeQPJbRCc9RnhoSyhvBL+WgxTzsk0Y567IFj+35wa4Xq7ykS5YIm7UIdq4iCfKcsiIoSvFFWONUnFovZoXHKhXE69R9hTOIEgZPcJ0VZRrx+i3j9hhtFPqQDnYjX8uaEpS2+F4twiVkOylSJAwfvBZO3XBnoTaEHtltSWAGKIEl3SJIQ1CRESIRnLFtJRc88GckEbQuOBTO5zBXziL0JIPKiyMtzggwiMc+czmbDEbDMbJaLhC3LPzPuFOKaD6zEM+tt15gNxTPLIg5dvglCfGmbmakYmqmKsEfRVOWWAXjqvEzVeamT6botq9321Vu2rIb7KOrufmZ24LWmoiI3yspJJ65e704JprBSFGH3pxXLhAQe9fBzbM1rq7YAm1dsctvZSiqu8G94rxwS/LQ7JYorRR0XXq/GmSh4dJADKAsSk70ajQ8gHdE0MhzVjOCbVDSvKINd1PhKVN+fgMTG2zYCvIaq+V2mmsNTP36IRLD6xO7ejWTDisfc7zCVD6tQW+/eMTW1Y3fSt20foe+hBZpQ3zfGfH3vyzmCZNvHFoJFVPrRjj7m6I26M3r7KHQxgD5c2H/4tQdIeJLJ+yQDvTsZOwv4jYfJQxVaxxmtKtNTTVaQnRmS6kkWvfBoNvCeIT55jt41PJZwpg3YYeJYGK+dppgK/sF+R/8ggZIOBlnyNoK/qpwokLZ6uCFRKCTKV8HeGaYksPg2Xj/3fyQZb6dhGWv2QLLQU4DW7lZwf77Hw+vb3AjzexKIVywkEXoGlB1JUqr4FW3A7BZlDzgzhZ5W0tyfI1da7mmn13JvsZOFxLuJIRsmLXJVskByA41iu/uvSds9bWOnPZQ4lSgANm+xqQ6gMPlGH2YR79rSDIXLXQBujHZSxkCpSIeynwCdNxEFJ2HVmSDaFPxQYoIN2BfCM8E6zTCu66VDSQ97KkPfIa8i7nGUITNAZagDhYFJjeg5rXh+bcBuYamT/JWmRVE8Iopeb/3ud1ZdSIs4TkQLcaogJ63Z5dGUxEfefz8qSKko+Qm2PB/ZgyEEMngmjkjovYB0GBog+n9COzD7MiQ73pfOA5S8NLseIst+QWbPC9y/J8dRv7QFliCNWcnzAYlI3fE8hdNVbBPY1WEeZxm8m5mKOdypQRG1qhiRgQBnZbr7N20qT1ipoPsLVYWEGq8hE3BoLPn2tV8PhWVe0WTB4nIN3WMD7cmIiDZEhaSSROulWMbk2+sX4LIs0Iq4NNdUfV3mDeqCbaEOligmbYSFCaU0VRVULrhTKoKlIMubNvV3ZyyOByWMilXkBpNjcIjihTjBrwzF/bmKF1iMJNsHxrobcnxElDVF0C3u69fevP5txIsEcUrVZyR96DPqiI/C+zGTp0uZGkXVP6PG1RncET7Ey/eKjnX885QeWw83krsCIVyvMp8TD9P3rEvMFUkFZxS6Rw25ytWQJ/52/tqLyQSDrc7Dpiq/H2XDgYsVBgjnK7BF95EwLKLNKLh0bg5x74VXPNwJO1fq7raB588j7pbhat78pDKjPE1td1Jl6Hhn8Q73LdISsCrrgwuijljQ28Tinnavx+Xu9ap6jYqn2QzNaly7RoVJ99MoBl/DvmtU1X0Lu3FCnO37XXKEW832Nai8BYnDKKvIF92W3F9dotK94ahCNyJPuW+5b2L1WrQ2X6fSc1TBejLg77uvsm8FX2b1ghWk6cbjuB1FUIVm9y0f6aMKfMbdhjshNGihFKgIgE7044ZvkbXz+zbh3chXN/f35Z6mOyF2b/m7H6V7HVV3XYOYtiDOig/J25bh+xPuAPMdxRPRc8V1YU8Z2mEv9OIO2O6DTg8Wtt2C3+lCcjBRmEaNVbDhi0nLnUK1ttvqdVpsexruQ93WGnf3T9s47N+te7nN5FeohRGeChUfIvZx5htAPYTNjQl/ea/tTlkW7LZ7nIK3dyNsGUwWpq0+a4k/ALvozB5nurkCqwthUdrq5mnzBD/tu5rpfPVYuC6L0VZwnMfd/YnGxgTc97jjFNjGFvRQ6iyrYPfZjyPVyQJM233YRF5YVb1xgLzjwVMX3NOwZ/K7wtJZx4W8pGRNNzf4ZOBeCKgPCxuKcUYmxQNycbjP5wGlEJGk8OZc369tR3gtaZ+X6CbmVkIONRVJcugpluk1TQL1Fqmfy1ELVi4hYy1zJhYNj4zu7RkfbuebN17fv+q2Fj4sDgtE7Hv2uk89uneIH7j9yNWjR1YMmUvJSzO6s9QcGWkbHt83PtzW0yWCMMLr4roNcMm+o88e3XdJ/0VDkWiFDxSv5YhXq8d3nVAryjjtoDXp7Ojn2gg6ijGHIUxDpQZ0Y2lQym2+5NZHN219to8XhsUw33Lb6p6dG9DVGN598/bmkXA0NoPeR2t4qO/h0U8d3bcKtmB5yeilos6PCCB29fgINjeNmEsdfaYmGhm6qB9RrPhEx7mrEbfGwCDauZXNJo09wLJ1oAhSe1NxWkUDKKJofMqeE+szt8S4K9JYmjbLXRRtylOU1vWN//mVy4/0DVGNqM9QJT7SvL287ot5MSZoGC/oyHTWO7p3vdd5s6RB439/5fKH6aIaEDh46AVkpMqWo1YdaWpe1690hzT4e79jxGuLvD+R0iUwuiJ+TLUM4+yrA8aAdsVAsX1JFgMsTkCF4ceBdtgLZ8oXaENnPpfPipLA6A57nn4+XI1hUbCoYmig1KP5pH44Kybnq4cUyatKivvTmXpeOC7y8J4il3yHncWVz+SDrc5zTqucPyYro3Af7XP30/I8ddJxsQAgXIFbz37QdsmqNhJl0K6145C0rkWzExAX8aM3sDpwYyA8oF83PNBXWu7xRPQMIT1E6syw7M4F2tFwOmyhVKQ7+uH/lz9DribLBF4jsuze94lYBc+7LzLOXMw4c+66u52EZz/QLEWxyA0XZFuA9+OVUfSTwyzWCw0o3a0Jx9BYTrKp2AZiEi9qGSs6OFhZkPboRDXesZKpbcd3UOjV8dMgNNQhr1pJh0Qy5petVIQ48Zq1KefMj7zIhluf3pQeBs5JfUuJMGcgHFRik16gP1mzHX2EmroaYhmVysETLOo54aSGU/gHzbEwdRvCMXuGhUczHj3HkZ42Rk9LYIDS07c8YRuqSBg91Pmnwo8VghFR2Y9oKTmxziSwi0HTN2I1cMvT3E7Fezk/Pae1UnYyUwqdRnqCNZPoXSJSk6hxGWmRBKqBSMqyTP97/wmaJcQCGpqbG5Iw6vhEtHpEVWihepULpFG3rqG0rOha2qTxJIC0YOSYFjrxEtP8nlSlIxvu7PLcRKmS76mk04Sq0HoTqJ04CcfcK+DDIU34mhCX/dByaAiDy58ibicVeRdNJrNyezI2G/ESlUKsZDxiOtLJk/ChXCc9Imp+1nO2xL6QZIkkWiizM7SHIF9q9K8ZpQDx8zOjgWaMzORvdrSGPJ2sEzRYZer9O2gmWD4zSTr6sSuH8Uc/IGjmyLIMOHUV0G48840967ixy2v6zIhcU+pr3bDj9u0bc1xfqUbO9sUuH3O/iqEbFPqaPbOBZuFTO57rx7mxvnDL7avRFLah/ei55LZCpKddjqz4OxhyH6YRLuzA0rcfY5yC8rQTcb08JdLYleZW8TZ0lGgSCyVfQoQtRDiPV6BqKLryzL7kqRmkuoGdE5UzlKWy39mJQlU1OChf1KrEHOYcsdMhvaO3j5JN+zZBXJZ2Kmq0WRSMDSFJGqmtC0q8eZesmfWxPxNNca3DC3KzYsg7MBBXhJ2yHmvy5sojNXVBmQvfhUdoxJ0NgiENWTzfqwd3SOjC927ceNvGjbfTUTNp13eIumhvAKEvJA/HTUW6Maj1CeJAUtBFrcOI1xugSWxubV1qqaRJ1gZvqiHLbKqwOo5TR9hELw7/iBsjL/t6WXl+SWN9VOO5RfnTtJcwreTFY35bWthGB+bMB+yOcGEDg4bztxbkUR0wh1h2kJWgV0awMR+Hjvn5mlrmu9BMCMpYsZynmQC8KR2xco4maZIg5jN5CU86ViJ/s27nzqlxgFc6167fuXP92s5XYOdDO8j4pYNYw16IjR8eH79U0ra3Y6V9uyat20l2P7AbsKpjJ81Tzs39nt9PXgqYeL9LNB+Yi9uMN1BEZ0knnvijDiZLEDg6dJ30NuA9oQEVh9U0uk/kgO8A+R94pvWy8YveWn0ZWbfmLepJXdqz5Z5B94qhu7d2k75r7l0Lx2gVtvTMr6FXgDY7p56d6qSNS+/e0ke6r//CQ1/YXiTdW++u+FK/529HfC3klvzNhK3Te4txIUFlkuQ8tIjguXrUG6WAPWgMsIcDF664d3v3DHXwhQ07YMul2I9QDvtQXz+bokoej3uUo5mt1Qi7f/m58pGoIAyavsnnFiUl8cbhKTpRmI+CKw9Y1oKc5GvZZJCT6kWJcCHNzzDS3KTQKEocr/6Fe1GoUf+1rq/QG/W/hs9goz8E649Xc5M6HxXjAnDV9OT9spBFuwOC26Prv2bzQ3RhCHfwaYpW8+LxqOzlYOZR7/Kf/RbmXMktCzAr3jWP/Kqt5KUqZDq4uTqyBbYGfL17HcuL19KcjykyePSoAP2bNgILH1qOXXFwA9l471P3bOIvOwRXL8j+k0OjB6cPjrLCfe2sXP/824QcsAMZlOmGWiMo0rwb4K1qo+mH/LkBVlXdA+cFXFFWvz0//AXvbZ6+ac3GoyzHHvXfzCqvNILfLi9qV7KBJ/03OPbql/A+XlcDa3g9C1/rnPPU/XzkR4E3q/4p6kHES6V3vVx1M7x3EG4RnpwfhuT9B8mTF4BG6w/vZp7SbtoL4oJBkCuYe2+LL3GT6CtdzGKjNas6FGaHETyqOIeljCSdy4azYTwkLxFIL08OHSKaM+7sonl9vERpGguhHaS5bUgz24xu3ETTPsVKqntkIZfpqR1MdBfQKd6hmiFHviU1QZ260MQ2FSOcbfDmVoyFeHkb9rq/db9KFWsP6uutqz6LgZW6R+JrIjp86Gp6jSXL+7RoUv38yjEracH0NiVpKdu2ISBl27QDRdTKAT9WHoc/IL/p7w4sptcdmtpFR6IcZRnNXDnaT909x7Ykjj6PwmlFdP9FMuWgQvb8nAiKpHB7iS4/r+pk678LRCWOGpq9QwfOlOGlbpDkEPwThngKL7puibAY5LvMl+ZQQ8Yx4mxF/wZjkGJ7a3NjKl5jyjiJ/hAhLzVVExN+9qMpZsAyWImhu/eF2NlfcmS6bxq6lNlO9CZvxpjon/G7R5k1SqVwuFwOv3HTTZn0TTelSQs2wtjpPkNH8D/RH++b3mkosx0KLkzSlfi92qSrzPKX2arMTe692ChjJ7T5I75t3I487EIe5jXKQ6pg6Q83qs/lEn3noSFynmb4aOrBF9sEoBuHhKFYcL11up41emofLCQGE60wVdeDClSvn5qqM41Go7t+iuWUHqzrNrOGWTsFst5TtwLXXPk0Syc9fSX2rsBFmzadY6C/Fge8d+e5uXHkfyiQRc6vwTu2Ylkhz95Fq2/8+YVv/CxSqb7xxyqhDjDBRxFBxcQnSYzeBfrYNqGJjej4TLDfWEywII42hqZ+/BB/6I2DkCn0WS9uv3PD4Z0DpG/3oemDe7u5NS/aMOWtol60t2qCusYTSi19uHn1iHiQOpz2i2v6xx/4xqE9PfyqHQ+N3Ln9RftsmoxADcYAyvMt9Y73lr7wdwTUmb8g/u53GOaw6pPizJC9MJrEj7noG9sG1CNhmWN2BcF2dpRzGBfz5XrojEWZRxuj6aCYY0tiLJOTMmK2uJJQjxj/8hjKEB1iGHCj4JTpxczQzEtehAevG+5pUO12twtCjfG4I979yJB4a7RlZbDdVGV1OMgDQPZQY+ERm1wqiVyYJwJHMrGaP+o9YKbUlE2ApL6YEiyylNT9ESff74qtvCgqNSZcBVOa+2Hr9q9E70rVikGTcxRJ4BSQa6ImzpQIEXk+OFbqhvQRQ4souDWotqAiL2Xqm+AZ/Yz0kXcCOnvfqg1779vzOXtqtvPMii9Ig5+dwj87Kf4bQ6EJfdRt4PyQZYFY0/NXERbE5vPzi+As2njhToFqfp7h6ufXYTFiZ6MCryyG/xQX5qIBFddLfr6b+SYsHc3P1ocikRD5rxCMuNslxeBKuiZjzQpUY6kFvwNgPtyioHRxkEr9fv+HE5AwHFc9q0neOXOa/kiAi9ByQX3et1fZb2+q7yCL914QN5y1GVt/DOVaR29JPCECXV9iGaI84A7sQ9W3Y4dLZe4vVR1Mxd3Hc7rq7lNVOKjqHM9xqmiceVWXNTgoiO6fswpN0R/EfnefyHtnMvcsdw1nzMOJiSzGpQ+SPmclxmVRqlVM0HG5wNFSQYAIRhjE3ZDTsobwJbifVegTxj7sx7mCRwvp5XSWh6/QYs/TwjyMahKsVCYZVaeECMTR56MplPyzCfrSPO/dL0m8RwvpQ1oS56aF7i/58Mpn0eOHaKxcTNGd84cLd4oCvXPu3B+4a8kPUA7rmSzJ7E3Zy7OzuJEm/Mt+7Eh/pyDPMx7xF7luuh/CY9hDe4WZYLqvW+YhFlJiWX1PO0aOB6L0t3AVOUK7V/XSqP8Dx/CavHCY8erwC3jhyKHZR2nu9wXvpz4vKN4dwOIA22sZ/S1RTbhyBxbvF/XeXzEQpfEUTa0hLTTE+RigN9vzQhBp0RzT5OUaKazwlhEU8u0fx8D9XmGdwVmmZmpavDGuichhJJUz1nn5pp9yj5H3GG7DgZtovmnn5YNFiiT/JyIZqw6Uvd+i0TRIFwumFw7SVEg/TYvQDM/8hE9O4uTWEVlECuyU2tLW1oKK3jIk+bItDxy6TZKw36mttdZgKDxo1fIRzrFMSbrt0J/Cl8KVh1OcozuqGUyO7RxLBk3UrA6XfmDTF97qwAErpOl655GnjnTqOidyIQsHO08G/hcLt/j/AAB4nGNgZGBgAOLaW41M8fw2Xxm4mV8ARRguss1QhNC5H/9//Z/FUsEcBORyMDCBRAFTFwxveJxjYGRgYA76n8UQxVLGwPD/FUsFA1AEBfgBAHyYBUh4nGN+wcDAvACCWfSBNIgviMBM1kA6koGBMRWVBqsDYqYmiF4wHQkxg+kUBMPVWEP0gTDYvBdoahZAzYxEY0ciuWUBFjkoZimDYLC8IKpehmsQccYvSGYgYZB7YBhFL5o8cxTQjDUI/wIArpclrwAAAAAAAAA6AIYA3AEKAUgBgAGgAfoCYgKqAwIDOgOGA9wEQAR4BLYFAgU8BZoFzAYMBlIGmga6BtgG+AcYB0QHcAecB8gIAAg2CG4IpgjyCUAJrAo0CtALOAueDAoMYA0ADVANjg3mDiQOjg7GDvgPOA+ED84QPBB2EN4RNhGgEfISchKoEsgS6BMGEz4TXhOSE8QT+BQsFGIUiBTWFX0AAAABAAAATgBuAAYAAAAAAAIAAAAQAHMAAAAiC3AAAAAAeJx1kctOGzEUhn9DoIKgLloJdcdZIRDK5CKhSqyoogJrhLJDwgyeSzpjRx4HlGfgLcoz8Dp9j+76Z2KhqFJmZM93Ph/bxx4AX/AHCqvnnG3FCgeMVryFT/gReZv+JnKHfBd5B108RN6l/xV5H2d4idzFV/zmCqqzx2iK98gK39RR5C18Vt8jb9P/jNwh30fewaGaR96lf428j4l6i9zFsfo7drOFL/MiyMn4VEaD4bk8LsRRlVZXouehcL6RS8mcDaaqXJK6OtSml+lemTrb3Jp8Xmm/rtZ5YnxTOivDZLCur401XgfztNytec5HIWSSeVfLVdxHZt5NTRqSIoTZRb+/vj/GcJhhAY8SOQoECE5oT/kdYYAhf4zgkRnCzFVWCQuNikZjzhlFO9IwvmTLGFlaw4yKnCBlX9PUdD2Oa/Zlay1n3dLmXKei9xuzNvkJ7XLvso2F9SaselP2Na1tZ+i2wqePszV4ZhUj2sBZy1P4tmrB1X/nEd7XcmxKk9In7a0F2gv0+W44/z/KQo7lAHicbZLnlpswEIW5Bgy4bLLpvfeE9N57z76DLARWEJKOEEucpw8CO/kTncOdT6PhnlHxRt4wJt7/x47nYQQfAUKMESFGggmmmGGOLezBXmxjH/bjAA7iEA7jCI7iGI7jBE7iFE7jDM7iHM7jAi7iEi7jCq7iGq7jBlLcxC3cxh3cxT3cxwM8xCM8xhM8xTM8xwu8xCu8xhu8xTu8xwd8xCd8xhd8xTd8xw/sBLUlZuIkZZW2q0hzahvDRqocUyIpE4EWTR1WXDZ1sGRCz5yklBsqWBZwmauZk01mTqxl0nIlUyLs9r/Zej35m4kFl2XKftlAKFomTlKlmfQ1l74lRdB9dbxQqqyIKbc2MPQZGqbFKsqVaYnJ4ky1Ms24iQXLrYPE8GLZ07jRfaIvcf5JX+NoMhQ5jLoqFwenBS8Gpw7WTh05py6MaOtT2ibEGNXWKW1Da0i9nPY6dNe7CEWy7pc+5EJpvfJVnvtUFUHFZBPWS2LYxKqiECztVpINypAuGS2nvQ6Gs+H0hsk0U3ZznDETguua1/MNpLvMWH/RFGEuuobCihScxqS2zPC6jH4rVaVcxn1UjQ1yJW1QK2MTJ6nrPOqp0d3Vk1WoSVOz7p0oHeWdTbpoh5i3sVWpezp23AGTWch+Mmonu0o0Vb+l6RqdabLmRnveH9ru7j54nGPw3sFwIihiIyNjX+QGxp0cDBwMyQUbGVidNjIwaEFoDhR6JwMDAycyi5nBZaMKY0dgxAaHjoiNzCkuG9VAvF0cDQyMLA4dySERICWRQLCRgUdrB+P/1g0svRuZGFwAB9MiuAAAAA==) format('woff')}</style>
<style id="style-core" type="text/css">html{font:16px/1 Helmet,Freesans,sans-serif}#store-area,tw-storydata{display:none!important;z-index:0}.no-transition{-o-transition:none!important;transition:none!important}:focus{outline:thin dotted}:disabled{cursor:not-allowed!important}body{color:#eee;background-color:#111}a{cursor:pointer;color:#68d;text-decoration:none;-o-transition-duration:.2s;transition-duration:.2s}a:hover{color:#8af;text-decoration:underline}a.link-broken{color:#c22}a.link-broken:hover{color:#e44}a[disabled],span.link-disabled{color:#aaa;cursor:not-allowed!important;text-decoration:none}area{cursor:pointer}button{cursor:pointer;color:#eee;background-color:#35a;border:1px solid #57c;line-height:normal;padding:.4em;-o-transition-duration:.2s;transition-duration:.2s;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}button:hover{background-color:#57c;border-color:#79e}button:disabled{background-color:#444;border:1px solid #666}input,select,textarea{color:#eee;background-color:transparent;border:1px solid #444;padding:.4em}select{padding:.34em .4em}input[type=text]{min-width:18em}textarea{min-width:30em;resize:vertical}input[type=checkbox],input[type=file],input[type=radio],select{cursor:pointer}input[type=range]{-webkit-appearance:none;min-height:1.2em}input[type=range]:focus{outline:0}input[type=range]::-webkit-slider-runnable-track{background:#222;border:1px solid #444;border-radius:0;cursor:pointer;height:10px;width:100%}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;background:#35a;border:1px solid #57c;border-radius:0;cursor:pointer;height:18px;margin-top:-5px;width:33px}input[type=range]:focus::-webkit-slider-runnable-track{background:#222}input[type=range]::-moz-range-track{background:#222;border:1px solid #444;border-radius:0;cursor:pointer;height:10px;width:100%}input[type=range]::-moz-range-thumb{background:#35a;border:1px solid #57c;border-radius:0;cursor:pointer;height:18px;width:33px}input[type=range]::-ms-track{background:0 0;border-color:transparent;color:transparent;cursor:pointer;height:10px;width:calc(100% - 1px)}input[type=range]::-ms-fill-lower{background:#222;border:1px solid #444;border-radius:0}input[type=range]::-ms-fill-upper{background:#222;border:1px solid #444;border-radius:0}input[type=range]::-ms-thumb{background:#35a;border:1px solid #57c;border-radius:0;cursor:pointer;height:16px;width:33px}input:not(:disabled):focus,input:not(:disabled):hover,select:not(:disabled):focus,select:not(:disabled):hover,textarea:not(:disabled):focus,textarea:not(:disabled):hover{background-color:#333;border-color:#eee}hr{display:block;height:1px;border:none;border-top:1px solid #eee;margin:1em 0;padding:0}audio,canvas,progress,video{max-width:100%;vertical-align:middle}.error-view{background-color:#511;border-left:.5em solid #c22;display:inline-block;margin:.1em;max-width:100%;padding:0 .25em;position:relative}.error-view>.error-toggle{background-color:transparent;border:none;line-height:inherit;left:0;padding:0;position:absolute;top:0;width:1.75em}.error-view>.error{display:inline-block;margin-left:.25em}.error-view>.error-toggle+.error{margin-left:1.5em}.error-view>.error-source[hidden]{display:none}.error-view>.error-source:not([hidden]){background-color:rgba(0,0,0,.2);display:block;margin:0 0 .25em;overflow-x:auto;padding:.25em}.highlight,.marked{color:#ff0;font-weight:700;font-style:italic}.nobr{white-space:nowrap}.error-view>.error-toggle:before,.error-view>.error:before,[data-icon-after]:after,[data-icon-before]:before,[data-icon]:before,a.link-external:after{font-family:tme-fa-icons;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;speak:none}[data-icon]:before{content:attr(data-icon)}[data-icon-before]:before{content:attr(data-icon-before) "\00a0"}[data-icon-after]:after{content:"\00a0" attr(data-icon-after)}.error-view>.error-toggle:before{content:"\e81a"}.error-view>.error-toggle.enabled:before{content:"\e818"}.error-view>.error:before{content:"\e80d\00a0\00a0"}a.link-external:after{content:"\00a0\e80e"}</style>
<style id="style-core-display" type="text/css">#story{z-index:10;margin:2.5em}@media screen and (max-width:1136px){#story{margin-right:1.5em}}#passages{max-width:54em;margin:0 auto}</style>
<style id="style-core-passage" type="text/css">.passage{line-height:1.75;text-align:left;-o-transition:opacity .4s ease-in;transition:opacity .4s ease-in}.passage-in{opacity:0}.passage ol,.passage ul{margin-left:.5em;padding-left:1.5em}.passage table{margin:1em 0;border-collapse:collapse;font-size:100%}.passage caption,.passage td,.passage th,.passage tr{padding:3px}</style>
<style id="style-core-macro" type="text/css">.macro-append-insert,.macro-linkappend-insert,.macro-linkprepend-insert,.macro-linkreplace-insert,.macro-prepend-insert,.macro-repeat-insert,.macro-replace-insert,.macro-timed-insert{-o-transition:opacity .4s ease-in;transition:opacity .4s ease-in}.macro-append-in,.macro-linkappend-in,.macro-linkprepend-in,.macro-linkreplace-in,.macro-prepend-in,.macro-repeat-in,.macro-replace-in,.macro-timed-in{opacity:0}</style>
<style id="style-ui-dialog" type="text/css">html[data-dialog] body{overflow:hidden}#ui-overlay.open{visibility:visible;-o-transition:opacity .2s ease-in;transition:opacity .2s ease-in}#ui-overlay:not(.open){-o-transition:visibility .2s step-end,opacity .2s ease-in;transition:visibility .2s step-end,opacity .2s ease-in}#ui-overlay{visibility:hidden;opacity:0;z-index:100000;position:fixed;top:-50%;left:-50%;height:200%;width:200%}#ui-dialog.open{display:block;-o-transition:opacity .2s ease-in;transition:opacity .2s ease-in}#ui-dialog{display:none;opacity:0;z-index:100100;position:fixed;top:50px;margin:0;padding:0}#ui-dialog>*{box-sizing:border-box}#ui-dialog-titlebar{position:relative}#ui-dialog-close{display:block;position:absolute;right:0;top:0;white-space:nowrap}#ui-dialog-body{overflow:auto;min-width:280px;height:92%;height:calc(100% - 2.1em)}#ui-overlay{background-color:#000}#ui-overlay.open{opacity:.8}#ui-dialog{max-width:66em}#ui-dialog.open{opacity:1}#ui-dialog-titlebar{background-color:#444;min-height:24px}#ui-dialog-title{margin:0;padding:.2em 3.5em .2em .5em;font-size:1.5em;text-align:center;text-transform:uppercase}#ui-dialog-close{cursor:pointer;font-size:120%;margin:0;padding:0;width:3.6em;height:92%;background-color:transparent;border:1px solid transparent;-o-transition-duration:.2s;transition-duration:.2s}#ui-dialog-close:hover{background-color:#b44;border-color:#d66}#ui-dialog-body{background-color:#111;border:1px solid #444;text-align:left;line-height:1.5;padding:1em}#ui-dialog-body>:first-child{margin-top:0}#ui-dialog-body hr{background-color:#444}#ui-dialog-body ul.buttons{margin:0;padding:0;list-style:none}#ui-dialog-body ul.buttons li{display:inline-block;margin:0;padding:.4em .4em 0 0}#ui-dialog-body ul.buttons>li+li>button{margin-left:1em}#ui-dialog-close{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#ui-dialog-close{font-family:tme-fa-icons;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;speak:none}</style>
<style id="style-ui" type="text/css">#ui-dialog-body.settings [id|=setting-body]>div:first-child{display:table;width:100%}#ui-dialog-body.settings [id|=setting-label]{display:table-cell;padding:.4em 2em .4em 0}#ui-dialog-body.settings [id|=setting-label]+div{display:table-cell;min-width:8em;text-align:right;vertical-align:middle;white-space:nowrap}#ui-dialog-body.list{padding:0}#ui-dialog-body.list ul{margin:0;padding:0;list-style:none;border:1px solid transparent}#ui-dialog-body.list li{margin:0}#ui-dialog-body.list li:not(:first-child){border-top:1px solid #444}#ui-dialog-body.list li a{display:block;padding:.25em .75em;border:1px solid transparent;color:#eee;text-decoration:none}#ui-dialog-body.list li a:hover{background-color:#333;border-color:#eee}#ui-dialog-body.saves{padding:0 0 1px}#ui-dialog-body.saves>:not(:first-child){border-top:1px solid #444}#ui-dialog-body.saves table{border-spacing:0;width:100%}#ui-dialog-body.saves tr:not(:first-child){border-top:1px solid #444}#ui-dialog-body.saves td{padding:.33em .33em}#ui-dialog-body.saves td:first-child{min-width:1.5em;text-align:center}#ui-dialog-body.saves td:nth-child(3){line-height:1.2}#ui-dialog-body.saves td:last-child{text-align:right}#ui-dialog-body.saves .empty{color:#999;speak:none;text-align:center;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#ui-dialog-body.saves .datestamp{font-size:75%;margin-left:1em}#ui-dialog-body.saves ul.buttons li{padding:.4em}#ui-dialog-body.saves ul.buttons>li+li>button{margin-left:.2em}#ui-dialog-body.saves ul.buttons li:last-child{float:right}#ui-dialog-body.settings div[id|=header-body]{margin:1em 0}#ui-dialog-body.settings div[id|=header-body]:first-child{margin-top:0}#ui-dialog-body.settings div[id|=header-body]:not(:first-child){border-top:1px solid #444;padding-top:1em}#ui-dialog-body.settings div[id|=header-body]>*{margin:0}#ui-dialog-body.settings h2[id|=header-heading]{font-size:1.375em}#ui-dialog-body.settings p[id|=header-desc],#ui-dialog-body.settings p[id|=setting-desc]{font-size:87.5%;margin:0 0 0 .5em}#ui-dialog-body.settings div[id|=setting-body]+div[id|=setting-body]{margin:1em 0}#ui-dialog-body.settings [id|=setting-control]{white-space:nowrap}#ui-dialog-body.settings button[id|=setting-control]{color:#eee;background-color:transparent;border:1px solid #444;padding:.4em}#ui-dialog-body.settings button[id|=setting-control]:hover{background-color:#333;border-color:#eee}#ui-dialog-body.settings button[id|=setting-control].enabled{background-color:#282;border-color:#4a4}#ui-dialog-body.settings button[id|=setting-control].enabled:hover{background-color:#4a4;border-color:#6c6}#ui-dialog-body.settings input[type=range][id|=setting-control]{max-width:35vw}#ui-dialog-body.list a,#ui-dialog-body.settings span[id|=setting-input]{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#ui-dialog-body.saves button[id=saves-clear]:before,#ui-dialog-body.saves button[id=saves-export]:before,#ui-dialog-body.saves button[id=saves-import]:before,#ui-dialog-body.settings button[id|=setting-control].enabled:after,#ui-dialog-body.settings button[id|=setting-control]:after{font-family:tme-fa-icons;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;speak:none}#ui-dialog-body.saves button[id=saves-export]:before{content:"\e829\00a0"}#ui-dialog-body.saves button[id=saves-import]:before{content:"\e82a\00a0"}#ui-dialog-body.saves button[id=saves-clear]:before{content:"\e827\00a0"}#ui-dialog-body.settings button[id|=setting-control]:after{content:"\00a0\00a0\e830"}#ui-dialog-body.settings button[id|=setting-control].enabled:after{content:"\00a0\00a0\e831"}</style>
<style id="style-ui-bar" type="text/css">#story{margin-left:20em;-o-transition:margin-left .2s ease-in;transition:margin-left .2s ease-in}#ui-bar.stowed~#story{margin-left:4.5em}@media screen and (max-width:1136px){#story{margin-left:19em}#ui-bar.stowed~#story{margin-left:3.5em}}@media screen and (max-width:768px){#story{margin-left:3.5em}}#ui-bar{position:fixed;z-index:50;top:0;left:0;width:17.5em;height:100%;margin:0;padding:0;-o-transition:left .2s ease-in;transition:left .2s ease-in}#ui-bar.stowed{left:-15.5em}#ui-bar-body{height:90%;height:calc(100% - 2.5em);margin:2.5em 0;padding:0 1.5em}#ui-bar.stowed #ui-bar-body,#ui-bar.stowed #ui-bar-history{visibility:hidden;-o-transition:visibility .2s step-end;transition:visibility .2s step-end}#ui-bar{background-color:#222;border-right:1px solid #444;text-align:center}#ui-bar-tray{position:absolute;top:.2em;left:0;right:0}#ui-bar a{text-decoration:none}#ui-bar hr{border-color:#444}#ui-bar-history [id|=history],#ui-bar-toggle{font-size:1.2em;line-height:inherit;color:#eee;background-color:transparent;border:1px solid #444}#ui-bar-toggle{display:block;position:absolute;top:0;right:0;border-right:none;padding:.3em .45em .25em}#ui-bar.stowed #ui-bar-toggle{padding:.3em .35em .25em .55em}#ui-bar-toggle:hover{background-color:#444;border-color:#eee}#ui-bar-history{margin:0 auto}#ui-bar-history [id|=history]{padding:.2em .45em .35em}#ui-bar-history #history-jumpto{padding:.2em .665em .35em}#ui-bar-history [id|=history]:not(:first-child){margin-left:1.2em}#ui-bar-history [id|=history]:hover{background-color:#444;border-color:#eee}#ui-bar-history [id|=history]:disabled{color:#444;background-color:transparent;border-color:#444}#ui-bar-body{line-height:1.5;overflow:auto}#ui-bar-body>:not(:first-child){margin-top:2em}#story-title{margin:0;font-size:162.5%}#story-author{margin-top:2em;font-weight:700}#menu ul{margin:1em 0 0;padding:0;list-style:none;border:1px solid #444}#menu ul:empty{display:none}#menu li{margin:0}#menu li:not(:first-child){border-top:1px solid #444}#menu li a{display:block;padding:.25em .75em;border:1px solid transparent;color:#eee;text-transform:uppercase}#menu li a:hover{background-color:#444;border-color:#eee}#menu a,#ui-bar-history [id|=history],#ui-bar-toggle{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#menu-core li[id|=menu-item] a:before,#ui-bar-history [id|=history],#ui-bar-toggle:before{font-family:tme-fa-icons;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;speak:none}#ui-bar-toggle:before{content:"\e81d"}#ui-bar.stowed #ui-bar-toggle:before{content:"\e81e"}#menu-item-saves a:before{content:"\e82b\00a0"}#menu-item-settings a:before{content:"\e82d\00a0"}#menu-item-restart a:before{content:"\e82c\00a0"}#menu-item-share a:before{content:"\e82f\00a0"}</style>
<style id="style-ui-debug" type="text/css">#debug-bar{background-color:#222;border-left:1px solid #444;border-top:1px solid #444;bottom:0;margin:0;max-height:75%;padding:.5em;position:fixed;right:0;z-index:99900}#debug-bar>div:not([id])+div{margin-top:.5em}#debug-bar>div>label{margin-right:.5em}#debug-bar>div>input[type=text]{min-width:0;width:8em}#debug-bar>div>select{width:15em}#debug-bar-toggle{color:#eee;background-color:#222;border:1px solid #444;height:101%;height:calc(100% + 1px);left:-2em;left:calc(-2em - 1px);position:absolute;top:-1px;width:2em}#debug-bar-toggle:hover{background-color:#333;border-color:#eee}#debug-bar-hint{bottom:.175em;font-size:4.5em;opacity:.33;pointer-events:none;position:fixed;right:.6em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;white-space:nowrap}#debug-bar-watch{background-color:#222;border-left:1px solid #444;border-top:1px solid #444;bottom:102%;bottom:calc(100% + 1px);font-size:.9em;left:-1px;max-height:650%;max-height:65vh;position:absolute;overflow-x:hidden;overflow-y:scroll;right:0;z-index:99800}#debug-bar-watch[hidden]{display:none}#debug-bar-watch div{color:#999;font-style:italic;margin:1em auto;text-align:center}#debug-bar-watch table{width:100%}#debug-bar-watch tr:nth-child(2n){background-color:rgba(127,127,127,.15)}#debug-bar-watch td{padding:.2em 0}#debug-bar-watch td:first-child+td{padding:.2em .3em .2em .1em}#debug-bar-watch .watch-delete{background-color:transparent;border:none;color:#c00}#debug-bar-watch-all,#debug-bar-watch-none{margin-left:.5em}#debug-bar-views-toggle,#debug-bar-watch-toggle{color:#eee;background-color:transparent;border:1px solid #444;margin-right:1em;padding:.4em}#debug-bar-views-toggle:hover,#debug-bar-watch-toggle:hover{background-color:#333;border-color:#eee}#debug-bar-watch:not([hidden])~div #debug-bar-watch-toggle,html[data-debug-view] #debug-bar-views-toggle{background-color:#282;border-color:#4a4}#debug-bar-watch:not([hidden])~div #debug-bar-watch-toggle:hover,html[data-debug-view] #debug-bar-views-toggle:hover{background-color:#4a4;border-color:#6c6}#debug-bar-hint:after,#debug-bar-toggle:before,#debug-bar-views-toggle:after,#debug-bar-watch .watch-delete:before,#debug-bar-watch-add:before,#debug-bar-watch-all:before,#debug-bar-watch-none:before,#debug-bar-watch-toggle:after{font-family:tme-fa-icons;font-style:normal;font-weight:400;font-variant:normal;text-transform:none;line-height:1;speak:none}#debug-bar-toggle:before{content:"\e838"}#debug-bar-hint:after{content:"\e838\202f\e822"}#debug-bar-watch .watch-delete:before{content:"\e804"}#debug-bar-watch-add:before{content:"\e805"}#debug-bar-watch-all:before{content:"\e83a"}#debug-bar-watch-none:before{content:"\e827"}#debug-bar-views-toggle:after,#debug-bar-watch-toggle:after{content:"\00a0\00a0\e830"}#debug-bar-watch:not([hidden])~div #debug-bar-watch-toggle:after,html[data-debug-view] #debug-bar-views-toggle:after{content:"\00a0\00a0\e831"}html[data-debug-view] .debug{padding:.25em;background-color:#234}html[data-debug-view] .debug[title]{cursor:help}html[data-debug-view] .debug.block{display:inline-block;vertical-align:middle}html[data-debug-view] .debug.invalid{text-decoration:line-through}html[data-debug-view] .debug.hidden,html[data-debug-view] .debug.hidden .debug{background-color:#555}html:not([data-debug-view]) .debug.hidden{display:none}html[data-debug-view] .debug[data-name][data-type].nonvoid:after,html[data-debug-view] .debug[data-name][data-type]:before{background-color:rgba(0,0,0,.25);font-family:monospace,monospace;white-space:pre}html[data-debug-view] .debug[data-name][data-type]:before{content:attr(data-name)}html[data-debug-view] .debug[data-name][data-type|=macro]:before{content:"<<" attr(data-name) ">>"}html[data-debug-view] .debug[data-name][data-type|=macro].nonvoid:after{content:"<</" attr(data-name) ">>"}html[data-debug-view] .debug[data-name][data-type|=html]:before{content:"<" attr(data-name) ">"}html[data-debug-view] .debug[data-name][data-type|=html].nonvoid:after{content:"</" attr(data-name) ">"}html[data-debug-view] .debug[data-name][data-type]:not(:empty):before{margin-right:.25em}html[data-debug-view] .debug[data-name][data-type].nonvoid:not(:empty):after{margin-left:.25em}html[data-debug-view] .debug[data-name][data-type|=special],html[data-debug-view] .debug[data-name][data-type|=special]:before{display:block}</style>
</head>
<body>
	<div id="init-screen">
		<div id="init-no-js"><noscript>JavaScript is required. Please enable it to continue.</noscript></div>
		<div id="init-lacking">Your browser lacks required capabilities. Please upgrade it or switch to another to continue.</div>
		<div id="init-loading"><div>Loading&hellip;</div></div>
	</div>
	<tw-storydata name="Unholy Arts v0.3" startnode="98" creator="Twine" creator-version="2.3.5" ifid="58DD54D0-A420-4F6E-A934-8062427989DC" zoom="0.6" format="SugarCube" format-version="2.30.0" options="" hidden><style role="stylesheet" id="twine-user-stylesheet" type="text/twine-css">

/* Styling and Colours of the Right UI Bar. */
#right-ui-bar {
	background-color: #222;
	border-right: 1px solid #444;
	text-align: center;
}
#right-ui-bar-toggle {
	font-size: 1.2em;
	line-height: inherit;
	color: #eee;
	background-color: transparent;
	border: 1px solid #444;
}
#right-ui-bar-toggle:before {
	font-family: tme-fa-icons;
	font-style: normal;
	font-weight: 400;
	font-variant: normal;
	text-transform: none;
	line-height: 1;
	speak: none;
}

/* Layout and Positioning of the Right UI Bar. */
#right-ui-bar {
	position: fixed;
	z-index: 50;
	top: 0;
	right: 0;
	width: 17.5em;
	height: 100%;
	margin: 0;
	padding: 0;
	-webkit-transition: right .2s ease-in;
	-o-transition: right .2s ease-in;
	transition: right .2s ease-in;
}
#right-ui-bar-tray {
	position: absolute;
	top: .2em;
	left: 0;
	right: 0;
}
#right-ui-bar-toggle {
	display: block;
	position: absolute;
	top: 0;
	left: 0;
	border-left: none;
	padding: .3em .45em .25em;
	-webkit-user-select: none;
}
#right-ui-bar-toggle:before {
	content: "\e81e";
}
#right-ui-bar-body {
	height: 90%;
	height: calc(100% - 2.5em);
	margin: 2.5em 0;
	padding: 0 1.5em;
}
#right-ui-bar-body {
	line-height: 1.5;
	overflow: auto;
}

#story {
	margin-right: 20em;
}

/* Stowing of the Right UI Bar. */
#right-ui-bar.stowed {
	right: -15.5em;
}
#right-ui-bar.stowed #right-ui-bar-toggle {
	padding: .3em .55em .25em .35em;
}
#right-ui-bar.stowed #right-ui-bar-toggle:before {
	content: "\e81d";
}
#right-ui-bar.stowed #right-ui-bar-body {
	visibility: hidden;
	-webkit-transition: visibility .2s step-end;
	-o-transition: visibility .2s step-end;
	transition: visibility .2s step-end;
}

#right-ui-bar.stowed~#story {
	margin-right: 4.5em;
}


/* Others */

p.clear {
	clear: both
}

.standardBox {
  border: 2px solid white;
  padding: 4px;
  width:auto;
  overflow:hidden;
}

.portraitBox {
  width:350px;
  float:right;
}

// Background

body  {
  background-image: url("img/background/background.png");
  background-size: cover;
}

// Character Status Screen

.split {
  height: 100%;
  width: 50%;
  position: fixed;
  z-index: 1;
  top: 0;
  overflow-x: hidden;
  padding-top: 20px;
}

.left {
  left: 0;
}

.right {
  right: 0;
}

.centered {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  // text-align: center;
}

// Overlapping images tests
#mapDiagram {
  position: absolute;
}
#mapImage {
  position: relative;
  top: 0;
  left: 0;
  z-index:0;
}
#mapCursor {
  position: absolute;
  z-index:3;
  border: 2px khaki solid;
}</style><script role="script" id="twine-user-script" type="text/twine-javascript">////////////// Minimum log tools

State.variables.log = [];
State.variables.logL1 = [];
State.variables.logL2 = [];

// CONFIG //

Config.saves.autoload = false;
Config.saves.autosave = false;
Config.loadDelay = 50;
Config.history.maxStates = 1;

// State.variables.StVarsList = []; // Ex.: isStVarOn("dldPly") // removeFromStVarsList("dldPly"); addToStVarsList("dldPly");
// monActUs
// go0
// chTts
	// First adventure
		// Map scenes
// *** alwSct -> Allowed into sanctum
// *** blmClaw -> Blackmailed by Claw - Map Story Event triggered
// *** dldCrf -> Crafting dildo
// *** dldPly -> Dildo Play
// *** mphInit -> Morph Init
// *** mphFsTf -> Morph First Transformation
  // Special experiences
// VarDom -> Varyonte's domination

////////// GAME SETTINGS CLASS //////////

setup.versionName = "Unholy Arts v0.3.6";

setup.infamySecondThreshold = 1.2;
setup.infamyThirdThreshold = 1.4;

// Default settings, useful for retro save compatibility
setup.defaultMfscaOption = "enable";

window.Settings = function() { 
	this.debugFunctions = true;
	
	this.stdSxScDur = 30; // Standard Sex Scene Duration
	this.infamyLimit = 25;
	this.relationshipsDuration = 3;
	this.equipmentDuration = 5;
	this.followingAllowed = false;
	this.relationshipTypesAllowed = false;
	this.challengingAllowed = false;
	this.assaultingAllowed = false;
	this.talkingAllowed = true;

	this.autosaving = "enable"; // "enable" / "disable"

	this.difficulty = "normal"; // "easy" / "normal" / "hard"
	
	this.futa = "enableAll"; // "enableAll" / "playerFuta" / "futaPartners" / "disableMainStory" / "disableAll"
	
	this.sexPrefs = "noChanges"; // "noChanges" / "usePussy" / "useDick"
	
	this.npcBonus = "none"; // "none" / "bondage" / "hypnosis" / "draining" / "all"
	
	this.lewdMales = "enable"; // "enable" / "disable"
	this.lewdMonsters = "enable"; // "enable" / "disable"
	
	this.anal = "enable"; // "enable" / "disable"
	
	this.pain = "enable"; // "enable" / "disable"
	
	this.mfsca = "enable"; // "enable" / "disable"
	
	this.battleDefeatSex = "enable"; // "enable" / "disable"
	
	this.servitudeRelationships = "enable"; // "enable" / "disable"
	
	this.stealingServitudeAllowed = "disable"; // "enable" / "disable"
	
	this.chastity = "enable"; // "enable" / "disable"
	
	// Settings formatting
	this.autosavingChoices = "";
	
	this.difficultyChoices = 'Difficulty:\n' + '<label><<radiobutton "$settings.difficulty" "easy">> Easy</label>\n'
						   + '<label><<radiobutton "$settings.difficulty" "normal" checked>> Normal</label>\n'
						   + '<label><<radiobutton "$settings.difficulty" "hard">> Hard</label>';
	
	this.futaChoices = "";
	
	this.sexPrefChoices = "";
	
	this.npcBonusChoices = "";
	
	this.analChoices = "";
	
	this.painChoices = "";
	
	this.battleDefeatSexChoices = "";
	
	this.servitudeRelationshipsChoices = "";
	
	this.stealingServitudeChoices = "";
						   
	this.allChoices = "";
	
	// Exit button
	Settings.prototype.exitPassage = "Disclaimer";
	Settings.prototype.exitButton = "<<l" + "ink [[Save settings and leave|" + this.exitPassage + "]]>><<s" + "cript>>\n"
					+ "cleanAllSettingsChoices();\n"
					+ "<</s" + "cript>><</l" + "ink>>";
};

// Methods
Settings.prototype.formatDifficultyChoices = function() {
		this.difficultyChoices = '__Difficulty__' + getDifficultyTooltip() + ':\n' + '<label><<radiobutton "$settings.difficulty" "easy"';
		if ( this.difficulty == "easy" ) { this.difficultyChoices += " checked"; }
		this.difficultyChoices += '>> Easy</label>\n'
						   + '<label><<radiobutton "$settings.difficulty" "normal"';
		if ( this.difficulty == "normal" ) { this.difficultyChoices += " checked"; }				   
		this.difficultyChoices += '>> Normal</label>\n'
						   + '<label><<radiobutton "$settings.difficulty" "hard"';
		if ( this.difficulty == "hard" ) { this.difficultyChoices += " checked"; }	
		this.difficultyChoices += '>> Hard</label>';
	}
	Settings.prototype.formatFutaChoices = function() {
		this.futaChoices = '__Futanari__' + getFutanariTooltip() + ':\n';
		this.futaChoices += '<label><<radiobutton "$settings.futa" "enableAll"';
		if ( this.futa == 'enableAll' ) { this.futaChoices += " checked"; }
		this.futaChoices += '>> Enable all content</label> ' + colorText("(Canon)","green") + '\n'
						  + '<label><<radiobutton "$settings.futa" "playerFuta"';
		if ( this.futa == 'playerFuta' ) { this.futaChoices += " checked"; }
		this.futaChoices += '>> Only futa player, no futa peers</label>\n'
						  + '<label><<radiobutton "$settings.futa" "futaPartners"';
		if ( this.futa == 'futaPartners' ) { this.futaChoices += " checked"; }
		this.futaChoices += '>> Futa peers, but no futa player</label>\n'
						  + '<label><<radiobutton "$settings.futa" "disableMainStory"';
		if ( this.futa == 'disableMainStory' ) { this.futaChoices += " checked"; }
		this.futaChoices += '>> Disable main story content</label>\n'
						  + '<label><<radiobutton "$settings.futa" "disableAll"';
		if ( this.futa == 'disableAll' ) { this.futaChoices += " checked"; }
		this.futaChoices += '>> Disable all content</label>';		
	}
	Settings.prototype.formatSexPrefChoices = function() { // noChanges usePussy useDick
		this.sexPrefChoices = '__Sex preferences__' + getTastesConfigTooltip() + ':\n';
		this.sexPrefChoices += '<label><<radiobutton "$settings.sexPrefs" "noChanges"';
		if ( this.sexPrefs == 'noChanges' ) { this.sexPrefChoices += " checked"; }
		this.sexPrefChoices += '>> No changes</label> ' + colorText("(Default)","green") + '\n'
						  + '<label><<radiobutton "$settings.sexPrefs" "usePussy"';
		if ( this.sexPrefs == 'usePussy' ) { this.sexPrefChoices += " checked"; }
		this.sexPrefChoices += '>> Use pussy</label>\n'
						  + '<label><<radiobutton "$settings.sexPrefs" "useDick"';
		if ( this.sexPrefs == 'useDick' ) { this.sexPrefChoices += " checked"; }
		this.sexPrefChoices += '>> Use dick</label>';		
	}
	
	Settings.prototype.formatNpcBonusesChoices = function() { // "none" / "bondage" / "hypnosis" / "draining" / "all"
		this.npcBonusChoices = '__NPC Candidates bonuses__' + getNPCsBonusesTooltip() + ':\n';
		this.npcBonusChoices += '<label><<radiobutton "$settings.npcBonus" "none"';
		if ( this.npcBonus == 'none' ) { this.npcBonusChoices += " checked"; }
		this.npcBonusChoices += '>> None</label>\n'
						  + '<label><<radiobutton "$settings.npcBonus" "bondage"';
		if ( this.npcBonus == 'bondage' ) { this.npcBonusChoices += " checked"; }
		this.npcBonusChoices += '>> Bondage</label>\n'
						  + '<label><<radiobutton "$settings.npcBonus" "hypnosis"';
		if ( this.npcBonus == 'hypnosis' ) { this.npcBonusChoices += " checked"; }
		this.npcBonusChoices += '>> Hypnosis</label>\n'
						  + '<label><<radiobutton "$settings.npcBonus" "draining"';
		if ( this.npcBonus == 'draining' ) { this.npcBonusChoices += " checked"; }
		this.npcBonusChoices += '>> Draining</label>\n'
						  + '<label><<radiobutton "$settings.npcBonus" "all"';
		if ( this.npcBonus == 'all' ) { this.npcBonusChoices += " checked"; }
		this.npcBonusChoices += '>> All</label>';		
	}
	
	Settings.prototype.formatAnalChoices = function() {
		this.analChoices = '__Anal__' + getAnalTooltip() + ':\n';
		this.analChoices += '<label><<radiobutton "$settings.anal" "enable"';
		if ( this.anal == 'enable' ) { this.analChoices += " checked"; }
		this.analChoices += '>> Enable</label>\n'
						  + '<label><<radiobutton "$settings.anal" "disable"';
		if ( this.anal == 'disable' ) { this.analChoices += " checked"; }
		this.analChoices += '>> Disable</label>';	
	}
	
	Settings.prototype.formatMFSCAchoices = function() {
		if ( this.mfsca == undefined ) {
			this.mfsca = setup.defaultMfscaOption;
		}
		var MFSCAchoices = "__Multiple full sex continued actions__" + getMFSCAtooltip() + ":\n"
						 + '<label><<radiobutton "$settings.mfsca" "enable"';
					if ( this.mfsca == 'enable' ) { MFSCAchoices += " checked"; }
		MFSCAchoices += '>> Enable</label>\n'
			          + '<label><<radiobutton "$settings.mfsca" "disable"';
					if ( this.mfsca == 'disable' ) { MFSCAchoices += " checked"; }
		MFSCAchoices += '>> Disable</label>';	
		
		return MFSCAchoices;
	}
	
	Settings.prototype.formatBattleDefeatSexChoices = function() {
		this.battleDefeatSexChoices = '__Sex as result of battles__' + getSexFromBattlesTooltip() + ':\n';
		this.battleDefeatSexChoices += '<label><<radiobutton "$settings.battleDefeatSex" "enable"';
		if ( this.battleDefeatSex == 'enable' ) { this.battleDefeatSexChoices += " checked"; }
		this.battleDefeatSexChoices += '>> Enable</label>\n'
						  + '<label><<radiobutton "$settings.battleDefeatSex" "disable"';
		if ( this.battleDefeatSex == 'disable' ) { this.battleDefeatSexChoices += " checked"; }
		this.battleDefeatSexChoices += '>> Disable</label>';	
	}
	Settings.prototype.formatServitudeRelationshipsChoices = function() {
		this.servitudeRelationshipsChoices = '__Servitude relationships__' + getServitudeRelationshipsTooltip() + ': ' + colorText("(Harsh content)","firebrick") + '\n';
		this.servitudeRelationshipsChoices += '<label><<radiobutton "$settings.servitudeRelationships" "enable"';
		if ( this.servitudeRelationships == 'enable' ) { this.servitudeRelationshipsChoices += " checked"; }
		this.servitudeRelationshipsChoices += '>> Enable</label>\n'
						  + '<label><<radiobutton "$settings.servitudeRelationships" "disable"';
		if ( this.servitudeRelationships == 'disable' ) { this.servitudeRelationshipsChoices += " checked"; }
		this.servitudeRelationshipsChoices += '>> Disable</label>';	
	}
	Settings.prototype.formatStealingServitudeChoices = function() {
		this.stealingServitudeChoices = '__Stealing submissives__' + getStealingServitudeTooltip() + ': ' + colorText("(Harsh content)","firebrick") + '\n';
		this.stealingServitudeChoices += '<label><<radiobutton "$settings.stealingServitudeAllowed" "enable"';
		if ( this.stealingServitudeAllowed == 'enable' ) { this.stealingServitudeChoices += " checked"; }
		this.stealingServitudeChoices += '>> Enable</label>\n'
						  + '<label><<radiobutton "$settings.stealingServitudeAllowed" "disable"';
		if ( this.stealingServitudeAllowed == 'disable' ) { this.stealingServitudeChoices += " checked"; }
		this.stealingServitudeChoices += '>> Disable</label>';	
	}
	Settings.prototype.formatChastityChoices = function() {
		this.chastityChoices = '__Chastity and ruined orgasms__' + getChastityTooltip() + ': ' + colorText("(Harsh content)","firebrick") + '\n';
		this.chastityChoices += '<label><<radiobutton "$settings.chastity" "enable"';
		if ( this.chastity == 'enable' ) { this.chastityChoices += " checked"; }
		this.chastityChoices += '>> Enable</label>\n'
						  + '<label><<radiobutton "$settings.chastity" "disable"';
		if ( this.chastity == 'disable' ) { this.chastityChoices += " checked"; }
		this.chastityChoices += '>> Disable</label>';	
	}

Settings.prototype.formatSexSceneDurationChoices = function() {
	var chText = "__Generic Sex Scene Duration__ (Standard=30):\n";
	chText += '<<textbox ' + '"$settings.stdSxScDur" "' + this.stdSxScDur + '">>\n\n'
	
	return chText;
}

Settings.prototype.formatMaleCharsChoices = function() {
	var chText = "__Male Characters Allowed to be Lewd__"
			   + ' <span title="Disabling this option will prevent all characters whose personal pronoun is <he> from participating in lewd acts, including: joining sex scenes, using or receiving sex attacks during battles, using or receiving flirty or arousing actions in conversations. This option will not affect a player character whose gender has been changed to male.">^^(?)^^</span>' + ":\n";
	chText += '<label><<radiobutton "$settings.lewdMales" "enable"';
	if ( this.lewdMales == "enable" ) { chText += " checked"; }
	chText += '>> Enable</label>\n';
	chText += '<label><<radiobutton "$settings.lewdMales" "disable"';
	if ( this.lewdMales == "disable" ) { chText += " checked"; }
	chText += '>> Disable</label>';
	return chText;
}
Settings.prototype.formatMonstersChoices = function() {
	var chText = "__Monsters Allowed to use Lewd Actions__"
			   + ' <span title="Disabling this option will prevent all characters whose race is monster from using lewd actions.">^^(?)^^</span>' + ":\n";
	chText += '<label><<radiobutton "$settings.lewdMonsters" "enable"';
	if ( this.lewdMonsters == "enable" ) { chText += " checked"; }
	chText += '>> Enable</label>\n';
	chText += '<label><<radiobutton "$settings.lewdMonsters" "disable"';
	if ( this.lewdMonsters == "disable" ) { chText += " checked"; }
	chText += '>> Disable</label>';
	return chText;
}

	Settings.prototype.formatAllChoices = function() {
		formatAutosavingChoices();
		this.formatDifficultyChoices();
		this.formatFutaChoices();
		this.formatSexPrefChoices();
		this.formatNpcBonusesChoices();
		this.formatAnalChoices();
		formatPainChoices();
		this.formatBattleDefeatSexChoices();
		this.formatServitudeRelationshipsChoices();
		this.formatStealingServitudeChoices();
		this.formatChastityChoices();
		
		this.allChoices = "";
		
		this.allChoices += this.autosavingChoices + "\n\n";
		if ( this.exitPassage != "Personal Room" ) { // These options shouldn't be accessible after the start of the game
			this.allChoices += this.difficultyChoices + "\n\n" + this.futaChoices + "\n\n" + this.sexPrefChoices + "\n\n" + this.npcBonusChoices + "\n\n"
		}
		this.allChoices += this.formatSexSceneDurationChoices() + "\n" + this.formatMaleCharsChoices() + "\n" + this.formatMonstersChoices() + "\n\n"
						+ this.analChoices + "\n\n" + this.painChoices + "\n\n" + this.formatMFSCAchoices() + "\n\n"
						+ this.battleDefeatSexChoices + "\n\n" + this.servitudeRelationshipsChoices + "\n\n"
						+ this.stealingServitudeChoices + "\n\n" + this.chastityChoices + "\n\n"
						+ this.exitButton;
	}
					
	Settings.prototype.getButtonExit = function() {
		var bText = "<<l" + "ink [[Save settings and leave|" + this.exitPassage + "]]>><<s" + "cript>>"
					+ "cleanAllSettingsChoices();\n"
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	Settings.prototype.setExitPassage = function(exitPassage) {
		this.exitPassage = exitPassage;
		this.exitButton = this.getButtonExit(this.exitPassage);
	}

window.gSettings = function() {
	return State.variables.settings;
}

window.cleanAllSettingsChoices = function() {
	State.variables.settings.allChoices = "";
	State.variables.settings.autosavingChoices = "";
	State.variables.settings.difficultyChoices = "";
	State.variables.settings.sexPrefChoices = "";
	State.variables.settings.npcBonusChoices = "";
	State.variables.settings.analChoices = "";
	State.variables.settings.painChoices = "";
	State.variables.settings.battleDefeatSexChoices = "";
	State.variables.settings.servitudeRelationshipsChoices = "";
	State.variables.settings.stealingServitudeChoices = "";
	State.variables.settings.chastityChoices = "";
	
	State.variables.settings.stdSxScDur = parseInt(State.variables.settings.stdSxScDur,10);
	if ( State.variables.settings.stdSxScDur == undefined || isNaN(State.variables.settings.stdSxScDur) ) {
		State.variables.settings.stdSxScDur = 30;
	} else if ( State.variables.settings.stdSxScDur < 1 ) {
		State.variables.settings.stdSxScDur = 1;
	}
}

window.formatAutosavingChoices = function() {
	State.variables.settings.autosavingChoices = '__Autosaving__' + getAutosavingTooltip() + ':\n';
	State.variables.settings.autosavingChoices += '<label><<radiobutton "$settings.autosaving" "enable"';
	if ( State.variables.settings.autosaving == 'enable' ) { State.variables.settings.autosavingChoices += " checked"; }
	State.variables.settings.autosavingChoices += '>> Enable</label>\n' + '<label><<radiobutton "$settings.autosaving" "disable"';
	if ( State.variables.settings.autosaving == 'disable' ) { State.variables.settings.autosavingChoices += " checked"; }
	State.variables.settings.autosavingChoices += '>> Disable</label>';	
}

window.formatPainChoices = function() {
	State.variables.settings.painChoices = '__Pain actions__' + getPainTooltip() + ': ' + colorText("(Harsh content)","firebrick") + '\n';
	State.variables.settings.painChoices += '<label><<radiobutton "$settings.pain" "enable"';
	if ( State.variables.settings.pain == 'enable' ) { State.variables.settings.painChoices += " checked"; }
	State.variables.settings.painChoices += '>> Enable</label>\n' + '<label><<radiobutton "$settings.pain" "disable"';
	if ( State.variables.settings.pain == 'disable' ) { State.variables.settings.painChoices += " checked"; }
	State.variables.settings.painChoices += '>> Disable</label>';	
}

window.applyDifficultyChanges = function() {
	switch(gSettings().difficulty) {
		case "easy":
			for ( var st of getStatNamesArray() ) {
				gC("chPlayerCharacter")[st].value += 2;
				gC("chPlayerCharacter")[st].affinity += 0.1;
			}
			break;
		case "normal":
			
			break;
		case "hard":
			for ( var st of getStatNamesArray() ) {
				gC("chPlayerCharacter")[st].value -= 2;
				gC("chPlayerCharacter")[st].affinity -= 0.1;
			}			
			break;
	}
	var npcCandidates = [ "chMir" , "chNash" , "chClaw" , "chVal" , "chAte" ];
	switch(gSettings().npcBonus) {
		case "none":
			for ( var npc of npcCandidates ) {
			}
			break;
		case "hypnosis":
			charactersLearnSceneActions(npcCandidates,["baHypnoticGlance","realHypnoticGlance"]);
			for ( var npc of npcCandidates ) {
			}
			break;
		case "draining":
			charactersLearnSceneActions(npcCandidates,["baDrainingKiss","baEnergyDrainingKiss","energyDrainingKiss"]);
			for ( var npc of npcCandidates ) {
			}
			break;
		case "bondage":
			charactersLearnSceneActions(npcCandidates,["baEtherealChains","etherealChains"]);
			for ( var npc of npcCandidates ) {
			}
			break;
		case "all":
			charactersLearnSceneActions(npcCandidates,["baHypnoticGlance","realHypnoticGlance","baDrainingKiss","baEnergyDrainingKiss","energyDrainingKiss","baEtherealChains","etherealChains"]);
			break;
	}
	switch(gSettings().sexPrefs) {
		case "noChanges":
			break;
		case "usePussy":
			for ( var npc of npcCandidates ) {
				gC(npc).tastes.usePussy.w += 100;
				gC(npc).tastes.useDick.w -= 50;
			}
			break;
		case "useDick":
			for ( var npc of npcCandidates ) {
				gC(npc).tastes.useDick.w += 100;
				gC(npc).tastes.usePussy.w -= 50;
			}
			break;
	}
}

window.getAutosavingTooltip = function() {
	var tText = '<span title="Enabling autosaving will automatically save your game at the last slot when you enter the personal room menu, '
			  + 'at the end of the day. If you\'re having performance issues, it\'s recommended to disable this option.">^^(?)^^</span>';
	return tText;
}

window.getDifficultyTooltip = function() {
	var tText = '<span title="When selected at the start of the game, changes the starting stats and affinities of the player.'
			  + '\nHard may make you suffer.">^^(?)^^</span>';
	return tText;
}
window.getFutanariTooltip = function() {
	var tText = '<span title="Futanari are women with both male and female genitalia.\n'
			  + 'The first three options will provoke futanari transformations on main characters near the start of the game.'
			  + 'Disabling main story content will prevent futanari protagonist transformations, but enable all other futanari content.">^^(?)^^</span>';
	return tText;
}
window.getAnalTooltip = function() {
	var tText = '<span title="This option enables or disables anal actions.">^^(?)^^</span>';
	return tText;
}
window.getPainTooltip = function() {
	var tText = '<span title="This option enables or disables sadism and masochism actions in sex scenes. Common fighting actions will remain enabled in combat scenes.">^^(?)^^</span>';
	return tText;
}
window.getMFSCAtooltip = function() {
	var tText = '<span title="This option enables or disables simultaneous continued full sex actions between any two characters.\n'
			  + 'Examples: A character X performing anal penetration on character Y while character Y performs scissoring with character Z will always be possible (as long as anal actions are enabled), but in order for character X to do both anal penetration and scissoring with character Y, this option requires to be enabled, since both are considered full sex continued actions. This option will allow anatomically impossible situations, such as two characters penetrating each other at the same time.">^^(?)^^</span>';
	return tText;
}

window.getSexFromBattlesTooltip = function() {
	var tText = '<span title="Partially implemented. Disabling this option will prevent characters from demanding sex after they win a battle.">^^(?)^^</span>';;
	return tText;
}
window.getServitudeRelationshipsTooltip = function() {
	var tText = '<span title="Servitude relationships are special relationships where the servant must obey the master. Disable this option to avoid these relationships from taking place.">^^(?)^^</span>';;
	return tText;
}
window.getStealingServitudeTooltip = function() {
	var tText = '<span title="Allowing this option will allow the player and NPCs to steal the submissives of other characters, should servitude relationships be allowed.">^^(?)^^</span>';
	return tText;
}
window.getTastesConfigTooltip = function() {
	var tText = '<span title="These options alter the sex scene preferences of your fellow NPC Candidates. If you do not intend them to become futanaris, it is best left unchanged. Cannot be changed later.">^^(?)^^</span>';
	return tText;
}
window.getChastityTooltip = function() {
	var tText = '<span title="This option allows spawning chastity belts and cages, as well as ruined orgasms and the actions provoking them. Disabling this option will not prevent the use of already spawned chastity items.">^^(?)^^</span>';
	return tText;
}

window.getNPCsBonusesTooltip = function() {
	var tText = '<span title="These options will grant extra actions related to specific kinks to the NPC Candidates.">^^(?)^^</span>';
	return tText;
}

window.isAssaultPossible = function(actor,target) {
	var flagPossible = true;
	
	if ( gC(actor).followingTo != "" ) { // Actor follows no one
		flagPossible = false;
	}
	else if ( gC(target).followingTo != "" ) { // Target follows no one
		flagPossible = false;
	}
	else if ( gSettings().assaultingAllowed == false ) { // Assaulting is allowed
		flagPossible = false;
	}
	else if ( getCharsRoom(target) != undefined ) {
		if ( getCharsRoom(target).combatAllowed == false ) { // Combat is allowed in target's current room
			flagPossible = false;
		}
	}
	else { // Actor and target don't have a special relationship that prevents assaults
		var relType = gRelTypeAb(actor,target);
		if ( relType ) {
			if ( relType.disallowedAssault ) {
				flagPossible = false;
			}
		}
	}
	
	if ( flagPossible ) {
		if ( mayCharBeInterrupted(target) == false ) {
			flagPossible = false;
		}
	}
	
	return flagPossible;
}
window.assaultPreConditions = function(actor,target) {
	var flagPossible = true;
	var relType = gRelTypeAb(actor,target);
	if ( relType ) {
		if ( relType.disallowedAssault ) {
			flagPossible = false;
		}
	}
	return flagPossible;
}
window.isChallengePossible = function(actor,target) {
	var flagPossible = true;
	
	if ( gC(actor).followingTo != "" ) { // Actor follows no one
		flagPossible = false;
	}
	else if ( gC(target).followingTo != "" ) { // Target follows no one
		flagPossible = false;
	}
	else if ( gSettings().challengingAllowed == false ) { // Challenging is allowed
		flagPossible = false;
	}
	else if ( getCharsRoom(target) != undefined ) {
		if ( getCharsRoom(target).combatAllowed == false ) { // Combat is allowed in target's current room
			flagPossible = false;
		}
	}
	else { // Actor and target don't have a special relationship that prevents challenges
		var relType = gRelTypeAb(actor,target);
		if ( relType ) {
			if ( relType.disallowedChallenge ) {
				flagPossible = false;
			}
		}
	}
	
	if ( flagPossible ) {
		if ( mayCharBeInterrupted(target) == false ) {
			flagPossible = false;
		}
	}
	
	return flagPossible;
}
window.challengePreConditions = function(actor,target) {
	var flagPossible = true;
	var relType = gRelTypeAb(actor,target);
	if ( relType ) {
		if ( relType.disallowedChallenge ) {
			flagPossible = false;
		}
	}
	return flagPossible;
}
window.isLiberationChallengePossible = function(actor,target) {
	var flagPossible = true;
	var eventsList = getEventsWherCharIsInvolved(actor).concat(getEventsWherCharIsInvolved(target));
	for ( var ev of eventsList ) {
		if ( ev.title == "battle" ) {
			flagPossible = false;
		}
	}
	
	if ( gSettings().challengingAllowed == false ) {
		flagPossible = false;
	} else if ( liberationChallengePreConditions(actor,target) == false ) {
		flagPossible = false;
	}
	else if ( getCharsRoom(target).combatAllowed == false ) { // Combat is allowed in target's current room
		flagPossible = false;
	}
	else if ( doesCharHaveDayTag(actor,"liberationAttempt") ) {
		flagPossible = false;
	}
	
	return flagPossible;
}
window.liberationChallengePreConditions = function(actor,target) {
	var flagPossible = true;
	if ( gC(actor).domChar != target ) {
		flagPossible = false;
	} else if ( gRelTypeAb(actor,target).liberationChallenge == false ) {
		flagPossible = false;
	}
	return flagPossible;
}

window.isLewdingPossible = function(actor,target) {
	var flag = true;
	if ( gSettings().lewdMales == "disable" ) {
		if ( actor != "chPlayerCharacter" ) {
			if ( gC(actor).perPr == "he" ) {
				flag = false;
			}
		}
		if ( flag ) {
			if ( target == undefined ) {
				flag = false;
			} else if ( target != "chPlayerCharacter" ) {
				if ( gC(target).perPr == "he" ) {
					flag = false;
				}
			}
		}
	}
	if ( gSettings().lewdMonsters == "disable" ) {
		if ( gC(actor).race == "monster" ) {
			flag = false;
		}
	}
	return flag;
}

// Constructors, serializers, etc.
Settings.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
Settings.prototype.clone = function () {
	return (new Settings())._init(this);
};
Settings.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Settings())._init($ReviveData$)', ownData);
};

//////////////

const storyState = {
	firstLoop: 0,
	firstAdventure: 1,
	secondLoop: 2
}

State.variables.storyState = storyState.firstLoop;

window.getCurrentStoryState = function() {
	var storyState = 0;
	if ( State.variables.storyState != undefined ) {
		storyState = State.variables.storyState;
	}
	return storyState;
}
window.isCurrentStoryStateInMainLoop = function() {
	var result = true;
	if ( State.variables.storyState == storyState.firstAdventure ) {
		result = false;
	}
	return result;
}

//////////////

setup.creditsGoddessEnthusiast = [ "LessIDableName ","Sordax","ben ","Peter ","Troy Armstrong","Colton Foote","Barnabas Collins","Vadrin ","Jake Ross","Nevyn ","Tyler Kreutzer","Pandavenger ","Chris40 ","He Who Remembers All","Bluebomber ","Brian Keefe","ElCrazy1 ","Grissie","ShardOfCard ","ElrondHubbard ","Thomas Colasanto","Nat Byham","Evgeniy ","Cody Shawver","Brad11 ","tiffany mawhorter","Trickster ","Redace","Alex Srisaard","วํฒนะ มานะภักดี","Oliver_Ritchie ","Ermin Pivac","Alex2011","Scott","anactualgoat ","TheShwig ","Jou Chen","Michael ","Mateusz Karliczek","Robert Crawford","MrTheDarkRed ","Black Rose Valerie","Kandschur ","Andrew Dupuis","mainman879 ","Chris Shaw","Christopher Hopkins","Kevin Andrews","DankMeme ","Meserym ","Quinzell Antrom","Pandavenger","Logan Villa","Norann","Pingo ","Jan Hynek","Franko Bogdan","Alex Gaskins","Torrin ","Andrew Elvin","ArkSilver ","White Pebble","Yukari ","Grimaga ","Marcus Lu","Alysha Malone","Dage ","ArtificerZeltara","J AndMck","Snazy","Vkad 64","Dragon","Roze14 ","C Fra","Tyler Trounce","Michael Dennis Eagles","Manraj Dhanda","FirefoxV2 ","Boopley Boop","Grandius Grimm","Taziah Robinson","Mekhet ","cbcpdxkq3z","Markus Boos","Remi BB","Jack Fereday","Patrick McCabe","Tyler Kelly","mahdeennave ","Kou Mao","Gavin Winkler","jason cole","Jojolity ","Takos ","Shawn ","AD","Richard Dolder","ZXapol ","Kasen081 ","Nathan Reina","Name ","Lena Elmer","Jake Davis","Aleister Crowley","Alexander Presley","Void-Searcher .","Mikkel Christoffer Kraesing Neergaard","Blake ","Tinwen ","Michael Rydel","Josh white","Desmond Finney","Nemo-Iratus ","Jack Jamieson","yospeakr","Tarcc ","Lily Dawn","Zangi ","Richard Whitcher","ErDragon","Duchairn ","DarkyCrusad","aleante ","pebbles ","Keira Nguyen","Omoi T Wilkes","Ryan Lines","Tyler","TJ Gulledge","lvence","Zargothrax ","DANG NGUYEN MINH LUAN","PyriteP ","Oleg Kuzen","doofy goof","uwuwuwu ","Davos Sunshine","Aidan Myers","James Sampson","P-tron ","Ghostty","Ron Volpe","Coleman Stephan Johnson","Daniel Voronin","J","Oskar Hjorth","Brandon Livingston","NooBie ","shawn plumridge","sera","Micah Watkins","Jonathan Sane","ArsonisticMadCat ","Normal Accidents","TheApatheticAsshat","Drayton ","SmolFish ","yoon sung ju","D B","proninja22nd .","Cyril Remo Reyes","Alakdar ","Oleg Moloh","Harutenrai","Alkhiro Saber","Terrell Simms","Rory Baker","Eli Shmidt","Nick ","Benjamin Delgren","Sans ","Jacob Saganek","Alice Hiess","Iamus The Fox","dias","Sven Kalus","Kilborn ","Halcy Grand","Mahin Ahmed","Classyjarl","昀之 贾","A.K.A wut","Loxica","Andres ","Eduardo ","Madison Hickman","Bobby White","Shane Daley","Vienna Prudenciano","Souleater","Colin Owler","MyHobos ","Bo Botkin","Jack ","Hatz","Robert England","Cody Powers","Ben Jones","Words Words","Samantha ","Miyako Kobayashi","Hooman","Brett Evans","Canadian321 ","cory kinsley","Jason ","MistressCynthia ","Brad Davis","Anon1998","Bob ","robbert roth","joe","Michal Reimer","Luke Ballard","Sagaptor ","Scott Christensen","Fauxfox ","anactualgoat","Bob Johnson","AdmiralBreaker","cynthia","SHSL Gamer","Realms×Myths","Feltenix","Pink Milk","Ashenbones ","Zachary","Fiona Quinn","Joseph Beals","Vidar ","Ryan Allday","Nora Knox","Wildhawk ","A ","jack slate","Aaron Gahr","lolknight ","ColorfulGreyGoo","buddhapest","Vadrin","jason","Hannes Westander","zachary gafken","Benyrx ","Anton Åkesson","Chessia58","Jayson Hudson","devin wagner","Kevin Banda","a сertain hypocrite","Destroyerofsin35 Gaming","Someothermon","anonymous kid","Liches-Favour ","Pole Star","Anita Juckum","shadow master","Tyler Coffey","Felipe","Stephen Clifford","Bob Dole","Fang","Lior","Hayden John Williams","ragond","billy","Devon Edwards","Twofeather Quanto","Omnimagnus ","ZombieSniper246 ","Callan Weir","gff af","Kuroi Mato","SpilledAntifreeze","William Shepherd","nosyk drofecnul","Clancy Gilroy","riff smitty","BloGer _VID_","huge legend","kadir ","Justin Kays","VySaika ","Jack Whitehouse","Melanie","Dark Solitude","BannedHeresy ","Matthew Schultz","Kin_Teb","Oberon","Leo ","annonomu ","michael glover","Steven Adams","Ana Silva","Dani James","C Tsang","Ignissik","Cole Delaney","David Alvå","Dalton Sky","Sejlen","savi","Jade Le","Lucas Pauling","Highlord","MattTheFree ","Triforcealt255 ","Selignite Verine","Benjamin L. Hood","Matthew Baskerville","Maximus ","Nathanael Crockett","Danealus ","SuperSuperMarcel","DarkPsionic ","Colin Yu","BasNek ","Nikolas Podrasky","ShadeOfTheLight ","Marmar ","will ","Bloodhound45","Booga","jf","jedidia bullock","NightMarie","ShadowsterZ","Nex ","peplum02348","EV ","Kharma Bearer","Derps McGee","David Poulson","Phant0mCobra ","Chong Xena","Devereaux Mills","Angelo ","Kaebora ","Parker Heustess","LazyDragon ","darktalon","Zavgonymous","Alivda" ];

setup.creditsPassionTemplePreacher = [ "Ryuko ","Fox McQwerty","Barada Azana","aattss ","Samurai_Jack141 ","Name2146 ","Snakes! ","Irasur","Alex ","Nathaniel Grams","Cory Elliott","SenoirKain ","Andreas","Gura ","ThatsAllFolks ","Joshua Boguth","Ross Fountain","Thomas ","Emily S.","Hunter Glad","Devin White","Anon ","hiorka","dark_dragon ","Hairdevill","A giant crab","Kai Scheele","Jacob LaRiviere","pyrite","Georgii Brisuela","Anonimus Mito","Stephen","Stephen Pieper","Weathnarh ","Zergling ","Rodimus Darnath","kirito shiba","Unsung ","NoWorries623 ","Aplysina Cyanobacterium","Terminal_ERROR","Grant Manthey","Matt Miller","Dan Schrader","Slywolf357 ","Vysirez ","Benjamin Grieder","Michael Avellino","Satile ","Kestrel","Paladin_Wiggles_II ","CancerMage ","NightStrike01 ","ZVReaper16","Mcquaqua ","billyboy","Eric Wood","Elisia Seda","Sebastian Baran","Jabbtoth ","Snaked ","MaxTan ","Cyril guillas","Bartolomeo ","Pikarukawa","Anburaru ","This Guy","Nemesison ","Sunny Reehal","Joshua Todd Shaffer","TheLastBang ","Burckle","c0nevs ","Rj Sawyer","Максим Конорев","Mig Dig","Jacob Wrightsman","Desseus ","Lexi Knight","CriticalExistenceFailure ","floccinaucinihilipilification ","Friendly Neighbor","이재승 ","NovaDragn ","Chris Douglas","Bob Fruman","Gamenerd3 ","StrayWolf ","Skyrim mod lvr","Felkesste","William K Bennett","Spencer Bradford","Phenix995 ","Foolwatchout ","Lunaraia ","Guardx","Curtis1122","Kyle ","Kuma III","Weegee","Wirglays ","DeathbyKimchi ","Yi ","Reddy Allen","Bohrne","Honey Crab","12inpen","Be","k0lt ","Jim S","Joe Barrass","This guy","LunarGuardsman ","CorprealFale","Willayfiddle ","Renpon ","warshotcv ","Something ","Jens Bertrams","Hartmanns Youkai","Aeonian Argos","Chris","Joe X","FalconNrOne ","'---- ","Randall H","Anomally","SlamJammer ","acpmage","Christian Adalbert","Dr_Russian ","Aspios ","Grumpy ","Gabriel Grey","Chris ","CrysHistory ","Jean Otus","SetsunaYuki","muckenmaker ","Rockstad ","Nathan Taylor","noah ","Konomori ","Rex J Jensen","Red Duke","Shirogitsune","Wazzugazzu","Wesley A. Collins","Hillfillk","Parzival","Tharm","Perseus_paradox ","Austin Anderson","BruceM ","Peter Managarm","Inquisitor Gaia","Elowin ","matthew nemec","Ultrasexy ","YJs ","MajorCoincoin ","Myles ","Mayu The Kitsune","Cotton59 ","Bunne","magenta_bang ","Shadowed Song","Isan-San ","NRFB ","Sam Williams","der","richardTrickle ","Rune ","Hendrijk Watson","Zanaam","Niklas ","Mikhail Petrovic","Qwazpoi","Pink Wolf","AxiosMIles ","Jacob Perry","BlackDickens ","L","swaginator ","Izanagi15 ","OmcMcAlp ","Layne Landis","DivingRocket","Beebo","Robin ","Kevin Ball","John","Windarian ","Mithrandir ","Silcerius","Rene Bien","segev hype","Lucy Ventura","Bryan Shepherd","Tom Hoffs","lolwutt","Anders Bergström","David Townsend","Gandohar ","TreeSquared ","Cheezzyninja ","MJN ","David S Abraham","urdnot123 ","Pedro Garza","brandon stenlake","Dr_Fizzle ","Martin Santiago","drew hal","Maudika ","Crette ","Thunderstruck025","John Doe","jacques ","MechaMarshmallow ","Grekken ","Mike13858","Joseph Padgett","Ronald Kim","DefectiveGamer ","Ian","John Denny","Steinhammer","Auntie Grieves","PassingbyPosts","Girmout Lokison","Rachel Gern","Aureate_Folly","Lunanar","rowgran","Anthony Zeppieri","Seraph ","Dan ","Gavin Lane","Hjaalfar Skjoldrsson","lamonte robinson","Hunter Cottrell","TheDarkSoul11","8 bit","Lordaron ","Cameron Spangler","MrPotatoAim6349","Jeff Mcbiscuits","Jackoshack","Haidrin","DeathCoyote","Azra","Whyohwhy 12","Houya","Maseca","kyle hoopes","Disparrow ","Logan Berek","Toa Disk","Brian Niceley","Etak ","josh","Matt ","William Padilla","Richard ","Stefan Karfusehr","James Edison","Slacker ","Moonswitch3399 ","Nikolas Ambross","Colette Lelette","Heptu","Vrocket","Grippa ","Andrew Henniges","Vapantraath","bunker buster","t s","Earl Martin","02010 ","Dean Laird","TheVelourFog ","....... ","Mastergamer ","Ophis ","Narsauce ","Panda","Noir Usagi","Endy Cubed","IzumoKai","Jakob Cagle","Darklordiablo ","Suzaku ","Orvas","Ryan Krieger","K DA","Grocon A","Mr. J.","Robert gray","Slacker","BruceM","DemonQueen Sera","Mal","MonsterAD","Aria","Jen-Hsun Huang","Karma","Alice Reich","Nathan ","UserPig ","Anon the 13th","megahellreaper ","owen moore","Bobby D Floyd","asfdAD ","<SK> ","0Kanata0","snakbar ","philip","Selunea","SquigglyJim","Elijah McGovern","Jan Klauser","Kurious ","Israfel ","Lizzon ","Mark Hagan","Parad0x ","Arentios ","CptFalric ","Phenix995","Mars88","Maerwin","Norael ","Leche con chocolate","C","Kris","Khariel ","Rachel Burry","thisisnotreallyme ","Kara Regas","Alexander Brown","Azahel Noel Kurtz","Martin Griffin","Brave ","jordan zhou","Jeff ","Josh Button","Kashra Bascombe","Preusk ","Jake345 ","Fyodor ","Bryden Hoff","VYet","Mark Griffin","Kamren Drybread","Stephen Kennedy","Gaveal ","LionsFate ","hankhillpropane","mardoc","Kelbeck","parle42","Dav G.","Daver ","Milkygf","Narsauce","Wanderer","Jeyne Poole","William Taylor","EPIC BIRD","Justin Doyle","Califried","Drew Lichter","Rogi250","Logan Dodd","Cargo RSteele","Master Spark","Ocelotinside ","frog","Wind Walker","Ookami Kuchi","kafqm kqgmp","NeoDnyarri ","hundheim ","meowcat242","QQQdev ","Dakota Keeffer","Malte Schwantje","ThatoneBrah ","Tyragor ","Jayun ","sksksksksksksksksksks kskskskskskskskskssksksksksk","maps","JubileeGeode","Rene","Dr_Russian","Kilian Gnauck","witedragon","aiden ploughe","faye ","Sarah","Andi Li","j l ","Alisdair Gaston","Josh S","James Maes","Ian Harlow","Max ","Kitsune Tenko 9","Bobert the great","Joe Thelizard","Steve ","0ffnixleoi","Matatus Gratorus","Devon Farion","Kholonoe Lavist","Ninja ","Lol Djsj","DemonBlade","'-药不够- ","Miyuki Irie (Realtime6)","Tim Fischer","Cody Gardner","SaltyNeko","Nicklas Høgh","jim ","midnight sky","Jacob","divaroach","Losevka","Noam Halpert","RC ","Sara Kline","Michael Mancuso","Daniel Smith","TheGman","Klopss ","NeitherMeNorYou ","Rekka","Vlad Brown","Zaibunny","Старпёр ","Owlbear","Jahmir Roy","Teltmanden","Richard Mills","Edward Phillips","Stratus","Alayla Risen","Anonynym","The One Who Knocks","R754","Ikarie","Azra El Crackhead","Cheezzy","Myah","DeadWolf357","용재 최","CasualBananas ","Blackwind TV","Dalriada ","Minesthra ","Avery Ioanidis","Black Lagoon23","Gloop ","shy-nerd-girl ","J. S.","Jordan Duggan","inszel ","Aaron Garland","Books Argentus","S","Technicolour","Exalt","A Giant Crab","Satsu","Chronos189 ","jere päivärinta","SomeRandomNamedBob","nk0x ","Brent Linn","BoogerBrigade ","Kelem ","Io96 ","Ah Dude","uzim22001 ","shin04h ","Alexander Schmid","Ethan Touzeau","Francis Lee","Bookmaniac","Dallas 179","Colin Kavanagh","Hampus Granat","Koshiu","Kibowalker ","Shatika Wallico","ChaoticPhoenix","codman56to","El Bardo" ];

setup.creditsPassionTempleClergy = [ "Alygness ","Joshua Smith","Longwave","Carlos Sierra","Elmeri Kunnas","Arkaykami","Shearly","Lil Wolfy" ];
setup.creditsTier1 = "";
setup.creditsTier2 = "";
setup.creditsTier3 = "";
for ( var patronEntry of setup.creditsGoddessEnthusiast ) {
	setup.creditsTier1 += patronEntry + "\n";
}
for ( var patronEntry of setup.creditsPassionTemplePreacher ) {
	setup.creditsTier2 += patronEntry + "\n";
}
for ( var patronEntry of setup.creditsPassionTempleClergy ) {
	setup.creditsTier3 += patronEntry + "\n";
}

///// General functions /////


// General UI bars functions

	// Present character info
window.presentCharInfo = function(title,img) {
	this.title = title;
	this.img = img;
}

window.getPresentCharByKey = function(key) {
	var title = gC(key).formattedName;
	var img = gC(key).avatar();
	var cInfo = new presentCharInfo(title,img);
	return cInfo;
}

window.getPresentCharCustomName = function(key,customName) {
	var title = '<span style="color:' + gC(key).nameColor + '">' + customName + '</span>';
	var img = gC(key).avatar();
	var cInfo = new presentCharInfo(title,img);
	return cInfo;
	// '<span style="color:'+this.nameColor+'">'+this.name+'</span>';
}

window.getPresentCharCustomTitle = function(key,customTitle) {
	var img = gC(key).avatar();
	var cInfo = new presentCharInfo(customTitle,img);
	return cInfo;
}

State.variables.presentCharacters = [];

window.setPasChars = function(charsInfoList) {
	// Set Passage Characters
	State.variables.presentCharacters = charsInfoList;
}
window.setNoPasChars = function() {
	State.variables.presentCharacters = [];
}


//  Bars proper
window.refreshUIbars = function() {
	if ( tags().contains("SIS") ) {																				// SIS
		// Player is alone or has followers
		if ( State.variables.chPlayerCharacter.followingTo == "" ) {
			State.variables.leftUIbarText = State.variables.chPlayerCharacter.getCharacterUIbarInfo() + State.variables.chPlayerCharacter.mood.getUiText();
			for ( var ck of State.variables.chPlayerCharacter.followedBy ) {
				State.variables.leftUIbarText += State.variables[ck].getCharacterUIbarInfo() + gC(ck).mood.getUiText();
			}
		} else { // Player following someone
			var leaderKey = State.variables.chPlayerCharacter.followingTo;
			State.variables.leftUIbarText = State.variables[leaderKey].getCharacterUIbarInfo() + gC(leaderKey).mood.getUiText();;;
			for ( var ck of State.variables[leaderKey].followedBy ) {
				State.variables.leftUIbarText += State.variables[ck].getCharacterUIbarInfo() + gC(ck).mood.getUiText();
			}
		}
		if ( State.variables.compass.pcSis != -1 ) {
			State.variables.rightUIbarText = "";
			for ( var charKey of State.variables.compass.sisList[State.variables.compass.pcSis].charList ) {
				if ( charKey == "chPlayerCharacter" || gC(charKey).followingTo != "" || gC(charKey).followedBy.includes("chPlayerCharacter") ) {
					// Don't show
				}
				else if ( gC(charKey).followedBy.length > 0 ) {
					State.variables.rightUIbarText += State.variables[charKey].getCharacterUIbarInfo() + State.variables[charKey].mood.getUiText();
					for ( var ck of gC(charKey).followedBy ) {
						State.variables.rightUIbarText += State.variables[ck].getCharacterUIbarInfo() + State.variables[ck].mood.getUiText();
					}
				}
				else {
					State.variables.rightUIbarText += State.variables[charKey].getCharacterUIbarInfo() + State.variables[charKey].mood.getUiText();
				}
			}
		} else {
			State.variables.rightUIbarText = "";
		}
	}
	else if ( State.variables.sc.flagSceneActive == false  ) { 													// Default
		State.variables.leftUIbarText = State.variables.chPlayerCharacter.getCharacterUIbarInfo();
		State.variables.rightUIbarText = "";
		for ( var pciA in State.variables.presentCharacters ) {
			if ( State.variables.presentCharacters[pciA] instanceof presentCharInfo ) {
				var pci = State.variables.presentCharacters[pciA];
				if ( pci.title != null ) {
					State.variables.rightUIbarText += pci.title + "\n";
				}
				if ( pci.img != null ) {
					State.variables.rightUIbarText += pci.img + "\n";
				}
				if ( pci.title != null || pci.img != null ) {
					State.variables.rightUIbarText += "\n";
				}
			}
		}
	
		if ( State.variables.compass.currentMap != "none" && State.variables.eventsCalendar.activeEvent != true ) {				// Map
			// Player following no one
			if ( State.variables.chPlayerCharacter.followingTo == "" ) {
				State.variables.leftUIbarText = State.variables.chPlayerCharacter.getCharacterUIbarInfo();
				for ( var ck of State.variables.chPlayerCharacter.followedBy ) {
					State.variables.leftUIbarText += State.variables[ck].getCharacterUIbarInfo();
				}
			} else { // Player following someone
				var leaderKey = State.variables.chPlayerCharacter.followingTo;
				State.variables.leftUIbarText = State.variables[leaderKey].getCharacterUIbarInfo();
				for ( var ck of State.variables[leaderKey].followedBy ) {
					State.variables.leftUIbarText += State.variables[ck].getCharacterUIbarInfo();
				}
			}
			State.variables.compass.refreshRightUImap();
		}
	}
	else {																										// Scene
		State.variables.leftUIbarText = ""; // State.variables.chPlayerCharacter.getCharacterUIbarInfo();
											// Hide the player character if they're not participating in a scene
		if ( State.variables.sc.teamAcharKeys.includes("chPlayerCharacter") ) {
			State.variables.leftUIbarText += State.variables.chPlayerCharacter.getCharacterUIbarInfo();
		}
		State.variables.rightUIbarText = "";
		
		for ( var charKey of State.variables.sc.teamAcharKeys ) {
			if ( charKey != "chPlayerCharacter" ) {
				State.variables.leftUIbarText += "\n" + State.variables[charKey].getCharacterUIbarInfo();
			}
		}
		for ( var charKey of State.variables.sc.teamBcharKeys ) {
			State.variables.rightUIbarText += "\n";
			if ( gC(charKey).fullPortrait ) {
				State.variables.rightUIbarText += State.variables.sc.getButtonShowFullAvatar(charKey) + " ";
			}
			State.variables.rightUIbarText += State.variables[charKey].getCharacterUIbarInfo();
		}
	}
}

// if (tags().contains("saveAllowed"))

////////// COMMON FUNCTIONS //////////

// Math
window.float2int = function(value) {
    return value | 0;
}
window.limitedRandom = function(limit) { // Returns a random float ranging between 0 and limit
	return Math.random() * limit;
}

window.limitedRandomInt = function(limit) { // Returns a random ranging between 0 and limit.
	limit += 0.99;
	return window.float2int(window.limitedRandom(limit));
}

window.getNumbersLength = function(n) {
	var num = n;
	if ( num < 0 ) { num = -num; }
	return parseInt(parseInt(num).toString().length);
}
window.isPosNegX1 = function(n) {
	if ( n >= 0 ) { return 1; }
	else { return -1; }
}

// Programming logic
window.shuffleArray = function(array) {
	var newArray = [];
	var pos = 0;
	
	while(array.length > 0) {
		pos = limitedRandomInt(array.length - 1);
		newArray.push(array[pos]);
		array.splice(pos,1);
	}
	
	return newArray;
}

window.arrayMinusA = function(array,a) {
	//State.variables.log += " : First array : " + array + " , Second Array : ";
	var newArray = [];
	var a2 = "" + a;
	
	for ( var b of array ) {
		var b2 = "" + b;
		if ( b2 !== a2 ) {
			newArray.push(b);
		}
		else {
		}
	}
	//State.variables.log += newArray + " ";
	return newArray;
}
window.removeDuplicatesFromList = function(array) {
	var newArray = [];
	for ( var obj of array ) {
		if ( newArray.includes(obj) == false ) {
			newArray.push(obj);
		}
	}
	return newArray;
}

window.randomFromList = function(list) {
	if ( list.length > 1 ) {
		var randomPosition = limitedRandomInt(list.length-1);
	} else { 
		var randomPosition = 0;
	}
	return list[randomPosition];
}

// Text
window.firstToCap = function(string) { // Returns a string similar to input with a capitalized first character
	var nString = string[0].toUpperCase() + string.slice(1);
	return nString;
}
window.ftc = function(string) { // firstToCap abbreviation
	return firstToCap(string);
}

window.hoverText = function(txt,hText) {
	var result = "<span title='" + hText + "'>" + txt + "</span>";
	return result;
}

window.ktn = function(charKey) { // Returns the stdName of a character given its char key
	return getChar(charKey).stdName();
}

window.dickWord = function() {
	return randomFromList(["dick","dick","dick","dick","dick","cock","cock","cock","prick","shaft","member","penis"]);
}
window.pussyWord = function() {
	return randomFromList(["pussy","pussy","pussy","pussy","pussy","cherry","cherry","snatch","clam","kitty"]);
}
window.boobsWord = function() {
	return randomFromList(["breasts","breasts","breasts","breasts","chest","chest","bosom","bust"]);
}
window.assWord = function() {
	return randomFromList(["ass","ass","ass","butt","butt","bottom","rear"]);
}

window.colorText = function(text,color) {
	var newText = '<span style="color:' + color + '">';
	newText += text;
	newText += '</' + 'span>';
	// <span style="color:lightcoral">Lust:</span>, khaki, purple, darkred, lightcoral
	return newText;
}
window.textLustDamage = function(damage) {
	return colorText((damage.toFixed(2) + " lust damage"),"lightcoral");
}
window.textWillpowerDamage = function(damage) {
	return colorText((damage.toFixed(2) + " willpower damage"),"darkslateblue");
}
window.textEnergyDamage = function(damage) {
	return colorText((damage.toFixed(2) + " energy damage"),"limegreen");
}
window.textSocialdriveDamage = function(damage) {
	return colorText((damage.toFixed(2) + " social drive damage"),"khaki");
}

window.textWillpowerPoints = function(damage) {
	return colorText((damage.toFixed(2) + " willpower points"),"darkslateblue");
}
window.textEnergyPoints = function(damage) {
	return colorText((damage.toFixed(2) + " energy points"),"limegreen");
}
window.textSocialdrivePoints = function(damage) {
	return colorText((damage.toFixed(2) + " social drive points"),"khaki");
}

window.getBarName = function(barType) {
	var text = "";
	if ( barType == "socialdrive" ) {
		text = "Social Drive";
	} else {
		text += firstToCap(barType); 
	}
	return text;
}

State.variables.customRoomIntro = "";
window.setRoomIntro = function(mapName,roomName) {
	//var room = State.variables[mapName].rooms[roomName];
	var intro = `<div class='standardBox'>  <span style="vertical-align: middle;"><img src="img/mapIcons/` + setup[mapName][roomName].medIcon + `" style="vertical-align: middle;">` + " __" + setup[mapName][roomName].title + "__</span>";
	//var intro = "<div class='standardBox'>[img[img/mapIcons/" + setup[mapName][roomName].medIcon + "]]__" + setup[mapName][roomName].title + "__";
	if ( setup[mapName][roomName].getDescription() != "" ) {
		intro += "\n" + setup[mapName][roomName].getDescription();
	}
	intro += '</div>';
	State.variables.customRoomIntro = intro;
}

window.getTextWithTooltip = function(txt,tooltip) {
	var fTxt = "<span title='" + tooltip + "'>" + txt + "</" + "span>";
	return fTxt;
}

// Engine
window.getChar = function(charKey) {
	return State.variables[charKey];
}
window.gC = function(charKey) { // getChar shortcut
	return getChar(charKey);
}

window.gCstat = function(charKey,stat) {
	return getChar(charKey)[stat].getValue();
}

window.getCharList = function(charKeysList) {
	var charList = [];
	for (var key in charKeysList) {
		charList.push(getChar(charKeysList[key]));
	}
	return charList;
}

window.getCharNames = function(charKeysList) {
	var text = "";
	var i = 0;
	for ( var charKey in charKeysList ) {
		text += gC(charKeysList[charKey]).getFormattedName();
		i++;
		if ( charKeysList.length == i ) {
			//text += ".";
		}
		else if ( i == charKeysList.length - 1 ) {
			text += " and ";
		}
		else if ( i < charKeysList.length ) {
			text += ", ";
		}
	}
	return text;
}
window.getCharKtns = function(charKeysList) {
	var text = "";
	var i = 0;
	for ( var charKey in charKeysList ) {
		text += ktn(charKeysList[charKey]);
		i++;
		if ( charKeysList.length == i ) {
			//text += ".";
		}
		else if ( i == charKeysList.length - 1 ) {
			text += " and ";
		}
		else if ( i < charKeysList.length ) {
			text += ", ";
		}
	}
	return text;
}

window.stringArrayToText = function(stringArray) {
	var text = "";
	var i = stringArray.length;
	for ( var str of stringArray ) {
		text += str;
		if ( i > 2 ) { text += ", "; }
		else if ( i > 1 ) { text += " and " }
		i--;
	}
	return text;
}
window.stringArrayToTextMinusAnd = function(stringArray) {
	var text = "";
	var i = 0;
	for ( var str of stringArray ) {
		if ( i > 0 ) { text += ","; }
		text += str;
		i++;
	}
	return text;
}

window.addToStVarsList = function(v) {
	if ( State.variables.StVarsList.includes(v) == false ) {
		State.variables.StVarsList.push(v);
	}
}
window.removeFromStVarsList = function(v) {
	var newStVars = [];
	for ( var varName of State.variables.StVarsList ) {
		if ( varName != v ) { newStVars.push(varName); }
	}
	State.variables.StVarsList = newStVars;
}
window.isStVarOn = function(v) {
	return ( State.variables.StVarsList.includes(v) );
}

config.saves.isAllowed = function () {
	if (tags().contains("saveAllowed")) {
		return true;
	}
	return false;
};

// Chars

	// Characters active for purposes of the simulation
	// These characters will get their stats, bars and relations updated at the end of each day, for instance
State.variables.activeSimulationCharacters = ["chPlayerCharacter","chVal","chNash","chClaw","chAte","chMir"];
window.getActiveSimulationCharactersArray = function() {
	var actSimChars = [];
	for ( var ch of State.variables.activeSimulationCharacters ) {
		actSimChars.push(ch);
	}
	return actSimChars;
}
window.getRandomizedActiveSimulationCharactersArray = function() {
	var actSimChars = getActiveSimulationCharactersArray();
	return shuffleArray(actSimChars);
}
window.getCandidatesKeysArray = function() {
	return ["chPlayerCharacter","chVal","chNash","chClaw","chAte","chMir"];
}
window.getRandomizedCandidatesKeysArray = function() {
	return shuffleArray(getCandidatesKeysArray());
}

window.getCharacterStatScore = function(character) {
	var score = gC(character).physique.value + gC(character).agility.value + gC(character).resilience.value + gC(character).will.value
			  + gC(character).intelligence.value + gC(character).perception.value + gC(character).charisma.value + gC(character).empathy.value
			  + gC(character).luck.value;
}

// Stats

window.addLuckFactor = function(baseValue,factor,luck) { // Applies an extra percent to baseValue depending on factor and luck
	var finalValue = baseValue * (1+factor*(limitedRandom(1.0)*(100-luck) + luck)/100);
	return finalValue;
}
window.luckedDiceThrow = function(luck) { // 100-sides dice throw, accounting for character's luck
	var result = (luck + limitedRandomInt(100-luck)) * 0.01;
	return result;
}

window.getStatNamesArray = function() {
	return ["physique","agility","resilience","will","intelligence","perception","empathy","charisma","luck"];
}
window.getRelationshipStatsNamesArray = function() {
	return [ "friendship" , "romance" , "sexualTension" , "submission" , "domination" , "rivalry" , "enmity" ];
}

window.getRandomStat = function() {
	return randomFromList(["physique","agility","resilience","will","intelligence","perception","empathy","charisma","luck"]);
}

window.getPhysiqueDescription = function() {
	var desc = "The capacity of a character to exert physical strength. Used for many physical activities and taxing sexual actions. "
			 + "Raises lust and energy.";
	return desc;
}
window.getAgilityDescription = function() {
	var desc = "The ability of a character to execute tasks that require precision. Used for many sexual actions, and often used to evade physical attacks. "
			 + "Raises lust and energy.";
	return desc;
}
window.getResilienceDescription = function() {
	var desc = "The capacity of a character to resist exhausting physical work and hits. Most commonly used to resist physical attacks and intense sexual pleasure. Raises lust and energy.";
	return desc;
}
window.getWillDescription = function() {
	var desc = "Indicates the mental resilience of a character. Often used to resist temptations and evade magical attacks, sometimes useful to cast magic. Raises lust and willpower.";
	return desc;
}
window.getIntelligenceDescription = function() {
	var desc = "Refers to the strength of the mind. Most commonly used to cast complex, precise magic. Raises lust and willpower.";
	return desc;
}
window.getPerceptionDescription = function() {
	var desc = "The capacity of a character to detect movements and sounds that would otherwise be ignored. Often useful to evade attacks. Raises lust and willpower.";
	return desc;
}
window.getEmpathyDescription = function() {
	var desc = "Indicates the ability of a character to understand the feelings and motivations of others. Most useful during socialization, also serves to resist social attacks. Raises lust and social drive.";
	return desc;
}
window.getCharismaDescription = function() {
	var desc = "Refers to the ability of a character to get the most out of their expressions. Most useful during socialization, and it also powers social attacks. Raises lust and social drive.";
	return desc;
}
window.getLuckDescription = function() {
	var desc = "In a world where everything is connected by aether, luck refers to the harmony of a character with all elements of the world. Improves in very small amounts your dealt sexual pleasure, damage, chances to land or evade attacks, and success during socialization.";
	return desc;
}

////////// Weighted List //////////

window.weightedList = function() {

};

window.weightedElement = function(content,weight) {
	this.content = content;
	this.w = weight;
};
class weightedRankedElement extends weightedElement {
	constructor(content,weight) {
		super(content,weight);
		this.r = 0;
	}
}
class weightedDefinedRankedElement extends weightedElement {
	constructor(content,weight,rank) {
		super(content,weight);
		this.r = rank;
	}
}
window.weightedListLength = function(wL) {
	var l = 0;
	for ( var el in wL ) {
		if ( wL[el] instanceof weightedElement ) {
			l++;
		} /*else if ( wL[el] instanceof weightedRankedElement ) { 
			l++;
		} else if ( wL[el] instanceof weightedDefinedRankedElement ) {
			l++;
		}*/
	}
	return l;
}

window.getWeightedListTotalValue = function(wList) {
	var fullWeight = 0;
	
	for ( var item in wList ) {
		if ( wList[item] instanceof weightedElement ) {
			if ( wList[item].w >= 0 ) {
				fullWeight += wList[item].w;
			}
		}
	}
	
	return fullWeight;
}
window.randomFromWeightedList = function(wList) {
	var fullWeight = getWeightedListTotalValue(wList);
	var r = limitedRandom(fullWeight);
	var chosenItem = "errorWList";
	var counter = 0;
	
	for ( var item in wList ) {
		if ( ( wList[item] != false ) && ( wList[item] instanceof weightedElement ) && ( chosenItem == "errorWList" ) ) {
			counter++;
			if ( wList[item].w > 0 ) {
				r -= wList[item].w;
				if ( r <= 0 ) {
					chosenItem = wList[item].content;
					break;
				}
			}
		}
	}
	if ( chosenItem == "errorWList" ) {
		if ( counter > 0 ) {
			chosenItem = getFirstElementFromWeightedList(wList);
		}
	}
	return chosenItem;
}
window.randomFromWeightedListPercentThreshold = function(wList,threshold) {
	// Similar to randomFromList(), except that options with weights lower than the highest weight*threshold are not taken into account
	var newWlist = new weightedList();
	
	// Get highest value
	var highest = -1;
	for ( var item of wList ) {
		if ( item.w > highest ) { highest = item.w; }
	}
	// Remove unvalid options
		var i = 0;
	for ( var item of wList ) {
		if ( item.w >= (highest * threshold) ) {
			//newWlist.push(item);
			newWlist[i] = item;
			i++;
		}
	}
	// Get random option
	return randomFromWeightedList(newWlist);
}
window.listIntoWeightedList = function(list) {
	var wList = new weightedList();
	for ( var item in list ) {
		wList[list[item]] = new weightedElement(list[item],100);
	}
	return wList;
}

window.createPreferencesWeightedList = function() {
	var wl = new weightedList();
	wl.foreplay = new weightedRankedElement("foreplay",100);
	wl.oral = new weightedRankedElement("oral",100);
	wl.fullsex = new weightedRankedElement("fullsex",100);
	wl.talk = new weightedRankedElement("talk",100);
	wl.useDick = new weightedRankedElement("useDick",100);
	wl.usePussy = new weightedRankedElement("usePussy",100);
	wl.useAnus = new weightedRankedElement("useAnus",100);
	wl.useBreasts = new weightedRankedElement("useBreasts",100);
	wl.useMouth = new weightedRankedElement("useMouth",100);
	wl.useEyes = new weightedRankedElement("useEyes",100);
	wl.useHands = new weightedRankedElement("useHands",100);
	wl.useLegs = new weightedRankedElement("useLegs",100);
	wl.useTail = new weightedRankedElement("useTail",100);
	wl.targetDick = new weightedRankedElement("targetDick",100);
	wl.targetPussy = new weightedRankedElement("targetPussy",100);
	wl.targetAnus = new weightedRankedElement("targetAnus",100);
	wl.targetBreasts = new weightedRankedElement("targetBreasts",100);
	wl.targetMouth = new weightedRankedElement("targetMouth",100);
	wl.targetEyes = new weightedRankedElement("targetEyes",100);
	wl.targetHands = new weightedRankedElement("targetHands",100);
	wl.targetLegs = new weightedRankedElement("targetLegs",100);
	wl.targetTail = new weightedRankedElement("targetTail",100);
	wl.top = new weightedRankedElement("top",100);
	wl.bottom = new weightedRankedElement("bottom",100);
	wl.domination = new weightedRankedElement("domination",100);
	wl.submission = new weightedRankedElement("submission",100);
	wl.bondage = new weightedRankedElement("bondage",100);
	wl.teasing = new weightedRankedElement("teasing",100);
	wl.hypnosis = new weightedRankedElement("hypnosis",100);
	wl.draining = new weightedRankedElement("draining",100);
	wl.charm = new weightedRankedElement("charm",100);
	wl.romantic = new weightedRankedElement("romantic",100);
	wl.usePain = new weightedRankedElement("usePain",100);
	wl.receivePain = new weightedRankedElement("receivePain",100);
	wl.denial = new weightedRankedElement("denial",100);
	wl.position = new weightedRankedElement("position",100);
	wl.continuedAction = new weightedRankedElement("continuedAction",100);
	
	return wl;
}
window.orderWeightedList = function(wL) {
	var orderedList = [];
	var chw = -10000; // Current highest weight
	var che = ""; // Current highest element
	while ( orderedList.length < (weightedListLength(wL) - 2) ) {
		for ( var we in wL ) {
			if ( orderedList.includes(wL[we].content) == false ) {
				if ( wL[we].w > chw && wL[we].content != "position" && wL[we].content != "continuedAction" ) {
					chw = wL[we].w;
					che = wL[we].content;
				}
			}
		}
		
		orderedList.push(che);
		chw = -10000;
		che = "";
	}
	orderedList.push("position");
	orderedList.push("continuedAction");
	return orderedList;
}
window.rankSexPreferences = function(wL) {
	var orderedList = orderWeightedList(wL);
	var rank2l = 4;
	var rank1l = 8;
	var i = 0;
	
	while ( i < rank2l ) {
		wL[orderedList[i]].r = 2;
		i++;
	}
	while ( i < (rank2l+rank1l) ) {
		wL[orderedList[i]].r = 1;
		i++;
	}
	while ( i < orderedList.length ) {
		wL[orderedList[i]].r = 0;
		i++;
	}
}

setup.basePreferencesMultipliers = [];
setup.basePreferencesMultipliers.foreplay = 1;
setup.basePreferencesMultipliers.oral = 1;
setup.basePreferencesMultipliers.fullsex = 3;
setup.basePreferencesMultipliers.talk = 1;
setup.basePreferencesMultipliers.useDick = 1.2;
setup.basePreferencesMultipliers.usePussy = 1.2;
setup.basePreferencesMultipliers.useAnus = 1;
setup.basePreferencesMultipliers.useBreasts = 1;
setup.basePreferencesMultipliers.useMouth = 1;
setup.basePreferencesMultipliers.useEyes = 1;
setup.basePreferencesMultipliers.useHands = 1;
setup.basePreferencesMultipliers.useLegs = 1;
setup.basePreferencesMultipliers.useTail = 1;
setup.basePreferencesMultipliers.targetDick = 1.2;
setup.basePreferencesMultipliers.targetPussy = 1.2;
setup.basePreferencesMultipliers.targetAnus = 1;
setup.basePreferencesMultipliers.targetBreasts = 1;
setup.basePreferencesMultipliers.targetMouth = 1;
setup.basePreferencesMultipliers.targetEyes = 1;
setup.basePreferencesMultipliers.targetHands = 1;
setup.basePreferencesMultipliers.targetLegs = 1;
setup.basePreferencesMultipliers.targetTail = 1;
setup.basePreferencesMultipliers.top = 1;
setup.basePreferencesMultipliers.bottom = 1;
setup.basePreferencesMultipliers.domination = 1;
setup.basePreferencesMultipliers.submission = 1;
setup.basePreferencesMultipliers.bondage = 1;
setup.basePreferencesMultipliers.teasing = 1;
setup.basePreferencesMultipliers.hypnosis = 1;
setup.basePreferencesMultipliers.draining = 1;
setup.basePreferencesMultipliers.charm = 1;
setup.basePreferencesMultipliers.romantic = 1;
setup.basePreferencesMultipliers.usePain = 0.7;
setup.basePreferencesMultipliers.receivePain = 0.7;
setup.basePreferencesMultipliers.denial = 0.7;
setup.basePreferencesMultipliers.position = 1;
setup.basePreferencesMultipliers.continuedAction = 1;

window.getFinalPreferenceWeight = function(charKey,pref) {
	var w = gC(charKey).tastes[pref].w * setup.basePreferencesMultipliers[pref];
	return w;
}

window.getFirstElementFromWeightedList = function(wList) {
	var chosenItem = undefined;
	
	for ( var item in wList ) {
		if ( chosenItem == undefined ) {
			if ( ( wList[item] != false ) && ( wList[item] instanceof weightedElement ) ) {
				chosenItem = wList[item].content;
			}
		} else {
			break;
		}
	}
	
	return chosenItem;
}

// Constructors, serializers, etc.
weightedElement.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

weightedElement.prototype.clone = function () {
	return (new weightedElement())._init(this);
};

weightedElement.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new weightedElement())._init($ReviveData$)', ownData);
};

weightedList.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

weightedList.prototype.clone = function () {
	return (new weightedList())._init(this);
};

weightedList.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new weightedList())._init($ReviveData$)', ownData);
};

////////// Standard empty list //////////

window.pseudoList = function() {
};

// Constructors, serializers, etc.
pseudoList.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

pseudoList.prototype.clone = function () {
	return (new pseudoList())._init(this);
};

pseudoList.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new pseudoList())._init($ReviveData$)', ownData);
};

////////// Maintenance //////////

window.getHotfixButton = function() {
	// This button will be used to apply hotfixes to saved games, when required. It may be found at the personal room screen.
	var bText = "\n\n"; //"\n\n<<l" + "ink [[Apply Hotfix|Personal Room]]>><<s" + "cript>>\n";
		//bText 	 += "applyHotfix();\n";
		//bText	 += "<</s" + "cript>><</l" + "ink>> Apply this hotfix at least once if you started this playthrough before version 0.2.10e.\n";
		bText	 += "<<l" + "ink [[Hotfix: Reset items, altered states and bodyparts|Personal Room]]>><<s" + "cript>>\n";
		bText 	 += "destroyAllAlteredStates(getActiveSimulationCharactersArray());\n";
		bText 	 += "fixEquipmentAndParts();\n";
		bText 	 += "unlockAllBodyparts(getActiveSimulationCharactersArray());\n";
		bText 	 += "resetStatModifiers();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>> This option unequips all items, finishes all altered states and resets the state of all bodyparts to 'free'. Use it only if the game throws an exception that prevents you from initiating a new day.\n"
	//var	bText	  = "\n\n<<l" + "ink [[Apply lag fix|Personal Room]]>><<s" + "cript>>\n";
	//	bText 	 += "applyLagFix();\n";
	//	bText	 += "<</s" + "cript>><</l" + "ink>>\n\n";
	 var bText = "";
	return bText;
}

window.applyHotfix = function() {
	gC("chMir").socialAi = new NpcSocialAi("chMir");
	gC("chNash").socialAi = new NpcSocialAi("chNash");
	gC("chClaw").socialAi = new NpcSocialAi("chClaw");
	gC("chVal").socialAi = new NpcSocialAi("chVal");
	gC("chAte").socialAi = new NpcSocialAi("chAte");
	
	State.variables.personalRoom.endDayEffects = function() {
		
		State.variables.personalRoom.autosavePossible = false;
		
		// New day
		State.variables.daycycle.addDays(1);
		for ( var character of getActiveSimulationCharactersArray() ) {
			gC(character).restoreBars(); // Energy bars
			gC(character).mood.resetMood(); // Moods
			
			gC(character).studiedScrollToday = false;
			
			gC(character).cbl = [];
		}
		
		// Set time
		State.variables.daycycle.hours = State.variables.simCycPar.templeNewDayTime;
		State.variables.daycycle.minutes = 0;
		
		// Level up stats
		for ( var character of getActiveSimulationCharactersArray() ) {
			//			for ( var stat of State.variables.baseStats ) {
			for ( var stat of setup.baseStats ) {
				if ( gC(character)[stat].tryLevelUp() ) {
					// Notify level up
					if ( character == "chPlayerCharacter" ) {
						this.newDayInfo += "Your " + stat + " has increased to " + gC(character)[stat].value + ".\n";
					}
				}
			}
			recalculateMaxBars(character);
			// State.variables[character].recalculateMaxBars();
		}
		
		// Relations and mood
		this.endDayRelationMoodEffects();

		// Daily sex checks
		for ( var character of getActiveSimulationCharactersArray() ) {
			if ( gC(character).hasOwnProperty("daysWithoutSex") ) {
				gC(character).daysWithoutSex += 1;
				gC(character).sexScenesToday = 0;
			}
			delete gC(character).dayTags;
		}

		// Infamy
		for ( var charKey of getActiveSimulationCharactersArray() ) {
			var infamyChange = ((gC(charKey).infamy - (gC(charKey).infamy % 10)) / 10 ) + 1;
			gC(charKey).changeInfamy(-infamyChange);
			if ( gC(charKey).globalAi.hasOwnProperty("attackedToday") ) {
				gC(charKey).globalAi.attackedToday = false;
			}
		}

		// Altered States
		for ( var charKey of getActiveSimulationCharactersArray() ) {
			for ( var as of gC(charKey).alteredStates ) {
				if ( as.scope == "days" ) {
					as.remainingDays--;
					if ( as.remainingDays <= 0 ) {
						as.flagRemove = true;
					}
				}
			}
			gC(charKey).cleanStates();
		}

		// Equipment
		for ( var equip of State.variables.equipmentList ) {
			if ( equip.days > 1 ) {
				equip.days--;
			} else if ( equip.days == 1 ) {
				unequipObject(equip.id);
			}
		}
				
		// Fix stats
		for ( var character of getActiveSimulationCharactersArray() ) {
			fixCharacterStatModifiers(character);
		}
		
		// Despawn merchants
		State.variables.currentMerchants = [];
	}
}

window.applyLagFix = function() {
	State.variables.compass.sisList = new pseudoList();
	State.variables.compass.lastSisId = -1;
	State.variables.compass.pcSis = -1;
	State.variables.compass.sisPassage = "";
	
	State.variables.compass.debugInfo = "";
}

window.fixEquipmentAndParts = function() {
	takeOffAllItems();
}

window.takeOffAllItems = function() {
	for ( var item of State.variables.equipmentList ) {
		unequipObject(item.id);
	}
}
window.finishAllRelationships = function() {
	for ( var char1 of getActiveSimulationCharactersArray() ) {
		for ( var char2 of getActiveSimulationCharactersArray() ) {
			if ( char1 != char2 ) {
				finishRelType(char1,char2);
			}
		}
	}
}
window.resetStatModifiers = function() {
	for ( var charKey of getActiveSimulationCharactersArray() ) {
		for ( var stat of getStatNamesArray() ) {
			gC(charKey)[stat].sumModifier = 0;
			gC(charKey)[stat].multModifier = 1;
		}
	}
}
window.resetRelationshipModifiers = function() {
	for ( var char1 of getActiveSimulationCharactersArray() ) {
		for ( var char2 of getActiveSimulationCharactersArray() ) {
			if ( char1 != char2 ) {
				for ( var stat of getRelationshipStatsNamesArray() ) {
					getRelation(char1,char2)[stat].levelMod = 0;
				}
			}
		}
	}
}
window.finishAllAlteredStates = function(charList) {
	for ( var cK of charList ) {
		removeCharsStates(cK);
	}
}
window.unlockAllBodyparts = function(charList) {
	for ( var cK of charList ) {
		for ( var part in gC(cK).body ) {
			if ( gC(cK).body[part] instanceof Bodypart ) {
				gC(cK).body[part].state = "free";
			}
		}
	}
}

window.takeOffAllBondage = function() {
	for ( var item of State.variables.equipmentList ) {
		if ( getEquipDataById(item.id).slotType == "bodypart" ) {
			unequipObject(item.id);
		}
	}
}

	// States
window.destroyAllAlteredStates = function(charList) {
	for ( var cK of charList ) {
		destroyCharsStates(cK);
	}
}
window.destroyCharsStates = function(charKey) {
	// Altered states are removed without removing their effects
	for ( var as of gC(charKey).alteredStates ) {
	}
	gC(charKey).alteredStates = [];
}

////////// BAR CLASS //////////

window.Bar = function(maxValue) {
	this.max = maxValue;
	this.current = maxValue;
	
	this.resistance = 0; // Reduces the damage against this bar
	this.weakness = 0; // Increases damage against this bar
	this.tainted = 0; // Increases the cost of using this bar
	
	this.accumulatedDamage = 0;
	
};

	// Bar related functions
	
window.applyBarDamage = function(target,bar,damage) {
	var msg = "";
	var overflow = 0;
	if ( bar == "lust" ) {
		gC(target).lust.attack(damage);
	} else {
		overflow = gC(target)[bar].attack(damage);
		gC(target).lust.attack(-overflow);
	}
	if ( overflow != 0 ) {
		msg = " The damage overflowed for " + textLustDamage(overflow) + ". ";
	}
	return msg;
}
window.applyBarDamageWithoutOverflow = function(target,bar,damage) {
	var msg = "";
	var overflow = 0;
	gC(target)[bar].attack(damage);
	if ( gC(target)[bar].current < 0 ) { gC(target)[bar].current = 0; }
	return msg;
}
window.applyBarPercentualDamage = function(target,bar,percent) {
	applyBarDamage(target,bar,-(gC(target)[bar].max*percent));
}

window.getBarPercentage = function(target,bar) {
	var pr = gC(target)[bar].current / gC(target)[bar].max;
	return pr;
}

// Bar methods
Bar.prototype.calculateCost = function(baseCost) {
		var modifier = this.tainted;
		if ( modifier < 0 ) {
			modifier = 0;
		}
		return (baseCost * ( 1 + (modifier * 0.01)));
	}
Bar.prototype.applyCost = function(baseCost) {
		var modifier = this.tainted;
		if ( modifier < 0 ) {
			modifier = 0;
		}
		this.changeValue(-baseCost * ( 1 + (modifier * 0.01)));
	}

Bar.prototype.changeValue = function(change) { // Use this function whenever it is desired to add to rest to the bar's current value.
		
		var overflow = 0;
		if ( -change > this.current ) { overflow = -change - this.current; }
		
		this.current += change; // Apply changes
		if (this.current > this.max) {
			this.current = this.max;
		} else if (this.current < 0) {
			// this.current = 0 ; // Removed to allow negative overflows
		}
		
		if ( change < 0 ) { // Accumulated damage
			this.accumulatedDamage -= change;
		}
		
		return overflow;
	}

Bar.prototype.attack = function(change) {
		var finalChange = change * (( 1 + ( this.weakness * 0.01 ) ) / ( 1 + this.resistance * 0.01 ));
		var overflow = this.changeValue(finalChange);
		return overflow;
	}
Bar.prototype.attackInConversation = function(change) {
		var finalChange = 0;
		if ( this.current >= this.max * 0.1 ) {
			finalChange = change * (( 1 + ( this.weakness * 0.01 ) ) / ( 1 + this.resistance * 0.01 ));
			this.changeValue(finalChange);
			if ( this.current < this.max * 0.1 ) {
				this.current = this.max * 0.1;
			}
		}
		return finalChange;
	}

Bar.prototype.restore = function() {
		this.current = this.max;
	}
Bar.prototype.deplete = function() {
		this.current = 0;
	}
Bar.prototype.cleanDamage = function() {
		this.accumulatedDamage = 0;
	}

// Constructors, serializers, etc.
Bar.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

Bar.prototype.clone = function () {
	return (new Bar())._init(this);
};

Bar.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Bar())._init($ReviveData$)', ownData);
};

////////// STAT CLASS //////////

// State.variables.baseStats = ["physique","agility","resilience","will","intelligence","perception","empathy","charisma","luck"];
setup.baseStats = ["physique","agility","resilience","will","intelligence","perception","empathy","charisma","luck"];

window.Stat = function() {
	this.value = 10;
	this.sumModifier = 0;
	this.multModifier = 1;
	this.experience = 0;
	this.affinity = 1.0; // Rate at which experience in gained.
};

window.fixStatModifiers = function(stat) {
	if ( stat.sumModifier > -0.001 && stat.sumModifier < 0.001 ) {
		stat.sumModifier = 0;
	}
	if ( stat.multModifier > 0.999 && stat.multModifier < 1.001 ) {
		stat.multModifier = 1;
	}
}
window.fixCharacterStatModifiers = function(charKey) {
	for ( var stat of getStatNamesArray() ) {
		fixStatModifiers(gC(charKey)[stat]);
	}
}
window.getTextStatExp = function(stat) {
	var text = "Experience: ";
	if ( stat.experience >= stat.getRequiredExp() ) {
		text += colorText("" + stat.experience.toFixed(0) + " / " + stat.getRequiredExp().toFixed(0),"limegreen");
	} else {
		text += stat.experience.toFixed(0) + " / " + stat.getRequiredExp().toFixed(0);
	}
	return text;
}
window.getTextStatAff = function(stat) {
	var text = "Affinity: " + stat.affinity.toFixed(2);
	return text;
}

// Stat Methods
Stat.prototype.addExperience = function(exp) {
		this.experience += exp * this.affinity;
	}

Stat.prototype.tryLevelUp = function() {
		var flagTryLevelUp = true;
		var flagLeveledUp = false;
		var requiredExp = this.getRequiredExp();
		
		while ( flagTryLevelUp == true ) {
			if ( this.experience >= requiredExp ) {
				flagLeveledUp = true;
				this.value++;
				this.experience -= requiredExp;
				requiredExp = this.getRequiredExp();
			}
			else {
				flagTryLevelUp = false;
			}
		}
		
		return flagLeveledUp;
	}

Stat.prototype.getRequiredExp = function() { // Returns the required exp to level up this stat
		return (this.value * 100);
	}
Stat.prototype.getValue = function() { // Returns the real value after modifiers are taken into account
		var result = (this.value + this.sumModifier) * this.multModifier;
		if ( result < 0 ) { result = 0; }
		return result;
	}

// Constructors, serializers, etc.
Stat.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

Stat.prototype.clone = function () {
	return (new Stat())._init(this);
};

Stat.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Stat())._init($ReviveData$)', ownData);
};

////////// BODYPART CLASS //////////

window.Bodypart = function(key,name) {
	this.key = key;
	this.name = name;
	this.state = "free";
	this.bondage = -1; // ID of equipped bondage
};

// Bodypart methods
Bodypart.prototype.textToUI = function() {
		var text = firstToCap(this.name) + ": ";
		
		if ( this.state == "inUse" ) {
			text += "In use";
		}
		else {
			text += firstToCap(this.state);
		}
		
		if ( this.bondage != -1 ) {
			text += " (" + '<span title="' + getEquipDataById(this.bondage).description + '">' + getEquipDataById(this.bondage).name + "</span>," + gC(getEquipById(this.bondage).owner).getFormattedName() + ")"; 
		}
	
		text += "\n";
		return text;
	}

// Constructors, serializers, etc.
Bodypart.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

Bodypart.prototype.clone = function () {
	return (new Bodypart())._init(this);
};

Bodypart.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Bodypart())._init($ReviveData$)', ownData);
};

////////// DRIVE CLASS //////////
// Side of a character's personality that determines their priorities. Drives as of 0.1:
// (self)improvement, pleasure, love, cooperation, domination and ambition

window.Drive = function(initialValue, initialLevel) {
	this.value = initialValue;
	this.level = initialLevel;
};

window.setDriveValues = function(drive,newValue,newLevel) {
	drive.level = newLevel;
	drive.value = newValue;
}
window.addPointsToDrive = function(drive,points) { // Positive or negative points. It calls the must be leveled function
	drive.value += points;
	driveChecksLevelChange(drive);
}
/*
//Padmiri's views have grown more favorable to self-improvement, domination, and ambition, and less favorable to cooperation.
Claw's views have grown more favorable to domination and ambition.//
<<s----cript>>
addPointsToDrive(gC("chMir").dCooperation,-100);
addPointsToDrive(gC("chClaw").dDomination,100);

Nashillbyir's views have grown more favorable to love and ambition.
<</s----cript>> \
*/
window.driveChecksLevelChange = function(drive) {
	if ( drive.level > 0 ) {
		if ( drive.value < formulaDriveLevelPoints(drive.level) ) {
			drive.level--;
		} else if ( drive.value > formulaDriveLevelPoints(drive.level + 1 ) ) {
			drive.level++;
		}
	} else {
		if ( drive.value > formulaDriveLevelPoints(drive.level + 1) ) {
			drive.level++;
		}
	}
}

window.formulaDriveLevelPoints = function(level) { // Returns the required points to get a given drive above the asked level
	// var formula = ( level * 200 ) + ( ( level * level ) * 50 );
	var formula = ( level * 175 ) + ( ( level * level ) * 15 );
	return formula;
	// 0 , 190 , 410 , 660 , 940 , 1250 , 1590
}

// getCharsDrivePercent at character-class.js

// Constructors, serializers, etc.
Drive.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
Drive.prototype.clone = function () {
	return (new Drive())._init(this);
};
Drive.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Drive())._init($ReviveData$)', ownData);
};

////////// MOOD CLASS //////////
// Set of parameters the determines the current mood of a given character

window.Mood = function() {
	this.friendly = 0;
	this.intimate = 0;
	this.flirty = 0;
	this.aroused = 0;
	this.dominant = 0;
	this.submissive = 0;
	this.bored = 0;
	this.angry = 0;	
}

window.getCharMood = function(character,mood) {
	return State.variables[character].mood[mood];
}

// Mood methods
Mood.prototype.applyChange = function(m,value) {
		var initialM = this[m];
		this[m] += value;
		if ( this[m] < 0 ) {
			this[m] = 0;
		} else if ( this[m] > 100 ) {
			this[m] = 100;
		}
		var difference = this[m] - initialM;
		return difference;
	}

Mood.prototype.resetMood = function() {
		this.friendly = 0;
		this.intimate = 0;
		this.flirty = 0;
		this.aroused = 0;
		this.dominant = 0;
		this.submissive = 0;
		this.bored = 0;
		this.angry = 0;
	}
Mood.prototype.createHtmlGraph = function() {
		var gText = createHorizontalGraph(25,150,[["lightgreen",this.friendly],["dodgerblue",this.intimate],["rosybrown",this.flirty],
					["crimson",this.aroused],["purple",this.dominant],["violet",this.submissive],["darkgray",this.bored],["red",this.angry]],
					this.createStatsText());
		return gText;
	}
Mood.prototype.createStatsText = function() {
		var t = "Friendly: " + this.friendly.toFixed(2) + "\n";
		t	 += "Intimate: " + this.intimate.toFixed(2) + "\n";
		t	 += "Flirty: " + this.flirty.toFixed(2) + "\n";
		t 	 += "Aroused: " + this.aroused.toFixed(2) + "\n";
		t 	 += "Dominant: " + this.dominant.toFixed(2) + "\n";
		t 	 += "Submissive: " + this.submissive.toFixed(2) + "\n";
		t 	 += "Bored: " + this.bored.toFixed(2) + "\n";
		t 	 += "Angry: " + this.angry.toFixed(2);
		return t;
	}
Mood.prototype.getTwoHighestMoods = function() {
		// I know I could have made a sort, I was tired ok
		var highMoods = [];
		for ( var m of ["friendly","intimate","flirty","aroused","dominant","submissive","bored","angry"] ) {
			if ( this[m] >= 20 ) {
				highMoods.push(m);
			}
		}
		var highestV = 0; // Highest Value
		var highestM = ""; // Highest Mood
		for ( var m of highMoods ) {
			if ( this[m] > highestV ) {
				highestM = m;
				highestV = this[m];
			}
		}
		var ndHighestV = 0;
		var ndHighestM = "";
		for ( var m of highMoods ) {
			if ( m != highestM && this[m] > ndHighestV ) {
				ndHighestM = m;
				ndHighestV = this[m];
			}
		}
		var results = [];
		if ( highestM != "" ) {
			results.push(highestM);
		}
		if ( ndHighestM != "" ) {
			results.push(ndHighestM);
		}
		return results;
	}

Mood.prototype.getUiText = function() {
		var uText = "";
		var moods = this.getTwoHighestMoods();
		if ( moods.length < 1 ) {
			uText += '<span style="color:darkgray"'+'>Neutral</'+'span>';
		} else if ( moods.length < 2 ) {
			uText += '<span style="color:darkgray"'+'>' + firstToCap(moods[0]) + '</' + 'span>';
		} else {
			uText += '<span style="color:darkgray"'+'>' + firstToCap(moods[0]) + ', ' + moods[1] + '</'+'span>';
		}
		uText += "\n" + this.createHtmlGraph();
		return uText;
	}

// Constructors, serializers, etc.
Mood.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
Mood.prototype.clone = function () {
	return (new Mood())._init(this);
};
Mood.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Mood())._init($ReviveData$)', ownData);
};
 

////////// VIRGINITY CLASS //////////
// Actions that begin vaginal or anal penetrative actions make take virginity checks
// If successful, this must send a message to scene, which must display this event

window.Virginity = function(type,name,enabled,taken) {
	this.type = type; // Bodypart key
	this.name = name; // Bodypart name
	this.enabled = enabled; // True/False
	this.taken = taken; // True/False
	this.taker = "";
	this.takerName = "";
	this.method = "";
	this.ctxt = ""; // Either "forced"/"given"/"bs" // Used to generate description in menu
}

window.provokeVirginityBonusRelationship = function(actor,target) {
	var description = "";
	if ( gC(actor).relations[target] != undefined ) {
		var multiplier1 = getVirginityRelationshipMultiplier(actor,target);
		var multiplier2 = getVirginityRelationshipMultiplier(target,actor);
		var ctxt = "";
		if ( State.variables.sc.sceneType == "ss" ) {
			if ( State.variables.sc.enabledLead == "fixed" && gC(target).hasLead == false ) {
				ctxt = "forced";
				// Target -> Actor: ++Sexual tension +Submission +Romance
				gC(target).relations[actor].sexualTension.stv += 400 * multiplier2;
				gC(target).relations[actor].submission.stv += 200 * multiplier2;
				gC(target).relations[actor].romance.stv += 200 * multiplier2;
				// Actor -> Target: +Sexual tension +Domination +Romance
				gC(actor).relations[target].sexualTension.stv += 100 * multiplier1;
				gC(actor).relations[target].domination.stv += 100 * multiplier1;
				gC(actor).relations[target].romance.stv += 100 * multiplier1;
				description = gC(actor).getFormattedName() + "'s and " + gC(target).getFormattedName() + "'s sexual tension and romance and " + gC(target).getFormattedName() + "'s submission have increased.";
			} else {
				ctxt = "given";
				// Target -> Actor: +++Romance +Sexual tension
				gC(target).relations[actor].sexualTension.stv += 200 * multiplier2;
				gC(target).relations[actor].romance.stv += 600 * multiplier2;
				// Actor -> Target: ++Romance +Sexual tension
				gC(actor).relations[target].sexualTension.stv += 100 * multiplier1;
				gC(actor).relations[target].romance.stv += 200 * multiplier1;
				description = gC(actor).getFormattedName() + "'s and " + gC(target).getFormattedName() + "'s romance and sexual tension have increased.";
			}
		} else if ( State.variables.sc.sceneType == "bs" ) {
			ctxt = "bs"; 
			// Target -> Actor: +++Rivalry
			gC(target).relations[actor].rivalry.stv += 400 * multiplier2;
			// Actor -> Target: +Rivalry
			gC(actor).relations[target].sexualTension.stv += 100 * multiplier1;
			description = gC(actor).getFormattedName() + "'s and " + gC(target).getFormattedName() + "'s rivalry has increased.";
		}
	}
	return description;
}
window.getVirginityRelationshipMultiplier = function(actor,target) {
	var multiplier = 10 + rLvlAbt(actor,target,"friendship") + rLvlAbt(actor,target,"romance") + rLvlAbt(actor,target,"sexualTension") + rLvlAbt(actor,target,"domination") + rLvlAbt(actor,target,"submission") + rLvlAbt(actor,target,"rivalry") + rLvlAbt(actor,target,"enmity");
	multiplier *= 0.1;
	return multiplier;
}

window.checkCharsVirginityExists = function(charKey,type) {
	var flag = true;
	var virginity = gC(charKey).virginities[type];
	if ( virginity != undefined ) {
		if ( virginity.taken) {
			flag = false;
		}
	}
	return flag;
}

window.destroyCharsVirginitiesNoFlavor = function(chKey) {
	for ( var vir in gC(chKey).virginities ) {
		gC(chKey).virginities[vir].taken = true;
	}
}

// Class methods
Virginity.prototype.assignTaker = function(taker,method) {
		this.taken = true;
		this.taker = taker;
		this.method = method;
	}
Virginity.prototype.clean = function() {
		this.taken = false;
		this.taker = "";
		this.method = "";
	}
Virginity.prototype.tryTakeVirginity = function(taker,method,description) {
		if ( this.enabled && this.taken == false ) {
			this.taken = true;
			this.taker = taker;
			this.takerName = gC(taker).name;
			this.method = method;
			if ( State.variables.sc.sceneType == "ss" ) {
				if ( State.variables.sc.enabledLead == "fixed" && gC(taker).hasLead == true ) {
					this.ctxt = "forced";
				} else {
					this.ctxt = "given";
				}
			} else if ( State.variables.sc.sceneType == "bs" ) {
				this.ctxt = "bs"; 
			}
			State.variables.sc.importantMessages += description + "\n";
		}
	}

// Constructors, serializers, etc.
Virginity.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

Virginity.prototype.clone = function () {
	return (new Virginity())._init(this);
};

Virginity.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Virginity())._init($ReviveData$)', ownData);
};

////////// POSITION CLASS //////////

window.Position = function() {
	this.key = "free";
	this.name = "Free";
	this.type = "free";
	this.description = "";
	
	this.cAction = null; // If it's a battle position, it may have a continued action
};

window.areCharactersPositionsConnected = function(charA,charB) {
	var flagAreConnected = false;
	if ( gC(charA).position.type == "active" ) {
		if ( gC(charA).position.targetsList.includes(charB) ) { flagAreConnected = true; }
	}
	else if ( gC(charA).position.type == "passive" ) {
		if ( gC(charA).position.initiator == charB ) { flagAreConnected = true; }
	}
	return flagAreConnected;
}

window.findAllConnectedCharsByPositionMinusList = function(charKey,excludedList) {
	var charList = [charKey];
	// Initiator
	var initiator = gC(charKey).position.initiator;
	if ( initiator != undefined ) {
		if ( excludedList.includes(initiator) == false && charList.includes(initiator) == false ) {
			charList = charList.concat(findAllConnectedCharsByPositionMinusList(initiator,charList));
		}
	}
	// TargetsList
	var targetsList = gC(charKey).position.targetsList;
	if ( targetsList != undefined ) {
		for ( var cK of targetsList ) {
			if ( charList.includes(cK) == false && excludedList.includes(cK) == false ) {
				charList = charList.concat(findAllConnectedCharsByPositionMinusList(cK,charList));
			}
		}
	}
	// SecondaryInitiators
	var secondaryInitiators = gC(charKey).position.secondaryInitiators;
	if ( secondaryInitiators != undefined ) {
		for ( var cK of secondaryInitiators ) {
			if ( charList.includes(cK) == false && excludedList.includes(cK) == false ) {
				charList = charList.concat(findAllConnectedCharsByPositionMinusList(cK,charList));
			}
		}
	}
	
	return charList;
}

// Position methods
Position.prototype.makeActive = function(targetsList) {
		this.type = "active";
		this.targetsList = targetsList;
	}
Position.prototype.makePassive = function(initiator) {
		this.type = "passive";
		this.initiator = initiator;
	}

Position.prototype.makePassiveSecondaryInitiators = function(initiator,secondaryInitiators) {
		this.type = "passive";
		this.initiator = initiator;
		this.secondaryInitiators = secondaryInitiators; // List
	}

Position.prototype.free = function() {
		if ( this.cAction != null ) {
			this.cAction.freeBodyparts();;
			this.cAction = null;
		}
		switch(this.type) {
			case "active":
				this.key = "free";
				this.name = "Free";
				this.type = "free";
				this.description = "";
				delete this.targetsList;
				break;
			case "passive":
				this.key = "free";
				this.name = "Free";
				this.type = "free";
				this.description = "";
				delete this.initiator;
				if ( this.hasOwnProperty('secondaryInitiators') ) {
					delete this.secondaryInitiators;
				}
				break;
		}
	}

// Constructors, serializers, etc.
Position.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

Position.prototype.clone = function () {
	return (new Position())._init(this);
};

Position.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Position())._init($ReviveData$)', ownData);
};

////////// FLAVOR AFFINITIES CLASS //////////

window.flavorAffinities = function() {
	// Sex
	this.sex = new flavorAffinity("sex");
	this.pounce = new flavorAffinity("pounce");
	for ( var type of ["Dick","Pussy","Ass","Mouth","Breasts","Eyes","Neck","Arms","Legs"] ) {
		var typeA = "use" + type;
		var typeB = "target" + type;
		this[typeA] = new flavorAffinity(typeA);
		this[typeB] = new flavorAffinity(typeB);
	}
	
	this.weapon = new flavorAffinity("weapon");
	
	this.drain = new flavorAffinity("drain");
	
	// Physical
	this.physical = new flavorAffinity("physical");
	this.kick = new flavorAffinity("kick");
	
	this.pain = new flavorAffinity("pain");
	
	// Magic
	this.magic = new flavorAffinity("magic");
	this.fire = new flavorAffinity("fire");
	this.ice = new flavorAffinity("ice");
	this.thunder = new flavorAffinity("thunder");
	this.holy = new flavorAffinity("holy");
	
	// Social
	this.social = new flavorAffinity("social");
	this.seduction = new flavorAffinity("seduction");
	this.taunt = new flavorAffinity("taunt");
	this.hypnosis = new flavorAffinity("hypnosis");
	
	// Others
	this.spore = new flavorAffinity("spore");
}

// Constructors, serializers, etc.
flavorAffinities.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

flavorAffinities.prototype.clone = function () {
	return (new flavorAffinities())._init(this);
};

flavorAffinities.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new flavorAffinities())._init($ReviveData$)', ownData);
};

////////// FLAVOR AFFINITY CLASS //////////

window.flavorAffinity = function(type) {
	this.type = type;
	this.strength = 0; // Scales up power of moves used
	this.frailty = 0; // Scales down power of moves used
	this.resistance = 0; // Scales down power of moves used against
	this.weakness = 0; // Scales up power of moves used against
}

// Constructors, serializers, etc.
flavorAffinity.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

flavorAffinity.prototype.clone = function () {
	return (new flavorAffinity())._init(this);
};

flavorAffinity.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new flavorAffinity())._init($ReviveData$)', ownData);
};

////////// ALTERED STATE CLASS //////////

window.alteredState = function(title,acr,scope,turns,provokeEffect,cancelEffect,description) {
	this.title = title;
	this.type = "none";
	this.acr = acr;
	this.scope = scope; // "scene", "days" or "equipment"
	this.remainingTurns = turns;
	this.provokeEffect = provokeEffect;
	this.cancelEffect = cancelEffect;
	this.description = description;
	this.remainingDays = -1; // If something other than -1, modify outside of constructor
	// this.turnEffect = function(character) -> Property added outside of constructor
	
	this.flagRemove = false;
}

window.applyAlteredState = function(charKeysList,alteredState) {
	for ( var charKey of charKeysList ) {
		gC(charKey).alteredStates.push(alteredState);
		alteredState.provokeEffect(charKey);
	}
}
window.removeAlteredStateByAcr = function(charKey,acr) {
	for ( var as of gC(charKey).alteredStates ) {
		if ( as.acr == acr ) {
			as.flagRemove = true;
		}
	}
	gC(charKey).cleanStates();
}
window.removeAlteredStateByAcrAndExtra = function(charKey,acr,extraProperty,propertyValue) {
	for ( var as of gC(charKey).alteredStates ) {
		if ( as.acr == acr ) {
			if ( as.hasOwnProperty(extraProperty) ) {
				if ( as[extraProperty] == propertyValue ) {
					as.flagRemove = true;
				}
			}
		}
	}
	gC(charKey).cleanStates();
}
window.getAsTurnEffect = function(as) {
	var te = null;
	if ( as.hasOwnProperty("turnEffect") ) {
		te = as.turnEffect;
	}
	return te;
}

window.doesCharHaveAlteredState = function(charKey,acr) {
	var flag = false;
	for ( var as of gC(charKey).alteredStates ) {
		if ( as.acr == acr ) { flag = true; }
	}
	return flag;
}

// Constructors, serializers, etc.
alteredState.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

alteredState.prototype.clone = function () {
	return (new alteredState())._init(this);
};

alteredState.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new alteredState())._init($ReviveData$)', ownData);
};




window.img = function(imageKey) {
	return State.variables.imgList[imageKey];
};

////////// CHARACTER CLASS //////////
window.Character = function(name, varName) {
	this.name = name || "noName";
	this.varName = varName || "BEWARE: THIS MUST BE DECLARED!";
	this.nameColor = "lightcyan";
	this.formattedName = '<span style="color:'+this.nameColor+'">'+this.name+'</span>';
	
	this.names = [ this.getName() , this.getName() , this.getName() ];
	
	this.type = "default";
	
	this.aiAlgorythm = 0;
	
	this.race = "human";
	
	// Currencies
	this.merit = 0;
	this.money = 0; // Veerens, silver coins
	this.infamy = 0;
	
	// Base stats
	this.physique = new Stat();
	this.agility = new Stat();
	this.resilience = new Stat();
	this.will = new Stat();
	this.intelligence = new Stat();
	this.perception = new Stat();
	this.empathy = new Stat();
	this.charisma = new Stat();
	this.luck = new Stat();
	
	// Bars
	this.lust = new Bar(100);
	this.willpower = new Bar(100);
	this.energy = new Bar(100);
	this.socialdrive = new Bar(100);
	
	// Group
	this.followingTo = "";
	this.followedBy = [];
	
	this.startedFollowingAt = []; // First element = hours, Second Element = minutes
	this.followingForDebt = false;
	
	// Lead
	this.lead = 50;
	this.leadMultiplier = 1.0;
	this.hasLead = false;
	// Position
	this.position = new Position();
	
	// Control
	this.control = 5;
	this.maxControl = 5;
	this.controlRecovery = 0.5;
	this.lostControlTurns = 0;
	
	// Combat type affinities
	this.combatAffinities = new flavorAffinities();
	
	// Altered states
	this.alteredStates = [];
	
	// Images
	this.fullPortrait = null; // If it exists, it must be returned from a function
	this.avatar = null; // If it exists, it must be returned from a function
	this.icon = function() {
		return "[img[img/charIcons/npcIcon.png]]";
	}
	
	this.fullPortraitL = null;
	this.avatarL = null;
	
	this.originalAvatar = null;
	this.originalPortrait = null;
	
	// Bodyparts list
	this.body = { 
		eyes : new Bodypart("eyes","eyes"),
		mouth : new Bodypart("mouth","mouth"),
		arms : new Bodypart("arms","arms"),
		legs : new Bodypart("legs","legs"),
		neck : new Bodypart("neck","neck")
	};

	// Drives
	this.dImprovement = new Drive(0,0);
	this.dPleasure = new Drive(0,0);
	this.dLove = new Drive(0,0);
	this.dCooperation = new Drive(0,0);
	this.dDomination = new Drive(0,0);
	this.dAmbition = new Drive(0,0);
	
	// Relations and mood
	this.relations = new Relations();
	
	this.mood = new Mood();
	this.baseMood = new Mood(); // State towards which a character's mood gravitates. 
	
	this.domChar = null; // Character that this character has a submissive relationship with
	this.subChars = []; // Characters that this character has dominant relationships with
	this.egaChars = []; // Characters that this character has egalitarian relationships with
	
	this.cbl = []; // Casus belli list: targets that actor may attack for no infamy cost
	
	// Misc. info
	this.daysWithoutSex = 0;
	this.sexScenesToday = 0;
	
	this.likedTopics = [];
	
	this.availableSocialInteractions = true; // If false, it isn't possible to begin dynamic social interactions with a given character
	
	// Virginities list
	this.virginities = {
		pussy : new Virginity("pussy","Vaginal",true,false),
		anal : new Virginity("anus","Anal",true,false),
		dick : new Virginity("dick","Penile",true,false)
	};
		
	// Orgasms
	this.orgasmCounter = 0;
	this.orgasmSceneCounter = 0;
	this.ruinedOrgasmSceneCounter = 0;
	this.mindblowingOrgasmSC = 0;
	
	this.turnPrefTags = [];
	
	this.koed = false; // Flag: has the character been defeated in the current battle
	
	// Known moves
	this.saList = ["doNothing","struggle"];
	
	// Known extra social actions
	this.extraSocIntList = [];
	
	// Others
	this.getRandomName = function() {
		return randomFromList(this.names);
	}
	this.getFRName = function() { // Formatted Random Name '<span style="color:'+this.nameColor+'">'+this.name+'</span>';
		var formattedName = '<span style="color:' + this.nameColor + '">'
						  + ftc(this.getRandomName()) + '</span>';
		return formattedName;
	}
	this.stdName = function() { // Standard Name, refers to the currently considered standard method of dynamically refering to a character.
		return this.getFRName();
	}
	
	this.setNameColor = function(colorKey) {
		this.nameColor = colorKey;
		this.formattedName = '<span style="color:'+this.nameColor+'">'+this.name+'</span>';
	}
	
	this.speechColor = "lavenderblush";
	this.colorStyleKey = 'color: '+this.speechColor;
	
	// this.turnTags = []; // Added and gotten by functions, see below Character class. These are labels that only last for the duration of a scene turn
	
	// Personality
	this.tastes = createPreferencesWeightedList();
	
		// Pronouns
	this.perPr = "it"; // Personal pronoun
	this.comPr = "it"; // Personal pronoun as complement
	this.refPr = "itself"; // Reflexive pronoun
	this.posPr = "its"; // Possessive pronoun
	this.inPosPr = "its"; // Independent Possessive

	// Maps
	this.currentRoom = ""; // Key refering to the room the character is currently placed at. If no map is active, this should be equal to "".
	
	this.refugeRooms = []; // List of 2-element arrays. First element is map key, second element is room key.
	this.getRefugeRoomInMap = function() {
		var room = "none";
		var cMapName = State.variables.compass.currentMap;
		for ( var rr of this.refugeRooms ) {
			if ( rr[0] == cMapName ) {
				room = rr[1];
			}
		}
		return room;
	}
	
	// Scrolls
	this.foundScrolls = [];
	this.studiedScrolls = [];
	
	this.studiedScrollToday = false;
	
	// Equipment
	this.ownedEquipment = []; // List of owned equipment's IDs.
	this.weaponID = -1; // ID of equipped weapon.
	
	// AI
	this.mapAi = new NpcMapAi(this.varName);
	this.sisAi = new NpcSisAi(this.varName);
	this.globalAi = new NpcGlobalAi(this.varName);
	this.socialAi = new NpcSocialAi(this.varName);
	
	// System
	this.wasPromptedInCurrentSisRound = false;
};

// More character methods
Character.prototype.getName = function() { return this.name; };
Character.prototype.getFormattedName = function() { return this.formattedName; };
Character.prototype.changeMerit = function(value) {
		this.merit += value;
		if ( this.merit < 0 ) {
			this.merit = 0;
		}
	}
Character.prototype.changeInfamy = function(value) {
		this.infamy += value;
		if ( this.infamy < 0 ) {
			this.infamy = 0;
		}
	}

Character.prototype.cleanStates = function() {
		var newAlteredStates = [];
		for ( var as of this.alteredStates ) {
			if ( as.flagRemove == false ) {
				newAlteredStates.push(as);
			} else {
				as.cancelEffect(this.varName);
			}
		}
		this.alteredStates = newAlteredStates;
	}
Character.prototype.removeSpecificState = function(stateAcr) {
	var anyStateRemoved = false; // The function returns true if any altered state gets finished.
	var newAlteredStates = [];
	for ( var as of this.alteredStates ) {
		if ( as.acr != stateAcr ) {
			newAlteredStates.push(as);
		} else {
			as.cancelEffect(this.varName);
			anyStateRemoved = true;
		}
	}
	this.alteredStates = newAlteredStates;
	return anyStateRemoved;
}
window.doesCharHaveState = function(cK,stateAcr) {
	var hasState = false;
	for ( var as of gC(cK).alteredStates ) {
		if ( as.acr != stateAcr ) {
			hasState = true;
		}
	}
	return hasState;
}

Character.prototype.addBodypart = function(key,name) {
		this.body[key] = new Bodypart(key,name);
	}
Character.prototype.removeBodypart = function(key) {
		delete this.body[key];
	}
Character.prototype.addFemaleParts = function() {
		this.addBodypart("breasts","breasts");
		this.addBodypart("pussy","pussy");
		this.addBodypart("anus","anus");
	}
Character.prototype.addMaleParts = function() {
		this.addBodypart("dick","dick");
		this.addBodypart("anus","anus");
	}
	
Character.prototype.hasFreeBodypart = function(part) {
		var flag = false;
		
		if ( this.body.hasOwnProperty(part) ) {
			if ( this.body[part].state == "free" ) {
				flag = true;
			}
		}
		
		return flag;
	}
	
Character.prototype.lockBodypart = function(part) {
		if ( this.body.hasOwnProperty(part) ) {
			if ( this.body[part].state == "free" ) {
				this.body[part].state = "locked";
			}
		}
	}
Character.prototype.freeBodypart = function(part) {
		if ( this.body.hasOwnProperty(part) ) {
			if ( this.body[part].state == "locked" ) {
				this.body[part].state = "free";
			}
		}
	}
	
Character.prototype.applyRelationVector = function(target,relationVector) {
		// Applies the values of a relation vector as changes to the character's relation with the target
		this.relations[target].friendship.stv += relationVector.friendship;
		this.relations[target].sexualTension.stv += relationVector.sexualTension;
		this.relations[target].romance.stv += relationVector.romance;
		this.relations[target].domination.stv += relationVector.domination;
		this.relations[target].submission.stv += relationVector.submission;
		this.relations[target].rivalry.stv += relationVector.rivalry;
		this.relations[target].enmity.stv += relationVector.enmity;
		
		return relationVector;
	}
Character.prototype.applyMoodVector = function(moodVector) {
		// Applies the values of a mood vector as changes to the character's mood
		// Real changes to the mod are returned
		var realChanges = new MoodVector(0,0,0,0,0,0,0,0);
		
		realChanges.friendly = this.mood.applyChange("friendly",moodVector.friendly);
		realChanges.intimate = this.mood.applyChange("intimate",moodVector.intimate);
		realChanges.flirty = this.mood.applyChange("flirty",moodVector.flirty);
		realChanges.aroused = this.mood.applyChange("aroused",moodVector.aroused);
		realChanges.dominant = this.mood.applyChange("dominant",moodVector.dominant);
		realChanges.submissive = this.mood.applyChange("submissive",moodVector.submissive);
		realChanges.bored = this.mood.applyChange("bored",moodVector.bored);
		realChanges.angry = this.mood.applyChange("angry",moodVector.angry);
		
		return realChanges;
	}
Character.prototype.applyMoodyMoodVector = function(moodVector) {
		// Applies the values of a mood vector as changes to the character's mood
		// Real changes to the mod are returned
		// With this function, the target's anger reduces some mood effects, and friendliness and intimacy reduce anger
		var realChanges = new MoodVector(0,0,0,0,0,0,0,0);
		var moodyMoodVector = new MoodVector( (moodVector.friendly * (200 - this.mood.angry - this.mood.bored) * 0.005) ,
		(moodVector.intimate * (200 - this.mood.angry - this.mood.bored) * 0.005) , (moodVector.flirty * (200 - this.mood.angry - this.mood.bored) * 0.005) ,
		(moodVector.aroused * (200 - this.mood.angry - this.mood.bored) * 0.005), moodVector.dominant , moodVector.submissive , moodVector.bored ,
		(moodVector.angry * (200 - this.mood.friendly - this.mood.intimate) * 0.005) );
		
		realChanges.friendly = this.mood.applyChange("friendly",moodyMoodVector.friendly);
		realChanges.intimate = this.mood.applyChange("intimate",moodyMoodVector.intimate);
		realChanges.flirty = this.mood.applyChange("flirty",moodyMoodVector.flirty);
		realChanges.aroused = this.mood.applyChange("aroused",moodyMoodVector.aroused);
		realChanges.dominant = this.mood.applyChange("dominant",moodyMoodVector.dominant);
		realChanges.submissive = this.mood.applyChange("submissive",moodyMoodVector.submissive);
		realChanges.bored = this.mood.applyChange("bored",moodyMoodVector.bored);
		realChanges.angry = this.mood.applyChange("angry",moodyMoodVector.angry);
		
		return realChanges;
	}
Character.prototype.restoreMood = function() {
		this.mood.friendly = this.baseMood.friendly;
		this.mood.intimate = this.baseMood.intimate;
		this.mood.flirty = this.baseMood.flirty;
		this.mood.aroused = this.baseMood.aroused;
		this.mood.dominant = this.baseMood.dominant;
		this.mood.submissive = this.baseMood.submissive;
		this.mood.bored = this.baseMood.bored;
		this.mood.angry = this.baseMood.angry;
	}
Character.prototype.applyMoodDecay = function() {
		var decayMult = 0.02;
		this.mood.friendly -= (this.mood.friendly - this.baseMood.friendly) * decayMult;
		this.mood.intimate -= (this.mood.intimate - this.baseMood.intimate) * decayMult;
		this.mood.flirty -= (this.mood.flirty - this.baseMood.flirty) * decayMult;
		this.mood.aroused -= (this.mood.aroused - this.baseMood.aroused) * decayMult;
		this.mood.dominant -= (this.mood.dominant - this.baseMood.dominant) * decayMult;
		this.mood.submissive -= (this.mood.submissive - this.baseMood.submissive) * decayMult;
		this.mood.bored -= (this.mood.bored - this.baseMood.bored) * decayMult;
		this.mood.angry -= (this.mood.angry - this.baseMood.angry) * decayMult;
	}
	
Character.prototype.getIsAvailableForSocialInteractions = function(initiator) {
		var flagAvailable = this.availableSocialInteractions;
		if ( this.followingTo != "" && this.followingTo != initiator ) {
			if ( State.variables.compass.findFirstSisIdInvolvingCharacter(this.varName) == -1 ) {
				flagAvailable = false;
			}
		}
		return flagAvailable;
	}
	
Character.prototype.makeVirginitiesUnknown = function() {
		for ( var virginity in this.virginities ) {
			this.virginities[virginity].taken = true;
			this.virginities[virginity].taker = "unknown";
			this.virginities[virginity].method = "unknown";
		}
	}

Character.prototype.setSpeechColor = function(colorKey) {					// SET SPEECH COLOR
		this.speechColor = colorKey;
		this.colorStyleKey = 'color: '+this.speechColor;
	}
	
Character.prototype.setColors = function(nameColor,speechColor) {
		this.setNameColor(nameColor);
		this.setSpeechColor(speechColor);
	}
	
Character.prototype.setBaseAttributes = function(ph,ag,re,wi,nt,pe,em,ch,lu) {
		this.physique.value = ph;
		this.agility.value = ag;
		this.resilience.value = re;
		this.will.value = wi;
		this.intelligence.value = nt;
		this.perception.value = pe;
		this.empathy.value = em;
		this.charisma.value = ch;
		this.luck.value = lu;
	}
Character.prototype.setAffinities = function(ph,ag,re,wi,nt,pe,em,ch,lu) {
		this.physique.affinity = ph;
		this.agility.affinity = ag;
		this.resilience.affinity = re;
		this.will.affinity = wi;
		this.intelligence.affinity = nt;
		this.perception.affinity = pe;
		this.empathy.affinity = em;
		this.charisma.affinity = ch;
		this.luck.affinity = lu;
	}
Character.prototype.adjustAttributes = function(statVariance,statBuff) {
	for ( var st of getStatNamesArray() ) {
		this[st].value += limitedRandomInt(statVariance) + statBuff;
	}
}

Character.prototype.cleanAccumulatedDamages = function() {
		this.lust.cleanDamage();
		this.willpower.cleanDamage();
	}
	
Character.prototype.tryOrgasm = function() {
		var overflow = -1;
		var type = "none";
		if ( this.lust.current <= 0 ) {
			overflow = -this.lust.current;
			this.orgasmCounter++;
			if ( isCharsOrgasmRuined(this.varName) == false ) { 
				if ( isOrgasmMindblowing(this.varName) ) {		// Mindblowing
					this.mindblowingOrgasmSC++;
					this.lust.current = this.lust.max;
					this.willpower.changeValue(-this.willpower.max * 0.2);
					type = "mindblowing";
				} else {										// Normal orgasm
					this.orgasmSceneCounter++;
					this.lust.current = this.lust.max;
					type = "normal";
				}
			} else { 											// Ruined orgasm
				this.ruinedOrgasmSceneCounter++;
				this.lust.current = this.lust.max * 0.80;
				this.energy.changeValue(-this.energy.max * 0.1);
				this.willpower.changeValue(-this.willpower.max * 0.1);
				this.socialdrive.changeValue(-this.socialdrive.max * 0.1);
				type = "ruined";
				if ( limitedRandomInt(100) > 30 ) {
					this.tastes.denial.w += limitedRandomInt(4);
				}
			}
		}
		
		return [overflow,type];
	}
Character.prototype.getAllSceneOrgasms = function() {
	var orgasms = this.orgasmSceneCounter + this.ruinedOrgasmSceneCounter + this.mindblowingOrgasmSC;
	return orgasms;
}
Character.prototype.influenceSexPrefs = function(probability,intensity) {
	for ( var tag of this.turnPrefTags ) {
		if ( probability > limitedRandomInt(100) ) {
			this.tastes[tag].w += intensity;
		}
	}
}
		
	// Text message functions
	
Character.prototype.textBars = function() { // Bars
		var text = "";
		if ( this.koed ) {
			text += colorText("KO","darkgray") + "\n";
		} else {
			// Lead
			if ( State.variables.sc.enabledLead == "dynamic" ) {
				if ( doesCharHaveSceneTag(this.varName,"noLead") ) {
					text += '<span style="color:darkgray">Lead disabled\n</span>'
				} else {
					text += this.textLeadBar() + "\n";
				}
			}
			else if ( State.variables.sc.enabledLead == "fixed" && this.hasLead == true ) {
				text += '<span style="color:darkgray"'+'>Leading</'+'span>'+'\n';
			}
			
			// Control
			if ( State.variables.sc.flagSceneActive && State.variables.sc.sceneType == "bs" ) {
				text += this.textControlBar() + "\n";
			}

			// Altered States
			if ( this.alteredStates.length > 0 ) {
				text += this.textAlteredStates() + "\n";
			}
			
			// Position
			if ( this.position.key != "free" ) {
				text += '<span style="color:darkgray"'+'>' + this.position.name + '</'+'span>'+'\n';
			}
		}
		// Lust
		text += img("lust") + ' <span style="color:lightcoral">Lust:</span>';
		if ( this.lust.current == this.lust.max ) {
		text += this.lust.current.toFixed(0); } else {
		text += this.lust.current.toFixed(2); }
		text += "/" + this.lust.max.toFixed(0) + "\n";
		// Willpower
		text += img("willpower") + ' <span style="color:darkslateblue">Willpower:</span>';
		if ( this.willpower.current == this.willpower.max ) {
		text += this.willpower.current.toFixed(0); } else {
		text += this.willpower.current.toFixed(2); }
		text += "/" + this.willpower.max.toFixed(0) + "\n";
		// Energy
		text += img("energy") + ' <span style="color:limegreen">Energy:</span>';
		if ( this.energy.current == this.energy.max ) {
		text += this.energy.current.toFixed(0); } else {
		text += this.energy.current.toFixed(2); }
		text += "/" + this.energy.max.toFixed(0) + "\n";
		// Social Drive
		text += img("socialdrive") + ' <span style="color:khaki">Social Drive:</span>';
		if ( this.socialdrive.current == this.socialdrive.max ) {
		text += this.socialdrive.current.toFixed(0); } else {
		text += this.socialdrive.current.toFixed(2); }
		text += "/" + this.socialdrive.max.toFixed(0) + "\n";
		return text;
	}

Character.prototype.textStats = function() {
		var text = "";
		var descriptions = [ getPhysiqueDescription() , getAgilityDescription() , getResilienceDescription() , getWillDescription() , getIntelligenceDescription() , getPerceptionDescription() , getEmpathyDescription() , getCharismaDescription() , getLuckDescription() ];
		var i = 0;
		for ( var cStat of getStatNamesArray() ) {
			var statName = '<span title="' + descriptions[i] + '">' + firstToCap(cStat) + "</span>";
			if ( this[cStat].getValue() < this[cStat].value ) {
				text += statName + ": " + colorText(this[cStat].getValue().toFixed(1),"red") + " (" + this[cStat].value.toFixed(0) + ")";
			} else if ( this[cStat].getValue() > this[cStat].value ) {
				text += statName + ": " + colorText(this[cStat].getValue().toFixed(1),"green") + " (" + this[cStat].value.toFixed(0) + ")";
			} else {
				text += statName + ": " + this[cStat].getValue().toFixed(0);
			}
			if ( cStat != "luck" ) {
				text += "\n";
			}
			i++;
		}
		return text;
	}
Character.prototype.textLeadBar = function() {
		var text = '<span style="color:darkgray">Lead: </span>' + this.lead.toFixed(2) + " / 100";
		if ( this.hasLead == true ) {
			text += '<span style=' + '"color:darkgray"' + '> Leading</span>';
		}
		return text;
	}
Character.prototype.textControlBar = function() {
		var text = '<span style="color:darkgray">Control: </span>';
		if ( this.control == this.maxControl ) {
			text += this.control + "/" + this.maxControl;
		} else {
			text += this.control.toFixed(2) + "/" + this.maxControl;
			if ( this.control <= 0 ) {
				if ( this.position.type != "passive" ) {
					text += " TR: " + this.lostControlTurns;
				} else {
					text += " Locked";
				}
			}
		}

		return text;
	}
Character.prototype.textAlteredStates = function() {
		var text = '<span style="color:darkgray">';
		var i = 0;
		for ( var as of this.alteredStates ) {
			if ( i > 0 ) { text += ", "; }
			var tooltip = as.title + ": " + as.description; // + "\nRemaining turns: " + as.remainingTurns;
			if ( as.scope == "scene" ) {
				tooltip += "\nRemaining turns: " + as.remainingTurns.toFixed(1);
			} else if ( as.scope == "days" ) {
				tooltip += "\nRemaining days: " + as.remainingDays.toFixed(1);
			}
			var asText = "<span title='" + tooltip + "'>" + as.acr + "</" + "span>";
			text += asText;
			i++;
		}
		text += '</span>';
		return text;
	}

Character.prototype.textLustBar = function() {
		var imgLust = img("lust");
		return ( imgLust + ' <span style="color:lightcoral">Lust: </span>' + this.lust.current.toFixed(2) + "/" + this.lust.max.toFixed(0) );
	}
	
Character.prototype.lustBarText = function() {
		var imgLust = img("lust");
		return ( imgLust + ' <span style="color:lightcoral">Lust: </span>' + this.lust.current.toFixed(2) + "/" + this.lust.max.toFixed(0) );
	}
Character.prototype.textWillpowerBar = function() {
		return ( img("willpower") + ' <span style="color:darkslateblue">Willpower: </span>' + this.willpower.current.toFixed(2) + "/" + this.willpower.max.toFixed(0) );
	}
Character.prototype.willpowerBarText = function() {
		return ( img("willpower") + ' <span style="color:darkslateblue">Willpower: </span>' + this.willpower.current.toFixed(2) + "/" + this.willpower.max.toFixed(0) );
	}
	
Character.prototype.textAccumulatedDamages = function() { // Accumulated Damage
		var text = this.name + ": ";
		if ( this.lust.accumulatedDamage > 0 ) {
			text += "Lust: " + this.lust.accumulatedDamage.toFixed(2) + ", ";
		}
		if ( this.willpower.accumulatedDamage > 0 ) {
			text += "Willpower: " + this.willpower.accumulatedDamage.toFixed(2) + ", ";
		}
		text += ";";
		return text;
	}
	
Character.prototype.textBodyparts = function() { // Bodyparts
		var text = "";
		
		var bpList = ["pussy","dick","anus","breasts","mouth","eyes","neck","arms","legs","tail"];
		for ( var part of bpList ) {
			if ( this.body.hasOwnProperty(part) ) {
				text += this.body[part].textToUI();
			}
		}
		
		return text;
	}
	
Character.prototype.textRelationshipWithPlayer = function() {
	var text = "";
	if ( this.varName != "chPlayerCharacter" ) {
		if ( this.relations["chPlayerCharacter"] != undefined && gC("chPlayerCharacter").relations[this.varName] != undefined ) {
			text += "\n\n__Relationship towards/by the player__\n";
			text += rLvlAbt(this.varName,"chPlayerCharacter","friendship") + " / Friendship / " + rLvlAbt("chPlayerCharacter",this.varName,"friendship") + "\n"
				  + rLvlAbt(this.varName,"chPlayerCharacter","sexualTension") + " / Sexual Tension / " + rLvlAbt("chPlayerCharacter",this.varName,"sexualTension") + "\n"
				  + rLvlAbt(this.varName,"chPlayerCharacter","romance") + " / Romance / " + rLvlAbt("chPlayerCharacter",this.varName,"romance") + "\n"
				  + rLvlAbt(this.varName,"chPlayerCharacter","domination") + " / Domination / " + rLvlAbt("chPlayerCharacter",this.varName,"domination") + "\n"
				  + rLvlAbt(this.varName,"chPlayerCharacter","submission") + " / Submission / " + rLvlAbt("chPlayerCharacter",this.varName,"submission") + "\n"
				  + rLvlAbt(this.varName,"chPlayerCharacter","rivalry") + " / Rivalry / " + rLvlAbt("chPlayerCharacter",this.varName,"rivalry") + "\n"
				  + rLvlAbt(this.varName,"chPlayerCharacter","enmity") + " / Enmity / " + rLvlAbt("chPlayerCharacter",this.varName,"enmity")
		}
	}
	return text;
}
	
	// Pronouns
Character.prototype.assignFemeninePronouns = function() {
		this.perPr = "she";
		this.comPr = "her";
		this.refPr = "herself";
		this.posPr = "her";
		this.inPosPr = "hers";
	}
Character.prototype.assignMasculinePronouns = function() {
		this.perPr = "he";
		this.comPr = "him";
		this.refPr = "himself";
		this.posPr = "his";
		this.inPosPr = "his";
	}
Character.prototype.assignItPronouns = function() {
		this.perPr = "it";
		this.comPr = "it";
		this.refPr = "itself";
		this.posPr = "its";
		this.inPosPr = "its";
	}
Character.prototype.getDiminutive = function() { return randomFromList(["girl"]); };
	
	// Management
Character.prototype.restoreBars = function() {						// RESTORE BARS FUNC
		this.lust.restore();
		this.willpower.restore();
		this.energy.restore();
		this.socialdrive.restore();
	}
	
Character.prototype.cleanLead = function() {
		this.lead = 50;
		this.hasLead = false;
	}
	
Character.prototype.sortSaList = function() {
		var sortedList = ["doNothing"];
		
		// Add single use actions
		for ( var sa of this.saList ) {
			if ( setup.saList[sa].tags.includes("sUse") ) {
				if ( sortedList.includes(sa) == false ) {
					sortedList.push(sa);
				}
			}
		}
		
		// Add continued actions
		for ( var sa of this.saList ) {
			if ( setup.saList[sa].tags.includes("cAct") ) {
				if ( sortedList.includes(sa) == false ) {
					sortedList.push(sa);
				}
			}
		}
		
		// Add positional actions
		for ( var sa of this.saList ) {
			if ( setup.saList[sa].tags.includes("pos") ) {
				if ( sortedList.includes(sa) == false ) {
					sortedList.push(sa);
				}
			}
		}
		
		// Add composite positional actions
		for ( var sa of this.saList ) {
			if ( setup.saList[sa].tags.includes("cpos") ) {
				if ( sortedList.includes(sa) == false ) {
					sortedList.push(sa);
				}
			}
		}
		
		// Add pounce actions
		for ( var sa of this.saList ) {
			if ( setup.saList[sa].tags.includes("bPos") ) {
				if ( sortedList.includes(sa) == false ) {
					sortedList.push(sa);
				}
			}
		}
		
		// Replace char.saList
		this.saList = sortedList;
	}

	// Character stats screen view
Character.prototype.getCharacterUIbarInfo = function() { // Returns a string that generates the character's basic info when displayed on Sugarcube 2
		var string = "<div align='center'>\ " + generateTitledName(this.varName) + " (" + this.getCharScreenButton("Status") + ")\n";
		if ( this.avatar != null ) {
			string += this.avatar() + "\n";
		}
		string += "</div> \ ";
		string += this.textBars() + "\n";
		return string;
	}
Character.prototype.getCharacterScreenInfo = function() { // Returns a string that generates the character's stats screen when displayed on Sugarcube 2
		var string = "__" + this.formattedName + "__\n";
		// TODO: Divide textBars to textBars and textStats, divided by a vertical line
		//string += '<div class="split left"><div class="centered"><p>' + this.textBars() + '</p></div></div>';
		//string += '<div class="split right"><div class="centered"><p>' + this.textStats() + "</p></div></div> \n";
		//string += '<html><table style="width:100%">' + '<tr><td>' + this.textBars() + '</td></tr>'
		//string += '<tr><td>' + this.textStats() + '</td></tr>' + '</table></html> \n'
		string += this.textBars() + "\n";
		string += this.textStats() + "\n\n";
		string += "__Bodyparts__:\n";
		string += this.textBodyparts() + "\n";
		string += textEquipment(this.varName);
		string += this.textRelationshipWithPlayer();
		return string;
	}
	
Character.prototype.getCharScreenButton = function(handler) {
		var text = '<<click "' + handler + '">>'
				   + '<<' + 'script>>'
				   + 'State.variables.charScreenFocus = "' + this.varName + '"; '
				   + 'var dialog = Dialog.setup("Status", "my-dialog-class");'
				   + 'new Wikifier(dialog, Story.get("' + 'Character Info Dialog Box'  + '").processText());'
				   + 'Dialog.open();'
				   + '<<' + '/script>>'
				   + '<</click>>';
		return text;
	}

	
// Previously at character class

// Stats and bars
window.recalculateMaxBars = function(charKey) {
		gC(charKey).lust.max = float2int(70 + (gC(charKey).physique.value * 1 + gC(charKey).agility.value * 1 + gC(charKey).resilience.value * 1
					  + gC(charKey).will.value * 1 + gC(charKey).intelligence.value * 1 + gC(charKey).perception.value * 1
					  + gC(charKey).empathy.value * 1 + gC(charKey).charisma.value * 1 + gC(charKey).luck.value * 1) / 3);
		gC(charKey).willpower.max = float2int(70 + gC(charKey).will.value * 1 + gC(charKey).intelligence.value * 1 + gC(charKey).perception.value * 1);
		gC(charKey).energy.max = float2int(70 + gC(charKey).physique.value * 1 + gC(charKey).agility.value * 1 + gC(charKey).resilience.value * 1);
		gC(charKey).socialdrive.max = float2int(70 + gC(charKey).empathy.value * 1 + gC(charKey).charisma.value * 1 + gC(charKey).luck.value * 1);
		for ( var sBar of ["lust","willpower","energy","socialdrive"] ) {
			gC(charKey)[sBar].current = gC(charKey)[sBar].max;
		}
	}

	// Special experience
window.getCharsSpecialExperience = function(cK,spExp) {
	var val = 0;
	if ( gC(cK)[spExp] != undefined ) {
		val = gC(cK)[spExp];
	}
	return val;
}
window.addCharsSpecialExperience = function(cK,spExp,amount) {
	if ( gC(cK)[spExp] == undefined ) {
		gC(cK)[spExp] = 0;
	}
	gC(cK)[spExp] += amount;
}

	// Control
window.attackControl = function(charKey,damage) {
		gC(charKey).control -= damage;
		if ( gC(charKey).control < 0 ) {
			gC(charKey).control = 0;
		} else if ( gC(charKey).control >= gC(charKey).maxControl ) {
			gC(charKey).control = gC(charKey).maxControl;
		}
	}
	
window.assignLostControlTurns = function(charKey,value) { // Value does nothing. Perhaps it will do something eventually.
		var lostTurns = limitedRandomInt(2) + 1 // 1 ~ 3
		gC(charKey).lostControlTurns = lostTurns;
		State.variables.sc.otherMessages.push("" + ktn(gC(charKey).varName) + " has lost control for " + lostTurns + " turn/s.");
	}
	
window.depleteControl = function(charKey) {
		gC(charKey).control = 0;
		assignLostControlTurns(charKey,1);
	}
	
window.cleanCharControl = function(charKey) {
		gC(charKey).control = gC(charKey).maxControl;
		gC(charKey).lostControlTurns = 0;
	}

window.recoverControl = function(charKey) {
		if ( gC(charKey).control < gC(charKey).maxControl && gC(charKey).controlRecovery > 0 ) {
			gC(charKey).control += gC(charKey).controlRecovery;
			if ( gC(charKey).control > gC(charKey).maxControl ) {
				gC(charKey).control = gC(charKey).maxControl;
			}
		}
	}
	
	
window.gainControlBack = function(charKey) {
		var gainedControl = gC(charKey).maxControl * 0.6;
		gC(charKey).control = gainedControl;
		gC(charKey).lostControlTurns = -1;
		State.variables.sc.otherMessages.push("" + ktn(gC(charKey).varName) + " recovered " + gainedControl + " control points.");
	}

// Name, text, formatting
window.generateTitledName = function(charKey) {
		var names = [];
		for ( var cName of gC(charKey).names ) {
			if ( names.includes(cName) == false ) {
				names.push(cName);
			}
		}
		var tooltip = "";
		for ( var cName of names ) {
			if ( tooltip != "" ) { tooltip += "\n"; }
			tooltip += firstToCap(cName);
		}
		var titledName = '<span style="color:'+ gC(charKey).nameColor+'" title="' + tooltip + '">' + gC(charKey).name+'</span>';
		return titledName;
	}

// Bodyparts
window.doesCharHaveBodypart = function(charKey,bodypart) {
	var flag = false;
	if ( gC(charKey).body.hasOwnProperty(bodypart) ) {
		flag = true;
	}
	return flag;
}

// Group functions
window.getCharGroup = function(charKey) { // Get character's group
	var group = [];
	if ( gC(charKey).followingTo == "" ) { // Char is leading
		group.push(charKey);
		for ( var charK of gC(charKey).followedBy ) {
			group.push(charK);
		}
	}
	else { // Char is following
		group.push(gC(charKey).followingTo);
		for ( var charK of gC(gC(charKey).followingTo).followedBy ) {
			group.push(charK);
		}
	}
	return group;
}
window.getPlayerCharsGroup = function() {
	return getCharGroup("chPlayerCharacter");
}

window.charUnfollowsChar = function(unfollowingChar,unfollowedChar) {
	if ( gC(unfollowingChar).followingForDebt ) {
		applyFollowingDebt(unfollowingChar);
		gC(unfollowingChar).followingForDebt = false;
	}
	gC(unfollowedChar).followedBy = arrayMinusA(gC(unfollowedChar).followedBy,unfollowingChar);
	gC(unfollowingChar).followingTo = "";
	charUnbecomesFollower(unfollowingChar);
	
	// Notify player if appropriate
	if ( unfollowingChar != "chPlayerCharacter" && unfollowedChar != "chPlayerCharacter"
	  && getRoomA(gC(unfollowingChar).currentRoom).characters.includes("chPlayerCharacter") ) {
		State.variables.compass.setMapMessage(gC(unfollowingChar).getFormattedName() + " stopped following " + gC(unfollowedChar).getFormattedName() + ".");
	}
}
window.charLosesFollowers = function(unfollowedChar) {
	for ( var charK of gC(unfollowedChar).followedBy ) {
		charUnfollowsChar(charK,unfollowedChar);
	}
}
window.charFollowsChar = function(followingChar,followedChar,flagPayingDebt) {
	charLosesFollowers(followingChar);
	gC(followingChar).mission = "";
	if ( gC(followingChar).followingTo != "" ) {
		charUnfollowsChar(followingChar,gC(followingChar).followingTo);
	}
	gC(followingChar).followingTo = followedChar;
	gC(followedChar).followedBy.push(followingChar);
	charBecomesFollower(followingChar);
	
	// Favor debt
	if ( flagPayingDebt ) {
		gC(followingChar).followingForDebt = true;
		gC(followingChar).startedFollowingAt = [ State.variables.daycycle.hours , State.variables.daycycle.minutes ];
	}
	
	// Join appropriate Sis
	var sisId = State.variables.compass.findFirstSisIdInvolvingCharacter(followedChar);
	if ( sisId != -1 ) {
		State.variables.compass.sisList[sisId].charJoinsSis(followingChar);
	}
	
	// Notify player if appropriate
	if ( followingChar != "chPlayerCharacter" && followedChar != "chPlayerCharacter"
	  && getRoomA(gC(followingChar).currentRoom).characters.includes("chPlayerCharacter") ) {
		State.variables.compass.setMapMessage(gC(followingChar).getFormattedName() + " started following " + gC(followedChar).getFormattedName() + ".");
	}
}

window.cleanCharGroup = function(charKey) { // Use ONLY on map period cleaning
	if ( gC(charKey).followingTo != "" ) {
		charUnfollowsChar(charKey,gC(charKey).followingTo);
	}
}

	// Favor debt
window.calculateFollowingDebt = function(charKey) {
	var debt = 0;
	if ( gC(charKey).followingForDebt ) {
		var h = gC(charKey).startedFollowingAt[0];
		var m = gC(charKey).startedFollowingAt[1];
		var mins = calculateMinsDiffFromCurrentTime(h,m);
		debt = mins / 60;
	}
	return debt;
}
window.payFavorDebt = function(charA,charB,favor) {
	if ( rFavor(charA,charB) <= 0 ) {
		// B owes favor to A, extra favor debt will be applied to B
		gC(charB).relations[charA].favor += favor;
	} else {
		if ( rFavor(charA,charB) < favor ) {
			// A's debt towards B is lower than favor to pay, extra debt will be applied to B
			var rest = favor - rFavor(charA,charB);
			gC(charA).relations[charB].favor = 0;
			gC(charB).relations[charA].favor = rest;
		} else {
			// Favor isn't enough to pay all of A's debt, it will just be rested¡
			gC(charA).relations[charB].favor -= favor;
		}
	}
}
window.applyFollowingDebt = function(charKey) {
	if ( gC(charKey).followingForDebt ) {
		var debt = calculateFollowingDebt(charKey);
		payFavorDebt(charKey,gC(charKey).followingTo,debt);
	}
}

	// Turn tags ( "denied" ) 
window.getCharTurnTags = function(charKey) {
	var turnTags = [];
	if ( gC(charKey).hasOwnProperty("turnTags") ) {
		turnTags = gC(charKey).turnTags;
	}
	return turnTags;
}
window.addTurnTagToChar = function(tag,charKey) {
	if ( gC(charKey).hasOwnProperty("turnTags") ) {
		gC(charKey).turnTags.push(tag);
	} else {
		gC(charKey).turnTags = [tag];
	}
}
window.doesCharHaveTurnTag = function(charKey,tag) {
	var flag = false;
	if ( gC(charKey).hasOwnProperty("turnTags") ) {
		if ( gC(charKey).turnTags.includes(tag) ) {
			flag = true;
		}
	}
	return flag;
}

	// Scene tags ( "noLead" )
window.getCharSceneTags = function(charKey) {
	var sceneTags = [];
	if ( gC(charKey).hasOwnProperty("sceneTags") ) {
		sceneTags = gC(charKey).sceneTags;
	}
	return sceneTags;
}
window.addSceneTagToChar = function(tag,charKey) {
	if ( gC(charKey).hasOwnProperty("sceneTags") ) {
		gC(charKey).sceneTags.push(tag);
	} else {
		gC(charKey).sceneTags = [tag];
	}
}
window.doesCharHaveSceneTag = function(charKey,tag) {
	var flag = false;
	if ( gC(charKey).hasOwnProperty("sceneTags") ) {
		if ( gC(charKey).sceneTags.includes(tag) ) {
			flag = true;
		}
	}
	return flag;
}

	// Day tags ( "liberationAttempt" )
window.getCharSceneTags = function(charKey) {
	var dayTags = [];
	if ( gC(charKey).hasOwnProperty("dayTags") ) {
		dayTags = gC(charKey).dayTags;
	}
	return dayTags;
}
window.addDayTagToChar = function(tag,charKey) {
	if ( gC(charKey).hasOwnProperty("dayTags") ) {
		gC(charKey).dayTags.push(tag);
	} else {
		gC(charKey).dayTags = [tag];
	}
}
window.doesCharHaveDayTag = function(charKey,tag) {
	var flag = false;
	if ( gC(charKey).hasOwnProperty("dayTags") ) {
		if ( gC(charKey).dayTags.includes(tag) ) {
			flag = true;
		}
	}
	return flag;
}

	// Orgasms
window.isCharsOrgasmRuined = function(charKey) {
	var flag = false;
	if ( gSettings().chastity == "enable" ) {
		if ( doesCharHaveTurnTag(charKey,"denied") ) {
			flag = true;
		} else {
			// Pussy and dick
			if ( doesCharHaveBodypart(charKey,"pussy") && doesCharHaveBodypart(charKey,"dick") ) {
				if ( gC(charKey).body.pussy.state == "locked" && gC(charKey).body.dick.state == "locked" ) {
					flag = true;
				}
			// Pussy
			} else if ( doesCharHaveBodypart(charKey,"pussy") ) {
				if ( gC(charKey).body.pussy.state == "locked" ) {
					flag = true;
				}
			// Dick
			} else if ( doesCharHaveBodypart(charKey,"dick") ) {
				if ( gC(charKey).body.dick.state == "locked" ) {
					flag = true;
				}
			}
		}
	}
	return flag;
}
window.isOrgasmMindblowing = function(charKey) {
	var flag = false;
	var overflowPercent = -(gC(charKey).lust.current/gC(charKey).lust.max);
	var overflowScore = gC(charKey).orgasmSceneCounter - (gC(charKey).mindblowingOrgasmSC * 3) + (overflowPercent * 1.5);
	if ( overflowScore > 2.4 ) {
		flag = true;
	}
	return flag;
}

// Constructors, serializers, etc.
Character.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

Character.prototype.clone = function () {
	return (new Character())._init(this);
};

Character.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Character())._init($ReviveData$)', ownData);
};

// Auxiliar functions //

	// Known actions
window.charactersLearnSceneActions = function(characters,sceneActions) {
	var resultsMsg = "";
	var movesLearned = [];
	for ( var currentChar of characters ) {
		movesLearned = [];
		for ( var currentAction of sceneActions ) {
			if ( gC(currentChar).saList.includes(currentAction) == false ) {
				gC(currentChar).saList.push(currentAction);
				movesLearned.push(setup.saList[currentAction].name);
			}
		}
		resultsMsg += gC(currentChar).getFormattedName() + " learned " + stringArrayToText(movesLearned) + ".\n";
		gC(currentChar).sortSaList();
	}
	return resultsMsg;
}
window.charactersForgetSceneActions = function(characters,sceneActions) {
	var resultsMsg = "";
	for ( var character of characters ) {
		var newSaList = [];
		for ( var action of gC(character).saList ) {
			if ( sceneActions.includes(action) == false ) {
				newSaList.push(action);
			}
		}
		gC(character).saList = newSaList;
	}
	return resultsMsg;
}

	// Scrolls
window.reorderCharactersStudiedScrolls = function(characters) {
	for ( var character of characters ) {
		var newScrList = [];
		for ( var scr of getScrollsStringList() ) {
			if ( gC(character).studiedScrolls.includes(scr) ) {
				newScrList.push(scr);
			}
		}
		gC(character).studiedScrolls = newScrList;
	}
}

	// Sex stats
window.getSexEffectsMultiplier = function(charKey) {
	var multiplier = ( ( 3 + gC(charKey).daysWithoutSex ) / ( 3 + gC(charKey).sexScenesToday * 3 ) );
	return multiplier;
}

	// Drives
window.updateCharacterDrives = function(charKey) {
	addPointsToDrive(gC(charKey).dImprovement,0);
	addPointsToDrive(gC(charKey).dLove,0);
	addPointsToDrive(gC(charKey).dPleasure,0);
	addPointsToDrive(gC(charKey).dCooperation,0);
	addPointsToDrive(gC(charKey).dDomination,0);
	addPointsToDrive(gC(charKey).dAmbition,0);
}

window.getCharsDrivePercent = function(charKey,driveType) {
	// Returns the percentage of the driveType's levels in relation to the character's total drive levels
	var percent = gC(charKey)[driveType].level / getCharsTotalDriveLevels(charKey);
	return percent;
}
window.getCharsDrive = function(charKey,driveType) {
	// Returns the percentage of the driveType's levels in relation to the character's total drive levels
	return gC(charKey)[driveType].level;
}
window.getCharsTotalDriveLevels = function(charKey) {
	var total = 0;
	for ( var drive of [ "dImprovement" , "dLove", "dPleasure", "dCooperation", "dDomination", "dAmbition" ] ) {
		total += gC(charKey)[drive].level;
	}
	return total;
}
window.getCharsInfamyLimit = function(charKey) {
	var absoluteLimit = gSettings().infamyLimit;
	
	var percentLimit = 0.8;
	var ambition = getCharsDrivePercent(charKey,"dAmbition");
	if ( ambition > 0.2 ) {
		percentLimit += 0.3;
	} else if ( ambition > 0.15 ) {
		percentLimit += 0.2;
	}else if ( ambition > 0.10 ) {
		percentLimit += 0.1;
	}
	var cooperationVsDomination = getCharsDrivePercent(charKey,"dDomination") - getCharsDrivePercent(charKey,"dCooperation");
	if ( cooperationVsDomination > 0.1 ) {
		percentLimit += 0.3;
	} else if ( cooperationVsDomination > 0.05 ) {
		percentLimit += 0.2;
	} else if ( cooperationVsDomination > 0 ) {
		percentLimit += 0.1;
	}
	return (percentLimit * absoluteLimit);
}

	// AI
window.getCharsMissionTitle = function(charKey) {
	var missionTitle = "";
	if ( gC(charKey).mission != undefined ) {
		missionTitle = gC(charKey).mission;
	}
	return missionTitle;
}

	// Moods
window.getCharsMaximumMoodModifier = function(charKey) {
	var maxMod = (gCstat(charKey,"empathy") * 1.2 + gCstat(charKey,"charisma") * 0.6 + gCstat(charKey,"luck") * 0.2) * 0.1;
	if ( maxMod <= 2 ) { maxMod = 2; }
	else if ( maxMod >= 20 ) { maxMod = 20; }
	return maxMod;
}

	// Text
window.textEquipment = function(charKey) {
	var eText = "";
	eText += "Weapon: ";
	if ( gC(charKey).weaponID != -1 ) {
		eText += '<span title="' + getEquipDataById(gC(charKey).weaponID).description + '">' + getEquipDataById(gC(charKey).weaponID).name + "</span>"
		if ( isCharsWeaponInUse(charKey) ) {
			eText += " (In use)";
		}
	}
	eText += "\nClothes: ";
	if ( gC(charKey).weaponID != -1 ) {
		
	}
	eText += "\nAccesory: ";
	if ( gC(charKey).weaponID != -1 ) {
		
	}
	return eText;
}

	// Base stats
window.getThreeKindredCharStats = function(charKey) { // Returns the character's 3 stats with the highest affinity
	var kindredStats = [];
	
	var stats = ["physique","agility","resilience","will","intelligence","perception","empathy","charisma","luck"];
	var currentHighestStat = stats[0];
	var currentHighestAff = 0;
	
	for ( var i = 0 ; i < 3 ; i++ ) {
		currentHighestAff = "luck";
		currentHighestAff = 0;
		for ( var currentStat of stats ) {
			if ( ( gC(charKey)[currentStat].affinity > currentHighestAff ) && (kindredStats.includes(currentStat) == false) ) {
				currentHighestStat = currentStat;
				currentHighestAff = gC(charKey)[currentStat].affinity;
			}
		}
		kindredStats.push(currentHighestStat);
	}
	
	return kindredStats;
}

	// Body
window.charHasLockedBodypart = function(charKey,bodypartKey) {
	var flag = false;
	if ( gC(charKey).body.hasOwnProperty(bodypartKey) ) {
		if ( gC(charKey).body[bodypartKey].state == "locked" ) {
			flag = true;
		}
	}
	return flag;
}

window.returnCharsUnlockedGenitals = function(charKey) {
	var unlockedGenitals = [];
	if ( gC(charKey).hasFreeBodypart("dick") ) {
		unlockedGenitals.push("dick");
	}
	if ( gC(charKey).hasFreeBodypart("pussy") ) {
		unlockedGenitals.push("pussy");
	}
	return unlockedGenitals;
}

	// States
window.removeCharsStates = function(charKey) {
	for ( var as of gC(charKey).alteredStates ) {
		as.cancelEffect(charKey);
	}
	gC(charKey).alteredStates = [];
}

	// Casus belli
window.actorGetsCbAgainstTarget = function(actor,target) {
	gC(actor).cbl.push(target);
	if ( gC(actor).socialAi.rivalTs.includes(target) == false ) {
		gC(actor).socialAi.rivalTs.push(target);
	}
}

// Auxiliar UI

window.textCharactersDrives = function(character) {
	var desc = "";
	var drives = ["dImprovement","dPleasure","dLove","dCooperation","dDomination","dAmbition"];
	var driveNames = ["Self-Improvement","Pleasure","Love","Cooperation","Domination","Ambition"];
	var i = 0;
	if ( character == "chPlayerCharacter" ) {
		desc = "Beware: characters' drives or values represent their values or ideas and determine their behavior as NPCs. The player character's drives cannot determine their behavior, but they may push them towards desiring certain events, which could slightly raise the difficulty of certain willpower checks.\n";
	}
	while ( i < 6 ) {
		desc += driveNames[i] + " - Level: " + gC(character)[drives[i]].level + " , Value: " + gC(character)[drives[i]].value.toFixed(1);
		if ( i < 5 ) { desc += "\n"; }
		i++;
	}
	return desc;
}

window.textCharactersTastes = function(character) {
	var desc = "";
	var iFlag = false;
	var flagDisplay = true;
	for ( var t in gC(character).tastes ) {
	flagDisplay = true;
	
	if ( gC(character).tastes[t].content == "useDick" ) {
		if ( gC(character).body.hasOwnProperty("dick") == false ) { flagDisplay = false; }
	} else if ( gC(character).tastes[t].content == "usePussy" ) {
		if ( gC(character).body.hasOwnProperty("pussy") == false ) { flagDisplay = false; }
	} else if ( gC(character).tastes[t].content == "useAnus" ) {
		if ( gC(character).body.hasOwnProperty("anus") == false ) { flagDisplay = false; }
	} else if ( gC(character).tastes[t].content == "useBreasts" ) {
		if ( gC(character).body.hasOwnProperty("breasts") == false ) { flagDisplay = false; }
	} else if ( gC(character).tastes[t].content == "useMouth" ) {
		if ( gC(character).body.hasOwnProperty("mouth") == false ) { flagDisplay = false; }
	} else if ( gC(character).tastes[t].content == "useEyes" ) {
		if ( gC(character).body.hasOwnProperty("eyes") == false ) { flagDisplay = false; }
	} else if ( gC(character).tastes[t].content == "useHands" ) {
		if ( gC(character).body.hasOwnProperty("arms") == false ) { flagDisplay = false; }
	} else if ( gC(character).tastes[t].content == "useLegs" ) {
		if ( gC(character).body.hasOwnProperty("legs") == false ) { flagDisplay = false; }
	} else if ( gC(character).tastes[t].content == "useTail" ) {
		if ( gC(character).body.hasOwnProperty("tail") == false ) { flagDisplay = false; }
	}
		if ( flagDisplay ) {
			if ( gC(character).tastes[t] instanceof weightedElement ) {
				if ( gC(character).tastes[t].content != "continuedAction" && gC(character).tastes[t].content != "position" ) {
					iFlag = "//";
					if ( gC(character).tastes[t].r == 2 ) {
						desc += "[img[img/sysIcons/redPlus.png]]";
						iFlag = "__";
					} else if ( gC(character).tastes[t].r == 1 ) {
						iFlag = "";
						desc += "[img[img/sysIcons/bluePlus.png]]";
					} else {
						desc += "    ";
					}
					desc += " ";
					if ( iFlag != false ) { desc += iFlag; }
					switch ( gC(character).tastes[t].content ) {
						case "foreplay":
							desc += "Foreplay"; break;
						case "oral":
							desc += "Oral";	break;
						case "fullsex":
							desc += "Full sex";	break;
						case "talk":
							desc += "Banter"; break;
						case "useDick":
							desc += "Use dick"; break;
						case "usePussy":
							desc += "Use pussy"; break;
						case "useAnus":
							desc += "Use anus"; break;
						case "useBreasts":
							desc += "Use breasts"; break;
						case "useMouth":
							desc += "Use mouth"; break;
						case "useEyes":
							desc += "Use eyes"; break;
						case "useHands":
							desc += "Use hands"; break;
						case "useLegs":
							desc += "Use legs"; break;
						case "useTail":
							desc += "Use tail"; break;
						case "targetDick":
							desc += "Target dick"; break;
						case "targetPussy":
							desc += "Target pussy"; break;
						case "targetBreasts":
							desc += "Target breasts"; break;
						case "targetAnus":
							desc += "Target anus"; break;
						case "targetMouth":
							desc += "Target mouth"; break;
						case "targetEyes":
							desc += "Target eyes"; break;
						case "targetHands":
							desc += "Target hands"; break;
						case "targetLegs":
							desc += "Target legs"; break;
						case "targetTail":
							desc += "Target tail"; break;
						case "top":
							desc += "Top"; break;
						case "bottom":
							desc += "Bottom"; break;
						case "domination":
							desc += "Domination"; break;
						case "submission":
							desc += "Submission"; break;
						case "bondage":
							desc += "Bondage"; break;
						case "teasing":
							desc += "Teasing"; break;
						case "hypnosis":
							desc += "Hypnosis"; break;
						case "draining":
							desc += "Draining"; break;
						case "charm":
							desc += "Charm"; break;
						case "romantic":
							desc += "Romantic"; break;
						case "usePain":
							desc += "Use pain"; break;
						case "receivePain":
							desc += "Receive pain"; break;
						case "denial":
							desc += "Denial"; break;
					}
					if ( iFlag != false ) { desc += iFlag; }
					desc += " - W:" + gC(character).tastes[t].w + "\n";
				}
			}
		}
	}
	return desc;
}

////////// SCENE CLASS //////////

window.scene = function() {
	this.sceneLog = ""; // Debug console
	
	this.scenePassage = "";
	
	this.sceneType = ""; // May be ss (Sex Scene) or bs (Battle Scene)	
	this.enabledLead = "none"; // Valid values: "none", "dynamic", "fixed"
	this.sceneConditions = []; // Flags to be initiated manually. They may disable certain player actions.
		// cantCancelActions
		// cantCancelPositions
		// cantInitiateCActs // Continued Actions
		// cantInitiatePos //
	
	this.teamAcharKeys = [];
	this.teamBcharKeys = [];
	
	this.teamAchosenActions = [];  // List of strings containing each chosen action's key.
	this.teamAchosenTargets = [];
	this.teamBchosenActions = [];
	this.teamBchosenTargets = [];
	
	this.lastPlayerCommand = "";
	this.lastPlayerTarget = "";
	
	this.leadGainRate = 10;
	this.askedForLead = []; // List of character keys that asked for lead
	this.askForLeadScript = ""; // Script that should always be printed, it allows the Player to ask for lead should it ever be possible
	
	this.continuedActions = []; // List of continued actions to be executed at the end of each turn.	
	
	this.pcChosenAction = ""; // This string is used by the player to choose their next action. It is fed from actions options list,
							  // and it is fed to the PC's team's chosen actions.
	this.pcChosenTargets = [""]; // Saves the targets chosen by the player. It is fed from targets options list, and it is fed to the
							   // PC's team's chosen targets.
	this.isPcActionValid = 0;
	this.formattedActionsOptionList = ""; // This string calls a macro that allows the Player to choose their action.
	this.formattedTargetsOptionList = ""; // This string calls a macro that allows the Player to select their targets.
	
	this.currentTurn = 1;
	this.turnLimit = -1;
	
	this.importantMessages = ""; // f.e.: Virginities list
	this.genericDialogs = "";
	this.enabledDialogues = true;
	this.headingDescription = "";
	this.outHeadingDescription = "";
	this.charactersDescription = "";
	this.positionsDescription = "";
	this.actionsDescription = "";
	this.extraEffectsDescription = "";
	this.actionsDescriptionNl = false;
	this.otherMessages = [];
	
	this.cancelActionButtons = []; // Each element is a list [ID,CommandScript,Description]
	this.cabID = 0; // ID for each cancelActionButton. It's assigned to the new cab, then incremented. Should be cleaned at the end of the scene.
	
	this.provisionalInfo = "";
	
	this.checkEndConditions = function() {
		return true;
	}
	this.endConditionsVars = 0;
	this.flagSceneEnded = false;
	this.flagSceneActive = false;
	this.extraEndInfo = "";
	
	this.endRoundEffects = []; // Functions to be executed and cleaned at the end of every round
	
	this.flagFullAvatar = false;
	this.selectedFullAvatar = "chPlayerCharacter";
	
	this.endSceneMessage = "The scene is finished.";
	this.endScenePassage = "";
	this.endScenePassageScript = "";
	
	this.endSceneScript = function() {
		return true;
	}
	
		// Battle extra parameters
	this.stakes = 1;
	this.aggressor = "";
	this.defender = "";
	
	this.customScript = function() {
		return 1;
	}
	// This function is automatically called at the end of every turn. It may be manually changed to create special behavior for a specific scene.
	
};

// Methods
	// Start-up // This must be called whenever the game starts a scene
	scene.prototype.startScene = function( sceneType, enabledLead,
								tAck, tBck,
								headingDescription,
								checkEndConditions, endConditionsVars,
								endScenePassage ) {
		this.sceneLog = "";
		this.sceneLog += "Cleaning previous scene. "; //DEP//
		
		var teamAcharKeys = [];
		var teamBcharKeys = [];
		
		// Remove males if disabled
		for ( var cK of tAck ) {
			var valid = true;
			if ( gSettings().lewdMales == "disable" && sceneType == "ss" ) {
				if ( cK != "chPlayerCharacter" && gC(cK).perPr == "he" ) {
					valid = false;
				}
			}
			if ( valid ) { teamAcharKeys.push(cK); }
		}
		for ( var cK of tBck ) {
			var valid = true;
			if ( gSettings().lewdMales == "disable" && sceneType == "ss" ) {
				if ( cK != "chPlayerCharacter" && gC(cK).perPr == "he" ) {
					valid = false;
				}
			}
			if ( valid ) { teamBcharKeys.push(cK); }
		}
		
		// Swap teams if required
		if ( teamBcharKeys.includes("chPlayerCharacter") ) {
			var tempTeamKeys = teamBcharKeys;
			teamBcharKeys = teamAcharKeys;
			teamAcharKeys = tempTeamKeys;
		}
		
		// Initialize vars
		this.sceneType = sceneType;
		this.enabledLead = enabledLead;
		this.sceneConditions = [];
		this.currentTurn = 1;
		
		var allChars = [];
		var newTeamAchars = [];
		var newTeamBchars = [];
		for ( var cK of teamAcharKeys ) {
			if ( allChars.includes(cK) == false ) {
				newTeamAchars.push(cK);
				allChars.push(cK);
			}
		}
		for ( var cK of teamBcharKeys ) {
			if ( allChars.includes(cK) == false ) {
				newTeamBchars.push(cK);
				allChars.push(cK);
			}
		}
		
		this.teamAcharKeys = newTeamAchars;
		this.teamBcharKeys = newTeamBchars;
		
		if ( this.enabledLead == "dynamic" ) {
			this.initiateLeadPoints();
		}
		else if ( this.enabledLead == "fixed" ) {
			
		}
		this.askedForLead = [];
		this.refreshAskForLeadScript();
		
		this.teamAchosenActions = []; // VARIABLE KEYS, NOT THE ACTUAL VARIABLES (ex.: doNothing)
		this.teamAchosenTargets = []; // VARIABLE KEYS, NOT THE ACTUAL VARIABLES (ex.: chGoddessHerald)
		this.teamBchosenActions = [];
		this.teamBchosenTargets = [];
	
		this.lastPlayerCommand = "";
		this.lastPlayerTarget = "";
		
		this.pcChosenAction = "";	  // Variable keys
		this.pcChosenTargets = [];    // Variable keys
		
		this.headingDescription = headingDescription;
		if ( this.headingDescription != "" ) {
			this.outHeadingDescription = this.headingDescription + "\n\n";
		}
		else {
			this.outHeadingDescription = "";
		}
		
		this.charactersDescription = "";
		this.positionsDescription = "";
		this.actionsDescription = "";
		this.extraEffectsDescription = "";
		
		this.cancelActionButtons = [];
		this.cabID = 0; 
		
		this.checkEndConditions = checkEndConditions;
		this.endConditionsVars = endConditionsVars;
		this.flagSceneEnded = false;
		
		this.endSceneMessage = "The scene is finished.";
		this.endScenePassage = endScenePassage;
		this.refreshEndScenePassageScript();
		this.endSceneScript = function() { // This function is called at the end of the scene, right before cleaning the scene object.
										   // Edit it right after starting the scene to get a certain effect at the end.
			return true;
		}
		
		this.cleanSceneOrgasms(); // Bugs may cause characters to reach the scene with a scene orgasm counter above 0.
								  // This cleans those situations
								  
		this.flagSceneActive = true;
		
		if ( this.teamBcharKeys.length > 0 ) {
			this.lastPlayerTarget = this.teamBcharKeys[0];
		} else {
			this.lastPlayerTarget = this.teamAcharKeys[0];
		}
		
		this.turnsWithoutActions = 0;
		
		this.formatScenePassage();
	}
	
	scene.prototype.autoResolveScene = function() {
		while ( this.flagSceneEnded == false ) {
			this.executeTurn();
		}
		this.cleanScene();
	}
	scene.prototype.autoResolveSceneAlt = function() {
		while ( this.flagSceneEnded == false ) {
			this.executeTurn();
		}
	}
	
	// Management
	scene.prototype.removeContinuedAction = function(caPosition) {
		this.continuedActions[caPosition].freeBodyparts();
		this.continuedActions[caPosition].forgetAssociatedActions();
		if ( this.continuedActions[caPosition].hasOwnProperty("flagUsingWeapon") ) {
			setCharsWeaponUnused(this.continuedActions[caPosition].initiator);
		}
		this.continuedActions.splice(caPosition,1);
	}
	scene.prototype.removeContinuedActionById = function(caId) {
		//this.continuedActions[caPosition].freeBodyparts();
		//this.continuedActions.splice(caPosition,1);
		
		var i = 0;
		var j = -1;
		for ( var cab of this.cancelActionButtons ) {
			if ( caId == cab[0] ) {
				j = i;
			}
			i++;
		}
		if ( j != -1 ) {
			this.removeContinuedAction(j);
			//this.cancelActionButtons.splice(j,1);
		}
	}
	scene.prototype.cleanContinuedActions = function() {
		var i = this.continuedActions.length;
		
		while ( i > 0 ) {
			i--;
			this.removeContinuedAction(i);
		}
	}
	scene.prototype.refreshEndScenePassageScript = function() {
		this.endScenePassageScript = '<p id="continueButton"><<link "Continue" "' + this.endScenePassage + '">>'
								   + '<<' + 'script>>'
								   // + 'State.variables.sc.endSceneScript();\n'
								   + 'State.variables.sc.cleanScene();\n'
								   + '<<' + '/script>>'
								   + '<</link>></p>';
	}
	
	scene.prototype.removeCancelActionButtonByID = function(id) {
		var i = 0;
		var j = -1;
		for ( var cab of this.cancelActionButtons ) {
			if ( id == cab[0] ) {
				j = i;
			}
			i++;
		}
		if ( j != -1 ) {
			this.cancelActionButtons.splice(j,1);
		}
	}
	
	scene.prototype.initiateLeadPoints = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		var validCharKeys = [];
		var purgedCharKeys = [];
		for ( var charKey of charKeys ) {
			if ( doesCharHaveSceneTag(charKey,"noLead") ) {
				purgedCharKeys.push(charKey);
			} else {
				validCharKeys.push(charKey);
			}
		}
		var rCharKeys = shuffleArray(validCharKeys);
		var l = rCharKeys.length;
		
		var i = 0;
		while ( i < l ) {
			if ( i == 0 ) {
				gC(rCharKeys[i]).lead = 100;
				gC(rCharKeys[i]).hasLead = true;
			}
			else {
				gC(rCharKeys[i]).lead = 100 * ( ((l-1)*2 - i) / ((l-1)*2) );
				gC(rCharKeys[i]).hasLead = false;
			}
			i++;
		}
		
		for ( var charKey of purgedCharKeys ) {
			gC(charKey).lead = 0;
			gC(charKey).hasLead = false;
		}
		
		// Set lead gain rate
		this.leadGainRate = 100 / (2 * rCharKeys.length);
	}
	scene.prototype.setLeadGainRate = function() { // OBSOLETE
		var nChars = this.teamAcharKeys.length + this.teamBcharKeys.length;
		this.leadGainRate = 100 / (2 * nChars);
	}
	scene.prototype.addTurnLeadPoints = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		for ( var key of charKeys ) {
			if ( doesCharHaveSceneTag(key,"noLead") == false ) {
				gC(key).lead += this.leadGainRate * gC(key).leadMultiplier * (gC(key).willpower.current / gC(key).willpower.max);
				if ( gC(key).lead > 100 ) {
					gC(key).lead = 100;
				}
			}
		}
	}
	scene.prototype.assignNewLead = function() {
		this.giveLeadToChar(randomFromList(this.askedForLead));
	}
	
	scene.prototype.giveLeadToChar = function(charKey) {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		for ( var key of charKeys ) {
			if ( gC(key).hasLead == true ) {
				gC(key).hasLead = false;
				gC(key).lead = 0;
			}
		}
		gC(charKey).hasLead = true;
	}
	scene.prototype.offerLeadToNpcs = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		for ( var key of charKeys ) {
			if ( gC(key).hasLead == false && gC(key).lead == 100 && (key != "chPlayerCharacter") ) {
				this.askedForLead.push(key);
			}
		}
	}
	scene.prototype.refreshAskForLeadScript = function() {
		this.askForLeadScript = "";
		if ( State.variables.chPlayerCharacter.lead == 100 && State.variables.chPlayerCharacter.hasLead == false && this.enabledLead == "dynamic" ) {
			this.askForLeadScript = '<<link "Attempt to take Lead" "Scene">>'
							 + '<<' + 'script>>'
							 + 'State.variables.sc.askedForLead.push("chPlayerCharacter");'
							 + 'State.variables.sc.askFor' + 'LeadScript = "";'
							 + '<<' + '/script>>'
							 + '<</link>>\n\n';
		}
		
		// Attempting to take lead at the end of this turn.\n\n
	}
	
	scene.prototype.cleanLeadPoints = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		for ( var key of charKeys ) {
			getChar(key).lead = 0;
			getChar(key).hasLead = false;
		}		
	}
	scene.prototype.cleanControl = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		for ( var key of charKeys ) {
			cleanCharControl(key);
		}		
	}
	scene.prototype.cleanSceneOrgasms = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		for ( var key of charKeys ) {
			getChar(key).orgasmSceneCounter = 0;
			gC(key).mindblowingOrgasmSC = 0;
			getChar(key).ruinedOrgasmSceneCounter = 0;
		}		
	}
	scene.prototype.cleanAccumulatedDamages = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		for ( var key of charKeys ) {
			getChar(key).cleanAccumulatedDamages();
		}
	}
	scene.prototype.cancelPosition = function(charKey) {
		var affectedChars = findAllConnectedCharsByPositionMinusList(charKey,[]);
		for ( var cK of affectedChars ) {
			getChar(cK).position.free();
		}
		
	}
	scene.prototype.cleanAllPositions = function() {
		var charList = this.teamAcharKeys.concat(this.teamBcharKeys);
		for ( var charKey of charList ) {
			getChar(charKey).position.free();
		}
	}
	scene.prototype.cleanAlteredStates = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		var cleanStates = false;
		for ( var key of charKeys) {
			cleanStates = false;
			for ( var as of gC(key).alteredStates ) {
				if ( as.scope == "scene" ) {
					as.flagRemove = true; // Finish effect
					cleanStates = true;
				}
			}
			if ( cleanStates ) {
				gC(key).cleanStates();
			}
		}
	}
	scene.prototype.cleanKoedFlags = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		for ( var key of charKeys ) {
			getChar(key).koed = false;
		}	
	}
	
	scene.prototype.cleanScene = function() {	
		this.endSceneScript();
		
		if ( this.sceneType == "ss" ) {
			for ( var character of this.teamAcharKeys.concat(this.teamBcharKeys) ) {
				if ( gC(character).hasOwnProperty("daysWithoutSex") ) {
					gC(character).daysWithoutSex = 0;
					gC(character).sexScenesToday += 1;
				}
			}
		}
		
		// this.logAccumulatedDamage();
		
		this.enabledLead = "none";
		this.cleanAccumulatedDamages();
		this.cleanLeadPoints();
		this.cleanControl();
		
		this.cleanSceneOrgasms();
		
		this.cleanContinuedActions();
		this.cleanAllPositions();
		
		this.cleanAlteredStates();
		this.cleanKoedFlags();		
		
		this.sceneType = "";
		
		cleanSceneTags();
		
		for ( var charKey of this.teamAcharKeys ) {
			gC(charKey).turnPrefTags = [];
		}
		for ( var charKey of this.teamBcharKeys ) {
			gC(charKey).turnPrefTags = [];
		}
		
		this.teamAcharKeys = [];
		this.teamBcharKeys = [];
		
		this.teamAchosenActions = [];
		this.teamAchosenTargets = [];
		this.teamBchosenActions = [];
		this.teamBchosenTargets = [];
		
		if ( this.spectators != undefined ) {
			delete this.spectators;
		}
		
		this.lastPlayerCommand = "";
		this.lastPlayerTarget = "";
		
		this.pcChosenAction = "";
		this.pcChosenTargets = [""];
		this.isPcActionValid = 0;
		this.formattedActionsOptionList = "";
		this.formattedTargetsOptionList = "";
		
		this.cancelActionButtons = [];
		this.cabID = 0; 
		
		this.currentTurn = 1;
		this.turnLimit = -1;
		
		this.importantMessages = "";
		this.genericDialogs = "";
		this.enabledDialogues = true;
		this.headingDescription = "";
		this.charactersDescription = "";
		this.actionsDescription = "";
		this.extraEffectsDescription = "";
		this.otherMessages = [];
		
		this.provisionalInfo = "";
		
		this.flagFullAvatar = false;
		this.selectedFullAvatar = "chPlayerCharacter";
		
		this.cleanCustomDialogues();
		delete this.turnsWithoutActions;
		
		this.checkEndConditions = function() {
			return true;
		}
		this.endConditionsVars = 0;
		this.flagSceneEnded = true;
		this.flagSceneActive = false;
		
		this.endSceneMessage = "The scene is finished.";
		//this.endScenePassage = "";
		//this.endScenePassageScript = "";
				
		this.customScript = function() {
			return 1;
		}
		this.endSceneScript = function() {
			return true;
		}
		
		if ( this.genericCharacters != undefined ) {
			for ( var chKey of this.genericCharacters ) {
				delete State.variables[chKey];
			}
			delete this.genericCharacters;
		}
		
		if ( this.tfFlag != undefined ) {
			this.cleanTfSceneData();
		}
	}
	
	scene.prototype.getCharacterContext = function(charKey) {
		var charPos = 0;
		var actionsOnActor = [];
		var charsOnActor = [];
		var i = 0;
		if ( this.teamAcharKeys.includes(charKey) ) {
			charPos = this.teamAcharKeys.indexOf(charKey);
			
			for ( var targets of this.teamAchosenTargets ) {
				if ( targets.includes(charKey) ) {
					actionsOnActor.push(this.teamAchosenActions[i]);
					charsOnActor.push(this.teamAcharKeys[i]);
				}
				i++;
			}
			i = 0;
			for ( var targets of this.teamBchosenTargets ) {
				if ( targets.includes(charKey) ) {
					actionsOnActor.push(this.teamBchosenActions[i]);
					charsOnActor.push(this.teamBcharKeys[i]);
				}
				i++;
			}
			
			var ctx = new sceneDialogContext(charKey,this.teamAchosenActions[charPos],this.teamAchosenTargets[charPos],charsOnActor,actionsOnActor);
			return ctx;
		}
		else if ( this.teamBcharKeys.includes(charKey) ) {
			charPos = this.teamBcharKeys.indexOf(charKey);
			
			for ( var targets of this.teamAchosenTargets ) {
				if ( targets.includes(charKey) ) {
					actionsOnActor.push(this.teamAchosenActions[i]);
					charsOnActor.push(this.teamAcharKeys[i]);
				}
				i++;
			}
			i = 0;
			for ( var targets of this.teamBchosenTargets ) {
				if ( targets.includes(charKey) ) {
					actionsOnActor.push(this.teamBchosenActions[i]);
					charsOnActor.push(this.teamBcharKeys[i]);
				}
				i++;
			}
			
			var ctx = new sceneDialogContext(charKey,this.teamBchosenActions[charPos],this.teamBchosenTargets[charPos],charsOnActor,actionsOnActor);
			return ctx;
		}
		else {
			return null;
		}
	}
	
	scene.prototype.isPlayerInScene = function() {
		var flagPcInScene = false;
		
		if ( this.teamAcharKeys.includes("chPlayerCharacter") || this.teamBcharKeys.includes("chPlayerCharacter") ) {
			flagPcInScene = true;
		}
		
		return flagPcInScene;
	}
	
	scene.prototype.cleanNegativeBars = function() {
		for ( var character of this.teamAcharKeys.concat(this.teamBcharKeys) ) {
			for ( var bar of ["willpower","energy","socialdrive"] ) {
				if ( gC(character)[bar].current < 0 ) {
					gC(character)[bar].current = 0;
				}
			}
		}
	}
	
	scene.prototype.setBattleParameters = function(stakes,attacker,defender) {
		this.stakes = stakes;
		this.aggressor = attacker;
		this.defender = defender;
	}
	
	window.getCharsTeam = function(cK) {
		var team = [];
		if ( gC("sc").teamAcharKeys.includes(cK) ) {
			team = gC("sc").teamAcharKeys;
		} else if ( gC("sc").teamBcharKeys.includes(cK) ) {
			team = gC("sc").teamBcharKeys;
		}
		return team;
	}
	window.getCharsTeamMinusSelf = function(cK) {
		var team = arrayMinusA(getCharsTeam(cK),cK);
		return team;
	}
	
	// Logic
	
	scene.prototype.isActionAllowed = function(actor,sceneAction) {
		var isAllowed = true;
		if ( sceneAction.tags.includes(this.sceneType) == false ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	scene.prototype.listUsableActions = function(actorKey) {
		// This function creates a list with the keys of all actions that are usable in some way during this turn by a given character.
		// This requires to check every action known by the character, and test its usability against any different target.
		var list = ["doNothing"];
		var charList = this.teamAcharKeys.concat(this.teamBcharKeys);
		
		for ( var actionKey of gC(actorKey).saList ) {
			for ( var target of charList ) {
				if ( list.includes(actionKey) == false ) {
					if ( this.isActionAllowed(actorKey,setup.saList[actionKey]) == true && isActionUsable(actionKey,actorKey,[target],false).isUsable == true ) {
						list.push(actionKey);
					}
				}
			}
		}
		
		return list;
	}
	scene.prototype.listUsableActionsOnTarget = function(actorKey,targetKey) {
		var list = ["doNothing"];
		var charList = this.teamAcharKeys.concat(this.teamBcharKeys);
		if ( gC(targetKey).koed ) {
			// Only "doNothing" is usable
		} else {
			
		for ( var actionKey of gC(actorKey).saList ) {
				if ( list.includes(actionKey) == false ) {
					if ( this.isActionAllowed(actorKey,setup.saList[actionKey]) == true && isActionUsable(actionKey,actorKey,[targetKey],false).isUsable == true ) {
						list.push(actionKey);
					}
				}
			}
		}
		
		return list;
	}
	
	scene.prototype.checkUnvalidContinuedActions = function() {
		// Checks every continued action on the scene. If any of them has unvalid positions, they are canceled
		var i = this.continuedActions.length; // Continued actions are checked from end to start
		var flagCancelledAction = false;
		
		while ( i > 0 ) {
			i--;
			if ( this.checkUnvalidContinuedAction(i) == true ) {
				this.removeContinuedAction(i);
				flagCancelledAction = true;
			}
		}
		
		if ( flagCancelledAction == true ) {
			this.actionsDescription += "\nThe changes in positions forced at least one continued action to be cancelled.\n";
		}
	}
	scene.prototype.checkUnvalidContinuedAction = function(position) {
		var flagCancelAction = false;
		var cA = this.continuedActions[position];
		
		for ( var caTag of cA.tags ) {
			switch(caTag) {
				case "activePosition":
					if ( getImmediatelyConnectedCharsToChar(cA.initiator).includes(cA.targetsList[0]) == false ) {
						flagCancelAction = true;
					}
					break;
			}
		}
		
		if ( cA.validRelationalPositions.length > 0 ) {
			var flagFoundValidRelationalPosition = false;
			for ( var relationalPosition of cA.validRelationalPositions ) {
				for ( var target of cA.targetsList ) {
					if ( gC(cA.initiator).position.key == relationalPosition[0] && gC(target).position.key == relationalPosition[1] ) {
						flagFoundValidRelationalPosition = true; 
					}
				}
			}
			if ( flagFoundValidRelationalPosition == false ) {
				flagCancelAction = true;
			}
		}
		
		if ( cA.unvalidRelationalPositions.length > 0 ) {
			var flagFoundUnvalidPosition = false;
			for ( var relationalPosition of cA.unvalidRelationalPositions ) {
				for ( var target of cA.targetsList ) {
					if ( gC(cA.initiator).position.key == relationalPosition[0] && gC(target).position.key == relationalPosition[1] ) {
						flagFoundUnvalidPosition = true;
					}
				}
			}
			if ( flagFoundUnvalidPosition == true ) {
				flagCancelAction = true;
			}
		}
		
		return flagCancelAction;
	}
	
	scene.prototype.applyPrefTurnTags = function() {
		if ( this.sceneType == "ss" ) {
			var i = 0;
			for ( var action of this.teamAchosenActions ) {
				var actor = this.teamAcharKeys[i];
				var targets = this.teamAchosenTargets[i];
				if ( isActionUsable(action,actor,targets,false) ) {
					for ( var flavorTag of setup.saList[action].flavorTags ) {
						if ( gC(actor).turnPrefTags.includes(flavorTag) == false ) { gC(actor).turnPrefTags.push(flavorTag); }
						var opTag = getOppositeTag(flavorTag);
						for ( var target of targets ) {
							if ( gC(actor).turnPrefTags.includes(opTag) == false ) { gC(actor).turnPrefTags.push(opTag); }
						}
					}
				}
				i++;
			}
			i = 0;
			for ( var action of this.teamBchosenActions ) {
				var actor = this.teamBcharKeys[i];
				var targets = this.teamBchosenTargets[i];
				if ( isActionUsable(action,actor,targets,false) ) {
					for ( var flavorTag of setup.saList[action].flavorTags ) {
						if ( gC(actor).turnPrefTags.includes(flavorTag) == false ) { gC(actor).turnPrefTags.push(flavorTag); }
						var opTag = getOppositeTag(flavorTag);
						for ( var target of targets ) {
							if ( gC(actor).turnPrefTags.includes(opTag) == false ) { gC(actor).turnPrefTags.push(opTag); }
						}
					}
				}
				i++;
			}
		}
	}
	
	scene.prototype.executeActions = function() {
		this.actionsDescription = "";
		var i = 0;
		
		if ( this.sceneType == "bs" ) {
										// This code is trash, but it works well, so do not touch it much @vvv@ //
			var unorderedActions = [];
			// Reorder data
			var actionsInfo = new weightedList(); 
			var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
			for ( var actK of this.teamAchosenActions ) {
				actionsInfo[this.teamAcharKeys[i]] = [ this.teamAcharKeys[i] , actK , this.teamAchosenTargets[i] ];
				i++;
			}
			i = 0;
			for ( var actK of this.teamBchosenActions ) {
				actionsInfo[this.teamBcharKeys[i]] = [ this.teamBcharKeys[i] , actK , this.teamBchosenTargets[i] ];
				i++;
			}
			// Divide actions to execute by blocks of priority
			while ( getActionsInfoLength(actionsInfo) > 0 ) {
				var highestPriority = findHighestPriorityInActionsInfo(actionsInfo);
				var currentChars = [];
				for ( var ai of getActionsInfoListWithPriority(actionsInfo,highestPriority) ) {
					currentChars.push(ai[0]);
				}
				var currentActions = actionsInfoArrayToActionsInfoList(getActionsInfoListWithPriority(actionsInfo,highestPriority))
				actionsInfo = actionsInfoArrayToActionsInfoList(getActionsInfoListWithoutPriority(actionsInfo,highestPriority));
				
				// Out of this priority block, execute all actions with a weighted random order, with luckier characters having higher weight
				// Weighted list
				var wL = new weightedList();
				for ( var charK of currentChars ) {
					wL[charK] = new weightedElement(charK,gC(charK).luck.getValue());
				}
				// Take weighted random elements from wL, execute their action, delete them from the list, until j == 0
				var j = currentChars.length;
				while ( j > 0 ) {
					var currentC = randomFromWeightedList(wL); // Take weighted random char
					if ( currentActions[currentC] != undefined ) {
						var currentA = currentActions[currentC][1]; // Execute action
						var actionDesc = setup.saList[currentA].description;
						var actionName = "[<span title=" + '"' + actionDesc + '"' + ">" + setup.saList[currentA].name + "</span>] ";
						this.actionsDescription += colorText(actionName,"darkgray");
						this.actionsDescription += tryExecuteAction(currentA,currentC,currentActions[currentC][2]).description;
						this.actionsDescription += "\n";
						delete wL[currentC]; // Delete from weighted list
					}
					j--; // Reduce j
				}
			}
		}
		else {
			for (let action of this.teamAchosenActions) {
				// Each chosen action is called in order. The parameters are the acting character and its list of targets.
				// Each action returns a description of its effects, which is added to actionsDescription.
				var actionDesc = setup.saList[action].description;
				var actionName = "[<span title=" + '"' + actionDesc + '"' + ">" + setup.saList[action].name + "</span>] ";
				this.actionsDescription += colorText(actionName,"darkgray");
				this.actionsDescription += tryExecuteAction(action,this.teamAcharKeys[i],this.teamAchosenTargets[i]).description;
				//this.actionsDescription += setup.saList[this.teamAchosenActions[action]].execute(this.teamAcharKeys[i],this.teamAchosenTargets[i]).description;
				this.actionsDescription += "\n";
				i++;
			}
			i = 0;
			for (let action of this.teamBchosenActions) {
				var actionDesc = setup.saList[action].description;
				var actionName = "[<span title=" + '"' + actionDesc + '"' + ">" + setup.saList[action].name + "</span>] ";
				this.actionsDescription += colorText(actionName,"darkgray");
				this.actionsDescription += tryExecuteAction(action,this.teamBcharKeys[i],this.teamBchosenTargets[i]).description;
				//this.actionsDescription += setup.saList[this.teamBchosenActions[action]].execute(this.teamBcharKeys[i],this.teamBchosenTargets[i]).description;
				this.actionsDescription += "\n";
				i++;
			}
		}
	}
			// Here be goblins, shoo //
	window.getActionsInfoLength = function(actionsInfo) {
		var l = 0;
		for ( var i in actionsInfo ) {
			if ( gC(actionsInfo[i][0]) != undefined ){
				l++;
			}
		}
		return l;
	}
	window.findHighestPriorityInActionsInfo = function(actionsInfo) {
		var highestPriority = -1000;
		for ( var i in actionsInfo ) {
			if ( gC(actionsInfo[i][0]) != undefined ){
				var actInf = actionsInfo[i];
				if ( setup.saList[actInf[1]].priority > highestPriority ) {
					highestPriority = setup.saList[actInf[1]].priority;
				}
			}
		}
		return highestPriority;
	}
	window.getActionsInfoListWithPriority = function(actionsInfo,priority) {
		var newList = [];
		for ( var i in actionsInfo ) {
			if ( gC(actionsInfo[i][0]) != undefined ){
				var actInf = actionsInfo[i];
				if ( setup.saList[actInf[1]].priority == priority ) {
					newList.push(actionsInfo[i]);
				}
			}
		}
		return newList;
	}
	window.getActionsInfoListWithoutPriority = function(actionsInfo,priority) {
		var newList = [];
		for ( var i in actionsInfo ) {
			if ( gC(actionsInfo[i][0]) != undefined ){
				var actInf = actionsInfo[i];
				if ( setup.saList[actInf[1]].priority != priority ) {
					newList.push(actionsInfo[i]);
				}
			}
		}
		return newList;
	}
	window.actionsInfoArrayToActionsInfoList = function(actionsInfoArray) {
		var actsInfoList = new weightedList(); 
		for ( var aie of actionsInfoArray ) {
			actsInfoList[aie[0]] = aie;
		}
		return actsInfoList;
	}
			// // //		   // // //
	
	scene.prototype.updateCancelActionButtons = function() {
		this.cabID = 0;
		for ( var ca in this.continuedActions ) {
			var cancelActionButton = [this.cabID]; // cab is assigned an ID
			if ( this.flagSceneEnded == false ) {	// If scene isn't finished, create Cancel Action Buttons
				var cancelPlayerActionScript = this.returnCancelActionScript(this.checkCancelAction(
																				"chPlayerCharacter",this.continuedActions[ca]),i,this.cabID);
				cancelActionButton.push(cancelPlayerActionScript);		// cab is assigned a cancel script
																		// If it can't be cancelled, cancelPlayerActionScript equals ""
			} else {
				cancelActionButton.push("");							// cab is assigned a cancel script
			}
			var actionName = colorText(("[" + this.continuedActions[ca].name + "] "),"darkgray");
			var actionDescription = this.continuedActions[ca].execute().description;
//			this.actionsDescription += actionName + actionDescription + "\n";
			cancelActionButton.push("" + actionName + actionDescription + "\n");
			this.cancelActionButtons.push(cancelActionButton);
			this.cabID++;
			i++;
		}
	}
	scene.prototype.executeContinuedActions = function() {
		var i = 0;		
		
		// Find Positional CAs
		var positionalContinuedActions = [];
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		for ( var charKey of charKeys ) {
			if ( gC(charKey).position.cAction != null ) {
				positionalContinuedActions.push(gC(charKey).position.cAction);
			}
		}
		
		// Formatting init
		if ( ( this.continuedActions.length + positionalContinuedActions.length ) > 0 ) {
			this.actionsDescriptionNl = true;
			// this.actionsDescription += "\n";
		} else {
			this.actionsDescriptionNl = false;
		}
		// Main
		for ( var ca in this.continuedActions ) {
			var cancelActionButton = [this.cabID]; // cab is assigned an ID
			if ( this.flagSceneEnded == false ) {	// If scene isn't finished, create Cancel Action Buttons
				var cancelPlayerActionScript = this.returnCancelActionScript(this.checkCancelAction(
																				"chPlayerCharacter",this.continuedActions[ca]),i,this.cabID);
				cancelActionButton.push(cancelPlayerActionScript);		// cab is assigned a cancel script
																		// If it can't be cancelled, cancelPlayerActionScript equals ""
			} else {
				cancelActionButton.push("");							// cab is assigned a cancel script
			}
			var actionName = colorText(("[" + this.continuedActions[ca].name + "] "),"darkgray");
			this.continuedActions[ca].continuedTurns++;
			var actionDescription = this.continuedActions[ca].execute().description;
//			this.actionsDescription += actionName + actionDescription + "\n";
			cancelActionButton.push("" + actionName + actionDescription + "\n");
			this.cancelActionButtons.push(cancelActionButton);
			this.cabID++;
			i++;
		}
		
		// Positional CAs effects
		for ( var pcAction of positionalContinuedActions ) {
			var actionName = colorText(("[" + pcAction.name + "] "),"darkgray");
			var actionDescription = pcAction.execute().description;
			// TODO: Add action name and description to CAs
			//var toPush = "" + actionName + actionDescription + "\n"
			var nonButton = [,"","" + actionName + actionDescription + "\n"];
			this.cancelActionButtons.push(nonButton);
			this.cabID++;
			i++;
		}
	}
	
	scene.prototype.checkForOrgasms = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		for ( var key of charKeys ) {
			var results = getChar(key).tryOrgasm(); // Overflow is the amount of lust excess after an orgasm.
													 // If -1, there was no orgasm
			var overflow = results[0];
			var type = results[1];
			
			if ( type != "none" ) {
				var orgasmMessage = this.textOrgasmMessage(key,overflow,type);
				this.importantMessages += orgasmMessage + "\n";
				if ( this.sceneType == "bs" ) {
					gC(key).koed = true; // If battle scene, character gets KO'ed
					this.cancelPosition(key);
				} else if ( this.sceneType == "ss" ) {
					var str = 7;
					if ( type == "mindblowing" ) {
						str = 20;
					} else if ( type == "ruined" ) {
						str = 15;
					}
					gC(key).influenceSexPrefs(50,limitedRandomInt(str));
				}
			}
		}		
	}
	
	scene.prototype.controlTurnEffects = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		for ( var key of charKeys) {
			if ( gC(key).position.type != "passive" ) { // Characters on passive positions do not recover control
				if ( gC(key).lostControlTurns == -1 ) { // Ignore control for this turn
					gC(key).lostControlTurns = 0;
				}
				else if ( gC(key).lostControlTurns > 0 ) { // Player lost control earlier, will eventually recover it
					gC(key).lostControlTurns--;
					if ( gC(key).lostControlTurns == 0 ) { // Player passed all lost control turns, will now recover some control
						gC(key).control = gC(key).maxControl * 0.6;
					}
				}
				else if ( gC(key).control <= 0 ) { // Player has just lost control, decide number of lost control turns
					assignLostControlTurns(key,1);
				}
				else { // Player has some control, will gradually recover more
					recoverControl(key);
				}
			}
		}
	}
	
	scene.prototype.alteredStatesTurnEffects = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys);
		var cleanStates = false;
		for ( var key of charKeys) {
			cleanStates = false;
			for ( var as of gC(key).alteredStates ) {
				if ( as.scope == "scene" ) {
					as.remainingTurns--; // Reduce remaining turns
					if ( as.remainingTurns <= 0 ) {
						as.flagRemove = true; // Finish effect
						cleanStates = true;
					}
				}
			}
			if ( cleanStates ) {
				gC(key).cleanStates();
			}
		}
	}
	
	scene.prototype.wereThereAnyActions = function() { // Checks if any character chose any action other than "doNothing"
		var thereWereActions = false;
		for ( var act of this.teamAchosenActions ) {
			if ( act != "doNothing" ) {
				thereWereActions = true;
			}
		}
		for ( var act of this.teamBchosenActions ) {
			if ( act != "doNothing" ) {
				thereWereActions = true;
			}
		}
		if ( thereWereActions ) {
			this.turnsWithoutActions = 0;
		} else {
			this.turnsWithoutActions++;
		}
	}
	
	scene.prototype.checkForcedDraw = function() { // Checks if the scene has grown stale. If some, executeTurn() must force a stalemate
		var forcedDraw = false;
		if ( this.turnsWithoutActions >= 3 ) {
			forcedDraw = true;
		}
		return forcedDraw;
	}
	
	scene.prototype.executeTurn = function() {	
		this.teamAchosenActions = [];  // Clean the stacks
		this.teamAchosenTargets = [];
		this.teamBchosenActions = [];
		this.teamBchosenTargets = [];
		
		this.importantMessages = "";
		this.genericDialogs = "";
		this.actionsDescription = "";
		this.extraEffectsDescription = "";
		this.otherMessages = [];	
		
		
		for ( var charKey of this.teamAcharKeys ) {
			gC(charKey).turnPrefTags = [];
		}
		for ( var charKey of this.teamBcharKeys ) {
			gC(charKey).turnPrefTags = [];
		}
		
		
		// Choose actions
		var aiResults;
		for ( var character of this.teamAcharKeys ) { // Player character
			if ( gC(character).koed ) { // Ko'ed characters can't act
				this.teamAchosenActions.push("doNothing");
				this.teamAchosenTargets.push([character]);
			}
			else if ( character == "chPlayerCharacter" ) {
				this.teamAchosenActions.push(this.pcChosenAction);
				this.teamAchosenTargets.push(this.pcChosenTargets);
			} 
			else if ( getChar(character).aiAlgorythm != 0 ) { // AI Algorythm
				aiResults = getChar(character).aiAlgorythm.callAction((character),this.teamAcharKeys,this.teamBcharKeys,this.currentTurn);
				this.teamAchosenActions.push(aiResults.actionKey);
				this.teamAchosenTargets.push(aiResults.targetsIDs);
			}
			else { // Everything failed: do nothing
				this.teamAchosenActions.push("doNothing");
				this.teamAchosenTargets.push([]);
			}
		}
		for ( var character of this.teamBcharKeys ) { // Player character
			if ( gC(character).koed ) { // Ko'ed characters can't act
				this.teamBchosenActions.push("doNothing");
				this.teamBchosenTargets.push([character]);
			}
			else if ( getChar(character) == "chPlayerCharacter" ) {
				this.teamBchosenActions.push(this.pcChosenAction);
				this.teamBchosenTargets.push(this.pcChosenTargets);
			}
			else if ( getChar(character).aiAlgorythm != 0 ) { // AI Algorythm
				aiResults = getChar(character).aiAlgorythm.callAction((character),this.teamBcharKeys,this.teamAcharKeys,this.currentTurn);
				this.teamBchosenActions.push(aiResults.actionKey);
				this.teamBchosenTargets.push(aiResults.targetsIDs);
			}
			else { // Everything failed: do nothing
				this.teamBchosenActions.push("doNothing");
				this.teamBchosenTargets.push([]);
			}
		}
		
		// Pre-execute actions
		this.cancelActionButtons = [];
		
		// Execute actions
		this.applyPrefTurnTags();
		this.executeActions();
		
		for ( var effect of this.endRoundEffects ) {
			var efMsg = effect();
			if ( efMsg != "" ) {
				this.actionsDescription += efMsg + "\n";
			}
		}
		this.endRoundEffects = [];
		
		// Execute altered states
		executeAlteredStatesTurnEffects();
		
		// Lead (Part 1)
		this.addTurnLeadPoints();
		if ( this.askedForLead.length > 0 ) {
			this.assignNewLead();
		}		
		
		// Execute continued action
		this.checkUnvalidContinuedActions();
		this.executeContinuedActions();
		
		// this.refreshCharacterDescriptions(); // Outdated		
		this.refreshPositionsDescriptions();
		
		this.currentTurn += 1;
		
		// Post-action effects
		this.checkForOrgasms();
				
		// Lead (Part 2)
		this.askedForLead = [];
		if ( this.enabledLead == "dynamic" ) {
			this.offerLeadToNpcs();
		}
		this.refreshAskForLeadScript();
		
		// Control
		this.controlTurnEffects();

		// Altered States
		this.alteredStatesTurnEffects();

		// Custom Script
		this.customScript();
		// Check importantMessages
		if ( this.importantMessages != "" ) {
			var temp = this.importantMessages;
			//this.importantMessages = '<span style="color:red">';
			//this.importantMessages += temp;
			//this.importantMessages += '<' + '/span>\n';
		}
		
		// Generate dialogs
		this.generateGenericDialogs();
		
		// Check heading
		if ( this.headingDescription != "" ) {
			this.outHeadingDescription = this.headingDescription + "\n\n";
		}
		
		// Were there any actions check
		this.wereThereAnyActions();
		
		// Check scene end
		this.flagSceneEnded = this.checkEndConditions(this.endConditionsVars);
		if ( this.flagSceneEnded == false ) {
			if ( this.checkForcedDraw() ) {
				this.flagSceneEnded = true;
				this.extraEndInfo = "stalemate";
			}
		}
		
		// Remember player commands
		var playerPosition = -1;
		var j = 0;
		for ( var chKey of this.teamAcharKeys ) {
			if ( chKey == "chPlayerCharacter" ) {
				playerPosition = j;
			}
			j++;
		}
		if ( playerPosition != -1 ) {
			this.lastPlayerCommand = this.teamAchosenActions[playerPosition];
			this.lastPlayerTarget = this.teamAchosenTargets[playerPosition][0];
		}
		
		// Bars below negative limits
		this.cleanNegativeBars();
		
		// Clean turn tags
		cleanTurnTags();
		
		// Format Scene Passage
		this.formatScenePassage();
	}
	
	// Logic 2
	scene.prototype.checkCancelAction = function(cancellingActorKey,continuedAction) { // This function returns the logic of attempting to cancel a continued action
		var logic = "noCost"; // The action will be cancelled at no cost
		
		if ( cancellingActorKey !== continuedAction.initiator ) {
			logic = "passTurn";
		}
		
		if ( this.sceneConditions.includes("cantCancelActions") ) {
			logic = "disabled";
		}
		
		if ( this.enabledLead != "none" && State.variables.chPlayerCharacter.hasLead == false ) {
			// If lead mode is dynamic or fixed, character needs lead to cancel continued actions
			logic = "disabled";
		}
		
		return logic;
	}
	scene.prototype.returnCancelActionScript = function(logic,caPos,id) { // Returns a string that, when interpreted by Sugarcube 2, allows the player to cancel a
															// continued action under specific logic
		
		var script = "";
		
		switch(logic) {
			case "noCost":
				script = '<<link "Cancel" "Scene">>'
					   + '<<' + 'script>>'
					   //+ 'State.variables.sc.removeContinuedAction(' + caPos + '); '
					   + 'State.variables.sc.removeContinuedActionById(' + id + '); '
					   + 'State.variables.sc.removeCancelActionButtonByID(' + id + ');\n'
//					   + 'State.variables.sc.actionsDescription = "The action was canceled";'
					   + 'State.variables.sc.formatScenePassage();\n'
					   + '<<' + '/script>>'
					   + '<</link>>';
				break;
			case "passTurn":
				script = '<<link "Cancel" "Scene">>'
					   + '<<' + 'script>>'
					   + 'if ( State.variables.sc.flagSceneEnded == false ) { '
					   //+ 'State.variables.sc.removeContinuedAction(' + caPos + '); '
					   + 'State.variables.sc.removeContinuedActionById(' + id + '); '
					   + 'State.variables.sc.removeCancelActionButtonByID(' + id + ');\n'
					   + 'State.variables.sc.formatScenePassage();\n'
					   + 'State.variables.sc.pcChosenAction = "doNothing"; '
					   + 'State.variables.sc.executeTurn();'
					   + ' } ' 
					   + '<<' + '/script>>'
					   + '<</link>>';
				break;
			case "disabled":
				script = "";
				break;
		}
		
		return script;
	}
	
	scene.prototype.returnCancelPlayerPositionScript = function() {
		var script = "";
		var flagNotLeading = false;
		if ( this.enabledLead != "none" && State.variables.chPlayerCharacter.hasLead == false ) {
			flagNotLeading = true;
		}
		if ( this.sceneType == "bs" ) {
			if ( State.variables.chPlayerCharacter.position.type != "passive" && State.variables.chPlayerCharacter.position.type != "free" ) {
				script = '<<link "Cancel Player Position" "Scene">>'
				   + '<<' + 'script>>'
				   + 'State.variables.sc.cancelPosition("chPlayerCharacter");'
				   + 'State.variables.sc.positionsDescription = "";'
				   + 'State.variables.sc.actionsDescription = "The position was canceled.";\n'
				   + 'State.variables.sc.formatScenePassage();\n'
				   + '<<' + '/script>>'
				   + '<</link>>\n';
			}
		}
		else if ( this.sceneConditions.includes("cantCancelPositions") == false && flagNotLeading == false ) {
			if ( gC("chPlayerCharacter").position.type != "free" ) {
				script = '<<link "Cancel Player Position" "Scene">>'
					   + '<<' + 'script>>'
					   + 'State.variables.sc.cancelPosition("chPlayerCharacter");'
					   + 'State.variables.sc.positionsDescription = "";'
					   + 'State.variables.sc.actionsDescription = "The position was canceled.";\n';
					   
				script += 'State.variables.sc.formatScenePassage();\n'
					   + '<<' + '/script>>'
					   + '<</link>>\n';
			}
		}
		return script;
	}
	
	// Controls
	scene.prototype.formatActionsOptionList = function(pcChar) {
		this.formattedActionsOptionList = '<<listbox "$sc.pcChosenAction" $sc.pcChosenAction>>\n';
		for (var actionKey of this.listUsableActions(pcChar.varName)) {
			if ( this.isActionAllowed(pcChar,setup.saList[actionKey]) == true ) {
				// this.sceneLog += "// " + actionKey + " //";
				var actionName = setup.saList[actionKey].name;
				this.formattedActionsOptionList += '<<option "' + actionName + '" ' + actionKey;
				if ( actionKey == this.lastPlayerCommand ) {
					this.formattedActionsOptionList += " selected";
				}
				this.formattedActionsOptionList += '>>\n';
			}
		}
		this.formattedActionsOptionList += '<</listbox>>';
	}
	
	scene.prototype.formatTargetsOptionList = function() {
		this.formattedTargetsOptionList = "";
		var i = 0;
		for ( var character of this.teamBcharKeys ) {
			this.formattedTargetsOptionList += '<label><<radiobutton "$sc.pcChosenTargets[0]" ' + character;
			if ( character == this.teamBcharKeys[0] && i == 0 ) { // Check if it's first target at the start of the scene
				this.formattedTargetsOptionList += ' checked';
			}
			else if ( character == this.lastPlayerTarget ) { // Check if it's last target
				this.formattedTargetsOptionList += ' checked';
			}
			this.formattedTargetsOptionList += '>> ' + getChar(character).formattedName + '</label>\n';
			i++;
		}
		for ( var character of this.teamAcharKeys ) {
			this.formattedTargetsOptionList += '<label><<radiobutton "$sc.pcChosenTargets[0]" ' + character;
			if ( character == this.lastPlayerTarget ) { // Check if it's last target
				this.formattedTargetsOptionList += ' checked';
			}
			this.formattedTargetsOptionList += '>> ' + getChar(character).formattedName + '</label>\n';
		}
	}
	
	scene.prototype.isPlayerActionUsable = function() {
		return isActionUsable(this.pcChosenAction,"chPlayerCharacter",this.pcChosenTargets,false);
	}
	
	scene.prototype.refreshIsPcActionValid = function() {
		this.isPcActionValid = this.isPlayerActionUsable();
	}
	
	scene.prototype.getButtonHideFullAvatar = function() {
		var bText = "<<l" + "ink [[[ x ]|Scene]]>><<s" + "cript>>";
		bText 	 += "State.variables.sc.flagFullAvatar = false;\n";
		bText	 += "State.variables.sc.formatScenePassage();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	scene.prototype.getButtonShowFullAvatar = function(character) {
		var bText = "<<l" + "ink [[[ + ]|Scene]]>><<s" + "cript>>";
		bText 	 += "State.variables.sc.flagFullAvatar = true;\n";
		bText	 += "State.variables.sc.selectedFullAvatar = '" + character + "';\n";
		bText	 += "State.variables.sc.formatScenePassage();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}

	// Descriptions
	scene.prototype.generateGenericDialogs = function() {
		var dialogs = "";
		if ( this.enabledDialogues ) {
			if ( this.sceneType == "ss" ) {
				var threshold = 65 + ( this.teamAcharKeys.length + this.teamBcharKeys.length ) * 5;
				if ( threshold > 85 ) { threshold = 85; }
				var i = 0;
				while ( i < this.teamAcharKeys.length ) {
					var extraThreshold = 0;
					if ( gC(this.teamAcharKeys[i]).hasFreeBodypart("mouth") == false ) {
						(100 - threshold) / 1.5;
					}
					if ( limitedRandomInt(100) > (threshold + extraThreshold) && (this.teamAcharKeys[i] != this.teamAchosenTargets[i] && this.teamAchosenTargets[i][0] != undefined ) ) { // Activate dialog
						var actionsAgainstActor = getActionsAgainstTarget(this.teamAcharKeys[i]);					
						var nd = chooseDialogFromList(setup.dialogDB[this.getDialogsList()],this.teamAcharKeys[i],this.teamAchosenTargets[i][0],this.teamAchosenActions[i],actionsAgainstActor);
						if ( nd != "" ) {
							if ( dialogs == "" ) { dialogs += nd; }
							else { dialogs += "\n" + nd; }
						}
					}
					i++;
				}
				i = 0;
				while ( i < this.teamBcharKeys.length ) {
					var extraThreshold = 0;
					if ( gC(this.teamBcharKeys[i]).hasFreeBodypart("mouth") == false ) {
						(100 - threshold) / 1.5;
					}
					if ( limitedRandomInt(100) > (threshold + extraThreshold) && (this.teamBcharKeys[i] != this.teamBchosenTargets[i] && this.teamBchosenTargets[i][0] != undefined) ) { // Activate dialog
						var actionsAgainstActor = getActionsAgainstTarget(this.teamBcharKeys[i]);					
						var nd = chooseDialogFromList(setup.dialogDB[this.getDialogsList()],this.teamBcharKeys[i],this.teamBchosenTargets[i][0],this.teamBchosenActions[i],actionsAgainstActor);
						if ( nd != "" ) {
							if ( dialogs == "" ) { dialogs += nd; }
							else { dialogs += "\n" + nd; }
						}
					}
					i++;
				}
			}
		}
		this.genericDialogs = dialogs;
	}
	scene.prototype.setDialoguesList = function(dialoguesList) { // Dialogues list is a string that refers to a object in setup.dialogDB
		State.variables.sc.customDialogues = dialoguesList;
	}
	scene.prototype.getDialogsList = function() {
		var dialoguesList = "ssDialogs";
		if ( State.variables.sc.hasOwnProperty("customDialogues") ) {
			dialoguesList = State.variables.sc.customDialogues;
		}
		return dialoguesList;
	}
	scene.prototype.cleanCustomDialogues = function() {
		delete State.variables.sc.customDialogues;
	}
	
	scene.prototype.textOrgasmMessage = function(charKey,overflow,type) {
		var orgasmText = "";
		var actionsAgainstActor = getActionsAgainstTargetIncludingSelf(charKey);
		var description = chooseMessageFromList(setup.dialogDB.orDialogs,charKey,"",type,actionsAgainstActor);
		if ( type == "ruined" ) {
			orgasmText = colorText((gC(charKey).name + " almost reached climax for " + (getChar(charKey).lust.max + overflow).toFixed(2) + " total lust damage, but... "),"red") + description + " " + gC(charKey).name + " feels " + gC(charKey).posPr + " strength flowing away.";
		} else if ( type == "mindblowing" ) {
			orgasmText = colorText((getChar(charKey).name + " reached a most powerful climax for " + (getChar(charKey).lust.max + overflow).toFixed(2) + " lust damage and " + (gC(charKey).willpower.max * 0.2).toFixed(2) + " willpower damage."),"red") + description;
		} else {
			orgasmText = colorText((getChar(charKey).name + " reached climax for " + (getChar(charKey).lust.max + overflow).toFixed(2) + " total lust damage."),"red") + description;
		}
		orgasmText += " ";
		return orgasmText;
	}
	
	scene.prototype.refreshCharacterDescriptions = function() {
		
		this.charactersDescription = "";
		var flagTeamA = true;
		var barsText = "";
		if (this.teamAcharKeys.length < 2) {
			for (let character in this.teamAcharKeys) { 
				if (getChar(this.teamAcharKeys[character]).varName == "chPlayerCharacter") {
					flagTeamA = false;
				}
			}
		}
		if (flagTeamA == true) {
			this.charactersDescription += "''Team A'':\n";
			for (let character in this.teamAcharKeys) {
				this.charactersDescription += getChar(this.teamAcharKeys[character]).formattedName + " " + getChar(this.teamAcharKeys[character]).getCharScreenButton("*") + " :\n";
				barsText = getChar(this.teamAcharKeys[character]).textBars();
				this.charactersDescription += barsText + "\n\n";
			}
			this.charactersDescription += "\n";
		}
		this.charactersDescription += "''Team B'':\n";
		for (let character in this.teamBcharKeys) {
			this.charactersDescription += getChar(this.teamBcharKeys[character]).formattedName + " " + getChar(this.teamBcharKeys[character]).getCharScreenButton("*") + " :\n";
			barsText = getChar(this.teamBcharKeys[character]).textBars();
			this.charactersDescription += barsText + "\n\n";
		}
	}
	scene.prototype.refreshPositionsDescriptions = function() {
		this.positionsDescription = "";
		var uncheckedChars = this.teamAcharKeys.concat(this.teamBcharKeys);
		var checkedChars = [];
		
		for ( var key of uncheckedChars ) {
			if ( checkedChars.includes(key) == false ) {
				if ( getChar(key).position.type != "free" ) {
					if ( this.positionsDescription != "" ) { this.positionsDescription += "\n"; } 
					this.positionsDescription += colorText(("[" + getChar(key).position.name + "] "),"darkgray");
					this.positionsDescription += getChar(key).position.description;
					checkedChars = checkedChars.concat(getCharsAtCharsPosition(key));
				}
			}
			/*
			if ( checkedChars.includes(key) == false ) {
				if ( getChar(key).position.type != "free" ) {
					if ( this.positionsDescription != "" ) { this.positionsDescription += "\n"; } 
					this.positionsDescription += colorText(("[" + getChar(key).position.name + "] "),"darkgray");
					this.positionsDescription += getChar(key).position.description;
					checkedChars.push(key);
					
					if ( gC(key).position.hasOwnProperty("initiator") ) {
						var initiator = gC(key).position.initiator
						checkedChars.push(initiator);
						if ( gC(key).position.hasOwnProperty("secondaryInitiators") ) {
							checkedChars = checkedChars.concat(gC(key).position.secondaryInitiators);
						}
						if ( gC(initiator).position.hasOwnProperty("targetsList") ) {
							for ( var t of gC(initiator).position.targetsList ) {
								checkedChars.push(t);
							}
						}
					}
					
					if ( gC(key).position.hasOwnProperty("targetsList") ) {
						checkedChars = checkedChars.concat(getChar(key).position.targetsList);
						for ( var target of getChar(key).position.targetsList ) {
							if ( gC(target).position.hasOwnProperty("secondaryInitiators") ) {
								checkedChars = checkedChars.concat(gC(target).position.secondaryInitiators);
							}
						}
					}
				}
			}
			*/
		}
		
		if ( this.positionsDescription != "" ) {
			this.positionsDescription += "\n";
			var cancelPosScript = this.returnCancelPlayerPositionScript();
			this.positionsDescription += this.returnCancelPlayerPositionScript();
			this.positionsDescription += "\n";
		}
	}

window.getCharsAtCharsPosition = function(charKey) {
	// Finds all characters positionally connected to charKey and returns them as a list
	var charList = [charKey];
	var searchedChars = [];
	while ( charList.length != searchedChars.length ) {
		var newChars = [];
		for ( var cK of charList ) {
			if ( searchedChars.includes(cK) == false ) {
				newChars = newChars.concat(getImmediatelyConnectedCharsToChar(cK));
				searchedChars.push(cK);
			}
		}
		charList = removeDuplicatesFromList(charList.concat(newChars));
	}
	return charList;
}
window.getImmediatelyConnectedCharsToChar = function(charKey) {
	var charList = [];
	var position = gC(charKey).position;
	if ( position.initiator != undefined ) {
		charList.push(position.initiator);
	}
	if ( position.targetsList != undefined ) {
		charList = charList.concat(position.targetsList);
	}
	if ( position.secondaryInitiators != undefined ) {
		charList = charList.concat(position.secondaryInitiators);
	}
	charList = removeDuplicatesFromList(charList);
	return charList;
}

	scene.prototype.logAccumulatedDamage = function() {
		var charKeys = this.teamAcharKeys.concat(this.teamBcharKeys );
		for ( var character of charKeys ) {
			this.sceneLog += " " + getChar(character).textAccumulatedDamages();
		}
	}

	// UI
	scene.prototype.formatScenePassage = function() {
		this.formatActionsOptionList(getChar("chPlayerCharacter"));
		this.formatTargetsOptionList();
		var pas = "<div>";
		// Right Avatar Div
		if ( this.flagFullAvatar ) {
			pas += this.formatFullAvatarDiv();
		} else {
			pas += '<<removeclass "#right-ui-bar" "stowed">>';
		}
		// Standard Scene Passage
		pas += "<div>";
		if ( this.outHeadingDescription != "" ) { pas += "<div class='standardBox'>" + this.outHeadingDescription + "\\ </div> \n"; }
		if ( this.positionsDescription != "" || this.actionsDescription != "" || this.cancelActionButtons.length > 0 ) {
			pas += "<div class='standardBox'>";
		}
		if ( this.positionsDescription != "" ) { pas += this.positionsDescription + "\\ \n"; }
		if ( this.actionsDescription != "" ) { pas += this.actionsDescription + "\\ \n"; }
		if ( this.actionsDescriptionNl ) { pas += "\n"; }
		if ( this.cancelActionButtons.length > 0 ) {
			for ( var cab of this.cancelActionButtons ) {
				if ( cab[1] != "" ) {
					pas += cab[1] + "\n";
				}
				pas += cab[2];
			}
		}
		if ( this.positionsDescription != "" || this.actionsDescription != "" || this.cancelActionButtons.length > 0 ) {
			pas += "</div>\n";
		}
		if ( this.importantMessages != "" ) { pas += "<div class='standardBox'>" + this.importantMessages + " </div> \n"; }
		if ( this.genericDialogs != "" ) { pas += "<div class='standardBox'>" + this.genericDialogs + " </div> \n"; }
		
		else if ( this.actionsDescription != "" ) { // I know this looks strange.
			pas += "\n";
		}
		
		var l = 0;
		if ( this.otherMessages.length > 0 ) {
			pas += "<div class='standardBox'>";
			for ( var mes of this.otherMessages ) {
				if ( l > 0 ) { pas+= "\n"; }
				pas += mes;
				l++;
			}
			pas += "</div>\n";
		}
		
		if ( this.extraEffectsDescription != "" ) {
			pas += "<div class='standardBox'>" + this.extraEffectsDescription + "</div>\n";
		}
		
		if ( this.flagSceneEnded == false ) { // Scene has not ended
			if ( this.isPlayerInScene() && State.variables.chPlayerCharacter.koed == false ) { // Player is in scene
				pas += this.askForLeadScript + "\\"
					 + "\n" + this.getActionDescriptionButton() + "\n"
					 + this.formattedActionsOptionList + "\n"
					 + "Target:\n"
					 + this.formattedTargetsOptionList + "\n"
					 + this.getCommitActionButton();
					 // If end condition = turns && player in scene
					 // Print remaining turns
					 if ( ( this.checkEndConditions == endConditionTurns ) && ( this.teamAcharKeys.includes("chPlayerCharacter") || this.teamBcharKeys.includes("chPlayerCharacter") ) ) {
						 pas += "\n\nRemaining turns: " + (this.endConditionsVars + 1 - this.currentTurn);
						 //"currentTurn": 2, "turnLimit": -1, "importantMessages": "", "headingDe
					 } else if ( this.checkEndConditions == endConditionGrapes ) {
						 pas += "\n\nRemaining grapes: " + State.variables.sc.remainingGrapes;
					 }
			} else {						// Player isn't in scene
				pas += this.getPassTurnButton();
			}
		} else {
			if ( this.endSceneMessage != "" ) { pas += this.endSceneMessage + "\n\n"; }
			pas += this.endScenePassageScript;
		}
		
		// Transformation scene description
		if ( this.hasOwnProperty("tfFlag") ) {
			pas += "\n<div class='standardBox'>" + this.tfProgressDescription() + "</div>\n";
		}
		
		pas += "</div></div>";
		this.scenePassage = pas;
	}
	
	scene.prototype.getActionDescriptionButton = function() {
		var tButton = "<<cli" + 'ck "Action description">>\n'
				   + '<<scr' + 'ipt>>' + 'var dialog = Dialog.setup("Action Description", "my-dialog-class");\n'
				   + 'new Wikifier(dialog, Story.get("Scene Tests Dialog Box").processText());\n'
				   + 'Dialog.open();\n'
				   + '<</scr' + 'ipt>> \\'
				   + '<</c' + 'lick>>';
		return tButton;
	}
	scene.prototype.getCommitActionButton = function() {
		var tButton = '<<l' + 'ink [[Commit action|Scene]]>>\n<<sc' + 'ript>>\n'
					+ 'State.variables.sc.refreshIsPcActionValid();\n'
					+ 'if ( State.variables.sc.isPcActionValid.isUsable === false ) {\n'
					+ 'var dialog = Dialog.setup("Action cannot be used", "my-dialog-class");\n'
					+ 'new Wikifier(dialog, Story.get("Scene IsActionUsable Box").processText());\n'
					+ 'Dialog.open();\n' + '} else {\n'
					+ 'State.variables.sc.executeTurn();\n}'
					+ '<</s' + 'cript>><</l' + 'ink>><sup>[q]</sup>';
		return tButton;
	}
	scene.prototype.getPassTurnButton = function() {
		var tButton = '<<l' + 'ink [[Next turn|Scene]]>>\n<<sc' + 'ript>>\n'
					+ 'State.variables.sc.executeTurn();\n'
					+ '<</s' + 'cript>><</l' + 'ink>><sup>[q]</sup>';
			// Button to autocomplete battle
		   tButton += '\n<<l' + 'ink [[Auto-resolve scene|Scene]]>>\n<<sc' + 'ript>>\n'
					+ 'State.variables.sc.autoResolveSceneAlt();\n'
					+ '<</s' + 'cript>><</l' + 'ink>><sup>[w]</sup>';
		return tButton;
	}

	scene.prototype.formatFullAvatarDiv = function() {
		var dText = '<<removeclass "#right-ui-bar" "stowed">> \ '
		
		if ( gC(this.selectedFullAvatar).fullPortrait != null ) {															// Image
			dText += '\n<<addclass "#right-ui-bar" "stowed">> \ ' + '<div class="portraitBox">' + '<center>' + this.getButtonHideFullAvatar() + '</center>'
				   + '\n<img src="' + gC(this.selectedFullAvatar).fullPortraitL + '" alt="" style="float: right"></div>';
		} else if ( gC(this.selectedFullAvatar).avatar != null ) {
			dText += '\n<<addclass "#right-ui-bar" "stowed">> \ ' + '<div class="portraitBox">' + '<center>' + this.getButtonHideFullAvatar() + '</center>'
				   + '\n<img src="' + gC(this.selectedFullAvatar).avatarL + '" alt="" style="float: right"></div>';
		}
		
		return dText;
	}
	
	// Meta-controls
	scene.prototype.markNextTurnLink = function() {
		if ( this.flagSceneActive ) {
			if ( State.variables.sc.teamAcharKeys.includes("chPlayerCharacter") || State.variables.sc.teamBcharKeys.includes("chPlayerCharacter") ) {
				State.variables.foundLinks = $("#passages a").toArray();
				var nextTurnLinkPosition = State.variables.foundLinks.length - 1;
				if ( State.variables.foundLinks[nextTurnLinkPosition].id != undefined ) {
					State.variables.foundLinks[nextTurnLinkPosition].id = "nextTurnLink";
				}
				State.variables.keysAssigned = [["q","nextTurnLink"],["Q","nextTurnLink"]];
			} else {
				var e = [];
				try {
					State.variables.foundLinks = $("#passages a").toArray();
					State.variables.keysAssigned = [];
					var nextTurnLinkPosition = State.variables.foundLinks.length - 2;
						State.variables.foundLinks[nextTurnLinkPosition].id = "nextTurnLink";
						State.variables.keysAssigned.push(["q","nextTurnLink"],["Q","nextTurnLink"]);
					var autoFinishLinkPosition = State.variables.foundLinks.length - 1;
						State.variables.foundLinks[autoFinishLinkPosition].id = "autoFinishLink";
						State.variables.keysAssigned.push(["w","autoFinishLink"],["W","autoFinishLink"]);
				} catch(e) {
				}
			}
		}
		else {
			State.variables.keysAssigned = [];
		}
	}

// Constructors, serializers, etc.
scene.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

scene.prototype.clone = function () {
	return (new scene())._init(this);
};

scene.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new scene())._init($ReviveData$)', ownData);
};

////////// END CONDITIONS FUNCTIONS //////////

window.endConditionTurns = function(turns) {
	var flagEndScene = false;
	
	if ( State.variables.sc.currentTurn > turns ) {
		flagEndScene = true;
	}
	
	return flagEndScene;
}

window.endConditionStandardBattle = function(turns) {
	var flagEndScene = false;
	var sceneResult = "none";
	var charKeys = State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys);
	var ckL = charKeys.length;
	var i = 0;
	
	// Check stalemate
	var posStalemate = true;
	while ( posStalemate && i < ckL ) {
		if ( gC(charKeys[i]).koed == false ) {
			posStalemate = false;
		}
		i++;
	}
	if ( posStalemate ) {
		flagEndScene = true;
		sceneResult = "stalemate";
	}
	
	// Check Team A victory
	if ( flagEndScene == false ) {
		var posTeamAwin = true;
		i = 0;
		while ( posTeamAwin && i < State.variables.sc.teamBcharKeys.length ) {
			if ( gC(State.variables.sc.teamBcharKeys[i]).koed == false ) {
				posTeamAwin = false;
			}
			i++;
		}
		if ( posTeamAwin ) {
			flagEndScene = true;
			sceneResult = "teamAwin";
		}
	}
	
	// Check Team B victory
	if ( flagEndScene == false ) {
		var posTeamBwin = true;
		i = 0;
		while ( posTeamBwin && i < State.variables.sc.teamAcharKeys.length ) {
			if ( gC(State.variables.sc.teamAcharKeys[i]).koed == false ) {
				posTeamBwin = false;
			}
			i++;
		}
		if ( posTeamBwin ) {
			flagEndScene = true;
			sceneResult = "teamBwin";
		}
	}
	
	if ( flagEndScene ) { State.variables.sc.extraEndInfo = sceneResult; }
	return flagEndScene;
}
window.createEndConditionStoryBattle = function(passageVictoryTeamA,passageVictoryTeamB) {
	var customScript = function(turns) {
		var flagEndScene = endConditionStandardBattle(turns);
		if ( State.variables.sc.extraEndInfo == "teamAwin" ) { // Team A wins
			State.variables.sc.endScenePassage = passageVictoryTeamA;
		} else { // Team A doesn't win
			State.variables.sc.endScenePassage = passageVictoryTeamB;
		}
		if ( flagEndScene ) {
			this.refreshEndScenePassageScript();
		}
		return flagEndScene;
	}
	return customScript;
}
window.createEndConditionStoryBattleWithDraw = function(passageVictoryTeamA,passageVictoryTeamB,passageDraw) {
	var customScript = function(turns) {
		var flagEndScene = endConditionStandardBattle(turns);
		if ( State.variables.sc.extraEndInfo == "teamAwin" ) { // Team A wins
			State.variables.sc.endScenePassage = passageVictoryTeamA;
		} else if ( State.variables.sc.extraEndInfo == "stalemate" ) { // Draw
			State.variables.sc.endScenePassage = passageDraw;
		} else { // Team A doesn't win
			State.variables.sc.endScenePassage = passageVictoryTeamB;
		}
		if ( flagEndScene ) {
			this.refreshEndScenePassageScript();
		}
		return flagEndScene;
	}
	return customScript;
}

//////// OTHER FUNCTIONS ////////

window.getSexDamageMult = function(actor,target,action) {
	// returns [] ; [0] is damage multiplier ; [1] is description
	var mult = 1;
	var luck = gCstat(actor,"luck");
	var isActor = false;
	if ( actor == target ) { isActor = true; }
	// Tastes
	mult += getSexPrefDamageMult(target,isActor,action);
	// Luck
	mult += -0.1 + luckedDiceThrow(luck) * 0.2;
	return [mult,getMultiplierDescription(mult)];
}

window.getSexPrefDamageMult = function(target,isActor,action) {
	var mult = 0;
	for ( var tag of setup.saList[action].flavorTags ) {
		if ( tag != "continuedAction" && tag != "position" ) {
			var cTag = tag;
			if ( cTag == "foreplay" || cTag == "talk" || cTag == "oral" || cTag == "fullsex" ) {
				effectMultiplier = 0.5;
			}
			var effectMultiplier = 1;
			// Select valid opposite tag if appropriate
			if ( tagVector(tag) && isActor == false ) {
				cTag = getOppositeTag(tag);
			}
			// Get extra altered state damage
			var asV = 0;
			for ( var as of gC(target).alteredStates ) {
				if ( as.hasOwnProperty("tag") ) {
					if ( as.tag == cTag ) {
						asV = as.intensity * effectMultiplier;
					}
				}
			}
			// Add rank, get final multiplier
			mult += gC(target).tastes[cTag].r * (0.03 * effectMultiplier) + asV;
		}
	}
	return mult;
}
window.tagVector = function(tag) {
	// Vectorized tag refers to those which meaning changes depending on whether the action is affecting the actor or the target.
	// "Foreplay" is a non-vectorized tag. "TargetPussy" is a vectorized tag: if the action affects a target, "usePussy" must be checked instead
	var flag = true;
	if ( tag == "foreplay" || tag == "oral" || tag == "fullsex" || tag == "talk" || tag == "bondage" || tag == "teasing" || tag == "hypnosis" || tag == "charm" || tag == "romantic" || tag == "denial" ) {
		flag = false;
	}
	return flag;
}
window.getOppositeTag = function(tag) {
	var rTag = tag;
	switch(tag) {
		case "useDick":
			rTag = "targetDick";
			break;
		case "usePussy":
			rTag = "targetPussy";
			break;
		case "useAnus":
			rTag = "targetAnus";
			break;
		case "useBreasts":
			rTag = "targetBreasts";
			break;
		case "useMouth":
			rTag = "targetMouth";
			break;
		case "useEyes":
			rTag = "targetEyes";
			break;
		case "useHands":
			rTag = "targetHands";
			break;
		case "useLegs":
			rTag = "targetLegs";
			break;
		case "useTail":
			rTag = "targetTail";
			break;
		case "targetDick":
			rTag = "useDick";
			break;
		case "targetPussy":
			rTag = "usePussy";
			break;
		case "targetAnus":
			rTag = "useAnus";
			break;
		case "targetBreasts":
			rTag = "useBreasts";
			break;
		case "targetMouth":
			rTag = "useMouth";
			break;
		case "targetEyes":
			rTag = "useEyes";
			break;
		case "targetHands":
			rTag = "useHands";
			break;
		case "targetLegs":
			rTag = "useLegs";
			break;
		case "targetTail":
			rTag = "useTail";
			break;
		case "top":
			rTag = "bottom";
			break;
		case "bottom":
			rTag = "top";
			break;
		case "domination":
			rTag = "submission";
			break;
		case "submission":
			rTag = "domination";
			break;
		case "usePain":
			rTag = "receivePain";
			break;
		case "receivePain":
			rTag = "usePain";
			break;
	}
	return rTag;
}

window.getSexDamageMultAlt = function(actor,target,tags) {
	// returns [] ; [0] is damage multiplier ; [1] is description
	var mult = 1;
	var luck = gCstat(actor,"luck");
	var isActor = false;
	if ( actor == target ) { isActor = true; }
	// Tastes
	mult += getSexPrefDamageMultAlt(target,isActor,tags);
	// Luck
	mult += -0.1 + luckedDiceThrow(luck) * 0.2;
	return [mult,getMultiplierDescription(mult)];
}
window.getSexPrefDamageMultAlt = function(target,isActor,tags) {
	var mult = 0;
	for ( var tag of tags ) {
		if ( tag != "continuedAction" && tag != "position" ) {
			var cTag = tag;
			if ( tagVector(tag) && isActor == false ) {
				cTag = getOppositeTag(tag);
			}
			mult += gC(target).tastes[cTag].r * 0.03;
		}
	}
	return mult;
}

window.getMultiplierDescription = function(mult) {
	var desc = "";
	if ( mult >= 1.2 ) {
		if ( mult >= 1.35 ) {
			desc = colorText(randomFromList(["Burning hot! ","Irresistible! ","Heating up! "]),"orangered");
		} else {
			desc = colorText(randomFromList(["Ravishing! ", "Exciting! ","Provoking! "]),"darkorange");
		}
	}
	return desc;
}

window.addExtraEffectDescription = function(desc) {
	if ( State.variables.sc.extraEffectsDescription != "" ) { State.variables.sc.extraEffectsDescription += "\n"; }
	State.variables.sc.extraEffectsDescription += desc;
}
window.executeAlteredStatesTurnEffects = function() {
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		for ( var as of gC(charKey).alteredStates ) {
			var effect = getAsTurnEffect(as);
			if ( effect ) {
				addExtraEffectDescription(effect(charKey));
			}
		}
	}
}

window.cleanTurnTags = function() {
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( gC(charKey).hasOwnProperty("turnTags") ) {
			delete gC(charKey).turnTags;
		}
	}
}

window.isCharInPrimaryContinuedAction = function(cK) {
	var flag = false;
	for ( var ca of State.variables.sc.continuedActions ) {
		if ( flag == false ) {
			if ( ca.rank > 1 ) {
				if ( ca.initiator == cK || ca.targetsList.includes(cK) ) {
					flag = true;
				}
			}
		}
	}
	return flag;
}

window.getActionsAgainstTarget = function(target) {
	var actions = [];
	var i = 0;
	while ( i < State.variables.sc.teamAchosenTargets.length ) {
		if ( State.variables.sc.teamAchosenTargets[i] == target ) {
			if ( State.variables.sc.teamAcharKeys[i] != target ) {
				actions.push(State.variables.sc.teamAchosenActions[i]);
			}
		}
		i++;
	}
	i = 0;
	while ( i < State.variables.sc.teamBchosenTargets.length ) {
		if ( State.variables.sc.teamBchosenTargets[i] == target ) {
			if ( State.variables.sc.teamBcharKeys[i] != target ) {
				actions.push(State.variables.sc.teamBchosenActions[i]);
			}
		}
		i++;
	}
	return actions;
}
window.getActionsAgainstTargetIncludingSelf = function(target) {
	var actions = [];
	var i = 0;
	while ( i < State.variables.sc.teamAchosenTargets.length ) {
		if ( State.variables.sc.teamAchosenTargets[i] == target ) {
			actions.push(State.variables.sc.teamAchosenActions[i]);
		}
		i++;
	}
	i = 0;
	while ( i < State.variables.sc.teamBchosenTargets.length ) {
		if ( State.variables.sc.teamBchosenTargets[i] == target ) {
			actions.push(State.variables.sc.teamBchosenActions[i]);
		}
		i++;
	}
	return actions;
}
window.doesActorsContinuedActionsInvolveBodypart = function(actor,part) {
	var flag = false;
	for ( var ca of State.variables.sc.continuedActions ) {
		if ( ca.initiator == actor ) {
			if ( ca.initiatorBodyparts.includes(part) ) {
				flag = true;
			}
		}
		if ( ca.targetsList.includes(actor) ) {
			if ( ca.targetsBodyparts.includes(part) ) {
				flag = true;
			}
		}
	}
	return flag;
}
window.doesActorsContinuedActionsInvolveBodypartCombination = function(actor,part,partnerPart) {
	var flag = false;
	for ( var ca of State.variables.sc.continuedActions ) {
		if ( ca.initiator == actor ) {
			if ( ca.initiatorBodyparts.includes(part) ) {
				if ( ca.targetsBodyparts.includes(partnerPart) ) {
					flag = true;
				}
			}
		}
		if ( ca.targetsList.includes(actor) ) {
			if ( ca.targetsBodyparts.includes(part) ) {
				if ( ca.initiatorBodyparts.includes(partnerPart) ) {
					flag = true;
				}
			}
		}
	}
	return flag;
}

window.anyOtherActorHasFreeBodypart = function(noActor,bodypart) {
	var hasBodypart = false;
	var scCharList = arrayMinusA(State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys),noActor);
	for ( var charKey of scCharList ) {
		if ( gC(charKey).body.hasOwnProperty(bodypart) ) {
			if ( gC(charKey).body[bodypart].state != "locked" ) {
				hasBodypart = true;
			}
		}
	}
	return hasBodypart;
}

window.cleanSceneTags = function() {
	var charList = State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys);
	for ( var charKey of charList ) {
		if ( gC(charKey).hasOwnProperty("sceneTags") ) {
			delete gC(charKey).sceneTags;
		}
	}
}

window.endSceneScriptRefreshLustIfOrgasmed = function() {
	var allChars = State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys);
	for ( var cK of allChars ) {
		if ( gC(cK).orgasmSceneCounter > 0 || gC(cK).mindblowingOrgasmSC > 0 || State.variables.sc.sceneType == "bs" ) {
			gC(cK).lust.restore();
		}
	}
}
window.setRefreshLustScript = function() {
	State.variables.sc.endSceneScript = endSceneScriptRefreshLustIfOrgasmed;
}
window.endSceneScriptRefreshSomeLustIfOrgasmed = function() {
	var allChars = State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys);
	for ( var cK of allChars ) {
		if ( gC(cK).lust.max * 0.5 > gC(cK).lust.current ) {
			gC(cK).lust.current += gC(cK).lust.max * 0.25; 
		}
	}
}
window.setRefreshSomeLustBattleScript = function() {
	State.variables.sc.endSceneScript = endSceneScriptRefreshSomeLustIfOrgasmed;
}

	// Data
window.getCharsEnemyTeam = function(cK) { // Checks if the "cK" character is in any team. If so, returns the opposite team
	var team = [];
	if ( State.variables.sc.teamAcharKeys.includes(cK) ) {
		team = State.variables.sc.teamBcharKeys;
	}
	if ( State.variables.sc.teamBcharKeys.includes(cK) ) {
		team = State.variables.sc.teamAcharKeys;
	}
	return team;
}

////////// SCENE ACTION RESULTS CLASS //////////

/* Scene actions now require both an effect value and a description to be returned.
This class will return all the required information from an action. */

window.saResults = function() {
	this.value = 0;
	this.description = "";
};

// Constructors, serializers, etc.
saResults.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

saResults.prototype.clone = function () {
	return (new saResults())._init(this);
};

////////// IS USABLE RESULTS CLASS //////////

/* Log that tells if the action is usable in the specified context, and carries a message explaining why not. */

window.isUsableResults = function() {
	this.isUsable = true;
	this.explanation = "";
};

window.isActionUsable = function(actionKey,actorKey,targetsKeys,skipLinkedCheck) {
	var iAU = new isUsableResults;
	
	var action = setup.saList[actionKey];
	var actor = getChar(actorKey);
	var targetsList = getCharList(targetsKeys);
	
	var isPositionValid = false;
	
	// Allowed by settings
	if ( action.getIsAllowedBySettings ) {
		if ( action.getIsAllowedBySettings() == false ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "This action is disallowed by user-selected settings.\n"; }
		}
	}
	if ( action.getIsCustomAllowed ) {
		if ( action.getIsCustomAllowed(actionKey,actorKey,targetsKeys,skipLinkedCheck) == false ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "This action is disallowed by a custom requirement.\n"; }
		}
	}
	
	// Is target ko'ed
	if ( targetsKeys.length > 0 ) {
		if ( gC(targetsKeys[0]).koed && actionKey != "doNothing" ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) {  iAU.explanation += "The target is KO.\n"; }
		}
	}
	
	// Is lewding allowed
	if ( State.variables.sc.sceneType == "bs" ) {
		if ( isLewdingPossible(actorKey,targetsKeys[0]) == false ) {
			if ( action.affinities.includes("sex") ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Lewding involving male characters is disallowed by user-selected settings.\n"; }
			}
		}
	}
	
	// Basic tags
	for ( var reqTag in action.reqTags ) {
		var req = action.reqTags[reqTag];
		switch(req) {
			case "diffTarget":										// Check If actor may target self
				for ( var target in targetsKeys ) {
					if ( actorKey == targetsKeys[target] ) {
						iAU.isUsable = false;
						if ( State.variables.settings.debugFunctions ) {  iAU.explanation += "This action cannot target its own user.\n"; }
					}
				}
				break;
			case "hasLead":											// Must have the lead in the scene
				if ( gC(actorKey).hasLead == false ) {
					iAU.isUsable = false;
					if ( State.variables.settings.debugFunctions ) {  iAU.explanation += "This action requires the user to be leading.\n"; }
				}
				break;
			case "control":											// Must have control in battle
				if ( gC(actorKey).control <= 0 ) {
					iAU.isUsable = false;
					if ( State.variables.settings.debugFunctions ) { iAU.explanation += "This action requires the user to have control higher than 0.\n"; }
				}
				break;
			case "activePosition":									// Shares a position with the target where the actor is the initiator
				var flagActivePosition = false;
				if ( gC(actorKey).position.type == "active" ) {
					if ( gC(actorKey).position.targetsList.includes(targetsKeys[0]) ) {
						flagActivePosition = true;
					}
				}
				if ( flagActivePosition == false ) {
					iAU.isUsable = false;
					if ( State.variables.settings.debugFunctions ) { iAU.explanation += "This action requires the user to be the initiator in a position with the target.\n"; }
				}
				 break;
			case "unusedWeapon":									// Requires the actor to have a currently unused weapon
				if ( isCharsWeaponInUse(actorKey) ) {
					iAU.isUsable = false;
					if ( State.variables.settings.debugFunctions ) { iAU.explanation += "This action requires the user's weapon to be currently not in use.\n"; }
				}
				break;
			case "struggle":										// Specific checks for struggle action
				if ( State.variables.sc.sceneType != "bs" ) {
					iAU.isUsable = false;
					if ( State.variables.settings.debugFunctions ) { iAU.explanation += "This action is only usable in battle scenes.\n"; }
				}
				if ( gC(actorKey).position.type != "passive" ) {
					iAU.isUsable = false;
					if ( State.variables.settings.debugFunctions ) { iAU.explanation += "This action is only usable if the actor is being held down.\n"; }
				}
				break;
		}
	}
	
	// Bodyparts
	for ( var rbp in action.actorBpReqs ) {							// Check actor required bodyparts
		if ( actor.body.hasOwnProperty(action.actorBpReqs[rbp]) ) { // Check If has property {
			if ( actor.body[action.actorBpReqs[rbp]].state != "free" ) {
				
				iAU.isUsable = false;
				if ( State.variables.settings.debugFunctions ) { iAU.explanation += "The character doesn't have the required free " + action.actorBpReqs[rbp] + " to perform the action.\n"; }
			}
		}
		else {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "The character doesn't have the required " + action.actorBpReqs[rbp] + " to perform the action.\n"; }
		}
	}
	for ( var rbp in action.targetBpReqs ) {						// Check target required bodyparts
		for ( var target in targetsList ) {
			if ( targetsList[target].body.hasOwnProperty(action.targetBpReqs[rbp]) ) { // Check If has property {
				if ( targetsList[target].body[action.targetBpReqs[rbp]].state != "free" ) {
					
					iAU.isUsable = false;
					if ( State.variables.settings.debugFunctions ) { iAU.explanation += "A target doesn't have the required free " + action.targetBpReqs[rbp] + " to perform the action.\n"; }
				}
			}
			else {
				iAU.isUsable = false;
				if ( State.variables.settings.debugFunctions ) { iAU.explanation += "A target doesn't have the required " + action.targetBpReqs[rbp] + " to perform the action.\n"; }
			}
		}
	}
	for ( var rlbp of action.targetLockedBpReqs ) {
		for ( var target of targetsList ) {
			if ( target.body.hasOwnProperty(rlbp) ) {
				if ( target.body[rlbp].state != "locked" ) {
					iAU.isUsable = false;
					if ( State.variables.settings.debugFunctions ) { iAU.explanation += "A target doesn't have the required locked " + rlbp + " to perform the action.\n"; }
				}
			} else {
				iAU.isUsable = false;
				if ( State.variables.settings.debugFunctions ) { iAU.explanation += "A target doesn't have the required " + rlbp + " to perform the action.\n"; }
			}
		}
	}
	
	// Required Continued Actions
	if ( (action.requiredActiveCAs.concat(action.requiredPassiveCAs)).length > 0 ) {
		var flagHasRequiredCA = false;
		
		for ( var ca of State.variables.sc.continuedActions ) {
			if ( flagHasRequiredCA == false ) {
				if ( action.requiredActiveCAs.includes(ca.key) ) {
					if ( ca.initiator == actorKey && ca.targetsList.includes(targetsKeys[0])) {
						flagHasRequiredCA = true;
					}
				}
				if ( action.requiredPassiveCAs.includes(ca.key) && ca.initiator == targetsKeys[0]) {
					if ( ca.targetsList.includes(actorKey) ) {
						flagHasRequiredCA = true;
					}
				}
			}
		}
		if ( flagHasRequiredCA == false && gC(actorKey).position.type != "free" ) {
			if ( gC(actorKey).position.type == "active" && gC(actorKey).position.cAction ) {
				if ( action.requiredActiveCAs.includes(gC(actorKey).position.cAction.key) ) {
					if ( gC(actorKey).position.cAction.targetsList.includes(targetsKeys[0]) ) {
						flagHasRequiredCA = true;
					}
				}
			}
			else if ( gC(actorKey).position.type == "passive" ) {
				var p = gC(gC(actorKey).position.initiator).position;
				
				if ( p.cAction ) {
					if ( action.requiredPassiveCAs.includes(p.cAction.key) && p.cAction.initiator == targetsKeys[0] ) {
						flagHasRequiredCA = true;
					}
				}					
			}
			/*
			else if ( gC(actorKey).position.type == "passive" ) {
				if ( action.requiredPassiveCAs.includes(gC(actorKey).position.cAction.key) ) {
					if ( gC(actorKey).position.cAction.initiator == targetsKeys[0] ) {
						flagHasRequiredCA = true;
					}
				}
			}
			*/
		}
		
		if ( flagHasRequiredCA == false ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "This action lacks a required continued action.\n"; }
		}
	}
	if ( action.requiredCAs.length > 0 ) {
		var flagHasRequiredCA = false;
		
		for ( var ca of State.variables.sc.continuedActions ) {
			if ( flagHasRequiredCA == false ) {
				if ( action.requiredCAs.includes(ca.key) ) {
					if ( (ca.initiator == actorKey && ca.targetsList.includes(targetsKeys[0])) || (targetsKeys.includes(ca.initiator) && ca.targetsList.includes(actorKey)) ) {
						flagHasRequiredCA = true;
					}
				}
			}
		}
		
		if ( flagHasRequiredCA == false ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "This action lacks a required continued action.\n"; }
		}
	}
	
	// Positions
	if ( action.requiredPositions.length > 0 ) { // Check actor required positions
		if ( action.requiredPositions.includes(actor.position.key) == false ) { 	// Actor has valid position?
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "The actor doesn't have a valid position.\n"; }
		}
	}
	if ( action.targetRequiredPositions.length > 0 ) { // Check target required positions
		for ( var target of targetsList ) {
			if ( action.targetRequiredPositions.includes(target.position.key) == false ) {
				iAU.isUsable = false;
				if ( State.variables.settings.debugFunctions ) {  iAU.explanation += "A target doesn't have a valid position.\n"; }
			}
		}
	}
	if ( action.linkedPositions == true && skipLinkedCheck == false ) {
		for ( var target of targetsList ) {
			if ( areCharactersLinked(actorKey,target.varName) == false ) {
				iAU.isUsable = false;
				if ( State.variables.settings.debugFunctions ) { iAU.explanation += "The actor and a target don't share a position.\n"; }
			}
		}
	}
	
	if ( action.unvalidRelationalPositions.length > 0 ) { // Check unvalid relational positions
		for ( var positions of action.unvalidRelationalPositions ) {
			for ( var target of targetsList ) {
				if ( (positions[0] == actor.position.key) && (positions[1] == target.position.key) && (areCharactersLinked(actorKey,target.varName) == true) ) {
					iAU.isUsable = false;
					if ( State.variables.settings.debugFunctions ) { iAU.explanation += "The actor and a target share an invalid position.\n"; }
				}
			}
		}
	}
	
	// Position
	if ( ( action.tags.includes("pos") || action.actionType == "pounce" ) && skipLinkedCheck == false ) {
		if ( gC(actorKey).position.key != "free" || gC(targetsKeys[0]).position.key != "free" ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "The actor and a target should be free to initiate a positional action.\n"; }
		}
	}
	if ( action.tags.includes("cpos") ) {
		if ( action.getRequiredPositioning(actorKey,targetsKeys[0]) == false  ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "The target doesn't have a valid position.\n"; }
		}
		if ( gC(actorKey).position.key != "free" && gC(targetsKeys[0]).position.key != "free" ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "At least one character must be free.\n"; }			
		}
	}
	
	// Continued actions
	if ( action.requiredActorContinuedActions.length > 0 ) {
		var caFound = false;
		for ( var ca of State.variables.sc.continuedActions ) {
			if ( action.requiredActorContinuedActions.includes(ca.key) ) {
				if ( ca.initiator == actorKey || ca.targetsList.includes(actorKey) ) {
					caFound = true;
				}
			}
		}
		if ( caFound == false ) {
				iAU.isUsable = false;
				if ( State.variables.settings.debugFunctions ) { iAU.explanation += "The actor requires to be involved in a specific continued action.\n"; }
		}
	}
	
	// Lead
	if ( State.variables.sc.enabledLead != "none" ) {
		if ( action.tags.includes("cAct") || action.tags.includes("pos") || action.tags.includes("cpos") ) {
			if ( actor.hasLead == false ) {
				iAU.isUsable = false;
				if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Positional and continued actions require the actor to have the lead in this scene.\n"; }
			}
		}
	}
	
	// Can't change positions settings
	if ( State.variables.sc.sceneConditions.includes("cantChangePositions") ) {
		if ( action.tags.includes("pos") ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Changing positions isn't allowed during this scene.\n"; }
		}
	}
	
	// Race check
	if ( action.requiredRace.length > 0 ) {
		if ( action.requiredRace.includes(gC(actorKey).race) == false ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Action requires a race different than the actor's.\n"; }
		}
	}
	
	// Altered state checks
	if ( action.actorDisabledByAs.length > 0 ) {
		for ( var as of gC(actorKey).alteredStates ) {
			for ( var acr of action.actorDisabledByAs ) {
				if ( acr == as.acr ) {
					iAU.isUsable = false;
					if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Action disabled by altered state of the actor.\n"; }
				}
			}
		}
	}
	if ( action.targetDisabledByAs.length > 0 ) {
		for ( var as of gC(targetsKeys[0]).alteredStates ) {
			for ( var acr of action.targetDisabledByAs ) {
				if ( acr == as ) {
					iAU.isUsable = false;
					if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Action disabled by altered state of the target.\n"; }
				}
			}
		}
	}
	
	// Bar costs checks
	if ( action.willpowerCost > 0 ) {
		if ( gC(actorKey).willpower.current < gC(actorKey).willpower.calculateCost(action.willpowerCost) ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Actor doesn't have enough willpower to perform the action.\n"; }
		}
	}
	if ( action.energyCost > 0 ) {
		if ( gC(actorKey).energy.current < gC(actorKey).energy.calculateCost(action.energyCost) ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Actor doesn't have enough energy to perform the action.\n"; }
		}
	}
	if ( action.socialdriveCost > 0 ) {
		if ( gC(actorKey).socialdrive.current < gC(actorKey).socialdrive.calculateCost(action.socialdriveCost) ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Actor doesn't have enough socialdrive to perform the action.\n"; }
		}
	}
	
	// Battle Position checks
	if ( action.tags.includes("bPos") ) {
		if ( gC(actorKey).position.key != "free" ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Actor requires not being in any position to perform the action.\n"; }
		} else {
			for ( var target of targetsKeys ) {
				if ( gC(target).position.key != "free" ) {
					iAU.isUsable = false;
					if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Targets require not being in any position to perform the action.\n"; }
				}
			}
		}
	}
	
	// No position check
	if ( action.requiresFree ) {
		if ( gC(actorKey).position.type != "free" ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Actor needs to be free of any position to perform the action.\n"; }
		}
	}
	
	// Multiple full sex continued actions
	if ( action.flavorTags.includes("fullsex") && action.flavorTags.includes("continuedAction") ) { // Action is fsca
		if ( gSettings().mfsca == undefined ) { // Ensure setting is properly defined, required for retro save compatibility
			gSettings().mfsca = setup.defaultMfscaOption;
		}
		if ( gSettings().mfsca == "disable" ) { // Is mfsca disallowed by settings
		
			var existingFsca = false;
			for ( var ca of State.variables.sc.continuedActions ) {
				if ( (ca.initiator == actorKey && ca.targetsList.includes(targetsKeys[0])) || (ca.initiator == targetsKeys[0] && ca.targetsList.includes(actorKey)) ) {
					if ( ca.flavorTags.includes("fullsex") ) {
						existingFsca = true;
					}
				}
			}
			if ( existingFsca ) {
				iAU.isUsable = false;
				if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Multiple full sex continued actions are disabled.\n"; }
			}
		}
	}
	
	// Transformation actions
	if ( action.tags.includes("tf") ) {
		if ( State.variables.sc.hasOwnProperty("tfFlag") == false ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Transformation action in non-transformation scene.\n"; }
		} else if ( targetsKeys[0] != State.variables.sc.tfTarget ) {
			iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Transformation action for anyone other than transformation target.\n"; }
		} else {
			var requiresTfPoints = false;
			for ( var tfGoal of action.tfGoals ) {
				if ( getRequiredPointsForTfGoal(tfGoal) > 0 ) {
					requiresTfPoints = true;
				}
			}
			if ( requiresTfPoints == false ) {
				iAU.isUsable = false;
			if ( State.variables.settings.debugFunctions ) { iAU.explanation += "Transformation goals aren't required anymore.\n"; }
			}
		}
	}
	
	return iAU;
};
window.isActionUsableOnPos = function(actionKey,actorKey,targetKeys,actorPos,targetsPos) {
	var iAU = new isUsableResults;
	// Remember positions
	var originalActorPos = gC(actorKey).position.key;
	var originalTargetPos = [];
	for ( var cK of targetKeys ) {
		originalTargetPos.push(gC(cK).position.key);
	}
	// Stablish hypothetical positions
	gC(actorKey).position.key = actorPos;
	var i = 0;
	for ( var cK of targetKeys ) {
		gC(cK).position.key = targetsPos[i];
		i++;
	}
	// Check results
	iAU = isActionUsable(actionKey,actorKey,targetKeys,true);
	// Re-stablish old positions
	gC(actorKey).position.key = originalActorPos;
	i = 0;
	for ( var cK of targetKeys ) {
		gC(cK).position.key = originalTargetPos[i];
		i++;
	}
	// Return results
	return iAU;
}

window.areCharactersLinked = function(charA,charB) {
	var flagLinked = false;
	
	if ( gC(charA).position.type == "active" ) {
		if ( gC(charA).position.targetsList.includes(charB) ) {
			flagLinked = true;
		}
		else if ( gC(gC(charA).position.targetsList[0]).position.hasOwnProperty('secondaryInitiators') )
		{
			var pos = gC(gC(charA).position.targetsList[0]).position;
			if ( pos.initiator == charB || pos.secondaryInitiators.includes(charB) ) {
				flagLinked = true;
			}
		}
	}
	else if ( gC(charA).position.type == "passive" ) {
		if ( gC(charA).position.initiator == charB ) {
			flagLinked = true;
		}
		else if ( gC(charA).position.hasOwnProperty('secondaryInitiators') ) {
			if ( gC(charA).position.secondaryInitiators.includes(charB) ) {
				flagLinked = true;
			}
		}
	}
	
	return flagLinked;
};

window.tryExecuteAction = function(actionKey,actorKey,targetKeys) {
	var iAU = new isUsableResults;
	var results = new saResults;
	
	iAU = isActionUsable(actionKey,actorKey,targetKeys,false);
	if ( iAU.isUsable ) { // Action may be used, execute:
		results = setup.saList[actionKey].execute(actorKey,targetKeys);
	}
	else {
		results.description = "The action couldn't be executed.";
	}
	
	return results;
}

// Constructors, serializers, etc.
isUsableResults.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

isUsableResults.prototype.clone = function () {
	return (new isUsableResults())._init(this);
};

////////// SCENE ACTION CLASS //////////

/* How these work

State.variables has a list of sceneActions
Each character has a list of learnt sceneActions, identified by their name or ID
Each action has a list of tags which mark their range.

Upon executing an action, its ID is used to access the original action on State.variables.saList, which provides a description.
																		-> setup.saList
Actions are executed by calling their execute() method, which applies all of its effects.
	The execute() method requires the actor using the action and a list of targets as parameters,
	and returns a string describing the action's effects.
	
Tags
  Scene Type Tags - These tags link an action to a scene type.
					They will only be usable If they share the type with the scene.
	ss = Sex Scene Action
	sbs = Sex Battle Scene Action
	bs = Battle Scene Action
	
  Type Use Tags - The tags differentiate between single-use and continued-use actions.
    sUse - Single Use
	cUse - Continued Use
*/

window.sceneAction = function() {
	this.name = "";
	this.key = "";
	this.targetType = "";
	this.actionType = "none";
	
	this.tags = []; // "ss","bs" -> Sex Scene, Battle Scene ; "sUse" -> Single Use ; "cAct" -> Continued Action ; "bPos" -> Battle Position
	this.reqTags = []; // Specific tags that change the action's requirements
						  // diffTarget -> Requires a target other than the actor	
						  // control -> Requires the actor's control to be higher than 0
	this.actorBpReqs = []; // The actor requires these body parts for the action to be possible
	this.targetBpReqs = [];	// The targets require these body parts for the action to be possible
	this.targetLockedBpReqs = []; // The targets require these bodyparts to be locked for the action to be possible
	this.flavorTags = [];
	this.strategyTags = [];
	this.affinities = [];
	
	this.getIsAllowedBySettings = null;
	this.getIsCustomAllowed = null; // function(actionKey,actorKey,targetsKeys,skipLinkedCheck) { return true; }
	
	this.requiredPositions = []; // If the list contains anything, the actor requires one of these positions
	this.targetRequiredPositions = []; // If the list contains anything, the targets require one of these positions
	this.linkedPositions = false; // If true, the actor and its targets require to be referenced as initiator or target in their respective positions
	
	this.requiredActorContinuedActions = []; // If any, the actor requires to be involved in any of these continued actions
	
	this.requiresFree = false; // If true, action will only be usable if actor has no position
	// this.unvalidPositions = []; // Is the actor's current position is in this list, the action isn't usable // Not implemented
	
	this.unvalidRelationalPositions = []; // List of 2-sized arrays. First element is actor position, second element is target position,
									     // If they match, the action can't be executed
	
	this.requiredActiveCAs = []; // Required Active and Passive Continued Actions refer to a set of continued actions of which at least
	this.requiredPassiveCAs = []; // one is required for the action to be possible.
								// Active ones require the character to be the initiator, passive ones requires the character to be the target.
	this.requiredCAs = []; // Required Continued Action, regardless of role.
	
	this.requiredRace = []; // If length > 0, requires the character's race to be included
	this.actorDisabledByAs = []; // If the character has any of these states, the action cannot be used
	this.targetDisabledByAs = []; // If the target has any of these states, the action cannot be used
		
	this.priority = 0;
	
	this.willpowerCost = 0; // If any of these three higher than 0, requires the character to have enough of it
	this.energyCost = 0;
	this.socialdriveCost = 0;
	
	this.description = "";
	
	this.execute = null; // Function. Returns a description of the action's effects during that particular use.
	// this.resultsMessage = null; // Function. Returns a string to be displayed on Sugarcube 2 with proper format.
};

window.applySaCosts = function(sa,actor) {
	if ( sa.energyCost ) {
		gC(actor).energy.applyCost(sa.energyCost);
	}
	if ( sa.willpowerCost ) {
		gC(actor).willpower.applyCost(sa.willpowerCost);
	}
	if ( sa.socialdriveCost ) {
		gC(actor).socialdrive.applyCost(sa.socialdriveCost);
	}
}
window.generateSaCostsText = function(sa,actor) {
	var costTexts = [];
	if ( sa.energyCost ) {
		var energyCost = gC(actor).energy.calculateCost(sa.energyCost);
		costTexts.push(textEnergyPoints(energyCost));
	}
	if ( sa.willpowerCost ) {
		var willpowerCost = gC(actor).willpower.calculateCost(sa.willpowerCost);
		costTexts.push(textWillpowerPoints(willpowerCost));
	}
	if ( sa.socialdriveCost ) {
		var socialdriveCost = gC(actor).socialdrive.calculateCost(sa.socialdriveCost);
		costTexts.push(textSocialdrivePoints(socialdriveCost));
	}
	var text = ktn(actor) + " consumed " + stringArrayToText(costTexts);
	return text;
}

window.createSaDoNothing = function() {
	var sa = new sceneAction();
	sa.name = "Do nothing";
	sa.key = "doNothing";
	sa.targetType = "self";
	sa.tags.push("ss");
	sa.tags.push("sbs");
	sa.tags.push("bs");
	sa.tags.push("sUse");
	
	sa.description = "The character surrenders themself to the whims of others.\n\nSelf-targetted action.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		results.value = 0;
		results.description = randomFromList([ ( (ktn(actorKey)) + " did nothing." ),
									( (ktn(actorKey)) + " stayed quiet." ),
									( (ktn(actorKey)) + " waited for the others to act.")]);
		
		return results;
	}
	return sa;
}
window.createBaPunch = function() {
	var ba = new sceneAction();
	ba.name = "Punch";
	ba.key = "punch";
	ba.targetType = "single";
	ba.tags.push("bs");
	ba.tags.push("sUse");
	ba.reqTags.push("diffTarget");
	ba.actorBpReqs.push("arms");
	
	ba.description = "The character punches a target.\n\nSingle target action.";
	ba.execute = function(actorKey,targetActors) {
		var results = new saResults;
		
		var healthDamage = ((getChar[actorKey].physique.getValue() * 2) / 5);
		targetActors[0].lust.changeValue(-healthDamage); // Change to health damage
		results.value = healthDamage;
		results.description += getChar[actorKey].formattedName + " punched " + getChar(targetActors[0]).formattedName + " for "
						  + healthDamage + " health damage.\n";
		
		return results;
	}
	return ba;
}

// Constructors, serializers, etc.
sceneAction.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

sceneAction.prototype.clone = function () {
	return (new sceneAction())._init(this);
};

sceneAction.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new sceneAction())._init($ReviveData$)', ownData);
};

////////// SCENE ACTIONS LIST CLASS //////////
// Scene Actions will be objects belonging to this object. This will ease the access to actions.
window.saList = function() {
	this.doNothing = createSaDoNothing();
	this.strokePussy = createSaStrokePussy();
	this.strokeBreasts = createSaStrokeBreasts();
	this.strokeDick = createSaStrokeDick();
	this.strokeAss = createSaStrokeAss();
	
	this.dickFootjob = createSaDickFootjob();
	this.pussyFootjob = createSaPussyFootjob();
	
	this.kissLips = createSaKissLips();
	this.frottage = createSaFrottage();
	
	this.lickLegs = createSaLickLegs();
	
	this.thrust = createSaThrust();
	this.analThrust = createSaAnalThrust();
	this.doubleThrust = createSaDoubleThrust();
	this.piston = createSaPiston();
	this.pushHipsBack = createSaPushHipsBack();
	this.pushAssBack = createSaPushAssBack();
	this.finalPush = createSaFinalPush();
	this.rideDick = createSaRideDick();
	this.pushDickBack = createSaPushDickBack();
	this.analRideDick = createSaAnalRideDick();
	this.analPushDickBack = createSaAnalPushDickBack();
	
	this.scissor = createSaScissor();
	
	this.fuckFace = createSaFuckFace();
	this.suckDick = createSaSuckDick();
	this.lickPussy = createSaLickPussy();
	this.rideFace = createSaRideFace();
	
	this.lickGroin = createSaLickGroin();
	
		// Fetish
	
	this.hypnoticGlance = createSaHypnoticGlance();
	this.lustfulGlance = createSaLustfulGlance();
	
	this.realHypnoticGlance = createSaRealHypnoticGlance();
	
	this.spanking = createSaSpanking();
	
	this.biteNeck = createSaBiteNeck();
	
	this.etherealChains = createSaEtherealChains();
	
	this.denyOrgasm = createSaDenyOrgasm();
	this.teaseLockedPussy = createSaTeaseLockedPussy();
	this.teaseLockedDick = createSaTeaseLockedDick();
	
			// Transformation
			
	this.sculptingKiss = createSaSculptingKiss();
	this.sculptChest = createSaSculptChest();
	this.sculptBody = createSaSculptBody();
	
	this.formDick = createSaFormDick();
	this.formPussy = createSaFormPussy();
	this.buryDick = createSaBuryDick();
	this.foldPussy = createSaFoldPussy();
	
	
		// Cont. actions
	
	this.frenchKiss = createSaFrenchKiss();
	this.legHoldHead = createLegHoldHead();
	this.extraLegHoldHead = createExtraLegHoldHead();
	this.giveCunnilingus = createGiveCunnilingus();
	this.getBlowjob = createSaGetBlowjob();
	this.giveBlowjob = createSaGiveBlowjob();
	
	this.penetratePussy = createSaPenetratePussy();
	this.penetrateAss = createSaPenetrateAss();
	this.interlockLegs = createSaInterlockLegs();
	this.mountDick = createSaMountDick();
	this.analMountDick = createSaAnalMountDick();
	
	this.doublePenetration = createSaDoublePenetration();
	
		// Positions
	this.mountFromBehind = createSaMountFromBehind();
	this.mountFaceToFace = createSaMountFaceToFace();
	this.kneel = createSaKneel();
	this.makeKneel = createSaMakeKneel();
	
		// Composite positions
	this.extraMountFromBehind = createSaExtraMountFromBehind();
	this.extraKneel = createSaExtraKneel();
	this.extraMakeKneel = createSaExtraMakeKneel();
	
	// Others //
	this.holdArms = createSaHoldArms();
	
	this.vinesHoldArms = createSaVinesHoldArms();
	
	this.slimeHug = createSaSlimeHug();
	
	this.energyDrainingKiss = createSaEnergyDrainingKiss();
	
	// Weapons
		// Dildo
	this.dildoTeaseGenitals = createSaDildoTeaseGenitals();
	
	this.thrustDildo = createSaThrustDildo();
	this.pushAgainstDildo = createSaPushAgainstDildo();
	
		// Continued actions
			// Dildo
	this.dildoPenetratePussy = createSaDildoPenetratePussy();
	this.dildoPenetrateAss = createSaDildoPenetrateAss();
	this.dildoPenetrateMouth = createSaDildoPenetrateMouth();
	
	this.doubleDildoPussyPenetration = createSaDoubleDildoPussyPenetration();
	//
	
	this.punch = createBaPunch(); // ToDo: Remove this
	
	////////////////// BATTLE SCENE ACTIONS ////////////////
	this.struggle = createSaStruggle();
	
	this.baKissLips = createSaBaKissLips();
	this.baStrokeDick = createSaBaStrokeDick();
	this.baStrokePussy = createSaBaStrokePussy();
	
	this.baTeaseLockedDick = createSaBaTeaseLockedDick();
	this.baTeaseLockedPussy = createSaBaTeaseLockedPussy();
	
	this.pounceFrontal = createSaNeutralFrontalPounce();
	
	this.pounceFrontalD2P = createSaD2PfrontalPounce();
	this.baThrust = createSaBaThrust();
	this.baPushHipsBack = createSaBaPushHipsBack();
	
	this.pounceFrontalP2P = createSaP2PfrontalPounce();
	this.baScissor = createSaBaScissor();
	this.baScissorBack = createSaBaScissorBack();
	
	this.pounceFrontalP2D = createSaP2DfrontalPounce();
	this.baRideDick = createSaBaRideDick();
	this.baPushDickBack = createSaBaPushDickBack();
	
		// Items
	this.baDildoPenetratePussy = createSaBaDildoPenetratePussy();
	
	this.baThrustDildo = createSaBaThrustDildo();
	
	// Physical
	
	this.kick = createSaKick();
	this.coldGuts = createSaColdGuts();
	
		// Pain
		
	this.baScratch = createSaBaScratch();
	
	this.catAspect = createSaCatAspect();
	
	// Magic
	
	this.holyBlast = createHolyBlast();
	this.embers = createSaEmbers();
	this.flamingFan = createSaFlamingFan();
	this.flaringFeint = createFlaringFeint();
	this.freezeFeet = createSaFreezeFeet();
	this.sparkingRubbing = createSaSparkingRubbing();
	this.lightningDarts = createSaLightningDarts();
	this.earthWall = createEarthWall();
	this.quake = createSaQuake();
	
	this.taunt = createSaTaunt();
	this.baTease = createSaBaTease();
	
		// Hypnosis
	
	this.baHypnoticGlance = createSaBaHypnoticGlance();
	this.baOrderKneeling = createBaOrderKneeling();
	this.baOrderMasturbation = createBaOrderMasturbation();
	this.baCorrodeMind = createBaCorrodeMind();
	this.tackle = createTackle();
	
		// Drain
		
	this.baDrainingKiss = createSaBaDrainingKiss();
	this.baEnergyDrainingKiss = createSaBaEnergyDrainingKiss();
	this.baDrainingRoots = createBaDrainingRoots();
	
		// Bondage
		
	this.baEtherealChains = createSaBaEtherealChains();
			
			// Vines
			
	this.baVineArmLock = createSaBaVineArmLock();
	
		// Transformation
		
	this.baBorrowedIdentity = createBorrowedIdentity();
	
		// Spores
		
	this.baRelaxingScent = createSaRelaxingScent();
	
	// Items
	this.staffSwipe = createStaffSwipe();
	this.boldJab = createBoldJab();
	this.channelAether = createSaChannelAether();
	this.flaunt = createSaFlaunt();
	this.disablingShot = createDisablingShot();
};

window.returnBaList = function() {
	return ["struggle","baKissLips","baStrokeDick","baStrokePussy","baTeaseLockedDick","baTeaseLockedPussy","pounceFrontal","pounceFrontalD2P","pounceFrontalP2D","pounceFrontalP2P","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","coldGuts","baScratch","catAspect","embers","freezeFeet","sparkingRubbing","lightningDarts","taunt","baTease","baHypnoticGlance","baOrderKneeling","baDrainingKiss","baEnergyDrainingKiss","baEtherealChains","baVineArmLock","baBorrowedIdentity","baRelaxingScent","holyBlast","flamingFan","flaringFeint","disablingShot","earthWall","quake"];
}
window.returnFirstScrollGroupActionsList = function() {
	return ["pushHipsBack","pushAssBack","scissor","thrust","mountFromBehind","rideDick","pushDickBack","kneel","makeKneel","legHoldHead","getBlowjob","fuckFace","suckDick","lickPussy","rideFace","giveCunnilingus","giveBlowjob",'strokeAss','penetrateAss','analThrust','doublePenetration','doubleThrust','analMountDick','analRideDick','analPushDickBack','spanking','holdArms','vinesHoldArms','dickFootjob','pussyFootjob','lickLegs','denyOrgasm','teaseLockedPussy','teaseLockedDick','baTeaseLockedDick','baTeaseLockedPussy','extraMountFromBehind','extraKneel','extraMakeKneel','extraLegHoldHead','coldGuts','pounceFrontal'];
}

// Constructors, serializers, etc.
saList.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

saList.prototype.clone = function () {
	return (new saList())._init(this);
};

saList.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new saList())._init($ReviveData$)', ownData);
};

// Auxiliars

window.doesAnyActionContainTag = function(actionsList,tag) {
	var flag = false;
	for ( var action of actionsList ) {
		if ( setup.saList[action].flavorTags.includes(tag) ) {
			flag = true;
		}
	}
	return flag;
}
window.doesAnyActionContainTags = function(actionsList,tagsList) {
	var flag = false;
	for ( var action of actionsList ) {
		var itFlag = true;
		for ( var tag of tagsList ) {
			if ( setup.saList[action].flavorTags.includes(tag) == false ) {
				itFlag = false;
			}
		}
		if ( itFlag == true ) { flag = true; }
	}
	return flag;
}

window.getCurrentContinuedActionsBetweenInitiatorAndTarget = function(initiator,target) {
	var existingCAs = [];
	
	// Continued actions
	for ( var ca of State.variables.sc.continuedActions ) {
		if ( ca.initiator == initiator && ca.targetsList.includes(target) ) {
			existingCAs.push(ca.key);
		}
	}
	
	return existingCAs;
}

////////// SEX SCENE ACTIONS //////////

	// Stroking

window.createSaStrokePussy = function() {
	var sa = new sceneAction();
	sa.name = "Stroke pussy";
	sa.key = "strokePussy";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.actorBpReqs.push("arms");
	sa.targetBpReqs.push("pussy");
	
	sa.unvalidRelationalPositions.push(["standing","kneeling"]);
	
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastTarget"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	
	sa.flavorTags.push("foreplay","useHands","targetPussy");
	
	sa.description = "The character strokes a pussy.\nThis action will sensitize the target's pussy.\n\nSingle target action.\n"
				   + "Actor requires free hands, target requires free pussy.\n\nForeplay\n\n__Influences__:\nDamage: Actor's agility x1.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		
		for (var target of targetActors) {
			var multAr = getSexDamageMult(actorKey,target,this.key);
			var lustDamage = ((getChar(actorKey).agility.getValue() * 2) / 10) * multAr[0];
			getChar(target).lust.changeValue(-lustDamage);
			
			if ( doesCharHaveAlteredState(target,"Pus+") == false ) {
				// Sensitized pussy
				var intensity = 0.05 + gCstat(actorKey,"agility") * 0.005 + limitedRandomInt(5) * 0.01;
				var turns = 4 + limitedRandomInt(4) + (gCstat(actorKey,"agility") * 0.04) - ((gCstat(actorKey,"agility") * 0.04) % 1);
				var as = createSensitizedTag(intensity,"usePussy","Sensitized pussy","Pus+",turns,"The pussy of this character will receive extra damage.");
				applyAlteredState([target],as);
			}
			
			results.value += lustDamage;
			results.description += randomFromList( [
											(ktn(actorKey) + " stroked " + ktn(target) + "'s " + pussyWord() + "."),
											(ktn(actorKey) + " caressed " + ktn(target) + "'s " + pussyWord() + "."),
											(ktn(actorKey) + " masturbated " + ktn(target) + "'s " + pussyWord() + ".") ] );
			results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		}
		
		return results;
	}
	return sa;
}
window.createSaStrokeBreasts = function() {
	var sa = new sceneAction();
	sa.name = "Stroke breasts";
	sa.key = "strokeBreasts";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.actorBpReqs.push("arms");
	sa.targetBpReqs.push("breasts");
	sa.unvalidRelationalPositions.push(["standing","kneeling"]);
	
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["mountedFromBehind","mountingFromBehind"],["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("foreplay","useHands","targetBreasts");
	
	sa.description = "The character strokes breasts.\nThis action will sensitize the target's breasts.\n\nSingle target action.\n"
				   + "Actor requires free hands, target requires free breasts.\n\nForeplay.\n\n__Influences__:\nDamage: Actor's agility x1.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		if ( doesCharHaveAlteredState(target,"Bre+") == false ) {
			// Sensitized breasts
			var intensity = 0.05 + gCstat(actorKey,"agility") * 0.005 + limitedRandomInt(5) * 0.01;
			var turns = 4 + limitedRandomInt(4) + (gCstat(actorKey,"agility") * 0.04) - ((gCstat(actorKey,"agility") * 0.04) % 1);
			var as = createSensitizedTag(intensity,"useBreasts","Sensitized breasts","Bre+",turns,"The breasts of this character will receive extra damage.");
			applyAlteredState([target],as);
		}
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).agility.getValue() * 2) / 10) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " stroked " + ktn(target) + "'s " + boobsWord() + "."),
									(ktn(actorKey) + " massaged " + ktn(target) + "'s " + boobsWord() + "."),
									(ktn(actorKey) + " masturbated " + ktn(target) + "'s " + boobsWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
							   
		return results;
	}
	return sa;
}
window.createSaStrokeDick = function() {
	var sa = new sceneAction();
	sa.name = "Handjob";
	sa.key = "strokeDick";
	sa.targetType = "single";
	sa.tags.push("ss","sUse");
	sa.actorBpReqs.push("arms");
	sa.targetBpReqs.push("dick");
	sa.unvalidRelationalPositions.push(["standing","kneeling"]);
	
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastTarget"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	
	sa.flavorTags.push("foreplay","useHands","targetDick");
	
	sa.description = "The character massages a dick.\nThis action will sensitize the target's dick.\n\nSingle target action.\n"
				   + "Actor requires free hands, target requires free dick.\n\nForeplay.\n\n__Influences__:\nDamage: Actor's agility x1.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		if ( doesCharHaveAlteredState(target,"Dic+") == false ) {
			// Sensitized dick
			var intensity = 0.05 + gCstat(actorKey,"agility") * 0.005 + limitedRandomInt(5) * 0.01;
			var turns = 4 + limitedRandomInt(4) + (gCstat(actorKey,"agility") * 0.04) - ((gCstat(actorKey,"agility") * 0.04) % 1);
			var as = createSensitizedTag(intensity,"useDick","Sensitized dick","Dic+",turns,"The dick of this character will receive extra damage.");
			applyAlteredState([target],as);
		}
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((gC(actorKey).agility.getValue() * 2) / 10) * multAr[0];
		gC(target).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " stroked " + ktn(target) + "'s " + dickWord() + "."),
									(ktn(actorKey) + " massaged " + ktn(target) + "'s " + dickWord() + "."),
									(ktn(actorKey) + " masturbated " + ktn(target) + "'s " + dickWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		return results;
	}
	return sa;
}
window.createSaStrokeAss = function() {
	var sa = new sceneAction();
	sa.name = "Tease ass";
	sa.key = "strokeAss";
	sa.targetType = "single";
	sa.tags.push("ss","sUse");
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		
		if ( State.variables.settings.anal == "disable" ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	
	sa.actorBpReqs.push("arms");
	sa.targetBpReqs.push("anus");
	sa.unvalidRelationalPositions.push(["standing","kneeling"],["mountedFromBehind","mountingFromBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastTarget"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	
	sa.flavorTags.push("foreplay","useHands","targetAnus");
	
	sa.description = "The character strokes the area surrounding the target's anus.\nThis action will sensitize the target's ass.\n\nSingle target action.\n"
				   + "Actor requires free hands, target requires free anus.\n\nForeplay.\n\n__Influences__:\nDamage: Actor's agility x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		if ( doesCharHaveAlteredState(target,"Ass+") == false ) {
			// Sensitized ass
			var intensity = 0.05 + gCstat(actorKey,"agility") * 0.005 + limitedRandomInt(5) * 0.01;
			var turns = 4 + limitedRandomInt(4) + (gCstat(actorKey,"agility") * 0.04) - ((gCstat(actorKey,"agility") * 0.04) % 1);
			var as = createSensitizedTag(intensity,"useAnus","Sensitized ass","Ass+",turns,"The ass of this character will receive extra damage.");
			applyAlteredState([target],as);
		}
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((gC(actorKey).agility.getValue() * 2) / 10) * multAr[0];
		gC(target).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " stroked " + ktn(target) + "'s " + assWord() + "."),
									(ktn(actorKey) + " massaged " + ktn(target) + "'s " + assWord() + "."),
									(ktn(actorKey) + " masturbated " + ktn(target) + "'s " + assWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		return results;
	}
	
	return sa;
}

window.createSaDickFootjob = function() {
	var sa = new sceneAction();
	sa.name = "Dick footjob";
	sa.key = "dickFootjob";
	sa.targetType = "single";
	sa.tags.push("ss","sUse");
	sa.actorBpReqs.push("legs");
	sa.targetBpReqs.push("dick");
	
	sa.requiredPositions.push("standing","mountedFromBehind","spitroastTarget");
	sa.targetRequiredPositions.push("kneeling","mountingFromBehind","spitroastBehind");
	sa.linkedPositions = true;
	
	sa.flavorTags.push("foreplay","useLegs","targetDick");
	
	sa.description = "The character massages the target's dick with their feet.\nThis action will sensitize the target's dick.\n"
				   + "Actor requires free legs, target requires free dick.\n\nForeplay.\n\n__Influences__:\nDamage: Actor's agility x1.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		
		for (var target of targetActors) {
			var multAr = getSexDamageMult(actorKey,target,this.key);
			var lustDamage = ((getChar(actorKey).agility.getValue() * 2) / 8) * multAr[0];
			getChar(target).lust.changeValue(-lustDamage);
			
			if ( doesCharHaveAlteredState(target,"Dic+") == false ) {
				// Sensitized dick
				var intensity = 0.05 + gCstat(actorKey,"agility") * 0.005 + limitedRandomInt(5) * 0.01;
				var turns = 4 + limitedRandomInt(4) + (gCstat(actorKey,"agility") * 0.04) - ((gCstat(actorKey,"agility") * 0.04) % 1);
				var as = createSensitizedTag(intensity,"useDick","Sensitized dick","Dic+",turns,"The dick of this character will receive extra damage.");
				applyAlteredState([target],as);
			}
		
			results.value += lustDamage;
			results.description += randomFromList( [
											(ktn(actorKey) + " frotted " + ktn(target) + "'s " + dickWord() + " with " + gC(actorKey).posPr + " feet."),
											(ktn(actorKey) + " gave a footjob to " + ktn(target) + "."),
											(ktn(actorKey) + "'s feet masturbated " + ktn(target) + "'s " + dickWord() + ".") ] );
			results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		}
		
		return results;
	}		
	return sa;
}
window.createSaPussyFootjob = function() {
	var sa = new sceneAction();
	sa.name = "Pussy footjob";
	sa.key = "pussyFootjob";
	sa.targetType = "single";
	sa.tags.push("ss","sUse");
	sa.actorBpReqs.push("legs");
	sa.targetBpReqs.push("pussy");
	
	sa.requiredPositions.push("standing","mountedFromBehind","spitroastTarget");
	sa.targetRequiredPositions.push("kneeling","mountingFromBehind","spitroastBehind");
	sa.linkedPositions = true;
	
	sa.flavorTags.push("foreplay","useLegs","targetPussy");
	
	sa.description = "The character massages the target's pussy with their feet.\nThis action will sensitize the target's pussy.\n"
				   + "Actor requires free legs, target requires free pussy.\n\nForeplay.\n\n__Influences__:\nDamage: Actor's agility x1.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		
		for (var target of targetActors) {
			var multAr = getSexDamageMult(actorKey,target,this.key);
			var lustDamage = ((getChar(actorKey).agility.getValue() * 2) / 8) * multAr[0];
			getChar(target).lust.changeValue(-lustDamage);
			
			if ( doesCharHaveAlteredState(target,"Pus+") == false ) {
				// Sensitized pussy
				var intensity = 0.05 + gCstat(actorKey,"agility") * 0.005 + limitedRandomInt(5) * 0.01;
				var turns = 4 + limitedRandomInt(4) + (gCstat(actorKey,"agility") * 0.04) - ((gCstat(actorKey,"agility") * 0.04) % 1);
				var as = createSensitizedTag(intensity,"usePussy","Sensitized pussy","Pus+",turns,"The pussy of this character will receive extra damage.");
				applyAlteredState([target],as);
			}
			
			results.value += lustDamage;
			results.description += randomFromList( [
											(ktn(actorKey) + " rubbed " + ktn(target) + "'s " + pussyWord() + " with " + gC(actorKey).posPr + " feet."),
											(ktn(actorKey) + "'s feet stimulated " + ktn(target) + "'s " + pussyWord() + "."),
											(ktn(actorKey) + "'s feet massaged " + ktn(target) + "'s " + pussyWord() + ".") ] );
			results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		}
		
		return results;
	}		
	return sa;
}

		// Weapon stroking actions
window.createSaDildoTeaseGenitals = function() {
	var sa = new sceneAction();
	sa.name = "Dildo Tease Genitals";
	sa.key = "dildoTeaseGenitals";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget","unusedWeapon");
	sa.actorBpReqs.push("arms");
	sa.unvalidRelationalPositions.push(["standing","kneeling"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"],["spitroastTarget","spitroastBehind"],["spitroastFront","spitroastTarget"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	
	sa.flavorTags.push("foreplay","teasing");
	
	sa.description = "The character rubs their dildo against their target's groin, teasing them about what may be about to come."
				   + "\nActor requires free arms.\nMay sometimes increase sensitivity for various available genitals."
				   + "\nInfluenced by the actor's agility, physique and perception.\n\nForeplay, teasing."
				   + "\n\n__Influences__:\nDamage: Actor's agility x2, actor's physique x2, actor's perception x1,"
				   + "\nfree target's genitals body parts.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var actStatsFactor = (gCstat(actorKey,"agility") + gCstat(actorKey,"physique") + gCstat(actorKey,"perception")) * 0.025;
		
		var actorGenitals = ["groin","private parts"];
		var targetGenitals = ["groin","private parts"];
		if ( gC(target).hasFreeBodypart("dick") ) {
			targetGenitals.push("dick");
			if ( limitedRandomInt(32) < 4 ) {
				if ( doesCharHaveAlteredState(target,"Dic+") == false ) {
					// Sensitized dick
					var intensity = 0.05 + actStatsFactor + limitedRandomInt(5) * 0.01;
					var turns = 4 + limitedRandomInt(4) + (actStatsFactor - (actStatsFactor % 1));
					var as = createSensitizedTag(intensity,"useDick","Sensitized dick","Dic+",turns,"The dick of this character will receive extra damage.");
					applyAlteredState([target],as);
				}
			}
		}
		if ( gC(target).hasFreeBodypart("pussy") ) {
			targetGenitals.push("pussy");
			if ( limitedRandomInt(8) < 4 ) {
				if ( doesCharHaveAlteredState(target,"Pus+") == false ) {
					// Sensitized pussy
					var intensity = 0.05 + actStatsFactor + limitedRandomInt(5) * 0.01;
					var turns = 4 + limitedRandomInt(4) + (actStatsFactor - (actStatsFactor % 1));
					var as = createSensitizedTag(intensity,"usePussy","Sensitized pussy","Pus+",turns,"The pussy of this character will receive extra damage.");
					applyAlteredState([target],as);
				}
			}
		}
		if ( gC(target).hasFreeBodypart("anus") ) {
			targetGenitals.push("ass");
			if ( limitedRandomInt(16) < 4 ) {
				if ( doesCharHaveAlteredState(target,"Ass+") == false ) {
					// Sensitized anus
					var intensity = 0.05 + actStatsFactor + limitedRandomInt(5) * 0.01;
					var turns = 4 + limitedRandomInt(4) + (actStatsFactor - (actStatsFactor % 1));
					var as = createSensitizedTag(intensity,"useAnus","Sensitized ass","Ass+",turns,"The ass of this character will receive extra damage.");
					applyAlteredState([target],as);
				}
			}
		}
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = (getChar(actorKey).agility.getValue() * 2 + getChar(actorKey).perception.getValue() + getChar(actorKey).physique.getValue() ) / 15;
		lustDamage *= (0.3 * targetGenitals.length) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		
		results.description = randomFromList([(ktn(actorKey) + " played with " + ktn(target) + "'s " + randomFromList(targetGenitals) + " using " + gC(actorKey).posPr + " dildo."),
									(ktn(actorKey) + " teased " + ktn(target) + "'s " + randomFromList(targetGenitals) + " with " + gC(actorKey).posPr + " dildo."),
									(ktn(target) + "'s " + randomFromList(targetGenitals) + " tingled from the contact with " + ktn(actorKey) + "'s dildo.")]);
		results.description += ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
							
		return results;
	}
	return sa;
}

	// Kissing/Almost sex

window.createSaKissLips = function() {
	var sa = new sceneAction();
	sa.name = "Kiss Lips";
	sa.key = "kissLips";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("mouth");
	sa.targetBpReqs.push("mouth");
	sa.unvalidRelationalPositions.push(["kneeling","standing"],["takenFromBehind","takingFromBehind"],["spitroastBehind","spitroastTarget"],
									   ["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["mountingFromBehind","mountingAndMounted"],["mountingAndMounted","mountingFromBehind"],["mountingAndMounted","mountedFromBehind"],["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("foreplay","useMouth","targetMouth");
	
	sa.description = "The character slowly kisses another character's lips.\n\nSingle target action.\n"
				   + "Actor requires free mouth, target requires free mouth.\n\nForeplay.\n\n__Influences__:\nDamage: Actor's agility x1.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).agility.getValue() * 2) / 10) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " kissed " + ktn(target) + "'s lips."),
									(ktn(actorKey) + " placed " + getChar(actorKey).posPr + " own lips on " + ktn(target) + "'s."),
									(ktn(actorKey) + " tempted " + ktn(target) + "'s lips with " + getChar(actorKey).posPr + " own.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
							   
		return results;
	}
	return sa;
}
window.createSaFrottage = function() {
	var sa = new sceneAction();
	sa.name = "Groin Frottage";
	sa.key = "frottage";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.unvalidRelationalPositions.push(["kneeling","standing"],["standing","kneeling"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"],["spitroastFront","spitroastTarget"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	
	sa.flavorTags.push("foreplay","teasing");
	
	sa.description = "The character rubs their groin against someone else's private parts.\nMay sometimes increase the sensitivity and desire for various available genitals.\n\nSingle target action."
				   + "\nInfluenced by actor's agility, perception and charisma.\n\nForeplay."
				   + "\n\n__Influences__:\nDamage: Actor's agility x2, actor's perception x1,actor's charisma x1,"
				   + "\nfree actor's genital body parts, free target's genital body parts.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var actStatsFactor = (gCstat(actorKey,"agility") + gCstat(actorKey,"perception") + gCstat(actorKey,"charisma")) * 0.02;
		
		var actorGenitals = ["groin","private parts"];
		var targetGenitals = ["groin","private parts"];
		if ( gC(actorKey).hasFreeBodypart("dick") ) {
			actorGenitals.push("dick");
			if ( limitedRandomInt(32) < 4 ) {
				if ( doesCharHaveAlteredState(actorKey,"Dic+") == false ) {
					// Sensitized dick
					var intensity = 0.05 + actStatsFactor + limitedRandomInt(5) * 0.01;
					var turns = 4 + limitedRandomInt(4) + (actStatsFactor - (actStatsFactor % 1));
					var as = createSensitizedTag(intensity,"useDick","Sensitized dick","Dic+",turns,"The dick of this character will receive extra damage.");
					applyAlteredState([actorKey],as);
				}
			}
			if ( limitedRandomInt(32) < 4 ) {
				if ( doesCharHaveAlteredState(target,"DicT") == false ) {
					// Desired dick
					var intensity = 0.05 + actStatsFactor + limitedRandomInt(5) * 0.01;
					var turns = 4 + limitedRandomInt(4) + (actStatsFactor - (actStatsFactor % 1));
					var as = createSensitizedTag(intensity,"targetDick","Desired dick","DicT",turns,"This character will receive extra damage when affected by other dicks.");
					applyAlteredState([target],as);
				}
			}
		}
		if ( gC(actorKey).hasFreeBodypart("pussy") ) {
			actorGenitals.push("pussy");
			if ( limitedRandomInt(32) < 4 ) {
				if ( doesCharHaveAlteredState(actorKey,"Pus+") == false ) {
					// Sensitized pussy
					var intensity = 0.05 + actStatsFactor + limitedRandomInt(5) * 0.01;
					var turns = 4 + limitedRandomInt(4) + (actStatsFactor - (actStatsFactor % 1));
					var as = createSensitizedTag(intensity,"usePussy","Sensitized pussy","Pus+",turns,"The pussy of this character will receive extra damage.");
					applyAlteredState([actorKey],as);
				}
			}
			if ( limitedRandomInt(32) < 4 ) {
				if ( doesCharHaveAlteredState(target,"PusT") == false ) {
					// Desired pussy
					var intensity = 0.05 + actStatsFactor + limitedRandomInt(5) * 0.01;
					var turns = 4 + limitedRandomInt(4) + (actStatsFactor - (actStatsFactor % 1));
					var as = createSensitizedTag(intensity,"targetPussy","Desired pussy","PusT",turns,"This character will receive extra damage when affected by other pussies.");
					applyAlteredState([target],as);
				}
			}
		}
		if ( gC(target).hasFreeBodypart("dick") ) {
			targetGenitals.push("dick");
			if ( limitedRandomInt(32) < 4 ) {
				if ( doesCharHaveAlteredState(target,"Dic+") == false ) {
					// Sensitized dick
					var intensity = 0.05 + actStatsFactor + limitedRandomInt(5) * 0.01;
					var turns = 4 + limitedRandomInt(4) + (actStatsFactor - (actStatsFactor % 1));
					var as = createSensitizedTag(intensity,"useDick","Sensitized dick","Dic+",turns,"The dick of this character will receive extra damage.");
					applyAlteredState([target],as);
				}
			}
			if ( limitedRandomInt(32) < 4 ) {
				if ( doesCharHaveAlteredState(actorKey,"DicT") == false ) {
					// Desired dick
					var intensity = 0.05 + actStatsFactor + limitedRandomInt(5) * 0.01;
					var turns = 4 + limitedRandomInt(4) + (actStatsFactor - (actStatsFactor % 1));
					var as = createSensitizedTag(intensity,"targetDick","Desired dick","DicT",turns,"This character will receive extra damage when affected by other dicks.");
					applyAlteredState([actorKey],as);
				}
			}
		}
		if ( gC(target).hasFreeBodypart("pussy") ) {
			targetGenitals.push("pussy");
			if ( limitedRandomInt(32) < 4 ) {
				if ( doesCharHaveAlteredState(target,"Pus+") == false ) {
					// Sensitized pussy
					var intensity = 0.05 + actStatsFactor + limitedRandomInt(5) * 0.01;
					var turns = 4 + limitedRandomInt(4) + (actStatsFactor - (actStatsFactor % 1));
					var as = createSensitizedTag(intensity,"usePussy","Sensitized pussy","Pus+",turns,"The pussy of this character will receive extra damage.");
					applyAlteredState([target],as);
				}
			}
			if ( limitedRandomInt(32) < 4 ) {
				if ( doesCharHaveAlteredState(actorKey,"PusT") == false ) {
					// Desired pussy
					var intensity = 0.05 + actStatsFactor + limitedRandomInt(5) * 0.01;
					var turns = 4 + limitedRandomInt(4) + (actStatsFactor - (actStatsFactor % 1));
					var as = createSensitizedTag(intensity,"targetPussy","Desired pussy","PusT",turns,"This character will receive extra damage when affected by other pussies.");
					applyAlteredState([actorKey],as);
				}
			}
		}
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(target,actorKey,this.key);
		var lustDamage = (getChar(actorKey).agility.getValue() * 2 + getChar(actorKey).perception.getValue() + getChar(actorKey).charisma.getValue() ) / 15;
		var lustDamage2 = lustDamage / 4;
		lustDamage *= (0.4 * actorGenitals.length - 0.2) * multAr[0];
		lustDamage2 *= (0.4 * targetGenitals.length - 0.2) * multAr2[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		
		results.description += ktn(actorKey) + randomFromList([" frotted "," pressed "]) + gC(actorKey).posPr + " " + randomFromList(actorGenitals);
		results.description += " against " + ktn(target) + "'s " + randomFromList(targetGenitals) + ". ";
		results.description += ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
							
		return results;
	}
	return sa;
}

window.createSaLickLegs = function() {
	var sa = new sceneAction();
	sa.name = "Lick legs";
	sa.key = "lickLegs";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("mouth");
	sa.targetBpReqs.push("legs");
	
	sa.requiredPositions.push("kneeling","spitroastTarget");
	sa.targetRequiredPositions.push("standing","spitroastFront");
	sa.linkedPositions = true;
	
	sa.flavorTags.push("foreplay","useMouth","targetLegs");
	
	sa.description = "The character tastes the skin of the target's legs.\n\nSingle target action.\n"
				   + "Actor requires free mouth, target requires free legs.\n\nForeplay.\n\n__Influences__:\nDamage: Actor's agility x1.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).agility.getValue() * 2) / 14) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(actorKey).lust.changeValue(-(lustDamage/2));
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " licked " + ktn(target) + "'s thighs."),
									(ktn(actorKey) + "'s tongue traced a line along " + ktn(target) + "'s leg."),
									(ktn(actorKey) + " kissed and licked " + ktn(target) + "'s calves.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + ktn(actorKey)
							 + " received " + textLustDamage((lustDamage/2)) + ". " + multAr[1];
							   
		return results;
	}
	return sa;
}

	// Sex actions

window.createSaThrust = function() {
	var sa = new sceneAction();
	sa.name = "Thrust";
	sa.key = "thrust";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("takingFromBehind","penetratePussy");
	
	sa.flavorTags.push("fullsex","useDick","targetPussy","top");
	
	sa.description = "The character pushes their cock into their target's folds. Actor and target must already be connected.\n\nSingle target action."
				   + "\n\nFull sex.\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1, actor's will x1.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		var lustDamage = ((getChar(actorKey).physique.getValue() * 3 + getChar(actorKey).agility.getValue() + getChar(actorKey).will.getValue()) / 10);
		var lustDamage2 = (lustDamage / 5) * multAr2[0];
		lustDamage *= multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " pushed " + gC(actorKey).posPr + " " + dickWord() + " deep into " + ktn(target) + "."),
									(ktn(actorKey) + " thrusted into " + ktn(target) + "."),
									(ktn(actorKey) + " penetrated " + ktn(target) + "'s " + randomFromList(["insides","pussy"]) + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}
	return sa;	
}
window.createSaAnalThrust = function() {
	var sa = new sceneAction();
	sa.name = "Anal thrust";
	sa.key = "analThrust";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		
		if ( State.variables.settings.anal == "disable" ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("takingFromBehind","penetrateAss");
	
	sa.flavorTags.push("fullsex","useDick","targetAnus","top");
	
	sa.description = "The character slides their dick through the target's rear. Actor and target must already be connected.\n\nSingle target action."
				   + "\n\nFull sex.\n\n__Influences__:\nDamage: Actor's resilience x10, actor's agility x6, actor's will x4.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		var lustDamage = ((getChar(actorKey).resilience.getValue() * 2.5 + getChar(actorKey).agility.getValue() * 1.5 + getChar(actorKey).will.getValue()) / 10);
		var energyDamage = (lustDamage / 4) * multAr[0];
		var lustDamage2 = (lustDamage / 4) * multAr2[0];
		lustDamage *= multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(targetActors[0]).energy.changeValue(-energyDamage);
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " pushed " + gC(actorKey).posPr + " " + dickWord() + " deep into " + ktn(target) + "."),
									(ktn(actorKey) + " thrusted into " + ktn(target) + "."),
									(ktn(actorKey) + " penetrated " + ktn(target) + "'s " + assWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + " and " + textEnergyDamage(energyDamage) + ". " + multAr[1];
		results.description += ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}		
	return sa;
}
window.createSaDoubleThrust = function() {
	var sa = new sceneAction();
	sa.name = "Double thrust";
	sa.key = "doubleThrust";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		
		if ( State.variables.settings.anal == "disable" ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("takingFromBehind","doublePenetration");
	
	sa.flavorTags.push("fullsex","useDick","targetPussy","targetAnus","top");
	
	sa.description = "The character slides two dicks into their partner's insides. Actor and target must already be connected.\n\nSingle target action."
				   + "\n\nFull sex.\n\n__Influences__:\nDamage, energy damage, self damage: Actor's physique x2, actor's resilience x2, actor's agility x1, actor's will x1.";
	sa.execute = function(actorKey,targetActors) {
		var actor = actorKey;
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		var lustDamage = (( gC(actor).physique.getValue() * 2 + gC(actor).agility.getValue() * 1 + gC(actor).resilience.getValue() * 2 + gC(actor).will.getValue() * 1 ) / 10);
		var energyDamage = (lustDamage / 4) * multAr[0];
		var lustDamage2 = (lustDamage / 6) * multAr2[0];
		lustDamage *= multAr[0];
		
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(targetActors[0]).energy.changeValue(-energyDamage);
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " pushed " + gC(actorKey).posPr + " " + dickWord() + "s deep into " + ktn(target) + "."),
									(ktn(actorKey) + " thrusted into " + ktn(target) + "'s insides."),
									(ktn(actorKey) + " penetrated both " + ktn(target) + "'s " + pussyWord() + " and " + assWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + " and " + textEnergyDamage(energyDamage) + ". " + multAr[1];
		results.description += ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}		
	return sa;
}
window.createSaPushHipsBack = function() {
	var sa = new sceneAction();
	sa.name = "Push Hips Back";
	sa.key = "pushHipsBack";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredPassiveCAs.push("takingFromBehind","penetratePussy","doublePenetration");
	
	sa.flavorTags.push("fullsex","usePussy","targetDick","bottom");
	
	sa.description = "The character pushes their hips back against someone else's dick. Target must already be penetrating the pussy of the actor."
				   + "\n\nSingle target action.\n\nFull sex."
				   + "\n\n__Influences__:\nDamage: Actor's resilience x3, actor's agility x1, actor's will x1.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		var lustDamage = (getChar(actorKey).resilience.getValue() * 3 + getChar(actorKey).agility.getValue() + getChar(actorKey).will.getValue()) / 20;
		var lustDamage2 = (lustDamage / 5) * multAr2[0];
		lustDamage *= multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " pressed " + gC(actorKey).posPr + " hips back against " + ktn(target)
								+ ", getting impaled in " + gC(target).posPr + " " + dickWord() + "."),
								(ktn(actorKey) + " pushed " + gC(actorKey).posPr + " " + pussyWord() + " hard against  "
								+ ktn(target) + "'s " + dickWord() + ".")
								] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}
	return sa;
}
window.createSaPushAssBack = function() {
	var sa = new sceneAction();
	sa.name = "Push Ass Back";
	sa.key = "pushAssBack";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredPassiveCAs.push("takingFromBehind","penetrateAss","doublePenetration");
	
	sa.flavorTags.push("fullsex","useAnus","targetDick","bottom");
	
	sa.description = "The character pushes their hips back against someone else's dick. Target must already be penetrating the ass of the actor."
				   + "\n\nSingle target action.\n\nFull sex."
				   + "\n\n__Influences__:\nDamage: Actor's resilience x3, actor's agility x1, actor's will x1.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		var lustDamage = (getChar(actorKey).resilience.getValue() * 3 + getChar(actorKey).agility.getValue() + getChar(actorKey).will.getValue()) / 20;
		var lustDamage2 = (lustDamage / 5) * multAr2[0];
		lustDamage *= multAr[0];
		getChar(targetActors[0]).lust.changeValue(-(lustDamage*0.7));
		getChar(targetActors[0]).energy.changeValue(-(lustDamage*0.3));
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " pressed " + gC(actorKey).posPr + " " + assWord() + " back against " + ktn(target)
								+ ", getting impaled in " + gC(target).posPr + " " + dickWord() + "."),
								(ktn(actorKey) + " pushed " + gC(actorKey).posPr + " " + assWord() + " hard against  "
								+ ktn(target) + "'s " + dickWord() + ".")
								] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage*0.7) + " and " + textEnergyDamage(lustDamage*0.3) + ". " + multAr[1];
		results.description += ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}
	return sa;
}
window.createSaPiston = function() {
	var sa = new sceneAction();
	sa.name = "Piston";
	sa.key = "piston";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("takingFromBehind","penetratePussy");
	sa.energyCost = 2;
	/*
	sa.requiredPositions.push("takingFromBehind");
	sa.targetRequiredPositions.push("takenFromBehind");
	sa.linkedPositions = true;
	*/
	sa.flavorTags.push("fullsex","useDick","targetPussy","top");
	
	sa.description = "The character uses all the strength in their legs and abs to fuck their target. The characters must be in position already.\n"
				   + "Costs 5 energy.\nSingle target action.\n\nFull sex."
				   + "\n\n__Influences__:\nDamage: Actor's physique x5, actor's resilience x3, actor's agility x2.";
	sa.execute = function(actorKey,targetActors) {
		 var results = new saResults;
		 var actor = actorKey;
		 var target = targetActors[0];
		 
		 applySaCosts(this,actor);
		 
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		 var lustDamage = ((getChar(actorKey).physique.getValue() * 5 + getChar(actorKey).agility.getValue() * 2 + getChar(actorKey).resilience.getValue() * 3) / 10);
		 var lustDamage2 = (lustDamage / 1.5) * multAr2[0];
		 lustDamage *= multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actor) + " forcefully went into " + ktn(target) + " with all " + gC(actor).posPr + " strength."),
									(ktn(actor) + " is repeteadly pushing " + gC(actor).posPr + " " + dickWord() + " into " + ktn(target) + "."),
									(ktn(actor) + " is dominating " + ktn(target) + "'s " + pussyWord() + ", pushing back and forth.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(actor) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1] + generateSaCostsText(this,actor) + ". ";
		 
		 return results;
	}
	return sa;
}
window.createSaFinalPush = function() {
	var sa = new sceneAction();
	sa.name = "Final Push";
	sa.key = "finalPush";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("takingFromBehind","penetratePussy");
	sa.energyCost = 20;
	
	sa.flavorTags.push("fullsex","useDick","targetPussy","top");
	
	sa.description = "The character pushes the physical limits of their body to pour their whole being into one final fuck.\n"
				   + "Forces an orgasm on the character and deals a lot of lust damage to their target.\n"
				   + "The characters must be in position already.\n\nSingle target action.\n"
				   + "\n\nFull sex."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's resilience x2.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var actor = actorKey;
		var target = targetActors[0];
		
		applySaCosts(this,actor);
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).physique.getValue() * 3 + getChar(actorKey).resilience.getValue() * 2) / 2) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(actorKey).lust.changeValue(-getChar(actorKey).lust.current);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actor) + " reached as deep as humanly possible within " + ktn(target)
								+ ", putting " + gC(actor).posPr + " whole being into one final push."),
								(ktn(actor) + "'s " + dickWord() + " aimed for the final frontier within " + ktn(target) + "'s " + pussyWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(actor) + " received " + colorText("lust damage until reaching orgasm","lightCoral") + ". " + generateSaCostsText(this,actor) + ". ";
		
		return results;
	}
	return sa;
	
}
window.createSaRideDick = function() {
	var sa = new sceneAction();
	sa.name = "Ride dick";
	sa.key = "rideDick";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("mountDick");
	
	sa.flavorTags.push("fullsex","usePussy","targetDick","top");
	
	sa.description = "The character moves up and down their partner's dick. Actor and target must already be connected.\n\nSingle target action."
				   + "\n\nFull sex.\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1, actor's will x1.";
	sa.execute = function(actorKey,targetActors) {
		var actor = actorKey;
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		var lustDamage = (getChar(actorKey).physique.getValue() * 3 + getChar(actorKey).agility.getValue() + getChar(actorKey).will.getValue()) / 10;
		var lustDamage2 = (lustDamage / 5) * multAr2[0];
		lustDamage *= multAr[0];
		
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " let " + gC(actorKey).posPr + " hips fall upon " + ktn(target) + "'s " + dickWord() + "."),
									(ktn(actorKey) + " tightened " + gC(actor).refPr + " around " + ktn(target) + "'s " +  dickWord() + "."),
									(ktn(actorKey) + "'s " + pussyWord() + " sucked " + ktn(target) + "'s " + dickWord() + " up.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}
	return sa;	
}
window.createSaAnalRideDick = function() {
	var sa = new sceneAction();
	sa.name = "Anally ride dick";
	sa.key = "analRideDick";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("analMountDick");
	
	sa.flavorTags.push("fullsex","useAnus","targetDick","top");
	
	sa.description = "The character moves up and down their partner's dick. Actor and target must already be connected.\n\nSingle target action."
				   + "\n\nFull sex.\n\n__Influences__:\nDamage: Actor's physique x3, actor's resilience x1, actor's will x1.";
	sa.execute = function(actorKey,targetActors) {
		var actor = actorKey;
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		var lustDamage = (getChar(actorKey).physique.getValue() * 3 + getChar(actorKey).resilience.getValue() + getChar(actorKey).will.getValue()) * 0.7 / 10;
		var energyDamage = (getChar(actorKey).physique.getValue() * 3 + getChar(actorKey).resilience.getValue() + getChar(actorKey).will.getValue()) * 0.3 / 10;
		var lustDamage2 = (lustDamage / 5) * multAr2[0];
		lustDamage *= multAr[0];
		
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(targetActors[0]).energy.changeValue(-energyDamage);
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " let " + gC(actorKey).posPr + " hips fall upon " + ktn(target) + "'s " + dickWord() + "."),
									(ktn(actorKey) + " moved back and forth, frotting " + gC(actor).posPr + " backsides around " + ktn(target) + "'s " +  dickWord() + "."),
									(ktn(actorKey) + "'s " + assWord() + " tightened around " + ktn(target) + "'s " + dickWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + " and " + textEnergyDamage(energyDamage) + ". " + multAr[1];
		results.description += ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}
	return sa;	
}
window.createSaPushDickBack = function() {
	var sa = new sceneAction();
	sa.name = "Push Dick Back";
	sa.key = "pushDickBack";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredPassiveCAs.push("mountDick");
	
	sa.flavorTags.push("fullsex","useDick","targetPussy","bottom");
	
	sa.description = "The character pushes their dick back against someone else's genitals. Target must already be riding the actor."
				   + "\n\nSingle target action.\n\nFull sex."
				   + "\n\n__Influences__:\nDamage: Actor's resilience x3, actor's agility x1, actor's will x1.";
	sa.execute = function(actorKey,targetActors) {
		var actor = actorKey;
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		var lustDamage = (getChar(actorKey).resilience.getValue() * 3 + getChar(actorKey).agility.getValue() + getChar(actorKey).will.getValue()) * multAr[0] / 20;
		var lustDamage2 = (lustDamage / 5) * multAr2[0];
		lustDamage *= multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " pushed " + gC(actorKey).posPr + " " + dickWord() + " against " + ktn(target) + "."),
								(ktn(actorKey) + " thrusted " + ktn(target) + "'s " + pussyWord() + "."),
								(ktn(actorKey) + "'s " + dickWord() + " retaliated against " + ktn(target) + "'s " + pussyWord() + ".")
								] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}
	return sa;
}
window.createSaAnalPushDickBack = function() {
	var sa = new sceneAction();
	sa.name = "Push Dick Back Against Ass";
	sa.key = "analPushDickBack";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredPassiveCAs.push("analMountDick");
	
	sa.flavorTags.push("fullsex","useDick","targetAnus","bottom");
	
	sa.description = "The character pushes their dick back against someone else's ass. Target must already be riding the actor."
				   + "\n\nSingle target action.\n\nFull sex."
				   + "\n\n__Influences__:\nDamage: Actor's resilience x3, actor's agility x1, actor's will x1.";
	sa.execute = function(actorKey,targetActors) {
		var actor = actorKey;
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		var lustDamage = (getChar(actorKey).resilience.getValue() * 3 + getChar(actorKey).agility.getValue() + getChar(actorKey).will.getValue()) * multAr[0] * 0.7 / 20;
		var energyDamage = (getChar(actorKey).resilience.getValue() * 3 + getChar(actorKey).agility.getValue() + getChar(actorKey).will.getValue()) * multAr[0] * 0.3 / 20;
		var lustDamage2 = (lustDamage / 5) * multAr2[0];
		lustDamage *= multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(targetActors[0]).energy.changeValue(-energyDamage);
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " pushed " + gC(actorKey).posPr + " " + dickWord() + " against " + ktn(target) + "."),
								(ktn(actorKey) + " thrusted " + ktn(target) + "'s " + assWord() + "."),
								(ktn(actorKey) + "'s " + dickWord() + " retaliated against " + ktn(target) + "'s " + assWord() + ".")
								] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + " and " + textEnergyDamage(energyDamage) + ". " + multAr[1];
		results.description += ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}
	return sa;
}

window.createSaScissor = function() {
	var sa = new sceneAction();
	sa.name = "Scissor";
	sa.key = "scissor";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredCAs.push("interlockLegs");
	
	sa.flavorTags.push("fullsex","usePussy","targetPussy");
	
	sa.description = "The character rub their own pussy with their target's.\nActor and target must be interlocking legs.\n\nSingle target action."
				   + "\n\nFull sex.\n\n__Influences__:\nDamage: Actor's physique x7, actor's agility x5.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		var lustDamage = (getChar(actorKey).physique.getValue() * 2.8 + getChar(actorKey).agility.getValue() * 2) / 10;
		var lustDamage2 = (lustDamage / 5) * multAr2[0];
		lustDamage *= multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " frotted " + gC(actorKey).posPr + " own " + pussyWord() + " against " + ktn(target) + "'s."),
									(ktn(actorKey) + " slid " + gC(actorKey).posPr + " groin through " + ktn(target) + "'s " + pussyWord() + ", seeking pleasure."),
									(ktn(actorKey) + " squeezed " + ktn(target) + "'s groin against " + gC(actorKey).posPr + " own " + pussyWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}
	return sa;	
}

window.createSaLickGroin = function() {
	var sa = new sceneAction();
	sa.name = "Lick Groin";
	sa.key = "lickGroin";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("mouth");
	
	sa.requiredPositions.push("kneeling","spitroastTarget");
	sa.targetRequiredPositions.push("standing","spitroastFront");
	sa.linkedPositions = true;
	
	sa.flavorTags.push("oral","useMouth","targetPussy","targetDick");
	
	sa.description = "The character lick the erogenous parts of their target's groin.\n\nSingle target action.\n"
				   + "\nOral.\n\n__Influences__:\nDamage: Actor's agility x1, target's free genitals.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var targetGenitals = ["groin","private parts"];
		if ( gC(target).hasFreeBodypart("dick") ) { targetGenitals.push("dick","dick"); }
		if ( gC(target).hasFreeBodypart("pussy") ) { targetGenitals.push("pussy","pussy"); }
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = (getChar(actorKey).agility.getValue() * 3) / 10;
		lustDamage *= ((targetGenitals.length + 1) * 0.2) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " licked " + ktn(target) + "'s " + randomFromList(targetGenitals) + "."),
								(ktn(actorKey) + " pleasured " + ktn(target) + "'s " + randomFromList(targetGenitals) + " with "
								+ gC(actorKey).posPr + " tongue."),
								(ktn(actorKey) + " throughly cleaned " + ktn(target) + "'s " + randomFromList(targetGenitals)
								+ " with " + gC(actorKey).posPr + " mouth.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		return results;
	}
	return sa;
}
window.createSaSuckDick = function() {
	var sa = new sceneAction();
	sa.name = "Suck Dick";
	sa.key = "suckDick";
	sa.targetType = "single";
	sa.tags.push("ss","sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredPassiveCAs.push("getBlowjob");
	
	sa.flavorTags.push("oral","useMouth","targetDick");
	
	sa.description = "The character sucks their target's dick.\n"
				   + "The actor must be giving a blowjob to their target.\n\nSingle target action.\n"
				   + "\nOral.\n\n__Influences__:\nDamage: Actor's agility x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var actor = actorKey;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = (getChar(actorKey).agility.getValue() / 3) * multAr[0];
		gC(target).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actor) + " sucked " + ktn(target) + "'s " + dickWord() + "."),
								(ktn(actor) + " throughly licked " + ktn(target) + "'s " + dickWord() + " within " + gC(actor).posPr + " mouth."),
								(ktn(actor) + " ran " + gC(actor).posPr + " tongue through " + ktn(target) + "'s " + dickWord() + "'s skin.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		return results;
	}
	return sa;
}
window.createSaFuckFace = function() {
	var sa = new sceneAction();
	sa.name = "Fuck Face";
	sa.key = "fuckFace";
	sa.targetType = "single";
	sa.tags.push("ss","sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("getBlowjob");
	
	sa.flavorTags.push("oral","targetMouth","useDick");
	
	sa.description = "The character penetrates their target's mouth with their dick.\n"
				   + "The actor must be receiving a blowjob from their target.\n\nSingle target action.\n"
				   + "\nOral.\n\n__Influences__:\nDamage: Actor's physique x1, actor's agility x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		// Lust to actor, lust to target, willpower to target
		var results = new saResults;
		var actor = actorKey;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,actorKey,this.key);
		var multAr2 = getSexDamageMult(actorKey,target,this.key);
		var lustDamageSelf = (getChar(actorKey).physique.getValue() / 10 + getChar(actorKey).agility.getValue() / 10) * multAr[0];
		var lustDamageTarget = (getChar(actorKey).physique.getValue() / 14 + getChar(actorKey).agility.getValue() / 14) * multAr2[0];
		var willpowerDamageTarget = (getChar(actorKey).physique.getValue() / 20 + getChar(actorKey).agility.getValue() / 20) * multAr2[0];
		gC(actor).lust.changeValue(-lustDamageSelf);
		gC(target).lust.changeValue(-lustDamageTarget);
		gC(target).willpower.changeValue(-willpowerDamageTarget);
		results.value += lustDamageTarget;
		
		results.description += randomFromList( [
								(ktn(actor) + " fiercely penetrated " + ktn(target) + "'s throat."),
								(ktn(target) + " struggles to breathe due to " + ktn(actor) + "'s enthusiam in fucking " + gC(target).posPr + " throat."),
								(ktn(actor) + "'s " + dickWord() + " is looking for treasure within " + ktn(target) + "'s mouth."),
								(ktn(actor) + " keeps pushing " + gC(actor).posPr + " " + dickWord() + " into " + ktn(target) + "'s mouth.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamageTarget) + " and " + textWillpowerDamage(willpowerDamageTarget)
							 + ". " + multAr2[1] + ktn(actor) + " received " + textLustDamage(lustDamageSelf) + ". " + multAr[1];
		
		return results;
	}
	return sa;
}
window.createSaLickPussy = function() {
	var sa = new sceneAction();
	sa.name = "Lick Pussy";
	sa.key = "lickPussy";
	sa.targetType = "single";
	sa.tags.push("ss","sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredPassiveCAs.push("legHoldingHead");
	
	sa.flavorTags.push("oral","useMouth","targetPussy");
	
	sa.description = "The character sucks their target's pussy.\n"
				   + "The actor must be eating out their target's pussy.\n\nSingle target action.\n"
				   + "\nOral.\n\n__Influences__:\nDamage: Actor's agility x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var actor = actorKey;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = (getChar(actorKey).agility.getValue() / 3) * multAr[0];
		gC(target).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actor) + " is eating " + ktn(target) + "'s " + pussyWord() + "."),
								(ktn(actor) + " throughly licked " + ktn(target) + "'s " + pussyWord() + "'s folds."),
								(ktn(actor) + " ran " + gC(actor).posPr + " tongue through every corner of " + ktn(target) + "'s " + pussyWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		return results;
	}
	return sa;
}
window.createSaRideFace = function() {
	var sa = new sceneAction();
	sa.name = "Ride Face";
	sa.key = "rideFace";
	sa.targetType = "single";
	sa.tags.push("ss","sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("legHoldingHead");
	
	sa.flavorTags.push("oral","targetMouth","usePussy");
	
	sa.description = "The character masturbates their own pussy against their target's face.\n"
				   + "The target must be eating out the actor's pussy.\n\nSingle target action.\n"
				   + "\nOral.\n\n__Influences__:\nDamage: Actor's physique x1, actor's agility x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var actor = actorKey;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,actorKey,this.key);
		var multAr2 = getSexDamageMult(actorKey,target,this.key);
		var lustDamageSelf = (getChar(actorKey).physique.getValue() / 10 + getChar(actorKey).agility.getValue() / 10) * multAr[0];
		var lustDamageTarget = (getChar(actorKey).physique.getValue() / 14 + getChar(actorKey).agility.getValue() / 14) * multAr2[0];
		var willpowerDamageTarget = (getChar(actorKey).physique.getValue() / 20 + getChar(actorKey).agility.getValue() / 20) * multAr2[0];
		gC(actor).lust.changeValue(-lustDamageSelf);
		gC(target).lust.changeValue(-lustDamageTarget);
		gC(target).willpower.changeValue(-willpowerDamageTarget);
		results.value += lustDamageTarget;
		results.description += randomFromList( [
								(ktn(actor) + " is riding " + ktn(target) + "'s mouth with " + gC(actor).posPr + " " + pussyWord() + "."),
								(ktn(actor) + "'s riding of " + ktn(target) + "'s face is going to light fire."),
								(ktn(actor) + " is pulling " + ktn(target) + "'s face against " + gC(actor).posPr + " own groin."),
								(ktn(target) + " has no choice to but swallow " + ktn(actor) + "'s vaginal fluids.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamageTarget) + " and " + textWillpowerDamage(willpowerDamageTarget)
							 + ". " + multAr2[1] + ktn(actor) + " received " + textLustDamage(lustDamageSelf) + ". " + multAr[1];
		
		return results;
	}
	return sa;
}

	// Weapon
window.createSaThrustDildo = function() {
	var sa = new sceneAction();
	sa.name = "Thrust dildo";
	sa.key = "thrustDildo";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("dildoPenetratePussy","dildoPenetrateAss","dildoPenetrateMouth");
	
	sa.flavorTags.push("top");
	
	sa.description = "The character thrusts their dildo into the target's bodypart it's inserted at. Different effects depending on the active continued action.\n\nSingle target action."
				   + "\n\n__Influences__:\nDamage: Actor's physique x1, actor's agility x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		// Custom flavor tags
		var aFlavorTags = ["top"];
		var currentCAs = getCurrentContinuedActionsBetweenInitiatorAndTarget(actorKey,target);
		if ( currentCAs.includes("dildoPenetratePussy")) {
			aFlavorTags.push("targetPussy");
		}
		if ( currentCAs.includes("dildoPenetrateAss")) {
			aFlavorTags.push("targetAnus");
		}
		if ( currentCAs.includes("dildoPenetrateMouth")) {
			aFlavorTags.push("targetMouth");
		}
		var multAr = getSexDamageMultAlt(actorKey,target,aFlavorTags);
		
		var lustDamage = ((getChar(actorKey).physique.getValue() * 1 + getChar(actorKey).agility.getValue() + getChar(actorKey).will.getValue()) / 12);
		var energyDamage = 0;
		var socialdriveDamage = 0;
		var targetPartText = ["insides"];
		
		// Extra effects
		if ( currentCAs.includes("dildoPenetratePussy")) {
			lustDamage *= 1.3;
			targetPartText.push("pussy","pussy");
		}
		if ( currentCAs.includes("dildoPenetrateAss")) {
			energyDamage = lustDamage * 0.3;
			energyDamage *= multAr[0];
			getChar(targetActors[0]).energy.changeValue(-energyDamage);
			targetPartText.push("ass","rear");
		}
		if ( currentCAs.includes("dildoPenetrateMouth")) {
			socialdriveDamage = lustDamage * 0.3;
			socialdriveDamage *= multAr[0];
			getChar(targetActors[0]).socialdrive.changeValue(-socialdriveDamage);
			targetPartText.push("mouth","throat");
		}
		lustDamage *= multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		
		results.description += randomFromList( [
									(ktn(actorKey) + " pushed " + gC(actorKey).posPr + " dildo deep into " + ktn(target) + "."),
									(ktn(actorKey) + " thrusted " + gC(actorKey).posPr + " " + randomFromList(["dildo","toy","tool"]) + " into " + ktn(target) + "."),
									(ktn(actorKey) + " penetrated " + ktn(target) + "'s " + randomFromList(targetPartText) + ".") ] );
		if ( currentCAs.includes("dildoPenetratePussy")) {
			results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		} else if ( currentCAs.includes("dildoPenetrateAss")) {
			results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + " and " + textEnergyDamage(energyDamage) + ". " + multAr[1];
		} else if ( currentCAs.includes("dildoPenetrateMouth")) {
			results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + " and " + textSocialdriveDamage(socialdriveDamage) + ". " + multAr[1];
		}
		
		return results;
	}
	return sa;	
}
window.createSaPushAgainstDildo = function() {
	var sa = new sceneAction();
	sa.name = "Push against dildo";
	sa.key = "pushAgainstDildo";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredCAs.push("doubleDildoPussyPenetration");
	
	sa.flavorTags.push("usePussy","targetPussy","fullsex");
	
	sa.description = "The character pushes their hips against the dildo in their pussy, striking against their partner's.\n\nSingle target action."
				   + "\n\nFull sex.\n\n__Influences__:\nDamage: Actor's physique x2, actor's resilience x1, actor's agility x1.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		var lustDamage = ((getChar(actorKey).physique.getValue() * 2 + getChar(actorKey).agility.getValue() + getChar(actorKey).resilience.getValue()) / 10);
		var lustDamage2 = (lustDamage / 3) * multAr2[0];
		lustDamage *= multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " pushed " + gC(actorKey).posPr + " hips against the dildo, striking " + ktn(target) + "'s insides."),
									(ktn(actorKey) + "'s movements push the dildo deep into " + ktn(target) + "."),
									(ktn(actorKey) + " thrusted " + gC(actorKey).refPr + " back and forth against the dildo, stimulating " + ktn(target) + "'s " + pussyWord() + " in the proccess.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}
	return sa;
}

	// Fetish

		// Hypnosis

window.createSaHypnoticGlance = function() {
	var sa = new sceneAction();
	sa.name = "Hypnotic Glance";
	sa.key = "hypnoticGlance";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("eyes");
	sa.targetBpReqs.push("eyes");
	
	sa.unvalidRelationalPositions.push(["takingFromBehind","takenFromBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastBehind","spitroastTarget"]);
	sa.unvalidRelationalPositions.push(["mountingFromBehind","mountingAndMounted"]);
	sa.unvalidRelationalPositions.push(["mountingAndMounted","mountingFromBehind"]);
	sa.unvalidRelationalPositions.push(["mountingAndMounted","mountedFromBehind"]);
	sa.unvalidRelationalPositions.push(["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("hypnosis","useEyes","targetEyes");
	
	sa.description = "The character uses hypnotic magic to erode their target's willpower through a seductive glance.\n"
				   + "Actor must have access to target's eyes.\n\nSingle target action.\n\nHypnosis."
				   + "\n\n__Influences__:\nDamage: Actor's charisma x2, actor's will x1.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		if ( actorKey == targetActors[0] ) {
			results.value = 0;
			results.description += getChar(actorKey).formattedName + " came to the realization that it's impossible to look at oneself without a mirror.";
		}
		else {
			var willpowerDamage = ((getChar(actorKey).charisma.getValue() * 2 + getChar(actorKey).will.getValue()) / 3);
			getChar(targetActors[0]).willpower.changeValue(-willpowerDamage);
			results.value += willpowerDamage;
			results.description += randomFromList( [
										(ktn(actorKey) + " enraptured " + ktn(target) + "'s eyes, and " + gC(target).perPr
										+ " felt " + gC(target).posPr + " willpower slipping away."),
										(ktn(actorKey) + "'s eyes captured " + ktn(target) + "'s attention, and " + gC(target).perPr
										+ " felt " + gC(target).refPr + " getting lost in them.") ] );
			results.description += " " + ktn(target) + " received " + textWillpowerDamage(willpowerDamage) + ".";
		}
							   
		return results;
	}
	return sa;
}
window.createSaLustfulGlance = function() {
	var sa = new sceneAction();
	sa.name = "Lustful Glance";
	sa.key = "lustfulGlance";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("eyes");
	sa.targetBpReqs.push("eyes");
	
	sa.unvalidRelationalPositions.push(["takingFromBehind","takenFromBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastBehind","spitroastTarget"]);
	sa.unvalidRelationalPositions.push(["mountingFromBehind","mountingAndMounted"]);
	sa.unvalidRelationalPositions.push(["mountingAndMounted","mountingFromBehind"]);
	sa.unvalidRelationalPositions.push(["mountingAndMounted","mountedFromBehind"]);
	sa.unvalidRelationalPositions.push(["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("charm","useEyes","targetEyes");
	
	sa.description = "The character uses hypnotic magic to heat their target's lust through a seductive glance.\n"
				   + "Actor must have access to target's eyes.\n\nSingle target action.\n\nCharm.\n\n__Influences__:\nDamage: Actor's charisma x1.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var lustDamage = getChar(actorKey).charisma.getValue();
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
										(ktn(actorKey) + " enraptured " + ktn(target) + "'s eyes, and " + gC(target).perPr
										+ " felt " + gC(target).posPr + " groin heating up."),
										(ktn(actorKey) + "'s eyes captured " + ktn(target) + "'s , and " + gC(target).perPr
										+ " found " + gC(target).posPr + " own mind fantasizing.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ".";
		
		return results;
	}
	return sa;
}

window.createSaRealHypnoticGlance = function() {
	var sa = new sceneAction();
	sa.name = "Hypnotic Glance";
	sa.key = "realHypnoticGlance";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("eyes");
	sa.targetBpReqs.push("eyes");
	
	sa.unvalidRelationalPositions.push(["takingFromBehind","takenFromBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastBehind","spitroastTarget"]);
	sa.unvalidRelationalPositions.push(["mountingFromBehind","mountingAndMounted"]);
	sa.unvalidRelationalPositions.push(["mountingAndMounted","mountingFromBehind"]);
	sa.unvalidRelationalPositions.push(["mountingAndMounted","mountedFromBehind"]);
	sa.unvalidRelationalPositions.push(["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("hypnosis","useEyes","targetEyes","domination");
	
	sa.description = "The character uses hypnotic magic to erode their target's willpower through a seductive glance.\n"
				   + "Actor must have access to target's eyes.\n\nSingle target action.\n\nHypnosis."
				   + "\n\n__Influences__:\nDamage: Actor's charisma x2, actor's will x1.";
	
	sa.execute = function(actorKey,targetActors) {
	var actor = actorKey;
		if ( actor == "chPlayerCharacter" ) { addToStVarsList("monActUs"); }
		var results = new saResults;
		var target = targetActors[0];
		
		if ( actorKey == targetActors[0] ) {
			results.value = 0;
			results.description += getChar(actorKey).formattedName + " came to the realization that it's impossible to look at oneself without a mirror.";
		}
		else {
			var multAr = getSexDamageMult(actorKey,target,this.key);
			var willpowerDamage = ((getChar(actorKey).charisma.getValue() / 5) + (getChar(actorKey).will.getValue()) / 10) * multAr[0];
			getChar(targetActors[0]).willpower.changeValue(-willpowerDamage);
			results.value += willpowerDamage;
			results.description += randomFromList( [
										(ktn(actorKey) + " enraptured " + ktn(target) + "'s eyes, and " + gC(target).perPr
										+ " felt " + gC(target).posPr + " willpower slipping away."),
										(ktn(actorKey) + "'s eyes captured " + ktn(target) + "'s attention, and " + gC(target).perPr
										+ " felt " + gC(target).refPr + " getting lost in them.") ] );
			results.description += " " + ktn(target) + " received " + textWillpowerDamage(willpowerDamage) + ". " + multAr[1];
		}
							   
		return results;
	}
	return sa; 
}

		// Pain

window.createSaSpanking = function() {
	var sa = new sceneAction();
	sa.name = "Spanking";
	sa.key = "spanking";
	sa.targetType = "single";
	sa.tags.push("ss","sUse");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("arms");
	
	sa.requiredPositions = ["mountingFromBehind","spitroastBehind","mountingFromBehind","mountingAndMounted"];
	sa.targetRequiredPositions = ["mountedFromBehind","spitroastTarget","mountingAndMounted","mountedFromBehind"];
	sa.linkedPositions = true;
	
	sa.flavorTags.push("domination","usePain");
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		if ( State.variables.settings.pain == "disable" ) {
			isAllowed = false;
		}
		return isAllowed;
	}
	
	sa.description = "The character punishes their target by hitting their ass with an open hand.\n\n"
				   + "Single target action.\n\nDomination.\n\n__Influences__:\nDamage: Actor's physique x1, actor's resilience x1.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((gC(actorKey).physique.getValue() + gC(actorKey).resilience.getValue()) / 20) * multAr[0];
		var willpowerDamage = ((gC(actorKey).physique.getValue() + gC(actorKey).resilience.getValue()) / 8) * multAr[0];
		gC(target).lust.changeValue(-lustDamage);
		gC(target).willpower.changeValue(-willpowerDamage);
		results.description += randomFromList( [
									(ktn(actorKey) + " slapped " + ktn(target) + "'s " + assWord() + " with all " + gC(actorKey).posPr + " might."),
									(ktn(actorKey) + " punished " + ktn(target) + "'s " + assWord() + "."),
									(ktn(actorKey) + " spanked " + ktn(target) + " like a child.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(target) + " received " + textWillpowerDamage(willpowerDamage) + "." + multAr[1];
		
		return results;
	}
	
	return sa;
}

window.createSaBiteNeck = function() {
	var sa = new sceneAction();
	sa.name = "Bite neck";
	sa.key = "biteNeck";
	sa.targetType = "single";
	sa.tags.push("ss","sUse");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("mouth");
	
	sa.requiredPositions = ["mountingFromBehind","mountingFaceToFace","spitroastBehind","mountingFromBehind","mountingAndMounted"];
	sa.targetRequiredPositions = ["mountedFromBehind","mountedFaceToFace","spitroastTarget","mountingAndMounted","mountedFromBehind"];
	sa.linkedPositions = true;
	
	sa.flavorTags.push("domination","usePain");
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		if ( State.variables.settings.pain == "disable" ) {
			isAllowed = false;
		}
		return isAllowed;
	}
	
	sa.description = "The character pinches a neck with their teeth.\n\n"
				   + "Single target action.\n\nDomination.\n\n__Influences__:\nDamage: Actor's agility x2, actor's perception x2, actor's physique x1.";
	
	sa.execute = function(actor,targetActors) {
		var target = targetActors[0];
		var results = new saResults;
		
		var multAr = getSexDamageMult(actor,target,this.key);
		var lustDamage = ((gCstat(actor,"agility") * 2 + gCstat(actor,"physique") + gCstat(actor,"perception") * 2) / 40) * multAr[0];
		var willpowerDamage = lustDamage / 4;
		var socialdriveDamage = lustDamage / 4;
		gC(target).lust.attack(-lustDamage);
		gC(target).willpower.attack(-willpowerDamage);
		gC(target).socialdrive.attack(-socialdriveDamage);
		results.description += randomFromList( [
									(ktn(actor) + " took a bite on " + ktn(target) + "'s neck, leaving a mark."),
									(ktn(actor) + " placed " + gC(actor).posPr + " teeth on " + ktn(target) + "'s neck, who felt a shiver running down " + gC(target).posPr + " spine."),
									(ktn(target) + " shrunk in anticipation of the pain, when " + gC(target).perPr + " felt " + ktn(actor) + "'s teeth on " + gC(target).posPr + " neck.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ", " + textWillpowerDamage(willpowerDamage) + " and "
						     + textSocialdriveDamage(socialdriveDamage) + ". " + multAr[1];
		
		return results;
	}
	
	return sa;	
}

// Continued actions-related actions
window.createSaFrenchKiss = function() {
	var sa = new sceneAction();
	sa.name = "French Kiss (CA)";
	sa.key = "frenchKiss";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("cAct");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("mouth");
	sa.targetBpReqs.push("mouth");
	sa.caRank = 1;
	
	sa.unvalidRelationalPositions.push(["takingFromBehind","takenFromBehind"],["standing","kneeling"],["kneeling","standing"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["spitroastBehind","spitroastTarget"],["spitroastTarget","spitroastBehind"],["spitroastTarget","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["mountingFromBehind","mountingAndMounted"]);
	sa.unvalidRelationalPositions.push(["mountingAndMounted","mountingFromBehind"]);
	sa.unvalidRelationalPositions.push(["mountingAndMounted","mountedFromBehind"]);
	sa.unvalidRelationalPositions.push(["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("oral","useMouth","targetMouth","romantic","continuedAction");
	
	sa.description = "The character initiates a deep kiss with their target, exploring each other's tongues.\n"
				   + "Every character's mouth must be free.\n\nSingle target continued action.\n"
				   + "\n\nOral."
				   + "\n\n__Influences__:\nDamage: Actor's agility x1.\nContinued damage: Actor's agility x1, actor's perception x1, actor's empathy x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).agility.getValue() * 1) / 6.5) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
									(ktn(actorKey) + " captured " + ktn(target) + "'s lips and trapped them in a deep kiss."),
									(ktn(actorKey) + " started to deeply kiss " + ktn(target) + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		// Create Continued Action
		State.variables.sc.continuedActions.push(createCaFrenchKiss(actorKey,targetActors));
							   
		return results;
	}
	return sa;
}

window.createLegHoldHead = function() {
	var sa = new sceneAction();
	sa.name = "Leg-hold Head (CA)";
	sa.key = "legHoldHead";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("cAct");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("legs","pussy");
	sa.targetBpReqs.push("mouth");
	sa.caRank = 2;
	
	sa.requiredPositions.push("standing","spitroastFront");
	sa.targetRequiredPositions.push("kneeling","spitroastTarget");
	sa.linkedPositions = true;
	
	sa.flavorTags.push("oral","useLegs","targetMouth","domination","continuedAction");
	
	sa.description = "The character holds their target's head with one or two legs, forcing them to lick what's between them.\n"
				   + "Requires the actor's target to be kneeling before them.\n"
				   + "\nSingle target continued action."
				   + "\n\nOral."
				   + "\n\n__Influences__:\Continued self damage: Actor's resilience x2, actor's physique x1, target's agility x3.\nContinued willpower damage (if any): Actor's charisma x2, actor's will x1, target's will x-2.\nContinued damage (if any): Actor's charisma x1, target's will x-1, target's remaining willpower %.";
	
	sa.execute = function(actorKey,targetActors) {
		 var results = new saResults;
		 var target = targetActors[0];
		 
		 results.value = 0;
		 results.description += randomFromList( [
									(ktn(actorKey) + " enclosed " + ktn(target) + "'s head between " + gC(actorKey).posPr
									+ " legs, forcing " + gC(target).comPr + " to lick."),
									(ktn(actorKey) + " trapped " + ktn(target) + "'s head between " + gC(actorKey).posPr + " legs.") ] );
		
		// Create Continued action
		State.variables.sc.continuedActions.push(createCaLegHoldHead(actorKey,targetActors));
		
		return results;
	}
	return sa;
}
window.createExtraLegHoldHead = function() {
	var sa = new sceneAction();
	sa.name = "Extra Leg-hold Head (CA)";
	sa.key = "extraLegHoldHead";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("cAct","ccAct");
	sa.reqTags.push("diffTarget");
	sa.targetBpReqs.push("mouth");
	sa.caRank = 2;
	
	sa.requiredPositions.push("standing","spitroastFront");
	sa.targetRequiredPositions.push("kneeling","spitroastTarget");
	sa.linkedPositions = true;
	
	sa.requiredActorContinuedActions = ["legHoldingHead"];
	
	sa.flavorTags.push("oral","useLegs","targetMouth","domination","continuedAction");
	
	sa.description = "The character gets an extra target's head between their legs, making them both lick pussy. It may get cramped.\n"
				   + "Requires the actor's target to be kneeling before them.\n"
				   + "\nSingle target continued action."
				   + "\n\nOral."
				   + "\n\n__Influences__:\Continued self damage: Actor's resilience x2, actor's physique x1, target's agility x3.\nContinued willpower damage (if any): Actor's charisma x2, actor's will x1, target's will x-2.\nContinued damage (if any): Actor's charisma x1, target's will x-1, target's remaining willpower %.";
	
	sa.execute = function(actorKey,targetActors) {
		 var results = new saResults;
		 var target = targetActors[0];
		 
		 results.value = 0;
		 results.description += randomFromList( [
								(ktn(actorKey) + " beckons " + ktn(target) + " to get " + gC(target).posPr + " head between " + ktn(actorKey) + "'s legs."),
								(ktn(actorKey) + " doesn't have enough with one, and traps " + ktn(target) + "'s head between " + gC(actorKey).posPr + " thighs as well."),
								(ktn(target) + "'s tongue has difficulty to share " + ktn(actorKey) + "'s " + pussyWord() + " with someone else.") ] );
		
		// Modify Continued action
		addTargetToActorsCA(target,actorKey,"legHoldingHead");
		
		return results;
	}
	return sa;
}
window.createGiveCunnilingus = function() {
	var sa = new sceneAction();
	sa.name = "Give Cunnilingus (CA)";
	sa.key = "giveCunnilingus";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("cAct");
	sa.reqTags.push("diffTarget");
	sa.targetBpReqs.push("legs","pussy");
	sa.actorBpReqs.push("mouth");
	sa.caRank = 2;
	
	sa.targetRequiredPositions.push("standing","spitroastFront");
	sa.requiredPositions.push("kneeling","spitroastTarget");
	sa.linkedPositions = true;
	
	sa.flavorTags.push("oral","useMouth","targetPussy","continuedAction");
	
	sa.description = "The character holds their target's head with one or two legs, forcing them to lick what's between them.\n"
				   + "Requires the actor to be kneeling before the target.\n"
				   + "\nSingle target continued action."
				   + "\n\nOral."
				   + "\n\n__Influences__:\Continued damage: Target's resilience x2, target's physique x1, actor's agility x3.\nContinued willpower damage (if any): Target's charisma x2, target's will x1, actor's will x-2.\nContinued damage (if any): Target's charisma x1, actor's will x-1, actor's remaining willpower %.";
	
	sa.execute = function(actorKey,targetActors) {
		 var results = new saResults;
		 var target = targetActors[0];
		 
		 results.value = 0;
		 results.description += randomFromList( [
									(ktn(actorKey) + " started to " + randomFromList(["lick","devour","pleasure"]) + " " + ktn(target) + "'s " + pussyWord() + "."),
									(ktn(target) + "'s clitoris lights up as " + ktn(actorKey) + " starts to lick and suck it."),
									(ktn(actorKey) + "'s tongue starts exploring the insides of " + ktn(target) + "'s " + pussyWord() + ".") ] );
		
		// Create Continued action
		State.variables.sc.continuedActions.push(createCaLegHoldHead(targetActors[0],[actorKey]));
		
		return results;
	}
	return sa;
}

window.createSaPenetratePussy = function() {
	var sa = new sceneAction();
	sa.name = "Penetrate Pussy (CA)";
	sa.key = "penetratePussy";
	sa.targetType = "single";
	sa.tags.push("ss","cAct");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("dick");
	sa.targetBpReqs.push("pussy");
	sa.caRank = 2;
	
	sa.requiredPositions = ["mountingFromBehind","mountingFaceToFace","spitroastBehind"];
	sa.targetRequiredPositions = ["mountedFromBehind","mountedFaceToFace","spitroastTarget"];
	sa.requiredPositions.push("mountingAndMounted","mountingAndMounted","mountingFromBehind");
	sa.targetRequiredPositions.push("mountedFaceToFace","mountedFromBehind","mountingAndMounted");
	sa.linkedPositions = true;
	
	sa.flavorTags.push("fullsex","useDick","targetPussy","top","continuedAction");
	
	sa.description = "The character sticks their dick in their partner's snatch and begins fucking them.\n\nSingle target continued action."
				   + "\nActor requires free dick, target requires free pussy.\n\nFull sex."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1.\nContinued damage: Actor's and target's physique x1, actor's and target's resilience x1";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).physique.getValue() * 3 + getChar(actorKey).agility.getValue() * 1) / 10) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " started fucking " + ktn(target) + "'s " + pussyWord() + "."),
								(ktn(actorKey) + " nailed " + gC(actorKey).posPr + " " + dickWord() + " inside " + ktn(target) + "."),
								(ktn(actorKey) + " connected " + gC(actorKey).posPr + " " + dickWord() + " with " + ktn(target) + "'s " + pussyWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		// Continued Action
		State.variables.sc.continuedActions.push(createCaPenetratePussy(actorKey,targetActors));
		
		// Try virginities
		if ( getChar(targetActors[0]).virginities.pussy.taken == false ) {
			var vd2 = colorText((getChar(actorKey).name + " has taken " + getChar(targetActors[0]).name + "'s vaginal virginity! "),"red") + provokeVirginityBonusRelationship(actorKey,targetActors[0]);
			getChar(targetActors[0]).virginities.pussy.tryTakeVirginity(actorKey,"takeFromBehind",vd2);
		}
		if ( getChar(actorKey).virginities.dick.taken == false ) {
			var vd1 = colorText((getChar(targetActors[0]).name + " has taken " + getChar(actorKey).name + "'s penile virginity! "),"red") + provokeVirginityBonusRelationship(targetActors[0],actorKey);
			getChar(actorKey).virginities.dick.tryTakeVirginity(targetActors[0],"takeFromBehind",vd1);
		}
		
		return results;
	}
	return sa;
}
window.createSaPenetrateAss = function() {
	var sa = new sceneAction();
	sa.name = "Penetrate Ass (CA)";
	sa.key = "penetrateAss";
	sa.targetType = "single";
	sa.tags.push("ss","cAct");
	sa.caRank = 2;
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		
		if ( State.variables.settings.anal == "disable" ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("dick");
	sa.targetBpReqs.push("anus");
	
	sa.requiredPositions = ["mountingFromBehind","mountingFaceToFace","spitroastBehind"];
	sa.targetRequiredPositions = ["mountedFromBehind","mountedFaceToFace","spitroastTarget"];
	sa.requiredPositions.push("mountingAndMounted","mountingAndMounted","mountingFromBehind");
	sa.targetRequiredPositions.push("mountedFaceToFace","mountedFromBehind","mountingAndMounted");
	sa.linkedPositions = true;
	
	sa.flavorTags.push("fullsex","useDick","targetAnus","top","continuedAction");
	
	sa.description = "The character pushes their member into the target's rear and starts fucking it.\n\nSingle target continued action."
				   + "\nActor requires free dick, target requires free anus.\n\nFull sex."
				   + "\n\n__Influences__:\nDamage: Actor's physique x1, actor's agility x1.\nContinued damage, continued energy damage: Actor's physique x1, actor's resilience x1.\nContinued self damage: Target's agility x1, target's resilience x1.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).physique.getValue() * 2 + getChar(actorKey).agility.getValue() * 2) / 10) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " penetrated " + ktn(target) + "'s " + assWord() + "."),
								(ktn(actorKey) + " pushed " + gC(actorKey).posPr + " own " + dickWord() + " into " + ktn(target) + "'s " + assWord() + "."),
								(ktn(target) + " exhales some air after " + ktn(actorKey) + " finishes getting " + gC(actorKey).posPr + " " + dickWord()
								+ " into " + gC(target).posPr + " " + assWord() + ".") ]
								);
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		// Continued Action
		State.variables.sc.continuedActions.push(createCaPenetrateAss(actorKey,targetActors));
		
		// Try virginities
		if ( getChar(targetActors[0]).virginities.anal.taken == false ) {
			var vd2 = colorText((getChar(actorKey).name + " has taken " + getChar(targetActors[0]).name + "'s anal virginity! "),"red") + provokeVirginityBonusRelationship(actorKey,targetActors[0]);
			getChar(targetActors[0]).virginities.anal.tryTakeVirginity(actorKey,"takeFromBehind",vd2);
		}
		if ( getChar(actorKey).virginities.dick.taken == false ) {
			var vd1 = colorText((getChar(targetActors[0]).name + " has taken " + getChar(actorKey).name + "'s penile virginity! "),"red") + provokeVirginityBonusRelationship(targetActors[0],actorKey);
			getChar(actorKey).virginities.dick.tryTakeVirginity(targetActors[0],"takeFromBehind",vd1);
		}
		
		return results;
	}
	return sa;
}
window.createSaInterlockLegs = function() {
	var sa = new sceneAction();
	sa.name = "Interlock Legs (CA)";
	sa.key = "interlockLegs";
	sa.targetType = "single";
	sa.tags.push("ss","cAct");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("pussy");
	sa.targetBpReqs.push("pussy");
	sa.caRank = 2;
	
	sa.requiredPositions = ["mountingFaceToFace","mountingFromBehind","spitroastBehind"];
	sa.targetRequiredPositions = ["mountedFaceToFace","mountedFromBehind","spitroastTarget"];
	sa.requiredPositions.push("mountingAndMounted","mountingAndMounted","mountingFromBehind");
	sa.targetRequiredPositions.push("mountedFaceToFace","mountedFromBehind","mountingAndMounted");
	sa.linkedPositions = true;
	
	sa.flavorTags.push("fullsex","usePussy","targetPussy","top","continuedAction");
	
	sa.description = "The character crosses their legs with their their partner's, in order stimulate to both their clits and folds."
				   + "\n\nSingle target continued action.\nBoth actor and target require free pussy.\n\nFull sex."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1.\nContinued damage: Actor's and target's physique x1, actor's and target's resilience x1.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).physique.getValue() * 3 + getChar(actorKey).agility.getValue() * 1) / 10) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " interlocked " + gC(actorKey).posPr + " and " + ktn(target) + "'s pussies."),
								(ktn(actorKey) + " pushed " + gC(actorKey).posPr + " own " + pussyWord() + " against " + ktn(target) + "'s."),
								(ktn(actorKey) + " locked " + gC(actorKey).posPr + " legs with " + ktn(target) + "'s.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		State.variables.sc.continuedActions.push(createCaInterlockLegs(actorKey,targetActors));
		
		return results;
	}
	return sa;
}
window.createSaMountDick = function() {
	var sa = new sceneAction();
	sa.name = "Mount Dick (CA)";
	sa.key = "mountDick";
	sa.targetType = "single";
	sa.tags.push("ss","cAct");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("pussy");
	sa.targetBpReqs.push("dick");
	sa.caRank = 2;
	
	sa.requiredPositions = ["mountingFaceToFace","mountingAndMounted"];
	sa.targetRequiredPositions = ["mountedFaceToFace","mountedFaceToFace"];
	sa.linkedPositions = true;
	
	sa.flavorTags.push("fullsex","usePussy","targetDick","top","continuedAction");
	
	sa.description = "The character impales themself in their partner's dick, and begins fucking them.\n\nSingle target continued action."
				   + "\nActor requires free pussy, target requires free dick.\n\nFull sex."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1.\nContinued damage: Actor's and target's physique x1, actor's and target's resilience x1";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).physique.getValue() * 3 + getChar(actorKey).agility.getValue() * 1) / 10) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " started fucking " + ktn(target) + "'s " + dickWord() + "."),
								(ktn(actorKey) + " mounted " + ktn(target) + "'s " + dickWord() + "."),
								(ktn(actorKey) + " fell upon " + ktn(target) + "'s " + dickWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		// Continued Action
		State.variables.sc.continuedActions.push(createCaMountDick(actorKey,targetActors));
		
		// Try virginities
		if ( getChar(targetActors[0]).virginities.dick.taken == false ) {
			var vd2 = colorText((getChar(actorKey).name + " has taken " + getChar(targetActors[0]).name + "'s penile virginity! "),"red") + provokeVirginityBonusRelationship(actorKey,targetActors[0]);
			getChar(targetActors[0]).virginities.dick.tryTakeVirginity(actorKey,"mountDick",vd2);
		}
		if ( getChar(actorKey).virginities.pussy.taken == false ) {
			var vd1 = colorText((getChar(targetActors[0]).name + " has taken " + getChar(actorKey).name + "'s vaginal virginity! "),"red") + provokeVirginityBonusRelationship(targetActors[0],actorKey);
			getChar(actorKey).virginities.pussy.tryTakeVirginity(targetActors[0],"mountDick",vd1);
		}
		
		return results;
	}
	return sa;
}
window.createSaAnalMountDick = function() {
	var sa = new sceneAction();
	sa.name = "Anal Mount Dick (CA)";
	sa.key = "analMountDick";
	sa.targetType = "single";
	sa.tags.push("ss","cAct");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("anus");
	sa.targetBpReqs.push("dick");
	sa.caRank = 2;
	
	sa.requiredPositions = ["mountingFaceToFace","mountingAndMounted"];
	sa.targetRequiredPositions = ["mountedFaceToFace","mountedFaceToFace"];
	sa.linkedPositions = true;
	
	sa.flavorTags.push("fullsex","useAnus","targetDick","top","continuedAction");
	
	sa.description = "The character impales their ass in their partner's dick, and begins fucking them.\n\nSingle target continued action."
				   + "\nActor requires free ass, target requires free dick.\n\nFull sex."
				   + "\n\n__Influences__:\nLust and energy damage: Actor's physique x3, actor's resilience x1.\nContinued damage: Actor's and target's physique x1, actor's and target's resilience x1";
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		
		if ( State.variables.settings.anal == "disable" ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).physique.getValue() * 3 + getChar(actorKey).resilience.getValue() * 1) * 0.7 / 10) * multAr[0];
		var energyDamage = ((getChar(actorKey).physique.getValue() * 3 + getChar(actorKey).resilience.getValue() * 1) * 0.3 / 10) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		getChar(targetActors[0]).energy.changeValue(-energyDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " started fucking " + ktn(target) + "'s " + dickWord() + " with " + gC(actorKey).posPr + " " + assWord() + "."),
								(ktn(actorKey) + " envolved " + ktn(target) + "'s " + dickWord() + " with " + gC(actorKey).posPr + " " + assWord() + "."),
								(ktn(actorKey) + "'s " + assWord() + " fell upon " + ktn(target) + "'s " + dickWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + " and " + textEnergyDamage(energyDamage) + ". " + multAr[1];
		
		// Continued Action
		State.variables.sc.continuedActions.push(createCaAnalMountDick(actorKey,targetActors));
		
		// Try virginities
		if ( getChar(targetActors[0]).virginities.dick.taken == false ) {
			var vd2 = colorText((getChar(actorKey).name + " has taken " + getChar(targetActors[0]).name + "'s penile virginity! "),"red") + provokeVirginityBonusRelationship(actorKey,targetActors[0]);
			getChar(targetActors[0]).virginities.dick.tryTakeVirginity(actorKey,"analMountDick",vd2);
		}
		if ( getChar(actorKey).virginities.anal.taken == false ) {
			var vd1 = colorText((getChar(targetActors[0]).name + " has taken " + getChar(actorKey).name + "'s anal virginity! "),"red") + provokeVirginityBonusRelationship(targetActors[0],actorKey);
			getChar(actorKey).virginities.anal.tryTakeVirginity(targetActors[0],"analMountDick",vd1);
		}
		
		return results;
	}
	return sa;
}

window.createSaDoublePenetration = function() {
	var sa = new sceneAction();
	sa.name = "Double Penetration (CA)";
	sa.key = "doublePenetration";
	
	sa.targetType = "single";
	sa.tags.push("ss","cAct");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("dick");
	sa.targetBpReqs.push("pussy");
	sa.targetBpReqs.push("anus");
	sa.caRank = 2;
	
	sa.requiredRace = [ "shapeshifter" ];
	
	sa.requiredPositions = ["mountingFromBehind","mountingFaceToFace","spitroastBehind"];
	sa.targetRequiredPositions = ["mountedFromBehind","mountedFaceToFace","spitroastTarget"];
	sa.requiredPositions.push("mountingAndMounted","mountingAndMounted","mountingFromBehind");
	sa.targetRequiredPositions.push("mountedFaceToFace","mountedFromBehind","mountingAndMounted");
	sa.linkedPositions = true;
	
	sa.willpowerCost = 3;
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		
		if ( State.variables.settings.anal == "disable" ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	
	
	sa.flavorTags.push("fullsex","useDick","targetPussy","targetAnus","top","continuedAction");
	
	sa.description = "The character uses two phalluses to penetrate their partner's pussy and ass.\n\nSingle target continued action."
				   + "\nActor requires free dick, target requires free pussy and anus.\n\nFull sex."
				   + "\n\n__Influences__:\nDamage: Actor's physique x2, actor's agility x1.\nContinued damage: Actor's and target's physique x1, actor's and target's resilience x1";
	
	sa.execute = function(actorKey,targetActors) {
		var actor = actorKey;
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).physique.getValue() * 4 + getChar(actorKey).agility.getValue() * 2) / 10) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " formed a second " + dickWord() + " and started fucking " + ktn(target) + "'s " + pussyWord() + " and " + assWord() + "."),
								(ktn(actorKey) + " split " + gC(actorKey).posPr + " " + dickWord() + " into two and inserted both in " + ktn(target) + "'s genitals."),
								(ktn(actorKey) + " grew a second " + dickWord() + " and filled " + ktn(target) + " with both of them.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + generateSaCostsText(this,actor) + ". " + multAr[1];
		
		// Continued Action
		State.variables.sc.continuedActions.push(createCaDoublePenetration(actorKey,targetActors));
		
		// Try virginities
		if ( getChar(targetActors[0]).virginities.pussy.taken == false ) {
			var vd2 = colorText((getChar(actorKey).name + " has taken " + getChar(targetActors[0]).name + "'s vaginal virginity! "),"red") + provokeVirginityBonusRelationship(actorKey,targetActors[0]);
			getChar(targetActors[0]).virginities.pussy.tryTakeVirginity(actorKey,"doublePenetration",vd2);
		}
		if ( getChar(targetActors[0]).virginities.anal.taken == false ) {
			var vd3 = colorText((getChar(actorKey).name + " has taken " + getChar(targetActors[0]).name + "'s anal virginity! "),"red") + provokeVirginityBonusRelationship(actorKey,targetActors[0]);
			getChar(targetActors[0]).virginities.anal.tryTakeVirginity(actorKey,"doublePenetration",vd3);
		}
		if ( getChar(actorKey).virginities.dick.taken == false ) {
			var vd1 = colorText((getChar(targetActors[0]).name + " has taken " + getChar(actorKey).name + "'s penile virginity! "),"red") + provokeVirginityBonusRelationship(targetActors[0],actorKey);
			getChar(actorKey).virginities.dick.tryTakeVirginity(targetActors[0],"doublePenetration",vd1);
		}
		
		return results;
	}
	return sa;
}

window.createSaGetBlowjob = function() {
	var sa = new sceneAction();
	sa.name = "Get Blowjob (CA)";
	sa.key = "getBlowjob";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("cAct");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("dick");
	sa.targetBpReqs.push("mouth");
	sa.caRank = 2;
	
	sa.requiredPositions = ["standing","spitroastFront"]; // If the list contains anything, the actor requires one of these positions
	sa.targetRequiredPositions = ["kneeling","spitroastTarget"]; // If the list contains anything, the targets require one of these positions
	sa.linkedPositions = false; // If true, the actor and its targets require to be referenced as initiator or target in their respective positions
	
	sa.flavorTags.push("oral","useDick","targetMouth","top","domination","continuedAction");
	
	sa.description = "The character gets their target to start sucking their cock.\n"
				   + "Actor must have a free dick, target must have a free mouth.\n\nSingle target continued action.\n"
				   + "\nOral."
				   + "\n\n__Influences__:\nDamage: Actor's charisma x1.\nContinued self damage: Target's agility x1.\nContinued damage: Actor's resilience x1.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = (gC(actorKey).charisma.getValue() / 5) * multAr[0];
		gC(target).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " told " + ktn(target) + " to start sucking " + gC(actorKey).posPr + " " + dickWord() + "."),
								(ktn(actorKey) + " got " + ktn(target) + " to start sucking " + gC(actorKey).posPr + " " + dickWord() + "."),
								(ktn(target) + " was made to suck " + ktn(actorKey) + "'s " + dickWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		// Continued Action
		State.variables.sc.continuedActions.push(createCaGetBlowjob(actorKey,targetActors));
		
		return results;
	}
	
	return sa;
}
window.createSaGiveBlowjob = function() {
	var sa = new sceneAction();
	sa.name = "Give Blowjob (CA)";
	sa.key = "giveBlowjob";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("cAct");
	sa.reqTags.push("diffTarget");
	sa.targetBpReqs.push("dick");
	sa.actorBpReqs.push("mouth");
	sa.caRank = 2;
	
	sa.targetRequiredPositions = ["standing","spitroastFront"]; // If the list contains anything, the actor requires one of these positions
	sa.requiredPositions = ["kneeling","spitroastTarget"]; // If the list contains anything, the targets require one of these positions
	sa.linkedPositions = false; // If true, the actor and its targets require to be referenced as initiator or target in their respective positions
	
	sa.flavorTags.push("oral","targetDick","useMouth","top","domination","continuedAction");
	
	sa.description = "The character starts sucking and licking their target's cock.\n"
				   + "Target must have a free dick, actor must have a free mouth.\n\nSingle target continued action.\n"
				   + "\nOral."
				   + "\n\n__Influences__:\nDamage: Actor's charisma x1.\nContinued damage: Actor's agility x2.\nContinued self damage: Target's resilience x1.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = (gC(actorKey).charisma.getValue() / 5) * multAr[0];
		gC(target).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " ran " + gC(actorKey).posPr + " tongue along the skin of " + ktn(target) + "'s " + dickWord() + ", throughly savoring everything."),
								(ktn(actorKey) + " started to slide " + ktn(target) + "'s " + dickWord() + " up and down through " + gC(actorKey).posPr + " mouth.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		// Continued Action
		State.variables.sc.continuedActions.push(createCaGetBlowjob(targetActors[0],[actorKey]));
		
		return results;
	}
	
	return sa;
}

	// Weapon sex actions
window.createSaDildoPenetratePussy = function() {
	var sa = new sceneAction();
	sa.name = "Dildo-Pussy Penetration (CA)";
	sa.key = "dildoPenetratePussy";
	sa.targetType = "single";
	sa.tags.push("ss","cAct");
	sa.reqTags.push("diffTarget","unusedWeapon");
	sa.actorBpReqs.push("arms");
	sa.targetBpReqs.push("pussy");
	sa.caRank = 1;
	
	sa.unvalidRelationalPositions.push(["standing","kneeling"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"],["spitroastTarget","spitroastBehind"],["spitroastFront","spitroastTarget"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	
	sa.flavorTags.push("targetPussy","top","continuedAction");
	
	sa.description = "The character sticks their dildo into their partner's vaginal folds, and begins penetrating them.\n\nSingle target continued action."
				   + "\nActor requires free arms, target requires free pussy."
				   + "\n\n__Influences__:\nDamage: Actor's physique x1, actor's agility x1.\nContinued damage: Actor's physique and agility x1.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		setCharsWeaponInUse(actorKey);
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).physique.getValue() * 1 + getChar(actorKey).agility.getValue() * 1) / 8) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " entered " + ktn(target) + "'s " + pussyWord() + " with " + gC(actorKey).posPr + " dildo, and began " + randomFromList(["massaging","penetrating","rubbing"]) + " it."),
								(ktn(target) + "'s " + pussyWord() + " was invaded by " + ktn(actorKey) + "'s dildo."),
								(ktn(actorKey) + "'s dildo entered the folds of " + ktn(target) + ", who welcomed it inside " + gC(target).comPr + ".")
								] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		// Continued Action
		State.variables.sc.continuedActions.push(createCaDildoPenetratePussy(actorKey,targetActors));
		
		return results;
	}
	return sa;
}
window.createSaDildoPenetrateAss = function() {
	var sa = new sceneAction();
	sa.name = "Dildo-Ass Penetration (CA)";
	sa.key = "dildoPenetrateAss";
	sa.targetType = "single";
	sa.tags.push("ss","cAct");
	sa.reqTags.push("diffTarget","unusedWeapon");
	sa.actorBpReqs.push("arms");
	sa.targetBpReqs.push("anus");
	sa.caRank = 1;
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		
		if ( State.variables.settings.anal == "disable" ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	
	sa.unvalidRelationalPositions.push(["standing","kneeling"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"],["spitroastTarget","spitroastBehind"],["spitroastFront","spitroastTarget"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	
	sa.flavorTags.push("targetAnus","top","continuedAction");
	
	sa.description = "The character sticks their dildo into their partner's backside, and begins penetrating it.\n\nSingle target continued action."
				   + "\nActor requires free arms, target requires free anus."
				   + "\n\n__Influences__:\nDamage: Actor's physique x1, actor's agility x1.\nContinued lust and energy damage: Actor's physique and agility x1.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		setCharsWeaponInUse(actorKey);
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).physique.getValue() * 1 + getChar(actorKey).agility.getValue() * 1) / 8) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " entered " + ktn(target) + "'s " + assWord() + " with " + gC(actorKey).posPr + " dildo, and began " + randomFromList(["massaging","penetrating","rubbing"]) + " it."),
								(ktn(target) + "'s " + assWord() + " was invaded by " + ktn(actorKey) + "'s dildo."),
								(ktn(actorKey) + "'s dildo entered the rear of " + ktn(target) + ", who welcomed it inside " + gC(target).comPr + ".")
								] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		// Continued Action
		State.variables.sc.continuedActions.push(createCaDildoPenetrateAss(actorKey,targetActors));
		
		return results;
	}
	return sa;
}
window.createSaDildoPenetrateMouth = function() {
	var sa = new sceneAction();
	sa.name = "Dildo-Mouth Penetration (CA)";
	sa.key = "dildoPenetrateMouth";
	sa.targetType = "single";
	sa.tags.push("ss","cAct");
	sa.reqTags.push("diffTarget","unusedWeapon");
	sa.actorBpReqs.push("arms");
	sa.targetBpReqs.push("mouth");
	sa.caRank = 1;
	
	sa.unvalidRelationalPositions.push(["kneeling","standing"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"],["spitroastBehind","spitroastTarget"]);
	
	sa.flavorTags.push("targetMouth","top","continuedAction");
	
	sa.description = "The character inserts their dildo in their partner's mouth, gagging them with it.\n\nSingle target continued action."
				   + "\nActor requires free arms, target requires free mouth."
				   + "\n\n__Influences__:\nDamage: Actor's agility x1.\nContinued lust and social drive damage: Actor's agility x1.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		setCharsWeaponInUse(actorKey);
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).agility.getValue() * 1) / 12) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " inserted " + gC(actorKey).posPr + " dildo in " + ktn(target) + "'s mouth, making " + gC(target).comPr + " gag."),
								(ktn(actorKey) + " pushed deep inside " + ktn(target) + "'s throat with " + gC(actorKey).posPr + " dildo."),
								(ktn(actorKey) + " used " + gC(actorKey).posPr + " dildo to penetrate " + ktn(target) + "'s mouth.") 
								] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		// Continued Action
		State.variables.sc.continuedActions.push(createCaDildoPenetrateMouth(actorKey,targetActors));
		
		return results;
	}
	return sa;
}
window.createSaDoubleDildoPussyPenetration = function() {
	var sa = new sceneAction();
	sa.name = "Double Dildo-Pussy Penetration (CA)";
	sa.key = "doubleDildoPussyPenetration";
	sa.targetType = "single";
	sa.tags.push("ss","cAct");
	sa.reqTags.push("diffTarget","unusedWeapon");
	sa.actorBpReqs.push("pussy");
	sa.targetBpReqs.push("pussy");
	sa.caRank = 2;
	
	sa.requiredPositions = ["mountingFaceToFace"];
	sa.targetRequiredPositions = ["mountedFaceToFace"];
	sa.requiredPositions.push("mountingAndMounted");
	sa.targetRequiredPositions.push("mountedFaceToFace");
	sa.linkedPositions = true;
	
	sa.flavorTags.push("fullsex","usePussy","targetPussy","top","continuedAction");
	
	sa.description = "The character sticks their dildo into their own pussy and their partner's, both of them able to push it against each other.\n"
				   + "\n\nSingle target continued action.\nActor and target require free pussy."
				   + "\n\n__Influences__:\nDamage: Actor's and target's physique x2, agility x1, resilience x1.";
				   	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var actor = actorKey;
		var target = targetActors[0];
		setCharsWeaponInUse(actorKey);
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).physique.getValue() * 2 + getChar(actorKey).agility.getValue() * 1 + getChar(actorKey).resilience.getValue() * 1) / 10) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " connected " + ktn(target) + "'s " + pussyWord() + " and " + gC(actor).posPr + " own with " + gC(actor).posPr + " dildo, and started pushing against it."),
								(ktn(actorKey) + " inserts " + gC(actor).posPr + " dildo into both " + ktn(target) + "'s and " + gC(actor).posPr + " own " + randomFromList(["pussies","pussies","pussies","cherries","clams"]) + ", now connected in pleasure."),
								("After introducing " + gC(actor).posPr + " dildo into " + gC(actor).posPr + " " + pussyWord() + " and " + ktn(target) + "'s, both of them are now getting pleasured by the pushes of the other.")
								] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		State.variables.sc.continuedActions.push(createCaDoubleDildoPussyPenetration(actorKey,targetActors));
		
		return results;
	}
	return sa;
}


	// Fetish continued actions-related actions

		// Bondage

window.createSaHoldArms = function() {
	var sa = new sceneAction();
	sa.name = "Hold Arms (CA)";
	sa.key = "holdArms";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("cAct");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("arms");
	sa.targetBpReqs.push("arms");
	sa.caRank = 1;
	
	sa.requiredPositions = ["mountingFromBehind","mountingFaceToFace","spitroastBehind"];
	sa.targetRequiredPositions = ["mountedFromBehind","mountedFaceToFace","spitroastTarget"];
	sa.requiredPositions.push("mountingAndMounted","mountingAndMounted","mountingFromBehind");
	sa.targetRequiredPositions.push("mountedFaceToFace","mountedFromBehind","mountingAndMounted");
	sa.linkedPositions = true;
	
	sa.flavorTags.push("domination");
	
	sa.description = "The character grabs the target's arms and holds them in place, preventing their use.\n"
				   + "Actor and target must have free arms. They must share valid positions.\n\nSingle target continued action.\n"
				   + "\nDomination."
				   + "\n\n__Influences__:\nContinued willpower damage: Actor's physique x1, actor's resilience x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		results.value += 0;
		results.description += randomFromList( [
								(ktn(actorKey) + " grabbed " + ktn(target) + "'s arms and won't let them go."),
								(ktn(actorKey) + " immobilized " + ktn(target) + "'s arms."),
								(ktn(actorKey) + " restrained " + ktn(target) + "'s hands with " + gC(actorKey).posPr + " own.")
								] );
		
		State.variables.sc.continuedActions.push(createCaHoldArms(actorKey,targetActors));
		
		return results;
	}
	
	return sa;
}

window.createSaVinesHoldArms = function() {
	var sa = new sceneAction();
	sa.name = "Vines Hold Arms (CA)";
	sa.key = "vinesHoldArms";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("cAct");
	sa.reqTags.push("diffTarget");
	sa.targetBpReqs.push("arms");
	sa.caRank = 1;
	
	sa.requiredRace = [ "leirien" ];
	sa.willpowerCost = 3;
	
	sa.flavorTags.push("domination","bondage");
	
	sa.description = "The character uses their vines to restrain the target's arms.\n"
				   + "Actor will consume 3 willpower points.\nTarget must have free arms.\n\nSingle target continued action.\n"
				   + "\nDomination, bondage."
				   + "\n\n__Influences__:\nContinued willpower damage: Actor's intelligence x1, actor's resilience x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		// Bar costs
		gC(actorKey).willpower.current -= this.willpowerCost;
		
		results.value += 0;
		results.description += randomFromList( [
								(ktn(actorKey) + "'s vines tied " + ktn(target) + "'s hands."),
								(ktn(actorKey) + " has used " + gC(actorKey).posPr + " vines to tie " + ktn(target) + "'s arms."),
								(ktn(actorKey) + " has trapped " + ktn(target) + "'s arms with " + gC(actorKey).posPr + " vines.")
								] );
		results.description += " " + ktn(actorKey) + " consumed " + textWillpowerPoints(this.willpowerCost);
		
		// Continued Action
		State.variables.sc.continuedActions.push(createCaVinesHoldArms(actorKey,targetActors));
		
		return results;
	}
	
	return sa;
}

window.createSaEtherealChains = function() {
	var sa = new sceneAction();
	sa.name = "Ethereal Chains";
	sa.key = "etherealChains";
	sa.targetType = "single";
	sa.tags.push("ss","sUse");
	sa.reqTags.push("diffTarget","hasLead");
	sa.targetBpReqs.push("arms");
	sa.caRank = 1;
	
	sa.flavorTags.push("domination","bondage");
	
	sa.description = "The character casts ethereal chains to lock their target's arms with them.\n"
				   + "Target must have free arms. Actor must be leading.\n\nSingle target action.\n"
				   + "\nDomination, bondage.";
	
	sa.execute = function(actor,targetActors) {
		if ( actor == "chPlayerCharacter" ) { addToStVarsList("monActUs"); }
		var results = new saResults;
		var target = targetActors[0];
		
		results.value += 0;
		results.description += randomFromList( [
									(ktn(actor) + " conjured aethereal chains and tied " + ktn(target) + "'s arms with them."),
									(ktn(actor) + " ties " + ktn(target) + "'s arms with magical chains.")
								] );
		
		var altState = createASaetherialChainsArms(1);
		applyAlteredState([target],altState);
		
		return results;
	}
	
	return sa;
}

		// Slime
		
window.createSaSlimeHug = function() {
	var sa = new sceneAction();
	sa.name = "Slime Hug (CA)";
	sa.key = "slimeHug";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("cAct");
	sa.reqTags.push("diffTarget");
	sa.caRank = 1;
	sa.strategyTags.push("tfHalfPlus");
	
	sa.requiredRace = [ "shapeshifter" ];
	sa.willpowerCost = 3;
	
	sa.requiredPositions = ["mountingFromBehind","mountingFaceToFace","mountedFromBehind","mountedFaceToFace","spitroastBehind"];
	sa.targetRequiredPositions = ["mountedFromBehind","mountedFaceToFace","mountingFromBehind","mountingFaceToFace","spitroastTarget"];
	sa.requiredPositions.push("mountingAndMounted","mountingAndMounted","mountingFromBehind");
	sa.targetRequiredPositions.push("mountedFaceToFace","mountedFromBehind","mountingAndMounted");
	sa.linkedPositions = true;
	
	sa.flavorTags.push("domination","bondage");
	
	sa.description = "The character extends their slimy body to surround their partner's skin.\n"
				   + "The target will receive continued lust, energy and willpower damage, will lose agility, and their lead gain rate will be reduced.\nActor will consume 3 willpower points.\n\nSingle target continued action.\n"
				   + "\nDomination, bondage."
				   + "\n\n__Influences__:\nContinued damage: Actor's agility x1, actor's resilience x1, actor's will x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		var actor = actorKey;
		var results = new saResults;
		var target = targetActors[0];
		
		// Bar costs
		gC(actorKey).willpower.current -= this.willpowerCost;
		
		// Lust damage, willpower damage
		
		// Altered state
		var altState = createASslimed(5);
		applyAlteredState([target],altState);
		
		results.value += 0;
		results.description += randomFromList( [
								(ktn(actor) + " embraced " + ktn(target) + ", trapping " + gC(target).comPr + " within the slime."),
								(ktn(actor) + " spread " + gC(actor).posPr + " slime over " + ktn(target) + "."),
								(ktn(target) + " feels " + ktn(actor) + "'s slime surround " + gC(target).posPr + " body, trapping " + gC(target).comPr + ".")
								] );
		results.description += " " + ktn(actorKey) + " consumed " + textWillpowerPoints(this.willpowerCost);
		
		// Continued Action
		var currentSh = null;
		for ( var cA of State.variables.sc.continuedActions ) {
			if ( cA.key == "slimeHug" && cA.initiator == actor && cA.targetsList.includes(target) ) {
				currentSh = cA;
			}
		}
		if ( currentSh == null ) {
			State.variables.sc.continuedActions.push(createCaSlimeHug(actorKey,targetActors));
		} else {
			currentSh.intensity++;
			results.description += " The slime further surrounds " + ktn(target) + ".";
		}
		
		return results;
	}
	
	return sa;
}

window.getCharsSlimedIntensity = function(charKey) {
	var slimedStatusAmount = 0;
	var slimeHugIntensity = 0;
	for ( var as of gC(charKey).alteredStates ) {
		if ( as.acr == "Slmd" ) {
			slimedStatusAmount++;
		}
	}
	for ( var cA of State.variables.sc.continuedActions ) {
		if ( cA.key == "slimeHug" && cA.targetsList[0] == charKey ) {
			if ( cA.intensity != undefined ) {
				slimeHugIntensity = cA.intensity;
			}
		}
	}
	var result = (slimedStatusAmount * 2) + slimeHugIntensity;
	return result;
}

	// Draining

window.createSaEnergyDrainingKiss = function() {
	var sa = new sceneAction();
	sa.name = "Energy Draining Kiss (CA)";
	sa.key = "energyDrainingKiss";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("cAct");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("mouth");
	sa.targetBpReqs.push("mouth");
	sa.caRank = 1;
	
	sa.unvalidRelationalPositions.push(["takingFromBehind","takenFromBehind"],["standing","kneeling"],["kneeling","standing"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["spitroastBehind","spitroastTarget"],["spitroastTarget","spitroastBehind"],["spitroastTarget","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["mountingFromBehind","mountingAndMounted"]);
	sa.unvalidRelationalPositions.push(["mountingAndMounted","mountingFromBehind"]);
	sa.unvalidRelationalPositions.push(["mountingAndMounted","mountedFromBehind"]);
	sa.unvalidRelationalPositions.push(["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("oral","useMouth","targetMouth","romantic","continuedAction","draining");
	
	sa.description = "The character connects their mouth with their targets' in a kiss, draining their energy.\n"
				   + "Every character's mouth must be free.\n\nSingle target continued action.\n"
				   + "\nOral, draining."
				   + "\n\n__Influences__:\Drained damage: Actor's agility x1.\nContinued drained damage: Actor's agility x1, actor's perception x1, actor's empathy x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var lustDamage = ((getChar(actorKey).agility.getValue() * 1) / 8) * multAr[0];
		var drainedEnergy = ((getChar(actorKey).agility.getValue() * 1) / 10) * multAr[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		gC(target).energy.changeValue(-drainedEnergy);
		gC(actorKey).energy.changeValue(drainedEnergy);
		results.value += lustDamage;
		
		results.description += randomFromList( [
									(ktn(actorKey) + " trapped " + ktn(target) + "'s lips, and drained " + gC(target).posPr + " energy through them."),
									(ktn(actorKey) + " started a kiss with " + ktn(target) + ", who feels weaker and weaker..."),
									(ktn(actorKey) + " pushed " + gC(actorKey).posPr + " tongue into " + ktn(target) + "'s mouth, stealing " + gC(target).posPr + " energy.") ] );
									
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + ktn(actorKey) + " drained "
							 + textEnergyDamage(drainedEnergy) + " from " + ktn(target) + ". " + multAr[1];
		
		// Create Continued Action
		State.variables.sc.continuedActions.push(createCaEnergyDrainingKiss(actorKey,targetActors));
							   
		return results;
	}
	return sa;
}

/* Cunnilingus postponed until required
window.createSaGetCunnilingus = function() {
	var sa = new sceneAction();
	sa.name = "Get Cunnilingus (CA)";
	sa.key = "getCunnilingus";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("cAct");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("pussy");
	sa.targetBpReqs.push("mouth");
	
	sa.requiredPositions = ["standing"]; // If the list contains anything, the actor requires one of these positions
	sa.targetRequiredPositions = ["kneeling"]; // If the list contains anything, the targets require one of these positions
	sa.linkedPositions = false; // If true, the actor and its targets require to be referenced as initiator or target in their respective positions
	
	sa.flavorTags.push("oral","usePussy","targetMouth","top","domination","continuedAction");
	
	sa.description = "The character gets their target to start sucking their pussy.\n"
				   + "Actor must have a free pussy, target must have a free mouth.\n\nSingle target continued action.\n"
				   + "Influenced by actor's charisma and resilience, and target's agility.\n\nOral.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		var lustDamage = gC(actorKey).charisma.getValue() / 5;
		gC(target).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(actorKey) + " told " + ktn(target) + " to start eating " + ktn(actorKey).posPr + " " + pussyWord() + "."),
								(ktn(actorKey) + " got " + ktn(target) + " to start licking " + ktn(actorKey).posPr + " " + pussyWord() + "."),
								(ktn(target) + " was made to suck " + ktn(actorKey) + "'s " + pussyWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ".";
		
		// Continued Action
		State.variables.sc.continuedActions.push(createCaGetBlowjob(actorKey,targetActors));
		
		return results;
	}
	
	return sa;
}
*/

// Position-related actions
window.createSaMountFromBehind = function() {
	var sa = new sceneAction();
	sa.name = "Mount from behind (POS)";
	sa.key = "mountFromBehind";
	sa.targetType = "single";
	sa.tags.push("ss","pos");
	sa.positionResults = ["mountingFromBehind","mountedFromBehind"];
	sa.reqTags.push("diffTarget");
	
	sa.flavorTags.push("position");
	
	sa.strategyTags.push("tfMinus");
	
	sa.description = "The character bends their target over, and positions themselves behind them.\n\nSingle target positional action.\n";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		results.value += 0;
		results.description = randomFromList( [
								(ktn(actorKey) + " grabbed " + ktn(target) + " from behind and bent " + gC(target).comPr + " over."),
								(ktn(actorKey) + " mounted " + ktn(target) + " from behind."),
								(ktn(actorKey) + " put " + gC(actorKey).refPr + " behind " + ktn(target) + " and grabbed " + gC(target).comPr + ".") ] );
								
		// Position
		createPosMountFromBehind(actorKey,targetActors);
		
		return results;
	}
	return sa;
}

window.createSaMountFaceToFace = function() {
	var sa = new sceneAction();
	
	sa.name = "Mount face to face (POS)";
	sa.key = "mountFaceToFace";
	sa.targetType = "single";
	sa.tags.push("ss","pos");
	sa.positionResults = ["mountingFaceToFace","mountedFaceToFace"];
	sa.reqTags.push("diffTarget");
	
	sa.flavorTags.push("position");
	
	sa.strategyTags.push("tfPos");
	
	sa.description = "The character embraces their target looking face to face.\n\nSingle target positional action.\n";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		
		results.value += 0;
		results.description = randomFromList( [
								(ktn(actorKey) + " embraced " + ktn(target) + " and held " + gC(target).comPr + "."),
								(ktn(actorKey) + " mounted " + ktn(target) + " from above."),
								(ktn(actorKey) + " took " + ktn(target) + " into " + gC(actorKey).posPr + " arms.") ] );
								
		// Position
		createPosMountFaceToFace(actorKey,targetActors);
		
		return results;
	}
	
	return sa;
}

window.createSaKneel = function() {
	
	var sa = new sceneAction();
	sa.name = "Kneel (POS)";
	sa.key = "kneel";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("pos");
	sa.positionResults = ["kneeling","standing"];
	sa.reqTags.push("diffTarget");
	
	sa.flavorTags.push("position");
	
	sa.strategyTags.push("tfMinus");
	
	sa.description = "The character kneels in front of their target.\n\nSingle target positional action.\n\nOral.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		
		results.value += 0;
		results.description += getChar(actorKey).formattedName + " knelt in front of " + getChar(targetActors[0]).formattedName + ".";
		
		// Position
		var targets = [];
		targets.push(actorKey);
		createPosKneel(targetActors[0],targets);
		
		return results;
	}
	
	return sa;
	
}
window.createSaMakeKneel = function() {
	var sa = new sceneAction();
	sa.name = "Make Kneel (POS)";
	sa.key = "makeKneel";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("pos");
	sa.positionResults = ["standing","kneeling"];
	sa.reqTags.push("diffTarget");
	
	sa.flavorTags.push("position");
	
	sa.strategyTags.push("tfMinus");
	
	sa.description = "The character makes their target kneel before themselves.\n\nSingle target positional action.\n\nOral.";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		
		results.value += 0;
		results.description += getChar(actorKey).formattedName + " ordered " + getChar(targetActors[0]).formattedName + " to kneel.";
		
		// Position
		createPosKneel(actorKey,targetActors);
		
		return results;
	}
	return sa;
}

window.createSaExtraMountFromBehind = function() {
	var sa = new sceneAction();
	
	sa.name = "Extra mount from behind (CPOS)";
	sa.key = "extraMountFaceToFace";
	sa.targetType = "single";
	sa.tags.push("ss","cpos");
	sa.positionResults = ["mountingFromBehind","mountingAndMounted"];
	sa.reqTags.push("diffTarget");
	sa.getRequiredPositioning = function(actor,target) {
		var validFlag = false;
		if ( gC(target).position.key == "kneeling" ) {
			if ( gC(target).position.hasOwnProperty("secondaryInitiator") == false ) {
				validFlag = true;
			}
		} else if ( gC(target).position.key == "mountingFaceToFace" ) {
			if ( gC(target).position.hasOwnProperty("secondaryInitiator") == false ) {
				validFlag = true;
			}
		} else if ( gC(target).position.key == "mountingFromBehind" ) {
			if ( gC(target).position.hasOwnProperty("secondaryInitiator") == false ) {
				validFlag = true;
			}
		}
		return validFlag;
	}
	
	sa.flavorTags.push("position");
	
	sa.description = "The character holds their target from behind.\nThe target must already be in a correct position.\n\nSingle target composite positional action.\n";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		var type = "";
		
		// Get type
		if ( gC(target).position.key == "kneeling" ) {
			if ( gC(target).position.hasOwnProperty("secondaryInitiator") == false ) {
				type = "spitroast";
			}
		} else if ( gC(target).position.key == "mountingFaceToFace" ) {
			if ( gC(target).position.hasOwnProperty("secondaryInitiator") == false ) {
				type = "mountingAndMounted";
			}
		} else if ( gC(target).position.key == "mountingFromBehind" ) {
			if ( gC(target).position.hasOwnProperty("secondaryInitiator") == false ) {
				type = "mountingAndMountedAlt";
			}
		}
		results.value += 0;
		
		
		switch(type) {
			case "spitroast":
				results.description = randomFromList( [
								(ktn(actorKey) + " took " + ktn(target) + " hips from behind, leaving " + gC(target).comPr + " spitroasted."),
								(ktn(target) + " notices how " + ktn(actorKey) + " is positioning behind " + gC(target).comPr + "."),
								(ktn(target) + " gets taken by " + ktn(actorKey) + " from behind, getting on all fours.") ] );
				createComPosSpitroast(actorKey,target);
				break;
			case "mountingAndMounted":
				results.description = randomFromList( [
								(ktn(actorKey) + " takes position above " + ktn(target) + "'s back."),
								(ktn(actorKey) + " mounts " + ktn(target) + " from behind."),
								(ktn(target) + " feels " + ktn(actorKey) + " holding " + gC(target).posPr + " hips.") ] );
				createComPosMountingAndMounted(actorKey,target);
				break;
			case "mountingAndMountedAlt":
				results.description = randomFromList( [
								(ktn(actorKey) + " takes position above " + ktn(target) + "'s back."),
								(ktn(actorKey) + " mounts " + ktn(target) + " from behind."),
								(ktn(target) + " feels " + ktn(actorKey) + " holding " + gC(target).posPr + " hips.") ] );
				createComPosMountingAndMountedAlt(actorKey,target);
				break;
		}
				
		return results;
	}
	
	return sa;
}
// createSaExtraKneel
// createSaExtraMakeKneel
window.createSaExtraKneel = function() {
	var sa = new sceneAction();
	
	sa.name = "Extra kneel (CPOS)";
	sa.key = "extraKneel";
	sa.targetType = "single";
	sa.tags.push("ss","cpos");
	sa.positionResults = ["kneel","standing"];
	sa.reqTags.push("diffTarget");
	sa.getRequiredPositioning = function(actor,target) {
		var validFlag = false;
		if ( gC(target).position.key == "standing" ) {
			if ( gC(target).position.hasOwnProperty("secondaryInitiator") == false ) {
				validFlag = true;
			}
		}
		return validFlag;
	}
	
	sa.flavorTags.push("position");
	
	sa.description = "The character kneels before a target who already has someone else in their knees.\nThe target must already be in a correct position.\n\nSingle target composite positional action.\n";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		var type = "";
		
		// Get type
		if ( gC(target).position.key == "standing" ) {
			if ( gC(target).position.hasOwnProperty("secondaryInitiator") == false ) {
				type = "standing";
			}
		}
		results.value += 0;
		
		switch(type) {
			case "standing":
				results.description = randomFromList( [
								(ktn(actorKey) + " got on " + gC(actorKey).posPr + " knees next to " + ktn(gC(target).position.targetsList[0]) + "."),
								(ktn(actorKey) + " got on all fours and crawled before " + ktn(target) + "."),
								(ktn(target) + " welcomed " + ktn(actorKey) + " when " + gC(actorKey).perPr + " kneeled before " + gC(target).comPr + ".") ] );
				createComPosDoubleKneeling(target,actorKey);
				break;
		}
		
		return results;
	}
	
	return sa;
}
window.createSaExtraMakeKneel = function() {
	var sa = new sceneAction();
	
	sa.name = "Extra make kneel (CPOS)";
	sa.key = "extraMakeKneel";
	sa.targetType = "single";
	sa.tags.push("ss","cpos");
	sa.positionResults = ["standing","kneel"];
	sa.reqTags.push("diffTarget");
	sa.getRequiredPositioning = function(actor,target) {
		var validFlag = false;
		if ( gC(actor).position.key == "standing" && gC(target).position.key == "free" ) {
			if ( gC(actor).position.targetsList.length < 2 ) {
				validFlag = true;
			}
		}
		return validFlag;
	}
	
	sa.flavorTags.push("position");
	
	sa.description = "The character makes a second character kneel before them.\nThe actor must already have someone kneeling before them.\n\nSingle target composite positional action.\n";
	
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		var actor = actorKey;
		var type = "";
		
		// Get type
		if ( gC(actor).position.key == "standing" ) {
			if ( gC(actor).position.hasOwnProperty("secondaryInitiator") == false ) {
				type = "standing";
			}
		}
		results.value += 0;
		
		switch(type) {
			case "standing":
				results.description = randomFromList( [
								(ktn(actorKey) + " beckoned " + ktn(target) + " to kneel before " + gC(actorKey).comPr + "."),
								(ktn(actorKey) + " ordered " + ktn(target) + " to kneel beside " + ktn(gC(actor).position.targetsList[0]) + ", and " + gC(target).perPr + " obeyed."),
								(ktn(target) + " complied when " + ktn(actorKey) + " told " + gC(target).comPr + " to get on " + gC(target).posPr + " knees.") ] );
				createComPosDoubleKneeling(actorKey,target);
				break;
		}
		
		return results;
	}
	
	return sa;
}


	// Denial
window.createSaDenyOrgasm = function() {
	var sa = new sceneAction();
	sa.name = "Deny orgasm";
	sa.key = "denyOrgasm";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.reqTags.push("hasLead");
	sa.actorBpReqs.push("arms");
	
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastTarget"]);
	
	sa.flavorTags.push("denial","domination");
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		
		if ( State.variables.settings.chastity == "disable" ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	
	sa.description = "The character locks their partner in place, attempting to ruin their orgasm.\n\nSingle target action.\n"
				   + "Actor requires free hands.\n\nDenial.\n\n__Influences__:\nNone.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var actor = actorKey;
		var target = targetActors[0];
		
		var lustPc = getBarPercentage(target,"lust");
		
		if ( lustPc > 0.1 ) {
			results.value = 0;
			results.description += randomFromList( [
										(ktn(actor) + " tried to deny " + ktn(target) + "'s orgasm, but " + gC(target).perPr + " wasn't close enough."),
										(ktn(actor) + " attempted to ruin " + ktn(target) + "'s climax, but it wasn't close enough yet.") ] );
		} else {
			var multAr = getSexDamageMult(actorKey,target,this.key);
			var lustDamage = (gC(target).lust.max * 0.15) * multAr[0];
			gC(target).lust.changeValue(-lustDamage);
			
			addTurnTagToChar("denied",target);
			
			results.value += lustDamage;
			results.description += randomFromList( [
										(ktn(actor) + " locked " + ktn(target) + " in place, denying " + gC(target).posPr + " pleasure."),
										(ktn(actor) + " prevented " + ktn(target) + " from getting any pleasure during " + gC(target).posPr + " climax."),
										(ktn(actor) + " denied " + ktn(target) + "'s orgasm, much to " + gC(target).posPr + " frustration.") ] );
			results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		}
		
		return results;
	}
	
	return sa;
}	
window.createSaTeaseLockedPussy = function() {
	var sa = new sceneAction();
	sa.name = "Tease locked pussy";
	sa.key = "teaseLockedPussy";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.actorBpReqs.push("arms");
	sa.targetLockedBpReqs.push("pussy");
	
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastTarget"]);
	
	sa.flavorTags.push("denial","domination","targetPussy");
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		
		if ( State.variables.settings.chastity == "disable" ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	
	sa.description = "The character teases their partner's locked pussy, attempting to ruin their orgasm.\n\nSingle target action.\n"
				   + "Actor requires free hands, target requires locked pussy.\n\nDenial.\n\n__Influences__:\nDamage: Actor's charisma x1, empathy x1, perception x1, agility x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var actor = actorKey;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var threshold = 0.1 + ( gCstat(actor,"charisma") + gCstat(actor,"empathy") + gCstat(actor,"agility") + gCstat(actor,"perception") ) * 0.00025;
		var startingLustDamage = ( gCstat(actor,"charisma") + gCstat(actor,"empathy") + gCstat(actor,"agility") + gCstat(actor,"perception") ) * 0.05 * multAr[0];
		results.value += startingLustDamage;
		gC(target).lust.changeValue(-startingLustDamage);
		
		var lustPc = getBarPercentage(target,"lust");
		
		if ( lustPc > threshold ) {
			results.description += randomFromList( [
										(ktn(actor) + " teased " + ktn(target) + "'s nethers, reminding " + gC(target).comPr + " of " + gC(target).posPr + " locked " + pussyWord() + "."),
										(ktn(actor) + " taunted " + ktn(target) + " about not being able to pleasure " + gC(target).posPr + " own " + pussyWord() + ".")
											] );
			results.description += " " + ktn(target) + " received " + textLustDamage(startingLustDamage) + ".";
		} else {
			var lustDamage = gC(target).lust.max * 0.25;
			gC(target).lust.changeValue(-lustDamage);
			
			addTurnTagToChar("denied",target);
			
			results.value += lustDamage;
			results.description += randomFromList( [
										(ktn(actor) + " teased " + ktn(target) + "'s nethers, reminding " + gC(target).comPr + " of " + gC(target).posPr + " locked " + pussyWord() + ". " + ktn(target) + " gave in to the humilliation."),
										(ktn(actor) + " taunted " + ktn(target) + " about not being able to pleasure " + gC(target).posPr + " own " + pussyWord() + ". " + ktn(target) + " couldn't hold the shame.")
											] );
			results.description += " " + ktn(target) + " received " + textLustDamage(startingLustDamage + lustDamage) + ". " + multAr[1];
		}
		
		return results;
	}
	
	return sa;
}		
window.createSaTeaseLockedDick = function() {
	var sa = new sceneAction();
	sa.name = "Tease locked dick";
	sa.key = "teaseLockedDick";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.actorBpReqs.push("arms");
	sa.targetLockedBpReqs.push("dick");
	
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastTarget"]);
	
	sa.flavorTags.push("denial","domination","targetDick");
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		
		if ( State.variables.settings.chastity == "disable" ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	
	sa.description = "The character teases their partner's locked dick, attempting to ruin their orgasm.\n\nSingle target action.\n"
				   + "Actor requires free hands, target requires locked dick.\n\nDenial.\n\n__Influences__:\nDamage: Actor's charisma x1, empathy x1, perception x1, agility x1.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var actor = actorKey;
		var target = targetActors[0];
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var threshold = 0.1 + ( gCstat(actor,"charisma") + gCstat(actor,"empathy") + gCstat(actor,"agility") + gCstat(actor,"perception") ) * 0.00025;
		var startingLustDamage = ( gCstat(actor,"charisma") + gCstat(actor,"empathy") + gCstat(actor,"agility") + gCstat(actor,"perception") ) * 0.05 * multAr[0];
		results.value += startingLustDamage;
		gC(target).lust.changeValue(-startingLustDamage);
		
		var lustPc = getBarPercentage(target,"lust");
		
		if ( lustPc > threshold ) {
			results.description += randomFromList( [
										(ktn(actor) + " teased " + ktn(target) + "'s thighs, reminding " + gC(target).comPr + " of " + gC(target).posPr + " locked " + dickWord() + "."),
										(ktn(actor) + " taunted " + ktn(target) + " about not being able to pleasure " + gC(target).posPr + " own " + dickWord() + ".")
											] );
			results.description += " " + ktn(target) + " received " + textLustDamage(startingLustDamage) + ".";
		} else {
			var lustDamage = gC(target).lust.max * 0.25;
			gC(target).lust.changeValue(-lustDamage);
			
			addTurnTagToChar("denied",target);
			
			results.value += lustDamage;
			results.description += randomFromList( [
										(ktn(actor) + " teased " + ktn(target) + "'s thighs, reminding " + gC(target).comPr + " of " + gC(target).posPr + " locked " + dickWord() + ". " + ktn(target) + " gave in to the humilliation."),
										(ktn(actor) + " taunted " + ktn(target) + " about not being able to pleasure " + gC(target).posPr + " own " + dickWord() + ". " + ktn(target) + " couldn't hold the shame.")
											] );
			results.description += " " + ktn(target) + " received " + textLustDamage(startingLustDamage + lustDamage) + ". " + multAr[1];
		}
		
		return results;
	}
	
	return sa;
}	

	// Transformation
window.createSaSculptingKiss = function() {
	var sa = new sceneAction();
	sa.name = "Sculpting Kiss";
	sa.key = "sculptingKiss";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.tags.push("tf");
	sa.actorBpReqs.push("mouth");
	sa.tfGoals = ["rebuildFace"];
	sa.strategyTags.push("tfPlus");
	
	sa.unvalidRelationalPositions.push(["kneeling","standing"],["takenFromBehind","takingFromBehind"],["spitroastBehind","spitroastTarget"],
									   ["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["mountingFromBehind","mountingAndMounted"],["mountingAndMounted","mountingFromBehind"],["mountingAndMounted","mountedFromBehind"],["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("useMouth");
	
	sa.description = "The character uses their mouth and tongue to cast transformation magic on their target's face.\n\nSingle target action.\n"
				   + "Actor requires free mouth.\n\n__Influences__:\nDamage: Actor's agility x3, will x2, intelligence x1, perception x2, luck x1, target's slimed intensity.";
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var actor = actorKey;
		
		for (var target of targetActors) {
			var multAr = getSexDamageMult(actorKey,target,this.key);
			var slimedIntensity = 1 + (getCharsSlimedIntensity(target) * 0.1);
			var lustDamage = ((gCstat(actor,"agility") * 3 + gCstat(actor,"will") * 2 + gCstat(actor,"intelligence") * 1 + gCstat(actor,"perception") * 2 + gCstat(actor,"luck") * 1) / 30);
			var lustDamage2 = lustDamage * (0.3 + limitedRandomInt(20) * 0.01);
			lustDamage *= slimedIntensity * multAr[0];
			var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
			lustDamage2 *= multAr2[0];
			getChar(target).lust.changeValue(-lustDamage);
			gC(actorKey).lust.changeValue(-lustDamage2);
			
			advanceTfGoalsPoints(this.tfGoals);
			
			results.value += lustDamage;
			
			results.description += randomFromList( [
											(ktn(actorKey) + "'s tongue runs all over " + ktn(target) + "'s face, stirring up lines of aether and flesh and leaving a soft tingling behind."),
											(ktn(actorKey) + "'s lips kiss and massage " + ktn(target) + "'s cheeks and chin, molding them to a new figure."),
											(ktn(actorKey) + "'s mouth plays with " + ktn(target) + "'s face as if it was candy, softly pushing and pulling its lines back and forth.") ] );
			results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1] + " " + ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		}
		
		return results;
	}
	return sa;
}	
window.createSaSculptChest = function() {
	var sa = new sceneAction();
	sa.name = "Sculpt Chest";
	sa.key = "sculptChest";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.actorBpReqs.push("arms");
	sa.targetBpReqs.push("breasts");
	sa.tags.push("tf");
	sa.tfGoals = ["removeBreasts","addBreasts"];
	sa.strategyTags.push("tfPlus");
	
	sa.unvalidRelationalPositions.push(["standing","kneeling"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["mountedFromBehind","mountingFromBehind"],["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("foreplay","useHands","targetBreasts");
	
	sa.description = "The character will give a new form to their target's chest.\nThis action may sensitize the target's breasts.\n\n"
				   + "Single target action.\nActor requires free hands, target requires free breasts.\n\nForeplay.\n\n__Influences__:\n"
				   + "Damage: Actor's physique x1, agility x2, resilience x2, will x2, perception x1, luck x1, target's slimed intensity.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		var actor = actorKey;
		
		if ( doesCharHaveAlteredState(target,"Bre+") == false ) {
			// Sensitized breasts
			var intensity = 0.05 + gCstat(actorKey,"agility") * 0.005 + limitedRandomInt(5) * 0.01;
			var turns = 4 + limitedRandomInt(4) + (gCstat(actorKey,"agility") * 0.04) - ((gCstat(actorKey,"agility") * 0.04) % 1);
			var as = createSensitizedTag(intensity,"useBreasts","Sensitized breasts","Bre+",turns,"The breasts of this character will receive extra damage.");
			applyAlteredState([target],as); 
		}
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var slimedIntensity = 1 + (getCharsSlimedIntensity(target) * 0.1);
		var lustDamage = ((gCstat(actor,"physique") * 1 + gCstat(actor,"agility") * 2 + gCstat(actor,"resilience") * 2 + gCstat(actor,"will") * 2 + gCstat(actor,"perception") * 1 + gCstat(actor,"luck") * 1) / 30);
		var lustDamage2 = lustDamage * (0.3 + limitedRandomInt(20) * 0.01);
		lustDamage *= slimedIntensity * multAr[0];
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		lustDamage2 *= multAr2[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		gC(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		
		advanceTfGoalsPoints(this.tfGoals);
		
		if ( State.variables.sc.genderChange == "feminine" ) {
			results.description += randomFromList( [
				(ktn(actorKey) + " kneaded " + ktn(target) + "'s chest, slowly giving form to two new mounds."),
				(ktn(actorKey) + " is forming " + boobsWord() + " over " + ktn(target) + "'s chest."),
				(ktn(actorKey) + " massages and kneads " + ktn(target) + "'s body, turning " + gC(target).posPr + " chest into " + boobsWord() + ".") ] );
		} else if ( State.variables.sc.genderChange == "masculine" ) {
			results.description += randomFromList( [
				(ktn(target) + "'s " + boobsWord() + " are slowly returned to " + gC(target).posPr + " chest, " + ktn(actorKey) + " flattening " + gC(target).posPr + "."),
				(ktn(actorKey) + " massages " + ktn(target) + "'s chest, calmly but surely pushing it back and giving it a more masculine form."),
				(ktn(actorKey) + "'s hands run all over " + ktn(target) + ", giving " + gC(target).comPr + " a more compact front.") ] );
		} else if ( gC(target).perPr == "she" ) {
			results.description += randomFromList( [
				(ktn(actorKey) + " massages " + ktn(target) + "'s " + boobsWord() + ", kneading them into a different form."),
				(ktn(target) + " feels " + gC(target).posPr + " " + boobsWord() + " being played with, shrunk and enlarged, as " + ktn(actorKey) + " playfully creates a new shape.") ] );	
		} else {
			results.description += randomFromList( [
				(ktn(actorKey) + " bathes " + gC(actorKey).posPr + " hands in " + ktn(target) + "'s chest, giving a new form."),
				(ktn(target) + " feels " + ktn(actorKey) + "'s hands push, pull and play with " + gC(target).posPr + " torso.") ] );	
		}
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1] + " " + ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
							   
		return results;
	}
	return sa;
}
window.createSaSculptBody = function() {
	var sa = new sceneAction();
	sa.name = "Sculpt Body";
	sa.key = "sculptBody";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.actorBpReqs.push("arms");
	sa.tags.push("tf");
	sa.tfGoals = ["rebuildFigure"];
	sa.strategyTags.push("tfPlus");
	
	sa.unvalidRelationalPositions.push(["standing","kneeling"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["mountedFromBehind","mountingFromBehind"],["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("foreplay","useHands");
	
	sa.description = "The character will remould the target's body, changing its form, lines and constitution.\n\n"
				   + "Single targe action.\nActor requires free hands.\n\nForeplay.\n\n__Influences__:\n"
				   + "Damage: Actor's physique x2, agility x3, resilience x2, will x2, perception x1, luck x1, target's slimed intensity.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		var actor = actorKey;
		
		var multAr = getSexDamageMult(actorKey,target,this.key);
		var slimedIntensity = 1 + (getCharsSlimedIntensity(target) * 0.1);
		var lustDamage = ((gCstat(actor,"physique") * 2 + gCstat(actor,"agility") * 3 + gCstat(actor,"resilience") * 2 + gCstat(actor,"will") * 2 + gCstat(actor,"perception") * 1 + gCstat(actor,"luck") * 1) / 30);
		var lustDamage2 = lustDamage * (0.3 + limitedRandomInt(20) * 0.01);
		lustDamage *= slimedIntensity * multAr[0];
		var multAr2 = getSexDamageMult(actorKey,actorKey,this.key);
		lustDamage2 *= multAr2[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		gC(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		
		advanceTfGoalsPoints(this.tfGoals);
		
		if ( State.variables.sc.genderChange == "feminine" ) {
			results.description += randomFromList( [
				(ktn(actorKey) + " hugs " + ktn(target) + "'s waist, tightening and squeezing it until revealing the form of an hourglass."),
				(ktn(actorKey) + " fondles " + ktn(target) + "'s hips up and down, stretching their limits until they become savory to the palate of " + gC(actorKey).posPr + " palms."),
				(ktn(actorKey) + " throughly rubs " + gC(actorKey).posPr + " body up and down against the flesh of " + ktn(target) + ", " + gC(target).posPr + " curves moving along with the embrace."),
				(ktn(target) + "'s skin feels soft and flexible, adjusting itself to the movements of " + ktn(actorKey) + "'s hands like silk accepts the form granted by its weaver.")				] );
		} else if ( State.variables.sc.genderChange == "masculine" ) {
			results.description += randomFromList( [
				(ktn(target) + "'s skin feels soft and flexible, adjusting itself to the movements of " + ktn(actorKey) + "'s hands like silk accepts the form granted by its weaver."),
				(ktn(actorKey) + " expands " + ktn(target) + "'s shoulders until they appear ample and robust."),
				(ktn(actorKey) + " softens the lines in " + ktn(target) + "'s waist.") ] );
		} else {
			results.description += randomFromList( [
				(ktn(target) + "'s skin feels soft and flexible, adjusting itself to the movements of " + ktn(actorKey) + "'s hands like silk accepts the form granted by its weaver."),
				(ktn(actorKey) + " plays with " + ktn(target) + "'s body, enlarging and relaxing tendons and muscles as " + gC(actorKey).perPr + " sees fit."),
				(ktn(actorKey) + " works " + ktn(target) + "'s body, highlighting some features and concealing others."),
				(ktn(actorKey) + " pulls and twists the strings of aether that keep " + ktn(target) + "'s body together, turning it into something new.") ] );	
		}
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1] + " " + ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
							   
		return results;
	}
	return sa;
}

window.createSaFormDick = function() {
	var sa = new sceneAction();
	sa.name = "Form Dick";
	sa.key = "formDick";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.tags.push("tf");
	sa.tfGoals = ["addDick"];
	sa.strategyTags.push("tfPlus");
	
	sa.unvalidRelationalPositions.push(["standing","kneeling"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["mountedFromBehind","mountingFromBehind"],["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("foreplay","targetDick");
	
	sa.description = "The character will manipulate their target's aether to form a dick in their groin.\n\n"
				   + "Single target action.\n\nForeplay.\n\n__Influences__:\n"
				   + "Damage: Actor's agility x3, intelligence x3, will x2, perception x2, luck x1, target's slimed intensity.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		var actor = actorKey;
		
		var flavorTags = this.flavorTags;
		
		if ( doesCharHaveAlteredState(target,"Dic+") == false ) {
			// Sensitized dick
			var intensity = 0.05 + gCstat(actorKey,"agility") * 0.005 + limitedRandomInt(5) * 0.01;
			var turns = 4 + limitedRandomInt(4) + (gCstat(actorKey,"agility") * 0.04) - ((gCstat(actorKey,"agility") * 0.04) % 1);
			var as = createSensitizedTag(intensity,"useDick","Sensitized dick","Dic+",turns,"The dick of this character will receive extra damage.");
			applyAlteredState([target],as);
		}
		
		var descriptionsString = [ (ktn(actorKey) + " rides " + ktn(target) + "'s groin, pulling strings of aether on " + gC(actorKey).posPr + " way up."),
						(ktn(actorKey) + "'s hips move back and forth, forming a cylindrical shape between them with " + ktn(target) + "'s essence."),
						(ktn(target) + " feels " + gC(target).posPr + " groin between pulled as " + ktn(actorKey) + " forms a new member between " + gC(target).posPr + " legs.") ];
		if ( gC(actorKey).body.hasOwnProperty("pussy") ) {
			if ( gC(actorKey).body.pussy.state != "locked" ) {
				flavorTags.push("usePussy");
				descriptionsString.push( (ktn(actorKey) + "'s movements are giving form to a new " + dickWord() + " between " + ktn(target) + "'s legs, which constantly caresses " + gC(actorKey).posPr + " own " + pussyWord() + ".") );
			}
		}
		results.description += randomFromList(descriptionsString);
		
		var multAr = getSexDamageMultAlt(actorKey,target,flavorTags);
		var slimedIntensity = 1 + (getCharsSlimedIntensity(target) * 0.1);
		var lustDamage = ((gCstat(actor,"agility") * 3 + gCstat(actor,"intelligence") * 3 + gCstat(actor,"will") * 2 + gCstat(actor,"perception") * 2 + gCstat(actor,"luck") * 1) / 30);
		var lustDamage2 = lustDamage * (0.3 + limitedRandomInt(20) * 0.01);
		lustDamage *= slimedIntensity * multAr[0];
		var multAr2 = getSexDamageMultAlt(actorKey,actorKey,flavorTags);
		lustDamage2 *= multAr2[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		gC(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		
		advanceTfGoalsPoints(this.tfGoals);
		
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1] + " " + ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
							   
		return results;
	}
	return sa;
}
window.createSaFormPussy = function() {
	var sa = new sceneAction();
	sa.name = "Form Pussy";
	sa.key = "formPussy";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.tags.push("tf");
	sa.tfGoals = ["addPussy"];
	sa.strategyTags.push("tfPlus");
	
	sa.unvalidRelationalPositions.push(["standing","kneeling"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["mountedFromBehind","mountingFromBehind"],["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("foreplay","targetPussy");
	
	sa.description = "The character will manipulate their target's aether to form a pussy in their groin.\n\n"
				   + "Single target action.\n\nForeplay.\n\n__Influences__:\n"
				   + "Damage: Actor's agility x3, intelligence x3, will x2, perception x2, luck x1, target's slimed intensity.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		var actor = actorKey;
		
		var flavorTags = this.flavorTags;
		
		if ( doesCharHaveAlteredState(target,"Pus+") == false ) {
			// Sensitized pussy
			var intensity = 0.05 + gCstat(actorKey,"agility") * 0.005 + limitedRandomInt(5) * 0.01;
			var turns = 4 + limitedRandomInt(4) + (gCstat(actorKey,"agility") * 0.04) - ((gCstat(actorKey,"agility") * 0.04) % 1);
			var as = createSensitizedTag(intensity,"usePussy","Sensitized pussy","Pus+",turns,"The pussy of this character will receive extra damage.");
			applyAlteredState([target],as);
		}
		
		var descriptionsString = [ (ktn(actorKey) + " pushes against " + ktn(target) + "'s groin, drilling new folds."),
						(ktn(target) + " feels " + gC(target).posPr + " groin unfolding apart as " + ktn(actorKey) + " gives form to " + ktn(target) + "'s new " + pussyWord() + "."),
						(ktn(actorKey) + " makes room between " + ktn(target) + "'s legs for new genitalia.") ];
		if ( gC(actorKey).body.hasOwnProperty("dick") ) {
			if ( gC(actorKey).body.dick.state != "locked" ) {
				flavorTags.push("useDick");
				descriptionsString.push( (ktn(actorKey) + "'s " + dickWord() + " penetrates between " + ktn(target) + "'s legs, giving form to " + ktn(target) + "'s new " + pussyWord() + ".") );
			}
		}
		results.description += randomFromList(descriptionsString);
		
		var multAr = getSexDamageMultAlt(actorKey,target,flavorTags);
		var slimedIntensity = 1 + (getCharsSlimedIntensity(target) * 0.1);
		var lustDamage = ((gCstat(actor,"agility") * 3 + gCstat(actor,"intelligence") * 3 + gCstat(actor,"will") * 2 + gCstat(actor,"perception") * 2 + gCstat(actor,"luck") * 1) / 30);
		var lustDamage2 = lustDamage * (0.3 + limitedRandomInt(20) * 0.01);
		lustDamage *= slimedIntensity * multAr[0];
		var multAr2 = getSexDamageMultAlt(actorKey,actorKey,flavorTags);
		lustDamage2 *= multAr2[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		gC(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		
		advanceTfGoalsPoints(this.tfGoals);
		
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1] + " " + ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
							   
		return results;
	}
	return sa;
}
window.createSaBuryDick = function() {
	var sa = new sceneAction();
	sa.name = "Bury Dick";
	sa.key = "buryDick";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.targetBpReqs.push("dick");
	sa.tags.push("tf");
	sa.tfGoals = ["removeDick"];
	sa.strategyTags.push("tfPlus");
	
	sa.unvalidRelationalPositions.push(["standing","kneeling"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["mountedFromBehind","mountingFromBehind"],["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("foreplay","targetDick");
	
	sa.description = "The character will merge their target's dick with their abdomen and groin.\n\n"
				   + "Single target action.\nTarget requires free dick.\n\nForeplay.\n\n__Influences__:\n"
				   + "Damage: Actor's physique x1, agility x2, resilience x1, intelligence x1, will x2, perception x1, luck x1, target's slimed intensity.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		var actor = actorKey;
		
		var flavorTags = this.flavorTags;
		
		var extraMult = 1;
		var descriptionsString = [ (ktn(actorKey) + " rubs " + gC(actorKey).posPr + " groin against " + ktn(target) + "'s " + dickWord() + ", pushing " + 
						"it inside " + gC(target).comPr + "."),
						(ktn(target) + "'s " + dickWord() + " feels the pressure of " + ktn(actorKey) + "'s body, slowly but surely burying it inside " + ktn(target) + "'s own abdomen."),
						(ktn(target) + " feels " + gC(target).posPr + " own " + dickWord() + " being pushed back by " + ktn(actorKey) + "'s abdomen, gradually submerging into " + gC(target).posPr + " own skin.") ];
		if ( gC(actorKey).body.hasOwnProperty("pussy") ) {
			if ( gC(actorKey).body.pussy.state != "locked" ) {
				flavorTags.push("usePussy");
				extraMult += 0.1;
				descriptionsString.push( (ktn(target) + "'s " + dickWord() + " feels " + ktn(actorKey) + "'s " + pussyWord() + " kiss it goodbye as it merges within " + ktn(target) + "'s body.") );
			}
		}
		if ( gC(actorKey).body.hasOwnProperty("dick") ) {
			if ( gC(actorKey).body.dick.state != "locked" ) {
				flavorTags.push("useDick");
				extraMult += 0.1;
				descriptionsString.push( (ktn(target) + "'s " + dickWord() + " feels the friction with " + ktn(actorKey) + "'s own " + dickWord() + ", as the latter pushes the former into " + ktn(target) + "'s own body.") );
			}
		}
		results.description += randomFromList(descriptionsString);
		
		var multAr = getSexDamageMultAlt(actorKey,target,flavorTags);
		var slimedIntensity = 1 + (getCharsSlimedIntensity(target) * 0.1);
		var lustDamage = ((gCstat(actor,"physique") * 1 + gCstat(actor,"agility") * 2 + gCstat(actor,"resilience") * 1 + gCstat(actor,"intelligence") * 1 + gCstat(actor,"will") * 2 + gCstat(actor,"perception") * 1 + gCstat(actor,"luck") * 1) / 33) * extraMult;
		var lustDamage2 = lustDamage * (0.3 + limitedRandomInt(20) * 0.01);
		lustDamage *= slimedIntensity * multAr[0];
		var multAr2 = getSexDamageMultAlt(actorKey,actorKey,flavorTags);
		lustDamage2 *= multAr2[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		gC(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		
		advanceTfGoalsPoints(this.tfGoals);
		
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1] + " " + ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
							   
		return results;
	}
	return sa;
}
window.createSaFoldPussy = function() {
	var sa = new sceneAction();
	sa.name = "Fold Pussy";
	sa.key = "foldPussy";
	sa.targetType = "single";
	sa.tags.push("ss");
	sa.tags.push("sUse");
	sa.targetBpReqs.push("pussy");
	sa.tags.push("tf");
	sa.tfGoals = ["removePussy"];
	sa.strategyTags.push("tfPlus");
	
	sa.unvalidRelationalPositions.push(["standing","kneeling"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	sa.unvalidRelationalPositions.push(["mountedFromBehind","mountingFromBehind"],["mountedFromBehind","mountingAndMounted"]);
	
	sa.flavorTags.push("foreplay","targetPussy");
	
	sa.description = "The character will manipulate their target's aether to fold their pussy away.\n\n"
				   + "Single target action.\nTarget requires free pussy.\n\nForeplay.\n\n__Influences__:\n"
				   + "Damage: Actor's physique x1, agility x2, resilience x1, intelligence x1, will x2, perception x1, luck x1, target's slimed intensity.";
				   
	sa.execute = function(actorKey,targetActors) {
		var results = new saResults;
		var target = targetActors[0];
		var actor = actorKey;
		
		var flavorTags = this.flavorTags;
		
		var extraMult = 1;
		var descriptionsString = [ (ktn(actorKey) + " manipulates the aether around " + ktn(target) + "'s " + pussyWord() + ", carefully folding it closed."),
						(ktn(actorKey) + " rubs against " + ktn(target) + "'s " + pussyWord() + ", melding its lips into one."),
						(ktn(target) + " feels " + gC(target).posPr + " " + pussyWord() + " being slowly shut by " + ktn(actorKey) + "'s magical manipulation.") ];
		results.description += randomFromList(descriptionsString);
		
		var multAr = getSexDamageMultAlt(actorKey,target,flavorTags);
		var slimedIntensity = 1 + (getCharsSlimedIntensity(target) * 0.1);
		var lustDamage = ((gCstat(actor,"physique") * 1 + gCstat(actor,"agility") * 2 + gCstat(actor,"resilience") * 1 + gCstat(actor,"intelligence") * 1 + gCstat(actor,"will") * 2 + gCstat(actor,"perception") * 1 + gCstat(actor,"luck") * 1) / 30) * extraMult;
		var lustDamage2 = lustDamage * (0.3 + limitedRandomInt(20) * 0.01);
		lustDamage *= slimedIntensity * multAr[0];
		var multAr2 = getSexDamageMultAlt(actorKey,actorKey,flavorTags);
		lustDamage2 *= multAr2[0];
		getChar(targetActors[0]).lust.changeValue(-lustDamage);
		gC(actorKey).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		
		advanceTfGoalsPoints(this.tfGoals);
		
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1] + " " + ktn(actorKey) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
							   
		return results;
	}
	return sa;
}





////////// SCENE CONTINUED ACTION CLASS //////////

/* How these work

Continued actions are lingering effects called by common actions.
They take place after common actions, and they add their descriptions to actions descriptions.
They have an initiator, a list of targets, and each of them has a list of involved bodyparts.
Bodyparts' states become "inUse" when continued actions are started, and "free" when they're finished.

*/

// POSITION ACTIONS //

/* How these work

Position actions are continued actions that have the purpose of setting a position between different characters.
A position action may also initiate a continued action effect.

*/

window.continuedAction = function() {
	this.name = "";
	this.key = "";
	this.initiator = ""; // Initiator character key
	this.targetsList = []; // Targetted characters' keys
	this.initiatorBodyparts = []; // Involved bodyparts for the initiator
	this.targetsBodyparts = [] ; // Involved bodyparts for the targets
	
	this.tags = [];
	this.validRelationalPositions = [] ; // List of sets of two positions.
										 // If length > 0 , initiator must have the first position on any set, and targets the second positions
	this.unvalidRelationalPositions = [] ; // Opposite of validRelationalPositions
	
	this.associatedActions = []; // Characters will learn these actions when continued actions involving them start, and forget them when the CAs finish
	
	// this.flagUsingWeapon = false; // If this attribute exists, the initiator's weapon will be set to unused when this continued action is finished
	
	this.rank = 1;
	this.continuedTurns = 0;
	
	this.execute = null;
	
	this.occupyBodyparts = function() {
		for ( var bp in this.initiatorBodyparts ) {
			getChar(this.initiator).body[this.initiatorBodyparts[bp]].state = "inUse";
		}
		for ( var bp in this.targetsBodyparts ) {
			for ( var tg in this.targetsList ) {
				getChar(this.targetsList[tg]).body[this.targetsBodyparts[bp]].state = "inUse";
			}
		}
	}
	this.freeBodyparts = function() {
		for ( var bp in this.initiatorBodyparts ) {
			getChar(this.initiator).body[this.initiatorBodyparts[bp]].state = "free";
		}
		for ( var bp in this.targetsBodyparts ) {
			for ( var tg in this.targetsList ) {
				getChar(this.targetsList[tg]).body[this.targetsBodyparts[bp]].state = "free";
			}
		}
	}
	this.learnAssociatedActions = function() {
		if ( this.associatedActions.length > 0 ) {
			var chars = this.targetsList.concat([this.initiator]);
			charactersLearnSceneActions(chars,this.associatedActions);
		}
	}
	this.forgetAssociatedActions = function() {
		if ( this.associatedActions.length > 0 ) {
			var chars = this.targetsList.concat([this.initiator]);
			charactersForgetSceneActions(chars,this.associatedActions);
		}
	}
}

window.createCaFrenchKiss = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.name = "French Kissing";
	ca.key = "frenchKissing";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "mouth" ];
	ca.targetsBodyparts = [ "mouth" ];
	ca.occupyBodyparts();
	ca.flavorTags = ["oral","useMouth","targetMouth","romantic","continuedAction"];
	
	ca.unvalidRelationalPositions.push(["standing","kneeling"],["kneeling","standing"]);
	
	ca.learnAssociatedActions();
	
	ca.execute = function() {
		var results = new saResults;
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var multAr2 = getSexDamageMultAlt(this.initiator,this.initiator,this.flavorTags);
		var lustDamage = ((getChar(this.initiator).agility.getValue() + getChar(this.initiator).perception.getValue() + getChar(this.initiator).empathy.getValue()) / 15);
		var lustDamage2 = lustDamage * 0.5 * multAr2[0];
		lustDamage *= multAr[0];
		getChar(this.initiator).lust.changeValue((-lustDamage/2));
		getChar(this.targetsList[0]).lust.changeValue((-lustDamage));
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(initiator) + "'s tongue intertwines with " + ktn(targetsList[0]) + "'s."),
								(ktn(initiator) + " explores " + ktn(targetsList[0]) + "'s mouth with " + gC(initiator).posPr + " tongue."),
								(ktn(initiator) + " and " + ktn(targetsList[0]) + " share their feelings through their lips and tongues.") ] );
		results.description += " " + ktn(targetsList[0]) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(initiator) + " received " + textLustDamage(lustDamage/2) + ". " + multAr2[1];
							   
		return results;
	}
	return ca;
}
window.createCaLegHoldHead = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.name = "Leg-holding Head";
	ca.key = "legHoldingHead";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "legs","pussy" ];
	ca.targetsBodyparts = [ "mouth" ];
	ca.occupyBodyparts();
	ca.rank = 2;
	ca.flavorTags = ["oral","useLegs","targetMouth","domination","position","continuedAction"];
	
	ca.validRelationalPositions.push(["standing","kneeling"],["spitroastFront","spitroastTarget"]);
	
	ca.execute = function() {
		var results = new saResults;
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		// Targets' agility
		var agiDamage = 0;
		for ( var t of this.targetsList ) {
			agiDamage += gCstat(t,"agility") * 3;
		}
		agiDamage *= ( (1 + this.targetsList.length) * 0.5 ) / this.targetsList.length;
		var lustDamage = ((agiDamage + getChar(this.initiator).resilience.getValue() * 2 + getChar(this.initiator).physique.getValue()) / 20) * multAr[0];
		getChar(initiator).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		if ( this.targetsList.length == 1 ) {
			var target = this.targetsList[0];
			results.description += randomFromList( [
								(ktn(this.initiator) + " is holding " + ktn(target) + " tight between " + gC(this.initiator).posPr
								+ " legs, forcing " + gC(target).comPr + " to lick."),
								(ktn(this.initiator) + " has trapped " + ktn(target) + "'s head between " + gC(this.initiator).posPr
								+ " legs, and " + ktn(target) + " is licking. ") ] );
		} else {
			results.description += randomFromList( [
								(getCharNames(this.targetsList) + " struggle to breathe as they both lick " + ktn(this.initiator) + "'s " + pussyWord() + "."),
								(ktn(this.initiator) + " enjoys " + gC(this.initiator).refPr + " as both " + getCharNames(this.targetsList) + " " + randomFromList(["devour","pleasure","lick"]) + " " + gC(this.initiator).posPr + " " + pussyWord() + "."),
								(getCharNames(this.targetsList) + " take turns to " + randomFromList(["massage","worship","pleasure"]) + " " + ktn(this.initiator) + "'s " + pussyWord() + " with their tongues.") ] );
		}
		results.description += " " + ktn(this.initiator) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		for ( var target of this.targetsList ) {
			// Submissive loss of willpower
			if ( gC(target).hasLead == false && gC(target).position.key == "kneeling" ) {
				var exWillpowerDamage = (gC(this.initiator).charisma.getValue() / Math.max(gC(target).will.getValue(),1)) * (2 - (gC(target).willpower.current / gC(target).willpower.max));
				//var exWillpowerDamage = ((gC(this.initiator).will.getValue() * 0.5 + gC(this.initiator).charisma.getValue() * 1) / Math.max(gC(target).will.getValue() * 1,1));
				gC(target).willpower.changeValue(-exWillpowerDamage);
				results.description += ktn(target) + "'s submissive position made " + gC(target).comPr + " receive " + textWillpowerDamage(exWillpowerDamage) + ". ";
			}
			
			// Submissive extra lust
			if ( gC(target).hasLead == false && gC(target).willpower.current < (gC(target).willpower.max * 0.8) ) {
				var exLustDamage = (gC(this.initiator).charisma.getValue() / Math.max(gC(target).will.getValue(),1)) * (2 - (gC(target).willpower.current / gC(target).willpower.max));
				//var exLustDamage = (gC(this.initiator).charisma.getValue() / Math.max((gC(target).will.getValue()) * (1 - (gC(target).willpower.current / gC(target).willpower.max)) * 2,0.1));
				gC(target).lust.changeValue(-exLustDamage);
				results.description += ktn(target) + "'s lack of control aroused " + gC(target).comPr + " and made " + gC(target).comPr + " receive " + textLustDamage(exLustDamage) + ". ";
			}
		}
		
		return results;
	}
	return ca;
}

window.createCaPenetratePussy = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.key = "penetratePussy";
	ca.name = "Penetrating pussy";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "dick" ];
	ca.targetsBodyparts = [ "pussy" ];
	ca.occupyBodyparts();
	ca.rank = 2;
	ca.flavorTags = ["fullsex","useDick","targetPussy","top","continuedAction"];
	
	ca.validRelationalPositions.push(["mountingFromBehind","mountedFromBehind"],["mountingFaceToFace","mountedFaceToFace"],
									 ["spitroastBehind","spitroastTarget"],["mountingFromBehind","mountingAndMounted"],
									 ["mountingAndMounted","mountedFaceToFace"],["mountingAndMounted","mountedFaceToFace"]);
	
	ca.execute = function() {
		var results = new saResults;
		var target = targetsList[0];
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var multAr2 = getSexDamageMultAlt(this.initiator,this.initiator,this.flavorTags);
		var lustDamage = ((getChar(this.initiator).physique.getValue() * 1 + getChar(this.initiator).resilience.getValue() * 1) / 8) * multAr[0];
		getChar(this.targetsList[0]).lust.changeValue(-lustDamage);
		var lustDamage2 = ((getChar(this.targetsList[0]).physique.getValue() * 1 + getChar(this.targetsList[0]).resilience.getValue() * 1) / 16) * multAr2[0];
		getChar(this.initiator).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(initiator) + "'s " + dickWord() + " remains connected to " + ktn(target) + "'s insides."),
								(ktn(initiator) + " keeps penetrating " + ktn(target) + "'s " + pussyWord() + "."),
								(ktn(initiator) + " is fucking " + ktn(target) + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(initiator) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		// Submissive loss of willpower
		if ( gC(target).hasLead == false && gC(target).position.key == "mountedFromBehind" ) {
			var exWillpowerDamage = (gC(this.initiator).will.getValue() / Math.max(gC(target).will.getValue(),1)) * (2 - (gC(target).willpower.current / gC(target).willpower.max));
			//var exWillpowerDamage = (gC(this.initiator).will.getValue() / Math.max(gC(target).will.getValue(),1)) * 1;
			gC(target).willpower.changeValue(-exWillpowerDamage);
			results.description += ktn(target) + "'s submissive position made " + gC(target).comPr + " receive " + textWillpowerDamage(exWillpowerDamage) + ".";
		}
		
		return results;
	}	
	return ca;
}
window.createCaPenetrateAss = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.key = "penetrateAss";
	ca.name = "Penetrating ass";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "dick" ];
	ca.targetsBodyparts = [ "anus" ];
	ca.occupyBodyparts();
	ca.rank = 2;
	ca.flavorTags = ["fullsex","useDick","targetAnus","top","continuedAction"];
	
	ca.validRelationalPositions.push(["mountingFromBehind","mountedFromBehind"],["mountingFaceToFace","mountedFaceToFace"],
									 ["spitroastBehind","spitroastTarget"],["mountingFromBehind","mountingAndMounted"],
									 ["mountingAndMounted","mountedFaceToFace"],["mountingAndMounted","mountedFaceToFace"]);
	
	ca.execute = function() {
		var results = new saResults;
		var target = targetsList[0];
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var multAr2 = getSexDamageMultAlt(this.initiator,this.initiator,this.flavorTags);
		var lustDamage = ((getChar(this.initiator).physique.getValue() * 1 + getChar(this.initiator).resilience.getValue() * 1) / 12) * multAr[0];
		getChar(this.targetsList[0]).lust.changeValue(-lustDamage);
		var lustDamage2 = ((getChar(this.targetsList[0]).agility.getValue() * 1 + getChar(this.targetsList[0]).resilience.getValue() * 1) / 20) * multAr2[0];
		getChar(this.initiator).lust.changeValue(-lustDamage2);
		var energyDamage = ((getChar(this.initiator).physique.getValue() * 1 + getChar(this.initiator).resilience.getValue() * 1) / 45);
		getChar(this.targetsList[0]).energy.changeValue(-energyDamage);
		
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(initiator) + "'s " + dickWord() + " remains connected to " + ktn(target) + "'s insides."),
								(ktn(initiator) + " keeps penetrating " + ktn(target) + "'s " + assWord() + "."),
								(ktn(target) + "'s rear remains filled by " + ktn(initiator) + "'s " + dickWord() + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + " and " + textEnergyDamage(energyDamage) + ". " + multAr[1];
		results.description += ktn(initiator) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		// Submissive loss of willpower
		if ( gC(target).hasLead == false && gC(target).position.key == "mountedFromBehind" ) {
			var exWillpowerDamage = (gC(this.initiator).will.getValue() / Math.max(gC(target).will.getValue(),1)) * (2 - (gC(target).willpower.current / gC(target).willpower.max));
			//var exWillpowerDamage = (gC(this.initiator).will.getValue() / Math.max(gC(target).will.getValue(),1)) * 1;
			gC(target).willpower.changeValue(-exWillpowerDamage);
			results.description += " " + ktn(target) + "'s submissive position made " + gC(target).comPr + " receive " + textWillpowerDamage(exWillpowerDamage) + ".";
		}
		
		return results;
	}	
	
	return ca;
}
window.createCaInterlockLegs = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.key = "interlockLegs";
	ca.name = "Interlocking legs";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "pussy" ];
	ca.targetsBodyparts = [ "pussy" ];
	ca.occupyBodyparts();
	ca.rank = 2;
	ca.flavorTags = ["fullsex","usePussy","targetPussy","top","continuedAction"];
	
	ca.validRelationalPositions.push(["mountingFaceToFace","mountedFaceToFace"],["mountingFromBehind","mountedFromBehind"],["spitroastBehind","spitroastTarget"],["mountingFromBehind","mountingAndMounted"],
									 ["mountingAndMounted","mountedFaceToFace"],["mountingAndMounted","mountedFaceToFace"]);
	
	ca.execute = function() {
		var results = new saResults;
		var target = targetsList[0];
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var multAr2 = getSexDamageMultAlt(this.initiator,this.initiator,this.flavorTags);
		var lustDamage = ((getChar(this.initiator).physique.getValue() * 1 + getChar(this.initiator).resilience.getValue() * 1) / 8) * multAr[0];
		getChar(this.targetsList[0]).lust.changeValue(-lustDamage);
		var lustDamage2 = ((getChar(this.targetsList[0]).physique.getValue() * 1 + getChar(this.targetsList[0]).resilience.getValue() * 1) / 16) * multAr2[0];
		getChar(this.initiator).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(initiator) + " and " + ktn(target) + " are frotting their pussies against each other."),
								(ktn(initiator) + " keeps rubbing herself against " + ktn(target) + "."),
								(ktn(initiator) + " is scissoring " + ktn(target) + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(initiator) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}	
	return ca;
}
window.createCaMountDick = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.key = "mountDick";
	ca.name = "Mounting dick";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "pussy" ];
	ca.targetsBodyparts = [ "dick" ];
	ca.occupyBodyparts();
	ca.rank = 2;
	ca.flavorTags = [ "fullsex","usePussy","targetDick","top","continuedAction"];
	
	ca.validRelationalPositions.push(["mountingFaceToFace","mountedFaceToFace"],["mountingAndMounted","mountedFaceToFace"]);
	
	ca.execute = function() {
		var results = new saResults;
		var target = targetsList[0];
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var multAr2 = getSexDamageMultAlt(this.initiator,this.initiator,this.flavorTags);
		var lustDamage = ((getChar(this.initiator).physique.getValue() * 1 + getChar(this.initiator).resilience.getValue() * 1) / 8) * multAr[0];
		getChar(this.targetsList[0]).lust.changeValue(-lustDamage);
		var lustDamage2 = ((getChar(this.targetsList[0]).physique.getValue() * 1 + getChar(this.targetsList[0]).resilience.getValue() * 1) / 16) * multAr2[0];
		getChar(this.initiator).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(target) + "'s " + dickWord() + " remains connected to " + ktn(initiator) + "'s insides."),
								(ktn(initiator) + " keeps riding " + ktn(target) + "'s " + dickWord() + "."),
								(ktn(initiator) + " is fucking " + ktn(target) + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(initiator) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}	
	return ca;
}
window.createCaAnalMountDick = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.key = "analMountDick";
	ca.name = "Anally mounting dick";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "anus" ];
	ca.targetsBodyparts = [ "dick" ];
	ca.occupyBodyparts();
	ca.rank = 2;
	ca.flavorTags = [ "fullsex","useAnus","targetDick","top","continuedAction"];
	
	ca.validRelationalPositions.push(["mountingFaceToFace","mountedFaceToFace"],["mountingAndMounted","mountedFaceToFace"]);
	
	ca.execute = function() {
		var results = new saResults;
		var target = targetsList[0];
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var multAr2 = getSexDamageMultAlt(this.initiator,this.initiator,this.flavorTags);
		var lustDamage = ((getChar(this.initiator).physique.getValue() * 1 + getChar(this.initiator).resilience.getValue() * 1) * 0.7 / 8) * multAr[0];
		var energyDamage = ((getChar(this.initiator).physique.getValue() * 1 + getChar(this.initiator).resilience.getValue() * 1) * 0.3 / 8) * multAr[0];
		getChar(this.targetsList[0]).lust.changeValue(-lustDamage);
		getChar(this.targetsList[0]).energy.changeValue(-energyDamage);
		var lustDamage2 = ((getChar(this.targetsList[0]).physique.getValue() * 1 + getChar(this.targetsList[0]).resilience.getValue() * 1) / 16) * multAr2[0];
		getChar(this.initiator).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(target) + "'s " + dickWord() + " keeps getting milked by " + ktn(initiator) + "'s " + assWord() + "."),
								(ktn(initiator) + "'s " + assWord() + " maintains its grip on " + ktn(target) + "'s " + dickWord() + "."),
								(ktn(initiator) + " is fucking " + ktn(target) + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + " and " + textEnergyDamage(energyDamage) + ". " + multAr[1];
		results.description += ktn(initiator) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}	
	return ca;
}

window.createCaDoublePenetration = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.key = "doublePenetration";
	ca.name = "Double Penetration";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "dick" ];
	ca.targetsBodyparts = [ "pussy" , "anus" ];
	ca.occupyBodyparts();
	ca.rank = 2;
	ca.flavorTags = ["fullsex","useDick","targetPussy","targetAnus","top","continuedAction"]
	
	ca.validRelationalPositions.push(["mountingFromBehind","mountedFromBehind"],["mountingFaceToFace","mountedFaceToFace"],
									 ["spitroastBehind","spitroastTarget"],["mountingFromBehind","mountingAndMounted"],
									 ["mountingAndMounted","mountedFaceToFace"],["mountingAndMounted","mountedFaceToFace"]);
	
	ca.execute = function() {
		var results = new saResults;
		var target = targetsList[0];
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var multAr2 = getSexDamageMultAlt(this.initiator,this.initiator,this.flavorTags);
		var lustDamage = ((getChar(this.initiator).physique.getValue() * 1 + getChar(this.initiator).resilience.getValue() * 1) / 5) * multAr[0];
		getChar(this.targetsList[0]).lust.changeValue(-lustDamage);
		var lustDamage2 = ((getChar(this.targetsList[0]).agility.getValue() * 1 + getChar(this.targetsList[0]).resilience.getValue() * 1) / 10) * multAr2[0];
		getChar(this.initiator).lust.changeValue(-lustDamage2);
		var energyDamage = ((getChar(this.initiator).physique.getValue() * 1 + getChar(this.initiator).resilience.getValue() * 1) / 45) * multAr[0];
		getChar(this.targetsList[0]).energy.changeValue(-energyDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(initiator) + "'s " + dickWord() + "s remain connected to " + ktn(target) + "'s insides."),
								(ktn(initiator) + " keeps penetrating " + ktn(target) + "'s " + pussyWord() + " and " + assWord() + "."),
								(ktn(initiator) + " is double fucking " + ktn(target) + ".") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + " and " + textEnergyDamage(energyDamage) + ". " + multAr[1];
		results.description += ktn(initiator) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		// Submissive loss of willpower
		if ( gC(target).hasLead == false && gC(target).position.key == "mountedFromBehind" ) {
			var exWillpowerDamage = (gC(this.initiator).will.getValue() / Math.max(gC(target).will.getValue(),1)) * (2 - (gC(target).willpower.current / gC(target).willpower.max));
			//var exWillpowerDamage = (gC(this.initiator).will.getValue() / Math.max(gC(target).will.getValue(),1)) * 1;
			gC(target).willpower.changeValue(-exWillpowerDamage);
			results.description += ktn(target) + "'s submissive position made " + gC(target).comPr + " receive " + textWillpowerDamage(exWillpowerDamage) + ".";
		}
		
		return results;
	}	
	return ca;
}

window.createCaGetBlowjob = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.key = "getBlowjob";
	ca.name = "Getting Blowjob";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "dick" ];
	ca.targetsBodyparts = [ "mouth" ];
	ca.occupyBodyparts();
	ca.rank = 2;
	ca.flavorTags = ["oral","useDick","targetMouth","top","domination","continuedAction"]
	
	ca.validRelationalPositions.push(["standing","kneeling"],["spitroastFront","spitroastTarget"]);
	
	ca.execute = function() {
		var results = new saResults;
		var target = this.targetsList[0];
		
		var multAr2 = getSexDamageMultAlt(this.initiator,this.initiator,this.flavorTags);
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var lustDamage2 = (gC(target).agility.getValue() / 5) * multAr2[0]; // Goes to initiator
		var lustDamage = (gC(this.initiator).resilience.getValue() / 10) * multAr[0]; // Goes to target
		gC(target).lust.changeValue(-lustDamage);
		gC(this.initiator).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(target) + " is sucking " + ktn(initiator) + "'s " + dickWord() + "."),
								(ktn(target) + " is fellating " + ktn(initiator) + "."),
								(ktn(initiator) + " is making " + ktn(target) + " suck " + gC(initiator).posPr + " " + dickWord() + ".") ] );
		results.description += " " + ktn(initiator) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		results.description += ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		// Submissive loss of willpower
		if ( gC(target).hasLead == false && gC(target).position.key == "kneeling" ) {
			var exWillpowerDamage = (gC(this.initiator).charisma.getValue() / Math.max(gC(target).will.getValue(),1)) * (2 - (gC(target).willpower.current / gC(target).willpower.max));
			//var exWillpowerDamage = ((gC(this.initiator).will.getValue() * 0.5 + gC(this.initiator).charisma.getValue() * 1) / gC(target).will.getValue()) * 1;
			gC(target).willpower.changeValue(-exWillpowerDamage);
			results.description += ktn(target) + "'s submissive position made " + gC(target).comPr + " receive " + textWillpowerDamage(exWillpowerDamage) + ". ";
		}
		
		// Submissive extra lust
		if ( gC(target).hasLead == false && gC(target).willpower.current < (gC(target).willpower.max * 0.8) ) {
			var exLustDamage = (gC(this.initiator).charisma.getValue() / Math.max(gC(target).will.getValue(),1)) * (2 - (gC(target).willpower.current / gC(target).willpower.max));
			//var exLustDamage = (gC(this.initiator).charisma.getValue() / gC(target).will.getValue()) * (1 - (gC(target).willpower.current / gC(target).willpower.max)) * 2;
			gC(target).lust.changeValue(-exLustDamage);
			results.description += ktn(target) + "'s lack of control aroused " + gC(target).comPr + " and made " + gC(target).comPr + " receive " + textLustDamage(exLustDamage) + ". ";
		}
		
		return results;
	}
	return ca;
}

	// Weapon
window.createCaDildoPenetratePussy = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.key = "dildoPenetratePussy";
	ca.name = "Dildo-Pussy penetration";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "arms" ];
	ca.targetsBodyparts = [ "pussy" ];
	ca.occupyBodyparts();
	ca.rank = 1;
	ca.flavorTags = ["targetPussy","top","continuedAction"];
	ca.flagUsingWeapon = true;
	
	ca.unvalidRelationalPositions.push(["standing","kneeling"]);
	ca.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"],["spitroastTarget","spitroastBehind"],["spitroastFront","spitroastTarget"]);
	ca.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	
	ca.execute = function() {
		var results = new saResults;
		var target = targetsList[0];
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var lustDamage = ((getChar(this.initiator).physique.getValue() * 1 + getChar(this.initiator).agility.getValue() * 1) / 16) * multAr[0];
		getChar(this.targetsList[0]).lust.changeValue(-lustDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(initiator) + "'s dildo continues pleasuring " + ktn(target) + "'s insides."),
								(ktn(initiator) + " keeps penetrating " + ktn(target) + "'s " + pussyWord() + " with " + gC(initiator).posPr + " dildo."),
								(ktn(initiator) + " is fucking " + ktn(target) + " with " + gC(initiator).posPr + " dildo.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		
		return results;
	}	
	return ca;
}
window.createCaDildoPenetrateAss = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.key = "dildoPenetrateAss";
	ca.name = "Dildo-Ass penetration";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "arms" ];
	ca.targetsBodyparts = [ "anus" ];
	ca.occupyBodyparts();
	ca.rank = 1;
	ca.flavorTags = ["targetAnus","top","continuedAction"];
	ca.flagUsingWeapon = true;
	
	ca.unvalidRelationalPositions.push(["standing","kneeling"]);
	ca.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"],["spitroastTarget","spitroastBehind"],["spitroastFront","spitroastTarget"]);
	ca.unvalidRelationalPositions.push(["spitroastFront","spitroastBehind"],["spitroastBehind","spitroastFront"]);
	
	ca.execute = function() {
		var results = new saResults;
		var target = targetsList[0];
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var lustDamage = ((getChar(this.initiator).physique.getValue() * 1 + getChar(this.initiator).agility.getValue() * 1) / 24) * multAr[0];
		var energyDamage = ((getChar(this.initiator).physique.getValue() * 1 + getChar(this.initiator).agility.getValue() * 1) / 32) * multAr[0];
		getChar(this.targetsList[0]).lust.changeValue(-lustDamage);
		getChar(this.targetsList[0]).energy.changeValue(-energyDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(initiator) + "'s dildo continues pleasuring " + ktn(target) + "'s rear."),
								(ktn(initiator) + " keeps penetrating " + ktn(target) + "'s " + assWord() + " with " + gC(initiator).posPr + " dildo."),
								(ktn(initiator) + " is fucking " + ktn(target) + " with " + gC(initiator).posPr + " dildo.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + " and " + textEnergyDamage(energyDamage) + "." + multAr[1];
		
		return results;
	}	
	return ca;
}
window.createCaDildoPenetrateMouth = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.key = "dildoPenetrateMouth";
	ca.name = "Dildo-Mouth penetration";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "arms" ];
	ca.targetsBodyparts = [ "mouth" ];
	ca.occupyBodyparts();
	ca.rank = 1;
	ca.flavorTags = ["targetMouth","top","continuedAction"];
	ca.flagUsingWeapon = true;
	
	ca.unvalidRelationalPositions.push(["kneeling","standing"]);
	ca.unvalidRelationalPositions.push(["spitroastTarget","spitroastFront"]);
	ca.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"],["spitroastBehind","spitroastTarget"]);
	
	ca.execute = function() {
		var results = new saResults;
		var target = targetsList[0];
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var lustDamage = ((getChar(this.initiator).agility.getValue() * 1) / 15) * multAr[0];
		var socialDriveDamage = ((getChar(this.initiator).agility.getValue() * 1) / 20) * multAr[0];
		getChar(this.targetsList[0]).lust.changeValue(-lustDamage);
		getChar(this.targetsList[0]).socialdrive.changeValue(-socialDriveDamage);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(target) + "'s mouth is full with " + ktn(initiator) + "'s dildo."),
								(ktn(initiator) + " continues massaging the insides of " + ktn(target) + "'s mouth with " + gC(initiator).posPr + " dildo.")
								] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + " and " + textSocialdriveDamage(socialDriveDamage) + "." + multAr[1];
		
		return results;
	}	
	return ca;
}

window.createCaDoubleDildoPussyPenetration = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.key = "doubleDildoPussyPenetration";
	ca.name = "Double Dildo-Pussy penetration";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "pussy" ];
	ca.targetsBodyparts = [ "pussy" ];
	ca.occupyBodyparts();
	ca.rank = 2;
	ca.flavorTags = ["fullsex","usePussy","targetPussy","top","continuedAction"];
	ca.flagUsingWeapon = true;
	
	ca.validRelationalPositions.push(["mountingFaceToFace","mountedFaceToFace"],["mountingAndMounted","mountedFaceToFace"]);
	
	ca.associatedActions = ["pushAgainstDildo"];
	ca.learnAssociatedActions();
	
	ca.execute = function() {
		var results = new saResults;
		var target = targetsList[0];
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var multAr2 = getSexDamageMultAlt(this.initiator,this.initiator,this.flavorTags);
		var lustDamage = ((getChar(this.initiator).physique.getValue() * 2 + getChar(this.initiator).resilience.getValue() * 1 + getChar(this.initiator).agility.getValue() * 1) / 24) * multAr[0];
		getChar(this.targetsList[0]).lust.changeValue(-lustDamage);
		var lustDamage2 = ((getChar(this.targetsList[0]).physique.getValue() * 2 + getChar(this.targetsList[0]).resilience.getValue() * 1 + getChar(this.targetsList[0]).agility.getValue() * 1) / 32) * multAr2[0];
		getChar(this.initiator).lust.changeValue(-lustDamage2);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(initiator) + "'s and " + ktn(target) + "'s " + randomFromList(["pussies","pussies","pussies","cherries","clams"]) + " remain connected by " + ktn(initiator) + "'s dildo."),
								(ktn(initiator) + "'s hips move up and down, letting them fall down to " + ktn(target) + "'s groin."),
								(ktn(initiator) + "'s " + pussyWord() + " feels the thrusts and pushes of " + ktn(target) + " down the other end of the dildo.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". " + multAr[1];
		results.description += ktn(initiator) + " received " + textLustDamage(lustDamage2) + ". " + multAr2[1];
		
		return results;
	}	
	return ca;
}

	// Fetish

window.createCaHoldArms = function(initiator,targetsList) {
	var ca = new continuedAction();
	ca.key = "holdArms";
	ca.name = "Holding Arms";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "arms" ];
	ca.targetsBodyparts = [ "arms" ];
	ca.occupyBodyparts();
	ca.flavorTags = ["domination"];
	
	ca.validRelationalPositions.push(["mountingFromBehind","mountedFromBehind"],["mountingFaceToFace","mountedFaceToFace"],
									 ["spitroastBehind","spitroastTarget"],["mountingFromBehind","mountingAndMounted"],
									 ["mountingAndMounted","mountedFaceToFace"],["mountingAndMounted","mountedFaceToFace"]);
									 
	ca.execute = function() {
		var results = new saResults;
		var target = this.targetsList[0];
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var willpowerDamage = ((gC(this.initiator).physique.getValue() + gC(this.initiator).resilience.getValue() ) / 10) * multAr[0];
		gC(target).willpower.changeValue(-willpowerDamage);
		results.value += willpowerDamage;
		results.description += randomFromList( [
								(ktn(target) + "'s arms remain restrainted by " + ktn(initiator) + "."),
								(ktn(target) + " is still immobilized by " + ktn(initiator) + "."),
								(ktn(initiator) + " keeps " + ktn(target) + "'s arms in place.") ] );
		results.description += " " + ktn(target) + " received " + textWillpowerDamage(willpowerDamage) + ". " + multAr[1];
		
		// Submissive extra lust
		if ( gC(target).hasLead == false && gC(target).willpower.current < (gC(target).willpower.max * 0.5) ) {
			var exLustDamage = ((gC(this.initiator).physique.getValue() + gC(this.initiator).resilience.getValue()) / Math.max(gC(target).will.getValue(),1)) * (2 - (gC(target).willpower.current / gC(target).willpower.max));
			//var exLustDamage = ((gC(this.initiator).physique.getValue() + gC(this.initiator).resilience.getValue())
			//					/ (gC(target).will.getValue() * 2 )) * (1 - (gC(target).willpower.current / gC(target).willpower.max)) * 2;
			gC(target).lust.changeValue(-exLustDamage);
			results.description += ktn(target) + "'s lack of control aroused " + gC(target).comPr + " and made " + gC(target).comPr + " receive " + textLustDamage(exLustDamage) + ". ";
		}
		
		return results;
	}
	return ca;
}

window.createCaVinesHoldArms = function(initiator,targetsList) {
	var ca = new continuedAction();
	ca.key = "vinesHoldArms";
	ca.name = "Vines holding arms";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.targetsBodyparts = [ "arms" ];
	ca.occupyBodyparts();
	ca.flavorTags = ["domination","bondage"];
									 
	ca.execute = function() {
		var results = new saResults;
		var target = this.targetsList[0];
		
		// Willpower damage
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var generalDamage = ((gC(this.initiator).intelligence.getValue() + gC(this.initiator).resilience.getValue() ) / 40) * multAr[0];
		
		var overflowMsg1 = applyBarDamage(target,"willpower",-generalDamage);
		var overflowMsg2 = applyBarDamage(target,"energy",-generalDamage);
		results.value += generalDamage;
		
		results.value += generalDamage;
		
		// Lead damage
		var leadDamage = 0;
		if ( gC(target).lead != 100 ) {
			leadDamage = ( State.variables.sc.leadGainRate * gC(target).leadMultiplier * (gC(target).willpower.current / gC(target).willpower.max) ) * 0.2;
			gC(target).lead -= leadDamage;
		}
		
		results.description += randomFromList( [
								(ktn(target) + "'s arms remain restrainted by " + ktn(initiator) + "'s vines."),
								(ktn(target) + " is still immobilized by " + ktn(initiator) + "'s vines."),
								(ktn(initiator) + "'s vines keep " + ktn(target) + "'s arms in place.") ] );
		results.description += " " + ktn(target) + " received " + textWillpowerDamage(generalDamage) + " and " + textEnergyDamage(generalDamage) + "." + overflowMsg1 + overflowMsg2 + " " + ktn(target) + " is having trouble to keep control. " + multAr[1];
		
		// Submissive extra lust
		if ( gC(target).hasLead == false && gC(target).willpower.current < (gC(target).willpower.max * 0.5) ) {
			var exLustDamage = ((gC(this.initiator).intelligence.getValue() + gC(this.initiator).resilience.getValue()) / Math.max(gC(target).will.getValue(),1)) * (2 - (gC(target).willpower.current / gC(target).willpower.max));
			//var exLustDamage = ((gC(this.initiator).intelligence.getValue() + gC(this.initiator).resilience.getValue())
			//					/ (gC(target).will.getValue() * 2 )) * (1 - (gC(target).willpower.current / gC(target).willpower.max)) * 2;
			gC(target).lust.changeValue(-exLustDamage);
			results.description += ktn(target) + "'s lack of control aroused " + gC(target).comPr + " and made " + gC(target).comPr + " receive " + textLustDamage(exLustDamage) + ". ";
		}
		
		return results;
	}
	return ca;
}

window.createCaSlimeHug = function(initiator,targetsList) {
	var ca = new continuedAction();
	ca.key = "slimeHug";
	ca.name = "Slime Hug";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.intensity = 1;
	ca.flavorTags = ["domination","bondage"];
									 
	ca.execute = function() {
		var results = new saResults;
		var target = this.targetsList[0];
		
		// General damage
		// Multiplier formula = (1+1.5/(x+0.5))^x - 1
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var multiplier = Math.pow((1+1.5/(this.intensity+0.5)),this.intensity) - 1;
		var generalDamage = multiplier * ((gC(this.initiator).agility.getValue() + gC(this.initiator).resilience.getValue() + gC(this.initiator).will.getValue() ) / 60) * multAr[0];
		applyBarDamage(target,"lust",-generalDamage);
		var overflowMsg1 = applyBarDamage(target,"willpower",-generalDamage);
		var overflowMsg2 = applyBarDamage(target,"energy",-generalDamage);
		results.value += generalDamage;
		
		// Lead damage
		var leadDamage = 0;
		if ( gC(target).lead != 100 ) {
			leadDamage = ( State.variables.sc.leadGainRate * gC(target).leadMultiplier * (gC(target).willpower.current / gC(target).willpower.max) ) * 0.2;
			gC(target).lead -= leadDamage;
		}
		
		results.description += randomFromList( [
								(ktn(target) + "'s movements remain restrained by the slime."),
								(ktn(target) + " feels the slime tight around " + gC(target).posPr + " body."),
								("The slime massages " + ktn(target) + "'s body.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(generalDamage) + ", " + textWillpowerDamage(generalDamage) + " and "
							 + textEnergyDamage(generalDamage) + "." + overflowMsg1 + overflowMsg2 + multAr[1];
		if ( leadDamage > 0 ) {
			results.description += " " + ktn(target) + " is having trouble to gain control.";
		}
		
		// Submissive extra lust
		if ( gC(target).hasLead == false && gC(target).willpower.current < (gC(target).willpower.max * 0.5) ) {
			var exLustDamage = ((gC(this.initiator).intelligence.getValue() + gC(this.initiator).resilience.getValue()) / Math.max(gC(target).will.getValue(),1)) * (2 - (gC(target).willpower.current / gC(target).willpower.max));
			//var exLustDamage = ((gC(this.initiator).intelligence.getValue() + gC(this.initiator).resilience.getValue())
			//					/ (gC(target).will.getValue() * 2 )) * (1 - (gC(target).willpower.current / gC(target).willpower.max)) * 2;
			gC(target).lust.changeValue(-exLustDamage);
			results.description += ktn(target) + "'s lack of control aroused " + gC(target).comPr + " and made " + gC(target).comPr + " receive " + textLustDamage(exLustDamage) + ". " + multAr[1];
		}
		
		return results;
	}
	return ca;
}

window.createCaEnergyDrainingKiss = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.name = "Energy Draining Kiss";
	ca.key = "energyDrainingKissing";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "mouth" ];
	ca.targetsBodyparts = [ "mouth" ];
	ca.occupyBodyparts();
	ca.flavorTags = ["oral","useMouth","targetMouth","romantic","continuedAction","draining"];
	
	ca.unvalidRelationalPositions.push(["standing","kneeling"],["kneeling","standing"]);
	
	ca.execute = function() {
		var results = new saResults;
		var target = targetsList[0];
		
		var multAr = getSexDamageMultAlt(this.initiator,this.targetsList[0],this.flavorTags);
		var lustDamage = ((getChar(this.initiator).agility.getValue() + getChar(this.initiator).perception.getValue() + getChar(this.initiator).empathy.getValue()) / 22.5) * multAr[0];
		getChar(this.initiator).lust.changeValue(-lustDamage/2);
		getChar(this.targetsList[0]).lust.changeValue(-lustDamage);
		var energyDrain = (( gCstat("chPlayerCharacter","agility") + gCstat("chPlayerCharacter","perception") + gCstat("chPlayerCharacter","empathy") ) / 30) * multAr[0];
		gC(this.initiator).energy.changeValue(energyDrain);
		gC(this.targetsList[0]).energy.changeValue(-energyDrain);
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(initiator) + " steals energy from " + ktn(target) + "'s mouth."),
								(ktn(initiator) + " keeps kissing " + ktn(target) + ", who feels " + gC(target).posPr + " energy slipping away.") ] );
								
		results.description += " " + ktn(targetsList[0]) + " received " + textLustDamage(lustDamage) + ". ";
		results.description += ktn(initiator) + " received " + textLustDamage(lustDamage/2) + ". " + ktn(initiator) + " drained "
							 + textEnergyDamage(energyDrain) + " from " + ktn(targetsList[0]) + ". " + multAr[1];
							   
		return results;
	}
	return ca;
}

///////// CREATE POSITION FUNCTIONS /////////

window.createPosMountFromBehind = function(initiator, targetsList) {
	getChar(initiator).position.makeActive(targetsList);
	getChar(initiator).position.key = "mountingFromBehind";
	getChar(initiator).position.name = "Mounting from behind";
	getChar(initiator).position.description = getChar(initiator).formattedName + " is holding " + getChar(targetsList[0]).formattedName
											+ "'s hips from behind.";
											
	getChar(targetsList[0]).position.makePassive(initiator);
	getChar(targetsList[0]).position.key = "mountedFromBehind";
	getChar(targetsList[0]).position.name = "Being mounted from behind";
	getChar(targetsList[0]).position.description = getChar(initiator).formattedName + " is holding " + getChar(targetsList[0]).formattedName
											+ "'s hips from behind.";
}

window.createPosMountFaceToFace = function(initiator, targetsList) {
	getChar(initiator).position.makeActive(targetsList);
	getChar(initiator).position.key = "mountingFaceToFace";
	getChar(initiator).position.name = "Mounting face to face";
	getChar(initiator).position.description = getChar(initiator).formattedName + " is holding " + getChar(targetsList[0]).formattedName
											+ " down.";
											
	getChar(targetsList[0]).position.makePassive(initiator);
	getChar(targetsList[0]).position.key = "mountedFaceToFace";
	getChar(targetsList[0]).position.name = "Being mounted face to face";
	getChar(targetsList[0]).position.description = getChar(initiator).formattedName + " is holding " + getChar(targetsList[0]).formattedName
											+ " down.";
}

window.createPosKneel = function(initiator, targetsList) {
	// Initiator is the character other are kneeling towards
	getChar(initiator).position.makeActive(targetsList);
	getChar(initiator).position.key = "standing";
	getChar(initiator).position.name = "Standing";
	getChar(initiator).position.description = getChar(targetsList[0]).formattedName + " is kneeling in front of " + getChar(initiator).formattedName + ".";
											
	getChar(targetsList[0]).position.makePassive(initiator);
	getChar(targetsList[0]).position.key = "kneeling";
	getChar(targetsList[0]).position.name = "Kneeling";
	getChar(targetsList[0]).position.description = getChar(targetsList[0]).formattedName + " is kneeling in front of " + getChar(initiator).formattedName + ".";
}

window.createPosSpitroast = function(mainInitiator,secondaryInitiator,target) {
	// Target gets on all fours, main initiator takes target from behind, secondaryInitiator takes target from the front
	gC(mainInitiator).position.makeActive([target]);
	gC(mainInitiator).position.key = "spitroastBehind";
	gC(mainInitiator).position.name = "Mounting from behind";
	
	gC(secondaryInitiator).position.makeActive([target]);
	gC(secondaryInitiator).position.key = "spitroastFront";
	gC(secondaryInitiator).position.name = "Taking head";
	
	gC(target).position.makePassiveSecondaryInitiators(mainInitiator,[secondaryInitiator]);
	gC(target).position.key = "spitroastTarget";
	gC(target).position.name = "Getting spitroasted";
	
	var description = "" + ktn(target) + " is on all fours, taken by " + ktn(mainInitiator) + " from behind and by " + ktn(secondaryInitiator)
					+ " from the front.\n";
	gC(mainInitiator).position.description = description;
	gC(secondaryInitiator).position.description = description;
	gC(target).position.description = description;
}

	// Composite position functions
window.createComPosSpitroast = function(initiator,target) {
	// Target gets on all fours, main initiator takes target from behind, secondaryInitiator takes target from the front
	var secondaryInitiator = gC(target).position.initiator;
	
	gC(initiator).position.makeActive([target]);
	gC(initiator).position.key = "spitroastBehind";
	gC(initiator).position.name = "Mounting from behind";
	
	gC(secondaryInitiator).position.makeActive([target]);
	gC(secondaryInitiator).position.key = "spitroastFront";
	gC(secondaryInitiator).position.name = "Taking head";
	
	gC(target).position.makePassiveSecondaryInitiators(initiator,[secondaryInitiator]);
	gC(target).position.key = "spitroastTarget";
	gC(target).position.name = "Getting spitroasted";
	
	var description = "" + ktn(target) + " is on all fours, taken by " + ktn(initiator) + " from behind and by " + ktn(secondaryInitiator)
					+ " from the front.";
	gC(initiator).position.description = description;
	gC(secondaryInitiator).position.description = description;
	gC(target).position.description = description;
}
window.createComPosMountingAndMounted = function(initiator,target) {
	//
	var secondaryTarget = gC(target).position.targetsList[0];
	
	gC(initiator).position.makeActive([target]);
	gC(initiator).position.key = "mountingFromBehind";
	gC(initiator).position.name = "Mounting from behind";
	
	gC(secondaryTarget).position.free();
	gC(secondaryTarget).position.makePassive(target);
	gC(secondaryTarget).position.key = "mountedFaceToFace";
	gC(secondaryTarget).position.name = "Being mounted face to face";
	
	gC(target).position.makePassive(initiator);
	gC(target).position.makeActive([secondaryTarget]);
	gC(target).position.key = "mountingAndMounted";
	gC(target).position.name = "Mounting and mounted";
	
	var description = "" + ktn(initiator) + " is mounting " + ktn(target) + ", who is also mounting " + ktn(secondaryTarget) + ".";
	gC(initiator).position.description = description;
	gC(secondaryTarget).position.description = description;
	gC(target).position.description = description;
}
window.createComPosMountingAndMountedAlt = function(initiator,target) {
	//
	var secondaryTarget = gC(target).position.targetsList[0];
	
	gC(initiator).position.makeActive([target]);
	gC(initiator).position.key = "mountingFromBehind";
	gC(initiator).position.name = "Mounting from behind";
	
	gC(secondaryTarget).position.free();
	gC(secondaryTarget).position.makePassive(target);
	gC(secondaryTarget).position.key = "mountedFromBehind";
	gC(secondaryTarget).position.name = "Being mounted from behind";
	
	gC(target).position.makePassive(initiator);
	gC(target).position.makeActive([secondaryTarget]);
	gC(target).position.key = "mountingAndMounted";
	gC(target).position.name = "Mounting and mounted";
	
	var description = "" + ktn(initiator) + " is mounting " + ktn(target) + ", who is also mounting " + ktn(secondaryTarget) + ".";
	gC(initiator).position.description = description;
	gC(secondaryTarget).position.description = description;
	gC(target).position.description = description;
}

window.createComPosDoubleKneeling = function(initiator,target) {
	var secondaryTarget = gC(initiator).position.targetsList[0]; // Must already be kneeling
	
	gC(initiator).position.makeActive([target,secondaryTarget]); // Must already be standing
	gC(initiator).position.key = "standing";
	gC(initiator).position.name = "Standing";
	
	gC(secondaryTarget).position.free();
	gC(secondaryTarget).position.makePassive(initiator);
	gC(secondaryTarget).position.key = "kneeling";
	gC(secondaryTarget).position.name = "Kneeling";
	
	gC(target).position.makePassive(initiator);
	gC(target).position.key = "kneeling";
	gC(target).position.name = "Kneeling";
	
	var description = "Both " + ktn(target) + " and " + ktn(secondaryTarget) + " are kneeling in front of " + ktn(initiator) + ".";
	gC(initiator).position.description = description;
	gC(secondaryTarget).position.description = description;
	gC(target).position.description = description;
}

// Constructors, serializers, etc.
continuedAction.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

continuedAction.prototype.clone = function () {
	return (new continuedAction())._init(this);
};

continuedAction.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new continuedAction())._init($ReviveData$)', ownData);
};

// Auxiliar functions

window.isPositionMounting = function(position) {
	var flag = false;
	if ( position == "mountingFaceToFace" || position == "mountingFromBehind" || position == "mountingAndMounted" ) { flag = true; }
	return flag;
}
window.isPositionMounted = function(position) {
	var flag = false;
	if ( position == "mountedFaceToFace" || position == "mountedFromBehind" || position == "mountingAndMounted" ) { flag = true; }
	return flag;
}
window.isPositionKneeling = function(position) {
	var flag = false;
	if ( position == "kneeling" || position == "spitroastTarget" ) { flag = true; }
	return flag;
}
window.isPositionMakingKneel = function(position) {
	var flag = false;
	if ( position == "standing" || position == "spitroastFront" ) { flag = true; }
	return flag;
}

window.addTargetToActorsCA = function(target,actor,caKey) {
	var found = false;
	for ( var ca of State.variables.sc.continuedActions ) {
		if ( ca.key == caKey && ca.initiator == actor && found == false ) {
			ca.targetsList.push(target);
			ca.occupyBodyparts();
			found = true;
		}
	}
	return found;
}


///// GENERIC DIALOGS /////

setup.dialogDB = [];

window.dialogContext = function(actor,target,extra1,extra2) {
	this.actor = actor;
	this.target = target;
	this.extra1 = extra1;
	this.extra2 = extra2;
}

window.dialog = function(getDialog,checkReqs,getWeight) {
	this.getDialog = getDialog; // Function: Returns a formatted dialog with specific input
	this.checkReqs = checkReqs; // Function: Checks if the requisites for this dialog are met
	this.getWeight = getWeight; // Function: Returns the weight of receiving this dialog
								// All of these functions receive a dialogContext object
}

// Sex scene dialogs
setup.dialogDB.ssDialogs = [];
setup.dialogDB.ssDialogs.push(new dialog( // Kissing 1
	function(context) {
		var dText = "";
		if ( getCharsDrivePercent(context.actor,"dDomination") + getCharsDrivePercent(context.actor,"dAmbition") >= 0.3 ) {
			dText = "Let me taste your lips.";
		} else {
			dText = "Will you let me taste your lips?";
		}
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("useMouth") &&
			 setup.saList[context.extra1].flavorTags.includes("targetMouth")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.ssDialogs.push(new dialog( 					// Kissing 2
	function(context) {
		var dText = "Let me taste you...";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("useMouth") &&
			 setup.saList[context.extra1].flavorTags.includes("targetMouth")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Caress 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `What a cute face, ${relName}. Did you like that?`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("foreplay")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 80;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Caress 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Are you sensitive here?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("foreplay")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 80;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Caress pussy 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "";
		if ( getCharsDrivePercent(context.actor,"dDomination") + getCharsDrivePercent(context.actor,"dAmbition") >= 0.3 ) {
			dText = "Hmm, someone's flooding.";
		} else {
			dText = "My, someone's flooding.";
		}
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("foreplay") &&
			 setup.saList[context.extra1].flavorTags.includes("targetPussy")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 80;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Caress pussy 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Aching to get filled?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("foreplay") &&
			 setup.saList[context.extra1].flavorTags.includes("targetPussy") &&
			 gC(context.actor).hasFreeBodypart("dick")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 80;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Caress pussy 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "This " + pussyWord() + " belongs to me now. If it's needy, you'll have to ask me for help.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("foreplay") &&
			 setup.saList[context.extra1].flavorTags.includes("targetPussy") &&
			 gC(context.target).domChar == context.actor &&
			 getCharsDrivePercent(context.actor,"dDomination") >= 0.15
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 30 + gC(context.actor).dDomination.level * 10;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Caress pussy 4
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "This thing of yours... Is now mine. You should thank me for letting you enjoy it.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("foreplay") &&
			 setup.saList[context.extra1].flavorTags.includes("targetPussy") &&
			 gC(context.target).domChar == context.actor &&
			 getCharsDrivePercent(context.actor,"dDomination") >= 0.1
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 30 + gC(context.actor).dDomination.level * 10;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Caress dick 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Hmm, you're getting big, and hard.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("foreplay") &&
			 setup.saList[context.extra1].flavorTags.includes("targetDick")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 80;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Caress dick 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Anxious to get this inside me?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("foreplay") &&
			 setup.saList[context.extra1].flavorTags.includes("targetDick") &&
			 ( gC(context.actor).hasFreeBodypart("pussy") || gC(context.actor).hasFreeBodypart("anus") )
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 80;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Caress dick 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Remember that this " + dickWord() + " of yours is my toy, only I can play with it.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("foreplay") &&
			 setup.saList[context.extra1].flavorTags.includes("targetDick") &&
			 gC(context.target).domChar == context.actor &&
			 getCharsDrivePercent(context.actor,"dDomination") >= 0.15
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 30 + gC(context.actor).dDomination.level * 10;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Caress dick 4
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "See this " + dickWord() + " of yours? It will only cum with my permission.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("foreplay") &&
			 setup.saList[context.extra1].flavorTags.includes("targetDick") &&
			 gC(context.target).domChar == context.actor &&
			 getCharsDrivePercent(context.actor,"dDomination") >= 0.15
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 30 + gC(context.actor).dDomination.level * 10;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Caress ass 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Hey, don't get startled.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("foreplay") &&
			 setup.saList[context.extra1].flavorTags.includes("targetAss")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 80;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Full sex 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = randomFromList([(`Hmm. Don't stop.`),(`Hmm. Don't stop, ${relName}.`)]);
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 65;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Full sex 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = randomFromList([("Yes, keep going!"),("Yes, just like that!")]);
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 getBarPercentage(context.actor,"lust") <= 0.65
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Full sex 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Don't stop, I'm almost there!";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 getBarPercentage(context.actor,"lust") <= 0.35
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 160;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Full sex 4
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `I'm getting close, ${relName}!`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 getBarPercentage(context.actor,"lust") <= 0.25
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 200;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Full sex 5
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Yes, yes I love you, ${relName}!`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		var romanceScore = rLvlAbt(context.actor,context.target,"romance") - rLvlAbt(context.actor,context.target,"enmity");
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 getBarPercentage(context.actor,"lust") <= 0.50 &&
			 romanceScore >= 7
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Full sex 6
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Enjoy being mine, ${relName}!`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		var dominationScore = rLvlAbt(context.actor,context.target,"domination") - rLvlAbt(context.actor,context.target,"submission");
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 dominationScore >= 7
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Scissoring 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Ah... Ah... Yes, grind me.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 setup.saList[context.extra1].flavorTags.includes("usePussy") &&
			 setup.saList[context.extra1].flavorTags.includes("targetPussy")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Scissoring 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = randomFromList([("Hold me close!"),(`Hold me close, ${relName}!`)]);
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 setup.saList[context.extra1].flavorTags.includes("usePussy") &&
			 setup.saList[context.extra1].flavorTags.includes("targetPussy") &&
			 getBarPercentage(context.actor,"lust") <= 0.40
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Full sex 7
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Come closer to me, ${relName}.`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		var romanceScore = rLvlAbt(context.actor,context.target,"romance") - rLvlAbt(context.actor,context.target,"enmity");
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 romanceScore >= 6
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Penetrating 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = randomFromList([("Aaah... You're so tight."),(`You're so tight, ${relName}.`)]);
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 setup.saList[context.extra1].flavorTags.includes("useDick") &&
			 (setup.saList[context.extra1].flavorTags.includes("targetPussy") || setup.saList[context.extra1].flavorTags.includes("targetAss"))
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Penetrating 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "You feel so good.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 setup.saList[context.extra1].flavorTags.includes("useDick") &&
			 (setup.saList[context.extra1].flavorTags.includes("targetPussy") || setup.saList[context.extra1].flavorTags.includes("targetAss"))
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Penetrating 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Yes, squirt for me!";
		return dText;
	},
	function(context) {
		var flagValid = false;
		var dominationScore = rLvlAbt(context.actor,context.target,"domination") - rLvlAbt(context.actor,context.target,"submission");
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 setup.saList[context.extra1].flavorTags.includes("useDick") &&
			 (setup.saList[context.extra1].flavorTags.includes("targetPussy") || setup.saList[context.extra1].flavorTags.includes("targetAss")) &&
			 dominationScore >= -4 &&
			 gC(context.actor).domChar != context.target
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Being penetrated 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Don't go too fast...";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 setup.saList[context.extra1].flavorTags.includes("targetDick") &&
			 (setup.saList[context.extra1].flavorTags.includes("usePussy") || setup.saList[context.extra1].flavorTags.includes("useAss"))  &&
			 getBarPercentage(context.actor,"lust") >= 0.80
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Being penetrated 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Yes, fill me!";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 setup.saList[context.extra1].flavorTags.includes("targetDick") &&
			 (setup.saList[context.extra1].flavorTags.includes("usePussy") || setup.saList[context.extra1].flavorTags.includes("useAss"))  &&
			 getBarPercentage(context.actor,"lust") <= 0.80
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Being penetrated 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Ah! Yes, don't stop!";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 setup.saList[context.extra1].flavorTags.includes("targetDick") &&
			 (setup.saList[context.extra1].flavorTags.includes("usePussy") || setup.saList[context.extra1].flavorTags.includes("useAss"))  &&
			 getBarPercentage(context.actor,"lust") <= 0.60
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Being penetrated 4
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `I want you deeper inside me, ${relName}! Don't stop!`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("fullsex") &&
			 setup.saList[context.extra1].flavorTags.includes("targetDick") &&
			 (setup.saList[context.extra1].flavorTags.includes("usePussy") || setup.saList[context.extra1].flavorTags.includes("useAss"))  &&
			 getBarPercentage(context.actor,"lust") <= 0.50
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 200;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Mounting 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Looking cute down there.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).position.type != "free" 
			) {
				if ( isPositionMounting(gC(context.actor).position.key) &&
					 areCharactersLinked(context.actor,context.target) ) {
						 flagValid = true;
					}
			}
		return flagValid;
	},
	function(context) {
		var weight = 20 + gC(context.actor).dDomination.level * 4;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Being mounted 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Will you be gentle?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).position.type != "free" 
			) {
				if ( isPositionMounted(gC(context.actor).position.key) &&
					 areCharactersLinked(context.actor,context.target) &&
					 getBarPercentage(context.actor,"lust") >= 0.80 ) {
						 flagValid = true;
					}
			}
		return flagValid;
	},
	function(context) {
		var weight = 30;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Kneeling 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Do you like seeing me on my knees, ${relName}?`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).position.type != "free" 
			) {
				if ( isPositionKneeling(gC(context.actor).position.key) &&
					 areCharactersLinked(context.actor,context.target) ) {
						 flagValid = true;
					}
			}
		return flagValid;
	},
	function(context) {
		var weight = 40;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Kneeling 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Are you enjoying this?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).position.type != "free" 
			) {
				if ( isPositionKneeling(gC(context.actor).position.key) &&
					 areCharactersLinked(context.actor,context.target) ) {
						 flagValid = true;
					}
			}
		return flagValid;
	},
	function(context) {
		var weight = 40;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Making kneel 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Good " + gC(context.target).getDiminutive() + ", don't stop.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).position.type != "free" 
			) {
				if ( isPositionMakingKneel(gC(context.actor).position.key) &&
					 areCharactersLinked(context.actor,context.target) ) {
						 flagValid = true;
					}
			}
		return flagValid;
	},
	function(context) {
		var weight = 40;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Making kneel 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Yes, look at my face.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).position.type != "free" 
			) {
				if ( isPositionMakingKneel(gC(context.actor).position.key) &&
					 areCharactersLinked(context.actor,context.target) ) {
						 flagValid = true;
					}
			}
		return flagValid;
	},
	function(context) {
		var weight = 40;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Being eaten out
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Aah, your tongue feels so good!";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("targetMouth") &&
			 (setup.saList[context.extra1].flavorTags.includes("usePussy") || setup.saList[context.extra1].flavorTags.includes("useAss") || setup.saList[context.extra1].flavorTags.includes("useDick"))
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Being eaten out
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Hmm, you're such a good " + gC(context.target).getDiminutive() + ".";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("targetMouth") &&
			 (setup.saList[context.extra1].flavorTags.includes("usePussy") || setup.saList[context.extra1].flavorTags.includes("useAss") || setup.saList[context.extra1].flavorTags.includes("useDick"))
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Sadism 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "You better behave from now on.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("usePain") 
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100 + gC(context.actor).dDomination.level * 5;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Sadism 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Take this.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("usePain") 
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 50 + gC(context.actor).dDomination.level * 10;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Sadism 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Liked that?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("usePain") 
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 75;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Sadism target 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Aw!";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 doesAnyActionContainTag(context.extra2,"usePain")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100 - gC(context.actor).dDomination.level * 10;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Sadism target 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Nngh...";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 doesAnyActionContainTag(context.extra2,"usePain")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 50;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Sadism target 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Is that the best you can do?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 doesAnyActionContainTag(context.extra2,"usePain")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 10 + gC(context.actor).dDomination.level * 10;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Sadism target 4
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Nothing I can't take!";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 doesAnyActionContainTag(context.extra2,"usePain")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 10 + gC(context.actor).dDomination.level * 10;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Bondage 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "There, all wrapped up.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("bondage") 
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Bondage 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Yes! Struggle for me.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("bondage") &&
			 getCharsDrivePercent(context.actor,"dDomination") >= 0.15
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 200;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Bondage 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Stay quiet and be a good toy.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("bondage") &&
			 getCharsDrivePercent(context.actor,"dDomination") >= 0.15
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 200;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Denial 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Hehehe...";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("denial") 
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 75;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Denial 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Have you been good enough to deserve an orgasm?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("denial") &&
			 getCharsDrivePercent(context.actor,"dDomination") >= 0.10
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 120;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Denial 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "You'll need to beg harder if you want to cum.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("denial") &&
			 getCharsDrivePercent(context.actor,"dDomination") >= 0.15
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 200;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Hypnosis 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Focus on my eyes...";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("hypnosis")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Hypnosis 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Look at me, ${relName}.`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 setup.saList[context.extra1].flavorTags.includes("hypnosis")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Locked mouth
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = randomFromList([("Hmm... Ngh, hmm..."),("Hmmm!"),("..."),("Nnng..."),("Hmm.")]);
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( charHasLockedBodypart(context.actor,"mouth")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Virgin pussy caressing target 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "";
		if ( getCharsDrivePercent(context.actor,"dDomination") + getCharsDrivePercent(context.actor,"dAmbition") > 0.3 ) {
			dText = "Hmm! I don't have much experience down there, so take it easy.";
		} else {
			dText = "Aah... I haven't had anything inside there, so please be gentle...";
		}
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 doesAnyActionContainTags(context.extra2,["foreplay","targetPussy"]) &&
			 anyOtherActorHasFreeBodypart(context.actor,"dick") &&
			 checkCharsVirginityExists(context.target,"pussy")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Virgin dick caressing target 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "";
		if ( getCharsDrivePercent(context.actor,"dDomination") + getCharsDrivePercent(context.actor,"dAmbition") > 0.3 ) {
			dText = "Uhnn. I haven't done much with my " + dickWord() + ", so don't be too rough.";
		} else {
			dText = "Aah... I don't have much experience with that, so be gentle, ok?";
		}
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 doesAnyActionContainTags(context.extra2,["foreplay","targetDick"]) &&
			 anyOtherActorHasFreeBodypart(context.actor,"pussy") &&
			 checkCharsVirginityExists(context.target,"dick")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Virgin ass caressing target 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "";
		if ( getCharsDrivePercent(context.actor,"dDomination") + getCharsDrivePercent(context.actor,"dAmbition") > 0.3 ) {
			dText = "Hmm! Be careful about where you touch...";
		} else {
			dText = "Hm-Ah! I hope you don't intend to go further...";
		}
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 doesAnyActionContainTags(context.extra2,["foreplay","targetAss"]) &&
			 anyOtherActorHasFreeBodypart(context.actor,"dick") &&
			 checkCharsVirginityExists(context.target,"anal")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);

setup.dialogDB.ssDialogs.push(new dialog( 					// Request pussy target 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "My " + pussyWord() + " is aching...";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 doesCharHaveAlteredState(context.actor,"Pus+") &&
			 gC(context.actor).hasFreeBodypart("pussy")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Request dick target 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Hmm, pay attention to my " + dickWord() + ".";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 doesCharHaveAlteredState(context.actor,"Dic+") &&
			 gC(context.actor).hasFreeBodypart("dick")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Request breasts target 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Massage my " + boobsWord() + ", will you?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 doesCharHaveAlteredState(context.actor,"Bre+") &&
			 gC(context.actor).hasFreeBodypart("breasts")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);
setup.dialogDB.ssDialogs.push(new dialog( 					// Request ass target 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "My " + assWord() + " is itchy.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 doesCharHaveAlteredState(context.actor,"Ass+") &&
			 gC(context.actor).hasFreeBodypart("anus")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	})
);

// Conversation offer dialogues
setup.dialogDB.csDialogs = [];
setup.dialogDB.csDialogs.push(new dialog( // Generic 1
	function(context) {
		var dText = "Hey, do you have a minute?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( true
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 80;
		return weight;
	}));
setup.dialogDB.csDialogs.push(new dialog( // Generic 2
	function(context) {
		var dText = "Let's chat for a while.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( true
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 80;
		return weight;
	}));
setup.dialogDB.csDialogs.push(new dialog( // Friendly 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Hello ${relName}, I'd like to hear your opinion on this...`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 isMissionOnFriendlyGroup(gC(context.actor).mission)
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 120;
		return weight;
	}));
setup.dialogDB.csDialogs.push(new dialog( // Friendly 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "You aren't going to believe this.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 isMissionOnFriendlyGroup(gC(context.actor).mission)
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 120;
		return weight;
	}));
setup.dialogDB.csDialogs.push(new dialog( // Friendly 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "How is your day going?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 isMissionOnFriendlyGroup(gC(context.actor).mission)
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 120;
		return weight;
	}));
setup.dialogDB.csDialogs.push(new dialog( // Flirty 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "I've just seen something that brightened my day. What was it? You, of course.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 isMissionOnFlirtyGroup(gC(context.actor).mission)
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 120;
		return weight;
	}));
setup.dialogDB.csDialogs.push(new dialog( // Flirty 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "I want to spend some time with you.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 isMissionOnFlirtyGroup(gC(context.actor).mission)
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 120;
		return weight;
	}));
setup.dialogDB.csDialogs.push(new dialog( // Flirty 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = "Hello, beautiful.";
		if ( gC(context.actor).perPr == "he" ) { dText = "Hello, handsome."; }
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 isMissionOnFlirtyGroup(gC(context.actor).mission)
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 120;
		return weight;
	}));
setup.dialogDB.csDialogs.push(new dialog( // Flirty 4
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Hi ${relName}, would you dedicate a while to me?`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 isMissionOnFlirtyGroup(gC(context.actor).mission)
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 120;
		return weight;
	}));
	
// Following dialogues
setup.dialogDB.folMeDialogs = []; // Extra 1 is forced = true || forced = false
setup.dialogDB.folMeDialogs.push(new dialog( // Follow me 1
	function(context) {
		var dText = "We both could benefit from teaming up. What do you say?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 context.extra1 == false
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.folMeDialogs.push(new dialog( // Follow me 2
	function(context) {
		var dText = "It feels like a dangerous day. Lend me a hand and I'll protect you.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 context.extra1 == false
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.folMeDialogs.push(new dialog( // Follow me 3
	function(context) {
		var dText = "I could really use some help today.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 context.extra1 == false
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.folMeDialogs.push(new dialog( // Follow me forced 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Follow me, ${relName}.`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 context.extra1 == true
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.folMeDialogs.push(new dialog( // Follow me forced 2
	function(context) {
		var dText = "Come with me.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 context.extra1 == true
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));

setup.dialogDB.folPlDialogs = [];
setup.dialogDB.folPlDialogs.push(new dialog( // Follow player 1
	function(context) {
		var dText = "It feels like a dangerous day. How about we go together?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( true
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.folPlDialogs.push(new dialog( // Follow player 2
	function(context) {
		var dText = "I'm feeling a bit dizzy. Mind if I tag along?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( true
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.folPlDialogs.push(new dialog( // Follow player 3
	function(context) {
		var dText = "Hey, would you mind if I followed you?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( true
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));

setup.dialogDB.unfolMeDialogs = [];
setup.dialogDB.unfolMeDialogs.push(new dialog( // Unfollow me 1
	function(context) {
		var dText = "I'd prefer to go alone for now.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( true
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.unfolMeDialogs.push(new dialog( // Unfollow me 2
	function(context) {
		var dText = "Let's split up for a while.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( true
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));

setup.dialogDB.unfolPlDialogs = [];
setup.dialogDB.unfolPlDialogs.push(new dialog( // Unfollow player 1
	function(context) {
		var dText = "I have something to do.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( true
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.unfolPlDialogs.push(new dialog( // Unfollow player 2
	function(context) {
		var dText = "I need some time for myself.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( true
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));

// Initiate combat dialogues
setup.dialogDB.icDialogs = [];
setup.dialogDB.icDialogs.push(new dialog( // Challenge 1
	function(context) {
		var dText = "I've been wanting to measure myself with you.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "challenge"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Challenge 2
	function(context) {
		var dText = "I've polished my techniques recently. Want to see it?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "challenge"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 70 + gC(context.actor).dImprovement.level * 10;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Challenge 3
	function(context) {
		var dText = "I've come to challenge you. Unless you're too scared, of course.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "challenge"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 70 + gC(context.actor).dDomination.level * 10;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Humilliate 1
	function(context) {
		var dText = "You've taken too much spotlight lately. Don't you know how fast flies burn?";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "humilliate"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Humilliate 2
	function(context) {
		var dText = "You appear to be doing well in the competition. Perhaps too well.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "humilliate"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Humilliate 3
	function(context) {
		var dText = "There's only room for one High Priestess - and I'll prove that I deserve it more than you.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "humilliate"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 70 + gC(context.actor).dAmbition.level * 10;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Weaken enemy 1
	function(context) {
		var dText = "You've been quite the bad " + gC(context.target).getDiminutive() + ". It's time to put you in your place.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "weakenEnemy"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Weaken enemy 2
	function(context) {
		var dText = "You've been getting stronger. I should stop you now that I still can.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "weakenEnemy"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Weaken enemy 3
	function(context) {
		var dText = "I heard of your misdeeds. I'll punish you before Drishtya has to.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "weakenEnemy"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 70 + gC(context.actor).dCooperation.level * 10;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Gain domination 1
	function(context) {
		var dText = "I think you don't respect me as much as you should. It's time to teach you a lesson.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "gainDomination"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Gain domination 2
	function(context) {
		var dText = "I've come to put you in your place.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "gainDomination"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Gain domination 3
	function(context) {
		var dText = "I'm in the mood to give you a good spanking.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "gainDomination"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 70 + gC(context.actor).dDomination.level * 10;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Force sex 1
	function(context) {
		var dText = "I'm in the mood for a fight. And I think you'll be my prize.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "forceSex"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Force sex 2
	function(context) {
		var dText = "I know it's a whim, but I really want to take you to warm my bed. Feel free to surrender.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "forceSex"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Force sex 3
	function(context) {
		var dText = "Remember how you teased me the other day? It's time to reap what you sowed.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "forceSex"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Gain submissive 1
	function(context) {
		var dText = "Can you believe it? I woke up this morning and no one brought me breakfast. You'll be bringing it to me tomorrow.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "gainSubmissive"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Gain submissive 2
	function(context) {
		var dText = "Don't you think you belong at my feet? Let me prove it to you.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "gainSubmissive"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Gain submissive 3
	function(context) {
		var dText = "I know you're too stubborn to admit you want to kneel before me, so I'll make sure you don't need any excuses.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "gainSubmissive"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Liberate friend 1
	function(context) {
		var dText = "Who gave you the right to boss others around? I'm going to put you in your place.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "liberateFriend"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Liberate friend 2
	function(context) {
		var dText = "I'm displeased with how you're treating my friends. I suggest you apologize as soon as possible.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "liberateFriend"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Liberate friend 3
	function(context) {
		var dText = "Someone I care about is under your yoke, but not for long.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "liberateFriend"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Casus belli retribution 1
	function(context) {
		var dText = "This will teach you not to wrong me.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "cbRetribution"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Casus belli retribution 2
	function(context) {
		var dText = "You were pretty mean earlier. Consider this some education in proper manners.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "cbRetribution" &&
			 getCharsDrivePercent(context.actor,"dCooperation") > 0.15
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.icDialogs.push(new dialog( // Casus belli retribution 3
	function(context) {
		var dText = "This wouldn't be happening if you knew when to keep your mouth shut.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( 
			 gC(context.actor).mission == "cbRetribution"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));

window.dialogToText = function(dialog,context) {
	var actor = context.actor;
	var dText = gC(actor).getFormattedName() + ': //' + colorText(('"' + dialog.getDialog(context) + '"'),gC(actor).speechColor) + '//';
	return dText;
}
window.chooseDialogFromList = function(dList,actor,target,extra1,extra2) {
	var chosenDialog = "";
	var context = new dialogContext(actor,target,extra1,extra2);
	var wList = [];
	for ( var dialog of dList ) { // If requisites are met, add dialog object to weighted list with valid weight
		if ( dialog.checkReqs(context) ) {
			wList.push(new weightedElement(dialog,dialog.getWeight(context)));
		}
	}
	if ( wList.length > 0 ) {
		var chosenDialog = randomFromWeightedListPercentThreshold(wList,0.3);
		return dialogToText(chosenDialog,context);
	} else {
		return chosenDialog;
	}
}

// Orgasm messages

setup.dialogDB.orDialogs = [];
setup.dialogDB.orDialogs.push(new dialog( // Standard 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `${actor}'s mind goes blank as an orgasm runs through ` + gC(context.actor).posPr + " body.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 30;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Standard 2
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `${actor}'s whole body contracts as excitement reaches its peak.`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 30;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Vaginal 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `A chill runs through ${actor}'s body as an orgasm erupts from ` + gC(context.actor).posPr + " " + pussyWord() + "."
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 ( (doesAnyActionContainTag(context.extra2,"targetPussy")
			   || doesActorsContinuedActionsInvolveBodypart(context.actor,"pussy")) && gC(context.actor).body.hasOwnProperty("pussy") )
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Vaginal 2
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `${actor}'s ` + pussyWord() + " enters in a delightful tension as it surfs a climax.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 ( (doesAnyActionContainTag(context.extra2,"targetPussy")
			   || doesActorsContinuedActionsInvolveBodypart(context.actor,"pussy")) && gC(context.actor).body.hasOwnProperty("pussy") )
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Vaginal 3
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `A wave of pleasure is born at ${actor}'s ` + pussyWord() + " and gently agitates " + gC(context.actor).posPr + " mind.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 ( (doesAnyActionContainTag(context.extra2,"targetPussy")
			   || doesActorsContinuedActionsInvolveBodypart(context.actor,"pussy")) && gC(context.actor).body.hasOwnProperty("pussy") )
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Scissoring 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `The constant friction erodes the resistance in ${actor}'s mind, and it succumbs to pleasure.`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"pussy","pussy")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Scissoring 2
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `An orgasm takes place in ${actor}'s ` + pussyWord() + ", making " + gC(context.actor).comPr + " believe for a moment that it's fusing with " + gC(context.actor).posPr + " partner's.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"pussy","pussy")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Penetrated pussy 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `A forceful thrust enters ${actor}'s ` + pussyWord() + ` and plunges an orgasm into it, flooding ${actor}'s senses.`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"pussy","dick")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Penetrated pussy 2
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `${actor}'s ` + pussyWord() + " constricts when pleasure rushes through it, enthusiastically eating the " + dickWord() + " inside.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"pussy","dick")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Eaten pussy 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `The tongue caressing ${actor}'s clitoris makes it peak, making ${actor} lose ` + gC(context.actor).posPr + " breath."
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"pussy","mouth")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Eaten pussy 2
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `The constant devouring of ${actor}'s ` + pussyWord() + ` breaks the resistance containing its pleasure, which floods ${actor}'s conscience.`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"pussy","mouth")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Penile 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `${actor}'s ` + dickWord() + " erupts, letting its essence outside."
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 ( (doesAnyActionContainTag(context.extra2,"targetDick")
			   || doesActorsContinuedActionsInvolveBodypart(context.actor,"dick")) && gC(context.actor).body.hasOwnProperty("dick") )
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Penile 2
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `The pleasure defeats ${actor}'s ` + dickWord() + " letting it burst and going loose.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 ( (doesAnyActionContainTag(context.extra2,"targetDick")
			   || doesActorsContinuedActionsInvolveBodypart(context.actor,"dick")) && gC(context.actor).body.hasOwnProperty("dick") )
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Penetrating vagina 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = "Being hugged by " + gC(context.actor).posPr + " partner's " + pussyWord() + `, ${actor}'s ` + dickWord() + " reaches climax and ejaculates inside.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"dick","pussy")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Penetrating vagina 2
	function(context) {
		var actor = gC(context.actor).name;
		var dText = "It isn't long before cum runs out of the " + pussyWord() + ` of ${actor}'s partner, proving ` + gC(context.actor).posPr + " most recent peak.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"dick","pussy")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Penetrating ass 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `The tightness of ${actor}'s partner's ` + assWord() + " proves too much for " + gC(context.actor).posPr + " " + dickWord() + ", which cums inside.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"dick","anus")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Penetrating ass 2
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `${actor}'s ` + dickWord() + " plunges inside, and lets it essence run free.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"dick","anus")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Penetrating mouth 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `The constant licking sends ${actor}'s ` + dickWord() + " over the edge, and it erupts in pleasure.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"dick","mouth")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Penetrating mouth 2
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `Pleasure gets the best out of ${actor}'s ` + dickWord() + ", and it cums into " + gC(context.actor).posPr + " partner's throat.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"dick","mouth")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Targetted ass 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `A chill runs through ${actor}'s back, as an orgasm is born near ` + gC(context.actor).posPr + " rear."
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 ( doesAnyActionContainTag(context.extra2,"targetAnus")
			   || doesActorsContinuedActionsInvolveBodypart(context.actor,"anus") )
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Penetrated ass 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `${actor} reaches ecstasy as ` + gC(context.actor).posPr + " " + assWord() + " gets filled.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"anus","dick")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Penetrated ass 2
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `The drilling of ${actor}'s ` + assWord() + " makes " + gC(context.actor).comPr + " peak, " + gC(context.actor).posPr + " mind succumbing to pleasure.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 doesActorsContinuedActionsInvolveBodypartCombination(context.actor,"anus","dick")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Mindblowing 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `${actor}'s eyes go blank as a most intense pleasure swallows ` + gC(context.actor).comPr + " whole.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 == "mindblowing"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 200;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Mindblowing 2
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `${actor} screams without control as the whole world seems to fade in joy.`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 == "mindblowing"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 200;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Mindblowing 3
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `Shivers and chills embrace and consume ${actor}'s nerves, marking this experience one ` + gC(context.actor).perPr + " won't easily forget.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 == "mindblowing"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 200;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Ruined 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `A small tear falls from ${actor}'s eye as the joy of orgasming runs away from ` + gC(context.actor).posPr + " fingers.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 == "ruined"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Ruined 2
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `Excitement and sorrow both fight to occupy ${actor}'s mind as ` + gC(context.actor).perPr + " accepts that the long-awaited release is not going to come.";
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 == "ruined"
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Ruined vaginal 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `${actor}'s ` + pussyWord() + " aches in frustration as it realizes that it isn't going to reach the climax."
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 charHasLockedBodypart(context.actor,"pussy")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));
setup.dialogDB.orDialogs.push(new dialog( // Ruined penile 1
	function(context) {
		var actor = gC(context.actor).name;
		var dText = `${actor}'s ` + dickWord() + " revolves in pain as it isn't allowed to ejaculate."
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( context.extra1 != "ruined" &&
			 charHasLockedBodypart(context.actor,"dick")
			) { flagValid = true; }
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}));

window.chooseMessageFromList = function(dList,actor,target,extra1,extra2) {
	var chosenDialog = "";
	var context = new dialogContext(actor,target,extra1,extra2);
	var wList = [];
	var i = 0;
	for ( var dialog of dList ) { // If requisites are met, add dialog object to weighted list with valid weight
		if ( dialog.checkReqs(context) ) {
			wList.push(new weightedElement(dialog,dialog.getWeight(context)));
		}
	}
	if ( wList.length > 0 ) {
		var chosenDialog = randomFromWeightedListPercentThreshold(wList,0.2).getDialog(context);
		return chosenDialog;
	} else {
		return chosenDialog;
	}
}

// Auxiliars

window.getRelationalName = function(actor,target) {
	var validNames = [gC(target).name,gC(target).name,gC(target).name];
	var enmityScore = (rLvlAbt(actor,target,"enmity") + rLvlAbt(actor,target,"rivalry") * 0.5 - rLvlAbt(actor,target,"friendship") - rLvlAbt(actor,target,"romance"));
	var submissionScore = rLvlAbt(actor,target,"submission") - rLvlAbt(actor,target,"domination");
	// Enmity
	if ( enmityScore >= 4 ) {
		validNames.push("asshole");
		if ( enmityScore >= 8 ) {
			validNames.push("scum");
		}
	} else {
	// Racial - Flower
		if ( enmityScore < -4 ) {
			if ( gC(actor).race == "leirien" || gC(target).race == "leirien" ) {
				validNames.push("flower");
			}
		}
	// Love
		if ( getCharsDrivePercent(actor,"dLove") > 0.1 ) {
			if ( rLvlAbt(actor,target,"romance") >= 6 ) {
				validNames.push("my love");
			}
		}
	// Submission
		if ( gC(actor).domChar == target || submissionScore >= 8 ) {
			if ( gC(target).perPr == "she" ) {
				validNames.push("mistress");
			} else if ( gC(target).perPr == "he" ) {
				validNames.push("master");
			}
		}
	}
	// Domination
	if ( submissionScore <= -3 && getCharsDrivePercent(actor,"dDomination") > 0.08 && gC(actor).domChar != target ) {
		validNames.push("pet");
		if ( submissionScore <= -5 && getCharsDrivePercent(actor,"dDomination") > 0.12 ) {
			validNames.push("toy");
			if ( gC(target).race == "beastkin" ) {
				validNames.push("kitten");
			}
		}
	}
	if ( (gC(target).domChar == actor || submissionScore <= -7) && getCharsDrivePercent(actor,"dDomination") > 0.15 ) {
		validNames.push("slave");
		validNames.push("servant");
	}
	// Pleasure
	if ( getCharsDrivePercent(actor,"dPleasure") > 0.16 ) {
		if ( rLvlAbt(actor,target,"sexualTension") >= 3 ) {
			if ( gC(target).perPr == "she" ) {
				validNames.push("beautiful");
			} else if ( gC(target).perPr == "he" ) {
				validNames.push("handsome");
			}
			if ( rLvlAbt(actor,target,"sexualTension") >= 6 ) {
				validNames.push("horny " + gC(target).getDiminutive());
				if ( rLvlAbt(actor,target,"sexualTension") >= 9 ) {
					validNames.push("slut");
				}
			}
		}
	}
	return randomFromList(validNames);
}
window.isMissionOnFriendlyGroup = function(missionName) {
	var flag = false;
	if ( missionName == "raiseFriendship" || missionName == "getAlliance" || missionName == "taunt" ) {
		flag = true;
	}
	return flag;
}
window.isMissionOnFlirtyGroup = function(missionName) {
	var flag = false;
	if ( missionName == "flirt" || missionName == "seduce" || missionName == "haveSex" || missionName == "haveDomSex" ) {
		flag = true;
	}
	return flag;
}

// Custom Dialogues
	// Blackmailed by Claw
setup.dialogDB.bbCshutup = [];
setup.dialogDB.bbCshutup.push(new dialog(					// Subbing 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Ah... Hnnh...`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( gC(context.actor).hasLead == false ) {
			flagValid = true;
		}
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}
));
setup.dialogDB.bbCshutup.push(new dialog(					// Subbing 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Slower... Not so fast.`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( gC(context.actor).hasLead == false && getBarPercentage(context.actor,"lust") <= 0.80 ) {
			flagValid = true;
		}
		return flagValid;
	},
	function(context) {
		var weight = 150;
		return weight;
	}
));
setup.dialogDB.bbCshutup.push(new dialog(					// Subbing 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Ah... Calm down...`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( gC(context.actor).hasLead == false && getBarPercentage(context.actor,"lust") <= 0.60 ) {
			flagValid = true;
		}
		return flagValid;
	},
	function(context) {
		var weight = 200;
		return weight;
	}
));
setup.dialogDB.bbCshutup.push(new dialog(					// Subbing 4
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `No! Hmmpf! Hmmmnn!`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( gC(context.actor).hasLead == false && getBarPercentage(context.actor,"lust") <= 0.20 ) {
			flagValid = true;
		}
		return flagValid;
	},
	function(context) {
		var weight = 400;
		return weight;
	}
));

setup.dialogDB.bbCshutup.push(new dialog(					// Domming 1
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `*Cough* *cough*`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( gC(context.actor).hasLead == true ) {
			flagValid = true;
		}
		return flagValid;
	},
	function(context) {
		var weight = 100;
		return weight;
	}
));
setup.dialogDB.bbCshutup.push(new dialog(					// Domming 2
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Hmm, this is feeling good.`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( gC(context.actor).hasLead == true && getBarPercentage(context.actor,"lust") <= 0.65 ) {
			flagValid = true;
		}
		return flagValid;
	},
	function(context) {
		var weight = 200;
		return weight;
	}
));
setup.dialogDB.bbCshutup.push(new dialog(					// Domming 3
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Enjoying yourself, ${relName}? You might want to be careful with your voice.`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( gC(context.actor).hasLead == true && getBarPercentage(context.target,"lust") <= 0.50 ) {
			flagValid = true;
		}
		return flagValid;
	},
	function(context) {
		var weight = 300;
		return weight;
	}
));
setup.dialogDB.bbCshutup.push(new dialog(					// Domming 4
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `It would be really bad if you couldn't contain a shout of joy when you reached climax, wouldn't it?`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( gC(context.actor).hasLead == true && getBarPercentage(context.target,"lust") <= 0.30 ) {
			flagValid = true;
		}
		return flagValid;
	},
	function(context) {
		var weight = 400;
		return weight;
	}
));
setup.dialogDB.bbCshutup.push(new dialog(					// Domming 5
	function(context) {
		var relName = getRelationalName(context.actor,context.target);
		var dText = `Aaah... Yes, this is good. Don't you want to let me hear your moaning?`;
		return dText;
	},
	function(context) {
		var flagValid = false;
		if ( gC(context.actor).hasLead == true && getBarPercentage(context.target,"lust") <= 0.40 && getBarPercentage(context.target,"lust") <= 0.40 ) {
			flagValid = true;
		}
		return flagValid;
	},
	function(context) {
		var weight = 400;
		return weight;
	}
));////////// AI ALGORITHMS RESULTS CLASS //////////
/* These objects return the action Key and the target varNames referring to the action the acting character is going to use. */

window.aiResults = function() {
	this.actionKey = "doNothing";
	this.targetsIDs = [];
};

// Constructors, serializers, etc.
aiResults.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

aiResults.prototype.clone = function () {
	return (new aiResults())._init(this);
};

////////// AI ALGORITHMS CLASS //////////
/* AI Algorithms are objects assigned to a character at the beginning of a scene.
   They hold all the required functions and information to determine the behavior of a given character during the scene. */

window.aiAlgorithm = function() {
	this.key;
	this.callAction = null;
	this.disablePositions = false;
	
	this.role = "none";
	// this.rolePreferences = weightedList
		// rolePreferences refers to a weighted list linked to the role assigned to the character for the scene
		// role and rolePreferences must be set using a custom function.
		// If role isn't set to "none", algorithms that use weighted lists will take rolePreferences into account
	// this.updateRolePreferences = function() // Must be set along with role
		
	this.setRoleEqualFooting = function() {
		this.role = "equalFooting";
		this.rolePreferences = createPreferencesWeightedList();
		this.rolePreferences.position.w = 300;
		this.rolePreferences.foreplay.w = 300;
		this.rolePreferences.continuedAction.w = 200;
		
		this.updateRolePreferences = function(lastActionKey) {
			this.rolePreferences.position.w += 20;
			if ( setup.saList[lastActionKey].flavorTags.includes("position") ) {
				// State.variables.sc.sceneLog += " Decided to use action last turn. Decreasing chance of using positions again. ; ";
				this.rolePreferences.position.w = 0;
			}
			else if ( setup.saList[lastActionKey].flavorTags.includes("continuedAction") ) {
				this.rolePreferences.continuedAction.w = 100;
			}
			if ( this.rolePreferences.foreplay.w > 100 ) {
				this.rolePreferences.foreplay.w -= 40;
			}
			if ( this.rolePreferences.continuedAction.w < 200 ) {
				this.rolePreferences.continuedAction.w += 20;
			}
		}
	}
	this.setRolePassive = function() {
		this.role = "passive";
		this.rolePreferences = createPreferencesWeightedList();
		this.rolePreferences.position.w = 50;
		this.rolePreferences.foreplay.w = 310;
		this.rolePreferences.oral.w = 125;
		this.rolePreferences.useDick.w = 50;
		this.rolePreferences.bottom.w = 200;
		this.rolePreferences.submission.w = 120;
		this.rolePreferences.domination.w = 20;
		this.rolePreferences.top.w = 80;
		this.rolePreferences.charm.w = 120;
		this.rolePreferences.denial.w = 10;
		this.rolePreferences.continuedAction.w = 200;
		
		this.updateRolePreferences = function(lastActionKey) {
			if ( this.rolePreferences.foreplay.w > 110 ) {
				this.rolePreferences.foreplay.w -= 40;
			}
			if ( setup.saList[lastActionKey].flavorTags.includes("continuedAction") ) {
				this.rolePreferences.continuedAction.w = 100;
			}
			if ( this.rolePreferences.continuedAction.w < 200 ) {
				this.rolePreferences.continuedAction.w += 20;
			}
		}
	}
	this.setRoleActive = function() {
		this.role = "active";
		this.rolePreferences = createPreferencesWeightedList();
		this.rolePreferences.position.w = 200;
		this.rolePreferences.fullsex.w = 115;
		this.rolePreferences.talk.w = 105;
		this.rolePreferences.oral.w = 95;
		this.rolePreferences.useDick.w = 125;
		this.rolePreferences.bottom.w = 80;
		this.rolePreferences.submission.w = 20;
		this.rolePreferences.domination.w = 110;
		this.rolePreferences.top.w = 150;
		this.rolePreferences.foreplay.w = 90;
		this.rolePreferences.continuedAction.w = 200;
		this.rolePreferences.denial.w = 110;
		
		this.updateRolePreferences = function(lastActionKey) {
			this.rolePreferences.position.w += 30;	// Position
			if ( setup.saList[lastActionKey].flavorTags.includes("position") ) {
				this.rolePreferences.position.w = 20;
			}
			if ( this.rolePreferences.foreplay.w > 100 ) {	// Foreplay
				this.rolePreferences.foreplay.w -= 20;
			}
			if ( setup.saList[lastActionKey].flavorTags.includes("continuedAction") ) { // Continued Actions
				this.rolePreferences.continuedAction.w = 100;
			}
			if ( this.rolePreferences.continuedAction.w < 200 ) {
				this.rolePreferences.continuedAction.w += 20;
			}
		}
	}
	this.setRoleRomantic = function() {
		this.role = "romantic";
		this.rolePreferences = createPreferencesWeightedList();
		this.rolePreferences.position.w = 200;	
		this.rolePreferences.talk.w = 110;
		this.rolePreferences.useEyes.w = 115;
		this.rolePreferences.targetEyes.w = 115;
		this.rolePreferences.domination.w = 75;
		this.rolePreferences.submission.w = 75;
		this.rolePreferences.useAnus.w = 25;
		this.rolePreferences.targetAnus.w = 25;
		this.rolePreferences.foreplay.w = 320;
		this.rolePreferences.continuedAction.w = 200;
		this.rolePreferences.denial.w = 80;
		
		this.updateRolePreferences = function(lastActionKey) {
			this.rolePreferences.position.w += 20;
			if ( setup.saList[lastActionKey].flavorTags.includes("position") ) {
				this.rolePreferences.position.w = 20;
			}
			if ( this.rolePreferences.foreplay.w > 120 ) {
				this.rolePreferences.foreplay.w -= 40;
			}
			if ( setup.saList[lastActionKey].flavorTags.includes("continuedAction") ) { // Continued Actions
				this.rolePreferences.continuedAction.w = 100;
			}
			if ( this.rolePreferences.continuedAction.w < 200 ) {
				this.rolePreferences.continuedAction.w += 20;
			}
		}
	}
	this.setRoleCompetition = function() {
		this.role = "competition";
		this.rolePreferences = createPreferencesWeightedList();
		this.rolePreferences.position.w = 250;
		this.rolePreferences.foreplay.w = 200;
		this.rolePreferences.talk.w = 80;
		this.rolePreferences.oral.w = 80;
		this.rolePreferences.useDick.w = 110;
		this.rolePreferences.hypnosis.w = 140;
		this.rolePreferences.domination.w = 200;
		this.rolePreferences.top.w = 120;
		this.rolePreferences.bottom.w = 20;
		this.rolePreferences.submission = 10;
		this.rolePreferences.continuedAction.w = 250;
		this.rolePreferences.denial.w = 150;
		
		this.updateRolePreferences = function(lastActionKey) {
			this.rolePreferences.position.w += 40;
			if ( setup.saList[lastActionKey].flavorTags.includes("position") ) {
				this.rolePreferences.position.w = 60;
			}
			if ( this.rolePreferences.foreplay.w > 80 ) {
				this.rolePreferences.foreplay.w -= 40;
			}
			if ( setup.saList[lastActionKey].flavorTags.includes("continuedAction") ) { // Continued Actions
				this.rolePreferences.continuedAction.w = 150;
			}
			if ( this.rolePreferences.continuedAction.w < 250 ) {
				this.rolePreferences.continuedAction.w += 20;
			}
		}
	}
	this.setRoleSubmission = function() {
		this.role = "submission";
		this.rolePreferences = createPreferencesWeightedList();
		this.rolePreferences.position.w = 20;
		this.rolePreferences.foreplay.w = 310;
		this.rolePreferences.oral.w = 110;
		this.rolePreferences.talk.w = 90;
		this.rolePreferences.targetDick.w = 110;
		this.rolePreferences.targetPussy.w = 110;
		this.rolePreferences.usePussy.w = 110;
		this.rolePreferences.useAnus.w = 110;
		this.rolePreferences.useDick.w = 110;
		this.rolePreferences.useMouth.w = 110;
		this.rolePreferences.bottom.w = 150;
		this.rolePreferences.submission.w = 200;
		this.rolePreferences.continuedAction.w = 200;
		this.rolePreferences.denial.w = 10;
		
		this.updateRolePreferences = function(lastActionKey) {
			if ( this.rolePreferences.foreplay.w > 110 ) {
				this.rolePreferences.foreplay.w -= 40;
			}
			if ( setup.saList[lastActionKey].flavorTags.includes("continuedAction") ) { // Continued Actions
				this.rolePreferences.continuedAction.w = 100;
			}
			if ( this.rolePreferences.continuedAction.w < 200 ) {
				this.rolePreferences.continuedAction.w += 20;
			}
		}
	}
	this.setRoleDomination = function() {
		this.role = "domination";
		this.rolePreferences = createPreferencesWeightedList();
		this.rolePreferences.position.w = 300;
		this.rolePreferences.foreplay.w = 220;
		this.rolePreferences.fullsex.w = 150;
		this.rolePreferences.oral.w = 80;
		this.rolePreferences.talk.w = 120;
		this.rolePreferences.useDick.w = 120;
		this.rolePreferences.usePussy.w = 110;
		this.rolePreferences.targetPussy.w = 110;
		this.rolePreferences.targetAnus.w = 110;
		this.rolePreferences.bottom.w = 0;
		this.rolePreferences.submission.w = 0;
		this.rolePreferences.top.w = 120;
		this.rolePreferences.domination.w = 200;
		this.rolePreferences.hypnosis.w = 120;
		this.rolePreferences.usePain.w = 150;
		this.rolePreferences.denial.w = 200;
		this.rolePreferences.continuedAction.w = 200;
		
		this.updateRolePreferences = function(lastActionKey) {
			this.rolePreferences.position.w += 30;
			if ( setup.saList[lastActionKey].flavorTags.includes("position") ) {
				this.rolePreferences.position.w = 20;
			}
			if ( this.rolePreferences.foreplay.w > 100 ) {
				this.rolePreferences.foreplay.w -= 40;
			}
			if ( setup.saList[lastActionKey].flavorTags.includes("continuedAction") ) { // Continued Actions
				this.rolePreferences.continuedAction.w = 100;
			}
			if ( this.rolePreferences.continuedAction.w < 200 ) {
				this.rolePreferences.continuedAction.w += 20;
			}
		}
	}
};

// Early AI algorithms - Sex Scenes
window.createAiFixedAction = function() {
		// This algorithm requires to be manually altered to set the fixed action and the fixed target.
		// It ignores the standard method's variables.
	var ai = new aiAlgorithm();
	ai.key = "fixedAction";
	ai.fixedAction = "doNothing";
	ai.fixedTarget = "chPlayerCharacter";
	ai.callAction = function(character,allyCharacters,enemyCharacters,currentTurn) {
		var results = new aiResults();
		results.actionKey = this.fixedAction;
		results.targetsIDs.push(this.fixedTarget);
		return results;
	}
	return ai;
}
window.createAiActionSequence = function() {
		// This algorithm requires a fixed target and a list of custom actions to be manually set.
		// It commands the user to sequentially use every listed action.
	var ai = new aiAlgorithm();
	ai.key = "actionSequence";
	ai.actionSequence = ["doNothing"];
	ai.fixedTarget = "chPlayerCharacter";
	ai.callAction = function(character,allyCharacters,enemyCharacters,currentTurn) {
		var results = new aiResults();
		results.actionKey = this.actionSequence[currentTurn-1];
		if ( results.actionKey == undefined ) {
			results.actionKey = "doNothing";
		}
		results.targetsIDs.push(this.fixedTarget);
		return results;
	}
	return ai;
}
window.createAiRandomAction = function() {
	var ai = new aiAlgorithm();
	ai.key = "randomAction";
	ai.fixedTarget = "chPlayerCharacter";
	ai.callAction = function(character,allyCharacters,enemyCharacters,currentTurn) {
		var results = new aiResults();
		
		var validActionsList = State.variables.sc.listUsableActions(character);
		validActionsList.shift();
		
		if ( validActionsList.length > 0 ) {
			results.actionKey = randomFromList(validActionsList);
		} else {
			results.actionKey = "doNothing";
		}
		
		results.targetsIDs.push(this.fixedTarget);
		return results;
	}
	return ai;
}

// Early AI algorithms - Battle Scenes
window.createAiRandomActionRandomOpponent = function() {
	var ai = new aiAlgorithm();
	ai.key = "randomAction";
	ai.callAction = function(character,allyCharacters,enemyCharacters,currentTurn) {
		var results = new aiResults();
		var validEnemies = [];
		for ( var enem of enemyCharacters ) {
			if ( gC(enem).koed == false ) {
				validEnemies.push(enem);
			}
		}
		
		if ( validEnemies.length > 0 ) {
			var target = randomFromList(validEnemies);
			
			var validActionsList = State.variables.sc.listUsableActionsOnTarget(character,target);
			validActionsList.shift();
			
			if ( validActionsList.length > 0 ) {
				results.actionKey = randomFromList(validActionsList);
			} else {
				results.actionKey = "doNothing";
			}
			
			results.targetsIDs.push(target);
		} else {
			results.actionKey = "doNothing";
			results.targetsIDs.push(character);
		}
		return results;
	}
	return ai;
}
window.createAiEarlyStrategic = function() { // November 2020 - Last checked April 2021
	var ai = new aiAlgorithm();
	ai.key = "earlyStrategy";
	ai. callAction = function(character,allyCharacters,enemyCharacters,currentTurn) {
		var results = new aiResults();
		var validEnemies = [];
		for ( var enem of enemyCharacters ) {
			if ( gC(enem).koed == false ) {
				validEnemies.push(enem);
			}
		}
		var target = character;
		var directEnemy = "";
		
		// Evaluate situation
			// "desperateAttack" -> Attack without restrain
			// "slowAttack" -> Try and buff oneself, then attack
			// "struggle" -> Get out of here
		// Is actor pinned down or pinning someone down? Are any of them close to defeat?
		// Is target's control depleted, or depleting? Is own control's depleted or depleting?
		// Is there health difference? Is there strength difference? Are buff actions possible?
		
		// On free
		// Is any enemy about to get Koed?
		// Is character about to get Koed?
		// Is there any down character? Should they get pinned down?
		// Are enemies running out of control?
		// Else - Self buff, debuff, attack control, attack
		var situation = "none";
		if ( gC(character).position.type == "free" ) { // Not in a position
			var weakenedEnemies = []; // Enemies with low lust
			var downedEnemies = []; // Enemies without control
			var downingEnemies = []; // Enemies with low control
			for ( var charKey of validEnemies ) {
				if ( getBarPercentage(charKey,"lust") != 0 && getBarPercentage(charKey,"lust") < 0.1 ) {
					weakenedEnemies.push(charKey);
				} else if ( gC(charKey).control == 0 && gC(charKey).position.type == "free" ) {
					downedEnemies.push(charKey);
				} else if ( gC(charKey).control <= gC(charKey).maxControl * 0.7 && gC(charKey).position.type == "free" ) {
					downingEnemies.push(charKey);
				}
			}
				
			if ( weakenedEnemies.length > 0 ) { // Any enemy about to get koed?
				situation = "desperateAttack";
				directEnemy = randomFromList(weakenedEnemies);
			} else if ( getBarPercentage(charKey,"lust") < 0.15 ) { // Character about to get koed?
				situation = "desperateAttack";
				directEnemy = randomFromList(validEnemies);
			} else if ( downedEnemies.length > 0 ) { // Pounce on anyone?
				var validDownedTargets = [];
				if ( gC(character).race == "monster" ) {
					validDownedTargets = downedEnemies;
				} else {
					for ( var charKey of downedEnemies ) {
						if ( (quantifyCharacterStrength(character) / quantifyCharacterStrength(charKey)) >= 0.7 ) {
							validDownedTargets.push(charKey);
						}
					}
				}
				if ( validDownedTargets.length > 0 && gC(character).control > gC(character).maxControl * 0.5 ) {
					situation = "pinTarget";
					directEnemy = randomFromList(validDownedTargets);
				}
			}
			if ( situation == "none" ) {
				if ( downingEnemies.length > 0 ) { // Attack someone's control?
					situation = "attackControl";
					directEnemy = randomFromList(downingEnemies);
				} else {							// Else
					situation = "balanced";
				}
			}
			
		} else if ( gC(character).position.type == "active" ) { // Pinning someone down
			directEnemy = gC(character).position.targetsList[0];
			if ( getBarPercentage(character,"lust") < 0.4 || getBarPercentage(directEnemy,"lust") < 0.4 ) {
				situation = "desperateAttack";
			} else {
				situation = "slowAttack";
			}
		} else { // Pinned down by someone
			// Strategies: Deal as much damage as possible / Struggle / Buff, then deal damage
			directEnemy = gC(character).position.initiator;
			if ( getBarPercentage(character,"lust") < 0.25 || getBarPercentage(directEnemy,"lust") < 0.25 ) {
				situation = "desperateAttack";
			} else if ( getBarPercentage(character,"lust") > 0.5 && ( quantifyCharacterStats(character) / quantifyCharacterStats(directEnemy) ) > 2 ) {
				situation = "slowAttack";
			} else {
				situation = "struggle";
			}
		}
		
		// Situation into choice
		switch ( situation ) {
			case "none":
				break;
			case "balanced":
				var validActionsList = [];
				var buffActions = [];
				var damageActions = [];
				directEnemy = randomFromList(validEnemies);
				if ( countCharactersBuffs(character) < 2 && limitedRandomInt(10) >= 5 ) {
					validActionsList = State.variables.sc.listUsableActionsOnTarget(character,character);
					buffActions = purgeActionsWithoutStrategyTag(validActionsList,"buff");
					if ( buffActions.length > 0 && limitedRandomInt(100) > 49 ) {
						results.actionKey = randomFromList(buffActions);
						results.targetsIDs = [ character ];
					}
				}
				if ( results.actionKey == "doNothing" ) {
					validActionsList = State.variables.sc.listUsableActionsOnTarget(character,directEnemy);
					damageActions = purgeActionsWithoutStrategyTag(validActionsList,"damageControl").concat(purgeActionsWithoutStrategyTag(validActionsList,"damageControl")).concat(purgeActionsWithoutStrategyTag(validActionsList,"debuff"));
					if ( damageActions.length > 0 ) {
						results.actionKey = randomFromList(damageActions);
					} else {
						results.actionKey = randomFromList(validActionsList);
					}
					results.targetsIDs = [ directEnemy ];
				}
				break;
			case "attackControl":
				// Pounce check
				directEnemy = randomFromList(downingEnemies);
				validActionsList = State.variables.sc.listUsableActionsOnTarget(character,directEnemy);
				damageActions = purgeActionsWithoutStrategyTag(validActionsList,"pounce");
				var betterActions = purgeActionsWithStrategyTag(damageActions,"subpar");
				if ( damageActions.length > betterActions.length ) { damageActions = betterActions; }
				if ( damageActions.length > 0 ) {
					var randomPounce = randomFromList(damageActions);
					if ( setup.saList[randomPounce].doesHitLand(character,directEnemy).hit && setup.saList[randomPounce].doesHitLand(character,directEnemy).hit ) {
						results.actionKey = randomPounce;
						results.targetsIDs = [ directEnemy ];
					}
				}
				if ( results.actionKey == "doNothing" ) {
					damageActions = purgeActionsWithoutStrategyTag(validActionsList,"damageControl");
					if ( damageActions.length > 0 ) {
						results.actionKey = randomFromList(damageActions);
						results.targetsIDs = [ directEnemy ];
					}
				}
				if ( results.actionKey == "doNothing" ) {
					damageActions = purgeActionsWithoutStrategyTag(validActionsList,"damage").concat(purgeActionsWithoutStrategyTag(validActionsList,"debuff"));
					if ( damageActions.length > 0 ) {
						results.actionKey = randomFromList(damageActions);
						results.targetsIDs = [ directEnemy ];
					}
				}
				break;
			case "pinTarget":
				directEnemy = randomFromList(downedEnemies);
				validActionsList = State.variables.sc.listUsableActionsOnTarget(character,directEnemy);
				damageActions = purgeActionsWithoutStrategyTag(validActionsList,"pounce");
				var betterActions = purgeActionsWithoutStrategyTag(damageActions,"subpar");
				if ( damageActions.length > betterActions.length ) { damageActions = betterActions; }
				if ( damageActions.length > 0 ) {
					results.actionKey = randomFromList(damageActions);
					results.targetsIDs = [ directEnemy ];
				}
				break;
			case "desperateAttack":
				var validActionsList = State.variables.sc.listUsableActionsOnTarget(character,directEnemy);
				var damageActions = purgeActionsWithoutStrategyTag(validActionsList,"damage");
				if ( damageActions.length > 0 ) {
					results.actionKey = randomFromList(damageActions);
				} else if ( validActionsList.length > 0 ) {
					results.actionKey = randomFromList(validActionsList);
				} else {
					results.actionKey = "struggle";
				}
				results.targetsIDs = [ directEnemy ];
				break;
			case "slowAttack":
				var validActionsList = [];
				if ( countCharactersBuffs(character) < 1 ) {
					validActionsList = State.variables.sc.listUsableActionsOnTarget(character,character);
					var buffActions = purgeActionsWithoutStrategyTag(validActionsList,"buff");
					if ( buffActions.length > 0 ) {
						results.actionKey = randomFromList(buffActions);
						results.targetsIDs = [ character ];
					}
					if ( results.actionKey == "doNothing" ) {
						validActionsList = State.variables.sc.listUsableActionsOnTarget(character,directEnemy);
						var damageActions = purgeActionsWithoutStrategyTag(validActionsList,"damage").concat(purgeActionsWithoutStrategyTag(validActionsList,"debuff"));
						results.actionKey = randomFromList(damageActions);
						results.targetsIDs = [ directEnemy ];
					}
				}
				break;
			case "struggle":
				results.actionKey = "struggle";
				results.targetsIDs = [ directEnemy ];
				break;
		}
		
		// TO DO : Remove all of this
		if ( results.actionKey == "doNothing" || results.actionKey == undefined ) {
			if ( validEnemies.length > 0 ) {
				var target = randomFromList(validEnemies);
				
				var validActionsList = State.variables.sc.listUsableActionsOnTarget(character,target);
				validActionsList.shift();
				
				if ( validActionsList.length > 0 ) {
					results.actionKey = randomFromList(validActionsList);
				} else {
					results.actionKey = "doNothing";
				}
				
				results.targetsIDs = [ target ];
			} else {
				results.actionKey = "doNothing";
				results.targetsIDs = [ character ];
			}
		}
		
		return results;
	}
	return ai;
}

// AI Algorithm useful in some scripted sex scenes
window.createAiRandomChoice = function(choicesList) {
	// Choices list must be a list of two elements list, first element contains target, second element contains action key
	// Example: "[ ["chVal","strokePussy"] , ["chVal","strokeBreasts"] , ["chMir","spanking"] ]"
	var ai = new aiAlgorithm();
	ai.key = "randomChoice";
	ai.choicesList = choicesList;
	ai.callAction = function(character,allyCharacters,enemyCharacters,currentTurn) {
		var results = new aiResults();
		
		var randomInt = limitedRandomInt(choicesList.length - 1); 
		results.actionKey = this.choicesList[randomInt][1];
		results.targetsIDs = [ this.choicesList[randomInt][0] ];
		
		return results;
	}
	return ai;
}

// OLD GENERIC AI ALGORITHM - SEX SCENES
window.createAiWeightedActionByTaste = function() {
	var ai = new aiAlgorithm();
	ai.key = "weightedByTaste";
	ai.fixedTarget = "chPlayerCharacter";
	ai.callAction = function(character,allyCharacters,enemyCharacters,currentTurn) {
		var results = new aiResults();
		
		results.targetsIDs.push(this.fixedTarget);
		
		var validActionsList = State.variables.sc.listUsableActionsOnTarget(character,this.fixedTarget);
		validActionsList.shift();
		
		if ( validActionsList.length > 0 ) {
			var wList = listIntoWeightedList(validActionsList);
			
			for ( var item in wList ) {
				if (wList.hasOwnProperty(item) ) {
					wList[item].w = applyTasteWeightToAction(wList[item],character); // Taste weighted
				}
			}
			if ( this.role != "none" ) {
				wList = applyWeightListToActionList(wList,this.rolePreferences);
			}
			
			results.actionKey = randomFromWeightedList(wList);
			if ( results.actionKey == "errorWList" ) {
				results.actionKey = "doNothing";
			}
		} else {
			results.actionKey = "doNothing";
		}
			
		if ( this.role != "none" ) {
			this.updateRolePreferences(results.actionKey);
		}
				
		return results;
	}
	return ai;
}

// OLD GENERIC AI ALGORITHM - SEX SCENES - 07-2020 - Last updated: 04-2021
window.createAiWeightedMissionsByTasteOld = function() {
	var ai = new aiAlgorithm();
	ai.key = "weightedMissions";
	ai.mission = "none";
	ai.missionCommands = [];
	ai.callAction = function(character,allyCharacters,enemyCharacters,currentTurn) {
		
		var results = new aiResults();
		results.targetsIDs = ([chooseTargetDynamically(character,allyCharacters,enemyCharacters)]);
		var dice = 0;
		
		if ( gC(character).hasLead == true ) {
			dice = limitedRandomInt(1);
			if ( dice == 1 ) {
				if ( this.missionCommands.length < 1 && ( limitedRandomInt(2) < 1 ) ) {
					this.mission = "none";					
				}
				if ( this.mission == "none" ) {
					var possibleMissions = randomFromList(returnValidSexSceneMissions(character,results.targetsIDs[0]));
					if ( possibleMissions != undefined ) {
						this.mission = possibleMissions;
						this.missionCommands = returnSexSceneMissionCommands(this.mission);
					} else {
						dice = 0;
					}
					if ( State.variables.sc.sceneConditions.includes("cantChangePositions") == false && State.variables.sc.sceneConditions.includes("cantCancelPositions") == false ) {
						State.variables.sc.cancelPosition(character);
					}
				}
				if ( this.missionCommands.length < 1 ) {
					dice = 0;
				} else {
					if ( isActionUsable(this.missionCommands[0],character,results.targetsIDs,false).isUsable ) {
						results.actionKey = this.missionCommands[0];
					} else {
						dice = 0;
					}
					this.missionCommands.shift();
				}
			}
		}
		if ( gC(character).hasLead == false || dice == 0 ) { // Typical behavior from weightedActionByTaste
			var validActionsList = State.variables.sc.listUsableActionsOnTarget(character,results.targetsIDs[0]);
			// Purge denial if target isn't close to orgasm
			if ( getBarPercentage(results.targetsIDs[0],"lust") > 0.1 || character == results.targetsIDs[0] ) {
				validActionsList = purgeActionsWithPreferenceTag(validActionsList,"denial");
			}
			validActionsList.shift();
		
			if ( validActionsList.length > 0 ) {
				var wList = listIntoWeightedList(validActionsList);
				
				for ( var item in wList ) {
					if (wList.hasOwnProperty(item) ) {
						wList[item].w = applyTasteWeightToAction(wList[item],character); // Taste weighted
						// Positional actions must not be chosen here, this portion removes their priority
						if ( setup.saList[wList[item].content].tags.includes("pos") ) {
							wList[item].w = 0;
						}
						// if ( setup.saList[wItem.content].flavorTags.includes(character.tastes[taste].content) ) {
					}
				}
				if ( this.role != "none" ) {
					wList = applyWeightListToActionList(wList,this.rolePreferences);
				}
				
				results.actionKey = randomFromWeightedList(wList);
				if ( results.actionKey == "errorWList" ) {
					results.actionKey = "doNothing";
				}
			} else {
				results.actionKey = "doNothing";
			}
		} else {
		}
		//var validActionsList = State.variables.sc.listUsableActionsOnTarget(character.varName
		
		return results;
	}
	return ai;
}

// NEW GENERIC AI ALGORITHM - SEX SCENES - 06-2021 - Last updated: 01-2021
window.createAiWeightedMissionsByTaste = function() {
	var ai = new aiAlgorithm();
	ai.key = "weightedMissions";
	ai.mission = "none";
	ai.missionCommands = []; // List of 2-sized arrays: {1st position is action, 2nd position is target}
	ai.callAction = function(character,allyCharacters,enemyCharacters,currentTurn) {
		var results = new aiResults();
		
		var tfScAlMs = true; // Shortcut to reduce frequency of choosing missions during tf scenes
		if ( gC(character).hasLead && State.variables.sc.hasOwnProperty("tfFlag") ) {
			if ( limitedRandomInt(64) > 48 ) {
				tfScAlMs = false;
			}
		}
		if ( gC(character).hasLead && State.variables.sc.sceneConditions.includes("cantChangePositions") == false && State.variables.sc.sceneConditions.includes("cantCancelPositions") == false && tfScAlMs == true ) {
			if ( this.missionCommands.length > 0 ) {
				// At this point "cancel" and "stay" commands shouldn't remain
				results.actionKey = this.missionCommands[0][0];
				results.targetsIDs = [this.missionCommands[0][1]];
				this.missionCommands.shift();
			} else {
				// Check canceleable continued actions
				if ( limitedRandomInt(100) < 5 ) {
					cancelAllCharActionsAndPositions(character);
				} else {
					charEvaluatesContinuedActionsToCancel(character);
					if ( State.variables.sc.hasOwnProperty("tfFlag") ) {
						cancelActionsConflictingWithTf(character);
					}
				}
				if ( isCharInPrimaryContinuedAction(character) ) {
					results = chooseValidBasicAction(character,allyCharacters,enemyCharacters);
				} else {
					if ( true ) {
						var mission = chooseCaMission(character,allyCharacters,enemyCharacters);
						if ( mission != "errorWList" ) {
							if ( mission != undefined && mission[0] != "" ) {
								if ( mission[2] == "stay" ) {
									// Skip position action
									this.missionCommands = [[mission[0],mission[1]]];
									results.actionKey = this.missionCommands[0][0];
									results.targetsIDs = [this.missionCommands[0][1]];
									this.missionCommands.shift();
								} else if ( mission[2] == "cancel" ) {
									// Cancel position and skip position action
									State.variables.sc.cancelPosition(character);
									this.missionCommands = [[mission[0],mission[1]]];
									results.actionKey = this.missionCommands[0][0];
									results.targetsIDs = [this.missionCommands[0][1]];
									this.missionCommands.shift();
								} else {
									this.missionCommands = [[mission[2],mission[1]],[mission[0],mission[1]]];
									results.actionKey = this.missionCommands[0][0];
									results.targetsIDs = [this.missionCommands[0][1]];
									this.missionCommands.shift();
								}
							}
						} else {
							results = chooseValidBasicAction(character,allyCharacters,enemyCharacters);
						}
					} else {
						results = chooseValidBasicAction(character,allyCharacters,enemyCharacters);
					}
				}
			}
		} else {
			this.missionCommands = [];
			results = chooseValidBasicAction(character,allyCharacters,enemyCharacters);
		}
		
		return results;
	}
	return ai;
}

// BASIC BATTLE AI ALGORITHM - SEX BATTLE SCENES - 08-2020
/*
window.createAiRandomActions = function() {
	var ai = new aiAlgorithm();
	ai.key = "randomActions";
	ai.callAction = function(character,allyCharacters,enemyCharacters,currentTurn) {
		var results = new aiResults();
		results.targetsIDs = [ enemyCharacters[0] ];
		
		
		
		return results;
	}
} */
// createAiRandomAction <-

// Auxiliar functions
window.chooseValidBasicAction = function(actor,allyCharacters,enemyCharacters) {
	var results = new aiResults();
	results.targetsIDs = [actor];
	results.actionKey = "doNothing";
	
	var allOtherCharacters = arrayMinusA(allyCharacters.concat(enemyCharacters),actor);
	
	// Actions on self
	var actionsOnSelf = listValidBasicActionsOnTarget(actor,actor); // Simple list of actions
		// Purge denial actions
		actionsOnSelf = purgeActionsWithPreferenceTag(actionsOnSelf,"denial");
	// Actions on others
	var nwActionsOnOthers = listTargetedWeightedActionListOnCharacters(actor,allOtherCharacters); // List of [target/action/weight=0]
	
		// What's this thing below? - wL = Weighted list of [t/a/w], wE = Weighted choice of [t/a] (I assume)
	
	// Are actions on self possible? Are actions on others possible?
	if ( actionsOnSelf.length == 0 && nwActionsOnOthers.length == 0 ) {
		// No actions possible
	} else if ( actionsOnSelf.length == 0 ) {
		// Only actions on others possible
		var wL = assignWeightsToTargetedWeightedActionList(actor,nwActionsOnOthers);
		var wE = randomFromWeightedList(wL);
		results.targetsIDs = [wE[0]];
		results.actionKey = wE[1];
	} else if ( nwActionsOnOthers.length == 0 ) {
		// Only actions on self possible
		var wL = assignWeightsToSelfTargetedActionList(actor,actionsOnSelf);
		var wE = randomFromWeightedList(wL);
		results.targetsIDs = [actor];
		results.actionKey = wE;
	} else {
		// Both actions on self and others possible
		if ( actorChoosesWhetherToActOnSelf(actor) ) {
			// Acts on self
			var wL = assignWeightsToSelfTargetedActionList(actor,actionsOnSelf);
			var wE = randomFromWeightedList(wL);
			results.targetsIDs = [actor];
			results.actionKey = wE;
		} else {
			// Acts on others
			var wL = assignWeightsToTargetedWeightedActionList(actor,nwActionsOnOthers);
			var wE = randomFromWeightedList(wL);
			results.targetsIDs = [wE[0]];
			results.actionKey = wE[1];
		}
	}
	
	
	return results;
}

	// Basic actions
window.listValidBasicActionsOnTarget = function(actor,target) {
	var aList = State.variables.sc.listUsableActionsOnTarget(actor,target);
	aList = purgeActionsWithPreferenceTag(aList,"position");
	aList = arrayMinusA(aList,"doNothing");
	return aList;
	// Example of aList = ["baKissLips", "baStrokePussy", "pounceFrontalP2P", "kick", "taunt", "baTease"];
}
window.simulateListValidBasicActionsOnTargetDuringCombat = function(actor,target) {
	// Previous scene data
	var oriSceneType = State.variables.sc.sceneType;
	var oriTeamAchars = State.variables.sc.teamAcharKeys; 
	var oriTeamBchars = State.variables.sc.teamBcharKeys;
	
	// Simulate scene data
	State.variables.sc.sceneType = "bs";
	State.variables.sc.teamAcharKeys = [actor]; 
	State.variables.sc.teamBcharKeys = [target];
	
	var aList = State.variables.sc.listUsableActionsOnTarget(actor,target);
	aList = purgeActionsWithPreferenceTag(aList,"position");
	aList = arrayMinusA(aList,"doNothing");
	
	// Restore scene data
	State.variables.sc.sceneType = oriSceneType;
	State.variables.sc.teamAcharKeys = oriTeamAchars; 
	State.variables.sc.teamBcharKeys = oriTeamBchars;
	
	return aList;
	// Example of aList = ["baKissLips", "baStrokePussy", "pounceFrontalP2P", "kick", "taunt", "baTease"];
}
window.listTargetedWeightedActionListOnCharacters = function(actor,targets) {
	var totalList = [];
	for ( var cK of targets ) {
		var vba = listValidBasicActionsOnTarget(actor,cK);
		totalList = totalList.concat(actionListIntoTargetedWeightedActionlist(vba,cK));
	}
	return totalList;
}
window.actionListIntoTargetedWeightedActionlist = function(actionList,target) {
	var aList = [];
	for ( var a of actionList ) {
		aList.push([target,a,0]);
	}
	return aList;
}

window.assignWeightsToSelfTargetedActionList = function(actor,actionlist) {
	// RETURNS WEIGHTED LIST
	// To evalute: character tastes (weights and ranks, character desires)
	var pActions = State.variables.sc.listUsableActionsOnTarget(actor,actor);
	var desires = getActorsCurrentDesires(actor);
	var wL = new weightedList();
	for ( var a of pActions ) {
		wL[a] = new weightedRankedElement(a,assignWeightToActionFromActorToTargetWithDesires(a,actor,actor,desires,1));
	}
	// Content: actionKey
	return wL;
}
window.assignWeightsToTargetedWeightedActionList = function(actor,twaList) {
	// RETURNS WEIGHTED LIST
	// To evaluate: character tastes (weights and ranks), character desires, - NOT target's preference -
	var desires = getActorsCurrentDesires(actor);
	var targetsMultipliers = [];
	var wL = new weightedList();
	var i = 0;
	for ( var twa of twaList ) {
		var mult = 1;
		if ( targetsMultipliers.hasOwnProperty(twa[0]) ) {
			mult = targetsMultipliers[twa[0]];
		} else {
			targetsMultipliers[twa[0]] = 1;
			if ( gC(twa[0]).orgasmSceneCounter == 0 ) {
				targetsMultipliers[twa[0]] = 2;
			}
			mult = targetsMultipliers[twa[0]];
		}
		wL[i] = new weightedElement([twa[0],twa[1]],assignWeightToActionFromActorToTargetWithDesires(twa[1],actor,twa[0],desires,mult));
		i++;
	}
	// Content: [targetKey,actionKey],weight
	return wL;
}

window.assignWeightToActionFromActorToTargetWithDesires = function(action,actor,target,desires,mult) {
	var weight = 10 + limitedRandomInt(10);
	var newMult = 1;
	var desiresMultiplier = 1;
	var targetDesires = getActorsCurrentDesires(target);
	
	// Denial check
	if ( setup.saList[action].flavorTags.includes("denial") && getBarPercentage(target,"lust") > 0.15 ) {
		weight = 0;
	} else {
		for ( var taste of setup.saList[action].flavorTags ) {
			// Base preference
			weight *= setup.basePreferencesMultipliers[taste];
			var extraM = 1;
			if ( taste == "foreplay" || taste == "talk" || taste == "oral" || taste == "fullsex" ) {
				extraM = 0.5;
			}
			// Weights and ranks
			if ( taste != "position" && taste != "continuedAction" ) {
				newMult += gC(actor).tastes[taste].w * 0.01;
				newMult += (1 + gC(actor).tastes[taste].r * 0.5);
				newMult *= extraM;
			}
			// Desires
			if ( desires.includes(taste) ) {
				desiresMultiplier += (0.5 * extraM);
			}
			if ( targetDesires.includes(getOppositeTag(taste)) ) {
				desiresMultiplier += (0.25 * extraM);
			}		
		}
		weight *= (newMult + desiresMultiplier + mult);
	}
	if ( weight > 0 && State.variables.sc.hasOwnProperty("tfFlag") ) {
		if ( setup.saList[action].strategyTags.includes("tfPlus") ) {
			weight *= 5;
		} else if ( setup.saList[action].strategyTags.includes("tfPlus") ) {
			weight *= 2;
		} else if ( setup.saList[action].strategyTags.includes("tfMinus") ) {
			weight /= 5;
		}
	}
	
	return weight;
}

	// Choose target
window.chooseTargetDynamically = function(character,allyCharacters,enemyCharacters) { // Updated 04-2021
	var mainTarget = "";
	
	var validActionsOnSelf = State.variables.sc.listUsableActionsOnTarget(character,character);
	var allOtherCharacters = arrayMinusA(allyCharacters.concat(enemyCharacters),character);
	// mainTarget = randomFromList(allOtherCharacters);
	
	if ( validActionsOnSelf.length > 1 ) {
		var threshold = 15;
		var loveMinusPleasure = getCharsDrivePercent(character,"dLove") - getCharsDrivePercent(character,"dPleasure");
		if ( loveMinusPleasure >= 0.1 ) {
			threshold = 10;
		} else if ( loveMinusPleasure <= -0.1 ) {
			threshold = 20;
		}
		
		if ( limitedRandomInt(100) > threshold ) {
		} else {
			mainTarget = character;
		}
	}
	
	if ( mainTarget == "" ) {
		for ( var cK of allOtherCharacters ) {
			if ( State.variables.sc.listUsableActionsOnTarget(character,cK).length < 2 ) {
				allOtherCharacters = arrayMinusA(allOtherCharacters,cK);
			}
		}
		if ( allOtherCharacters.length > 0 ) {
			mainTarget = randomFromList(allOtherCharacters);
		} else {
			mainTarget = character;
		}
	}
	
	return mainTarget;
}
window.actorChoosesWhetherToActOnSelf = function(character) {
	var actsOnSelf = false;
	
		var threshold = 15;
		var loveMinusPleasure = getCharsDrivePercent(character,"dLove") - getCharsDrivePercent(character,"dPleasure");
		if ( loveMinusPleasure >= 0.1 ) {
			threshold = 10;
		} else if ( loveMinusPleasure <= -0.1 ) {
			threshold = 20;
		}
		
		if ( limitedRandomInt(100) > threshold ) {
		} else {
			actsOnSelf = true;;
		}
		
	return actsOnSelf;
}

	// Aux
window.getActorsCurrentDesires = function(actor) {
	var tagsList = [];
	for ( var as of gC(actor).alteredStates ) {
		if ( as.hasOwnProperty("tag") ) {
			tagsList.push(as.tag);
		}
	}
	return tagsList;
}

window.charEvaluatesContinuedActionsToCancel = function(actor) {
	var casToRemove = [];
	var flagCancelPosition = false;
	var i = 0;
	for ( var ca of State.variables.sc.continuedActions ) {
		if ( ca.initiator == actor || ca.targetsList.includes(actor) ) {
			var cancelChance = 0;
			if ( ca.rank == 2 ) {
				cancelChance = -140 + ca.continuedTurns * 20;
			} else {
				cancelChance = -80 + ca.continuedTurns * 20;
			}
			for ( var tag of ca.flavorTags ) {
				cancelChance -= gC(actor).tastes[tag].r * 5;
			}
			if ( cancelChance > limitedRandomInt(100) ) {
				// Tick to cancel action
				casToRemove = [i].concat(casToRemove);
				if ( ca.rank == 2 ) {
					if ( gC(actor).aiAlgorythm.missionCommands.length == 0 ) {
						if ( limitedRandomInt(100) > 50 ) {
							flagCancelPosition = true;
						}
					}
				}
			}
		}
		i++;
	}
	// Finish CAs in reverse order
	for ( var id of casToRemove ) {
		State.variables.sc.removeContinuedAction(id);
	}
	if ( flagCancelPosition ) {
		State.variables.sc.cancelPosition(actor);
	}
}
window.cancelAllCharActionsAndPositions = function(actor) {
	var casToRemove = [];
	var i = 0;
	for ( var ca of State.variables.sc.continuedActions ) {
		if ( ca.initiator == actor || ca.targetsList.includes(actor) ) {
			casToRemove = [i].concat(casToRemove);
		}
		i++;
	}
	// Finish CAs in reverse order
	for ( var id of casToRemove ) {
		State.variables.sc.removeContinuedAction(id);
	}
	State.variables.sc.cancelPosition(actor);
}

window.cancelActionsConflictingWithTf = function(actor) {
	if ( actor != State.variables.sc.tfTarget ) {
		var tfActions = [];
		var requiredTargetBps = [];
		var requiredActorBps = [];
		var conflictingContinuedActions = []; // Reverse position iterators
		
		// Get all tfActions from a tfActor
		for ( var sa of gC(State.variables.sc.tfActors[0]).saList ) {
			if ( setup.saList[sa].tags.includes("tf") ) {
				tfActions.push(sa);
				// Get all requiredBps
				for ( var bp of setup.saList[sa].targetBpReqs ) {
					if ( requiredTargetBps.includes(bp) == false ) {
						requiredTargetBps.push(bp);
					}
				}
				for ( var bp of setup.saList[sa].actorBpReqs ) {
					if ( requiredActorBps.includes(bp) == false ) {
						requiredActorBps.push(bp);
					}
				}
			}
		}
		// Get all conflictingContinuedActions
		var i = 0;
		for ( var cA of State.variables.sc.continuedActions ) {
			var selectedCa = false;
			if ( cA.initiator == actor ) {
				if ( cA.targetsList.includes(State.variables.sc.tfTarget) ) {
					for ( var tBp of cA.targetsBodyparts ) {
						if ( requiredTargetBps.includes(tBp) ) {
							conflictingContinuedActions = [i].concat(conflictingContinuedActions);
							selectedCa = true;
						}
					}
				}
				if ( selectedCa == false ) {
					for ( var aBp of cA.initiatorBodyparts ) {
						if ( requiredActorBps.includes(aBp) ) {
							conflictingContinuedActions = [i].concat(conflictingContinuedActions);
						}
					}
				}
				i++;
			}
		}
		// Cancel all conflictingContinuedActions in reverse order
		for ( var id of conflictingContinuedActions ) {
			State.variables.sc.removeContinuedAction(id);
		}
	}
}

	// Continued actions pathfinder
window.chooseCaMission = function(actor,allyCharacters,enemyCharacters) {
	var allOtherCharacters = arrayMinusA(allyCharacters.concat(enemyCharacters),actor);
	var aOCcopy = allOtherCharacters;
	var primaryCAlist = []; // Each usable CA is a property, containing a list with all valid positionings
	var caUnweightedList = [];
	var knownPrimaryCactions = getCharsPrimaryContinuedActions(actor); // Get known primary CAs
	var potentialPositions = [];
	for ( var target of aOCcopy ) {
		// Get all potential positions
		potentialPositions = potentialPositions.concat(findAllPotentialPositions(actor,target));
	}	
	// Generate primaryCAlist
	for ( var posPair of potentialPositions ) {
		for ( var ca of knownPrimaryCactions ) {
			target = posPair[3];
			if ( isActionUsableOnPos(ca,actor,[posPair[3]],posPair[0],[posPair[1]]).isUsable ) {
				if ( primaryCAlist.hasOwnProperty(ca) ) {
					if ( primaryCAlist[ca].hasOwnProperty(target) ) {
						primaryCAlist[ca][target].push(posPair[2]);
					} else {
						primaryCAlist[ca][target] = [posPair[2]];
					}
				} else {
					primaryCAlist.push(ca);
					primaryCAlist[ca] = [];
					if ( primaryCAlist[ca].hasOwnProperty(target) ) {
						primaryCAlist[ca][target].push(posPair[2]);
					} else {
						primaryCAlist[ca][target] = [posPair[2]];
					}
					//primaryCAlist[ca] = [posPair];
				}
			}
		}
	}
	// Example of primaryCAlist:
	//  "penetratePussy": Array(0) ["chPlayerCharacter": Array(2) ["mountFaceToFace", "mountFromBehind"]],
	//  "interlockLegs": Array(0) ["chPlayerCharacter": Array(2) ["mountFaceToFace", "mountFromBehind"]]
	
	for ( var cae of primaryCAlist ) {
		var caeData = primaryCAlist[cae];
		for ( var target of aOCcopy ) {
			if ( caeData.hasOwnProperty(target) ) {
				var firstMethod = caeData[target][0];
				if ( firstMethod == "cancel" || firstMethod == "stay" ) {
					caUnweightedList.push([cae,target,firstMethod]);
				} else {
					caUnweightedList.push([cae,target,randomFromList(caeData[target])]);
				}
			}
		}
	}
	// Example of caUnweightedList:
	// Array(2) [Array(3) ["penetratePussy", "chVal", "mountFromBehind"], Array(3) ["penetratePussy", "chPlayerCharacter", "mountFaceToFace"]]
	
	// Exception: if valid conditions, remove cAs conflicting with transformation
	if ( State.variables.sc.hasOwnProperty("tfFlag") ) {
		caUnweightedList = purgeCAsConflictingWithTransformationGoals(caUnweightedList,actor);
	}
	
	// Generate weighted list
	var wL = createWeightedListOfCaChoices(actor,caUnweightedList);
	// Choose mission and translate it into instructions
	var mission = randomFromWeightedList(wL);
	
	return mission;
}

window.findAllPotentialPositions = function(actor,target) {
	var positions = [];
	if ( areCharactersLinked(actor,target) ) {
		positions.push([gC(actor).position.key,gC(target).position.key,"stay",target]);
		positions.push(["free","free","cancel",target]);
	} else if ( gC(actor).position.key == "free" && gC(target).position.key == "free" ) {
		positions.push(["free","free","stay",target]);
	}
	// Get all position actions known by actor
	var positionActions = purgeActionsWithoutPreferenceTag(gC(actor).saList,"position");
	// Filter usable position actions
	var usablePositionActions = [];
	if ( gC(actor).aiAlgorythm.disablePositions == false ) {
		for ( var pA of positionActions ) {
			if ( State.variables.sc.hasOwnProperty("tfFlag") == false || setup.saList[pA].strategyTags.includes("tfPos") ) {
				if ( isActionUsable(pA,actor,[target],false).isUsable ) {
					usablePositionActions.push(pA);
				} else if ( areCharactersLinked(actor,target) && isActionUsableOnPos(pA,actor,[target],"free",["free"]).isUsable ) {
				//	usablePositionActions.push(pA);
				}
			}
		}
	}
	// Add position results from usable position actions
	for ( var uPA of usablePositionActions ) {
		if ( setup.saList[uPA].hasOwnProperty("positionResults") ) {
			positions.push(setup.saList[uPA].positionResults.concat(uPA,target));
		}
	}
	// Third element: keyword to reach position pair
	// "stay": do not change positions ; "cancel": cancel current positioning
	// Fourth element: Target
	return positions;
}
window.getCharsPrimaryContinuedActions = function(charKey) {
	var pca = [];
	var caList = purgeActionsWithoutPreferenceTag(gC(charKey).saList,"continuedAction");
	for ( var ca of caList ) {
		if ( setup.saList[ca].hasOwnProperty("caRank") ) {
			if ( setup.saList[ca].caRank == 2 ) {
				pca.push(ca);
			}
		}
	}
	return pca;
}

window.createWeightedListOfCaChoices = function(actor,caPosChoicesList) {
	// To evaluate: character tastes (weights and ranks), character desires, - NOT target's preference -
	var desires = getActorsCurrentDesires(actor);
	var targetsMultipliers = [];
	var wL = new weightedList();
	
	var i = 0;
	for ( var capCh of caPosChoicesList ) {
		var mult = 1;
		var target = capCh[1];
		if ( targetsMultipliers.hasOwnProperty(target) ) {
			mult = targetsMultipliers[target];
		} else {
			targetsMultipliers[target] = 1;
			if ( gC(target).orgasmSceneCounter == 0 ) {
				targetsMultipliers[target] = 2;
			}
			mult = targetsMultipliers[target];
		}
		wL[i] = new weightedElement(capCh,assignWeightToActionFromActorToTargetWithDesires(capCh[0],actor,target,desires,mult));
		i++;
	}
	
	return wL;
}

///// Old or combat

	// Missions
window.returnValidSexSceneMissions = function(character,target) {
	// Very cheap version, this function will be upgraded into a full system
	var validMissions = [];
	if ( gC(character).hasFreeBodypart("dick") && gC(target).hasFreeBodypart("pussy") ) {
		validMissions.push("penetratePussy");
	}
	if ( gC(character).hasFreeBodypart("pussy") && gC(target).hasFreeBodypart("pussy") ) {
		validMissions.push("scissor");
	}
	if ( gC(character).hasFreeBodypart("dick") && gC(target).hasFreeBodypart("pussy") && gC(target).hasFreeBodypart("anus") && gC(character).race == "shapeshifter" && gC(character).saList.includes("doublePenetration") && State.variables.settings.anal == "enable" ) {
		validMissions.push("doublePenetration");
	}
	if ( gC(character).hasFreeBodypart("dick") && gC(target).hasFreeBodypart("mouth") ) {
		validMissions.push("getBlowjob");
	}
	if ( gC(character).hasFreeBodypart("pussy") && gC(target).hasFreeBodypart("mouth") ) {
		validMissions.push("getCunnilingus");
	}
	return validMissions;
}
window.returnSexSceneMissionCommands = function(missionKey) {
	var commandsChain = [];
	switch(missionKey) {
		case "penetratePussy":
			commandsChain.push(randomFromList(["mountFromBehind","mountFaceToFace"]));
			commandsChain.push("penetratePussy");
			break;
		case "doublePenetration":
			commandsChain.push(randomFromList(["mountFromBehind","mountFaceToFace"]));
			commandsChain.push("doublePenetration");
			break;
		case "scissor":
			commandsChain.push("mountFaceToFace");
			commandsChain.push("interlockLegs");
			break;
		case "getBlowjob":
			commandsChain.push("makeKneel");
			commandsChain.push("getBlowjob");
			break;
		case "getCunnilingus":
			commandsChain.push("makeKneel");
			commandsChain.push("legHoldHead");
			break;
	}
	return commandsChain;
}

	// Weight
window.applyWeightListToActionList = function(actList,wgtList) {
	var actList2 = actList;
	
	for ( var action in actList2 ) {
		if ( actList2.hasOwnProperty(action) ) {
			for ( var weight in wgtList ) {
				if ( wgtList.hasOwnProperty(weight) ) {
					if ( setup.saList[actList2[action].content].flavorTags.includes(wgtList[weight].content) ) {
						actList2[action].w *= wgtList[weight].w / 100;
					}
				}
			}
			State.variables.sc.sceneLog += actList2[action].content + ".w: " + actList2[action].w + " ; ";
		}
	}
	
	return actList2;
}
window.applyTasteWeightToAction = function(wItem,character) { // wItem refers to the action key as a weighted element
	var newWeight = wItem.w;
	
	for ( var taste in character.tastes ) {
		if ( character.tastes.hasOwnProperty(taste) ) {
			if ( setup.saList[wItem.content].flavorTags.includes(character.tastes[taste].content) ) {
				newWeight *= (character.tastes[taste].w / 100);
			}
		}
	}
	
	return newWeight;
}
window.applyRoleWeightToAction = function(wList,rolePreferences) {
	/*
	var wList2 = wList;
	for ( var item in wList2 ) {
		if (wList2.hasOwnProperty(item) ) {
			wList2[item].w = applyTasteWeightToAction(wList2[item],character); // Taste weighted
		}
	}
	*/
}

	// Action lists
window.purgeActionsWithStrategyTag = function(list,tag) {
	var newList = [];
	for ( var action of list ) {
		if ( setup.saList[action].strategyTags.includes(tag) == false ) {
			newList.push(action);
		}
	}
	return newList;
}
window.purgeActionsWithoutStrategyTag = function(list,tag) {
	var newList = [];
	for ( var action of list ) {
		if ( setup.saList[action].strategyTags.includes(tag) ) {
			newList.push(action);
		}
	}
	return newList;
}
window.purgeActionsWithPreferenceTag = function(list,tag) {
	var newList = [];
	for ( var action of list ) {
		if ( setup.saList[action].flavorTags.includes(tag) == false ) {
			newList.push(action);
		}
	}
	return newList;
}
window.purgeActionsWithoutPreferenceTag = function(list,tag) {
	var newList = [];
	for ( var action of list ) {
		if ( setup.saList[action].flavorTags.includes(tag) == true ) {
			newList.push(action);
		}
	}
	return newList;
}

window.purgeInvalidActionsFromListActorOnTarget = function(list,actor,target) {
	var newList = [];
	for ( var act of list ) {
		if ( isActionUsable(act,actor,[target],false).isUsable == true ) {
			newList.push(act);
		}
	}
	return newList;
}

window.purgeCAsConflictingWithTransformationGoals = function(caUnweightedList,actor) {
	// Example of caUnweightedList:
	// Array(2) [Array(3) ["penetratePussy", "chVal", "mountFromBehind"], Array(3) ["penetratePussy", "chPlayerCharacter", "mountFaceToFace"]]
	var newCaUnweightedList = [];
	
	var tfActions = [];
	var requiredTargetBps = [];
	var requiredActorBps = [];
	
	// Get all tfActions from a tfActor
	for ( var sa of gC(State.variables.sc.tfActors[0]).saList ) {
		if ( setup.saList[sa].tags.includes("tf") ) {
			tfActions.push(sa);
			// Get all requiredBps
			for ( var bp of setup.saList[sa].targetBpReqs ) {
				if ( requiredTargetBps.includes(bp) == false ) {
					requiredTargetBps.push(bp);
				}
			}
			for ( var bp of setup.saList[sa].actorBpReqs ) {
				if ( requiredActorBps.includes(bp) == false ) {
					requiredActorBps.push(bp);
				}
			}
		}
	}
	
	for ( var cAs of caUnweightedList ) {
		var flagKeep = true;
		if ( cAs[1] == State.variables.sc.tfTarget ) {
			for ( bp of setup.saList[cAs[0]].targetBpReqs ) {
				if ( requiredTargetBps.includes(bp) ) {
					flagKeep = false;
				}
			}
			for ( bp of setup.saList[cAs[0]].actorBpReqs ) {
				if ( requiredActorBps.includes(bp) ) {
					flagKeep = false;
				}
			}
		}
		if ( flagKeep ) {
			newCaUnweightedList.push(cAs);
		}
	}
	return newCaUnweightedList;
}

	// Altered states
window.countCharactersBuffs = function(charKey) {
	var count = 0;
	for ( var as of gC(charKey).alteredStates ) {
		if ( as.type == "buff" ) { count++; }
	}
	return count;
}
window.countCharactersDebuffs = function(charKey) {
	var count = 0;
	for ( var as of gC(charKey).alteredStates ) {
		if ( as.type == "debuff" ) { count++; }
	}
	return count;
}

// Constructors, serializers, etc.
aiAlgorithm.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

aiAlgorithm.prototype.clone = function () {
	return (new aiAlgorithm())._init(this);
};

aiAlgorithm.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new aiAlgorithm())._init($ReviveData$)', ownData);
};



////////// AI ALGORITHMS LIST CLASS //////////
// AI algorithms will be objects belonging to this object. This will ease the access to ai functions.
window.aiList = function() {
};

// Constructors, serializers, etc.
aiList.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

aiList.prototype.clone = function () {
	return (new aiList())._init(this);
};

aiList.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new aiList())._init($ReviveData$)', ownData);
};

////////// RESOURCES MANAGEMENT //////////

// Images
window.imgList = function() {
	// Icons
	this.lust = "[img[img/lustIcon.png]]";
	this.willpower = "[img[img/willpowerIcon.png]]";
	this.energy = "[img[img/energyIcon.png]]";
	this.socialdrive = "[img[img/socialdriveIcon.png]]";
	// Social Icons
	this.friendly = "[img[img/socialIcons/friendlyIcon.png]]";
	this.intimate = "[img[img/socialIcons/intimateIcon.png]]";
	this.flirty = "[img[img/socialIcons/flirtyIcon.png]]";
	this.aroused = "[img[img/socialIcons/arousedIcon.png]]";
	this.dominant = "[img[img/socialIcons/dominantIcon.png]]";
	this.submissive = "[img[img/socialIcons/submissiveIcon.png]]";
	this.bored = "[img[img/socialIcons/boredIcon.png]]";
	this.angry = "[img[img/socialIcons/angryIcon.png]]";
};
window.img = function(imageKey) {
	return State.variables.imgList[imageKey];
};
setup.sillanFull = "[img[img/portraits/sillan-full.png]]"
setup.sillanAvatar = "[img[img/portraits/sillan-avatar.png]]";

window.getProvisionalSillanPortrait = function() {
	var porText = '<span style="color:aqua">???</span>\n';
				+ setup.sillanAvatar;
	return porText;
}

// Constructors, serializers, etc.
imgList.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

imgList.prototype.clone = function () {
	return (new imgList())._init(this);
};

imgList.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new imgList())._init($ReviveData$)', ownData);
};

///// Custom Scene Scripts /////
// These are assigned to the scene.customScript property when appropiate
// State.variables.sc

window.cssGhFutaFuck = function() {
	switch (State.variables.sc.currentTurn) {
		case 2:
			State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"You should breathe deeply..."//</span>';
			break;
		case 3:
			State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"...Otherwise, you might not have enough air for what\'s coming."//</span>';
			break;
		case 4:
			State.variables.sc.headingDescription = 'The mist expands in all directions...';
			break;
		case 5:
			State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"Hah..."//<' + '/span>' + '  she inhales.\n' + '<span @style=$chGoddessHerald.colorStyleKey>//"Congratulations, small one. You\'re a woman now."//<' + '/span>';
			break;
		case 6:
			State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"Now, push back against me. Show me you want it too."//<' + '/span>\n//You have learnt \'Push Hips Back\'//.\n\n' + 'The mist expands in all directions...';
			State.variables.chPlayerCharacter.saList.push("pushHipsBack");
			break;
		case 7:
			State.variables.sc.headingDescription = 'The mist expands in all directions...';
			break;
	}
	if ( State.variables.sc.currentTurn >= 7 && State.variables.sc.pcChosenAction == "pushHipsBack" && State.variables.StVars.gh2 == 0 ) {
		State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"Ah, yes! That\'s a good girl! Don\'t stop."//<'
											  + '/span>\n//You received <span style="color:darkslateblue">10 willpower damage</span>.//'
											  + '\n\nThe mist extends in all directions...';
		State.variables.chPlayerCharacter.willpower.changeValue(-10);
		State.variables.StVars.gh2 = 1;
	}
	else if ( State.variables.sc.currentTurn >= 7 ) {
		State.variables.sc.headingDescription = 'The mist expands in all directions...';
	}
	
	if ( State.variables.sc.currentTurn >= 8 && State.variables.chPlayerCharacter.orgasmSceneCounter > 0 ) {
		State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"Get ready, precious flower. Here I come."//<'
											  + '/span>' + '\n\n//Is this what an orgasm feels like? And this woman just gave me... My first one?//'
											  + '\n\nThe mist extends in all directions...';
		if ( State.variables.chGoddessHerald.aiAlgorythm.hasOwnProperty("fixedAction") ) {
			if ( State.variables.chGoddessHerald.aiAlgorythm.fixedAction == "finalPush" ) {
				State.variables.sc.headingDescription = 'The mist extends in all directions...';
			}
		}
		State.variables.chGoddessHerald.aiAlgorythm = createAiFixedAction();
		State.variables.chGoddessHerald.aiAlgorythm.fixedAction = "finalPush";
		State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = "chPlayerCharacter";
	}
	else if ( State.variables.sc.currentTurn >= 8 ) {
		State.variables.chGoddessHerald.aiAlgorythm = createAiFixedAction();
		State.variables.chGoddessHerald.aiAlgorythm.fixedAction = "piston";
		State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = "chPlayerCharacter";
	}
};
window.cssGhScissor = function() {
	switch (State.variables.sc.currentTurn) {
		case 2:
			State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"Hold me close..."//</span>';
			break;
		case 3:
			State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"...You are going to want to feel all of me."//</span>';
			break;
		case 4:
			State.variables.sc.headingDescription = 'The mist expands in all directions...';
			break;
		case 5:
			State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"Hah..."//<' + '/span>' + '  she inhales.\n' + '<span @style=$chGoddessHerald.colorStyleKey>//"Congratulations, small one. You\'re a woman now."//<' + '/span>';
			break;
		case 6:
			State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"Now, push back against me. Show me you want it too."//<' + '/span>\n//You have learnt \'Scissor\'//.\n\n' + 'The mist expands in all directions...';
			State.variables.chPlayerCharacter.saList.push("scissor");
			break;
		case 7:
			State.variables.sc.headingDescription = 'The mist expands in all directions...';
			break;
	}
	if ( State.variables.sc.currentTurn >= 7 && State.variables.sc.pcChosenAction == "scissor" && State.variables.StVars.gh2 == 0 ) {
		State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"Ah, yes! That\'s a good girl! Don\'t stop."//<'
											  + '/span>\n//You received <span style="color:darkslateblue">10 willpower damage</span>.//'
											  + '\n\nThe mist extends in all directions...';
		State.variables.chPlayerCharacter.willpower.changeValue(-10);
		State.variables.StVars.gh2 = 1;
	}
	else if ( State.variables.sc.currentTurn >= 7 ) {
		State.variables.sc.headingDescription = 'The mist expands in all directions...';
	}
	
	if ( State.variables.sc.currentTurn >= 8 ) {
		State.variables.chGoddessHerald.aiAlgorythm = createAiFixedAction();
		State.variables.chGoddessHerald.aiAlgorythm.fixedAction = "scissor";
		State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = "chPlayerCharacter";
	}
};

window.cssGhKneeling = function() {
	switch ( State.variables.sc.currentTurn ) {
		case 2:
			State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"You look really cute down there.'
												  + '\nYou\'ll look even cuter when you\'re sticking your tongue out."//</span>'
												  + '\nThe mist extends in all directions...';
			State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = "chGoddessHerald";
			break;
		case 3:
			State.variables.sc.headingDescription = 'You took out your tongue, just as she ordered.\n'
												  + '<span @style=$chGoddessHerald.colorStyleKey>//"And now lick me. Right between my legs."//</span>'
												  + '\n//You have learnt \'Lick Groin\'//.'
												  + '\nThe mist extends in all directions...';
			State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = "chPlayerCharacter";
			State.variables.chPlayerCharacter.saList.push("lickGroin");			
			break;
		case 4:
			if ( State.variables.sc.pcChosenAction == "lickGroin" ) {
				State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"Ah... Good girl, don\'t stop."//</span>'
													  + '\nThe mist extends in all directions...';
			}
			else {
				State.variables.sc.headingDescription = 'The mist extends in all directions...';
			}
			State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = "chGoddessHerald";
			break;
		case 5:
			State.variables.sc.headingDescription = 'The mist extends in all directions...';
			break;
		case 6:
			State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"You\'re doing great, little flower.'
												  + '\nNow get some air, I\'m going to speed this up."//</span>'
												  + '\nThe mist extends in all directions...';
			State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = "chPlayerCharacter";
			State.variables.chGoddessHerald.aiAlgorythm.fixedAction = "legHoldHead";			
			break;
		case 7:
			State.variables.sc.headingDescription = 'The mist extends in all directions...';
			State.variables.chGoddessHerald.aiAlgorythm = createAiFixedAction();
			State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = "chGoddessHerald";
			State.variables.chGoddessHerald.aiAlgorythm.fixedAction = "strokeBreasts";			
			break;			
	}
	if ( State.variables.sc.currentTurn >= 8 ) {
		State.variables.sc.headingDescription = State.variables.chGoddessHerald.formattedName + ' is heating up. She received 10 lust damage.\n'
											  + "The mist extends in all directions...";
		State.variables.chGoddessHerald.lust.changeValue(-10);
	}
};
window.ccsGhStanding = function() {
	switch ( State.variables.sc.currentTurn ) {
		case 2:
			
			State.variables.sc.headingDescription = '<span @style=$chGoddessHerald.colorStyleKey>//"Relax, and look at me in the eyes. They\'ll eat all of your worries away."//</span>'
												  + '\nThe mist extends in all directions...';
			break; /*
		case 3:
			State.variables.sc.headingDescription = 'You cannot help but feel the intense gaze of the woman directly on you.'
												  + '\nYou\'re above her, she\'s pleasuring you, and yet... She has you right on her hands.\n'
												  + 'You have received <span style="color:lightcoral">5 lust damage</span> and <span style="color:darkslateblue">2 willpower damage</span>.\n'
												  + 'The mist extends in all directions...';
			State.variables.chPlayerCharacter.lust.changeValue(-5);
			State.variables.chPlayerCharacter.willpower.changeValue(-2);
			break;
		case 6:
			State.variables.sc.headingDescription = 'You cannot help but feel the intense gaze of the woman directly on you.'
												  + '\nYou\'re above her, she\'s pleasuring you, and yet... She has you right on her hands.\n'
												  + 'You have received <span style="color:lightcoral">5 lust damage</span> and <span style="color:darkslateblue">2 willpower damage</span>.\n'
												  + 'The mist extends in all directions...';
			State.variables.chPlayerCharacter.lust.changeValue(-5);
			State.variables.chPlayerCharacter.willpower.changeValue(-2);
			State.variables.chGoddessHerald.aiAlgorythm = createAiFixedAction();
			State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = "chPlayerCharacter";
			State.variables.chGoddessHerald.aiAlgorythm.fixedAction = "lickGroin";
			break; */
	}
	if ( State.variables.sc.currentTurn >= 3 && State.variables.sc.currentTurn < 6 ) {
			State.variables.sc.headingDescription = 'You cannot help but feel the intense gaze of the woman directly on you.'
												  + '\nYou\'re above her, she\'s pleasuring you, and yet... She has you right on her hands.\n'
												  + 'You have received <span style="color:lightcoral">5 lust damage</span> and <span style="color:darkslateblue">2 willpower damage</span>.\n'
												  + 'The mist extends in all directions...';
			State.variables.chPlayerCharacter.lust.changeValue(-5);
			State.variables.chPlayerCharacter.willpower.changeValue(-2);
	}
	else if ( State.variables.sc.currentTurn >= 6 ) {
			State.variables.sc.headingDescription = 'You cannot help but feel the intense gaze of the woman directly on you.'
												  + '\nYou\'re above her, she\'s pleasuring you, and yet... //She has me right on her hands.//\n'
												  + 'You have received <span style="color:lightcoral">5 lust damage</span> and <span style="color:darkslateblue">2 willpower damage</span>.\n'
												  + 'The mist extends in all directions...';
			State.variables.chPlayerCharacter.lust.changeValue(-5);
			State.variables.chPlayerCharacter.willpower.changeValue(-2);
			State.variables.chGoddessHerald.aiAlgorythm = createAiFixedAction();
			State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = "chPlayerCharacter";
			State.variables.chGoddessHerald.aiAlgorythm.fixedAction = "lickGroin";
	}
};

window.ghFutaFuckEndCondition = function(none) {
	var flagEndScene = false;
	
	if ( State.variables.chGoddessHerald.orgasmSceneCounter > 0 ) {
		flagEndScene = true;
	}
	
	return flagEndScene;	
}
window.ghScissorEndCondition = function(none) {
	var flagEndScene = false;
	
	if ( State.variables.chGoddessHerald.orgasmSceneCounter > 0 && State.variables.chPlayerCharacter.orgasmSceneCounter > 0 ) {
		flagEndScene = true;
	}
	
	return flagEndScene;	
}
window.playerOrgasmEndCondition = function(none) {
	var flagEndScene = false;
	
	if ( State.variables.chPlayerCharacter.getAllSceneOrgasms() > 0 ) {
		flagEndScene = true;
	}
	
	return flagEndScene;	
}
window.valtanOrgasmEndCondition = function(none) {
	var flagEndScene = false;
	
	if ( State.variables.chVal.getAllSceneOrgasms() > 0 ) {
		flagEndScene = true;
	}
	
	return flagEndScene;	
}
window.playerNvaltanOrgasmEndCondition = function(none) {
	var flagEndScene = false;
	
	if ( State.variables.chPlayerCharacter.getAllSceneOrgasms() > 0 && State.variables.chVal.getAllSceneOrgasms() > 0 ) {
		flagEndScene = true;
	}
	
	return flagEndScene;
}
window.playerNnashOrgasmEndCondition = function(none) {
	var flagEndScene = false;
	
	if ( State.variables.chPlayerCharacter.getAllSceneOrgasms() > 0 && State.variables.chNash.getAllSceneOrgasms() > 0 ) {
		flagEndScene = true;
	}
	
	return flagEndScene;
}
window.playerNnashTwoOrgasmsEndCondition = function(none) {
	var flagEndScene = false;
	
	if ( State.variables.chPlayerCharacter.getAllSceneOrgasms() > 1 && State.variables.chNash.getAllSceneOrgasms() > 1 ) {
		flagEndScene = true;
	}
	
	return flagEndScene;
}

window.reachTurnLimitEndCondition = function(turnLimit) {
	var flagEndScene = false;
	
	if ( State.variables.sc.currentTurn >= turnLimit ) {
		flagEndScene = true;
	}
	
	return flagEndScene;
}

// Staying hydrated
window.stHyInitMirToVal = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chMir"],["chVal"],"The scent of well cooked mushrooms fills your nose.",valtanOrgasmEndCondition,99,
	"SE Staying Hydrated Voyeur End");
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.chVal.hasLead = true;
	State.variables.chMir.hasLead = false;
	State.variables.sc.customScript = ccsStHyMirToVal;
	createPosKneel("chVal", ["chMir"]);
	ccsStHyAssignChoices();
	setRefreshLustScript();
}
window.ccsStHyMirToVal = function() {
	ccsStHyAssignChoices();
}
window.ccsStHyAssignChoices = function() {
	var valChoices = [["chVal","strokeBreasts"]];
	var mirChoices = [["chMir","strokePussy"]];
	
	// X% chance for Val to cancel continued action if she has a dick
	if ( gC("chVal").body.hasOwnProperty("dick") && State.variables.sc.continuedActions.length > 0 ) {
		
		if ( limitedRandomInt(9) < 3 ) {
			State.variables.sc.removeContinuedAction(0);
		}
	}
	
	if ( State.variables.sc.continuedActions.length == 0 ) {		// If there's no continued action, Val may choose one of these
		valChoices.push(["chMir","legHoldHead"]);
		if ( gC("chVal").hasFreeBodypart("dick") ) {
			valChoices.push(["chMir","getBlowjob"]);
		}
	} else {
		if ( State.variables.sc.continuedActions[0].key == "legHoldingHead" ) {
			valChoices.push(["chMir","rideFace"]);
			mirChoices.push(["chVal","lickPussy"]);
			valChoices.push(["chMir","rideFace"]);
			mirChoices.push(["chVal","lickPussy"]);
			if ( gC("chVal").hasFreeBodypart("dick") ) {
				valChoices.push(["chVal","strokeDick"]);
			}
		}
		else if ( State.variables.sc.continuedActions[0].key == "getBlowjob" ) {
			valChoices.push(["chMir","fuckFace"]);
			mirChoices.push(["chVal","suckDick"]);
			valChoices.push(["chMir","fuckFace"]);
			mirChoices.push(["chVal","suckDick"]);
			if ( gC("chVal").hasFreeBodypart("pussy") ) {
				valChoices.push(["chVal","strokePussy"]);
			}
		}
	}
	
	State.variables.chVal.aiAlgorythm = createAiRandomChoice(valChoices);
	State.variables.chMir.aiAlgorythm = createAiRandomChoice(mirChoices);
}

window.stHyInitPlToVal = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chVal"],"The smell of sweet gelatine invades your nose.",valtanOrgasmEndCondition,99,
	"SE Staying Hydrated ValHydratesPlayer End");
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.chVal.hasLead = true;
	State.variables.chPlayerCharacter.hasLead = false;
	State.variables.sc.customScript = ccsStHyPlToVal;
	createPosKneel("chVal", ["chPlayerCharacter"]);
	ccsStHyAssignChoicesPlToVal();
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.ccsStHyPlToVal = function() {
	ccsStHyAssignChoicesPlToVal();
}
window.ccsStHyAssignChoicesPlToVal = function() {
	var valChoices = [["chVal","strokeBreasts"]];
	
	// X% chance for Val to cancel continued action if she has a dick
	if ( gC("chVal").body.hasOwnProperty("dick") && State.variables.sc.continuedActions.length > 0 ) {
		
		if ( limitedRandomInt(9) < 3 ) {
			State.variables.sc.removeContinuedAction(0);
		}
	}
	
	if ( State.variables.sc.continuedActions.length == 0 ) {		// If there's no continued action, Val may choose one of these
		valChoices.push(["chPlayerCharacter","legHoldHead"]);
		if ( gC("chVal").hasFreeBodypart("dick") ) {
			valChoices.push(["chPlayerCharacter","getBlowjob"]);
		}
	} else {
		if ( State.variables.sc.continuedActions[0].key == "legHoldingHead" ) {
			valChoices.push(["chPlayerCharacter","rideFace"]);
			valChoices.push(["chPlayerCharacter","rideFace"]);
			if ( gC("chVal").hasFreeBodypart("dick") ) {
				valChoices.push(["chVal","strokeDick"]);
			}
		}
		else if ( State.variables.sc.continuedActions[0].key == "getBlowjob" ) {
			valChoices.push(["chPlayerCharacter","fuckFace"]);
			valChoices.push(["chPlayerCharacter","fuckFace"]);
			if ( gC("chVal").hasFreeBodypart("pussy") ) {
				valChoices.push(["chVal","strokePussy"]);
			}
		}
	}
	
	State.variables.chVal.aiAlgorythm = createAiRandomChoice(valChoices);
}

window.stHyInitValToPl = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chVal"],"The scent of well cooked mushrooms fills your nose.",playerOrgasmEndCondition,99,
	"SE Staying Hydrated PlayerHydratesVal End");
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.sc.sceneConditions.push("cantChangePositions");
	State.variables.chVal.hasLead = false;
	State.variables.chPlayerCharacter.hasLead = true;
	State.variables.sc.customScript = ccsStHyValToPl;
	createPosKneel("chPlayerCharacter", ["chVal"]);
	ccsStHyAssignChoicesValToPl();
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.ccsStHyValToPl = function() {
	ccsStHyAssignChoicesValToPl();
}
window.ccsStHyAssignChoicesValToPl = function() {
	var valChoices = [["chVal","strokePussy"],["chVal","strokeBreasts"]];
	if ( gC("chVal").hasFreeBodypart("dick") ) {
		valChoices.push(["chVal","strokeDick"]);
	}
	
	if ( State.variables.sc.continuedActions.length > 0 ) {
		if ( State.variables.sc.continuedActions[0].key == "legHoldingHead" ) {
			valChoices.push(["chPlayerCharacter","lickPussy"]);
			valChoices.push(["chPlayerCharacter","lickPussy"]);
		}
		else if ( State.variables.sc.continuedActions[0].key == "getBlowjob" ) {
			valChoices.push(["chPlayerCharacter","suckDick"]);
			valChoices.push(["chPlayerCharacter","suckDick"]);
		}
		else {
			valChoices.push(["chPlayerCharacter","lickGroin"]);
			valChoices.push(["chPlayerCharacter","strokePussy"]);
		}
	}
		
	State.variables.chVal.aiAlgorythm = createAiRandomChoice(valChoices);
}

window.stHyInitSpitroast = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter","chVal"],["chMir"],"Valtan smiles mischievously.",playerNvaltanOrgasmEndCondition,99,
	"SE Staying Hydrated MirSurrounded End");
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.sc.sceneConditions.push("cantChangePositions");
	State.variables.chVal.hasLead = true;
	State.variables.chMir.hasLead = false;
	State.variables.chPlayerCharacter.hasLead = true;
	State.variables.sc.customScript = ccsStHySpitroast;
	createPosSpitroast("chPlayerCharacter","chVal","chMir");
	ccsStHyAssignChoicesSpitroast();
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.ccsStHySpitroast = function() {
	ccsStHyAssignChoicesSpitroast();
}
window.ccsStHyAssignChoicesSpitroast = function() {
	var valChoices = [["chVal","strokeBreasts"]];
	var mirChoices = [];
	
	var caKeys = [];
	for ( var continuedAction of State.variables.sc.continuedActions ) {
		caKeys.push(continuedAction.key);
	}
	
	if ( caKeys.includes("getBlowjob") ) { // Val getting blowjob
		valChoices.push(["chMir","fuckFace"],["chMir","fuckFace"],["chVal","strokePussy"]);
		mirChoices.push(["chVal","suckDick"],["chVal","suckDick"],["chVal","strokePussy"]);
	}
	else if ( caKeys.includes("legHoldingHead") ) { // Val getting cunnilingus
		valChoices.push(["chMir","rideFace"],["chMir","rideFace"]);
		mirChoices.push(["chVal","lickPussy"],["chVal","lickPussy"]);
		if ( gC("chVal").hasFreeBodypart("dick") ) {
			valChoices.push(["chVal","strokeDick"]);
			mirChoices.push(["chVal","strokeDick"]);
		}
	}
	else { 									// Val not getting head
		valChoices.push(["chMir","legHoldHead"],["chMir","kissLips"],["chVal","strokePussy"]);
		mirChoices.push(["chVal","lickGroin"],["chVal","strokePussy"]);
		if ( gC("chVal").hasFreeBodypart("dick") ) {
			valChoices.push(["chMir","getBlowjob"],["chMir","getBlowjob"]);
		}
	}
	
	if ( caKeys.includes("penetratePussy") ) { // Player fucking Mir
		mirChoices.push(["chPlayerCharacter","pushHipsBack"],["chPlayerCharacter","pushHipsBack"],["chPlayerCharacter","pushHipsBack"]);
	}
	else if ( caKeys.includes("interlockLegs") ) { // Player scisoring Mir
		mirChoices.push(["chPlayerCharacter","scissor"],["chPlayerCharacter","scissor"],["chPlayerCharacter","scissor"]);
	}
	else {										// Player not giving back-up to Mir
		mirChoices.push(["chPlayerCharacter","frottage"],["chPlayerCharacter","frottage"]);
	}
	
	if ( gC("chMir").hasFreeBodypart("dick") ) {
		mirChoices.push(["chMir","strokeDick"]);
	}
	if ( gC("chMir").hasFreeBodypart("pussy") ) {
		mirChoices.push(["chMir","strokePussy"]);
	}
	
	State.variables.chVal.aiAlgorythm = createAiRandomChoice(valChoices);
	State.variables.chMir.aiAlgorythm = createAiRandomChoice(mirChoices);
}

// Stretching Help II
window.stHpIIinit = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chNash"],"The big guy remains imperturbable.",playerNnashOrgasmEndCondition,99,
	"SE SH II End NodeC Had Sex");
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.sc.sceneConditions.push("cantChangePositions");
	State.variables.chNash.hasLead = true;
	State.variables.chPlayerCharacter.hasLead = false;
	createPosMountFromBehind("chNash",["chPlayerCharacter"]);
	// Assign choices
	State.variables.chNash.hasLead = true;
	State.variables.chNash.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chNash.aiAlgorythm.fixedTarget = "chPlayerCharacter";
	State.variables.chNash.aiAlgorythm.setRoleDomination();
	//
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}

// Beating a Kitty Into Friendship
window.btifFirstBattleInit = function() {
	State.variables.sc.startScene(
	"bs","fixed",["chMir"],["chAte"],"__Field__\nThis is the clearest area in the training grounds. You're guaranteed to find a spot in which you can unleash hellflames without destroying anything.",endConditionTurns,6,
	"SE Beating Kitty Into Friendship Further Trouble");
		State.variables.chMir.aiAlgorythm = createAiFixedAction();
		State.variables.chMir.aiAlgorythm.fixedAction = "kick";
		State.variables.chMir.aiAlgorythm.fixedTarget = "chAte";
		State.variables.chAte.aiAlgorythm = createAiFixedAction();
		State.variables.chAte.aiAlgorythm.fixedAction = "embers";
		State.variables.chAte.aiAlgorythm.fixedTarget = "chMir";/*
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).aiAlgorythm = createAiEarlyStrategic();
		}
	}*/
	State.variables.sc.customScript = ccsBtifFirstBattleScript;
	State.variables.sc.outHeadingDescription = '<span style="color:mediumvioletred">//"Your goal in battles is to disrupt your opponent\'s aether. Or, in other words, to knock them out. The most direct way to do this is by harming them until they run out of strength."//</span>\n\n';
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}

window.ccsBtifFirstBattleScript = function() {
	switch (State.variables.sc.currentTurn) {
		case 2:
			State.variables.chMir.aiAlgorythm.fixedAction = "kick";
			State.variables.chAte.aiAlgorythm.fixedAction = "freezeFeet";
			State.variables.sc.headingDescription = '<span style="color:saddlebrown">//"Your opponent will keep trying to evade your attacks, and will often be successful. If you want to give a harder time to your rival when they try to evade your hits, make sure you harm their control while keeping your own high."//</span>' ;
			break;
		case 3:
			State.variables.chMir.aiAlgorythm.fixedAction = "taunt";
			State.variables.chAte.aiAlgorythm.fixedAction = "freezeFeet";
			State.variables.sc.headingDescription = '<span style="color:mediumvioletred">//"Some actions may inflict various conditions on your enemies and allies. Some of them may turn out to be a boon or a handicap, depending on the circumstances."//</span>';
			break;
		case 4:
			State.variables.chMir.aiAlgorythm.fixedAction = "baStrokePussy";
			State.variables.chAte.aiAlgorythm.fixedAction = "embers";
			State.variables.sc.headingDescription = '<span style="color:mediumvioletred">//"In case you weren\'t aware, provoking your opponent to reach orgasm is another way to disrupt their aether. While this supposes higher risks, it could be worth it to take the fight to a sexual context."//</span>';
			break;
		case 5:
			State.variables.chMir.aiAlgorythm.fixedAction = "pounceFrontalP2P";
			State.variables.chAte.aiAlgorythm.fixedAction = "freezeFeet";
			State.variables.sc.headingDescription = '<span style="color:saddlebrown">//"If you want to try the sexual approach, you should pounce on your enemy. Pounce attacks are hard to land correctly, unless your target is out of control, but they will put you in the perfect position to deliver pleasure."//<' + '/span>';
			break;
		case 6:
			State.variables.chMir.aiAlgorythm.fixedAction = "baKissLips";
			State.variables.chAte.aiAlgorythm.fixedAction = "sparkingRubbing";
			State.variables.sc.headingDescription = '<span style="color:saddlebrown">//"If your opponent successfully pounces on you, you\'ll at a disadvantage! In that case, you should struggle as much as possible until your enemy runs out of control."//<' + '/span>';
			break;
		case 7:
			State.variables.sc.headingDescription =  '<span @style=$chNash.colorStyleKey>//"I can\'t take it anymore!"//</span> Nash shouts suddenly.';
			State.variables.sc.flagSceneEnded = true;
			break;
	}
}

window.ccsBtifNashVsClawBattleInit = function() {
	var clawGoal = "";
	switch ( State.variables.StVars.BkifStakes ) {
		case "servitude":
			clawGoal = "SE BKIF Claw Victory Servitude";
			break;
		case "sex":
			clawGoal = "SE BKIF Claw Victory Sex";
			break;
		case "humilliation":
			clawGoal = "SE BKIF Claw Victory Humilliation";
			break;
	}
	State.variables.sc.startScene(
	"bs","fixed",["chNash"],["chClaw"],"__Field__\nThis is the clearest area in the training grounds. You're guaranteed to find a spot in which you can unleash hellflames without destroying anything.",createEndConditionStoryBattle("SE BKIF Nash Victory",clawGoal),6,
	"SE BKIF Nash Victory");
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).aiAlgorythm = createAiEarlyStrategic();
		}
	}
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.ccsBtifPlayerVsClawBattleInit = function() {
	var clawGoal = "";
	switch ( State.variables.StVars.BkifStakes ) {
		case "servitude":
			clawGoal = "SE BKIF Claw Defeats Player Servitude";
			break;
		case "sex":
			clawGoal = "SE BKIF Claw Defeats Player Sex";
			break;
		case "humilliation":
			clawGoal = "SE BKIF Claw Defeats Player Humilliation";
			break;
	}
	State.variables.sc.startScene(
	"bs","fixed",["chPlayerCharacter"],["chClaw"],"__Field__\nThis is the clearest area in the training grounds. You're guaranteed to find a spot in which you can unleash hellflames without destroying anything.",createEndConditionStoryBattleWithDraw("SE BKIF Player Victory",clawGoal,"SE BKIF Player Victory"),6,
	"SE BKIF Player Victory");
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).aiAlgorythm = createAiEarlyStrategic();
		}
	}
	State.variables.sc.customScript = function(turns) {
		if ( State.variables.StVars.drishtyaSawVaryonteMoves == true ) {
			State.variables.sc.headingDescription = "__Field__\nThis is the clearest area in the training grounds. You're guaranteed to find a spot in which you can unleash hellflames without destroying anything.";
		}
		if ( State.variables.sc.teamAchosenActions[0] == "baHypnoticGlance" || State.variables.sc.teamAchosenActions[0] == "baDrainingKiss" || State.variables.sc.teamAchosenActions[0] == "baEnergyDrainingKiss" || State.variables.sc.teamAchosenActions[0] == "baEtherealChains" ) {
			if ( State.variables.StVars.drishtyaSawVaryonteMoves == false ) {
				State.variables.StVars.drishtyaSawVaryonteMoves = true;
				State.variables.sc.headingDescription = '<span @style=$chMir.colorStyleKey>//"What was that?"//</span>';
			}
		}
	}
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.ccsBtifTeamfightBattleInit = function() {
	State.variables.sc.startScene(
	"bs","fixed",["chPlayerCharacter","chNash"],["chClaw","chVal"],"__Field__\nThis is the clearest area in the training grounds. You're guaranteed to find a spot in which you can unleash hellflames without destroying anything.",createEndConditionStoryBattleWithDraw("SE BKIF Player Team Victory","SE BKIF Player Team Defeat","SE BKIF Player Team Victory"),6,
	"SE BKIF Player Victory");
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).aiAlgorythm = createAiEarlyStrategic();
		}
	}
	State.variables.sc.customScript = function(turns) {
		if ( State.variables.StVars.drishtyaSawVaryonteMoves == true ) {
			State.variables.sc.headingDescription = "__Field__\nThis is the clearest area in the training grounds. You're guaranteed to find a spot in which you can unleash hellflames without destroying anything.";
		}
		if ( State.variables.sc.teamAchosenActions[0] == "baHypnoticGlance" || State.variables.sc.teamAchosenActions[0] == "baDrainingKiss" || State.variables.sc.teamAchosenActions[0] == "baEnergyDrainingKiss" || State.variables.sc.teamAchosenActions[0] == "baEtherealChains" ) {
			if ( State.variables.StVars.drishtyaSawVaryonteMoves == false ) {
				State.variables.StVars.drishtyaSawVaryonteMoves = true;
				State.variables.sc.headingDescription = '<span @style=$chMir.colorStyleKey>//"What was that?"//</span>';
			}
		}
	}
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}

// Aspiring Tree Climber
window.aspiringTCdommingClaw = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chClaw"],"The wind is caressing the forest.",endConditionTurns,gSettings().stdSxScDur,
	"SE Aspiring TC Post Domming Claw");
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.sc.sceneConditions.push("cantChangePositions");
	State.variables.chClaw.hasLead = false;
	State.variables.chPlayerCharacter.hasLead = true;
	createPosMountFaceToFace("chPlayerCharacter",["chClaw"]);
	// Assign choices
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.fixedTarget = "chPlayerCharacter";
	State.variables.chClaw.aiAlgorythm.setRoleSubmission();
	//
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.aspiringTCdommedByClaw = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chClaw"],"The trees' branches move along with the wind.",endConditionTurns,gSettings().stdSxScDur,
	"SE Aspiring TC Post Subbing Claw");
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.sc.sceneConditions.push("cantChangePositions");
	State.variables.chClaw.hasLead = true;
	State.variables.chPlayerCharacter.hasLead = false;
	createPosMountFaceToFace("chClaw",["chPlayerCharacter"]);
	// Assign choices
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.fixedTarget = "chPlayerCharacter";
	State.variables.chClaw.aiAlgorythm.setRoleDomination();
	//
	State.variables.sc.continuedActions.push(createCaHoldArms("chClaw",["chPlayerCharacter"]));
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}

// Luring Masquerade

window.ccsLuMaPlayerVsTwoBattleInit = function() {
	State.variables.sc.startScene( // Forest The trees are shaken by the wind.
	// Luring Masquerade Miracle Victory
	// Luring Masquerade Defeated By Two
	"bs","fixed",["chPlayerCharacter"],["chMir","chVal"],"__Forest__\nThe trees are shaken by the wind.",createEndConditionStoryBattle("Luring Masquerade Miracle Victory","Luring Masquerade Defeated By Two"),6,
	"Luring Masquerade Miracle Victory");
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).aiAlgorythm = createAiEarlyStrategic();
		}
	}
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.ccsLuMaTwoVsValBattleInit = function() {
	State.variables.sc.startScene( 
	"bs","fixed",["chPlayerCharacter","chMir"],["chVal"],"__Forest__\nThe trees are shaken by the wind.",createEndConditionStoryBattle("Luring Masquerade Victory Of Two","Luring Masquerade Humilliated By One"),6,
	"Luring Masquerade Miracle Victory");
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).aiAlgorythm = createAiEarlyStrategic();
		}
	}
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.ccsLuMaPlayerVsValBattleInit = function() {
	State.variables.sc.startScene( 
	"bs","fixed",["chPlayerCharacter"],["chVal"],"__Forest__\nThe trees are shaken by the wind.",createEndConditionStoryBattle("Luring Masquerade Sweet Revenge","Luring Masquerade Saved By Mir"),6,
	"Luring Masquerade Miracle Victory");
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).aiAlgorythm = createAiEarlyStrategic();
		}
	}
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}

// Gifts for Nature
window.giftsForNatureInPadmirisCare = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chMir"],"Your mind is foggy. Your body moves as Padmiri commands.",function(none) {
		var sceneMayEnd = false;
		if ( gC("chPlayerCharacter").getAllSceneOrgasms() > 0 && gC("chMir").getAllSceneOrgasms() > 0 ) { sceneMayEnd = true; }
		return sceneMayEnd;
	},30,
	"SE Gifts For Nature Parasafi Explanation");
	State.variables.chMir.hasLead = true;
	State.variables.chPlayerCharacter.hasLead = false;
	// Assign choices
	State.variables.chMir.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chMir.aiAlgorythm.fixedTarget = "chPlayerCharacter";
	State.variables.chMir.aiAlgorythm.setRoleActive();
	//
	State.variables.StVars.check3 = false;
	State.variables.StVars.check4 = false;
	State.variables.StVars.check5 = false;
	
	State.variables.sc.customScript = function() {
		if ( State.variables.StVars.check4 == false ) {
			if ( State.variables.StVars.check3 == true ) {
				State.variables.sc.headingDescription = "You're slowly recovering control over your body.";
				State.variables.StVars.check4 = true;
			}
			if ( State.variables.StVars.check3 == false && gC("chPlayerCharacter").getAllSceneOrgasms() > 0 ) {
				State.variables.StVars.check3 = true;
				State.variables.sc.headingDescription = '<span @style=$chMir.colorStyleKey>//"That should be enough. ...But I hope you don\'t mind if I help myself..."//<'
											  + '/span>' + '\n\nYour mind is still foggy. Your body moves as Padmiri commands.';
			}
		} 
		if ( State.variables.sc.currentTurn >= 5 ) {
			var damage = 1 + 0.2 * State.variables.sc.currentTurn;
			damage = damage - ( damage % 1 );
			State.variables.sc.importantMessages += "The parasalfis flower's scent gets your blood pumping.\n"
									+ gC("chPlayerCharacter").getFormattedName() + " has received " + textLustDamage(damage) + ".\n"
									+ gC("chMir").getFormattedName() + " has received " + textLustDamage(damage) + ".\n"
			applyBarDamage("chPlayerCharacter","lust",-damage);
			applyBarDamage("chMir","lust",-damage);
			State.variables.sc.checkForOrgasms();
		}
	}
	
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}

// The Grapes of Lust
window.finishGrapesData = function() {
	delete State.variables.sc.remainingGrapes;
}
window.tryGettingGrape = function() {
	var gotGrape = "none";
	var checkedAction = "doNothing";
	if ( State.variables.sc.remainingGrapes != undefined ) {
		if ( State.variables.sc.remainingGrapes > 0 ) {
			checkedAction = setup.saList[State.variables.sc.teamBchosenActions[0]];
			if ( checkedAction.flavorTags.includes("usePussy") && checkedAction.flavorTags.includes("targetMouth") ) {
				if ( limitedRandomInt(100) > 78 ) {
					gotGrape = State.variables.sc.teamBchosenTargets[0];
					State.variables.sc.remainingGrapes--;
				}
			}
			var i = 0;
			for ( var act of State.variables.sc.teamAchosenActions ) {
				checkedAction = setup.saList[State.variables.sc.teamAchosenActions[i]];
				if ( gotGrape == "none" ) {
					if ( checkedAction.flavorTags.includes("useMouth") && checkedAction.flavorTags.includes("targetPussy") ) {
						if ( limitedRandomInt(100) > 78 ) {
							gotGrape = State.variables.sc.teamAcharKeys[i];
							State.variables.sc.remainingGrapes--;
						}
					}
				}
				i++;
			}
		}
	}
	if ( gotGrape == "chAte" ) {
		var msg = randomFromList( [
			(ktn("chAte") + " managed to dig deep inside " + ktn("chVal") + "'s " + pussyWord() + " and caught a grape, which she promptly swallowed."),
			("It almost looks like it's going to slip away, but " + ktn("chAte") + "'s tongue managed to grab a grape and drag it to her own mouth."),
			("After slurping some slime, " + ktn("chAte") + " sucks yet another berry from " + ktn("chVal") + "'s " + pussyWord() + "."),
			("The grape slips for a moment, but Valtan decides to have some mercy and pushes it out of herself right into " + ktn("chAte") + "'s mouth."),
			(ktn("chVal") + " gets distracted by the pleasure for a moment, and she loses strength in her abdomen. A grape falls in the process straight into the mouth of " + ktn("chAte") + ".") ] );
		State.variables.sc.importantMessages += msg;
	} else if ( gotGrape == "chPlayerCharacter" ) {
		var msg = randomFromList( [
			(ktn("chPlayerCharacter") + "'s tongue explores deep in " + ktn("chVal") + "'s " + pussyWord() + " and digs a grape out, which " + gC("chPlayerCharacter").perPr + " shares with " + ktn("chAte") + "."),
			("After snatching a grape, " + ktn("chPlayerCharacter") + " kisses " + ktn("chAte") + ", pushing the berry inside her mouth. She swallows cutely."),
			("A grape falls from " + ktn("chVal") + "'s depths down to " + ktn("chPlayerCharacter") + "'s lips, and " + gC("chPlayerCharacter").perPr + " grabs it and puts it in " + ktn("chAte") + "'s."),
			(ktn("chPlayerCharacter") + " gets a berry, and gets distracted by the strange flavour it gets when it gets mixed with slime - but " + gC("chPlayerCharacter").perPr + " promptly shares the fruit with " + ktn("chAte") + "."),
			(ktn("chAte") + " looks at " + ktn("chPlayerCharacter") + " expectantly when she notices " + gC("chPlayerCharacter").comPr + " getting a grape. " + ktn("chPlayerCharacter") + " complies and gives it to her.") ] );
		State.variables.sc.importantMessages += msg;
	}
	return gotGrape;
}
window.endConditionGrapes = function(turns) {
	var sceneFinished = false;
	if ( State.variables.sc.remainingGrapes == undefined ) {
		sceneFinished = true;
	} else {
		if ( State.variables.sc.remainingGrapes <= 0 ) {
			sceneFinished = true;
			finishGrapesData();
		}
	}
	return sceneFinished;
}
window.cssTgolValxAte = function() {
	State.variables.sc.remainingGrapes = 8;
	charactersLearnSceneActions(["chVal"],["legHoldHead","extraLegHoldHead","makeKneel","extraMakeKneel","rideFace","getBlowjob","fuckFace"]);
	charactersLearnSceneActions(["chAte"],["kneel","extraKneel","giveCunnilingus","lickPussy","giveBlowjob","suckDick"]);
	State.variables.sc.startScene(
	"ss","fixed",["chAte"],["chVal"],"It smells like wet grass.",endConditionGrapes,gSettings().stdSxScDur,
	"SE TGoL Player Protests End");
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.chVal.hasLead = true;
	State.variables.chAte.hasLead = false;
	State.variables.sc.customScript = tryGettingGrape;
	createPosKneel("chVal",["chAte"]);
	// Choices and AI
	State.variables.chVal.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chVal.aiAlgorythm.setRoleDomination();
	State.variables.chVal.aiAlgorythm.disablePositions = true;
	/*
	State.variables.chVal.aiAlgorythm.rolePreferences.useDick.w = 0;
	State.variables.chVal.aiAlgorythm.rolePreferences.position.w = 0;
	State.variables.chVal.aiAlgorythm.rolePreferences.usePussy.w = 800;
	State.variables.chVal.aiAlgorythm.rolePreferences.oral.w = 400;
	State.variables.chVal.aiAlgorythm.rolePreferences.targetMouth.w = 800;
	*/
	State.variables.chAte.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chAte.aiAlgorythm.setRoleSubmission();
	/*
	State.variables.chAte.aiAlgorythm.rolePreferences.useMouth.w = 800;
	State.variables.chAte.aiAlgorythm.rolePreferences.oral.w = 400;
	State.variables.chAte.aiAlgorythm.rolePreferences.targetPussy.w = 800;
	*/
	//
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.cssTgolValxAtePlayer = function() {
	State.variables.sc.remainingGrapes = 8;
	charactersLearnSceneActions(["chVal"],["legHoldHead","extraLegHoldHead","makeKneel","extraMakeKneel","rideFace","getBlowjob","fuckFace"]);
	charactersLearnSceneActions(["chAte","chPlayerCharacter"],["kneel","extraKneel","giveCunnilingus","lickPussy","giveBlowjob","suckDick"]);
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter","chAte"],["chVal"],"It smells like wet grass.",endConditionGrapes,gSettings().stdSxScDur,
	"SE TGoL Join Ate End");
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.chVal.hasLead = true;
	State.variables.chAte.hasLead = false;
	State.variables.chPlayerCharacter.hasLead = false;
	State.variables.sc.customScript = tryGettingGrape;
	createPosKneel("chVal",["chAte"]);
	createComPosDoubleKneeling("chVal","chPlayerCharacter");
	// Choices and AI
	State.variables.chVal.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chVal.aiAlgorythm.setRoleDomination();
	State.variables.chVal.aiAlgorythm.disablePositions = true;
	State.variables.chAte.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chAte.aiAlgorythm.setRoleSubmission();
	//
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.cssTgolValVsPlayer = function() {
	var clawGoal = "";
	switch ( State.variables.StVars.BkifStakes ) {
		case "servitude":
			clawGoal = "SE BKIF Claw Victory Servitude";
			break;
		case "sex":
			clawGoal = "SE BKIF Claw Victory Sex";
			break;
		case "humilliation":
			clawGoal = "SE BKIF Claw Victory Humilliation";
			break;
	}
	State.variables.sc.startScene(
	"bs","fixed",["chPlayerCharacter"],["chVal"],"__Lake__\nIt smells like wet grass.",createEndConditionStoryBattle("SE TGoL Defy Valtan Player Victory","SE TGoL Defy Valtan Player Defeat"),6,
	"SE TGoL Defy Valtan Player Victory");
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).aiAlgorythm = createAiEarlyStrategic();
		}
	}
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}

// Flaunting A Kitty
window.fakClawOralsPadmiriInit = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chClaw"],["chMir"],"The Leirien fights to keep her cool while she keeps reading.",endConditionTurns,4,
	"SE FAK Eat her out 2");
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.chClaw.hasLead = true;
	State.variables.chMir.hasLead = false;
	State.variables.sc.customScript = fakAssignChoicesClawToMir;
	createPosKneel("chMir", ["chClaw"]);
	fakAssignChoicesClawToMir();
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.fakAssignChoicesClawToMir = function() {
	var clawChoices = [];
	var mirChoices = [["chMir","doNothing"]];
	if ( State.variables.sc.continuedActions.length < 1 ) {
		if ( gC("chMir").hasFreeBodypart("dick") ) {
			clawChoices.push(["chMir","giveBlowjob"]);
		}
		if ( gC("chMir").hasFreeBodypart("pussy") ) {
			clawChoices.push(["chMir","giveCunnilingus"]);
		} 
	} else {
		if ( State.variables.sc.continuedActions[0].key == "getBlowjob" ) {
			clawChoices.push(["chMir","suckDick"],["chMir","suckDick"]);
		} else if ( State.variables.sc.continuedActions[0].key == "legHoldingHead" ) {
			clawChoices.push(["chMir","lickPussy"],["chMir","lickPussy"]);
		}
		if ( gC("chMir").hasFreeBodypart("dick") ) {
			clawChoices.push(["chMir","strokeDick"]);
		}
		if ( gC("chMir").hasFreeBodypart("pussy") ) {
			clawChoices.push(["chMir","strokePussy"]);
		} 
	}
	
	State.variables.chClaw.aiAlgorythm = createAiRandomChoice(clawChoices);
	State.variables.chMir.aiAlgorythm = createAiRandomChoice(mirChoices);
}
window.fakPlayerPleasuresClaw = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chClaw"],"Shelves full of dramatic plays fill most sides of the room. There are also some chairs and tables reserved for studying.",fakMoaningKittyEndCondition,4,
	"SE FAK Moaning kitty 2");
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.chPlayerCharacter.hasLead = true;
	State.variables.chClaw.hasLead = false;
	createPosMountFromBehind("chPlayerCharacter", ["chClaw"]);
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.setRoleSubmission();
	State.variables.sc.formatScenePassage();	
	setRefreshLustScript();
}
window.fakMoaningKittyEndCondition = function() {
	var flagReady = false;
	if ( getBarPercentage("chClaw","lust") <= 0.75 ) {
		flagReady = true;
	}
	return flagReady;
}
window.fakPlayerTakesClaw = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chClaw"],"Padmiri hides most of her face behind the scroll, but take a peek quite often.",fakMoaningKitty2EndCondition,4,
	"SE FAK Padmiri Gives In");
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.chPlayerCharacter.hasLead = true;
	State.variables.chClaw.hasLead = false;
	createPosMountFromBehind("chPlayerCharacter", ["chClaw"]);
	State.variables.sc.formatScenePassage();
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.setRoleSubmission();
	setRefreshLustScript();
}
window.fakMoaningKitty2EndCondition = function() {
	var flagReady = false;
	if ( getBarPercentage("chClaw","lust") <= 0.55 ) {
		flagReady = true;
	}
	return flagReady;
}
window.playerMirClawOrgasmEndCondition = function(none) {
	var flagEndScene = false;
	
	if ( State.variables.chPlayerCharacter.getAllSceneOrgasms() > 0 && State.variables.chClaw.getAllSceneOrgasms() > 0 && State.variables.chMir.getAllSceneOrgasms() > 0 ) {
		flagEndScene = true;
	}
	
	return flagEndScene;
}
window.fakClawGetsShared = function(targetPassage) {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter","chMir"],["chClaw"],"The scroll stands abandoned in top of the table.",playerMirClawOrgasmEndCondition,4,
	targetPassage);
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.chPlayerCharacter.hasLead = true;
	State.variables.chMir.hasLead = true;
	State.variables.chClaw.hasLead = false;
	createPosKneel("chMir",["chClaw"]);
	createComPosSpitroast("chPlayerCharacter","chClaw");
	State.variables.sc.formatScenePassage();
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.setRoleSubmission();
	State.variables.chMir.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chMir.aiAlgorythm.setRoleActive();
	setRefreshLustScript();
}
window.fakMirSubmits = function(targetPassage) {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chClaw","chMir"],"The scroll stands abandoned in top of the table.",playerMirClawOrgasmEndCondition,4,
	targetPassage);
	State.variables.chPlayerCharacter.hasLead = true;
	State.variables.chMir.hasLead = false;
	State.variables.chClaw.hasLead = false;
	State.variables.sc.formatScenePassage();
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.setRoleSubmission();
	State.variables.chMir.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chMir.aiAlgorythm.setRoleSubmission();
	setRefreshLustScript();
}
window.fakMirGetsShared = function(targetPassage) {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter","chClaw"],["chMir"],"The scroll stands abandoned in top of the table.",playerMirClawOrgasmEndCondition,4,
	targetPassage);
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.chPlayerCharacter.hasLead = true;
	State.variables.chMir.hasLead = false;
	State.variables.chClaw.hasLead = true;
	createPosKneel("chClaw",["chMir"]);
	createComPosSpitroast("chPlayerCharacter","chMir");
	State.variables.sc.formatScenePassage();
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.setRoleActive();
	State.variables.chMir.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chMir.aiAlgorythm.setRoleSubmission();
	setRefreshLustScript();
}

// Bondage Awakening
window.BoAwPadmiriAbusesTrio = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter","chNash","chClaw"],["chMir"],"Nothing disrupts the quietness of the lake, save for your moans.",mirTwoOrgasms,4,
	"SE BoAw Trapped Trio PostSex");
	State.variables.chPlayerCharacter.hasLead = false;
	State.variables.chMir.hasLead = true;
	State.variables.chClaw.hasLead = false;
	State.variables.chNash.hasLead = false;
	State.variables.sc.formatScenePassage();
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.setRoleSubmission();
	State.variables.chMir.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chMir.aiAlgorythm.setRoleDomination();
	State.variables.chNash.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chNash.aiAlgorythm.setRoleSubmission();
	setRefreshLustScript();
}
window.mirTwoOrgasms = function(none) {
	var flagEndScene = false;
	
	if ( State.variables.chMir.getAllSceneOrgasms() > 1 ) {
		flagEndScene = true;
	}
	
	return flagEndScene;
}
window.BoAwPlayerAbusesDuo = function(newPassage) {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chClaw","chNash"],"Nothing disrupts the quietness of the lake, save for your moans.",playerTwoOrgasms,4,
	newPassage);
	State.variables.chPlayerCharacter.hasLead = true;
	State.variables.chClaw.hasLead = false;
	State.variables.chNash.hasLead = false;
	State.variables.sc.formatScenePassage();
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.setRoleSubmission();
	State.variables.chNash.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chNash.aiAlgorythm.setRoleSubmission();
	setRefreshLustScript();
}
window.playerTwoOrgasms = function(none) {
	var flagEndScene = false;
	
	if ( State.variables.chPlayerCharacter.getAllSceneOrgasms() > 1 ) {
		flagEndScene = true;
	}
	
	return flagEndScene;
}
window.BoAwPairAbusesDuo = function(newPassage) {
	addSceneTagToChar("noLead","chClaw");
	addSceneTagToChar("noLead","chNash");
	State.variables.sc.startScene(
	"ss","dynamic",["chPlayerCharacter","chMir"],["chClaw","chNash"],"Nothing disrupts the quietness of the lake, save for your moans.",playerMirTwoOrgasms,4,
	newPassage);	
	State.variables.sc.formatScenePassage();
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.setRoleSubmission();
	State.variables.chMir.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chMir.aiAlgorythm.setRoleDomination();
	State.variables.chNash.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chNash.aiAlgorythm.setRoleSubmission();
	setRefreshLustScript();
}
window.playerMirTwoOrgasms = function(none) {
	var flagEndScene = false;
	
	if ( State.variables.chPlayerCharacter.getAllSceneOrgasms() > 1 && State.variables.chMir.getAllSceneOrgasms() > 1 ) {
		flagEndScene = true;
	}
	
	return flagEndScene;
}

// Blackmailed by Claw
	// Dommed by Claw
window.bbCdommedByClaw = function(newPassage) {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chClaw"],"You feel the strong grip of Claw on your skin.",clawTwoOrgasms,gSettings().stdSxScDur,
	newPassage);
	// Positioning, conditions
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.sc.sceneConditions.push("cantChangePositions");
	State.variables.chClaw.hasLead = true;
	State.variables.chPlayerCharacter.hasLead = false;
	createPosMountFromBehind("chClaw",["chPlayerCharacter"]);
	// Custom Dialogues
	State.variables.sc.setDialoguesList("bbCshutup");
	// Assign choices
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.fixedTarget = "chPlayerCharacter";
	State.variables.chClaw.aiAlgorythm.setRoleDomination();
	// Custom script
		// Set StVars.check4 to the sub char's current amount of orgasms
		// If check4 grows from the previous turn,
			// Chance for the sub character to moan, attracting attention
				// Update scene sub-description
				// Reduce character's reputation
			// Update check4 to new quantity
	State.variables.StVars.check4 = 0; // Sub's orgasm counter
	State.variables.StVars.check5 = "chClaw"; // Who's the sub to be checking
	if ( gC("chClaw").hasLead == true ) { State.variables.StVars.check5 = "chPlayerCharacter"; }
	State.variables.sc.customScript = function() {
		if ( gC(State.variables.StVars.check5).getAllSceneOrgasms() > State.variables.StVars.check4 ) { // Sub orgasmed
			State.variables.sc.importantMessages += gC(State.variables.StVars.check5).getFormattedName() + " can barely contain " + gC(State.variables.StVars.check5).refPr + ". //" + colorText(randomFromList(['"Nnggh..."','"Nhh-Aaaah!"','"Mmmhhhnn!"','"Hmmnn."']), gC(State.variables.StVars.check5).nameColor) + "//\n"
			+ "Barely seen by a Shapeshifter below, rumors spread and " + gC(State.variables.StVars.check5).getFormattedName() + "'s respect in the tribe slightly falls (-5).";
			gC(State.variables.StVars.check5).ssRsp -= 5;
			State.variables.StVars.check4 = gC(State.variables.StVars.check5).getAllSceneOrgasms();
		}
	}
	//
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.clawTwoOrgasms = function(none) {
	var flagEndScene = false;
	
	if ( State.variables.chClaw.getAllSceneOrgasms() > 1 ) {
		flagEndScene = true;
	}
	
	return flagEndScene;
}

	// Domming Claw
window.bbCdommingClaw = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chClaw"],"Claw pushes back against you, trying to stand away from the cliff.",playerTwoOrgasms,gSettings().stdSxScDur,
	"FASE BbC Dommed Claw");
	// Positioning, conditions
	State.variables.sc.sceneConditions.push("cantCancelPositions");
	State.variables.sc.sceneConditions.push("cantChangePositions");
	State.variables.chClaw.hasLead = false;
	State.variables.chPlayerCharacter.hasLead = true;
	createPosMountFromBehind("chPlayerCharacter",["chClaw"]);
	// Custom Dialogues
	State.variables.sc.setDialoguesList("bbCshutup");
	// Assign choices
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.setRoleSubmission();
	// Custom script
		// Set StVars.check4 to the sub char's current amount of orgasms
		// If check4 grows from the previous turn,
			// Chance for the sub character to moan, attracting attention
				// Update scene sub-description
				// Reduce character's reputation
			// Update check4 to new quantity
	State.variables.StVars.check4 = 0; // Sub's orgasm counter
	State.variables.StVars.check5 = "chClaw"; // Who's the sub to be checking
	if ( gC("chClaw").hasLead == true ) { State.variables.StVars.check5 = "chPlayerCharacter"; }
	State.variables.sc.customScript = function() {
		if ( gC(State.variables.StVars.check5).getAllSceneOrgasms() > State.variables.StVars.check4 ) { // Sub orgasmed
			State.variables.sc.importantMessages += gC(State.variables.StVars.check5).getFormattedName() + " can barely contain " + gC(State.variables.StVars.check5).refPr + ". //" + colorText(randomFromList(['"Nnggh..."','"Nhh-Aaaah!"','"Mmmhhhnn!"','"Hmmnn."']), gC(State.variables.StVars.check5).nameColor) + "//\n"
			+ "Barely seen by a Shapeshifter below, rumors spread and " + gC(State.variables.StVars.check5).getFormattedName() + "'s respect in the tribe slightly falls (-5).";
			gC(State.variables.StVars.check5).ssRsp -= 5;
			State.variables.StVars.check4 = gC(State.variables.StVars.check5).getAllSceneOrgasms();
		}
	}
	//
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}

	// Fighting Claw
window.bbCfightingClaw = function() {
	State.variables.sc.startScene( // Both you and your opponent catiously stand away from the edge of the cliff
	// FASE BbC Fight Victory
	// FASE BbC Fight Defeat
	"bs","fixed",["chPlayerCharacter"],["chClaw"],"__Caverns ~ Union Lake Upper Platform__\nBoth you and your opponent catiously stand away from the edge of the cliff.",createEndConditionStoryBattle("FASE BbC Fight Victory","FASE BbC Fight Defeat"),6,
	"FASE BbC Fight Victory");
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).aiAlgorythm = createAiEarlyStrategic();
		}
	}
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
	
// Dildo Play
window.dldPlyNashTopsPlayer = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chNash"],"Piles of materials, resources and crafts surround you, blocking the vision of any intruder. Of any new intruder, at least. Probably.",playerNnashTwoOrgasmsEndCondition,gSettings().stdSxScDur,
	"FASE DldPly NashTakesControl End");
	// Control
	State.variables.chNash.hasLead = true;
	State.variables.chPlayerCharacter.hasLead = false;
	// Assign choices
	State.variables.chNash.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chNash.aiAlgorythm.fixedTarget = "chPlayerCharacter";
	State.variables.chNash.aiAlgorythm.setRoleDomination();
	// Equip dildo on Nash
	unequipObject(State.variables.StVars.check1);
	unequipToolTypeFromChar("weaponID","chNash");
	equipObjectOnWearer(State.variables.StVars.check1,"chNash",-1);
	// Custom script
		// Chance for Nash to use dildo-related actions only, chance for Nash to use the usual aiAlgorythm
	State.variables.sc.customScript = function() {
		var flagNashChoosesDildoAction = true;
		if ( State.variables.chNash.aiAlgorythm.hasOwnProperty("missionCommands") ) {
			if ( State.variables.chNash.aiAlgorythm.missionCommands.length > 0 ) {
				flagNashChoosesDildoAction = false;
			}
		}
		if ( flagNashChoosesDildoAction ) {
			if ( limitedRandomInt(30) >= 20 ) { // Nash chooses dildo actions
				var possibleDildoChoices = ["dildoTeaseGenitals","dildoPenetratePussy","dildoPenetrateAss","dildoPenetrateMouth","thrustDildo","doubleDildoPussyPenetration","baDildoPenetratePussy","baThrustDildo","pushAgainstDildo"];
				possibleDildoChoices = purgeInvalidActionsFromListActorOnTarget(possibleDildoChoices,"chNash","chPlayerCharacter");
				if ( possibleDildoChoices.length > 0 ) {
					var fixedDildoChoices = [];
					for ( var ch of possibleDildoChoices ) {
						fixedDildoChoices.push(["chPlayerCharacter",ch]);
					}
					State.variables.chNash.aiAlgorythm = createAiRandomChoice(fixedDildoChoices);
					State.variables.chNash.aiAlgorythm.fixedTarget = "chPlayerCharacter";
				} else { flagNashChoosesDildoAction = false; }
			} else { flagNashChoosesDildoAction = false; }
		}
		if ( flagNashChoosesDildoAction == false ) {
			State.variables.chNash.aiAlgorythm = createAiWeightedMissionsByTaste();
			State.variables.chNash.aiAlgorythm.fixedTarget = "chPlayerCharacter";
			State.variables.chNash.aiAlgorythm.setRoleDomination();
		}
	}
	//
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.dldPlyEgaNashHasDildo = function() {
	State.variables.sc.startScene(
	"ss","dynamic",["chPlayerCharacter"],["chNash"],"Piles of materials, resources and crafts surround you, blocking the vision of any intruder. Of any new intruder, at least. Probably.",playerNnashTwoOrgasmsEndCondition,gSettings().stdSxScDur,
	"FASE DldPly EgaNashDld End");
	// Assign choices
	State.variables.chNash.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chNash.aiAlgorythm.fixedTarget = "chPlayerCharacter";
	State.variables.chNash.aiAlgorythm.setRoleActive();
	// Equip dildo on Nash
	unequipObject(State.variables.StVars.check1);
	unequipToolTypeFromChar("weaponID","chNash");
	equipObjectOnWearer(State.variables.StVars.check1,"chNash",-1);
	// Custom script
		// Chance for Nash to use dildo-related actions only, chance for Nash to use the usual aiAlgorythm
	State.variables.sc.customScript = function() {
		var flagNashChoosesDildoAction = true;
		if ( State.variables.chNash.aiAlgorythm.hasOwnProperty("missionCommands") ) {
			if ( State.variables.chNash.aiAlgorythm.missionCommands.length > 0 ) {
				flagNashChoosesDildoAction = false;
			}
		}
		if ( flagNashChoosesDildoAction ) {
			if ( limitedRandomInt(30) >= 20 ) { // Nash chooses dildo actions
				var possibleDildoChoices = ["dildoTeaseGenitals","dildoPenetratePussy","dildoPenetrateAss","dildoPenetrateMouth","thrustDildo","doubleDildoPussyPenetration","baDildoPenetratePussy","baThrustDildo","pushAgainstDildo"];
				possibleDildoChoices = purgeInvalidActionsFromListActorOnTarget(possibleDildoChoices,"chNash","chPlayerCharacter");
				if ( possibleDildoChoices.length > 0 ) {
					var fixedDildoChoices = [];
					for ( var ch of possibleDildoChoices ) {
						fixedDildoChoices.push(["chPlayerCharacter",ch]);
					}
					State.variables.chNash.aiAlgorythm = createAiRandomChoice(fixedDildoChoices);
					State.variables.chNash.aiAlgorythm.fixedTarget = "chPlayerCharacter";
				} else { flagNashChoosesDildoAction = false; }
			} else { flagNashChoosesDildoAction = false; }
		}
		if ( flagNashChoosesDildoAction == false ) {
			State.variables.chNash.aiAlgorythm = createAiWeightedMissionsByTaste();
			State.variables.chNash.aiAlgorythm.fixedTarget = "chPlayerCharacter";
			State.variables.chNash.aiAlgorythm.setRoleActive();
		}
	}
	//
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.dldPlyEgaPlayerHasDildo = function() {
	State.variables.sc.startScene(
	"ss","dynamic",["chPlayerCharacter"],["chNash"],"Piles of materials, resources and crafts surround you, blocking the vision of any intruder. Of any new intruder, at least. Probably.",playerNnashTwoOrgasmsEndCondition,gSettings().stdSxScDur,
	"FASE DldPly EgaPlayerDld End");
	// Assign choices
	State.variables.chNash.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chNash.aiAlgorythm.fixedTarget = "chPlayerCharacter";
	State.variables.chNash.aiAlgorythm.setRolePassive();
	// Equip dildo on PC
	unequipObject(State.variables.StVars.check1);
	unequipToolTypeFromChar("weaponID","chPlayerCharacter");
	equipObjectOnWearer(State.variables.StVars.check1,"chPlayerCharacter",-1);
		//
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}
window.dldPlyPlayerTopsNash = function() {
	State.variables.sc.startScene(
	"ss","fixed",["chPlayerCharacter"],["chNash"],"Piles of materials, resources and crafts surround you, blocking the vision of any intruder. Of any new intruder, at least. Probably.",playerNnashTwoOrgasmsEndCondition,gSettings().stdSxScDur,
	"FASE DldPly PlayerTakesControl End");
	// Control
	State.variables.chNash.hasLead = false;
	State.variables.chPlayerCharacter.hasLead = true;
	// Assign choices
	State.variables.chNash.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chNash.aiAlgorythm.fixedTarget = "chPlayerCharacter";
	State.variables.chNash.aiAlgorythm.setRoleSubmission();
	// Equip dildo on PC
	unequipObject(State.variables.StVars.check1);
	unequipToolTypeFromChar("weaponID","chPlayerCharacter");
	equipObjectOnWearer(State.variables.StVars.check1,"chPlayerCharacter",-1);
	//
	State.variables.sc.formatScenePassage();
	setRefreshLustScript();
}


//////// Codeblock originally created by greyelf ////////
/* Create the Right UI Bar. */
var $rightUiBar = $('<div id="right-ui-bar"></div>').insertAfter("#ui-bar");

var rightTray = $rightUiBar.append('<div id="right-ui-bar-tray"><button id="right-ui-bar-toggle" tabindex="0" title="Toggle the Right UI bar" aria-label="Toggle the Right UI bar" type="button"></button></div>');

var rightBody = $rightUiBar.append('<div id="right-ui-bar-body"></div>');

/* Attach the toggle button click. */
$rightUiBar.find('#right-ui-bar-toggle').ariaClick({label : "Toggle the Right UI bar"}, () => $rightUiBar.toggleClass('stowed'));

/* Automatically show the contents of the StoryRightSidebar passage in the right-ui-bar-body element. */
postrender["Display Right Sidebar Contents"] = function (content, taskName) {
	setPageElement('right-ui-bar-body', 'StoryRightSidebar');
};

////////////////////////////////////////////////////////////////// CUSTOM SCRIPTS //////////

// Customize portrait
window.assignPcPortrait = function() {
	switch(State.variables.StVars.temp2) {
		case "option1":
			gC("chPlayerCharacter").fullPortrait = function() {
				return "[img[img/portraits/mc1-full.png]]";
			}
			gC("chPlayerCharacter").avatar = function() {
				return "[img[img/portraits/mc1-avatar.png]]";
			}
			gC("chPlayerCharacter").fullPortraitL = "img/portraits/mc1-full.png";
			gC("chPlayerCharacter").avatarL = "img/portraits/mc1-avatar.png";
			break;
		case "option2":
			gC("chPlayerCharacter").fullPortrait = function() {
				return "[img[img/portraits/mc2-full.png]]";
			}
			gC("chPlayerCharacter").avatar = function() {
				return "[img[img/portraits/mc2-avatar.png]]";
			}
			gC("chPlayerCharacter").fullPortraitL = "img/portraits/mc2-full.png";
			gC("chPlayerCharacter").avatarL = "img/portraits/mc2-avatar.png";
			break;
		case "option3":
			gC("chPlayerCharacter").fullPortrait = function() {
				return "[img[img/portraits/mc3-full.png]]";
			}
			gC("chPlayerCharacter").avatar = function() {
				return "[img[img/portraits/mc3-avatar.png]]";
			}
			gC("chPlayerCharacter").fullPortraitL = "img/portraits/mc3-full.png";
			gC("chPlayerCharacter").avatarL = "img/portraits/mc3-avatar.png";
			break;
		case "optionCustom":
			gC("chPlayerCharacter").fullPortrait = function() {
				return "[img[img/portraits/custom-full.png]]";
			}
			gC("chPlayerCharacter").avatar = function() {
				return "[img[img/portraits/custom-avatar.png]]";
			}
			gC("chPlayerCharacter").fullPortraitL = "img/portraits/custom-full.png";
			gC("chPlayerCharacter").avatarL = "img/portraits/custom-avatar.png";
			break;
	}
}

// Customize stats
window.getSelectStatListBox = function(position) {
	var lb = '<<listbox "$selectedStats[' + position + ']" autoselect>>\n';
	for ( var st of getStatNamesArray() ) {
		lb += '<<option "' + firstToCap(st) + '" "' + st + '">>\n';
	}
	lb += '<</listbox>>';
	return lb;
}

State.variables.selectStatListBoxes = [ getSelectStatListBox(0) , getSelectStatListBox(1) , getSelectStatListBox(2), getSelectStatListBox(3), getSelectStatListBox(4), getSelectStatListBox(5) ];

window.applyPcStatBonusesWeaknesses = function() {
	var sts = State.variables.selectedStats;
	State.variables.chPlayerCharacter[sts[0]].value += 2;
	State.variables.chPlayerCharacter[sts[0]].affinity += 0.1;
	State.variables.chPlayerCharacter[sts[1]].value += 1;
	State.variables.chPlayerCharacter[sts[1]].affinity += 0.05;
	State.variables.chPlayerCharacter[sts[2]].value += 1;
	State.variables.chPlayerCharacter[sts[2]].affinity += 0.05;
	State.variables.chPlayerCharacter[sts[3]].value -= 2;
	State.variables.chPlayerCharacter[sts[3]].affinity -= 0.1;
	State.variables.chPlayerCharacter[sts[4]].value -= 1;
	State.variables.chPlayerCharacter[sts[4]].affinity -= 0.05;
	State.variables.chPlayerCharacter[sts[5]].value -= 1;
	State.variables.chPlayerCharacter[sts[5]].affinity -= 0.05
	
	recalculateMaxBars("chPlayerCharacter");
	// State.variables.chPlayerCharacter.recalculateMaxBars();
}

// Re-assignation
window.reassignPlayerStats = function() {
	var tempStat = gC("chPlayerCharacter")[State.variables.StVars.check1];
	gC("chPlayerCharacter")[State.variables.StVars.check1] = gC("chPlayerCharacter")[State.variables.StVars.check4];
	gC("chPlayerCharacter")[State.variables.StVars.check4] = tempStat;
	tempStat = gC("chPlayerCharacter")[State.variables.StVars.check2];
	gC("chPlayerCharacter")[State.variables.StVars.check2] = gC("chPlayerCharacter")[State.variables.StVars.check5];
	gC("chPlayerCharacter")[State.variables.StVars.check5] = tempStat;
	tempStat = gC("chPlayerCharacter")[State.variables.StVars.check3];
	gC("chPlayerCharacter")[State.variables.StVars.check3] = gC("chPlayerCharacter")[State.variables.StVars.check6];
	gC("chPlayerCharacter")[State.variables.StVars.check6] = tempStat;
	State.variables.StVarsList = arrayMinusA(State.variables.StVarsList,"go0");
}

// Old customize stats
window.returnAssignTalentsScript = function() {
	var script = returnAssignTalentScript("physique");
	script += returnAssignTalentScript("agility");
	script += returnAssignTalentScript("resilience");
	script += returnAssignTalentScript("will");
	script += returnAssignTalentScript("intelligence");
	script += returnAssignTalentScript("perception");
	script += returnAssignTalentScript("empathy");
	script += returnAssignTalentScript("charisma");
	script += returnAssignTalentScript("luck");
	script += "\n<<link [[Cancel all|CharCust 1]]>><<script>>unassignAllTalentVariations()<<" + "/script>><<" + "/link>>";
	return script;
}
window.returnAssignTalentScript = function(attribute) {
	var script = " ";
	if ( State.variables.StVars.pcMainDoom > 0 ) {
		script += "<<link [[<< |CharCust 1]]>><<" + "script>>";
		script += "assignPcGreatWeakness('" + attribute + "');"
		script += "<<" + "/script>><<" + "/link>> ";
	}
	if ( State.variables.StVars.pcDoom > 0 ) {
		script += "<<link [[< |CharCust 1]]>><<" + "script>>";
		script += "assignPcWeakness('" + attribute + "');"
		script += "<<" + "/script>><<" + "/link>> ";
	}
	script += firstToCap(attribute) + returnAttributeTooltip(attribute) + ": " + State.variables.chPlayerCharacter[attribute].value + " ";
	if ( State.variables.StVars.pcBoon > 0 ) {
		script += "<<link [[> |CharCust 1]]>><<" + "script>>";
		script += "assignPcTalent('" + attribute + "');"
		script += "<<" + "/script>><<" + "/link>> ";
	}
	if ( State.variables.StVars.pcMainBoon > 0 ) {
		script += "<<link [[>> |CharCust 1]]>><<" + "script>>";
		script += "assignPcGreatTalent('" + attribute + "');"
		script += "<<" + "/script>><<" + "/link>> ";
	}
	
	script += "\n";
	return script;
}

window.unassignTalentVariation = function(attribute) {
	switch(State.variables.chPlayerCharacter[attribute].value) {
		case 8:
			State.variables.StVars.pcMainDoom++;
			break;
		case 9:
			State.variables.StVars.pcDoom++;
			break;
		case 10:
			break;
		case 11:
			State.variables.StVars.pcBoon++;
			break;
		case 12:
			State.variables.StVars.pcMainBoon++;
			break;
		State.variables.chPlayerCharacter[attribute].value = 10;
		State.variables.chPlayerCharacter[attribute].affinity = 1.0;
	}
}
window.assignPcGreatWeakness = function(attribute) {
	unassignTalentVariation(attribute);
	State.variables.chPlayerCharacter[attribute].value = 8;
	State.variables.chPlayerCharacter[attribute].affinity = 0.8;
	State.variables.StVars.pcMainDoom--;
}
window.assignPcWeakness = function(attribute) {
	unassignTalentVariation(attribute);
	State.variables.chPlayerCharacter[attribute].value = 9;
	State.variables.chPlayerCharacter[attribute].affinity = 0.9;	
	State.variables.StVars.pcDoom--;
}
window.assignPcTalent = function(attribute) {
	unassignTalentVariation(attribute);
	State.variables.chPlayerCharacter[attribute].value = 11;
	State.variables.chPlayerCharacter[attribute].affinity = 1.1;
	State.variables.StVars.pcBoon--;
}
window.assignPcGreatTalent = function(attribute) {
	unassignTalentVariation(attribute);
	State.variables.chPlayerCharacter[attribute].value = 12;
	State.variables.chPlayerCharacter[attribute].affinity = 1.2;	
	State.variables.StVars.pcMainBoon--;
}
window.unassignAllTalentVariations = function() {
	State.variables.chPlayerCharacter.physique.value = 10;
	State.variables.chPlayerCharacter.physique.affinity = 1.0;
	State.variables.chPlayerCharacter.agility.value = 10;
	State.variables.chPlayerCharacter.agility.affinity = 1.0;
	State.variables.chPlayerCharacter.resilience.value = 10;
	State.variables.chPlayerCharacter.resilience.affinity = 1.0;
	State.variables.chPlayerCharacter.will.value = 10;
	State.variables.chPlayerCharacter.will.affinity = 1.0;
	State.variables.chPlayerCharacter.intelligence.value = 10;
	State.variables.chPlayerCharacter.intelligence.affinity = 1.0;
	State.variables.chPlayerCharacter.perception.value = 10;
	State.variables.chPlayerCharacter.perception.affinity = 1.0;
	State.variables.chPlayerCharacter.empathy.value = 10;
	State.variables.chPlayerCharacter.empathy.affinity = 1.0;
	State.variables.chPlayerCharacter.charisma.value = 10;
	State.variables.chPlayerCharacter.charisma.affinity = 1.0;
	State.variables.chPlayerCharacter.luck.value = 10;
	State.variables.chPlayerCharacter.luck.affinity = 1.0;
	State.variables.StVars.pcBoon = 2;
	State.variables.StVars.pcDoom = 2;
	State.variables.StVars.pcMainBoon = 1;
	State.variables.StVars.pcMainDoom = 1;	
}
window.returnAttributeTooltip = function(attribute) {
	var tooltip = "";
	switch (attribute) {
		case "physique":
			tooltip = "<span title='Physique is used in all actions related to pure physical strength,"
					+ " such as attacking with a blade or riding someone.'>^^(?)^^</span>";
			break;
		case "agility":
			tooltip = "<span title='Agility influences all actions that require physical dexterity,"
					+ " like dodging an arrow or licking someone´s pleasure parts.'>^^(?)^^</span>";
			break;
		case "resilience":
			tooltip = "<span title='Resilience is involved in all events related to physical endurance, "
					+ "such as receiving a punch and being mounted.'>^^(?)^^</span>";
			break;
		case "will":
			tooltip = "<span title='Will determines the strength of your character, which is important "
					+ "for arcane, social and sexual matters.'>^^(?)^^</span>";
			break;
		case "intelligence":
			tooltip = "<span title='Your intelligence helps you succeed at matters related to logic,"
					+ " such as casting spells.'>^^(?)^^</span>";
			break;
		case "perception":
			tooltip = "<span title='Your perception will help you at refining your senses, which may help you"
					+ " at hearing distant conversations, noticing obscure details or dodging a blow.'>^^(?)^^</span>";
			break;
		case "empathy":
			tooltip = "<span title='Empathy is your capacity to understand others. It will help you at"
					+ " developing your relationships and understanding people´s motivations.'>^^(?)^^</span>";
			break;
		case "charisma":
			tooltip = "<span title='Charisma is used to convey your feelings and heat up the emotions of"
					+ " others. It will help you at developing your relationships and preemptively watering groins.'>^^(?)^^</span>";
			break;
		case "luck":
			tooltip = "<span title='It may feel as if luck didn´t exist, but what tells you it doesn´t "
					+ "influence every single thing that happens to you?'>^^(?)^^</span>";
			break;
	}
	return tooltip;
}

// Tests
window.configureTestsRoomScene = function() {
	var leadType = "none";
	
	if ( State.variables.tsr.sceneType == "normalLead" ) {
		leadType = "dynamic";
	}
	else if ( State.variables.tsr.sceneType == "passive" ) {
		leadType = "fixed";
	}
	else if ( State.variables.tsr.sceneType == "active" ) {
		leadType = "fixed";
	}
	else if ( State.variables.tsr.sceneType == "romantic" ) {
		leadType = "dynamic";
	}
	else if ( State.variables.tsr.sceneType == "competition" ) {
		leadType = "dynamic";
	}
	else if ( State.variables.tsr.sceneType == "submission" ) {
		leadType = "fixed";
	}
	else if ( State.variables.tsr.sceneType == "domination" ) {
		leadType = "fixed";
	}
	
	State.variables.sc.startScene("ss", leadType,
		["chPlayerCharacter"], [State.variables.tsr.character],
		"wow such testz",endConditionTurns,100,
		"Testing Scenes Room");
	State.variables[State.variables.tsr.character].aiAlgorythm = createAiWeightedMissionsByTaste();
	// State.variables[State.variables.tsr.character].aiAlgorythm.fixedTarget = "chPlayerCharacter";
	switch ( State.variables.tsr.sceneType ) {
		case "normalLead":
			State.variables[State.variables.tsr.character].aiAlgorythm.setRoleEqualFooting();
			break;
		case "passive":
			State.variables[State.variables.tsr.character].aiAlgorythm.setRolePassive();
			State.variables.chPlayerCharacter.hasLead = true;
			break;
		case "active":
			State.variables[State.variables.tsr.character].aiAlgorythm.setRoleActive();
			State.variables[State.variables.tsr.character].hasLead = true;
			break;
		case "romantic":
			State.variables[State.variables.tsr.character].aiAlgorythm.setRoleRomantic();
			break;
		case "competition":
			State.variables[State.variables.tsr.character].aiAlgorythm.setRoleCompetition();
			break;
		case "submission":
			State.variables[State.variables.tsr.character].aiAlgorythm.setRoleSubmission();
			State.variables.chPlayerCharacter.hasLead = true;
			break;
		case "domination":
			State.variables[State.variables.tsr.character].aiAlgorythm.setRoleDomination();
			State.variables[State.variables.tsr.character].hasLead = true;
			break;
	}

	charactersLearnSceneActions(["chVal"],[
									"doublePenetration"
		]);
	State.variables.chVal.saList = ["doNothing", "struggle", "strokePussy", "lickGroin", "baKissLips", "baStrokeDick", "baStrokePussy", "baThrust", "baPushHipsBack", "baScissor", "baScissorBack", "baRideDick", "baPushDickBack", "coldGuts", "baTease", "embers", "freezeFeet", "sparkingRubbing", "thrust", "piston", "finalPush", "suckDick", "lickPussy", "scissor", "strokeAss", "analThrust", "dickFootjob", "pussyFootjob", "lickLegs", "pushHipsBack", "spanking", "fuckFace", "rideFace", "frenchKiss", "legHoldHead", "getBlowjob", "doublePenetration", "mountFaceToFace", "mountFromBehind", "pounceFrontalD2P", "pounceFrontalP2P", "pounceFrontalP2D", "doubleThrust","slimeHug","denyOrgasm"];
	//State.variables.chVal.tastes.bondage.w = 20000;
	//State.variables.chVal.tastes.domination.w = 20000;
	State.variables.chVal.tastes.denial.w = 2000;
}

window.configureBattleTestsRoomScene = function() {
	State.variables.sc.startScene("bs", "none",
		["chPlayerCharacter"], [State.variables.tsr.character],
		"wow such testz",endConditionTurns,100,
		"Testing Scenes Room");
	State.variables[State.variables.tsr.character].aiAlgorythm = createAiEarlyStrategic();
}

window.setUpTestScenesRoom = function() {
	charactersLearnSceneActions(getCandidatesKeysArray(),["strokePussy","strokeBreasts","kissLips","frottage","frenchKiss","kneel","makeKneel","lickGroin",
	"legHoldHead","mountFromBehind","penetratePussy","thrust","piston","finalPush","mountFaceToFace","getBlowjob","suckDick","lickPussy","interlockLegs",
	"scissor","strokeAss","penetrateAss","analThrust","holdArms","vinesHoldArms","dickFootjob","pussyFootjob","lickLegs","rideDick","pushDickBack","extraMountFromBehind","analMountDick","analRideDick","analPushDickBack"]);
	
	charactersLearnSceneActions(["chPlayerCharacter"],[
									"kick","coldGuts",
									"embers","freezeFeet","sparkingRubbing",
									"taunt","baTease"
									,"realHypnoticGlance"
									,"energyDrainingKiss"
									,"baEtherealChains","etherealChains",
									"denyOrgasm","teaseLockedPussy","teaseLockedDick"
		]);
	charactersLearnSceneActions(["chVal"],[
									"denyOrgasm","teaseLockedPussy","teaseLockedDick"
		]);
}

window.setUpBattleTestsRoom = function() {
	/*
	
									"baKissLips","baStrokeDick","baStrokePussy",
									"pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D",
									"baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack",
									"kick","coldGuts",
									"embers","freezeFeet","sparkingRubbing",
									"taunt","baTease"
									*/
	// Chars learn battle moves here
	charactersLearnSceneActions(getCandidatesKeysArray(),[
									"baKissLips","baStrokeDick","baStrokePussy",
									"pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D",
									"baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","baTeaseLockedDick","baTeaseLockedPussy","pounceFrontal"
		]);
	charactersLearnSceneActions(["chPlayerCharacter"],[
									"kick","coldGuts",
									"embers","freezeFeet","sparkingRubbing",
									"taunt","baTease"
									,"baHypnoticGlance"
									,"baEnergyDrainingKiss","baDrainingKiss","baEtherealChains"
		]);
	charactersLearnSceneActions(["chNash","chClaw"],[
									"kick","coldGuts",
									"taunt"
		]);
	charactersLearnSceneActions(["chMir","chVal","chAte"],[
									"embers","freezeFeet","sparkingRubbing",
		]);
	charactersLearnSceneActions(["chVal"],[
									"baTease",
		]);
	for ( var character of getCandidatesKeysArray() ) {
		recalculateMaxBars(character);
		// gC(character).recalculateMaxBars();
		gC(character).restoreBars();
	}
}

window.setUpMultiBattleTest = function() {
	// Init setup
	//State.variables.chPlayerCharacter.agility.value = 50;
	//State.variables.chPlayerCharacter.physique.value = 50;
	//State.variables.chPlayerCharacter.intelligence.value = 50;
	//State.variables.chPlayerCharacter.luck.value = 50;
	charactersLearnSceneActions(getCandidatesKeysArray(),[
									"baKissLips","baStrokeDick","baStrokePussy",
									"pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D",
									"baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack"
		]);
	charactersLearnSceneActions(["chPlayerCharacter"],[
									"kick","coldGuts",
									"embers","freezeFeet","sparkingRubbing",
									"taunt","baTease"
									,"baHypnoticGlance"
									,"baEnergyDrainingKiss","baDrainingKiss","baEtherealChains",
									"baBorrowedIdentity"
		]);
	charactersLearnSceneActions(["chNash","chClaw"],[
									"kick","coldGuts",
									"taunt"
		]);
	charactersLearnSceneActions(["chMir","chVal","chAte"],[
									"embers","freezeFeet","sparkingRubbing",
		]);
	charactersLearnSceneActions(["chVal"],[
									"baTease",
									"baBorrowedIdentity"
		]);
	for ( var character of getCandidatesKeysArray() ) {
		recalculateMaxBars(character);
		// gC(character).recalculateMaxBars();
		gC(character).restoreBars();
	}
		
	var dilID = createEquipment("w5","chPlayerCharacter");
	equipObjectOnWearer(dilID,"chPlayerCharacter",-1);
	
	// Start scene
	State.variables.sc.startScene("bs", "none",
		["chPlayerCharacter","chAte"], ["chNash","chVal"],
		"wow such testz",endConditionStandardBattle,100,
		"Testing Scenes Room");
	State.variables.chAte.aiAlgorythm = createAiEarlyStrategic();
	State.variables.chNash.aiAlgorythm = createAiEarlyStrategic();
	State.variables.chVal.aiAlgorythm = createAiEarlyStrategic();
	
	//State.variables.chNash.lust.current = 1;
	//State.variables.chVal.lust.current = 25;
}

window.setUpMultiSexTest = function() {
	gC("chPlayerCharacter").addBodypart("dick","dick");
	gC("chVal").addBodypart("dick","dick");
	gC("chMir").addBodypart("dick","dick");
	charactersLearnSceneActions(getCandidatesKeysArray(),["strokePussy","strokeBreasts","kissLips","frottage","frenchKiss","kneel","makeKneel","lickGroin",
	"legHoldHead","mountFromBehind","penetratePussy","thrust","piston","finalPush","mountFaceToFace","getBlowjob","suckDick","lickPussy","interlockLegs",
	"scissor","strokeAss","penetrateAss","analThrust","holdArms","vinesHoldArms","dickFootjob","pussyFootjob","lickLegs","rideDick","pushDickBack","extraMountFromBehind"]);
	
	//addSceneTagToChar("noLead","chMir");
	
	State.variables.sc.startScene("ss", "dynamic",
		["chPlayerCharacter"], ["chMir","chVal"],
		"wow such testz",endConditionTurns,100,
		"Testing Scenes Room");
		
	State.variables["chMir"].aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables["chVal"].aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables["chMir"].aiAlgorythm.setRoleEqualFooting();
	State.variables["chVal"].aiAlgorythm.setRoleEqualFooting();
	
	createPosMountFaceToFace("chVal",["chMir"]);
	gC("chPlayerCharacter").hasLead = true;
	gC("chVal").lead = 0;
	gC("chVal").hasLead = false;
}
window.setUpMultiSexTestAlt = function() {
	gC("chPlayerCharacter").addBodypart("dick","dick");
	gC("chVal").addBodypart("dick","dick");
	gC("chMir").addBodypart("dick","dick");
	charactersLearnSceneActions(getCandidatesKeysArray(),["strokePussy","strokeBreasts","kissLips","frottage","frenchKiss","kneel","makeKneel","lickGroin",
	"legHoldHead","mountFromBehind","penetratePussy","thrust","piston","finalPush","mountFaceToFace","getBlowjob","suckDick","lickPussy","interlockLegs",
	"scissor","strokeAss","penetrateAss","analThrust","holdArms","vinesHoldArms","dickFootjob","pussyFootjob","lickLegs","rideDick","pushDickBack","extraMountFromBehind","extraKneel","extraMakeKneel","extraLegHoldHead","giveCunnilingus","giveBlowjob"]);
	
	addSceneTagToChar("noLead","chMir");
	addSceneTagToChar("noLead","chVal");
	
	State.variables.sc.startScene("ss", "dynamic",
		["chPlayerCharacter"], ["chMir","chVal"],
		"wow such testz",endConditionTurns,100,
		"Testing Scenes Room");
		
	createPosKneel("chPlayerCharacter",["chMir"]);
	//createComPosDoubleKneeling("chVal","chPlayerCharacter");
		
	State.variables["chMir"].aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables["chVal"].aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables["chMir"].aiAlgorythm.setRoleEqualFooting();
	State.variables["chVal"].aiAlgorythm.setRoleEqualFooting();
}

// Training
window.addExpToChar = function(charKey,baseStat,exp) {
	var rExp = State.variables[charKey][baseStat].affinity * exp;
	State.variables[charKey][baseStat].experience += rExp;
}

// Altered States
window.applyAetherialBondageToChars = function(charList,intensity,days) {
	for ( var cK of charList ) {
		if ( gC(cK).hasFreeBodypart("arms") ) {
			applyAlteredState([cK],createASaetChainedArms(intensity,days));
		}
		if ( gC(cK).hasFreeBodypart("legs") ) {
			applyAlteredState([cK],createASaetChainedLegs(intensity,days));
		}
		if ( gC(cK).hasFreeBodypart("mouth") ) {
			applyAlteredState([cK],createASaetChainedMouth(intensity,days));
		}
	}
}
window.applyVinesBondageToChars = function(charList,intensity,days) {
	for ( var cK of charList ) {
		if ( gC(cK).hasFreeBodypart("arms") ) {
			applyAlteredState([cK],createASvinChainedArms(intensity,days));
		}
		if ( gC(cK).hasFreeBodypart("legs") ) {
			applyAlteredState([cK],createASvinChainedLegs(intensity,days));
		}
		if ( gC(cK).hasFreeBodypart("mouth") ) {
			applyAlteredState([cK],createASvinChainedMouth(intensity,days));
		}
	}
}

////////// SIMULATION CYCLE PARAMETERS CLASS  //////////
// Global simulation parameters

window.SimCycPar = function() {
	this.templeDayPeriod = "training"; // "training" or "socialization"
	
	this.templeTrainingHours = 5;
	this.templeWorkHours = 5;
	this.templeSocializationHours = 5;
	this.templeNewDayTime = 7;
	
	this.trainingResultsBase = 1.0;
	this.trainingResultsModifier = 1.0;
	this.trainingCostBase = 1.0;
	this.trainingCostModifier = 1.0;
	this.restingResultsBase = 1.0;
	this.restingResultsModifier = 1.0;
};

State.variables.simCycPar = new SimCycPar();

window.trainingResultsVar = function() {
	// Returns a float that is to be multiplied by training returns
	var result = State.variables.simCycPar.trainingResultsBase * State.variables.simCycPar.trainingResultsModifier;
	return result;
}
window.trainingCostVar = function() {
	// Returns a float that is to be multiplied by training costs
	var result = State.variables.simCycPar.trainingCostBase * State.variables.simCycPar.trainingCostModifier;
	return result;
}
window.restingResultsVar = function() {
	// Returns a float that is to be multiplied by training returns
	var result = State.variables.simCycPar.restingResultsBase * State.variables.simCycPar.restingResultsModifier;
	return result;
}

// Constructors, serializers, etc.
SimCycPar.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
SimCycPar.prototype.clone = function () {
	return (new SimCycPar())._init(this);
};
SimCycPar.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new SimCycPar())._init($ReviveData$)', ownData);
};

////////// DAY CYCLE CLASS  //////////
// Day Cycle contains and regulates information about current hour and day, which is often used during the simulation.

window.DayCycle = function() {
	this.hours = 0;
	this.minutes = 0;
	this.day = 1;
	this.month = 1;
	
	this.addMinutes = function(min) {
		
		var fiveMinsPeriods = this.getFiveMinsPeriods(min);
		var i = 0;
		while ( i < fiveMinsPeriods ) {
			this.fiveMinEffects();
			i++;
		}
		
		this.minutes += min;
		if ( this.minutes >= 60 ) {
			var extraHours = float2int(this.minutes / 60);
			this.minutes -= 60*extraHours;
			this.addHours(extraHours);
		}
	}
	this.addHours = function(hours) {
		this.hours += hours;
		// Summing days manually avoids some trouble
		/*
		if ( this.hours >= 24 ) {
			var extraDays = float2int(this.hours / 24);
			this.hours -= 24*extraDays;
			this.addDays(extraDays);
		}
		*/
		var i = 0;
		while ( i < hours ) {
			this.hourlyEffects();
			i++;
		}
	}
	this.addDays = function(days) {
		this.day += days;
		if ( this.day >= 31 ) {
			var extraMonths = float2int(this.day / 30);
			this.day -= 30*extraMonths;
			this.addMonths(extraMonths);
		}
	}
	this.addMonths = function(months) {
		this.month += months;
		if ( this.month >= 13 ) {
			var extraYears = float2int(this.month / 12);
			this.month -= 12*extraYears;
		}
	}
	this.setDate = function(month,day,hours,minutes) {
		this.month = month;
		this.day = day;
		this.hours = hours;
		this.minutes = minutes;
	}
	
	this.returnHourMin = function() {
		var string = String(this.hours).padStart(2,'0') + ":" + String(this.minutes).padStart(2,'0');
		return string;
	}
	this.returnMonthDay = function() {
		var string = "M" + this.month + " - D" + this.day;
		return string;
	}
	
	this.getFiveMinsPeriods = function(addedMins) {
		var initialQuotient = Math.floor(addedMins/5);
		var extraPeriod = 0;
		if ( (this.minutes % 5) + (addedMins % 5) ) {
			extraPeriod++;
		}
		var result = initialQuotient + extraPeriod;
		return result;
	}
	
	this.fiveMinEffects = function() {
		if ( isMapSimActive() ) {
			for ( var character of getCurrentMap().characters ) {
				gC(character).applyMoodDecay();
			}
		}
	}
	this.hourlyEffects = function() {
		// Natural recovery
		if ( isMapSimActive() ) {
			for ( var character of getCurrentMap().characters ) {
				characterNaturalRest(character,60);
			}
		}
	}
};

window.characterNaturalRest = function(character,minutes) {
	var percent = 0.02 * (minutes/60) * restingResultsVar();
	for ( var bar of ["lust","willpower","energy","socialdrive"] ) {
		charRecoversBarPercent(character,bar,percent);
	}
}

window.calculateMinutesDifference = function(hoursA,minutesA,hoursB,minutesB) {
	var result = 0;
	result += (hoursA - hoursB) * 60;
	result += minutesA - minutesB;
	return result;
}
window.calculateMinsDiffFromCurrentTime = function(hoursB,minutesB) {
	var result = 0;
	var hoursA = State.variables.daycycle.hours;
	var minutesA = State.variables.daycycle.minutes;
	result += (hoursA - hoursB) * 60;
	result += minutesA - minutesB;
	return result;
}

window.getTimeObject = function(hours,minutes) {
	var timeObject = new DayCycle();
	timeObject.minutes = minutes;
	timeObject.hours = hours;
	return timeObject;
}
window.getRelativeTimeString = function(addedMinutes) {
	// Creates a timeObject with current hours and minutes, adds a certain amount of minutes to it, then returns a string with the new hours/minutes
	var newTimeObject = getTimeObject(State.variables.daycycle.hours,State.variables.daycycle.minutes);
	newTimeObject.addMinutes(addedMinutes);
	return newTimeObject.returnHourMin();
}

///// Day Cycle
State.variables.daycycle = new DayCycle();
State.variables.daycycle.setDate(1,1,8,0);

// Constructors, serializers, etc.
DayCycle.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

DayCycle.prototype.clone = function () {
	return (new DayCycle())._init(this);
};

DayCycle.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new DayCycle())._init($ReviveData$)', ownData);
};
setup.cursorHalfX = 10;
setup.cursorHalfY = 10;

////////// Map functions //////////
	// Management / Info
window.getLinkToRoom = function(roomKey,message,distance) {
	var string = '[img[img/mapIcons/' + getRoomInfoA(roomKey).icon + ']] <<link [[' + message + '|Map]]>><<script>>'
		   + 'State.variables.compass.playerMovesToRoom("' + roomKey + '",' + distance + ');'
		   + '<</' + 'script>><</' + 'link>>';
	return string;
}
window.getMap = function(mapKey) {
	return State.variables[mapKey];
}
window.getMapInfo = function(mapKey) {
	return setup[mapKey];
}
window.getCurrentMap = function () {
	return State.variables[State.variables.compass.currentMap];
}
window.getCurrentRoom = function() {
	return State.variables[State.variables.compass.currentMap].rooms[State.variables.compass.currentRoom];
}
window.getCurrentRoomInfo = function() {
	return setup[State.variables.compass.currentMap][State.variables.compass.currentRoom];
}
window.getRoomA = function(roomKey) { // Assumes the room's map is active
	return State.variables[State.variables.compass.currentMap].rooms[roomKey];
}
window.getRoomInfoA = function(roomKey) { // Assumes the room's map is active
	return setup[State.variables.compass.currentMap][roomKey];
}
window.getRoomInMap = function(mapKey,roomKey) {
	return State.variables[mapKey].rooms[roomKey];
}
window.getRoomInfoInMap = function(mapKey,roomKey) {
	return setup[mapKey][roomKey];
}
window.getCharsRoom = function(charKey) {
	return getRoomA(gC(charKey).currentRoom);
}

window.getEventsWherCharIsInvolved = function(character) {
	var events = [];
	for ( var sEvent of State.variables.compass.ongoingEvents ) {
		if ( sEvent.characters.includes(character) ) {
			events.push(sEvent);
		}
	}
	return events;
}
window.getCharsActiveEvent = function(character) {
	var tEvent = null;
	var events = getEventsWherCharIsInvolved(character);
	for ( var sEvent of events ) {
		if ( sEvent.flagForcedToEnd == false && tEvent == null ) {
			tEvent = sEvent;
		}
	}
	return tEvent;
}
window.mayCharBeInterrupted = function(character) {
	var flagMayBeInterrupted = true;
		var tEvent = getCharsActiveEvent(character);
		if ( tEvent ) {
			flagMayBeInterrupted = tEvent.flagMayBeInterrupted;
		}
	return flagMayBeInterrupted;
}
window.mayCharBeApproached = function(actor,target) {
	var flag = false;
	if ( mayCharBeInterrupted(target) && (gC(target).followingTo == "" || gC(target).followingTo == actor) ) {
		flag = true;
	}
	return flag;
}

window.mayEventBeSpectated = function(sEvent) {
	var flag = false;
	if ( sEvent ) {
		if ( sEvent.title == "battle" || sEvent.title == "scene" ) {
			if ( sEvent.characters.includes("chPlayerCharacter") == false && gC("chPlayerCharacter").followingTo == "" ) {
			// if ( sEvent.charactersTeamA.includes("chPlayerCharacter") == false && sEvent.charactersTeamB.includes("chPlayerCharacter") == false ) {
				flag = true;
			}
		}
	}
	return flag;
}
window.mayBattleBeJoined = function(sEvent) {
	var flag = false;
	if ( sEvent ) {
		if ( sEvent.title == "battle" ) {
			if ( sEvent.characters.includes("chPlayerCharacter") == false && gC("chPlayerCharacter").followingTo == "" && sEvent.hasOwnProperty("label") ) {
				if ( sEvent.label == "assault" ) {
					flag = true;
				}
			}
		}
	}
	return flag;
}
window.mayBattleBeJoinedByChar = function(sEvent,charKey) {
	var flag = false;
	if ( sEvent ) {
		if ( sEvent.title == "battle" ) {
			if ( sEvent.characters.includes(charKey) == false && gC(charKey).followingTo == "" && sEvent.hasOwnProperty("label") ) {
				if ( sEvent.label == "assault" ) {
					flag = true;
				}
			}
		}
	}
	return flag;
}

window.getSisCharIsIn = function(character) {
	var sisKey = State.variables.compass.findFirstSisIdInvolvingCharacter(character);
	return State.variables.compass.sisList[sisKey];
}

window.isCharInScene = function(character) {
	var isInScene = false;
	var sEvent = getCharsActiveEvent(character);
	if ( sEvent ) {
		if ( sEvent.title == "scene" || sEvent.title == "battle" ) {
			isInScene = true;
		}
	}
	return isInScene;
}

window.charLeavesAnySis = function(character) {
	var sisKey = State.variables.compass.findFirstSisIdInvolvingCharacter(character);
	if ( sisKey != -1 ) {
		State.variables.compass.sisList[sisKey].charLeavesSis(character);
	}
}

	// Create movement events
window.createSystemEventMovement = function(minutes, characters, roomKey) {
	var sEvent = new systemEvent(minutes,characters,"movement","Moving",function(cList) {
			State.variables.compass.moveCharsToRoom(cList,roomKey);
			
			var eventMsg = "Characters moved.";
			return eventMsg;
		}
	);
	sEvent.applyEffectIfForcedToEnd = false;
	sEvent.roomKey = roomKey;
	sEvent.priority = -1;
	return sEvent;
}
window.createSystemEventMovementByConnection = function(connection, characters) {
	var mins = State.variables.compass.getStandardMovementTime(connection.distance,characters);
	return createSystemEventMovement(mins,characters,connection.loc);
}

	// Group management
State.variables.debugAlwaysAcceptSis = false;

window.eitherCreateSisOrRejectSis = function(targetChar) { // Function called when player attempts to talk to character	
														   // It either creates a SIS or communicates player that SIS was rejected
	var acceptedSis = doesTargetAcceptConversation("chPlayerCharacter",targetChar);
	var acceptedSisFlag = acceptedSis[0];
	
	if ( acceptedSisFlag || State.variables.debugAlwaysAcceptSis || getCharGroup(targetChar).includes("chPlayerCharacter") ) {	// Create Sis
		State.variables.compass.createNewSis(getCharGroup('chPlayerCharacter').concat(getCharGroup(targetChar)));
		State.variables.sisPlayerInfo.lastTarget = targetChar;
		State.variables.sisPlayerInfo.currentTarget = targetChar;
		State.variables.sisSpecifics.playerTarget = targetChar;
	}
	else {
		State.variables.compass.pcSis = -1;
		State.variables.sisPlayerInfo.flagRejectedSis = true;
		State.variables.sisPlayerInfo.rejectedSisPassage = "" + gC(targetChar).getFormattedName() + " rejected the conversation.\n"
				+ acceptedSis[1] // Info about why SIS was rejected
				+ colorText("\nTip: There are many reasons why a character may reject a conversation, but the most common include "
				+ "being angry or bored, having specific priorities, or wanting to make full use of the training period.\n\n","khaki")
				+ getButtonExitRejectedSis();
		State.variables.compass.sisPassage = State.variables.sisPlayerInfo.rejectedSisPassage;
	}
}
	
window.charBecomesFollower = function(charKey) {
	// Char's AI shuts down
	signCharsActive([charKey]);
	gC(charKey).mapAi.goalsList = [];
	// Char leaves current event
	var cEvent = State.variables.compass.findFirstEventInvolvingCharacter(charKey);
	if ( cEvent ) { // Not null -> Event exists
		cEvent.removeCharFromEvent(charKey); // Character leaves the event
	}
	
	// Char leaves SIS
	var cSisId = State.variables.compass.findFirstSisIdInvolvingCharacter(charKey);
	if ( cSisId != -1 ) {
		State.variables.compass.sisList[cSisId].charsLeaveSis([charKey]);
	}
	if ( charKey == "chPlayerCharacter" ) {
		State.variables.compass.pcSis = -1;
	}
	
	// Char joins followed's event
	var nEvent = State.variables.compass.findFirstEventInvolvingCharacter(gC(charKey).followingTo);
	if ( nEvent ) {
		if ( nEvent.ongoingTime == 0 ) {
			nEvent.characters.push(charKey);
		}
	}
		
}
window.charUnbecomesFollower = function(charKey) {
	signCharsIdle([charKey]);
}

window.charMayModifyGroup = function(charKey) {
	var flagMayModify = true;
	
	var eventsList = State.variables.compass.findAllEventsInvolvingCharacter(charKey);
	for ( var sEvent of eventsList ) {
		if ( sEvent.flagMayChangeGroups == false ) {
			flagMayModify = false;
		}
	}
	
	return flagMayModify;
}

window.playerJoinsTargetChar = function(charKey) {
	var sEvent = State.variables.compass.findFirstEventInvolvingCharacter(charKey); /*
	if ( sEvent ) {
		if ( sEvent.title == "movement" || sEvent.ongoingTime == 0 ) {
			sEvent.characters.push("chPlayerCharacter");
		}
	} */
}
window.playerLeavesTargetChar = function(charKey) {
	var sEvent = State.variables.compass.findFirstEventInvolvingCharacter(charKey);
	if ( sEvent ) {
		sEvent.removeCharFromEvent("chPlayerCharacter");
	}
}
window.playerJoinsFollowedSis = function() {
	var f = gC("chPlayerCharacter").followingTo;
	if ( f != "" ) {
		var sis = findFirstSisIdInvolvingCharacter(f);
		if ( sis != -1 ) {
			State.variables.compass.sisList[sis].charJoinsSis("chPlayerCharacter");
		}
	}
}

		// Auxiliar
window.charArefusesToFollowCharacterB = function(charA,charB) {
	var favor = rFavor(charA,charB);
	if ( favor > 0 ) {
		getRelation(charB,charA).enmity.stv += 150;
	}
}

	// Logic
window.willFirstEventFinishSooner = function(firstEvent,secondEvent) {
	var flag = false;
	if ( firstEvent.timeRemaining <= secondEvent.timeRemaining ) {
		if ( firstEvent.timeRemaining == secondEvent.timeRemaining ) {
			if ( secondEvent.characters.includes("chPlayerCharacter") ) {
				flag = true;
			}
		} else {
			flag = true;
		}
	}
	return flag;
}

	// Logic/Engine
window.eventToPile = function(sEvent) {
	State.variables.compass.ongoingEvents.push(sEvent);
	State.variables.compass.sortOnGoingEventsByTime();
	signCharsActive(sEvent.characters);
}

window.signCharsIdle = function(characters) {
	for ( var character of characters ) {
		gC(character).mapAi.signIdle();
	}
}
window.signCharsActive = function(characters) {
	for ( var character of characters ) {
		gC(character).mapAi.signActive();
	}
}

	// Battles
window.initiatePlayerAssault = function(target) {
	// Infamy
	var infamy = getCharGroup("chPlayerCharacter").length * 3 / getCharGroup(target).length;
	if ( gC("chPlayerCharacter").cbl.includes(target) ) {
		infamy = 0;
		gC("chPlayerCharacter").cbl = arrayMinusA(gC("chPlayerCharacter").cbl,target);
	}
	gC("chPlayerCharacter").changeInfamy(infamy);
	// Mood
	gC(target).mood.applyChange("angry",25);
	// Initiate Battle
		// Event
	var allChars = getCharGroup("chPlayerCharacter").concat(getCharGroup(target));
	for ( var charKey of allChars ) {
		charLeavesAnySis(charKey);
		State.variables.compass.characterEventEndsPrematurely(charKey);
	}
	signCharsActive(allChars);
	State.variables.compass.ongoingEvents.push(createSystemEventStandardAssault(getCharGroup("chPlayerCharacter"),getCharGroup(target),[]));
	State.variables.compass.sortOnGoingEventsByTime();
	State.variables.compass.pushAllTimeToAdvance();
	
	// Message
	var iText = "You're assaulting " + getCharNames(getCharGroup(target)) + "!\n"
			  + "You have gained " + infamy.toFixed(1) + " infamy.\n\n"
			  + "[[Continue|Scene]]";
	State.variables.compass.setInterludeTrigger(iText);
}
window.initiateNpcAssault = function(actor,target) {
	if ( gC(actor).hasOwnProperty("globalAi") ) {
		if ( gC(actor).globalAi.hasOwnProperty("attackedToday") ) {
			gC(actor).globalAi.attackedToday = true;
		}
	}
	
	// Infamy
	var infamy = getCharGroup(actor).length * 3 / getCharGroup(target).length;
	if ( gC(actor).cbl.includes(target) ) {
		infamy = 0;
		gC(actor).cbl = arrayMinusA(gC(actor).cbl,target);
	}
	gC(actor).changeInfamy(infamy);
	// Mood
	gC(target).mood.applyChange("angry",25);
	// Initiate Battle
		// Event
	var allChars = getCharGroup(actor).concat(getCharGroup(target));
	for ( var charKey of allChars ) {
		charLeavesAnySis(charKey);
		State.variables.compass.characterEventEndsPrematurely(charKey);
	}
	signCharsActive(allChars);
	State.variables.compass.ongoingEvents.push(createSystemEventStandardAssault(getCharGroup(actor),getCharGroup(target),[]));
	State.variables.compass.sortOnGoingEventsByTime();
	
	if ( allChars.includes("chPlayerCharacter") ) {
		State.variables.compass.timeToAdvance = 0;
	}
}

window.initiateLiberationChallenge = function(actor,target) {
	addDayTagToChar("liberationAttempt",actor);
	// Initiate Battle
		// Event
	var allChars = getCharGroup(target);
	var spectators = arrayMinusA(arrayMinusA(allChars,actor),target);
	for ( var charKey of allChars ) {
		charLeavesAnySis(charKey);
		State.variables.compass.characterEventEndsPrematurely(charKey);
	}
	signCharsActive(allChars);
	
	State.variables.compass.ongoingEvents.push(createSystemEventLiberationChallenge([actor],[target],spectators));
	State.variables.compass.sortOnGoingEventsByTime();
	
	if ( allChars.includes("chPlayerCharacter") && target != "chPlayerCharacter" ) {
		State.variables.compass.timeToAdvance = 0;
		State.variables.compass.pushAllTimeToAdvance();
	}
	
	if ( actor == "chPlayerCharacter" ) {
		var iText = "You're challenging " + getCharNames(getCharGroup(target)) + " to finish your relationship!\n"
				  + "[[Continue|Scene]]";
		State.variables.compass.setInterludeTrigger(iText);
	} else if ( target == "chPlayerCharacter" ) {
		var playerEvent = State.variables.compass.findFirstEventInvolvingPlayer();
		var gD = chooseDialogFromList(setup.dialogDB.icDialogs,actor,"chPlayerCharacter","","");
		var p = gD + "\n" + gC(actor).getFormattedName() + " is initiating a liberation challenge against you!\n\n";
		p += getButtonBeingAssaulted(actor);
		State.variables.compass.setPlayerPrompt(p,actor,true);
	}
}

window.setUpPlayerChallengeOptions = function(target) {
	// Set up options
	var oText = "Challenge this character to a one on one battle.\nThe higher the stakes, the higher the demand the winner may make on the loser.\n\n";
	oText += "- <<l" + "ink [[Challenge for low stakes|Interlude]]>><<s" + "cript>>\n";
	oText += "processNpcChallengeResponse('" + target + "',1);\n";
	oText += "<</s" + "cript>><</l" + "ink>>\n";
	oText += "- <<l" + "ink [[Challenge for medium stakes|Interlude]]>><<s" + "cript>>\n";
	oText += "processNpcChallengeResponse('" + target + "',2);\n";
	oText += "<</s" + "cript>><</l" + "ink>>\n";
	oText += "- <<l" + "ink [[Challenge for high stakes|Interlude]]>><<s" + "cript>>\n";
	oText += "processNpcChallengeResponse('" + target + "',3);\n";
	oText += "<</s" + "cript>><</l" + "ink>>\n";
	oText += "- <<l" + "ink [[On a second thought, let's leave|Map]]>><<s" + "cript>>\n";
	oText += "<</s" + "cript>><</l" + "ink>>";			  
	
	State.variables.compass.setInterludeTrigger(oText);
}
window.processNpcChallengeResponse = function(target,stakes) {
	var flagAccepts = doesTargetAcceptChallenge("chPlayerCharacter",target,stakes);
	var msg = "";
	
	// Infamy
	var infamy = 1;
	if ( gC("chPlayerCharacter").cbl.includes(target) ) {
		infamy = 0;
		gC("chPlayerCharacter").cbl = arrayMinusA(gC("chPlayerCharacter").cbl,target);
	}
	gC("chPlayerCharacter").changeInfamy(infamy);
			
	if ( flagAccepts ) {
		// Event
		var allChars = getCharGroup("chPlayerCharacter").concat(getCharGroup(target));
		var spectators = gC("chPlayerCharacter").followedBy.concat(gC(target).followedBy);
		for ( var charKey of allChars ) {
			charLeavesAnySis(charKey);
			State.variables.compass.characterEventEndsPrematurely(charKey);
		}
		signCharsActive(allChars);
		// Scene
		State.variables.compass.ongoingEvents.push(createSystemEventStandardChallenge(["chPlayerCharacter"],[target],spectators,stakes));
		State.variables.compass.sortOnGoingEventsByTime();
		State.variables.compass.pushAllTimeToAdvance();
		// Message
		msg = gC(target).getFormattedName() + " accepted the challenge! You gained 1 infamy.\n\n"
			+ "[[Continue|Scene]]";
	} else {
		gC("chPlayerCharacter").changeMerit(1);
		gC(target).changeMerit(-1);
		// Message
		msg = gC(target).getFormattedName() + " rejected the challenge. You gained 1 infamy. You took 1 merit from " + gC(target).comPr + ".\n\n"
			+ "[[Continue|Map]]";
	}
	
	State.variables.compass.setInterludeTrigger(msg);
}
window.initiateNpcToNpcChallenge = function(actor,target,stakes) {
	if ( gC(actor).hasOwnProperty("globalAi") ) {
		if ( gC(actor).globalAi.hasOwnProperty("attackedToday") ) {
			gC(actor).globalAi.attackedToday = true;
		}
	}
	var flagAccepts = doesTargetAcceptChallenge(actor,target,stakes);
	
	// Infamy
	var infamy = 1;
	if ( gC(actor).cbl.includes(target) ) {
		infamy = 0;
		gC(actor).cbl = arrayMinusA(gC("chPlayerCharacter").cbl,target);
	}
	gC(actor).changeInfamy(infamy);
	
	if ( flagAccepts ) {
		// Event
		var allChars = getCharGroup(actor).concat(getCharGroup(target));
		var spectators = gC(actor).followedBy.concat(gC(target).followedBy);
		for ( var charKey of allChars ) {
			State.variables.compass.characterEventEndsPrematurely(charKey);
			charLeavesAnySis(charKey);
		}
	
		signCharsActive(allChars);
		// Scene
		State.variables.compass.ongoingEvents.push(createSystemEventStandardChallenge([actor],[target],spectators,stakes));
		State.variables.compass.sortOnGoingEventsByTime();
	} else {
		gC(actor).changeMerit(1);
		gC(target).changeMerit(-1);
	}
	return flagAccepts;
}
window.initiateNpcToPlayerAcceptedChallenge = function(challenger,stakes) {
	var actor = challenger;
	if ( gC(actor).hasOwnProperty("globalAi") ) {
		if ( gC(actor).globalAi.hasOwnProperty("attackedToday") ) {
			gC(actor).globalAi.attackedToday = true;
		}
	}
	
	var target = "chPlayerCharacter";
	var allChars = getCharGroup(actor).concat(getCharGroup(target));
	var spectators = gC(actor).followedBy.concat(gC(target).followedBy);
	for ( var charKey of allChars ) {
		State.variables.compass.characterEventEndsPrematurely(charKey);
		charLeavesAnySis(charKey);
	}
	signCharsActive(allChars);
	// Scene
	State.variables.compass.ongoingEvents.push(createSystemEventStandardChallenge([actor],[target],spectators,stakes));
	State.variables.compass.sortOnGoingEventsByTime();
	State.variables.compass.pushAllTimeToAdvance();
}

window.addSpectatorsToBattle = function(battleEvent,spectatorCharactersList) {
	for ( var charKey of spectatorCharactersList ) {
		battleEvent.characters.push(charKey);
		battleEvent.spectators.push(charKey);
	}
}
window.addSpectatorsToCharsBattle = function(targetCharacter,spectatorCharactersList) {
	addSpectatorsToBattle(getCharsActiveEvent(targetCharacter),spectatorCharactersList);
}
window.addCharsTeamToCharsBattle = function(joiningCharacter,joinedCharacter) {
	var sEvent = getCharsActiveEvent(joinedCharacter);
	var gainedInfamy = 0;
	var notification = "";
	if ( sEvent ) {
		if ( sEvent.title == "battle" ) {
			if ( mayBattleBeJoinedByChar(sEvent,joiningCharacter) ) {
				var targetTeamA = false;
				if ( sEvent.charactersTeamA.includes(joinedCharacter) ) {
					targetTeamA = true;
				}
				for ( var charKey of gC(joiningCharacter).followedBy.concat([joiningCharacter]) ) {
					sEvent.characters.push(charKey);
					if ( targetTeamA ) {
						sEvent.charactersTeamA.push(charKey);
						gainedInfamy = 1;
					} else {
						sEvent.charactersTeamB.push(charKey);
						gainedInfamy = -1;
					}
				}
				if ( gC(joiningCharacter).relations[joinedCharacter].relType ) {
					gainedInfamy += gC(joiningCharacter).relations[joinedCharacter].relType.supportInfamy;
				}
				notification = gC(joiningCharacter).getFormattedName() + " came to the battle in support of " + gC(joinedCharacter).getFormattedName() + ".";
				gC(joiningCharacter).changeInfamy(gainedInfamy);
				sEvent.extraMessages.push(notification);
				sEvent.extraMessages.push(("" + gC(joiningCharacter).getFormattedName() + " gained " + gainedInfamy.toFixed(0) + " infamy."));
			}
		}
	}
}

////////// COMPASS CLASS  //////////
// Compass contains references to the current map in play and player's location.

///// HOW TO ADD NEW Events
// State.variables.compass.ongoingEvents.push(PUT EVENT HERE);
// State.variables.compass.sortOnGoingEventsByTime();
/////
// HOW TO ADD NEW Events FROM AN EVENT'S EFFECT

// DEBUG
State.variables.zFlagDbCp = true; // Set to true or false. Flag to debug compass

window.isMapSimActive = function() {
	var flagActive = false;
	if ( State.variables.compass.flagEndedScenario == false ) {
		flagActive = true;
	}
	return flagActive;
}

window.Compass = function() {
	this.currentMap = "none";
	this.currentRoom = "none";
	
	this.ongoingEvents = [];
	this.timeToAdvance = 0;
	
	this.flagEndedScenario = false;
	
	this.roomPassage = ""; // Information to be displayed at the "Map" passage, regarding information about the current room.
	this.interludePassage = ""; // Information to be displayed at the "Interlude" passage.
	this.sceneResultsPassage = "";
	this.sceneResultsTemp = "";
	this.scenarioEndPassage = "";
	
	this.roomMessage = "";
	this.roomActionsMessage = "";
	
	this.sisList = new pseudoList();
	this.lastSisId = -1;
	this.pcSis = -1;
	this.sisPassage = "";
	
	this.executingEvents = false;
	
	///
	this.flagPlayerIsPrompted = false;
	this.promptPassage = "";
	this.promptSender = ""; // Character or entity sending the prompt
	this.isPrompterAchar = true; // Is the entity prompting the Player a NPC
	
	this.flagMenuInMap = false;
	this.mapMenuPassage = "";
	///
	
	this.flagAskedToSort = false; // Necessary due to instances in which events are sorted in the middle of pushAllTimeToAdvance
	
	this.periodEndsTip = "";
	
	// Debug
	this.debugInfo = "";	
	
	this.debugFinishedEventInfo = function(sEvent) {
		var text = "|Finished event. Event name: " + sEvent.title + ", Chars: [" + sEvent.characters + "], Total time: " + sEvent.ongoingTime + "|";
		return text;
	}
};

// Methods
	// Management
	Compass.prototype.initializeMap = function(mapKey,roomKey) {
		this.currentMap = mapKey;
		this.currentRoom = roomKey;
		
		State.variables[State.variables.compass.currentMap].cleanCharacters();
		
		this.ongoingEvents = [];
		this.timeToAdvance = 0;
		
		this.flagEndedScenario = false;
		
		this.roomPassage = "";
		this.interludePassage = "";
		this.scenarioEndPassage = "";
		
		// Clean SIS
		this.lastSisId = -1;
		this.pcSis = -1;
		this.sisPassage = "";
		
		delete this.sisList;
		this.sisList = new pseudoList();
	}
	Compass.prototype.setCurrentRoom = function(roomKey) {
		this.currentRoom = roomKey;
	}
	Compass.prototype.getCurrentRoom = function() {
		return State.variables[this.currentMap].rooms[this.currentRoom];
	}
	
	Compass.prototype.createNewSis = function(charList) { 
		this.lastSisId++; // It will represent the new SIS ID until the end of this function
		var characters = removeDuplicatesFromList(charList);
		this.sisList[this.lastSisId] = new SocIntSys(this.lastSisId,characters);
		
		for ( var character of characters ) {
			this.characterEventEndsPrematurely(character);
			gC(character).mapAi.state = "active";
		}
		
		if ( this.sisList[this.lastSisId].charList.includes("chPlayerCharacter") ) {
			this.pcSis = this.lastSisId;
		} else {
			this.sisList[this.lastSisId].preInitiateNewRoundNoPC();
		}
	}
	
	Compass.prototype.finishMapSimulation = function() {
		this.flagEndedScenario = true;
		this.timeToAdvance = 0;
		// Break character groups
		for ( var charKey of getCurrentMap().characters ) {
			cleanCharGroup(charKey);
		}
		
		// Finish sis conversations
		for ( var sis in this.sisList ) {
			if ( this.sisList[sis] instanceof SocIntSys ) {
				if ( this.sisList[sis].charList.includes("chPlayerCharacter") == false ) {
					this.sisList[sis].remainingCharsLeaveSis();
				} else {
					for ( var chKey of this.sisList[sis].charList ) {
						if ( chKey != "chPlayerCharacter" ) {
							charLeavesAnySis(chKey);
						}
					}
				}
			}
		}
		
		// Finish events
		for ( var sEvent of this.ongoingEvents ) {
			 if ( sEvent.title != "scenarioEnd" ) { // scenarioEnd events call this event
				 sEvent.forceEnd();
			 }
		}
		
		// Clean AI memory
		for ( var charKey of getCurrentMap().characters ) {
			gC(charKey).mapAi.previousGoals = [];
		}
		
		// Clean messages
		this.roomMessage = "";
		this.roomActionsMessage = "";
		
		// Clean scene
		State.variables.sc.cleanScene();
		
		// Clean others
		this.periodEndsTip = "";
		
		return true;
	}
	
		// External interruptions and calls to player
	Compass.prototype.interruptPlayer = function(promptText,promptSender,isPrompterAchar) {
		this.timeToAdvance = 0;
		this.setPlayerPrompt(promptText,promptSender,isPrompterAchar);
		// If player is in SIS -> Set prompt in SIS -> Otherwise set prompt in map
		this.interludePassage = promptText;
	}
	
	Compass.prototype.setPlayerPrompt = function(passageText,promptSender,isPrompterAchar) {
		this.flagPlayerIsPrompted = true;
		this.promptPassage = passageText;
		this.promptSender = promptSender;
		this.isPrompterAchar = isPrompterAchar;
		var playerSisId = this.getCharacterSisId("chPlayerCharacter");
		if ( playerSisId == -1 ) { // Set prompt in map
			this.interludePassage = passageText;
		} else { // Set prompt in SIS
			this.sisList[playerSisId].setSisPlayerPrompt(passageText);
			this.timeToAdvance = 0;
		}
	}
	Compass.prototype.finishPlayerPrompt = function() {
		this.flagPlayerIsPrompted = false;
		var playerSisId = this.getCharacterSisId("chPlayerCharacter");
		if ( playerSisId != -1 ) { // End Sis prompt
			this.sisList[playerSisId].endSisPlayerPrompt();
			this.pushTimerUntilPlayerIsDone();
		}
		this.promptPassage = "";
	}
	
		// Characters
	Compass.prototype.getPlayerGroupChars = function() {
		return getPlayerCharsGroup();
	}
	Compass.prototype.getCharactersGroup = function(character) {
		return getCharGroup(character);
	}
	
	Compass.prototype.wakeUpFakeActiveChars = function() {
		for ( var character of getCurrentMap().characters ) {
			if ( gC(character).mapAi.state == "active" ) {
				if ( character != "chPlayerCharacter" ) {
					var sEvent = this.findFirstEventInvolvingCharacter(character);
					if ( sEvent == null ) {
						gC(character).mapAi.signIdle();
						gC(character).mapAi.main();
					}
				}
			}
		}
	}
	Compass.prototype.allCharsCheckMapAi = function() {
		// Every character present in the map calls mapAi.main(), trying to reach new goals, creating new missions or staying quiet
		for ( var character of getCurrentMap().characters ) {
			gC(character).mapAi.main();
		}
	}
	
	Compass.prototype.moveCharToRoom = function(charKey,roomKey) {
		// Only changes variables, logic isn't involved
		var oldRoom = gC(charKey).currentRoom;
		var oldRoomCharList = arrayMinusA(getRoomA(oldRoom).characters,charKey);
		getRoomA(oldRoom).characters = oldRoomCharList;
		
		gC(charKey).currentRoom = roomKey;
		getRoomA(roomKey).characters.push(charKey);
		
		if ( charKey == "chPlayerCharacter" ) {
			this.setCurrentRoom(roomKey);
		}
	}
	Compass.prototype.moveCharsToRoom = function(charKeysList,roomKey) {
		// Only changes variables, logic isn't involved
		for ( var character of charKeysList ) {
			this.moveCharToRoom(character,roomKey);
		}
		if ( charKeysList.includes("chPlayerCharacter") ) {
			this.setCurrentRoom(roomKey);
		}
	}
	
	Compass.prototype.isCharacterInSis = function(charKey) {
		var flagInSis = false;
		for ( var sis in this.sisList ) {
			if ( this.sisList[sis] instanceof SocIntSys ) {
				if ( this.sisList[sis].charList.includes(charKey) ) {
					flagInSis = true;
				}
			}
		}
		return flagInSis;
	}
	Compass.prototype.getCharacterSisId = function(charKey) {
		var sisId = -1;
		var i = 0;
		for ( var sis in this.sisList ) {
			if ( this.sisList[sis] instanceof SocIntSys ) {
				if ( this.sisList[sis].charList.includes(charKey) ) {
					sisId = i;
				}
				i++;
			}
		}
		return sisId;
	}
	
		// Events
	Compass.prototype.sortOnGoingEventsByTime = function() {
		if ( this.ongoingEvents.length > 1 ) { // At least 2 events in pile
			var sortedList = this.ongoingEvents;
			for ( var i = this.ongoingEvents.length - 1 ; i > 0 ; i-- ) { // Almost all events are check from last to second
				for ( var l = i ; l > 0 ; l-- ) { // l runs through the events array and tries to push each element to the left if it will finish
												  // sooner than the other one
												  
					
					if ( willFirstEventFinishSooner(sortedList[l],sortedList[l-1]) ) {
						var tE = sortedList[l-1];
						sortedList[l-1] = sortedList[l];
						sortedList[l] = tE;
					}
				}
			}
			this.ongoingEvents = sortedList;
		}
		this.flagAskedToSort = true;
	}
	
	Compass.prototype.findFirstEventInvolvingPlayer = function() {
		var sEvent = null;
		var i = 0;
		while ( sEvent == null && i < this.ongoingEvents.length ) {
			if ( this.ongoingEvents[i].characters.includes("chPlayerCharacter") ) {
				sEvent = this.ongoingEvents[i];
			}
			i++;
		}
		return sEvent;
	}
	Compass.prototype.findLastEventInvolvingPlayer = function() {
		var sEvent = null;
		var maxTime = -1;
		for ( var gEvent of this.ongoingEvents ) {
			if ( gEvent.characters.includes("chPlayerCharacter") ) {
				if ( gEvent.timeRemaining > maxTime ) {
					sEvent = gEvent;
					maxTime = gEvent.timeRemaining;
				}
			}
		}
		return sEvent;
	}
	Compass.prototype.findFirstEventInvolvingCharacter = function(character) {
		var sEvent = null;
		var i = 0;
		while ( sEvent == null && i < this.ongoingEvents.length ) {
			if ( this.ongoingEvents[i].characters.includes(character) && this.ongoingEvents[i].flagForcedToEnd == false ) {
				sEvent = this.ongoingEvents[i];
			}
			i++;
		}
		return sEvent;
	}
	Compass.prototype.findAllEventsInvolvingCharacter = function(character) {
		var eventsList = [];
		for ( var sEvent of this.ongoingEvents ) {
			if ( sEvent.characters.includes(character) ) {
				eventsList.push(sEvent);
			}
		}
		return eventsList;
	}
	Compass.prototype.findAllEventsIDsInvolvingCharacter = function(character) {
		var eventsList = [];
		var i = 0;
		for ( var sEvent of this.ongoingEvents ) {
			if ( sEvent.characters.includes(character) ) {
				eventsList.push(i);
			}
			i++;
		}
		return eventsList;
	}
	Compass.prototype.findFirstSisIdInvolvingCharacter = function(character) {
		var id = -1;
		for ( var sis in this.sisList ) {
			if ( this.sisList[sis] instanceof SocIntSys ) {
				if ( this.sisList[sis].charList.includes(character) ) {
					id = this.sisList[sis].key; 
				}
			}
		}
		return id;
	}
	
	Compass.prototype.pushTimerUntilPlayerIsDone = function() {
		var sEvent = this.findLastEventInvolvingPlayer();
		if ( sEvent != null ) {
			this.timeToAdvance = sEvent.timeRemaining;
		}
	}
	
	Compass.prototype.characterEventEndsPrematurely = function(character) {
		// Function called when external events force a character to leave their event
		//var newEventsList = [];
		
		for ( var sEvent of this.ongoingEvents ) {
			if ( sEvent.characters.includes(character) ) {
				sEvent.forceEnd();
			} else {
				//newEventsList.push(sEvent);
			}
		}
		
		//this.ongoingEvents = newEventsList;
	}
	
	// Logic
	Compass.prototype.getStandardMovementTime = function(distance,characterGroup) { // Calculates movement time in a given distance for a given character group.
		return distance;
	}
	Compass.prototype.charsMoveToRoom = function(characters,roomKey,distance) {
		var minutes = this.getStandardMovementTime(distance,characters);
		this.ongoingEvents.push(createSystemEventMovement(minutes,characters,roomKey));
		this.sortOnGoingEventsByTime();
		if ( characters.includes("chPlayerCharacter") ) {
			this.setCurrentRoom(roomKey);
		}
	}
	Compass.prototype.playerMovesToRoom = function(roomKey,distance) { // Moves the player's location in the map.
		var minutes = this.getStandardMovementTime(distance,this.getPlayerGroupChars());
		this.ongoingEvents.push(createSystemEventMovement(minutes,this.getPlayerGroupChars(),roomKey));
		this.sortOnGoingEventsByTime();
		this.pushAllTimeToAdvance();
		this.setCurrentRoom(roomKey);
	}
	
	Compass.prototype.pushTimeToOngoingEvents = function(minutes) {
		if ( this.ongoingEvents.length > 0 ) {
			this.purgeDuplicityEvents();
			this.purgeInvalidEvents();
			var newList = [];
			for ( var sEvent of this.ongoingEvents ) {
				sEvent.flagDontPushTimeYet = false;
			}
			
			this.executingEvents = true; // Executing events and pushing time
			for ( var sEvent of this.ongoingEvents ) {
				if ( sEvent.pushTime(minutes) == false ) { // On true, event time reached 0 and it executes its effect
					newList.push(sEvent);
				}
				else {
					if ( State.variables.zFlagDbCp ) {
						this.debugInfo += this.debugFinishedEventInfo(sEvent) + "\n";
					}
				}
			}
			this.executingEvents = false; // Finished exeucuting events
			this.ongoingEvents = newList; // Only unfinished events are kept
			
			if ( this.flagAskedToSort ) { // Sort events added in the middle of the previous cycle
				this.sortOnGoingEventsByTime();
				this.flagAskedToSort = false;
			}
		}
	}
	Compass.prototype.cleanPhantasmEvents = function() {
		this.pushTimeToOngoingEvents(0);
	}
	Compass.prototype.advanceTime = function(minutes) { // General function to advance time. It regulates everything. EVERYTHING.
		State.variables.daycycle.addMinutes(minutes);
		
		this.pushTimeToOngoingEvents(minutes);
		this.timeToAdvance -= minutes;
		
		this.wakeUpFakeActiveChars();
		this.allCharsCheckMapAi();
	}
	Compass.prototype.pushAllTimeToAdvance = function() {
		this.pushTimerUntilPlayerIsDone();
		if ( this.timeToAdvance == 0 ) {
			this.pushTimeToOngoingEvents(0);
		}
			// Infinite loop patch Part 1 //
		var tempTimeToAdvance = this.timeToAdvance;
		var repeatedAdvances = 0;
			// Infinite loop patch //
			State.variables.repeatedAdvances = 0;
		while ( this.timeToAdvance > 0 && repeatedAdvances < 10 ) {
			var timePush = this.ongoingEvents[0].timeRemaining;
			this.advanceTime(timePush);
			// Infinite loop patch Part 2 //
			if ( tempTimeToAdvance == this.timeToAdvance ) { repeatedAdvances++; }
			else { State.variables.repeatedAdvances = -repeatedAdvances; repeatedAdvances = 0; }
			// Infinite loop patch //
		}
	}
	
	Compass.prototype.pushAllTimeToAdvanceAsFollower = function() {
		this.timeToAdvance = 0;
		var sEvent = this.findFirstEventInvolvingCharacter(gC("chPlayerCharacter").followingTo);
		if ( sEvent ) {
			this.timeToAdvance = sEvent.timeRemaining;
		}
		if ( this.timeToAdvance == 0 ) {
			this.pushTimeToOngoingEvents(0);
			if ( gC(gC("chPlayerCharacter").followingTo).mapAi.state == "idle" ) {
				gC(gC("chPlayerCharacter").followingTo).mapAi.main();
			}
		}
		while ( this.timeToAdvance > 0 ) {
			var timePush = this.ongoingEvents[0].timeRemaining;
			this.advanceTime(timePush);
		}
	}
	
	Compass.prototype.purgeDuplicityEvents = function() {
		for ( var cK of getCurrentMap().characters ) {
			var eList = this.findAllEventsInvolvingCharacter(cK);
			if ( eList.length > 1 ) {
				var i = 0;
				var eI = 0;
				var highestP = -30;
				// Adjust priority
				for ( var ev of eList ) {
					if ( ev.characters.includes("chPlayerCharacter") ) {
						ev.priority += 10;
					}
				}
				// Get highest priority and position
				for ( var ev of eList ) {
					if ( ev.priority >= highestP ) {
						highestP = ev.priority;
						eI = i;
					}
					i++;
				}
				// Signal all other events to be purged
				i = 0;
				for ( var ev of eList ) {
					if ( i != eI ) {
						ev.forceEnd();
					}
					i++;
				}
			}
		}
	}
	Compass.prototype.purgeInvalidEvents = function() {
		// Problem: an action of the player may have dragged a NPC to an event X despite the NPC having just started an event Y.
		// Solution: find all NPCs that share an event with the player, cancel all events that have just started and found NPCs are participating in them.
		var selectedNPCs = [];
		for ( var sEvent of this.ongoingEvents ) {
			if ( sEvent.ongoingTime == 0 ) {
				if ( sEvent.characters.includes("chPlayerCharacter") ) {
					selectedNPCs = selectedNPCs.concat(sEvent.characters);
				}
			}
		}
		// Selected NPCs now contains a list with all charactes that share an event with the player, as well as the player. Now we will force events that contain one of these NPCs *but* not the player and have just started to end
		for ( var sEvent of this.ongoingEvents ) {
				if ( sEvent.ongoingTime == 0 ) {
				var flagFinishEvent = false;
				for ( var ch of sEvent.characters ) {
					if ( selectedNPCs.includes(ch) ) { flagFinishEvent = true; }
				}
				if ( sEvent.characters.includes("chPlayerCharacter") ) { flagFinishEvent = false; }
				if ( flagFinishEvent ) { sEvent.forceEnd() }
			}
		}
		// Problem: an action of the player may have provoked two characters to be unable to fight each other, but they may have already started fighting.
		// Solution: Find incompatible battle events and force them to end
			// Liberation challenges, challenges, assaults
		for ( var sEvent of this.ongoingEvents ) {
			if ( sEvent.label == "liberationChallenge" ) {
				if ( liberationChallengePreConditions(sEvent.charactersTeamA[0],sEvent.charactersTeamB[0]) == false ) {
					sEvent.forceEnd();
				}
			} else if ( sEvent.label == "challenge" ) {
				if ( challengePreConditions(sEvent.charactersTeamA[0],sEvent.charactersTeamB[0]) == false ) {
					sEvent.forceEnd();
				}
			} else if ( sEvent.label == "assault" ) {
				if ( assaultPreConditions(sEvent.charactersTeamA[0],sEvent.charactersTeamB[0]) == false ) {
					sEvent.forceEnd();
				}
			}
		}
	}
	
	// UI
	Compass.prototype.refreshRoomPassage = function() {
		if ( this.flagEndedScenario == false ) {					// Scenario hasn't ended, default behavior
			this.setCurrentRoom(gC("chPlayerCharacter").currentRoom);
			if ( getCurrentRoomInfo().setSubarea ) { getCurrentRoomInfo().setSubarea(); } // Set the current room's associated subarea, if required
			this.roomPassage = "";
			if ( this.roomMessage != "" ) {
				this.roomPassage += this.roomMessage + "\n\n";
				this.roomMessage = "";
			}
			if ( this.flagMenuInMap ) {
				this.roomPassage += this.mapMenuPassage;
			}
			else {
				this.roomPassage += `<div class='standardBox'>  <span style="vertical-align: middle;"><img src="img/mapIcons/` + getCurrentRoomInfo().medIcon + `" style="vertical-align: middle;">` + " __" + getCurrentRoomInfo().title + "__</span>\n";
				
				if  ( getCurrentRoomInfo().getDescription() != "" ) {
					this.roomPassage += getCurrentRoomInfo().getDescription() + "\n";
				}
				this.roomPassage += "</div>\n";
				
				// Check if prompt is no longer valid
				if ( this.flagPlayerIsPrompted ) {
					if ( this.isPrompterAchar ) {
						if ( gC(this.promptSender).followingTo != "" && gC(this.promptSender).followingTo != "chPlayerCharacter" && isCharInScene(this.promptSender) == false ) {
							// Cancel prompt
							this.flagPlayerIsPrompted = false;
							this.promptPassage = "";
							this.isPrompterAchar = true;
						}
					}
				}
				
				if ( this.flagPlayerIsPrompted == false ) {  //  Typical behavior
					this.roomActionsMessage = "";
				
					if ( gC("chPlayerCharacter").followingTo == "" ) { // If player is following a character, player can't initiate actions or move on their own
						if ( getCurrentRoomInfo().connections != null ) {
							this.roomPassage += getCurrentRoomInfo().displayConnections() + " \n";
						}
					
						this.roomPassage += this.displayCurrentRoomActions() + " \n";
					}
					else { // Player following character
						var followedSisId = this.findFirstSisIdInvolvingCharacter(gC("chPlayerCharacter").followingTo);
						var sEvent = this.findFirstEventInvolvingCharacter(gC("chPlayerCharacter").followingTo);
						if ( followedSisId != -1 ) {
							this.roomPassage += this.getButtonJoinAndAdvanceToConversation(followedSisId) + "\n\n";
						}
						else if ( sEvent ) {
							if ( sEvent.title == "battle" ) {
								// Option 1: Challenge - Player should be forced to spectate
								// Option 2: Assault - Player should be forced to participate
								if ( sEvent.label == "assault" ) {
									this.roomPassage += this.getButtonJoinCombatForced() + " \n\n";
								} else if ( sEvent.label == "challenge" || sEvent.label == "liberationChallenge" ) {
									this.roomPassage += this.getButtonSpectateCombatAlt() + " \n\n";
								}
							}
							else if ( sEvent.title == "movement" ) {
								this.roomPassage += this.getButtonContinueAsFollower("Map") + " \n\n";
							} else {
								this.roomPassage += this.getButtonContinueAsFollower("Interlude") + " \n\n";
							}
						}
						else {
							this.roomPassage += this.getButtonContinueAsFollower("Map") + " \n\n";
						}
					}
					
					if ( this.roomActionsMessage != "" ) {
						this.roomPassage += this.roomActionsMessage + "\n\n";
						this.roomActionsMessage = "";
					}
				
					this.roomPassage += this.displayCharactersInRoom() + " \n";
					
					if ( State.variables.chPlayerCharacter.hasFreeBodypart("eyes") ) {
						this.roomPassage += this.displayEventsInRoom(getCurrentRoomInfo().key);
					} else {
						this.roomPassage += "Having your vision blocked prevents you from seeing what's happening.\n"
					}
					
					if ( getCurrentMap().icon ) {
						var coords = this.getCursorCoordinates();
						this.roomPassage += "\n\n<div align='center' id='mapDiagram'>";
						this.roomPassage += '<img src="img/maps/' + getCurrentMap().icon + '" id="mapImage" usemap="#image_map"/>\n';
						this.roomPassage += '<img src="img/mapCursor.png" id="mapCursor" '
										  + 'style="position:relative;left:' + coords[0] + 'px;top:' + coords[1] + 'px"/>'
										  + "</div>";
						// Areas map
						this.roomPassage += '\n<map name="image_map">';
						if ( getCurrentRoomInfo().getConnections(["chPlayerCharacter"]) != null ) {
							if ( gC("chPlayerCharacter").followingTo == "" ) {
								for ( var con of getCurrentRoomInfo().getConnections(["chPlayerCharacter"]) ) {
									var ri = getRoomInfoA(con.loc);
									this.roomPassage += '<area class="roomAreaButton" title="' + ri.title + '" coords="' + ri.getAreaCoordinates() + '" shape="rect" room-key="' + con.loc + '" travel-time="' + con.distance + '" data-passage="Map" data-setter="State.variables.compass.playerMovesToRoom(\'' + con.loc + '\',' + con.distance + ')" >\n';
								}
							}
						}						
						this.roomPassage += "</map>";
					}
				} else { // Player is prompted
					this.roomPassage += this.promptPassage;
				}
			}
		} else { 													// Scenario has ended, scenarioEndPassage should lead to next gameplay section
			this.roomPassage = this.scenarioEndPassage;
		}
	}
	window.clickRoomIconEvent = function() {
		State.variables.compass.playerMovesToRoom(this.getAttribute("room-key"),parseInt(this.getAttribute("travel-time")));
		state.display("Map");
	}

	window.adjustCursorPosition = function() {
		var cursorObject = document.getElementById("mapCursor");
		cursorObject.style.position = 'relative';
		cursorObject.style.left = '100px';
		cursorObject.style.top = '100px';
	}
	Compass.prototype.getCursorCoordinates = function() {
		var mapDimensions = getCurrentMap().diagramDimensions;
		// Adjust for map dimensions
		var coords = [-(mapDimensions[0]/2),-(mapDimensions[1])];
		// Adjust for cursor dimensions
		coords[0] += setup.cursorHalfX;
		coords[1] -= setup.cursorHalfY;
		// Adjust for room position in map
		coords[0] += getCurrentRoomInfo().mapPos[0];
		coords[1] += getCurrentRoomInfo().mapPos[1];
		return coords;
	}
	Compass.prototype.refreshRightUImap = function() {
		var extraTimeLabel = "";
		if ( this.periodEndsTip != "" ) {
			extraTimeLabel = " > (" + this.periodEndsTip + ")";
		}
		State.variables.rightUIbarText = '<div style="text-align: center;">' + State.variables.daycycle.returnMonthDay()
										 + "\n" + State.variables.daycycle.returnHourMin() + extraTimeLabel + '</div>';
		
		if ( Story.get(State.passage).tags.contains("jobsScreen") == false ) {
			
			// Display characters in room
			for ( var charKey of getCurrentRoom().characters ) {
				if ( charKey == "chPlayerCharacter" || gC(charKey).followingTo != "" || gC(charKey).followedBy.includes("chPlayerCharacter") ) {
					// Don't show
				}
				else if ( gC(charKey).followedBy.length > 0 ) {
					State.variables.rightUIbarText += State.variables[charKey].getCharacterUIbarInfo();
					for ( var ck of gC(charKey).followedBy ) {
						State.variables.rightUIbarText += State.variables[ck].getCharacterUIbarInfo();
					}
				}
				else {
					State.variables.rightUIbarText += State.variables[charKey].getCharacterUIbarInfo();
				}
			}
			
		}
		
	}
	
	Compass.prototype.displayCurrentRoomActions = function() { // Returns the text required to display the current room actions to the player.
		var text = "";
		var actions = getCurrentRoomInfo().getActions(this.getPlayerGroupChars());
		if ( actions.length > 0 ) {
			var i = 0;
			for ( var action of actions ) {
				if ( action.requirements(this.getPlayerGroupChars()) ) {
					text += action.title + action.displayDescriptionMark() + ' <<link [[Execute|' + action.getPassage() + ']]>><<script>>'
										 + 'getCurrentRoomInfo().getActions(getPlayerCharsGroup())[' + i + '].eventToPile('
										 + action.recMins + ',State.variables.compass.getPlayerGroupChars());'
										 // This sends a systemEvent to pile, that should eventually be executed
										 + 'State.variables.compass.pushAllTimeToAdvance();'
										 + '<</' + 'script>><</' + 'link>>';
										 
					if ( action.flexibleTimes ) { // Extra buttons to allow the player to select time multiples
						text += ' / <<link [[x2|Interlude]]>><<script>>'
							 + 'getCurrentRoomInfo().getActions(getPlayerCharsGroup())[' + i + '].eventToPile('
							 + (action.recMins * 2) + ',State.variables.compass.getPlayerGroupChars());'
							 + 'State.variables.compass.pushAllTimeToAdvance();'
							 + '<</' + 'script>><</' + 'link>>';
						text += ' / <<link [[x3|Interlude]]>><<script>>'
							 + 'getCurrentRoomInfo().getActions(getPlayerCharsGroup())[' + i + '].eventToPile('
							 + (action.recMins * 3) + ',State.variables.compass.getPlayerGroupChars());'
							 + 'State.variables.compass.pushAllTimeToAdvance();'
							 + '<</' + 'script>><</' + 'link>>';
						text += ' / <<link [[x4|Interlude]]>><<script>>'
							 + 'getCurrentRoomInfo().getActions(getPlayerCharsGroup())[' + i + '].eventToPile('
							 + (action.recMins * 4) + ',State.variables.compass.getPlayerGroupChars());'
							 + 'State.variables.compass.pushAllTimeToAdvance();'
							 + '<</' + 'script>><</' + 'link>>';
						text += ' / <<link [[x5|Interlude]]>><<script>>'
							 + 'getCurrentRoomInfo().getActions(getPlayerCharsGroup())[' + i + '].eventToPile('
							 + (action.recMins * 5) + ',State.variables.compass.getPlayerGroupChars());'
							 + 'State.variables.compass.pushAllTimeToAdvance();'
							 + '<</' + 'script>><</' + 'link>>';
						text += ' / <<link [[x1/2|Interlude]]>><<script>>'
							 + 'getCurrentRoomInfo().getActions(getPlayerCharsGroup())[' + i + '].eventToPile('
							 + (action.recMins * 0.5) + ',State.variables.compass.getPlayerGroupChars());'
							 + 'State.variables.compass.pushAllTimeToAdvance();'
							 + '<</' + 'script>><</' + 'link>>';
							 
					}
					
					text += "\n";
				}
				i++;	  
			}
		}
		
		if ( getCurrentRoomInfo().getCustomActionsText != undefined ) {
			text += getCurrentRoomInfo().getCustomActionsText(this.getPlayerGroupChars());
		}
		return text;
	}
		
	Compass.prototype.displayCharactersInRoom = function() {
		var text = "__Characters in room__:\n";
		var i = 1;
		for ( var character of this.getCurrentRoom().characters ) {
			if ( gC(character).icon != null ) { // Icon
				text += gC(character).icon() + " ";
			}
			text += gC(character).getFormattedName(); // Name
			if ( gC("chPlayerCharacter").cbl.includes(character) ) {
				text += '<span title="' + "You have a casus belli against this character. Your next assault or challenge against them will cost you no infamy." + '">' + colorText(" (!)","firebrick"); + '</span>';
			}
			if ( gRelTypeAb(character,"chPlayerCharacter") ) {
				text += " (" + getRelTypeAbr(character,"chPlayerCharacter") + ") ";
			}
			
			var charInSis = this.isCharacterInSis(character);
			var tEvent = getCharsActiveEvent(character);
			
			//  Group buttons
			if ( gC("chPlayerCharacter").followingTo == "" && State.variables.settings.followingAllowed == true ) { // If player if a follower, buttons change
				// Group buttons
				if ( charMayModifyGroup(character) ) {
					if ( character == "chPlayerCharacter" ) {
					}
					else if ( gC(character).followingTo == "chPlayerCharacter" ) { // Target follows Player
						text += " ( " + rFormatPlayerFavor(character) + " " + this.getButtonAskToUnfollowYou(character) + " ) , ";
					}
					else if ( State.variables.chPlayerCharacter.followingTo == character ) { // Player follows target
						if ( this.findFirstSisIdInvolvingCharacter("chPlayerCharacter") == -1 ) {
							text += " ( " + rFormatPlayerFavor(character) + " " + this.getButtonAskToUnfollowThem(character) + " ) , ";
						}
					}
					else if ( gC(character).followedBy.length > 0 ) { // Target is leader
						if ( gC(character).domChar == "chPlayerCharacter" ) {
							text += " ( " + rFormatPlayerFavor(character) + " " + this.getButtonAskToGetFollowed(character) + " , " + this.getButtonAskToFollowTo(character) + " ) , ";
						}
						else if ( State.variables.chPlayerCharacter.followedBy.length < 1 && State.variables.chPlayerCharacter.followingTo != character ) {
							text += " ( " + rFormatPlayerFavor(character) + " " + this.getButtonAskToFollowTo(character) + " ) , ";
						}
					}
					else if ( gC(character).followingTo == "" ) { // Character follows no one, has no followers
						if ( State.variables.chPlayerCharacter.followingTo != "" && State.variables.chPlayerCharacter.followingTo != character ) { // PC is follower
							text += " ( " + rFormatPlayerFavor(character) + " " + this.getButtonAskToFollowTo(character) + " ) , ";
						}
						else if ( State.variables.chPlayerCharacter.followedBy.length > 0 && gC(character).followingTo != "chPlayerCharacter" ) { // PC has followers
							text += " ( " + rFormatPlayerFavor(character) + " " + this.getButtonAskToGetFollowed(character) + " ) , ";
						}
						else if ( State.variables.chPlayerCharacter.followingTo != character && gC(character).followingTo != "chPlayerCharacter" ) { // Else
							text += " ( " + rFormatPlayerFavor(character) + " " + this.getButtonAskToGetFollowed(character) + " , " + this.getButtonAskToFollowTo(character) + " ) , ";
						}
					}
					else { // Character is following someone else
						if ( State.variables.chPlayerCharacter.followingTo == "" && gC(character).followingTo != "chPlayerCharacter" ) {
							text += " ( " + rFormatPlayerFavor(character) + " " + this.getButtonAskToGetFollowed(character) + " ) , ";
						}
					}
				}
			}
			
			// Interaction buttons
			if ( mayCharBeInterrupted(character) && State.variables.settings.talkingAllowed == true ) {
				if ( gC("chPlayerCharacter").followingTo == "" && ( gC(character).followingTo == "" || gC(character).followingTo == "chPlayerCharacter" ) ) {			
					if ( this.canCharBeInteracted(character) && ( character != "chPlayerCharacter" ) && ( charInSis == false ) ) { // Interaction button
						text += " ( " + this.getButtonBeginSocialInteraction(character) + " , " + this.getButtonBeginSocialInteractionSpecifics(character) + " )";
					}
					else if ( charInSis ) {
						text += " ( " + this.getButtonJoinConversation(this.getCharacterSisId(character)) + " )";
					}
				}
				else if ( gC("chPlayerCharacter").followingTo == character ) {
					if ( this.findFirstSisIdInvolvingCharacter("chPlayerCharacter") == -1 ) {
						text += " ( " + this.getButtonAskToUnfollowThem(character) + " ) ";
					}
				}
			}
			
			// Battle buttons
			if ( character != "chPlayerCharacter" ) {
				var battleButtons = [];
				if ( isChallengePossible("chPlayerCharacter",character) ) {
					battleButtons.push(this.getButtonChallenge(character));
				}
				if ( isAssaultPossible("chPlayerCharacter",character) ) {
					battleButtons.push(this.getButtonAssault(character));
				}
				if ( isLiberationChallengePossible("chPlayerCharacter",character) ) {
					battleButtons.push(this.getButtonLiberationChallenge(character));
				}
				if ( battleButtons.length > 0 ) {
					text += " (" + stringArrayToTextMinusAnd(battleButtons) + ")";
				}
			}
			
			if ( mayEventBeSpectated(tEvent) ) {
				text += " (" + this.getButtonSpectateCombat(character) + ")";
				if ( mayBattleBeJoined(tEvent) ) {
					text += " (" + this.getButtonJoinCombatWillingly(character) + ")";
				}
			}
			
			text += "\n";
			i++;
		}
		return text;
	}
	
	Compass.prototype.getEventDisplayInfo = function(sEvent) {
		var text = getCharNames(sEvent.characters);
		if ( sEvent.characters.length == 1 ) {
			text += " is ";
		}
		else {
			text += " are ";
		}
		
		if ( sEvent.title == "movement") {
			text += "moving towards " + getRoomA(sEvent.roomKey).title + ". This may be finished in " + sEvent.timeRemaining + " minutes.";
		}
		else if ( sEvent.title == "rest" ) {
			text += "resting to replenish forces.";
		}
		else if ( sEvent.title == "sisRound" ) {
			text += "are chatting together. This may continue for at least " + sEvent.timeRemaining + " minutes.";
		}
		else if ( sEvent.title == "battle" ) {
			text += "engaged in ";
			if ( sEvent.label == "assault" ) {
				text += "an assault initiated by " + gC(sEvent.charactersTeamA[0]).getFormattedName() + " against " + gC(sEvent.charactersTeamB[0]).getFormattedName() + ".";
			} else { // "challenge"
				text += "a challenge initiated by " + gC(sEvent.charactersTeamA[0]).getFormattedName() + " against " + gC(sEvent.charactersTeamB[0]).getFormattedName() + ".";
			}
			text += " This may continue for at least " + sEvent.timeRemaining + " minutes.";
		}
		else {
			text += "engaged in " + sEvent.name + ". This may continue for " + sEvent.timeRemaining + " minutes.";
		}
		
		return text;
	}
	Compass.prototype.displayEventsInRoom = function(roomKey) {
		var text = "";
		
		for ( var sEvent of this.ongoingEvents ) {
			if ( sEvent.characters.length > 0 ) {
				if ( gC(sEvent.characters[0]).currentRoom == roomKey && sEvent.flagForcedToEnd == false ) {
					text += this.getEventDisplayInfo(sEvent) + "\n";
				}
			}
		}
		
		return text;
	}
	
	Compass.prototype.setInterludeInfo = function(passageText) {
		this.interludePassage = passageText + "[[Return to Map" + "|Map]]";
	}
	Compass.prototype.setInterludeTrigger = function(uniquePassageText) {
		this.interludePassage = uniquePassageText;
	}
	
	Compass.prototype.setMapMessage = function(msg) {
		if ( this.roomMessage != "" ) { this.roomMessage += "\n"; }
		this.roomMessage += msg;
	}
	Compass.prototype.setMapActionsMessage = function(msg) {
		if ( this.roomActionsMessage != "" ) { this.roomActionsMessage += "\n"; }
		this.roomActionsMessage += msg;
	}
	
	// UI - Buttons
	Compass.prototype.canCharBeInteracted = function(charKey) {
		var flagCharAllowsSocialInteractions = gC(charKey).availableSocialInteractions;
		
		
		return flagCharAllowsSocialInteractions;
	}
	Compass.prototype.getButtonBeginSocialInteraction = function(targetCharacter) {
		var bText = "<<l" + "ink [[Talk|Social Interactions]]>><<s" + "cript>>\n";
		bText 	 += "eitherCreateSisOrRejectSis('" + targetCharacter + "');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	Compass.prototype.getButtonBeginSocialInteractionSpecifics = function(targetCharacter) {
		var bText = "<<l" + "ink [[Discuss topic|Social Interactions Specifics]]>><<s" + "cript>>\n";
		bText 	 += "eitherCreateSisOrRejectSis('" + targetCharacter + "');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	Compass.prototype.getButtonJoinConversation = function(targetSIS) {
		var bText = "<<l" + "ink [[Join conversation|Social Interactions]]>><<s" + "cript>>\n";
		bText	 += "State.variables.compass.sisList[" + targetSIS + "].playerRequestsJoin();"
		bText	 += "State.variables.compass.sisList[" + targetSIS + "].charsJoinSis(getCharGroup('chPlayerCharacter'));\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
	Compass.prototype.getButtonAskToGetFollowed = function(targetCharacter) {
		var bText = "<<l" + "ink [[Ask to follow you|Map]]>><<s" + "cript>>\n";
		bText 	 += "aAsksBtoFollowA('chPlayerCharacter','" + targetCharacter + "');\n";
		//"charFollowsChar('" + targetCharacter + "','chPlayerCharacter');\n";
		//bText	 += "State.variables.compass.setMapMessage('" + gC(targetCharacter).name + " accepted and will now follow you.');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	Compass.prototype.getButtonAskToFollowTo = function(targetCharacter) {
		var bText = "<<l" + "ink [[Ask to follow them|Map]]>><<s" + "cript>>\n";
		bText 	 += "aAsksBtoFollowB('chPlayerCharacter','" + targetCharacter + "');\n";
		//bText 	 += "charFollowsChar('chPlayerCharacter','" + targetCharacter + "');\n";
		//bText	 += "playerJoinsTargetChar('" + targetCharacter + "');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	Compass.prototype.getButtonAskToUnfollowThem = function(targetCharacter) {
		var bText = "<<l" + "ink [[Ask to unfollow them|Map]]>><<s" + "cript>>\n";
		bText 	 += "aAsksBtoUnfollowB('chPlayerCharacter','" + targetCharacter + "');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	Compass.prototype.getButtonAskToUnfollowYou = function(targetCharacter) {
		var bText = "<<l" + "ink [[Ask to unfollow you|Map]]>><<s" + "cript>>\n";
		bText 	 += "aAsksBtoUnfollowA('chPlayerCharacter','" + targetCharacter + "');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
	Compass.prototype.getButtonContinueAsFollower = function(nextPassage) {
		var bText = "<<l" + "ink [[Continue|" + nextPassage + "]]>><<s" + "cript>>\n";
		bText 	 += "State.variables.compass.wakeUpFakeActiveChars();\n";
		bText 	 += "State.variables.compass.pushAllTimeToAdvanceAsFollower();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;		
	}
	Compass.prototype.getButtonJoinAndAdvanceToConversation = function(targetSIS) {
		var bText = "<<l" + "ink [[Continue to conversation|Social Interactions]]>><<s" + "cript>>\n";
		bText	 += "State.variables.compass.sisList[" + targetSIS + "].playerRequestsJoin();"
		bText	 += "State.variables.compass.sisList[" + targetSIS + "].charsJoinSis(getCharGroup('chPlayerCharacter'));\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
	Compass.prototype.getButtonAssault = function(target) {
		var bText = "<<l" + "ink [[ Aslt |Interlude]]>><<s" + "cript>>\n";
		bText 	 += "initiatePlayerAssault('" + target + "');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	Compass.prototype.getButtonChallenge = function(target) {
		var bText = "<<l" + "ink [[ Chlg |Interlude]]>><<s" + "cript>>\n";
		bText 	 += "setUpPlayerChallengeOptions('" + target + "');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	Compass.prototype.getButtonLiberationChallenge = function(target) {
		var bText = "<<l" + "ink [[ Liberation Challenge |Interlude]]>><<s" + "cript>>\n";
		bText 	 += "initiateLiberationChallenge('chPlayerCharacter','" + target + "');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}		
	
	Compass.prototype.getButtonSpectateCombat = function(target) {
		var bText = "<<l" + "ink [[Spectate Combat|Scene]]>><<s" + "cript>>\n";
		bText += "addSpectatorsToCharsBattle('" + target + "',getCharGroup('chPlayerCharacter'));\n";
		bText += "State.variables.compass.pushAllTimeToAdvance();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	Compass.prototype.getButtonJoinCombatForced = function() {
		var bText = "<<l" + "ink [[Join combat|Scene]]>><<s" + "cript>>\n";
		bText += "State.variables.compass.pushAllTimeToAdvance();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	Compass.prototype.getButtonJoinCombatWillingly = function(joinedChar) {
		var bText = "<<l" + "ink [[Join combat on their side|Scene]]>><<s" + "cript>>\n";
		bText += 'addCharsTeamToCharsBattle("chPlayerCharacter","' + joinedChar + '");\n';
		bText += "State.variables.compass.pushAllTimeToAdvance();\n";
		bText += "State.variables.sc.formatScenePassage();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	Compass.prototype.getButtonSpectateCombatAlt = function(target) {
		// Used when the player is already spectating the combat
		var bText = "<<l" + "ink [[Spectate Combat|Scene]]>><<s" + "cript>>\n";
		bText += "State.variables.compass.pushAllTimeToAdvance();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
Compass.prototype.cleanLeftoverData = function() { // Must be used before saving the game
	this.roomPassage = "";
	this.interludePassage = "";
	this.sceneResultsPassage = "";
	this.sceneResultsTemp = "";
	this.scenarioEndPassage = "";
	
	this.roomMessage = "";
	this.roomActionsMessage = "";
	
	this.sisList = new pseudoList();
	this.lastSisId = -1;
	this.pcSis = -1;
	this.sisPassage = "";
	
	this.executingEvents = false;
	
	///
	this.flagPlayerIsPrompted = false;
	this.promptPassage = "";
	this.promptSender = ""; // Character or entity sending the prompt
	this.isPrompterAchar = true; // Is the entity prompting the Player a NPC
	
	this.flagMenuInMap = false;
	this.mapMenuPassage = "";
	///
	
	this.flagAskedToSort = false; // Necessary due to instances in which events are sorted in the middle of pushAllTimeToAdvance
	
	this.periodEndsTip = "";
	
	// Debug
	this.debugInfo = "";	
}

State.variables.compass = new Compass();

// Constructors, serializers, etc.
Compass.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
Compass.prototype.clone = function () {
	return (new Compass())._init(this);
};
Compass.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Compass())._init($ReviveData$)', ownData);
};

////////// ROOMS LIST CLASS  //////////
// Serializer functions force me to make yet another empty class
window.Rooms = function() {
};

// Constructors, serializers, etc.
Rooms.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
Rooms.prototype.clone = function () {
	return (new Rooms())._init(this);
};
Rooms.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Rooms())._init($ReviveData$)', ownData);
};


////////// CHART CLASS  //////////
// Charts contain rooms and characters able to move between them and perform actions.
// They should actually be named "maps", but Javascript disagrees. I don't think it will accept it any time soon.

window.Chart = function(key,title) {
	this.key = key;
	this.title = title;
	this.icon = null;
	this.rooms = new Rooms();
	this.characters = []; // Keys of characters currently present in map. Remember to clean.
	this.diagramDimensions = [100,100]; // Dimensions of the minimap file
};

Chart.prototype.autogenerateRooms = function(setupChart) {
	for ( var i in setup[setupChart] ) {
		var r = setup[setupChart][i];
		if ( r instanceof RoomInfo ) {
			this.rooms[r.key] = new Room(r.key,r.title);
			this.rooms[r.key].combatAllowed = r.combatAllowed;
		}
	}
}

	Chart.prototype.placeCharacter = function(charKey,roomKey) {
		gC(charKey).currentRoom = roomKey;
		this.rooms[roomKey].characters.push(charKey);
		this.characters.push(charKey);
	}
	Chart.prototype.placeCharacters = function(charKeys,roomKey) {
		for ( var character of charKeys ) {
			this.placeCharacter(character,roomKey);
		}
	}
	Chart.prototype.cleanCharacters = function() {
		for ( var character of this.characters ) {
			getRoomA(gC(character).currentRoom).characters = [];
			gC(character).currentRoom = "";
		}
		this.characters = [];
	}

	Chart.prototype.getAllRooms = function() {
		var rooms = [];
		for ( var room in this.rooms ) {
			if ( this.rooms[room] instanceof Room ) {
				rooms.push(this.rooms[room]);
			}
		}
		return rooms;
	}

// Constructors, serializers, etc.
Chart.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
Chart.prototype.clone = function () {
	return (new Chart())._init(this);
};
Chart.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Chart())._init($ReviveData$)', ownData);
};


////////// ROOM CLASS & ROOM INFO CLASS //////////
// Rooms are in-game locations, containing different actions, connections to other rooms, characters, descriptions, etc.

window.Room = function(key,title) {
	
	this.key = key;
	this.title = title;
	/*
	this.medIcon = "windrose-med.png";
	this.icon = "windrose.png";
	
	this.description = "";
	this.getDescription = function() {
		return this.description;
	}
	
	this.connections = null; // Connections refers to connected rooms in the same map, referenced by their keys.
	this.displayConnections = null;
							 // The connections are displayed as a set of links provided by a function. The function must be created manually.
																									// A dynamic function may be created later.
	
	this.getConnections = function(characterGroup) { // Returned to AIs. Will only send back valid room connections.
		return this.connections;
	}
	*/
	this.characters = []; // Keys of characters currently present in this room.
	/*
	this.getActions = function(characters) {	// Returns a list of map actions available in this room.
		return [];
	}
	
	this.getCustomActionsText = null;
	*/
	this.combatAllowed = true;
};

window.RoomInfo = function(key,title,medIcon,icon,description,connections,getActions,mapPos) {
	this.key = key;
	this.title = title;
	this.medIcon = medIcon;
	this.icon = icon;
	this.description = description;
	this.connections = connections;
	if ( getActions != null ) {
		this.getActions = getActions;
	} else {
		this.getActions = function(characters) {	// Returns a list of map actions available in this room.
			return [];
		}
	}
	this.getCustomActionsText = null;
	this.combatAllowed = true;
	
	this.mapPos = mapPos; // Position of icon in map diagram
	this.setSubarea = null; // If not null, it is a function that sets a new subarea bottom map when the player gets here
	this.getSpecialAreaCoordinates = null; // If not null, it is a function that returns different areas depending on different circumstances
}

	RoomInfo.prototype.getDescription = function() {
		return this.description;
	}
	RoomInfo.prototype.getConnections = function(characterGroup) { // Returned to AIs. Will only send back valid room connections.
		return this.connections;
	}
	RoomInfo.prototype.displayConnections = function() {
		return createStandardDisplayConnections(this.connections);
	}
	RoomInfo.prototype.getAreaCoordinates = function() {
		var coords = "";
		if ( this.getSpecialAreaCoordinates ) { coords = this.getSpecialAreaCoordinates() }
		else {
			coords = "" + this.mapPos[0] + ',' + this.mapPos[1] + ',' + (this.mapPos[0]+20) + ',' + (this.mapPos[1]+20);
		}
		return coords;
	}

window.createStandardDisplayConnections = function(connections) {
	var string = "";
	for ( var connection of connections ) {
		string += getLinkToRoom(connection.loc,"Go to " + getCurrentMap().rooms[connection.loc].title,connection.distance)
			    + " (" + colorText(connection.distance,"khaki") + ") ";
				if ( State.variables.chPlayerCharacter.hasFreeBodypart("eyes") ) {
					string += displayCharIconsInRoom(connection.loc);
				}
		string += "\n";
	}
	return string;
}

window.displayCharIconsInRoom = function(roomKey) {
	var string = "";
	for ( var character of getRoomA(roomKey).characters ) {
		if ( gC(character).icon != null ) {
			string += gC(character).icon() + " ";
		}
	}
	return string;
}

// Constructors, serializers, etc.
Room.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
Room.prototype.clone = function () {
	return (new Room())._init(this);
};
Room.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Room())._init($ReviveData$)', ownData);
};

RoomInfo.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
RoomInfo.prototype.clone = function () {
	return (new RoomInfo())._init(this);
};
RoomInfo.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new RoomInfo())._init($ReviveData$)', ownData);
};


////////// ROOM CONNECTION CLASS CLASS  //////////

window.RoomConnection = function(loc, distance) {
	this.loc = loc;
	this.distance = distance;
};

// Constructors, serializers, etc.
RoomConnection.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
RoomConnection.prototype.clone = function () {
	return (new RoomConnection())._init(this);
};
RoomConnection.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new RoomConnection())._init($ReviveData$)', ownData);
};


////////// MAP ACTIONS CLASS  //////////
// System events are dynamically generated by character actions within maps. The compass.advanceTime() function activates them.

window.mapAction = function(actionKey,actionTitle,systemEvent,flagHide) {
	this.key = actionKey; // Key
	this.title = actionTitle; // Phrase to be displayed in map
	this.description = "";
	this.tags = [];
	
	this.recMins = 60;
	this.flexibleTimes = false;
	
	this.requirements = function(charGroup) {  // This function checks if the characters are able to perform the action
		return true;
	}
	this.systemEvent = systemEvent; // System event, to be created at compass if a group of characters performs this action
	this.flagHide = flagHide; // Determines if the action may be shown even if requirements are not met
	
	this.displayTitle = function() { // Returns a string to be displayed to the player when the action is present and not hidden
		return this.actionTitle;
	}
	this.displayDescriptionMark = function() { // Returns a string to be displayed to the player to show the action's description
		var string = "";
		if ( this.description != "" ) {
			string = '<span title="' + this.description + '">^^(?)^^</span>';
		}
		return string;
	}
		
	this.eventToPile = function(minutes,characters) { // Creates a new system event at the compass' pile using this action's event as base
		State.variables.compass.ongoingEvents.push(this.systemEvent(minutes,characters));
		State.variables.compass.sortOnGoingEventsByTime();
		signCharsActive(characters);
	}
	
	this.getPassage = function() { return "Interlude" };
};

/*
window.getMapActionInRoom = function(room,actionKey) {
	var id = 0;
	var i = 0;
	for ( var mapAction of room
} */

// Constructors, serializers, etc.
mapAction.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
mapAction.prototype.clone = function () {
	return (new mapAction())._init(this);
};
mapAction.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new mapAction())._init($ReviveData$)', ownData);
};

////////// SYSTEM EVENTS CLASS  //////////
// System events are dynamically generated by character actions within maps. The compass.advanceTime() function activates them.

window.systemEvent = function(minutes,characters,title,name,effect) {
	this.title = title; // Similar to key
	this.name = name; // Displayed in text
	this.label = null; // Doesn't always have to be anything
	
	this.timeRemaining = minutes;
	this.ongoingTime = 0; // Used in effect to calculate dimension of effects
	this.priority = 0; // If events must be purged, those with the highest priority will remain
	
	this.characters = characters;
	this.effect = effect;
	
	this.extraMessages = [];

	this.flagMayBeInterrupted = true;
	this.flagMayChangeGroups = true; // If false, character can't be invited or forced to join or leave group
	
	this.flagForcedToEnd = false;
	this.applyEffectIfForcedToEnd = true; // If false, effect will not apply
	
	this.flagSignCharsAsIdleOnEnd = true; // If true, characters' AI may get a new goal when the event ends
	this.flagDontPushTimeYet = false; // This must be set to true on creation if the event will be created during
									  // pushTimeToOngoingEvents
									  
	this.executeWithoutCharacters = false;
	
	this.removeCharFromEvent = function(charKey) {
		if ( this.characters.includes(charKey) ) {
			this.characters = arrayMinusA(this.characters,charKey);
			if ( this.characters.length < 1 ) {
				// Event ran out of characters, what to do
				this.forceEnd();
			}
		}
	}
	
	this.pushTime = function(minutes) {
		var flagFinishedEvent = false;
		
		var effectMsg = "";
		if ( this.flagDontPushTimeYet == false ) {
			this.timeRemaining -= minutes;
			this.ongoingTime += minutes;
			effectMsg = "";
			
			if ( this.flagForcedToEnd == true ) {			// Forced to end
				flagFinishedEvent = true;
				if ( this.applyEffectIfForcedToEnd ) {
					if ( this.characters.length > 0 || this.executeWithoutCharacters ) {
						effectMsg = this.effect(this.characters);
					}
				}
			}
			else if ( this.timeRemaining <= 0 ) {			// Finished at its correct time
				if ( this.characters.length > 0 || this.executeWithoutCharacters ) {
					effectMsg = this.effect(this.characters); // Event gets executed
				}
				
				if ( this.flagSignCharsAsIdleOnEnd ) {
					signCharsIdle(this.characters); // Tell MapAIs these characters are missing orders
				}
				
				flagFinishedEvent = true;
			}
			
			if ( this.characters.includes("chPlayerCharacter") || this.characters.includes(gC("chPlayerCharacter").followingTo) ) {
				State.variables.compass.setInterludeInfo(effectMsg); // interludePassage = effectMsg;
			}
		}
		
		return flagFinishedEvent;
	}
	this.forceEnd = function() {
		this.timeRemaining = 0;
		
		if ( this.title != "movement" && this.title != "sisRound" ) {
			
		} else {
			var effectMsg = "The movement couldn't be completed."; // Event will not get executed
		}
		
		this.flagForcedToEnd = true;
		
		
		if ( this.title != "sisRound" ) {
			//signCharsIdle(this.characters);
		}
		
		if ( this.characters.includes("chPlayerCharacter") ) {
			State.variables.compass.setInterludeInfo(effectMsg); // interludePassage = effectMsg;
		}
		
		
		return true;
	}
	
};

// Constructors, serializers, etc.
systemEvent.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
systemEvent.prototype.clone = function () {
	return (new systemEvent())._init(this);
};
systemEvent.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new systemEvent())._init($ReviveData$)', ownData);
};

////////// TEMPLE MAPS ////////// 

setup.mapTrainingGrounds = [];
setup.mapTrainingGrounds.westLibrary = new RoomInfo(
	"westLibrary", // Key
	"West Library", // Title
	"library-med.png", // Med Icon
	"library.png", // Icon
	"Shelves full of dramatic plays fill most sides of the room. There are also some chairs and tables reserved for studying.", // Description
	[ new RoomConnection('eastLibrary',2) ,
		  new RoomConnection('amphitheater',2) ,
		  new RoomConnection('dummies',2) ,
		  new RoomConnection('mainLibrary',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionDramaReading() ];
		return actions;
	}, // getActions
	[31,128]
);

setup.mapTrainingGrounds.eastLibrary = new RoomInfo(
	"eastLibrary", // Key
	"East Library", // Title
	"library-med.png", // Med Icon
	"library.png", // Icon
	"Everywhere you look at, there are scrolls containing mystic wisdom collected through the ages. Their very presence taints the air.", // Description
	[ new RoomConnection('westLibrary',2) ,
	  new RoomConnection('dummies',2) ,
	  new RoomConnection('field',2) ,
	  new RoomConnection('mainLibrary',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionEnergyReading() ];
		return actions;
	}, // getActions
	[73,128]
);
setup.mapTrainingGrounds.amphitheater = new RoomInfo(
	"amphitheater", // Key
	"Amphitheater", // Title
	"amphietheater-med.png", // Med Icon
	"amphietheater.png", // Icon
	"A grand, circular stone platform is surrounded by several stone benches. It reminds you of home.", // Description
	[ new RoomConnection('westBridge',2) ,
	  new RoomConnection('dummies',2) ,
	  new RoomConnection('westLibrary',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionDramaActing() ];
		return actions;
	}, // getActions
	[9,89]
);
setup.mapTrainingGrounds.dummies = new RoomInfo(
	"dummies", // Key
	"Dummies", // Title
	"dummies-med.png", // Med Icon
	"dummies.png", // Icon
	"This place is filled with straw men, wrapped with strong leather but fluffy if you push them. They're perfect if you need to kick something.", // description
	[ new RoomConnection('eastBridge',2) ,
	  new RoomConnection('field',2) ,
	  new RoomConnection('eastLibrary',2) ,
	  new RoomConnection('westLibrary',2) ,
	  new RoomConnection('amphitheater',2) ,
	  new RoomConnection('westBridge',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionAerobics() ,
						createTrainingActionSpellcasting() ];
		return actions;
	}, // getActions
	[52,89]
);
setup.mapTrainingGrounds.field = new RoomInfo(
	"field", // Key
	"Field", // Title
	"field-med.png", // Med Icon
	"field.png", // Icon
	"This is the clearest area in the training grounds. You're guaranteed to find a spot in which you can unleash hellflames without destroying anything.", // description
	[ new RoomConnection('lowerWaterfall',2) ,
	  new RoomConnection('southNaturalWall',2) ,
	  new RoomConnection('eastLibrary',2) ,
	  new RoomConnection('dummies',2) ,
	  new RoomConnection('eastBridge',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionSpellcasting() ];
		return actions;
	}, // getActions
	[93,88]
);
setup.mapTrainingGrounds.westBridge = new RoomInfo(
	"westBridge", // Key
	"West Bridge", // Title
	"bridge-med.png", // Med Icon
	"bridge.png", // Icon
	"Looking downstream, you see the water leaving the training grounds, passing below the Temple's walls.", // description
	[ new RoomConnection('forest',2) ,
	  new RoomConnection('dummies',2) ,
	  new RoomConnection('amphitheater',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionSwimming() ];
		return actions;
	}, // getActions
	[30,55]
);
setup.mapTrainingGrounds.eastBridge = new RoomInfo(
	"eastBridge", // Key
	"East Bridge", // Title
	"bridge-med.png", // Med Icon
	"bridge.png", // Icon
	"Looking upstream, you see a decently sized waterfall, and an even bigger one behind it.", // description
	[ new RoomConnection('lake',2) ,
	  new RoomConnection('lowerWaterfall',2) ,
	  new RoomConnection('field',2) ,
	  new RoomConnection('dummies',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionSwimming() ];
		return actions;
	}, // getActions
	[74,54]
);
setup.mapTrainingGrounds.forest = new RoomInfo(
	"forest", // Key
	"Forest", // Title
	"forest-med.png", // Med Icon
	"forest.png", // Icon
	"The trees are shaken by the wind.", // description
	[ new RoomConnection('lake',2) ,
	  new RoomConnection('westBridge',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionMeditation(),
						createRestingActionStandard() ];
		return actions;
	}, // getActions
	[31,18]
);
setup.mapTrainingGrounds.lake = new RoomInfo(
	"lake", // Key
	"Lake", // Title
	"lake-med.png", // Med Icon
	"lake.png", // Icon
	"It smells like wet grass.", // description
	[ new RoomConnection('northNaturalWall',2) ,
	  new RoomConnection('lowerWaterfall',2) ,
	  new RoomConnection('eastBridge',2) ,
	  new RoomConnection('forest',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionAerobics() , 
						createTrainingActionMeditation() ];
		return actions;
	}, // getActions
	[74,18]
);
setup.mapTrainingGrounds.lowerWaterfall = new RoomInfo(
	"lowerWaterfall", // Key
	"Lower Waterfall", // Title
	"waterfall-med.png", // Med Icon
	"waterfall.png", // Icon
	"The falling water crashes violently against the river. Against this noise, you find peace.", // description
	[ new RoomConnection('field',2) ,
	  new RoomConnection('eastBridge',2) ,
	  new RoomConnection('lake',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionWaterfallMeditation() ];
		return actions;
	}, // getActions
	[110,35]
);
setup.mapTrainingGrounds.southNaturalWall = new RoomInfo(
	"southNaturalWall", // Key
	"Natural Wall South", // Title
	"natural-wall-med.png", // Med Icon
	"natural-wall.png", // Icon
	"Rock walls at one side and cliffs at its opposite. Stairs carved in stone connect this place with the field.", // description
	[ new RoomConnection('northNaturalWall',2) ,
	  new RoomConnection('upperWaterfall',2) ,
	  new RoomConnection('field',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionAnaerobics() ];
		return actions;
	}, // getActions
	[133,63]
);
setup.mapTrainingGrounds.northNaturalWall = new RoomInfo(
	"northNaturalWall", // Key
	"Natural Wall North", // Title
	"natural-wall-med.png", // Med Icon
	"natural-wall.png", // Icon
	"Rock walls at one side and cliffs at its opposite. Stairs carved in stone connect this place with the lake.", // description
	[ new RoomConnection('lake',2) ,
	  new RoomConnection('upperWaterfall',2) ,
	  new RoomConnection('southNaturalWall',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionAnaerobics() ];
		return actions;
	}, // getActions
	[134,8]
);
setup.mapTrainingGrounds.upperWaterfall = new RoomInfo(
	"upperWaterfall", // Key
	"Upper Waterfall", // Title
	"waterfall-med.png", // Med Icon
	"waterfall.png", // Icon
	"This is the most secluded place of the training grounds. If you look up, you can contemplate the immense mountain that gives home to the Temple.", // description
	[ new RoomConnection('northNaturalWall',2) ,
	  new RoomConnection('southNaturalWall',2) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionWaterfallMeditation() ,
						createTrainingActionEnergyReading() ];
		return actions;
	}, // getActions
	[158,35]
);
setup.mapTrainingGrounds.mainLibrary = new RoomInfo(
	"mainLibrary", // Key
	"Main Library", // Title
	"library-med.png", // Med Icon
	"library.png", // Icon
	"This great room is probably bigger than the West and East wings combined. The vast majority of the Confined Valley's history is here.", // description
	[ new RoomConnection('eastLibrary',2) ,
	  new RoomConnection('westLibrary',2) ,
	  new RoomConnection('grandHall',2) ], // Connections
	function(characters) {
		var actions = [];
		if ( getScrollsCharMayFind(characters[0]).length > 0 ) {
			actions.push(createSearchForScrollsAction());
		}
		actions.push(createRestingActionStandard());
		if ( ( characters[0] != "chPlayerCharacter" ) && ( gC(characters[0]).studiedScrollToday == false ) ) {
			actions.push(createStyduRandomScrollMapAction());
		}
		return actions;
	}, // getActions
	[52,159]
);
setup.mapTrainingGrounds.mainLibrary.getCustomActionsText = function(characters) {
	var cText = "";
	if ( ( gC(characters[0]).foundScrolls.length > gC(characters[0]).studiedScrolls.length ) && ( gC(characters[0]).studiedScrollToday == false ) ) {
		cText = "Study a scroll<sup><span title='Pick a specific scroll and the characters will study its contents.'>(?)</span></sup> "
			  + getButtonMapMenuSelectScroll() + "\n";
	}
	if ( getScrollsCharMayFind(characters[0]).length < 1 ) {
		cText += colorText("Locked:","firebrick") + " There aren't any new scrolls for the characters.\n";
	}
	if ( gC(characters[0]).foundScrolls.length == gC(characters[0]).studiedScrolls.length ) {
		cText += colorText("Locked:","firebrick") + " The characters haven't found any new scrolls to study.\n";
	} else if ( gC(characters[0]).studiedScrollToday ) {
		cText += colorText("Locked:","firebrick") + " The leading character has already studied a scroll today.\n";
	}
	return cText;
}
setup.mapTrainingGrounds.mainLibrary.combatAllowed = false;

setup.mapTrainingGrounds.grandHall = new RoomInfo(
	"grandHall", // Key
	"Grand Hall", // Title
	"greathall-med.png", // Med Icon
	"greathall.png", // Icon
	"The Statue of the Goddess looks over its creation.", // description
	[ new RoomConnection('mainLibrary',2) ,
	  new RoomConnection('roomsOuterNorth',2) ,
	  new RoomConnection('roomsOuterSouth',2) ,
	  new RoomConnection('fulfillmentCorridor',2) ,
	  new RoomConnection('ambitionCorridor',2) ], // Connections
	null, // getActions
	[95,193]
);
setup.mapTrainingGrounds.roomsOuterNorth = new RoomInfo(
	"roomsOuterNorth", // Key
	"Rooms - Outer North Wing", // Title
	"corridor-left-med.png", // Med Icon
	"corridor-left.png", // Icon
	"This corridor is connected by stairs to the Grand Hall. You can find the rooms of the priestesses and other long-term residents here.", // description
	[ new RoomConnection('grandHall',2) ,
	  new RoomConnection('roomsInnerNorth',2) ], // Connections
	null, // getActions
	[41,221]
); 
setup.mapTrainingGrounds.roomsInnerNorth = new RoomInfo(
	"roomsInnerNorth", // Key
	"Rooms - Inner North Wing", // Title
	"corridor-left-med.png", // Med Icon
	"corridor-left.png", // Icon
	"The halls get darker as you advance.", // description
	[ new RoomConnection('roomsOuterNorth',2) ,
	  new RoomConnection('roomsInnerSouth',2) ], // Connections
	null, // getActions
	[15,249]
);
setup.mapTrainingGrounds.roomsInnerSouth = new RoomInfo(
	"roomsInnerSouth", // Key
	"Rooms - Inner South Wing", // Title
	"corridor-right-med.png", // Med Icon
	"corridor-right.png", // Icon
	"You can find your room here, as well as those of other Candidates.", // description
	[ new RoomConnection('roomsInnerNorth',2) ,
	  new RoomConnection('roomsOuterSouth',2) ,
	  new RoomConnection('playerRoom',1),
	  new RoomConnection('mirRoom',1),
	  new RoomConnection('ateRoom',1) ], // Connections
	null, // getActions
	[41,278]
);
setup.mapTrainingGrounds.roomsInnerSouth.getConnections = function(characters) {
	var rooms = [this.connections[0],this.connections[1]];
	if ( characters.includes("chPlayerCharacter") ) {
		rooms.push(this.connections[2]);
	}
	if ( characters.includes("chMir") ) {
		rooms.push(this.connections[3]);
	}
	if ( characters.includes("chAte") ) {
		rooms.push(this.connections[4]);
	}
	return rooms;
}
setup.mapTrainingGrounds.roomsInnerSouth.displayConnections = function() {
	var string = getLinkToRoom(this.connections[0].loc,"Go to " + getCurrentMap().rooms[this.connections[0].loc].title,this.connections[0].distance)
			    + " (" + colorText(2,"khaki") + ") " + displayCharIconsInRoom(this.connections[0].loc) + "\n";
	string += getLinkToRoom(this.connections[1].loc,"Go to " + getCurrentMap().rooms[this.connections[1].loc].title,this.connections[1].distance)
			    + " (" + colorText(2,"khaki") + ") " + displayCharIconsInRoom(this.connections[1].loc) + "\n";
	string += getLinkToRoom(this.connections[2].loc,"Go to " + getCurrentMap().rooms[this.connections[2].loc].title,this.connections[2].distance)
			    + " (" + colorText(1,"khaki") + ") " + displayCharIconsInRoom(this.connections[2].loc) + "\n";
	if ( getPlayerCharsGroup().includes("chMir") ) {
		string += getLinkToRoom(this.connections[3].loc,"Go to " + getCurrentMap().rooms[this.connections[3].loc].title,this.connections[3].distance)
			    + " (" + colorText(1,"khaki") + ") " + displayCharIconsInRoom(this.connections[3].loc) + "\n";
	} else {
		string += colorText("You can't enter Padmiri's room without Padmiri.\n","red");
	}
	if ( getPlayerCharsGroup().includes("chAte") ) {
		string += getLinkToRoom(this.connections[4].loc,"Go to " + getCurrentMap().rooms[this.connections[4].loc].title,this.connections[4].distance)
			    + " (" + colorText(1,"khaki") + ") " + displayCharIconsInRoom(this.connections[4].loc) + "\n";
	} else {
		string += colorText("You can't enter Maaterasu's room without Maaterasu.\n","red");
	}
	return string;
}
setup.mapTrainingGrounds.roomsOuterSouth = new RoomInfo(
	"roomsOuterSouth", // Key
	"Rooms - Outer South Wing", // Title
	"corridor-right-med.png", // Med Icon
	"corridor-right.png", // Icon
	"This room is connected by stairs to the Grand Hall. You can find the rooms of other Candidates here.", // description
	[ new RoomConnection('roomsInnerSouth',2) ,
	  new RoomConnection('grandHall',2),
	  new RoomConnection('clawRoom',1),
	  new RoomConnection('nashRoom',1),
	  new RoomConnection('valRoom',1) ], // Connections
	null, // getActions
	[67,250]
);
setup.mapTrainingGrounds.roomsOuterSouth.getConnections = function(characters) {
	var rooms = [this.connections[0],this.connections[1]];
	if ( characters.includes("chClaw") ) {
		rooms.push(this.connections[2]);
	}
	if ( characters.includes("chNash") ) {
		rooms.push(this.connections[3]);
	}
	if ( characters.includes("chVal") ) {
		rooms.push(this.connections[4]);
	}
	return rooms;
}
setup.mapTrainingGrounds.roomsOuterSouth.displayConnections = function() {
	var string = getLinkToRoom(this.connections[0].loc,"Go to " + getCurrentMap().rooms[this.connections[0].loc].title,this.connections[0].distance)
			    + " (" + colorText(2,"khaki") + ") " + displayCharIconsInRoom(this.connections[0].loc) + "\n";
	string += getLinkToRoom(this.connections[1].loc,"Go to " + getCurrentMap().rooms[this.connections[1].loc].title,this.connections[1].distance)
			    + " (" + colorText(2,"khaki") + ") " + displayCharIconsInRoom(this.connections[1].loc) + "\n";
	if ( getPlayerCharsGroup().includes("chClaw") ) {
		string += getLinkToRoom(this.connections[2].loc,"Go to " + getCurrentMap().rooms[this.connections[2].loc].title,this.connections[2].distance)
			    + " (" + colorText(1,"khaki") + ") " + displayCharIconsInRoom(this.connections[2].loc) + "\n";
	} else {
		string += colorText("You can't enter Claw's room without Claw.\n","red");
	}
	if ( getPlayerCharsGroup().includes("chNash") ) {
		string += getLinkToRoom(this.connections[3].loc,"Go to " + getCurrentMap().rooms[this.connections[3].loc].title,this.connections[3].distance)
			    + " (" + colorText(1,"khaki") + ") " + displayCharIconsInRoom(this.connections[3].loc) + "\n";
	} else {
		string += colorText("You can't enter Nashillbyir's room without Nashillbyir.\n","red");
	}
	if ( getPlayerCharsGroup().includes("chVal") ) {
		string += getLinkToRoom(this.connections[4].loc,"Go to " + getCurrentMap().rooms[this.connections[4].loc].title,this.connections[4].distance)
			    + " (" + colorText(1,"khaki") + ") " + displayCharIconsInRoom(this.connections[4].loc) + "\n";
	} else {
		string += colorText("You can't enter Valtan's room without Valtan.\n","red");
	}
	return string;
}
setup.mapTrainingGrounds.grandHall.combatAllowed = false;
setup.mapTrainingGrounds.roomsOuterNorth.combatAllowed = false;
setup.mapTrainingGrounds.roomsInnerNorth.combatAllowed = false;
setup.mapTrainingGrounds.roomsOuterSouth.combatAllowed = false;
setup.mapTrainingGrounds.roomsInnerSouth.combatAllowed = false;

setup.mapTrainingGrounds.playerRoom = new RoomInfo(
	"playerRoom", // Key
	"Player Room", // Title
	"candidates-room-med.png", // Med Icon
	"candidates-room.png", // Icon
	"It's too early to go to sleep. Go get busy.", // description
	[ new RoomConnection('roomsInnerSouth',1) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard() ];
		return actions;
	}, // getActions
	[9,316]
);
setup.mapTrainingGrounds.mirRoom = new RoomInfo(
	"mirRoom", // Key
	"Padmiri's Room", // Title
	"candidates-room-med.png", // Med Icon
	"candidates-room.png", // Icon
	"A bed made of giant leaves sits at the center of the room. Vines, mushrooms, roots and many other plants grow around the walls.", // description
	[ new RoomConnection('roomsInnerSouth',1) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard() ];
		return actions;
	}, // getActions
	[34,320]
);
setup.mapTrainingGrounds.ateRoom = new RoomInfo(
	"ateRoom", // Key
	"Maaterasu's Room", // Title
	"candidates-room-med.png", // Med Icon
	"candidates-room.png", // Icon
	"A strange purple orb at the top of a gray pillar watches your every move.", // description
	[ new RoomConnection('roomsInnerSouth',1) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard() ];
		return actions;
	}, // getActions
	[59,316]
);
setup.mapTrainingGrounds.clawRoom = new RoomInfo(
	"clawRoom", // Key
	"Fiercest Claw's Room", // Title
	"candidates-room-med.png", // Med Icon
	"candidates-room.png", // Icon
	"A lone dummy stands at the center of the room, severely injured. Someone's been scratching it.", // description
	[ new RoomConnection('roomsOuterSouth',1) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard() ];
		return actions;
	}, // getActions
	[105,287]
);
setup.mapTrainingGrounds.nashRoom = new RoomInfo(
	"nashRoom", // Key
	"Nashillbyir's Room", // Title
	"candidates-room-med.png", // Med Icon
	"candidates-room.png", // Icon
	"Weapon frames decorate the walls, featuring a staff, a pike and a bow.", // description
	[ new RoomConnection('roomsOuterSouth',1) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard() ];
		return actions;
	}, // getActions
	[115,263]
);
setup.mapTrainingGrounds.valRoom = new RoomInfo(
	"valRoom", // Key
	"Valtan's Room", // Title
	"candidates-room-med.png", // Med Icon
	"candidates-room.png", // Icon
	"A large pond covers most of the room.", // description
	[ new RoomConnection('roomsOuterSouth',1) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard() ];
		return actions;
	}, // getActions
	[106,238]
);
setup.mapTrainingGrounds.playerRoom.combatAllowed = false;
setup.mapTrainingGrounds.mirRoom.combatAllowed = false;
setup.mapTrainingGrounds.ateRoom.combatAllowed = false;
setup.mapTrainingGrounds.clawRoom.combatAllowed = false;
setup.mapTrainingGrounds.nashRoom.combatAllowed = false;
setup.mapTrainingGrounds.valRoom.combatAllowed = false;

setup.mapTrainingGrounds.fulfillmentCorridor = new RoomInfo(
	"fulfillmentCorridor", // Key
	"Fulfillment Corridor", // Title
	"fulfillment-corridor-med.png", // Med Icon
	"fulfillment-corridor.png", // Icon
	"Lavish chandeliers and some inner windows create a calid illumination.", // description
	[ new RoomConnection('grandHall',2) ,
	  new RoomConnection('diningHall',2) ,
	  new RoomConnection('publicBaths',2) ], // Connections
	null, // getActions
	[151,166]
);
setup.mapTrainingGrounds.diningHall = new RoomInfo(
	"diningHall", // Key
	"Dining Hall", // Title
	"dininghall-med.png", // Med Icon
	"dininghall.png", // Icon
	"A long table stands along the room. Half a hundred people would be able to eat here.", // description
	[ new RoomConnection('fulfillmentCorridor',2) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard() ];
		return actions;
	}, // getActions
	[137,131]
);
setup.mapTrainingGrounds.publicBaths = new RoomInfo(
	"publicBaths", // Key
	"Public Baths", // Title
	"public-bath-med.png", // Med Icon
	"public-bath.png", // Icon
	"Termal waters similar to those you found at your room. There is, however, a chill in the air.", // description
	[ new RoomConnection('fulfillmentCorridor',2) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard() ];
		return actions;
	}, // getActions
	[166,131]
);
setup.mapTrainingGrounds.ambitionCorridor = new RoomInfo(
	"ambitionCorridor", // Key
	"Ambition Corridor", // Title
	"ambition-corridor-med.png", // Med Icon
	"ambition-corridor.png", // Icon
	"Austere lighting, stern decorations.", // description
	[ new RoomConnection('grandHall',2) ,
	  new RoomConnection('storage',2) ,
	  new RoomConnection('starsTower',2) ], // Connections
	null, // getActions
	[156,219]
);
setup.mapTrainingGrounds.storage = new RoomInfo(
	"storage", // Key
	"Storage", // Title
	"storage-med.png", // Med Icon
	"storage.png", // Icon
	"All kinds of tools and materials are saved here. You aren't allowed to take any.", // description
	[ new RoomConnection('ambitionCorridor',2) ], // Connections
	null, // getActions
	[191,205]
);
setup.mapTrainingGrounds.starsTower = new RoomInfo(
	"starsTower", // Key
	"Stars Tower", // Title
	"startower-med.png", // Med Icon
	"startower.png", // Icon
	"Blue crystals surround the room's candles, printing their color into everything. You can find a telescope and several tools of geometric calculation.", // description
	[ new RoomConnection('ambitionCorridor',2) ], // Connections
	null, // getActions
	[191,234]
);
setup.mapTrainingGrounds.starsTower.getCustomActionsText = function(characters) {
	var cText = "";
	if ( State.variables.StVarsList.includes("go0") && quantifyCharacterVacuumStrength("chPlayerCharacter") < (18*9) ) {
		cText = getButtonMapMenuRespec() + "<sup><span title='You will have a one-time opportunity to switch the values of three pairs of stats.'>(?)</span></sup> " + "\n";
	}
	return cText;
}
setup.mapTrainingGrounds.fulfillmentCorridor.combatAllowed = false;
setup.mapTrainingGrounds.diningHall.combatAllowed = false;
setup.mapTrainingGrounds.publicBaths.combatAllowed = false;
setup.mapTrainingGrounds.ambitionCorridor.combatAllowed = false;
setup.mapTrainingGrounds.storage.combatAllowed = false;
setup.mapTrainingGrounds.starsTower.combatAllowed = false;

////////////////////////////////////////////

//State.variables.mapTrainingGrounds = new Chart("mapTrainingGrounds","Passion Temple");
//State.variables.mapTrainingGrounds.icon = "temple-map.png";

//State.variables.mapTrainingGrounds.autogenerateRooms("mapTrainingGrounds");

window.initMapTrainingGrounds = function() {
	State.variables.mapTrainingGrounds = new Chart("mapTrainingGrounds","Passion Temple");
	State.variables.mapTrainingGrounds.diagramDimensions = [217,346];
	State.variables.mapTrainingGrounds.icon = "temple-map.png";

	State.variables.mapTrainingGrounds.autogenerateRooms("mapTrainingGrounds");
}
initMapTrainingGrounds();
window.deinitMapTrainingGrounds = function() {
	delete State.variables.mapTrainingGrounds;
}

// TRAINING MAP ACTIONS //
// Tags: "trRankX" refers to "Training of Rank X"

// Auxiliar
window.charConsumesBarAmount = function(character,bar,amount) {
	var flagEnoughBar = false;
	
	
	if ( gC(character)[bar].current >= amount ) {
		flagEnoughBar = true;
	}
	gC(character)[bar].changeValue(-amount);
	
	if ( gC(character)[bar].current < 0 ) {
		gC(character)[bar].current = 0;
	}
	
	return flagEnoughBar;
}

window.charsGetExpRate = function(minutes,characters,stat,rate) {
	var rxm = rate * minutes;
	for ( var charKey of characters ) {
		gC(charKey)[stat].addExperience(rxm);
	}
}
window.charGetsExpRate = function(minutes,character,stat,rate) {
	var rxm = rate * trainingResultsVar() * minutes;
	gC(character)[stat].addExperience(rxm);
	return rxm;
}

window.tutorshipExtraExp = function(minutes,characters,stat,rate) {
	var resultsText = "";
	for ( var charKey of characters ) {
		if ( gC(charKey).domChar == characters[0] ) {
			if ( gRelTypeAb(charKey,characters[0]).type == "tutorship" ) {
				var dice = limitedRandomInt(100);
				if ( gC(charKey)[stat].value < gC(characters[0])[stat].value ) {
					var rxm = rate * trainingResultsVar() * minutes * 0.25;
					if ( dice < 21 ) { rxm *= 2; }
					gC(charKey)[stat].addExperience(rxm);
					resultsText += "\nAs " + gC(charKey).getFormattedName() + "'s tutor, " + gC(characters[0]).getFormattedName() + " helped " + gC(charKey).getFormattedName() + " gain " + (rxm * gC(charKey)[stat].affinity).toFixed(2) + " additional experience points. ";
					if ( dice < 21 ) {
						resultsText += "A most dedicated attention by part of " + gC(charKey).posPr + " tutor doubled this amount, in exchange for increased submission. ";
						var dom = gC(charKey).domChar;
						getRelation(charKey,dom).submission.stv += 40;
						getRelation(dom,charKey).domination.stv += 40;
					}
				}
			}
		}
	}
	if ( resultsText != "" ) { resultsText = "\n\n" + resultsText; } 
	return resultsText;
}
window.sharedTrainingRelationshipEvents = function(characters) {
	var message = "";
	if ( characters.length > 1 ) {
		var it1 = 0;
		while ( it1 < characters.length - 1 ) {
			var it2 = it1 + 1;
			while ( it2 < characters.length ) {
				var char1 = characters[it1];
				var char2 = characters[it2];
				if ( getRelation(char1,char2) != undefined ) {
					message += sharedTrainingRelationshipEvent(char1,char2);
				}
				it2++;
			}
			it1++;
		}
	}
	if ( message != "" ) { message += "\n\n"; }
	return message;
}
window.sharedTrainingRelationshipEvent = function(charA,charB) {
	var dice = limitedRandomInt(100);
	var msg = "";
	var rivalryFlag = false;
	// Events: Raised friendship, raised rivalry, raised domination
	if ( gC(charA).domChar == charB ) { 				// B doms A
		if ( dice < (12 + gC(charB).dDomination.level) ) { // Domination
			getRelation(charA,charB).submission.stv += 40;
			getRelation(charB,charA).domination.stv += 40;
			msg += randomFromList( [
							(ktn(charB) + " amends " + ktn(charA) + "'s posture."),
							(ktn(charA) + " feels the confident gaze of " + ktn(charB) + " upon " + gC(charA).comPr + "."),
							(ktn(charB) + " orders " + ktn(charA) + " to assist " + gC(charB).comPr + " in " + gC(charB).posPr + " own training.")
					] ) + " " + colorText((gC(charA).getName() + "'s submission towards " + gC(charB).getName() + " has increased."),"purple");
		}
	} else if ( gC(charB).domChar == charA ) { 			// A doms B
		if ( dice < (12 + gC(charA).dDomination.level) ) { // Friendship
			getRelation(charA,charB).domination.stv += 40;
			getRelation(charB,charA).submission.stv += 40;
			msg += randomFromList( [
							(ktn(charA) + " amends " + ktn(charB) + "'s posture."),
							(ktn(charB) + " feels the confident gaze of " + ktn(charA) + " upon " + gC(charB).comPr + "."),
							(ktn(charA) + " orders " + ktn(charB) + " to assist " + gC(charA).comPr + " in " + gC(charA).posPr + " own training.")
					] ) + " " + colorText((gC(charB).getName() + "'s submission towards " + gC(charA).getName() + " has increased."),"purple");
		}
	} else if ( gC(charA).egaChars.includes(charB) ) {  // Egalitarian relationship
	} else { 											// Else
		if ( dice < (5 + (gC(charA).dAmbition.level + gC(charA).dImprovement.level + gC(charB).dAmbition.level + gC(charB).dImprovement.level) * 0.3) ) { // Rivalry
			rivalryFlag = true;
			getRelation(charA,charB).rivalry.stv += 40;
			getRelation(charB,charA).rivalry.stv += 40;
			msg += randomFromList( [
							(ktn(charA) + " cannot help but try to outdo " + ktn(charB) + " during the training. This endeavor doesn't go unnoticed."),
							(ktn(charA) + " notices " + ktn(charB) + " trying to finish everything one step ahead of " + gC(charA).comPr + "."),
							("A tense air forms between " + ktn(charA) + " and " + ktn(charB) + " during the training, perhaps due to their competitiveness.")
						] ) + " " + colorText((gC(charB).getName() + "'s and " + gC(charA).getName() + "'s rivalry has increased."),"darkred");
		}
	}
	
	dice = limitedRandomInt(100);
	if ( (dice < (25 + gC(charA).dCooperation.level + gC(charB).dCooperation.level)) && rivalryFlag == false ) { // Friendship
		if ( msg != "" ) { msg += ""; }
		getRelation(charA,charB).friendship.stv += 40;
		getRelation(charB,charA).friendship.stv += 40;
		msg += randomFromList( [
						(ktn(charA) + " and " + ktn(charB) + " are enjoying each other's company."),
						("The training session gets enlivened by " + ktn(charA) + " and " + ktn(charB) + " jokes."),
						(ktn(charB) + " and " + ktn(charA) + " get to know each other a little better during this time.")
					] ) + " " + colorText((gC(charB).getName() + "'s and " + gC(charA).getName() + "'s friendship has increased."),"khaki");
	}
	
	if ( msg != "" ) { msg = "\n" + msg; }
	return msg;
}

window.createCharGotExpMessage = function(character,stat,exp) {
	var msg = ktn(character) + " gained " + (exp * gC(character)[stat].affinity).toFixed(2) + " " + stat + " experience.";
	//var msg = ktn(character) + " gained a base " + exp + " " + stat + " experience.";
	return msg;
}
window.createCharSpentBarMessage = function(character,bar,cost) {
	var msg = ktn(character) + " spent " + cost.toFixed(2) + " " + getBarName(bar) + " points.\n";
	return msg;
}
window.charRecoversBarPercent = function(character,barType,percent) {
	var recoveryValue = gC(character)[barType].max * percent;
	gC(character)[barType].changeValue(recoveryValue);
	return recoveryValue;
}

// Actions
window.createSystemEventStandardRest = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"standardRest","Rest for one hour",function(cList) {
			var percent = 10 * restingResultsVar();
			var rPercent = percent * 0.01;
			for ( var character of cList ) {
				for ( var bar of ["lust","willpower","energy","socialdrive"] ) {
					charRecoversBarPercent(character,bar,rPercent*(this.ongoingTime/60));
				}
			}
			if ( cList.length > 1 ) {
				var eventMsg = "" + ktn(cList[0]) + " and the others rested for a while, recovering lust, "
							+ "willpower, energy and social drive points.\n";
			}
			else if (cList.length == 0) {
				var eventMsg = "";
			}
			else {
				var eventMsg = "" + ktn(cList[0]) + " rested for an hour, recovering lust, "
							+ "willpower, energy and social drive points.\n";
			}
			return eventMsg;
		}
	);
	sEvent.priority = 1;
	return sEvent;
}
window.createRestingActionStandard = function() {
	var action = new mapAction("standardRest","Rest for one hour",createSystemEventStandardRest,false);
	action.description = "The characters will rest for an hour, partially recovering their bar stats.";
	action.tags.push("rest");
	action.recMins = 60;
	action.flexibleTimes = true;
	return action;
}

	// Empathy
window.createSystemEventDramaReading = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"dramaReading","Drama Reading",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 1;
			var barCost = 20;
			var barType = "socialdrive";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				if ( charHadEnoughBar == false ) { expRate = 0.5; } 
				exp = charGetsExpRate(this.ongoingTime,character,"empathy",expRate);
				eventMsg += createCharGotExpMessage(character,"empathy",exp) + "\n";
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
			}
			eventMsg += tutorshipExtraExp(minutes,characters,"empathy",expRate);
			eventMsg += sharedTrainingRelationshipEvents(characters);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createTrainingActionDramaReading = function() {
	var action = new mapAction("dramaReading","Drama Reading",createSystemEventDramaReading,false);
	action.description = "The characters will make critical readings of different drama plays to train their empathy, consuming social drive.";
	action.tags.push("training","trRank1","empathy");
	action.recMins = 60;
	action.flexibleTimes = true;
	
	return action;
}

	// Charisma
window.createSystemEventDramaActing = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"dramaActing","Drama Acting",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 1;
			var barCost = 20;
			var barType = "socialdrive";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				if ( charHadEnoughBar == false ) { expRate = 0.5; } 
				exp = charGetsExpRate(this.ongoingTime,character,"charisma",expRate);
				eventMsg += createCharGotExpMessage(character,"charisma",exp) + "\n";
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
				//eventMsg += 
			}
			eventMsg += tutorshipExtraExp(minutes,characters,"charisma",expRate);
			eventMsg += sharedTrainingRelationshipEvents(characters);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createTrainingActionDramaActing = function() {
	var action = new mapAction("dramaActing","Drama Acting",createSystemEventDramaActing,false);
	action.description = "The characters will train their charisma playing different roles in the stage, consuming social drive.";
	action.tags.push("training","trRank1","charisma");
	action.recMins = 60;
	action.flexibleTimes = true;
	return action;
}

	// Luck
window.createSystemEventWaterfallMeditation = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"waterfallMeditation","Waterfall Meditation",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 1;
			var barCost = 0;
			var barType = "socialdrive";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				if ( charHadEnoughBar == false ) { expRate = 0.5; } 
				exp = charGetsExpRate(this.ongoingTime,character,"luck",expRate);
				eventMsg += createCharGotExpMessage(character,"luck",exp) + "\n";
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
			}
			eventMsg += tutorshipExtraExp(minutes,characters,"luck",expRate);
			eventMsg += sharedTrainingRelationshipEvents(characters);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createTrainingActionWaterfallMeditation = function() {
	var action = new mapAction("waterfallMeditation","Waterfall Meditation",createSystemEventWaterfallMeditation,false);
	action.description = "Mysterious are the ways of the world, and characters immersing themselves within it will be at harmony with the Universe. Trains luck.";
	action.tags.push("training","trRank1","luck");
	action.recMins = 60;
	action.flexibleTimes = true;
	return action;
}

	// Resilience
window.createSystemEventSwimming = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"swimming","Swimming",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 1;
			var barCost = 20;
			var barType = "energy";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				if ( charHadEnoughBar == false ) { expRate = 0.5; } 
				exp = charGetsExpRate(this.ongoingTime,character,"resilience",expRate);
				eventMsg += createCharGotExpMessage(character,"resilience",exp) + "\n";
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
			}
			eventMsg += tutorshipExtraExp(minutes,characters,"resilience",expRate);
			eventMsg += sharedTrainingRelationshipEvents(characters);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createTrainingActionSwimming = function() {
	var action = new mapAction("swimming","Swimming",createSystemEventSwimming,false);
	action.description = "The characters will train their resilience swimming in the river, consuming energy.";
	action.tags.push("training","trRank1","resilience");
	action.recMins = 60;
	action.flexibleTimes = true;
	return action;
}

	// Agility
window.createSystemEventAerobics = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"aerobics","Aerobics",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 1;
			var barCost = 20;
			var barType = "energy";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				if ( charHadEnoughBar == false ) { expRate = 0.5; } 
				exp = charGetsExpRate(this.ongoingTime,character,"agility",expRate);
				eventMsg += createCharGotExpMessage(character,"agility",exp) + "\n";
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
			}
			eventMsg += tutorshipExtraExp(minutes,characters,"agility",expRate);
			eventMsg += sharedTrainingRelationshipEvents(characters);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createTrainingActionAerobics = function() {
	var action = new mapAction("aerobics","Aerobics",createSystemEventAerobics,false);
	action.description = "The characters will do aerobic execises to train their agility, consuming energy.";
	action.tags.push("training","trRank1","agility");
	action.recMins = 60;
	action.flexibleTimes = true;
	return action;
}

	// Physique
window.createSystemEventAnaerobics = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"anaerobics","Anaerobics",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 1;
			var barCost = 20;
			var barType = "energy";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				if ( charHadEnoughBar == false ) { expRate = 0.5; } 
				exp = charGetsExpRate(this.ongoingTime,character,"physique",expRate);
				eventMsg += createCharGotExpMessage(character,"physique",exp) + "\n";
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
			}
			eventMsg += tutorshipExtraExp(minutes,characters,"physique",expRate);
			eventMsg += sharedTrainingRelationshipEvents(characters);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createTrainingActionAnaerobics = function() {
	var action = new mapAction("anaerobics","Anaerobics",createSystemEventAnaerobics,false);
	action.description = "The characters will do anaerobic execises to train their physique, consuming energy.";
	action.tags.push("training","trRank1","physique");
	action.recMins = 60;
	action.flexibleTimes = true;
	return action;
}

	// Will
window.createSystemEventMeditation = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"meditation","Meditation",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 1;
			var barCost = 20;
			var barType = "willpower";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				if ( charHadEnoughBar == false ) { expRate = 0.5; } 
				exp = charGetsExpRate(this.ongoingTime,character,"will",expRate);
				eventMsg += createCharGotExpMessage(character,"will",exp) + "\n";
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
			}
			eventMsg += tutorshipExtraExp(minutes,characters,"will",expRate);
			eventMsg += sharedTrainingRelationshipEvents(characters);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createTrainingActionMeditation = function() {
	var action = new mapAction("meditation","Meditation",createSystemEventMeditation,false);
	action.description = "The characters will look deep into every dimension of themselves, hardening in the face of adversity and training their will, consuming willpower.";
	action.tags.push("training","trRank1","will");
	action.recMins = 60;
	action.flexibleTimes = true;
	return action;
}

	// Intelligence
window.createSystemEventSpellcasting = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"spellcasting","Spellcasting",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 1;
			var barCost = 20;
			var barType = "willpower";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				if ( charHadEnoughBar == false ) { expRate = 0.5; } 
				exp = charGetsExpRate(this.ongoingTime,character,"intelligence",expRate);
				eventMsg += createCharGotExpMessage(character,"intelligence",exp) + "\n";
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
			}
			eventMsg += tutorshipExtraExp(minutes,characters,"intelligence",expRate);
			eventMsg += sharedTrainingRelationshipEvents(characters);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createTrainingActionSpellcasting = function() {
	var action = new mapAction("spellcasting","Spellcasting",createSystemEventSpellcasting,false);
	action.description = "The characters will practice different spells, training their intelligence, consuming willpower.";
	action.tags.push("training","trRank1","intelligence");
	action.recMins = 60;
	action.flexibleTimes = true;
	return action;
}

	// Perception
window.createSystemEventEnergyReading = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"energyReading","Energy Reading",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 1;
			var barCost = 20;
			var barType = "willpower";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				if ( charHadEnoughBar == false ) { expRate = 0.5; } 
				exp = charGetsExpRate(this.ongoingTime,character,"perception",expRate);
				eventMsg += createCharGotExpMessage(character,"perception",exp) + "\n";
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
			}
			eventMsg += tutorshipExtraExp(minutes,characters,"perception",expRate);
			eventMsg += sharedTrainingRelationshipEvents(characters);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createTrainingActionEnergyReading = function() {
	var action = new mapAction("energyReading","Energy Reading",createSystemEventEnergyReading,false);
	action.description = "The characters will train their perception by looking for different magical waves and streams, consuming willpower.";
	action.tags.push("training","trRank1","perception");
	action.recMins = 60;
	action.flexibleTimes = true;
	return action;
}


////////// NPC-MAP-AI CLASS //////////

window.NpcMapAi = function(charKey) {
	this.charKey = charKey;
	this.type = "static";
	this.state = "idle"; // "idle" -> Not participating in any event ; "active" -> Participating in an event
	this.goalsList = []; // List of chosen actions to execute in order.
	this.previousGoals = [];
	
	this.tryNewGoal = function() {
		var flagSuccess = true;
		
		if ( this.goalsList.length > 0 && ( this.charKey != "chPlayerCharacter" ) ) {
			if ( this.goalsList[0] != undefined ) {
				this.previousGoals.push(this.goalsList[0].type);
			}
			if ( this.goalsList[0].isValid() ) {	
				this.goalsList[0].createEvent();
				this.previousGoals.push("Was valid");
				this.goalsList.splice(0,1);
			}
			else {
				flagSuccess = false;
			}
		}
		else {
			flagSuccess = false;
		}
		
		return flagSuccess;
	}
	
	this.signIdle = function() {
		if ( gC(this.charKey).followingTo == "" ) {
			this.state = "idle";
		}
	}
	this.signActive = function() {
		if ( this.type != "static" ) {
			if ( this.charKey == "chPlayerCharacter" ) {
				
			}
			this.state = "active";
		}
	}
	
	
	/////////// PROVISIONAL ///////////
	this.main = function() { // General function for the AI to regulate itself. It must be executed regularly.
		if ( this.type != "static" ) {
			var sisKey = State.variables.compass.findFirstSisIdInvolvingCharacter(this.charKey);
			if ( this.state == "idle" && sisKey == -1 ) {
				if ( State.variables.compass.flagEndedScenario == false ) {
					gC(this.charKey).globalAi.generalEvaluations();
				}
				if ( this.state == "idle" && gC(this.charKey).followingTo == "" ) { // General evaluations may make the character join an ongoing event
					if ( this.tryNewGoal() ) { // Try new mission
					}
					else { // New mission couldn't be executed
						this.goalsList = [];
						if ( this.createNewMission != null ) {	// TO EDIT IN THE FUTURE
							this.getNewGoals();
							
							if ( this.goalsList.length > 0 ) {
								this.tryNewGoal();
							}
							// this.createNewMission(getCurrentMap().key,[charKey])); // Provisional name? Generates a new list of goals
						}
					}
				}
			} else if ( gC(this.charKey).followingTo != "" && State.variables.compass.findFirstEventInvolvingCharacter(this.charKey) == null ) {
				var fT = gC(this.charKey).followingTo;
				var rT = gRelTypeAb(this.charKey,fT);
				if ( rT != null ) {
					if ( isLiberationChallengePossible(this.charKey,fT) ) {
						if ( limitedRandomInt(100) < (6 * modifierLiberationChallengeChance(this.charKey,fT)) ) {
							if ( proportionQuantifiedCharactersStrength(this.charKey,fT) > 0.85 + limitedRandom(0.1) ) {
								initiateLiberationChallenge(this.charKey,fT);
							}
						}
					}
				}
			}
		}
	}
	/////////////////////////////////////
	
	this.getNewGoals = function() {
		var newGoals = 0;
		if ( gC(this.charKey).globalAi.type != "static" ) {
			newGoals = gC(this.charKey).globalAi.getMission();
		}
		else {
			newGoals = this.createNewMission(getCurrentMap().key,[this.charKey]);
		}
		for ( var goal of newGoals ) {
			this.goalsList.push(goal);
		}
	}
	this.createNewMission = null; //function() {
	//}
};

// Constructors, serializers, etc.
NpcMapAi.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
NpcMapAi.prototype.clone = function () {
	return (new NpcMapAi())._init(this);
};
NpcMapAi.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new NpcMapAi())._init($ReviveData$)', ownData);
};

////////// MAP-AI-GOAL CLASS //////////

window.createMapAiGoalMoveTo = function(charKey,goalRoom) {
	var goal = new MapAiGoal(charKey);
	goal.type = "movement";
	goal.goalRoom = goalRoom;
	goal.isValid = function() {		// Checks if the goal may be reached
		return checkMoveTo(State.variables.compass.getCharactersGroup(charKey),gC(charKey).currentRoom,goalRoom);
	}
	goal.createEvent = function() {	// Adds an event to the events pile
		var connection = null;
		var charsGroup = State.variables.compass.getCharactersGroup(this.charKey);
		
		for ( var con of getRoomInfoA(gC(this.charKey).currentRoom).getConnections(charsGroup) ) {
			if ( con.loc == this.goalRoom ) {
				connection = con;
			}
		}
		var sEvent = createSystemEventMovementByConnection(connection,charsGroup);
		eventToPile(sEvent);
	}
	return goal;
}

window.createMapAiGoalAction = function(charKey,goalRoom,goalAction,minutes) {
	var goal = new MapAiGoal(charKey);
	goal.type = "action";
	goal.goalRoom = goalRoom;
	goal.goalAction = goalAction;
	goal.minutes = minutes;
	goal.isValid = function() { // Checks if the goal may be executed
		 return checkMapAction(getCharGroup(charKey),goal.goalRoom,goal.goalAction);
	}
	goal.createEvent = function() { // Adds an event to the events pile
		 var mapAction = null;
		 var charsGroup = getCharGroup(this.charKey);
		 for ( var mapA of getRoomInfoA(this.goalRoom).getActions(charsGroup) ) {
			 if ( this.goalAction == mapA.key ) {
				 mapAction = mapA;
			 }
		 }
		 if ( mapAction != null ) {
			 mapAction.eventToPile(minutes,charsGroup);
		 }
	}
	
	return goal;
}

window.createMapAiGoalTalkTo = function(charKey,targetCharKey) {
	var goal = new MapAiGoal(charKey);
	goal.type = "talkTo";
	goal.targetChar = targetCharKey;
	goal.targetCharGroup = getCharGroup(goal.targetChar);
	
	goal.isValid = function() { // Checks if the goal may be executed
		return checkTalkTo(State.variables.compass.getCharactersGroup(this.charKey),this.targetChar);
	}
	goal.createEvent = function() { // Adds an event to the events pile
		var flagPlayerIsInvolved = false;
		var flagTargetIsInSis = State.variables.compass.isCharacterInSis(this.targetChar);
		
		if ( flagTargetIsInSis ) {				   // Joining already stablished conversation
			var convId = State.variables.compass.getCharacterSisId(this.targetChar);
			for ( var charKey of getCharGroup(this.charKey) ) {
				State.variables.compass.sisList[convId].charJoinsSis(charKey);
			}
			State.variables.compass.sisList[convId].importantMessages +=
				getCharNames(getCharGroup(this.charKey)) + " joined the conversation.\n";
		}
		else {
			var flagSetIdle = true;
			if ( this.targetCharGroup[0] == "chPlayerCharacter" ) { flagPlayerIsInvolved = true; }
			if ( flagPlayerIsInvolved == false ) { // Initiating conversation with NPC
				if ( doesTargetAcceptConversation(this.charKey,this.targetChar)[0] ) { // Ask character to start conversation
					var characters = State.variables.compass.getCharactersGroup(this.charKey).concat(State.variables.compass.getCharactersGroup(this.targetChar));
					State.variables.compass.createNewSis(characters);
					flagSetIdle = false;
				}
				if ( flagSetIdle ) {
					this.state = "idle";
				}
			} else {							   // Initiating conversation with Player
				if ( State.variables.compass.flagPlayerIsPrompted == false ) {
					var playerEvent = State.variables.compass.findFirstEventInvolvingPlayer();
					var flagPlayerIsSub = false;
					if ( gC("chPlayerCharacter").domChar == this.charKey ) {
						flagPlayerIsSub = true;
					}
					var genericDialogue = chooseDialogFromList(setup.dialogDB.csDialogs,this.charKey,"chPlayerCharacter","","");
					var p = genericDialogue + "\n" + gC(this.charKey).getFormattedName() + " wants to talk to you.\n\n";
					if ( playerEvent == null ) {
						p += getButtonAcceptConversation(this.charKey) + "\n";
						if ( flagPlayerIsSub ) {
							p += colorText("Locked: ","red") + "You can't refuse a conversation from a character you're submissive to.";
						} else {
							p += getButtonRejectConversation(this.charKey);
						}
						State.variables.compass.setPlayerPrompt(p,this.charKey,true);
					} else {
						p += getButtonAcceptConversationInterrupted(this.charKey) + "\n";
						if ( flagPlayerIsSub ) {
							p += colorText("Locked: ","red") + "You can't refuse a conversation from a character you're submissive to.";
						} else {
							p += getButtonRejectConversationInterrupted(this.charKey);
						}
						State.variables.compass.interruptPlayer(p,this.charKey,true);
					}
				}
			}
		}
	}
	return goal;
}
window.createMapAiGoalPursueAndTalkTo = function(charKey,targetCharKey) {
	var goal = new MapAiGoal(charKey);
	goal.type = "pursueAndTalkTo";
	goal.targetChar = targetCharKey;
	
	goal.initialDistance = -1;
	goal.walkedDistance = 0;
	
	goal.isValid = function() {
		var flagIsValid = true;
		if ( getCurrentMap().characters.includes(this.targetChar) == false ) {
			flagIsValid = false;
		}
		else if ( ( this.initialDistance != -1 ) && ( this.advancedDistance > this.initialDistance * 2 ) ) {
			flagIsValid = false;
		}
		return flagIsValid;
	}
	goal.createEvent = function() {
		if ( gC(this.charKey).currentRoom == gC(this.targetChar).currentRoom ) { // Target in same room
			if ( checkTalkTo(State.variables.compass.getCharactersGroup(this.charKey),this.targetChar) ) { // Target may be talked to
				createMapAiGoalTalkTo(this.charKey,this.targetChar).createEvent();
				gC(this.charKey).mapAi.signActive();
			}
			else { // Target may not be talked to
				// Abort mission
			}
		}
		else { // Target not in same room
			// Check if initial distance exists
			if ( this.initialDistance == -1 ) {
				var initialRoute = getRouteToCharacter(getCurrentMap().key,getCharGroup(this.charKey),this.targetChar);
				this.initialDistance = initialRoute.length;
			}
			if ( this.walkedDistance < this.initialDistance * 2 ) {
				
				// Create route towards NPC
				var currentRoute = getRouteToCharacter(getCurrentMap().key,getCharGroup(this.charKey),this.targetChar);
				if ( currentRoute.length > 0 ) {
					// Create event to move towards next room
					createMapAiGoalMoveTo(this.charKey,currentRoute[0]).createEvent();
					this.walkedDistance++;
					// Create new goal on this character's mapAi with an extra advanced distance and set initial distance
					var goal = createMapAiGoalPursueAndTalkTo(this.charKey,this.targetChar);
					goal.initialDistance = this.initialDistance;
					goal.walkedDistance = this.walkedDistance;
					if ( gC(this.charKey).mapAi.goalsList == undefined ) {
						gC(this.charKey).mapAi.goalsList = [goal];
					} else {
						gC(this.charKey).mapAi.goalsList.push(goal);
					}
				}
			}
		}
	}
	return goal;
}

window.createMapAiGoalAssault = function(charKey,targetCharKey) {
	var goal = new MapAiGoal(charKey);
	goal.type = "assault";
	goal.targetChar = targetCharKey;
	
	goal.isValid = function() { // Checks if the goal may be executed
		return checkMayAssault(getCharGroup(this.charKey),this.targetChar);
	}
	goal.createEvent = function() { // Adds an event to the events pile
		var flagPlayerIsInvolved = false;
		var flagTargetIsInSis = State.variables.compass.isCharacterInSis(this.targetChar);
		
		var flagSetIdle = true;
		if ( this.targetChar == "chPlayerCharacter" ) { flagPlayerIsInvolved = true; }
		if ( flagPlayerIsInvolved == false ) { // Assaulting another NPC
			initiateNpcAssault(charKey,targetCharKey);
		} else {							   // Assaulting Player
			if ( State.variables.compass.flagPlayerIsPrompted == false ) {
				var playerEvent = State.variables.compass.findFirstEventInvolvingPlayer();
				initiateNpcAssault(charKey,targetCharKey);
				var gD = chooseDialogFromList(setup.dialogDB.icDialogs,charKey,targetCharKey,"","");
				var p = gD + "\n" + gC(charKey).getFormattedName() + " is assaulting you!\n\n";
				p += getButtonBeingAssaulted(charKey);
				if ( playerEvent == null ) {
					State.variables.compass.setPlayerPrompt(p,this.charKey,true);
				} else {
					State.variables.compass.interruptPlayer(p,this.charKey,true);
				}
			}
		}
	}
	return goal;
}
window.createMapAiGoalChallenge = function(charKey,targetCharKey) {
	var goal = new MapAiGoal(charKey);
	goal.type = "challenge";
	goal.targetChar = targetCharKey;
	
	goal.isValid = function() { // Checks if the goal may be executed
		return checkMayChallenge(getCharGroup(this.charKey),this.targetChar);
	}
	goal.createEvent = function() { // Adds an event to the events pile
		var flagPlayerIsInvolved = false;
		var flagTargetIsInSis = State.variables.compass.isCharacterInSis(this.targetChar);
		var stakes = selectNpcChallengeStakes(charKey);
		
		var flagSetIdle = true;
		if ( this.targetChar == "chPlayerCharacter" ) { flagPlayerIsInvolved = true; }
		if ( flagPlayerIsInvolved == false ) { // Assaulting another NPC
			initiateNpcToNpcChallenge(charKey,targetCharKey,stakes);
		} else {							   // Assaulting Player
			if ( State.variables.compass.flagPlayerIsPrompted == false ) {
				var playerEvent = State.variables.compass.findFirstEventInvolvingPlayer();
				var stakesMsg = "";
				var gD = chooseDialogFromList(setup.dialogDB.icDialogs,charKey,targetCharKey,"","");
				switch ( stakes ) {
					case 1:
						stakesMsg = "low stakes";
						break;
					case 2:
						stakesMsg = "medium stakes";
						break;
					case 3:
						stakesMsg = "high stakes";
						break;
				}
				var p = gD + "\n" + gC(charKey).getFormattedName() + " is challenging you for " + stakesMsg + "!\nRefusing the challenge will make you lose merit.\n\n";
				p += getButtonAcceptChallenge(charKey,stakes) + "\n" + getButtonRejectChallenge(charKey,stakes);
				if ( playerEvent == null ) {
					State.variables.compass.setPlayerPrompt(p,this.charKey,true);
				} else {
					State.variables.compass.interruptPlayer(p,this.charKey,true);
				}
			}
		}
	}
	return goal;
}
window.selectNpcChallengeStakes = function(cK) {
	var stakes = 1;
	
	if ( gC(cK).mission == "humilliate" ) { stakes = 1 + limitedRandomInt(1); }
	else if ( gC(cK).mission == "weakenEnemy" || gC(cK).mission == "gainDomination" || gC(cK).mission == "forceSex" ) { stakes = 2 + limitedRandomInt(1); }
	else if ( gC(cK).mission == "gainSubmissive" ) { stakes = 3; }
	else if ( gC(cK).mission == "liberateFriend" ) { stakes = 2; }
	else { stakes = 1 + limitedRandomInt(2); }
	
	return stakes;
}

window.createMapAiGoalPursueAndAssault = function(charKey,targetCharKey) {
	var goal = new MapAiGoal(charKey);
	goal.type = "pursueAndAssault";
	goal.targetChar = targetCharKey;
	
	goal.initialDistance = -1;
	goal.walkedDistance = 0;
	
	goal.isValid = function() {
		var flagIsValid = true;
		if ( getCurrentMap().characters.includes(this.targetChar) == false ) {
			flagIsValid = false;
		}
		else if ( ( this.initialDistance != -1 ) && ( this.advancedDistance > this.initialDistance * 2 ) ) {
			flagIsValid = false;
		}
		return flagIsValid;
	}
	goal.createEvent = function() {
		if ( gC(this.charKey).currentRoom == gC(this.targetChar).currentRoom ) { // Target in same room
			if ( checkMayAssault(getCharGroup(this.charKey),this.targetChar) ) { // Target may be talked to
				createMapAiGoalAssault(this.charKey,this.targetChar).createEvent();
				gC(this.charKey).mapAi.signActive();
			}
			else { // Target may not be talked to
				// Abort mission
			}
		}
		else { // Target not in same room
			// Check if initial distance exists
			if ( this.initialDistance == -1 ) {
				var initialRoute = getRouteToCharacter(getCurrentMap().key,getCharGroup(this.charKey),this.targetChar);
				this.initialDistance = initialRoute.length;
			}
			if ( this.walkedDistance < this.initialDistance * 2 ) {
				
				// Create route towards NPC
				var currentRoute = getRouteToCharacter(getCurrentMap().key,getCharGroup(this.charKey),this.targetChar);
				if ( currentRoute.length > 0 ) {
					// Create event to move towards next room
					createMapAiGoalMoveTo(this.charKey,currentRoute[0]).createEvent();
					this.walkedDistance++;
					// Create new goal on this character's mapAi with an extra advanced distance and set initial distance
					var goal = createMapAiGoalPursueAndAssault(this.charKey,this.targetChar);
					goal.initialDistance = this.initialDistance;
					goal.walkedDistance = this.walkedDistance;
					if ( gC(this.charKey).mapAi.goalsList == undefined ) {
						gC(this.charKey).mapAi.goalsList = [goal];
					} else {
						gC(this.charKey).mapAi.goalsList.push(goal);
					}
				}
			}
		}
	}
	return goal;
}
window.createMapAiGoalPursueAndChallenge = function(charKey,targetCharKey,stakes) {
	var goal = new MapAiGoal(charKey);
	goal.type = "pursueAndChallenge";
	goal.targetChar = targetCharKey;
	
	goal.initialDistance = -1;
	goal.walkedDistance = 0;
	
	goal.isValid = function() {
		var flagIsValid = true;
		if ( getCurrentMap().characters.includes(this.targetChar) == false ) {
			flagIsValid = false;
		}
		else if ( ( this.initialDistance != -1 ) && ( this.advancedDistance > this.initialDistance * 2 ) ) {
			flagIsValid = false;
		}
		return flagIsValid;
	}
	goal.createEvent = function() {		
		if ( gC(this.charKey).currentRoom == gC(this.targetChar).currentRoom ) { // Target in same room
			if ( checkMayChallenge(getCharGroup(this.charKey),this.targetChar) ) { // Target may be talked to
					// ToDo mapAiGoalGallenge
				createMapAiGoalChallenge(this.charKey,this.targetChar).createEvent();
				gC(this.charKey).mapAi.signActive();
			}
			else { // Target may not be challenged
				// Abort mission
			}
		}
		else { // Target not in same room
			// Check if initial distance exists
			if ( this.initialDistance == -1 ) {
				var initialRoute = getRouteToCharacter(getCurrentMap().key,getCharGroup(this.charKey),this.targetChar);
				this.initialDistance = initialRoute.length;
			}
			if ( this.walkedDistance < this.initialDistance * 2 ) {
				// Create route towards NPC
				var currentRoute = getRouteToCharacter(getCurrentMap().key,getCharGroup(this.charKey),this.targetChar);
				if ( currentRoute.length > 0 ) {
					// Create event to move towards next room
					createMapAiGoalMoveTo(this.charKey,currentRoute[0]).createEvent();
					this.walkedDistance++;
					// Create new goal on this character's mapAi with an extra advanced distance and set initial distance
					var goal = createMapAiGoalPursueAndChallenge(this.charKey,this.targetChar);
					goal.initialDistance = this.initialDistance;
					goal.walkedDistance = this.walkedDistance;
					if ( gC(this.charKey).mapAi.goalsList == undefined ) {
						gC(this.charKey).mapAi.goalsList = [goal];
					} else {
						gC(this.charKey).mapAi.goalsList.push(goal);
					}
				}
			}
		}
	}
	return goal;
}

window.MapAiGoal = function(charKey) {
	this.charKey = charKey;
	this.type = "none";
};

// Constructors, serializers, etc.
MapAiGoal.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
MapAiGoal.prototype.clone = function () {
	return (new MapAiGoal())._init(this);
};
MapAiGoal.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new MapAiGoal())._init($ReviveData$)', ownData);
};

////////// GOAL CHECKERS //////////
window.checkMoveTo = function(charGroup,currentRoomKey,goalRoomKey) {
	var cons = getRoomInfoA(currentRoomKey).getConnections(charGroup);
	var validCon = false;
	for ( var con of cons ) {
		if ( goalRoomKey == con.loc ) {
			validCon = true; // Current room has a connection with goal room
		}
	}
	return validCon;
}

window.checkMapAction = function(charGroup,roomKey,mapActionKey) {
	var flagAllowed = false;
	for ( var mapAction of getRoomInfoA(roomKey).getActions(charGroup) ) {
		if ( mapActionKey == mapAction.key ) {
			flagAllowed = true; // Current room allows to initiate goal action
		}
	}
	if ( gC(charGroup[0]).currentRoom != roomKey ) {
		flagAllowed = false;
	}
	
	return flagAllowed;
}

window.checkTalkTo = function(charGroup,targetChar) {
	var flagAllowed = false;
	var flagAllowedInteraction = gC(targetChar).getIsAvailableForSocialInteractions(charGroup[0]); // True if target may join SIS
	var flagSameRoom = false;
	if ( gC(targetChar).currentRoom == gC(charGroup[0]).currentRoom ) {
		flagSameRoom = true;
	}		// True if they're at the same room
	
	var targetEvent = State.variables.compass.findFirstEventInvolvingCharacter(targetChar);
	var flagMayBeInterrupted = true; // True if the character's event may be interrupted or there's no event
	if ( targetEvent != null ) {
		if ( targetEvent.title != "sisRound" ) {
			flagMayBeInterrupted = mayCharBeInterrupted(targetChar);
			// flagMayBeInterrupted = State.variables.compass.findFirstEventInvolvingCharacter(targetChar).flagMayBeInterrupted;
		}
	}
	if ( flagAllowedInteraction && flagSameRoom && flagMayBeInterrupted ) {
		flagAllowed = true;
	}
	return flagAllowed;
}

window.checkMayAssault = function(charGroup,targetChar) {
	var flagAllowed = false;
	var flagAllowedAssault = isAssaultPossible(charGroup[0],targetChar); // True if assault is possible
	var flagSameRoom = ( gC(targetChar).currentRoom == gC(charGroup[0]).currentRoom ); // True if they're at the same room
	
	var targetEvent = State.variables.compass.findFirstEventInvolvingCharacter(targetChar);
	var flagMayBeInterrupted = true; // True if the character's event may be interrupted or there's no event
	if ( targetEvent != null ) {
		flagMayBeInterrupted = State.variables.compass.findFirstEventInvolvingCharacter(targetChar).flagMayBeInterrupted;
	}
	if ( flagAllowedAssault && flagSameRoom && flagMayBeInterrupted ) {
		flagAllowed = true;
	}
	return flagAllowed;
}
window.checkMayChallenge = function(charGroup,targetChar) {
	var flagAllowed = false;
	var flagAllowedChallenge = isChallengePossible(charGroup[0],targetChar); // True if assault is possible
	var flagSameRoom = ( gC(targetChar).currentRoom == gC(charGroup[0]).currentRoom ); // True if they're at the same room
	
	var targetEvent = State.variables.compass.findFirstEventInvolvingCharacter(targetChar);
	var flagMayBeInterrupted = true; // True if the character's event may be interrupted or there's no event
	if ( targetEvent != null ) {
		flagMayBeInterrupted = State.variables.compass.findFirstEventInvolvingCharacter(targetChar).flagMayBeInterrupted;
	}
	if ( flagAllowedChallenge && flagSameRoom && flagMayBeInterrupted ) {
		flagAllowed = true;
	}
	return flagAllowed;
}

////////// MISSIONS //////////

	// Auxiliar

		// Get map's actions
window.getAllActionsOnMap = function(chart,charsGroup) {
	var actions = [];
	var roomActions = null;
	var rooms = chart.getAllRooms();
	
	for ( var room of rooms ) {
		roomActions =  getRoomInfoA(room.key).getActions(charsGroup);
		if ( roomActions.length > 0 ) {
			for ( var action of roomActions ) {
				actions.push(action);
			}
		}
	}
	
	return actions;
}

window.getAllActionsOnMapThat = function(chart,charsGroup,isValid) { // isValid is a function that checks the validity of the action
	var actions = getAllActionsOnMap(chart,charsGroup);
	var validActions = [];
	
	for ( var action of actions ) {
		if ( isValid(action) ) {
			validActions.push(action);
		}
	}
	
	return validActions;
	// Example: getAllActionsOnMapThat
	// (State.variables.mapTrainingGrounds,["chNash"],function(action) { if ( action.tags.includes("charisma") ) { return true; } else { return false; } });
}

		// Get routes
window.getRouteToClosestTrainingActivity = function(mapKey,charsGroup) {
	// Assumes the position of first character in charsGroup
	
	var isValid = function(roomKey) {
		var room = getRoomInMap(mapKey,roomKey);
		var flagValid = false;
		if ( room.tags.includes("training") ) { flagValid = true; }
		return flagValid;
	}
	
	var pathfinder = new Pathfinder(mapKey,charsGroup,gC(charsGroup[0]).currentRoom,isValid);
	var route = pathfinder.getShortestValidRoute();
	return route;
}
window.getRouteToClosestTaggedActivity = function(mapKey,charsGroup,tag) {
	// Assumes the position of first character in charsGroup
	
	var isValid = function(roomKey) {
		//var room = getRoomInMap(mapKey,roomKey);
		var flagValid = false;
		for ( var action of getRoomInfoA(roomKey).getActions(charsGroup) ) {
			if ( action.tags.includes(tag) ) { flagValid = true; }
		}
		return flagValid;
	}
	
	var pathfinder = new Pathfinder(mapKey,charsGroup,gC(charsGroup[0]).currentRoom,isValid);
	var route = pathfinder.getShortestValidRoute();
	
	return route;
}
window.getRouteToClosestAltTaggedActivity = function(mapKey,charsGroup,tagsList) {
	// Assumes the position of first character in charsGroup
	
	var isValid = function(roomKey) {
		//var room = getRoomInMap(mapKey,roomKey);
		var flagValid = false;
		for ( var action of getRoomInfoA(roomKey).getActions(charsGroup) ) {
			for ( var tag of tagsList ) {
				if ( action.tags.includes(tag) ) { flagValid = true; }
			}
		}
		return flagValid;
	}
	
	var pathfinder = new Pathfinder(mapKey,charsGroup,gC(charsGroup[0]).currentRoom,isValid);
	var route = pathfinder.getShortestValidRoute();
	return route;
}
window.getRouteToCharacter = function(mapKey,charsGroup,character) {
	// Assumes the target character is in map
	if ( gC(charsGroup[0]).currentRoom != gC(character).currentRoom ) {
		var roomKey = gC(character).currentRoom;
		var isValid = function(roomKey) {
			return ( roomKey == gC(character).currentRoom );
		}
		var pathfinder = new Pathfinder(mapKey,charsGroup,gC(charsGroup[0]).currentRoom,isValid);
		var route = pathfinder.getShortestValidRoute();
	} else {
		var route = [ gC(character).currentRoom ];
	}
	return route;
}
window.getRouteToRoom = function(mapKey,charsGroup,room) {
	// Assumes the target character is in map
	if ( gC(charsGroup[0]).currentRoom != room ) {
		var isValid = function(roomKey) {
			return ( roomKey == room );
		}
		var pathfinder = new Pathfinder(mapKey,charsGroup,gC(charsGroup[0]).currentRoom,isValid);
		var route = pathfinder.getShortestValidRoute();
	} else {
		var route = [ gC(character).currentRoom ];
	}
	return route;
}

		// Get route commands list
window.createRouteMovementCommands = function(roomsList,charsGroup) {
	var commandsList = [];
	
	if ( roomsList.length == 1 && roomsList[0] == gC(charsGroup[0]).currentRoom ) {
	}
	else {
		for ( var roomKey of roomsList ) {
			commandsList.push(createMapAiGoalMoveTo(charsGroup[0],roomKey));
		}
	}
	
	return commandsList;
}

		// Get actions
window.getLastActionInRoomIf = function(mapKey,roomKey,charsGroup,isValid) {
	var targetAction = null;
	
	var actions = getRoomInfoA(roomKey).getActions(charsGroup);
	
	for ( var action of actions ) {
		if ( isValid(action) ) {
			targetAction = action;
		}
	}
	
	return targetAction;
}
window.getLastTaggedActionInRoom = function(mapKey,roomKey,charsGroup,tag) {
	var isValid = function(action) {
		if ( action.tags.includes(tag) ) {
			return true;
		} else {
			return false;
		}
	}
	
	var targetAction = getLastActionInRoomIf(mapKey,roomKey,charsGroup,isValid);
	
	return targetAction;
}
/*
window.getLastEitherTaggedActionInRoom = function(mapKey,roomKey,charsGroup,tagsList) {
	var isValid = function(action) {
		if ( action.tags.includes(tag) ) {
			return true;
		} else {
			return false;
		}
	}
	var targetAction = getLastActionInRoomIf(mapKey,roomKey,charsGroup,isValid);
	
	return targetAction;
}
*/

	// Mission creators // - These functions return a list of commands to be added to NpcMapAi.goalsList

window.cMissionRandomMovement = function(mapKey,charsGroup) {
	var commandsList = [];
	
	var connections = getRoomInfoA(gC(charsGroup[0].currentRoom)).getConnections();
	
	if ( connections.length > 0 ) {  // Create command to move to random adjacent location
		commandsList.push(createMapAiGoalMoveTo(charsGroup[0],randomFromList(connections).loc));
	}
	
	return commandsList;
}
window.cMissionTrainRandomStat = function(mapKey,charsGroup) {
	// Creates missions to train randomly chosen stats
	var commandsList = [];
	
	var statToTrain = getRandomStat();
	var route = getRouteToClosestTaggedActivity(getCurrentMap().key,charsGroup,statToTrain);
	if ( route.length > 0 ) {
		var targetRoom = route[route.length - 1];
	} else {
		var targetRoom = gC(charsGroup[0]).currentRoom;
	}
	var actionKey = getLastTaggedActionInRoom(getCurrentMap().key,targetRoom,charsGroup,statToTrain).key;
	
	if ( route.length > 0 ) {
		commandsList = commandsList.concat(createRouteMovementCommands(route,charsGroup));
	}
	if ( actionKey != null ) {
		commandsList.push(createMapAiGoalAction(charsGroup[0],targetRoom,actionKey,60));
	}
	
	return commandsList;
}
window.cMissionBalancedRandomTrain = function(mapKey,charsGroup) {
	// Creates missions to train randomly chosen stats, favoring those with the highest affinity
	var commandsList = [];
	
	var charKey = charsGroup[0];
	var possibleStats = getStatNamesArray();
	possibleStats = possibleStats.concat(getThreeKindredCharStats(charKey));
	possibleStats = possibleStats.concat(getThreeKindredCharStats(charKey));
	possibleStats = possibleStats.concat(getThreeKindredCharStats(charKey));
	
	var statToTrain = getRandomStat();
	
	var route = getRouteToClosestTaggedActivity(getCurrentMap().key,charsGroup,statToTrain);
	if ( route.length > 0 ) {
		var targetRoom = route[route.length - 1];
	} else {
		var targetRoom = gC(charsGroup[0]).currentRoom;
	}
	var actionKey = getLastTaggedActionInRoom(getCurrentMap().key,targetRoom,charsGroup,statToTrain).key
	
	if ( route.length > 0 ) {
		commandsList = commandsList.concat(createRouteMovementCommands(route,charsGroup));
	}
	if ( actionKey != null ) {
		commandsList.push(createMapAiGoalAction(charsGroup[0],targetRoom,actionKey,60));
	}
	
	return commandsList;
}

window.cMissionActionTag = function(mapKey,charsGroup,tag) {
	var commandsList = [];
	
	var route = getRouteToClosestTaggedActivity(getCurrentMap().key,charsGroup,tag);
	if ( route.length > 0 ) {
		var targetRoom = route[route.length - 1];
	} else {
		var targetRoom = gC(charsGroup[0]).currentRoom;
	}
	var actionKey = getLastTaggedActionInRoom(getCurrentMap().key,targetRoom,charsGroup,tag).key;
	
	if ( route.length > 0 ) {
		commandsList = commandsList.concat(createRouteMovementCommands(route,charsGroup));
	}
	if ( actionKey != null ) {
		commandsList.push(createMapAiGoalAction(charsGroup[0],targetRoom,actionKey,60));
	}
	
	return commandsList;
}
	
window.cMissionPursueAndTalkTo = function(mapKey,charsGroup,targetChar) {
	return [ createMapAiGoalPursueAndTalkTo(charsGroup[0],targetChar) ];
}

window.cMissionPursueAndAssault = function(charsGroup,targetChar) {
	return [ createMapAiGoalPursueAndAssault(charsGroup[0],targetChar) ];
}

window.cMissionPursueAndChallenge = function(charsGroup,targetChar) {
	return [ createMapAiGoalPursueAndChallenge(charsGroup[0],targetChar) ];
}

////////// PROPOSALS //////////

window.npcProposalFollowMe = function(actor,target) {
	if ( gC(actor).currentRoom == gC(target).currentRoom ) {
		if ( target == "chPlayerCharacter" ) { // Target is player
				if ( State.variables.compass.flagPlayerIsPrompted == false ) {
				var spRel = gRelTypeAb(target,actor);
				var flagForcedToFollow = false;
				if ( spRel != null ) {
					if ( spRel.forcedToFollow ) {
						flagForcedToFollow = true;
					}
				}
				if ( flagForcedToFollow ) {
					var gD = chooseDialogFromList(setup.dialogDB.folMeDialogs,actor,"chPlayerCharacter",true,"");
					var p = gD + "\n" + gC(actor).getFormattedName() + " wants you to follow " + gC(actor).comPr + ". You relationship compels you to accept.\n\n";
					p += getButtonNpcAsksToFollowThemAccept(actor);
					State.variables.compass.setPlayerPrompt(p,actor,true);
				}
				else if ( rFavor("chPlayerCharacter",actor) > 0 ) {
					var gD = chooseDialogFromList(setup.dialogDB.folMeDialogs,actor,"chPlayerCharacter",false,"");
					var p = gD + "\n" + gC(actor).getFormattedName() + " wants you to follow " + gC(actor).comPr + ". You're indebted to " + gC(actor).getFormattedName()
						  + " and refusing this request would be seen as an insult.\n\n";
					p += getButtonNpcAsksToFollowThemAccept(actor) + "\n";
					p += getButtonNpcAsksToFollowThemReject(actor);
					State.variables.compass.setPlayerPrompt(p,actor,true);
				}
				else {
					var gD = chooseDialogFromList(setup.dialogDB.folMeDialogs,actor,"chPlayerCharacter",false,"");
					var p = gD + "\n" + gC(actor).getFormattedName() + " wants you to follow " + gC(actor).comPr + ". This would put " +
							gC(actor).comPr + " in your debt.\n\n";
					p += getButtonNpcAsksToFollowThemAccept(actor) + "\n";
					p += getButtonNpcAsksToFollowThemReject(actor);
					State.variables.compass.setPlayerPrompt(p,actor,true);
				}
			}
		} else { // Target is not player
			aAsksBtoFollowA(actor,target);
		}
	}
}
window.npcProposalFollowYou = function(actor,target) {
	if ( gC(actor).currentRoom == gC(target).currentRoom ) {
		if ( target == "chPlayerCharacter" ) { // Target is player
			if ( State.variables.compass.flagPlayerIsPrompted == false ) {
				var gD = chooseDialogFromList(setup.dialogDB.folPlDialogs,actor,"chPlayerCharacter",false,"");
				var p = gD + "\n" + gC(actor).getFormattedName() + " wants to follow you.\n\n";
				p += getButtonNpcAsksToFollowPlayerAccept(actor) + "\n";
				p += getButtonNpcAsksToFollowPlayerReject(actor);
				State.variables.compass.setPlayerPrompt(p,actor,true);
			}
		} else { // Target is not player
			aAsksBtoFollowB(actor,target);
		}
	}
}
window.npcProposalUnfollowMe = function(actor,target) {
	if ( gC(actor).currentRoom == gC(target).currentRoom ) {
		if ( target == "chPlayerCharacter" ) { // Target is player
			if ( State.variables.compass.flagPlayerIsPrompted == false ) {
				var gD = chooseDialogFromList(setup.dialogDB.unfolMeDialogs,actor,"chPlayerCharacter",false,"");
				var p = gD + "\n" + gC(actor).getFormattedName() + " wants you to stop following " + gC(actor).comPr + ".\n\n";
				p += getButtonNpcAsksToUnfollowThemAccept(actor) + "\n";
				p += getButtonNpcAsksToUnfollowThemReject(actor);
				State.variables.compass.setPlayerPrompt(p,actor,true);
			}
		} else { // Target is not player
			aAsksBtoUnfollowA(actor,target);
		}
	}
}
window.npcProposalUnfollowYou = function(actor,target) {
	if ( gC(actor).currentRoom == gC(target).currentRoom ) {
		if ( target == "chPlayerCharacter" ) { // Target is player
			if ( State.variables.compass.flagPlayerIsPrompted == false ) {
				var gD = chooseDialogFromList(setup.dialogDB.unfolPlDialogs,actor,"chPlayerCharacter",false,"");
				var p = gD + "\n" + gC(actor).getFormattedName() + " wants to stop following you.\n\n";
				p += getButtonNpcAsksToUnfollowPlayerAccept(actor) + "\n";
				p += getButtonNpcAsksToUnfollowPlayerReject(actor);
				State.variables.compass.setPlayerPrompt(p,actor,true);
			}
		} else { // Target is not player
			aAsksBtoUnfollowB(actor,target);
		}
	}
}

	// Character decisions //
window.doesTargetAcceptConversation = function(actor,target) {
	var forcedToAccept = false;
	var result = false;
		var stringResult = "";
	if ( gC(target).domChar == actor ) {
		forcedToAccept = true;
		result = true;
		stringResult = gC(target).getFormattedName() + " is bound to accept.";
	}
	if ( forcedToAccept == false ) {
		// Mood
		var targetDominanceMood = + gC(target).mood.submissive * (1.0) + gC(target).mood.dominant * (-0.2);
		var targetMoodFactor = gC(target).mood.friendly * (0.5) + gC(target).mood.flirty * (0.5) + gC(target).mood.intimate * (0.5)
								 + gC(target).mood.aroused * (0.5) + gC(target).mood.angry * (-1.0) + gC(target).mood.bored * (-0.5);
		if ( targetDominanceMood > 0 ) { targetMoodFactor += targetDominanceMood; }
		
		// Relationship
		var targetDominantRelation = rLvlAbt(target,actor,"submission") * 4.0 + rLvlAbt(target,actor,"domination") * -4.0;
		var relationshipFactor = rLvlAbt(target,actor,"friendship") * 1.0 + rLvlAbt(target,actor,"romance") * 1.5 + rLvlAbt(target,actor,"sexualTension") * 0.5
							 + rLvlAbt(target,actor,"enmity") * -3.0 + rLvlAbt(target,actor,"rivalry") * -1.0;
		if ( targetDominantRelation > 0 ) { relationshipFactor += targetDominantRelation; }
		if ( relationshipFactor < 0 && relationshipFactor > -8 ) {
			relationshipFactor = 0;
		}
		
		// Simulation state
		var simulationState = 0;
		if ( State.variables.simCycPar.templeDayPeriod == "training" && gC(target).type == "candidate" ) {
			simulationState = -20;
		}
		
		var semifinalValue = targetMoodFactor + relationshipFactor + simulationState;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		if ( finalValue >= 0 || State.variables.debugAlwaysAcceptSis ) { result = true; }
		if ( result ) {
			stringResult = "Success!"; 
			gC(target).mission = "";
		}
		else 		  { stringResult = "Failure."; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2)
					  + ", Others: " + simulationState + ", Luck: " + luckFactor.toFixed(2) + " - Result: " + finalValue.toFixed(2);
	}
	return [result,stringResult];	
}

window.doesTargetAcceptChallenge = function(actor,target,stakes) {
	var flagAccepts = false;
	switch ( stakes ) {
		case 1:
			if ( proportionQuantifiedCharactersStrength(target,actor) > 0.80 ) {
				flagAccepts = true;
			}
			break;
		case 2:
			if ( proportionQuantifiedCharactersStrength(target,actor) > 0.85 ) {
				flagAccepts = true;
			}
			break;
		case 3:
			if ( proportionQuantifiedCharactersStrength(target,actor) > 0.90 ) {
				flagAccepts = true;
			}
			break;
	}
	return flagAccepts;
}

// Temporary
window.cMissionCustomCommands = function(mapKey,charsGroup) {
	var commandsList = [];
	
	//commandsList.push(createMapAiGoalMoveTo(charsGroup[0],"eastLibrary"));
	//commandsList.push(createMapAiGoalMoveTo(charsGroup[0],"westLibrary"));
	commandsList.push(createMapAiGoalTalkTo(charsGroup[0],"chVal"));
	
	return commandsList;
}

////////// FURTHER AUXILIAR FUNCTIONS //////////

window.aAsksBtoFollowA = function(charA,charB) {
	// Character A asks character B if B will follow A
	var flagAccepted = false;
	var willPayDebt = false;
	var message = "";
	
	var flagCantUnfollowC = false;
	
	if ( gC(charB).followingTo != "" ) {
		var cRelType = gRelTypeAb(charB,gC(charB).followingTo);
		if ( cRelType != null ) {
			if ( cRelType.forcedToFollow ) {
				flagCantUnfollowC = true;
			}
		}
	}
	if ( flagCantUnfollowC ) { // CharB is forced to keep following CharC
		message = gC(charB).name + " can't stop following " + gC(gC(charB).followingTo).name + ".";
	}
	else {
		if ( gC(charB).relations.hasOwnProperty(charA) ) {
			var relType = gRelTypeAb(charB,charA);
			if ( relType ) {
				if ( relType.forcedToFollow ) { // Special relationship forces to follow
					flagAccepted = true;
					message = gC(charB).name + " accepts your order and will follow you.";
				}
			}
			if ( flagAccepted == false && gC(charB).relations[charA].favor > 0 ) { // Favor
				willPayDebt = true;
				flagAccepted = true;
				message = gC(charB).name + " will follow you to repay favor.";
			}
			if ( flagAccepted == false ) { // Relationships and mood
				var posValues = 1 + rLvlAbt(charB,charA,"submission") * 20 + rLvlAbt(charB,charA,"friendship") * 10 + rLvlAbt(charB,charA,"romance") * 20 + getCharMood(charB,"submissive");
				var negValues = rLvlAbt(charB,charA,"enmity") * 30 + rLvlAbt(charB,charA,"rivalry") * 10 + rLvlAbt(charB,charA,"domination") * 20 + getCharMood(charB,"angry") + getCharMood(charB,"dominant");
				if ( posValues > negValues ) {
					willPayDebt = true;
					flagAccepted = true;
					message = gC(charB).name + " will follow you and consider you in " + gC(charB).posPr + " debt.";
				} else {
					message = gC(charB).name + " doesn't want to follow you.";
				}
			}
		} else { // The characters don't know each other (Should this even be possible?)
			message = gC(charB).name + " barely knows you.";
		}
	}
	
	// Send message if appropriate
	if ( charA == "chPlayerCharacter" ) {
		State.variables.compass.setMapMessage(message);
	}
	// Create following relationship
	if ( flagAccepted ) {
		charLosesFollowers(charB);
		charFollowsChar(charB,charA,willPayDebt);
	}
	
	return flagAccepted;
}
window.aAsksBtoFollowB = function(charA,charB) {
	// Character A asks character B if A may follow B
	var flagAccepted = false;
	var message = "";
	
	// Mood and relationship
	var posValues = 1 + rLvlAbt(charB,charA,"friendship") * 10 + rLvlAbt(charB,charA,"romance") * 20;
	var negValues = rLvlAbt(charB,charA,"enmity") * 30 + rLvlAbt(charB,charA,"rivalry") * 10 + getCharMood(charB,"angry");
	if ( posValues > negValues ) {
		flagAccepted = true;
		message = gC(charB).name + " will allow you to follow " + gC(charB).posPr + " out of your own will.";
	} else {
		message = gC(charB).name + " doesn't want you to follow " + gC(charB).comPr + ".";
	}
	
	// Send message if appropriate
	if ( charA == "chPlayerCharacter" ) {
		State.variables.compass.setMapMessage(message);
	}
	// Create following relationship
	if ( flagAccepted ) {
		charFollowsChar(charA,charB,false);
		if ( charA == "chPlayerCharacter" ) {
			playerJoinsTargetChar(charB);
		}
	}
	
	return flagAccepted;
}
window.aAsksBtoUnfollowA = function(charA,charB) {
	// Character A asks character B if B will stop following A
	var flagAccepted = true;
	var message = "";
	
	// Send message if appropriate
	if ( charA == "chPlayerCharacter" ) {
		message = gC(charB).name + " will stop following you.";
		State.variables.compass.setMapMessage(message);
	}
	// Destroy following relationship
	if ( flagAccepted ) {
		charUnfollowsChar(charB,charA);
	}
	
	return flagAccepted;
}
window.aAsksBtoUnfollowB = function(charA,charB) {
	// Character A asks character B if A may stop following B
	var flagAccepted = true;
	var message = gC(charB).name + " is fine with you no longer following " + gC(charB).comPr + ".";
	
	if ( gRelTypeAb(charA,charB) != null ) {
		if ( gRelTypeAb(charA,charB).forcedToFollow ) {
			flagAccepted = false;
			message = "Your relationship with " + gC(charB).name + " does not allow you to leave.";
		}
	}
	if ( flagAccepted ) {
		if ( ( rFavor(charA,charB) > 0 ) && ( gC(charA).followingForDebt ) ) {
			flagAccepted = false;
			message = gC(charB).name + " does not allow to leave, since you're indebted to " + gC(charB).comPr + ".";
		}
	}
	
	// Send message if appropriate
	if ( charA == "chPlayerCharacter" ) {
		State.variables.compass.setMapMessage(message);
	}
	// Destroy following relationship
	if ( flagAccepted ) {
		charUnfollowsChar(charA,charB);
		if ( charA == "chPlayerCharacter" ) {
			playerLeavesTargetChar(charB);
		//bText	 += "playerLeavesTargetChar('" + targetCharacter + "');\n";
		}
	}
	
	return flagAccepted;
}

window.modifierLiberationChallengeChance = function(sub,dom) {
	var modifier = 1;
	var relMod = (rLvlAbt(sub,dom,"domination") - rLvlAbt(sub,dom,"submission") - rLvlAbt(sub,dom,"friendship") - rLvlAbt(sub,dom,"romance") * 2 + rLvlAbt(sub,dom,"enmity") * 2 + rLvlAbt(sub,dom,"rivalry"));
	var drivesMod = (getCharsDrive(sub,"dAmbition") + getCharsDrive(sub,"dDomination")) * 0.05;
	relMod = isPosNegX1(relMod) * getNumbersLength(relMod*relMod) * 0.1;
	modifier = 1 + relMod + drivesMod;
	if ( modifier < 0.1 ) { modifier = 0.1; }
	return modifier;
}

////////// PATHFINDER CLASS //////////

State.variables.zFlagDbPf = false; // Set to true or false. Flag to debug pathfinder

window.Pathfinder = function(mapKey,charGroup,startingRoomKey,isNodeValidTarget) {
	this.mapKey = mapKey;
	this.charGroup = charGroup; // Group of characters moving
	this.startingNodeKey = startingRoomKey;
	this.isNodeValidTarget = isNodeValidTarget; // Expected to be a function, receiving a node as parameter
	this.nodesList = [];
	
	this.debugInfo = "";
	
	for ( var room in getMapInfo(this.mapKey) ) { // Create an object ("nodesList") that contains a node for each room present in the map	//
		var tRoom = getMapInfo(this.mapKey)[room];
		if ( tRoom instanceof RoomInfo ) {
			this.nodesList[tRoom.key] = new pfNode(tRoom.key);
		}
	}												//																						//
	// Closed, Closing and Open Nodes refer to the nodes' keys, not the node objects
	this.closedNodes = [];
	
	this.closingNodes = [ this.nodesList[startingRoomKey].key ];		// Closing Nodes begins fed with starting node
	this.nodesList[startingRoomKey].hasBeenChecked = true;				// Starting node begins checked
	this.nodesList[startingRoomKey].currentRoute = [ ];					// Starting node has no route
	this.openNodes = [];
	
	this.validNodesList = [];
	if ( this.isNodeValidTarget(startingRoomKey) ) {						// If starting node is a valid target, add to valid nodes
		this.validNodesList.push(startingRoomKey);
	}
	
	
	// Adjacent nodes
	this.getNodesAdjacentToNode = function(nodeKey) {
		var adjacentNodes = [];
		for ( var con of getRoomInfoInMap(this.mapKey,nodeKey).getConnections(this.charGroup) ) {
			adjacentNodes.push(con.loc);
		}
		return adjacentNodes;
	}
	this.getNodesAdjacentToClosingNodes = function() {		// This shouldn't be used, actually
		var adjNodes = [];
		for ( var nodeKey of this.closingNodes ) {
			adjNodes.push(this.getNodesAdjacentToNode(nodeKey));
		}
		return adjNodes;
	}
		
	// Distances and routes between nodes
	this.getDistanceBetweenNodes = function(nodeA,nodeB) {
		var distance = -1;
		for ( var connection of getRoomInfoInMap(this.mapKey,nodeA).getConnections(this.charGroup) ) {
			if ( connection.loc == nodeB ) { // Target room key equal node key
				distance = connection.distance;
			}
		}
		return distance;
	}
	this.isNewDistanceShorter = function(originNode,targetNode) {
		var itsShorter = false;
		var originNodeDistance = this.nodesList[originNode].currentRouteDistance;
		var targetNodeDistance = this.nodesList[targetNode].currentRouteDistance;
		if ( ( originNodeDistance + this.getDistanceBetweenNodes(originNode,targetNode) ) < targetNodeDistance ) {
			itsShorter = true;
		}
		return itsShorter;
	}
	
	// Management
	this.formatNodeRoute = function(nodeKey) {
			// First position is the characters' group position. It gets removed, and the node's key gets added at the end.
		var route = [].concat(this.nodesList[nodeKey].currentRoute);
		route.splice(0,1);
		route.push(nodeKey);
		return route;
	}
	this.getClosestValidNode = function() {
		var closestNode = null;
		var closestDistance = -1;
		for ( var nodeKey of this.validNodesList ) {
			if ( closestDistance == -1 ) {
				closestDistance = this.nodesList[nodeKey].currentRouteDistance;
				closestNode = nodeKey;
			}
			else if ( closestDistance > this.nodesList[nodeKey].currentRouteDistance ) {
				closestDistance = this.nodesList[nodeKey].currentRouteDistance;
				closestNode = nodeKey;
			}
		}
		return closestNode;
	}
	
	// Main function. This is implemented in other called functions
	this.mainFinder = function() {
		// Find all paths
		
		while ( this.closingNodes.length > 0 ) {
			// Get nodes adjacent to Closing Nodes
			for ( var nodeKey of this.closingNodes ) {
				var adjNodes = this.getNodesAdjacentToNode(nodeKey);
				
				// A ) Recalculate routes and distances for adjacent nodes
				for ( var adjNode of adjNodes ) {
					if ( adjNode != this.startingNodeKey ) {
						// If adjNode isn't the starting node && ( has no route || potential new route is shorter )
						if ( this.nodesList[adjNode].currentRoute == null || this.isNewDistanceShorter(nodeKey,adjNode) ) {
							this.nodesList[adjNode].currentRoute = [].concat(this.nodesList[nodeKey].currentRoute);
							this.nodesList[adjNode].currentRoute.push(nodeKey);
							this.nodesList[adjNode].currentRouteDistance = this.getDistanceBetweenNodes(nodeKey,adjNode) + this.nodesList[nodeKey].currentRouteDistance;
						}
					}
					// B ) Check nodes. Check and add to Open Nodes if unchecked
					if ( this.nodesList[adjNode].hasBeenChecked == false ) {
						this.nodesList[adjNode].hasBeenChecked = true;
						this.openNodes.push(adjNode);
					}
				}
				
				this.result = 0;
			}
			
			// C ) Closing Nodes to Closed Nodes, clean Closing Nodes
			this.closedNodes = this.closedNodes.concat(this.closingNodes);
			this.closingNodes = [];
			// D ) Find valid goals on Open Nodes
			for ( var nodeKey of this.openNodes ) {
				if ( this.isNodeValidTarget(nodeKey) ) {
					this.validNodesList.push(nodeKey);
				}
			}
			// E ) Open nodes to Closing Nodes, clean Open Nodes
			this.closingNodes = [].concat(this.openNodes);
			this.openNodes = [];
		}
		if ( State.variables.zFlagDbPf == true && false ) {
			this.debugInfo = this.formatAllNodesInfo();
		}
	}

	// Functions to call. Each pathfinder must be created to call one of these functions, then removed
	this.getAllValidNodes = function() {
		this.mainFinder();
		return this.validNodesList;
	}
	this.getShortestValidRoute = function() {
		var shortestRoute = [];
		this.mainFinder();
		
		var closestNode = this.getClosestValidNode();
		if ( closestNode != null ) {
			shortestRoute = this.formatNodeRoute(closestNode);
		}
		return shortestRoute;
	}
	this.getAllValidRoutes = function() {
		this.mainFinder();
		var routesList = [];
		for ( var validNode of this.validNodesList ) {
			routesList.push(this.formatNodeRoute(validNode));
		}
		return routesList;
	}

	// Debug functions
	this.formatNodeInfoToLine = function(nodeKey) {
		var text = "";
		text += this.nodesList[nodeKey].key + ", was checked: " + this.nodesList[nodeKey].hasBeenChecked + ", route: ["
			  + this.nodesList[nodeKey].currentRoute + "] , distance: " + this.nodesList[nodeKey].currentRouteDistance + ".";
		return text;
	}
	this.formatAllNodesInfo = function() {
		var text = "";
		for ( var node in this.nodesList ) {
			if ( this.nodesList[node] instanceof pfNode ) {
				text += this.formatNodeInfoToLine(this.nodesList[node].key) + "  |\n";
			}
		}
		return text;
	}
}

////////// NODE CLASS //////////

window.pfNode = function(roomKey) {
	this.key = roomKey;
	this.hasBeenChecked = false;
	this.currentRoute = null;
	this.currentRouteDistance = 0;
}

////////// SCENARIO FUNCTIONS //////////
// These functions initialize map with the appropiate characters and assigns correct AIs to them.

// OBSOLETE //
window.initStandardTrainingGrounds = function() {
	State.variables.compass.initializeMap("mapTrainingGrounds","westLibrary");
	var chars = getActiveSimulationCharactersArray();
	State.variables.mapTrainingGrounds.placeCharacters(chars,"westLibrary");
	
	for ( var charKey of chars ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).mapAi.type = "balancedTraining";
			gC(charKey).mapAi.createNewMission = cMissionBalancedRandomTrain;
		}
	}
}
//          //

	// Passion Temple
window.initTrainingPeriodPassionTemple = function() {
	
	// Place Candidates on map
	State.variables.compass.initializeMap("mapTrainingGrounds","grandHall");
	var chars = getRandomizedActiveSimulationCharactersArray();
	State.variables.mapTrainingGrounds.placeCharacters(chars,"grandHall");
	
	// Stablish period type
	State.variables.simCycPar.templeDayPeriod = "training";
	
	// Assign AIs
	for ( var charKey of chars ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).globalAi = createCandidateGlobalAi(charKey);
			gC(charKey).mapAi.type = "balancedTraining";
			gC(charKey).mapAi.createNewMission = cMissionBalancedRandomTrain;
			gC(charKey).mapAi.state = "idle";
			gC(charKey).mapAi.goalsList = [];
		}
	}
	
	State.variables.compass.allCharsCheckMapAi();
	
	// Set period variables
	State.variables.simCycPar.trainingResultsBase = 3.0; // Training has enhanced effectiveness
	
	// Stablish period duration
	var periodMins = State.variables.simCycPar.templeTrainingHours * 60;
	State.variables.compass.ongoingEvents.push(createTrainingEndEvent(periodMins));
	State.variables.compass.periodEndsTip = getRelativeTimeString(periodMins);
	
	State.variables.compass.sortOnGoingEventsByTime();
}

window.initSocializationPeriodPassionTemple = function() {
	
	// Place Candidates on map
	State.variables.compass.initializeMap("mapTrainingGrounds","grandHall");
	var chars = getRandomizedActiveSimulationCharactersArray();
	State.variables.mapTrainingGrounds.placeCharacters(chars,"grandHall");
	
	// Stablish period type
	State.variables.simCycPar.templeDayPeriod = "socialization";
	
	// Assign AIs
	for ( var charKey of chars ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).globalAi = createCandidateGlobalAi(charKey);
			gC(charKey).mapAi.type = "balancedTraining";
			gC(charKey).mapAi.createNewMission = cMissionBalancedRandomTrain;
			gC(charKey).mapAi.state = "idle";
			gC(charKey).mapAi.goalsList = [];
		}
	}
	
	State.variables.compass.allCharsCheckMapAi();
	
	// Set period variables
	State.variables.simCycPar.trainingResultsBase = 1.0; // Training has usual effectiveness
	
	// Stablish period duration
	var periodMins = State.variables.simCycPar.templeSocializationHours * 60;
	State.variables.compass.ongoingEvents.push(createSocializationEndEvent(periodMins));
	State.variables.compass.periodEndsTip = getRelativeTimeString(periodMins);
	
	State.variables.compass.sortOnGoingEventsByTime();
}

window.initTrainingPeriodPassionTempleTests = function() {
	
	// Place Candidates on map
	State.variables.compass.initializeMap("mapTrainingGrounds","westLibrary");
	var chars = ["chPlayerCharacter","chNash","chVal"];
	State.variables.mapTrainingGrounds.placeCharacters(chars,"westLibrary");
	
	// Stablish period type
	State.variables.simCycPar.templeDayPeriod = "training";
	
	// Extra
	State.variables.chVal.willpower.current = 20;
	State.variables.chNash.willpower.current = 20;
	State.variables.chNash.energy.current = 20;
	State.variables.chNash.socialdrive.current = 20;
	
	State.variables.compass.moveCharsToRoom(["chVal"],"publicBaths");
	
	// Assign AIs
	for ( var charKey of chars ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).mapAi.type = "balancedTraining";
			gC(charKey).mapAi.createNewMission = cMissionBalancedRandomTrain;
			gC(charKey).mapAi.state = "idle";
			gC(charKey).mapAi.goalsList = [];
		}
	}
	
	State.variables.compass.allCharsCheckMapAi();
	
	// Set period variables
	State.variables.simCycPar.trainingResultsBase = 3.0; // Training is 3 times as effective
	
	// Stablish period duration
	var periodMins = State.variables.simCycPar.templeTrainingHours * 60;
	State.variables.compass.ongoingEvents.push(createTrainingEndEvent(periodMins));
	State.variables.compass.periodEndsTip = getRelativeTimeString(periodMins);
	
	State.variables.compass.sortOnGoingEventsByTime();
}

	// Gleaming Caverns
window.initAdventurePeriodGleamingCaverns = function() {
	// Initial settings
	State.variables.settings.followingAllowed = false;
	State.variables.settings.relationshipTypesAllowed = false;
	State.variables.settings.challengingAllowed = false;
	State.variables.settings.assaultingAllowed = false;
	State.variables.settings.talkingAllowed = false;
	
	// Place Characters on map
	State.variables.compass.initializeMap("mapGleamingCaverns","templeStorage");
	State.variables.mapGleamingCaverns.placeCharacters(["chHope","chRock","chArt"],"hiddenCamp");
	State.variables.mapGleamingCaverns.placeCharacters(["chNer"],"templeShrine");
	State.variables.mapGleamingCaverns.placeCharacters(["chMes"],"hiddenHut");	
	State.variables.mapGleamingCaverns.placeCharacters(["chVal"],"pondIllumination");	
	State.variables.mapGleamingCaverns.placeCharacters(["chSil"],"templeSanctum");	
	State.variables.mapGleamingCaverns.placeCharacters(["chPlayerCharacter","chNash","chMir","chClaw","chAte"],"templeStorage");
	setSubareaCaverns();
	
	// Stablish period type
	State.variables.simCycPar.templeDayPeriod = "adventure";
	
	// Assign AIs
	for ( var charKey of ["chNash","chClaw","chMir","chAte","chVal"] ) {
		gC(charKey).globalAi = createCandidateGcAi(charKey);
		gC(charKey).mapAi.createNewMission = cMissionBalancedRandomTrain;
		gC(charKey).mapAi.type = "gcCandidate";
		gC(charKey).mapAi.state = "idle";
		gC(charKey).mapAi.goalsList = [];
	}
	gC("chVal").globalAi = createValGcAi("chVal");
	for ( var charKey of ["chArt","chHope","chRock","chNer","chSil","chMes"] ) {
		gC(charKey).globalAi = createCandidateGcAi(charKey);
		gC(charKey).mapAi.type = "static";
		gC(charKey).mapAi.goalsList = [];
	}
	
	State.variables.compass.allCharsCheckMapAi();
	
	// Set period variables
	State.variables.simCycPar.trainingResultsBase = 1.0; // Training has enhanced effectiveness
	
	// Stablish period duration
	var periodMins = 14 * 60;
	State.variables.compass.ongoingEvents.push(createAdventureEndEvent(periodMins));
	State.variables.compass.periodEndsTip = getRelativeTimeString(periodMins);
	
	State.variables.compass.sortOnGoingEventsByTime();
}

	// Tests
window.initCommandTestsPeriodPassionTemple = function() {
	
	// Place Candidates on map
	State.variables.compass.initializeMap("mapTrainingGrounds","grandHall");
	var chars = ["chPlayerCharacter","chNash","chVal","chMir"];
	State.variables.mapTrainingGrounds.placeCharacters(["chMir","chPlayerCharacter","chVal","chNash"],"grandHall");
	//State.variables.mapTrainingGrounds.placeCharacters(["chMir","chPlayerCharacter"],"mirRoom");
	
	// Stablish period type
	State.variables.simCycPar.templeDayPeriod = "socialization";
	
	// Assign AIs
	for ( var charKey of chars ) {
		if ( charKey != "chPlayerCharacter" /*&& charKey != "chVal"*/ ) {
			gC(charKey).mapAi.type = "balancedTraining";
			gC(charKey).mapAi.createNewMission = cMissionBalancedRandomTrain;
			gC(charKey).mapAi.state = "idle";
			gC(charKey).mapAi.goalsList = [];
		}
	}
/*
	createRelTypeTutorshipSub("chPlayerCharacter","chMir",3);
	createRelTypeTutorshipDom("chMir","chPlayerCharacter",3);
	*/
	//State.variables.chVal.infamy = 15;
	//State.variables.chMir.infamy = 15;
/*	
	gC("chMir").mapAi.state = "idle";
	gC("chMir").mapAi.type = "balancedTraining";
	gC("chMir").mapAi.createNewMission = cMissionPursueAndTalkTo("chMir","chPlayerCharacter");
	
	gC("chVal").mapAi.state = "idle";
	gC("chVal").mapAi.type = "balancedTraining";
	gC("chVal").mapAi.goalsList = [ createMapAiGoalMoveTo("chVal","mainLibrary") , createMapAiGoalMoveTo("chVal","westLibrary") , createMapAiGoalPursueAndChallenge("chVal","chMir",1) ];
	
	gC("chNash").mapAi.state = "idle";
	gC("chNash").mapAi.type = "balancedTraining";
	gC("chNash").mapAi.goalsList = [ createMapAiGoalMoveTo("chNash","mainLibrary") , createMapAiGoalMoveTo("chVal","westLibrary") , createMapAiGoalPursueAndTalkTo("chNash","chMir",1) ];
*/
	
	gC("chNash").lust.current = 5;
	gC("chNash").mapAi.state = "idle";
	gC("chNash").mapAi.type = "balancedTraining";
	// gC("chNash").mapAi.createNewMission = cMissionPursueAndTalkTo("chNash","chMir");
	//gC("chNash").mapAi.goalsList = [ cMissionPursueAndTalkTo("chNash","chMir",1) ];
	
	gC("chMir").mapAi.goalsList = [ createMapAiGoalMoveTo("chMir","mainLibrary") , createMapAiGoalMoveTo("chMir","westLibrary") ];
	gC("chVal").mapAi.goalsList = [ createMapAiGoalMoveTo("chVal","mainLibrary") , createMapAiGoalMoveTo("chVal","westLibrary") , createMapAiGoalPursueAndAssault("chVal","chMir") ];
	// gC("chVal").mapAi.goalsList = [ createMapAiGoalMoveTo("chVal","mainLibrary") , createMapAiGoalMoveTo("chVal","westLibrary") , createMapAiGoalPursueAndChallenge("chVal","chMir") ];
	gC("chNash").mapAi.goalsList = [ createMapAiGoalMoveTo("chNash","mainLibrary") , createMapAiGoalMoveTo("chNash","eastLibrary") ,
									 createMapAiGoalMoveTo("chNash","westLibrary") , createMapAiGoalMoveTo("chNash","eastLibrary") ];
	
	//charFollowsChar("chPlayerCharacter","chMir",false);
	
	/*
	gC("chVal").mapAi.type = "balancedTraining";
	gC("chVal").mapAi.createNewMission = cMissionPursueAndAssault;
	gC("chVal").mapAi.state = "idle";
	gC("chVal").mapAi.goalsList = [ createMapAiGoalPursueAndAssault("chVal","chMir") ];
	State.variables.chVal.lust.current = 100;
	State.variables.chPlayerCharacter.lust.current = 1;
	*/
	//getRelation("chPlayerCharacter","chVal").favor = 5;
	//npcProposalFollowMe("chVal","chPlayerCharacter");
		
	// State.variables.compass.allCharsCheckMapAi();
	
	// Set period variables
	State.variables.simCycPar.trainingResultsBase = 1.0; // Training has usual effectiveness
	
	// Stablish period duration
	var periodMins = State.variables.simCycPar.templeSocializationHours * 60;
	State.variables.compass.ongoingEvents.push(createSocializationEndEvent(periodMins));
	State.variables.compass.periodEndsTip = getRelativeTimeString(periodMins);
	
	State.variables.compass.sortOnGoingEventsByTime();
	
	
	State.variables.chVal.relations.chPlayerCharacter.sexualTension.level = 100;
	State.variables.chNash.relations.chPlayerCharacter.romance.level = 20;
	
	gC("chNash").mood["dominant"] = 80;
	gC("chNash").mood["aroused"] = 80;
	gC("chNash").mood["flirty"] = 80;
	
	createRelTypeCompanionship("chPlayerCharacter","chMir");
	createRelTypeCompanionship("chMir","chPlayerCharacter");
}


window.initFakePeriodPassionTemple = function() {
	// Fake training period
//		State.variables.logL1.push("startTraining");
	// Place Candidates on map
	State.variables.compass.initializeMap("mapTrainingGrounds","westLibrary");
	var chars = getActiveSimulationCharactersArray();
	State.variables.mapTrainingGrounds.placeCharacters(["chNash","chMir","chAte","chClaw","chVal"],"westLibrary");
	
	// Stablish period type
	State.variables.simCycPar.templeDayPeriod = "training";
	
	// Assign AIs
	for ( var charKey of chars ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).mapAi.type = "balancedTraining";
			gC(charKey).mapAi.createNewMission = cMissionBalancedRandomTrain;
			gC(charKey).mapAi.state = "idle";
			gC(charKey).mapAi.goalsList = [];
		}
	}
	
//		State.variables.logL1.push("firstCheckingAi");
	State.variables.compass.allCharsCheckMapAi();
	
	// Set period variables
	State.variables.simCycPar.trainingResultsBase = 3.0; // Training has enhanced effectiveness
	
	// Stablish period duration
	var periodMins = State.variables.simCycPar.templeTrainingHours * 60;
	State.variables.compass.ongoingEvents.push(createFakePeriodEndEvent(periodMins));
	State.variables.compass.periodEndsTip = getRelativeTimeString(periodMins);
	
//		State.variables.logL1.push("startingEvents");
	State.variables.compass.sortOnGoingEventsByTime();
	State.variables.compass.timeToAdvance = periodMins;
	State.variables.compass.pushAllTimeToAdvance();
//		State.variables.logL1.push("finishedEvents");
	// Fake socialization period
//		State.variables.logL1.push("startingSocialization");
	// Place Candidates on map
	State.variables.compass.initializeMap("mapTrainingGrounds","westLibrary");
	var chars = getActiveSimulationCharactersArray();
	State.variables.mapTrainingGrounds.placeCharacters(["chNash","chMir","chAte","chClaw","chVal"],"westLibrary");
	
	// Stablish period type
	State.variables.simCycPar.templeDayPeriod = "socialization";
	
	// Assign AIs
	for ( var charKey of chars ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).mapAi.type = "balancedTraining";
			gC(charKey).mapAi.createNewMission = cMissionBalancedRandomTrain;
			gC(charKey).mapAi.state = "idle";
			gC(charKey).mapAi.goalsList = [];
		}
	}
	
//		State.variables.logL1.push("checkingAi");
	State.variables.compass.allCharsCheckMapAi();
	
	// Set period variables
	State.variables.simCycPar.trainingResultsBase = 1.0; // Training has enhanced effectiveness
	
	// Stablish period duration
	var periodMins = State.variables.simCycPar.templeTrainingHours * 60;
	State.variables.compass.ongoingEvents.push(createFakePeriodEndEvent(periodMins));
	State.variables.compass.periodEndsTip = getRelativeTimeString(periodMins);
	
//		State.variables.logL1.push("startingEvents");
	State.variables.compass.sortOnGoingEventsByTime();
	State.variables.compass.timeToAdvance = periodMins;
	State.variables.compass.pushAllTimeToAdvance();
//		State.variables.logL1.push("finishingEvents");
	
		spawnMerchants();
		npcsBuyItems();
		npcsEquipBondage();
//		State.variables.logL1.push("endDayEffects");
	State.variables.personalRoom.endDayEffects();
	State.variables.personalRoom.endDayRelationMoodEffects();
}
window.initFakePeriodPassionTempleXtimes = function(times) {
	gC("chClaw").addBodypart("dick","dick");
	gC("chAte").addBodypart("dick","dick");
	gC("chVal").addBodypart("dick","dick");
	gC("chClaw").baseMood.angry = 0;
	gC("chAte").baseMood.bored = 0;
	State.variables.enabledMerchants = [0,30];
	try {
	var i = 0;
	while ( i < times ) {
		//State.variables.logL1 = [];
		i++;
//		State.variables.logL1.push("fakePeriod");
//		State.variables.logL1.push(getActiveSimulationCharactersArray().length);
		initFakePeriodPassionTemple();
//		State.variables.logL1.push("perRoom");
//		State.variables.logL1.push(getActiveSimulationCharactersArray().length);
		State.variables.personalRoom.initPersonalRoom();
//		State.variables.logL1.push(getActiveSimulationCharactersArray().length);
		
//		State.variables.logL1.push("socPri");
//		State.variables.logL1.push(getActiveSimulationCharactersArray().length);
		// AI social priorities
		for ( var character of arrayMinusA(getActiveSimulationCharactersArray(),"chPlayerCharacter") ) {
			setSocialAiCandidateGoals(gC(character).socialAi);
		}
//		State.variables.logL1.push(getActiveSimulationCharactersArray().length);
		
//		State.variables.logL1.push("finishedDay");
//		State.variables.logL1.push(getActiveSimulationCharactersArray().length);
	}
	} catch(e) {
		State.variables.logL2.errorLog = e.message;
	}
	/*
	// Logging
	var statsData = "";
	var drivesData = "";
	var meritData = "";
	var statsTotal = 0;
	for ( var cd of getActiveSimulationCharactersArray() ) {
		if ( cd != "chPlayerCharacter" ) {
			statsData += cd + ": ";
			statsTotal = 0;
			drivesData += cd + ": ";
			meritData += cd + ": " + gC(cd).merit + " - - - ";
			for ( var st of getStatNamesArray() ) {
				statsData += gC(cd)[st].value + ",";
				statsTotal += gC(cd)[st].value;
			}
			statsData += " Total: " + statsTotal + "  ";
			for ( var dr of ["dImprovement","dPleasure","dLove","dCooperation","dDomination","dAmbition"] ) {
				drivesData += gC(cd)[dr].value.toFixed(0) + "," + gC(cd)[dr].level + " ; ";
			}
			statsData += " - - - ";
			drivesData += " - - - ";
		}
	}
	*/
}


window.testGleamingCaverns = function() {
	deinitMapTrainingGrounds();
	initMapGleamingCaverns();
	// Place characters on map
	State.variables.compass.initializeMap("mapGleamingCaverns","cavernMP2");
	var chars = ["chPlayerCharacter"]
	State.variables.mapGleamingCaverns.placeCharacters(chars,"cavernMP2");
	
	// Assign AIs
	for ( var charKey of chars ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).mapAi.type = "balancedTraining";
			gC(charKey).mapAi.createNewMission = cMissionBalancedRandomTrain;
			gC(charKey).mapAi.state = "idle";
			gC(charKey).mapAi.goalsList = [];
		}
	}
	
	State.variables.compass.allCharsCheckMapAi();
	
	// Stablish period duration
	var periodMins = 60 * 14;
	State.variables.compass.ongoingEvents.push(createTestMapEndEvent(periodMins));
	State.variables.compass.periodEndsTip = getRelativeTimeString(periodMins);
	
	State.variables.compass.sortOnGoingEventsByTime();
	setSubareaCaverns();
}


////////// JOBS ASSIGNER //////////
// Regulates jobs choice screen and jobs' logic

window.JobsAssigner = function() {
	this.candidatesInfo = []; // List of arrays with 2 elements. First element is character's key. Second element is job's title.
	this.possibleJobs = [];
	this.passageText = "";
	
	this.flagPlayerIsChoosing = false;
	
	this.initialWorkHours = 5;
	this.remainingWorkHours = 5;
	
	this.lastWorkInfo = "";
	
};

// Methods

	// Management
JobsAssigner.prototype.createInitialJobs = function() {
		this.possibleJobs.push(createRepairsJob(),createCleaningJob(),createTendCropsJob(),createBookResearchJob(),createOutdoorsCleaningJob(),
							   createAnalyzeFloraJob(),createDramaWritingJob(),createDramaCatalogueJob(),createSalfisGatheringJob());
	}
	
JobsAssigner.prototype.cleanWorkloads = function() {
		for ( var job of this.possibleJobs ) {
			job.availableWorkloads = 0;
			job.characters = [];
		}
	}
JobsAssigner.prototype.cleanWorkHours = function() {
		this.initialWorkHours = State.variables.simCycPar.templeWorkHours;
		this.remainingWorkHours = this.initialWorkHours;
	}
	
JobsAssigner.prototype.createRandomWorkloads = function(workloads) {
		var i = 0;
		while ( i < workloads ) {
			this.possibleJobs[limitedRandomInt(this.possibleJobs.length - 1)].availableWorkloads++;
			i++;
		}
	}
	
JobsAssigner.prototype.sortCandidates = function() { // Randomly decides the order in which Candidates will pick their jobs, and adds them to candidatesInfo
		this.candidatesInfo = [];
		var sortedCandidates = getRandomizedActiveSimulationCharactersArray();
		for ( var candidate of sortedCandidates ) {
			this.candidatesInfo.push([candidate,""]);
		}
	}
JobsAssigner.prototype.sortCandidatesPCfirst = function() {
		this.candidatesInfo = [["chPlayerCharacter",""]];
		var sortedCandidates = shuffleArray("chNash","chVal","chClaw","chMir","chAte");
		for ( var candidate of sortedCandidates ) {
			this.candidatesInfo.push([candidate,""]);
		}
	}
JobsAssigner.prototype.sortCandidatesPClast = function() {
		this.candidatesInfo = [];
		var sortedCandidates = shuffleArray("chNash","chVal","chClaw","chMir","chAte");
		for ( var candidate of sortedCandidates ) {
			this.candidatesInfo.push([candidate,""]);
		}
		this.candidatesInfo.push(["chPlayerCharacter",""]);
	}
	
JobsAssigner.prototype.getAvailableJobsKeys = function() {
		var jobKeys = [];
		for ( var job of this.possibleJobs ) {
			if ( (job.availableWorkloads - job.takenWorkloads) > 0 ) {
				var i = 0;
				while ( i < (job.availableWorkloads - job.takenWorkloads) ) {
					jobKeys.push(job.key);
					i++;
				}
			}
		}
		return jobKeys;
	}
	
JobsAssigner.prototype.candidatesChooseJobs = function(candidatesKeys) { // Calls the AI function for each of these candidates to choose their jobs, and assigns them
		for ( var candidate of candidatesKeys ) {
			var jobKey = this.candidateChoosesJobRandom(candidate);
			this.assignJobToChar(candidate,jobKey);
		}
	}
	
	// UI
		// Jobs assignation
JobsAssigner.prototype.jobsInfoToPassageText = function() {
		for ( var job of this.possibleJobs ) {
			this.passageText += getJobDisplayText(job) + "\n";
		}
	}
JobsAssigner.prototype.availableJobsInfoToPassageText = function() {
		for ( var job of this.possibleJobs ) {
			if ( job.availableWorkloads > 0 ) {
				this.passageText += getJobDisplayText(job) + "\n";
			}
		}
	}
	
JobsAssigner.prototype.getCandidatesInfoPassageText = function() {
		var text = "";
		for ( var candidate of this.candidatesInfo ) {
			text += gC(candidate[0]).formattedName;
			if ( candidate[1] != "" ) {
				text += ": " + candidate[1];
			}
			text += "\n";
		}
		return text;
	}
	
JobsAssigner.prototype.formatStartingPassageText = function() {
		this.passageText += "__Candidates' order__:\n";
		this.passageText += this.getCandidatesInfoPassageText();
		this.passageText += "\nThese are today's available jobs:";
		this.passageText += "\n\n";
		this.availableJobsInfoToPassageText();
	}
JobsAssigner.prototype.passageTextToInitialState = function() {
		// this.passageText = this.getAdvanceToPlayerChoiceStateButton() + "\n\n";
		this.formatStartingPassageText();
	}
JobsAssigner.prototype.formatFinalJobAssignationPassageText = function() {
		this.passageText = "" + this.getAdvanceToModeChoiceButton() + "\n\n";
		this.passageText += "__Candidates' order__:\n";
		this.passageText += this.getCandidatesInfoPassageText();
		this.passageText += "\nThese are today's available jobs:";
		this.passageText += "\n\n";
		this.availableJobsInfoToPassageText();
	}
JobsAssigner.prototype.formatManualModePassageText = function() {
		this.passageText = "__Remaining working hours__: " + this.remainingWorkHours;
		
		var i = 0;
		while ( this.candidatesInfo[i][0] != "chPlayerCharacter" ) { i++; }
		var l = 0;
		while ( this.possibleJobs[l].title != this.candidatesInfo[i][1] ) { l++; }
		
		if ( this.remainingWorkHours > 0 ) {
			var i = 2;
			this.passageText += "\n\nCurrently working at: - __" + this.possibleJobs[l].title + "__\n" + this.possibleJobs[l].description;
			this.passageText += "\n\n__Choose effort__:\n";
			this.passageText += this.getLowEffortButton("Low",1);
			while ( i <= this.remainingWorkHours ) {
				this.passageText += " " + this.getLowEffortButton("x" + i,i);
				i++;
			}
			i = 2;
			this.passageText += "\n" + this.getMediumEffortButton("Medium",1);
			while ( i <= this.remainingWorkHours ) {
				this.passageText += " " + this.getMediumEffortButton("x" + i,i);
				i++;
			}
			i = 2;
			this.passageText += "\n" + this.getHighEffortButton("High",1);
			while ( i <= this.remainingWorkHours ) {
				this.passageText += " " + this.getHighEffortButton("x" + i,i);
				i++;
			}
		}
		
		if ( this.lastWorkInfo != "" ) {
			this.passageText += "\n\n" + this.lastWorkInfo;
			this.lastWorkInfo = "";
		}
		
		if ( this.remainingWorkHours <= 0 ) {
			this.passageText += "\n" + this.getFinishWorkButton();
		}
	}
JobsAssigner.prototype.formatAutoModePassageText = function() {
		this.passageText = "Work complete.\n\n";
		this.passageText += this.lastWorkInfo;
		this.passageText += this.getFinishWorkButton();
	}
	
		// Actual jobs
JobsAssigner.prototype.passageTextToPlayerChoosesMode = function() {
		this.passageText = "Choose the work mode:\n\n";
		this.passageText += this.getManualModeButton() + ": you will be asked how much effort you wish to use each round.\n";
		this.passageText += this.getAutoModeButton() + ": the amount of effort you put will be automatically decided.\n";
	}
	
	// AI
JobsAssigner.prototype.candidateChoosesJobRandom = function(charKey) { // Returns key of chosen job
		var avJobKeys = shuffleArray(this.getAvailableJobsKeys());
		return avJobKeys[0];
	}
	
JobsAssigner.prototype.candidateChoosesEffort = function(charKey,job) {
		var effort = 1; // Low
		if ( job.tier == 1 ) {
			if ( gC(charKey)[job.bar].current >= 80 ) {
				effort = 2;
			}
		}
		return effort;
	}
	
	// Logic
JobsAssigner.prototype.assignJobToChar = function(charKey,jobKey) {
		var jobI = 0; // Job Index
		var charI = 0; // Character Index
		while ( this.possibleJobs[jobI].key != jobKey ) {
			jobI++;
		}
		while ( this.candidatesInfo[charI][0] != charKey ) {
			charI++;
		}
		
		this.possibleJobs[jobI].characters.push(charKey);
		this.possibleJobs[jobI].takenWorkloads++;
		this.candidatesInfo[charI][1] = this.possibleJobs[jobI].title;
	}	
JobsAssigner.prototype.charactersBeforePCchooseJobs = function() {
		var charI = 0; // Char Index
		while ( this.candidatesInfo[charI][0] != "chPlayerCharacter" ) {
			this.candidatesChooseJobs([this.candidatesInfo[charI][0]]);
			charI++;
		}
	}	
JobsAssigner.prototype.charactersAfterPCchooseJobs = function() {
		var charI = 0; // Char Index
		while ( this.candidatesInfo[charI][0] != "chPlayerCharacter" ) {
			charI++;
		}
		charI++;
		while ( charI /*this.candidatesInfo[charI][0]*/ < 6 ) {
			this.candidatesChooseJobs([this.candidatesInfo[charI][0]]);
			charI++;
		}
	}
	
JobsAssigner.prototype.playerWorksOneHour = function(effort) {
		var i = 0;
		while ( this.candidatesInfo[i][0] != "chPlayerCharacter" ) { i++; }
		var l = 0;
		while ( this.possibleJobs[l].title != this.candidatesInfo[i][1] ) { l++; }
		
		if ( this.lastWorkInfo != "" ) { this.lastWorkInfo += "\n"; }
		this.lastWorkInfo += this.possibleJobs[l].effect("chPlayerCharacter",effort);
		
		this.minusOneRemainingHour();
	}
JobsAssigner.prototype.playerAutoWorks = function() {
		var i = 0;
		while ( this.candidatesInfo[i][0] != "chPlayerCharacter" ) { i++; }
		var l = 0;
		while ( this.possibleJobs[l].title != this.candidatesInfo[i][1] ) { l++; }
		
		var effort = this.candidateChoosesEffort("chPlayerCharacter",this.possibleJobs[l]);
		var i = 0;
		this.lastWorkInfo = "";
		while ( i < this.initialWorkHours ) {
			this.lastWorkInfo += this.possibleJobs[l].effect("chPlayerCharacter",effort) + "\n";
			this.minusOneRemainingHour();
			i++;
		}
	}
JobsAssigner.prototype.npcCandidatesWork = function() {
		for ( var job of this.possibleJobs ) {
			for ( var character of job.characters ) {
					if ( character != "chPlayerCharacter" ) {
					var i = 0;
					var effort = this.candidateChoosesEffort(character,job);
					while ( i < this.initialWorkHours ) {
						job.effect(character,effort);
						i++;
					}
				}
			}
		}
	}
	
JobsAssigner.prototype.minusOneRemainingHour = function() {
		// This function removes one remaining hour, and adds an hour to the current time. This is only invoked when the player is working.
		State.variables.daycycle.addHours(1);
		this.remainingWorkHours--;
	}
	
	// Buttons
	
		// No longer in use
JobsAssigner.prototype.getAdvanceToPlayerChoiceStateButton = function() {
		var bText = "<<l" + "ink [[Continue|Jobs Screen]]>><<s" + "cript>>\n";
		bText	 += "State.variables.jobsAssigner.charactersBeforePCchooseJobs();\n";
		bText	 += "State.variables.jobsAssigner.flagPlayerIsChoosing = true;\n";
		bText	 += 'State.variables.jobsAssigner.passageText = "";\n';
		bText	 += "State.variables.jobsAssigner.formatStartingPassageText();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
JobsAssigner.prototype.getPlayerChoosesJobButton = function(jobKey) {
		/*var bText = "<<l" + "ink [[Continue|Jobs Screen]]>><<s" + "cript>>\n";
		bText	 += 'State.variables.jobsAssigner.assignJobToChar("chPlayerCharacter","' + jobKey + '");\n';
		bText	 += "State.variables.jobsAssigner.flagPlayerIsChoosing = false;\n";
		bText	 += "State.variables.jobsAssigner.charactersAfterPCchooseJobs();\n";
		bText	 += 'State.variables.jobsAssigner.passageText = "";\n';
		bText	 += "State.variables.jobsAssigner.formatFinalJobAssignationPassageText();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>"; */
		
		var bText = "<<l" + "ink [[Choose on Manual Mode|Jobs Screen]]>><<s" + "cript>>\n";
		bText	 += 'State.variables.jobsAssigner.assignJobToChar("chPlayerCharacter","' + jobKey + '");\n';
		bText	 += "State.variables.jobsAssigner.flagPlayerIsChoosing = false;\n";
		bText	 += "State.variables.jobsAssigner.charactersAfterPCchooseJobs();\n";
		bText	 += 'State.variables.jobsAssigner.passageText = "";\n';
		bText	 += "State.variables.jobsAssigner.npcCandidatesWork();";
		bText	 += "State.variables.jobsAssigner.formatManualModePassageText();";
		bText	 += "<</s" + "cript>><</l" + "ink>>" + " | ";
		
		bText 	 += "<<l" + "ink [[Choose on Auto Mode|Jobs Screen]]>><<s" + "cript>>\n";
		bText	 += 'State.variables.jobsAssigner.assignJobToChar("chPlayerCharacter","' + jobKey + '");\n';
		bText	 += "State.variables.jobsAssigner.flagPlayerIsChoosing = false;\n";
		bText	 += "State.variables.jobsAssigner.charactersAfterPCchooseJobs();\n";
		bText	 += 'State.variables.jobsAssigner.passageText = "";\n';
		bText	 += "State.variables.jobsAssigner.npcCandidatesWork();";
		bText	 += "State.variables.jobsAssigner.playerAutoWorks();";	
		bText	 += "State.variables.jobsAssigner.formatAutoModePassageText();";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
JobsAssigner.prototype.getAdvanceToModeChoiceButton = function() {
		var bText = "<<l" + "ink [[Choose work mode|Jobs Screen]]>><<s" + "cript>>\n";
		bText	 += "State.variables.jobsAssigner.npcCandidatesWork();";
		bText	 += "State.variables.jobsAssigner.passageTextToPlayerChoosesMode();";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
JobsAssigner.prototype.getManualModeButton = function() {
		var bText = "<<l" + "ink [[Manual Mode|Jobs Screen]]>><<s" + "cript>>\n";
		bText	 += "State.variables.jobsAssigner.formatManualModePassageText();";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
JobsAssigner.prototype.getAutoModeButton = function() {
		var bText = "<<l" + "ink [[Auto Mode|Jobs Screen]]>><<s" + "cript>>\n";
		bText	 += "State.variables.jobsAssigner.playerAutoWorks();";		
		bText	 += "State.variables.jobsAssigner.formatAutoModePassageText();";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
JobsAssigner.prototype.getLowEffortButton = function(name,effortsAmount) {
		var i = 0;
		var bText = "<<l" + "ink [[" + name + "|Jobs Screen]]>><<s" + "cript>>\n";
		while ( i < effortsAmount ) {
			bText	 += "State.variables.jobsAssigner.playerWorksOneHour(1);\n";
			i++;
		}
		bText	 += "State.variables.jobsAssigner.formatManualModePassageText();";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
JobsAssigner.prototype.getMediumEffortButton = function(name,effortsAmount) {
		var i = 0;
		var bText = "<<l" + "ink [[" + name + "|Jobs Screen]]>><<s" + "cript>>\n";
		while ( i < effortsAmount ) {
			bText	 += "State.variables.jobsAssigner.playerWorksOneHour(2);\n";
			i++;
		}
		bText	 += "State.variables.jobsAssigner.formatManualModePassageText();";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
JobsAssigner.prototype.getHighEffortButton = function(name,effortsAmount) {
		var i = 0;
		var bText = "<<l" + "ink [[" + name + "|Jobs Screen]]>><<s" + "cript>>\n";
		while ( i < effortsAmount ) {
			bText	 += "State.variables.jobsAssigner.playerWorksOneHour(3);\n";
			i++;
		}
		bText	 += "State.variables.jobsAssigner.formatManualModePassageText();";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
JobsAssigner.prototype.getFinishWorkButton = function() {
		var bText = "The work period is now finished. The Candidates are free for the rest of the day.";
		bText	 += "\n\n<<l" + "ink [[Continue|Map]]>><<s" + "cript>>\n";
		bText	 += "State.variables.jobsAssigner.passageText = '';\n";
		bText	 += "State.variables.jobsAssigner.lastWorkInfo = '';\n";
		bText	 += "initSocializationPeriodPassionTemple();";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
	// Engine
JobsAssigner.prototype.initJobsAssigner = function() {
		// Init
		this.lastWorkInfo = "";
		this.possibleJobs = [];
		this.createInitialJobs();
		this.sortCandidates();	
		// Management
		this.cleanWorkloads();
		this.cleanWorkHours();
		var workloads = State.variables.activeSimulationCharacters.length;
		workloads = workloads * 1.2 - 1;
		this.createRandomWorkloads(workloads);
		
		// Candidates before player choose work
		this.charactersBeforePCchooseJobs();
		this.flagPlayerIsChoosing = true;
		
		// Display
		this.passageText = "";
		this.passageTextToInitialState();		
	}

State.variables.jobsAssigner = new JobsAssigner();

// Constructors, serializers, etc.
JobsAssigner.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
JobsAssigner.prototype.clone = function () {
	return (new JobsAssigner())._init(this);
};
JobsAssigner.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new JobsAssigner())._init($ReviveData$)', ownData);
};

////////// JOBS //////////
// Actual jobs

window.Job = function(key,title) {
	this.key = key;
	this.title = title;
	this.description = "";
	
	this.tier = 1;
	
	this.availableWorkloads = 0; // Amount of times this job may be taken in the current day
	this.takenWorkloads = 0;
	this.characters = []; // Characters who have taken at least one workload
	
	this.effect;
};

window.getJobDisplayText = function(job) {
	var text = "- __" + job.title + "__ - Available workloads: " + (job.availableWorkloads - job.takenWorkloads);
	if ( State.variables.jobsAssigner.flagPlayerIsChoosing == true && (job.availableWorkloads - job.takenWorkloads) > 0 ) {
		text += " - " + State.variables.jobsAssigner.getPlayerChoosesJobButton(job.key);
	}
	text += "\n" + job.description + "\n";
	return text;
}

window.tierOneJobEffect = function(charKey,stat,bar,effort) {
	var moneyFactor = 1; // Multiplies the amount of earned money
	var statExpFactor = 0.5; // Multiplies the amount of earned exp
	var baseMoneyFactor = 0.8 // Multiplies how much money is earned without stats
	var statMoneyFactor = 0.02; // Multiplies how relevant is a stat in earning money
	
	var energyChange = 0;
	var expChange = 0;
	var moneyChange = 0;
	
	switch(effort) {
		case 1: // Low effort
			expChange += 100 * statExpFactor * 0.6;
			moneyChange = 100 * moneyFactor * 0.6 * ( baseMoneyFactor + gC(charKey)[stat].getValue() * statMoneyFactor );
			break;
		case 2: // Medium effort
			if ( gC(charKey)[bar].current >= 10 ) {
				energyChange = -10;
				expChange = 100 * statExpFactor * 1;
				moneyChange = 100 * moneyFactor * 1 * ( baseMoneyFactor + gC(charKey)[stat].getValue() * statMoneyFactor );
			} else { // Not enough energy for medium effort
				gC(charKey)[bar].current = 0;
				energyChange = -1; // Special Value
				expChange = 100 * statExpFactor * 0.4;
				moneyChange = 100 * moneyFactor * 0.4 * ( baseMoneyFactor + gC(charKey)[stat].getValue() * statMoneyFactor );
			}
			break;
		case 3: // High effort
			if ( gC(charKey)[bar].current >= 20 ) {
				energyChange = -20;
				expChange = 100 * statExpFactor * 1.2;
				moneyChange = 100 * moneyFactor * 1.2 * ( baseMoneyFactor + gC(charKey)[stat].getValue() * statMoneyFactor );				
			} else { // Not enough energy for high effort
				gC(charKey)[bar].current = 0;
				energyChange = -1; // Special value
				expChange = 100 * statExpFactor * 0.2;
				moneyChange = 100 * moneyFactor * 0.2 * ( baseMoneyFactor + gC(charKey)[stat].getValue() * statMoneyFactor );
			}
			break;
	}
	
	if ( energyChange == -1 ) {
		gC(charKey)[bar].current = 0;
	} else {
		gC(charKey)[bar].current += energyChange;
	}
	gC(charKey)[stat].experience += expChange;
	gC(charKey).money += moneyChange;
	
	return [ energyChange , expChange , moneyChange ]; // Array with all relevant values
}
window.createTierOneResultsMessage = function(charKey,resultsArray,stat,bar) {
	var text = "";
	if ( resultsArray[0] == -1 ) { // Ran out of energy
		text += gC(charKey).getFormattedName() + " ran out of " + getBarName(bar) +".\n";
	} else {
		text += gC(charKey).getFormattedName() + " lost " + (resultsArray[0] * -1).toFixed(1) + " " + getBarName(bar) + ".\n";
	}
	text += gC(charKey).getFormattedName() + " gained " + resultsArray[1].toFixed(1) + " " + firstToCap(stat) + " experience points.\n";
	text += gC(charKey).getFormattedName() + " worked for a total of " + resultsArray[2].toFixed(1) + " Veerens.\n";
	return text;
}

window.createRepairsJob = function() {
	var job = new Job("repairs","Repair the Temple");
	job.description = "We have found some deterioration on the Temple's structure, which needs to be repaired or rebuilt."
					+ "\nUses physique and energy, trains physique.";
	job.stat = "physique";
	job.bar = "energy";
	job.effect = function(charKey,effort) {
		var results = tierOneJobEffect(charKey,this.stat,this.bar,effort);
		return createTierOneResultsMessage(charKey,results,this.stat,this.bar);
	}
	return job;
}
window.createCleaningJob = function() {
	var job = new Job("cleaning","Clean the halls");
	job.description = "The indoors of the Temple require some cleaning.\nUses agility and energy, trains agility.";
	job.stat = "agility";
	job.bar = "energy";
	job.effect = function(charKey,effort) {
		var results = tierOneJobEffect(charKey,this.stat,this.bar,effort);
		return createTierOneResultsMessage(charKey,results,this.stat,this.bar);
	}
	return job;
}
window.createTendCropsJob = function() {
	var job = new Job("tendCrops","Tend the crops");
	job.description = "We need to sow, water or harvest some of our crops.\nUses resilience and energy, trains resilience.";
	job.stat = "resilience";
	job.bar = "energy";
	job.effect = function(charKey,effort) {
		var results = tierOneJobEffect(charKey,this.stat,this.bar,effort);
		return createTierOneResultsMessage(charKey,results,this.stat,this.bar);
	}
	return job;
}
window.createBookResearchJob = function() {
	var job = new Job("bookResearch","Research spell books");
	job.description = "Taototh wants someone to study some old spell books, and hopefully find something useful."
					+ "\nUses intelligence and willpower, trains intelligence.";
	job.stat = "intelligence";
	job.bar = "willpower";
	job.effect = function(charKey,effort) {
		var results = tierOneJobEffect(charKey,this.stat,this.bar,effort);
		return createTierOneResultsMessage(charKey,results,this.stat,this.bar);
	}
	return job;
}
window.createOutdoorsCleaningJob = function() {
	var job = new Job("outdoorCleaning","Clean the outdoors");
	job.description = "Leaves and other rests of nature have piled up in our outdoors. Use magic to get them out of the way."
					+ "\nUses will and willpower, trains will.";
	job.stat = "will";
	job.bar = "willpower";
	job.effect = function(charKey,effort) {
		var results = tierOneJobEffect(charKey,this.stat,this.bar,effort);
		return createTierOneResultsMessage(charKey,results,this.stat,this.bar);
	}
	return job;
}
window.createAnalyzeFloraJob = function() {
	var job = new Job("analysisFlora","Analyze the local flora");
	job.description = "We need a report on the growth and state of the local flora. Explore our surrounding gardens and forests"
					+ " and take notes about it.\nUses perception and willpower, trains perception.";
	job.stat = "perception";
	job.bar = "willpower";
	job.effect = function(charKey,effort) {
		var results = tierOneJobEffect(charKey,this.stat,this.bar,effort);
		return createTierOneResultsMessage(charKey,results,this.stat,this.bar);
	}
	return job;
}
window.createDramaWritingJob = function() {
	var job = new Job("dramaWriting","Write new dramas");
	job.description = "We want to expand our drama library. Write some scripts and we may add them to the collection."
					+ "\nUses charisma and social drive, trains charisma.";
	job.stat = "charisma";
	job.bar = "socialdrive";
	job.effect = function(charKey,effort) {
		var results = tierOneJobEffect(charKey,this.stat,this.bar,effort);
		return createTierOneResultsMessage(charKey,results,this.stat,this.bar);
	}
	return job;
}
window.createDramaCatalogueJob = function() {
	var job = new Job("dramaCatalogue","Catalogue old dramas");
	job.description = "We have some unsorted texts in the drama library. Analyze them in order to properly catalogue them."
					+ "\nUses empathy and social drive, trains empathy.";
	job.stat = "empathy";
	job.bar = "socialdrive";
	job.effect = function(charKey,effort) {
		var results = tierOneJobEffect(charKey,this.stat,this.bar,effort);
		return createTierOneResultsMessage(charKey,results,this.stat,this.bar);
	}
	return job;
}
window.createSalfisGatheringJob = function() {
	var job = new Job("salfisGathering","Gather salfis flowers");
	job.description = "Salfis flowers are very efficient at storing magic energy, and we have to replenish our stock. "
					+ "Gather some of them in the surrounding forests.\nUses luck and willpower, trains luck.";
	job.stat = "luck";
	job.bar = "willpower";
	job.effect = function(charKey,effort) {
		var results = tierOneJobEffect(charKey,this.stat,this.bar,effort);
		return createTierOneResultsMessage(charKey,results,this.stat,this.bar);
	}
	return job;
}

// Constructors, serializers, etc.
Job.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
Job.prototype.clone = function () {
	return (new Job())._init(this);
};
Job.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Job())._init($ReviveData$)', ownData);
};

////////// RELATIONS LIST CLASS  //////////
	// This is actually required, believe me.
window.Relations = function() {
};

// Constructors, serializers, etc.
Relations.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
Relations.prototype.clone = function () {
	return (new Relations())._init(this);
};
Relations.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Relations())._init($ReviveData$)', ownData);
};


////////// RELATION-PARAMETER CLASS  //////////
// Relation-parameter or RelPar is a dual parameter belonging to a relation

window.RelPar = function(shortTerm,longTerm) {
	this.stv = shortTerm; // Short Term Value
	this.ltv = longTerm; // Long Term Value
	this.level = 0; // Level, determined at the start of the day
	this.levelMod = 0; // Level modifier, gets summed to current level
};

RelPar.prototype.processNewDay = function(mult) {
		var f = (this.stv * mult) / 100.0;
		if ( this.stv < 0 ) { this.stv *= 0.5; } // Reduce effect of negative stv
		this.stv -= f * 5; // Remove 5% of current Short Term Value
		this.ltv += f; // Add 1% of current Short Term Value
		if ( this.ltv < 0 ) { this.ltv = 0; } // Prevent negative ltv
		var levelChanges = formulaRelParLevel(this);
		this.level += levelChanges;
		if ( levelChanges != 0 ) {
			return true;
		} else {
			return false;
		}
	}

window.formulaRelParLevel = function(RelPar) { // Returns the level of a given RelPar
	var newLevel = 0;
	var tPoints = RelPar.stv + RelPar.ltv;
	var currentLevelPoints = ( RelPar.level * 200 ) + ( ( RelPar.level * RelPar.level ) * 50 );
	if ( (tPoints < currentLevelPoints) && (RelPar.level != 0) ) {
		newLevel--;
	} else if ( tPoints > (( (RelPar.level + 1) * 200 ) + ( ( (RelPar.level + 1) * (RelPar.level + 1) ) * 50 ) ) ) {
		newLevel++;
	}

	return newLevel;
	// 0 , 250 , 600 , 1050 , 1600 , 2250
}
window.formulaRelParLevelResult = function(level) {
	var result = ( level * 200 ) + ( ( level * level ) * 50 );
	return result;
}
window.formulaRelParTotalLevel = function(RelPar) {
	var flagKeepsGrowing = true;
	var level = 0;
	
	while ( flagKeepsGrowing == true ) {
		if ( (RelPar.stv + RelPar.ltv) > formulaRelParLevelResult(level+1) ) {
			level++;
		}
		else {
			flagKeepsGrowing = false;
		}
	}
	return level;
}

// Constructors, serializers, etc.
RelPar.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
RelPar.prototype.clone = function () {
	return (new RelPar())._init(this);
};
RelPar.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new RelPar())._init($ReviveData$)', ownData);
};

////////// RELATION CLASS  //////////
// A relation is the sum of variables determining how one character feels towards another.

window.Relation = function(targetCharKey) {
	this.target = targetCharKey ; // Key of the character this relation is directed to.
	
	this.friendship = new RelPar(0,0);
	this.sexualTension = new RelPar(0,0);
	this.romance = new RelPar(0,0);
	this.domination = new RelPar(0,0);
	this.submission = new RelPar(0,0);
	this.rivalry = new RelPar(0,0);
	this.enmity = new RelPar(0,0);
	
	this.favor = 0;
	
	this.relType = null;
	
	this.anger = 0; // Anger works independently and is resetted each day. // Not implemented, may get deleted completely
};

Relation.prototype.processNewDay = function() {
		var anyChanges = false;
		for ( var stat of [ "friendship" , "sexualTension" , "romance" , "domination" , "submission" , "rivalry" , "enmity" ] ) {
			var mult = 1.0;
			var statDiff = 0;
			if ( stat == "friendship" || stat == "romance" ) {
				statDiff = (this.friendship.level + this.romance.level - this.enmity.level * 2) / 2;
			} else if ( stat == "enmity" ) {
				statDiff = - (this.friendship.level - this.romance.level + this.enmity.level * 2) / 2;
			} else if ( stat == "submission" ) {
				statDiff = this.submission.level - this.domination.level;
			} else if ( stat == "domination" ) {
				statDiff = - this.submission.level + this.domination.level;
			}
			if ( statDiff >= 9 ) { mult = 1.6; }
			else if ( statDiff >= 6 ) { mult = 1.4; }
			else if ( statDiff >= 3 ) { mult = 1.2; }
			else if ( statDiff <= -6 ) { mult = 0.8; }
			if ( this[stat].processNewDay(mult) ) {
				anyChanges = true;
			}
			this.anger = 0;
		}
		return anyChanges;
	}

window.checkAndCreateRelations = function(charList) { // This function checks every character in a given list, checks if they have relations, and
													// creates them if they don't 
	for ( var i of charList ) {
		for ( var l of charList ) {
			if ( i != l ) {
				if ( gC(i).relations[l] == undefined ) {
					gC(i).relations[i] = new Relation(l);
				}
			}
		}
	}
}

window.rLvlAbt = function(charA,charB,type) { // Returns the levels of the "type" type of relation between charA (actor) and charB (target),
		// Relation Level CharA CharB Type // if there's any
	var level = -1;
	if ( gC(charA).relations[charB] != undefined ) {
		level = gC(charA).relations[charB][type].level + gC(charA).relations[charB][type].levelMod;
	}
	return level;
}
window.rFavor = function(charA,charB) {
	// Returns the favor charA owes to charB. If none, returns the favor charB owes to charA, as a negative value.
	var favor = 0;
	if ( gC(charA).relations[charB] != undefined ) {
		favor = gC(charA).relations[charB].favor;
		if ( favor == 0 ) {
			favor = -gC(charB).relations[charA].favor;
		}
	}
	return favor;
}
window.rFormatPlayerFavor = function(character) {
	var favor = 0;
	var txt = '<span title="Favor">';
	if ( gC("chPlayerCharacter").relations[character] != undefined ) {
		favor = gC("chPlayerCharacter").relations[character].favor;
		if ( favor == 0 ) {
			favor = gC(character).relations.chPlayerCharacter.favor;
			txt += "F:" + colorText(favor.toFixed(2),"green");
		} else {
			txt += "F:" + colorText(favor.toFixed(2),"red");
		}
	}
	txt += "</span> ,"
	return txt;
}

window.getRelation = function(actor,target) {
	return gC(actor).relations[target];
}

window.initRelationshipDataAmongAllActiveCharacters = function() {
	for ( var charA of getActiveSimulationCharactersArray() ) {
		for ( var charB of getActiveSimulationCharactersArray() ) {
			if ( charA != charB ) {
				if ( getRelation(charA,charB) == undefined ) {
					gC(charA).relations[charB] = new Relation(charB);
				}
			}
		}
	}
}

// Constructors, serializers, etc.
Relation.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
Relation.prototype.clone = function () {
	return (new Relation())._init(this);
};
Relation.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Relation())._init($ReviveData$)', ownData);
};

  // Utilities

	// Relationship description
window.getRelationshipDescription = function(charA,charB) {
	var results = [(gC(charA).getFormattedName() + " is indifferent towards " + gC(charB).getFormattedName() + "."),"0",0]; // 0: Description, 1: Type, 2: Level
	
	var fr = rLvlAbt(charA,charB,"friendship");
	var ro = rLvlAbt(charA,charB,"romance");
	var se = rLvlAbt(charA,charB,"sexualTension");
	var dom = rLvlAbt(charA,charB,"domination");
	var sub = rLvlAbt(charA,charB,"submission");
	var ri = rLvlAbt(charA,charB,"rivalry");
	var en = rLvlAbt(charA,charB,"enmity");
	var intensity = 0;
	var inValue = 0;
	
	if ( fr == 0 && ro == 0 && se == 0 && dom == 0 && sub == 0 && ri == 0 && en == 0 ) {
		results = [(gC(charA).getFormattedName() + " is indifferent towards " + gC(charB).getFormattedName() + "."),"0",0];
	} else if ( (fr+ro) > (ri+en) ) { // Positive relationship
		if ( (fr+ro) > (se*1.5) ) { // Not sexually focused
			var dsBalance = (dom-sub) / (fr+ro);
			inValue = fr+ro;
			if ( inValue > 15 ) { intensity = 2; }
			else if ( inValue > 7 ) { intensity = 1; }
			if ( dsBalance >= 0.25 ) { // Domination is dominant
				if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " thinks " + gC(charB).getFormattedName() + " is cute."),"1ab",0]; }
				else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " enjoys " + gC(charB).getFormattedName() + "'s company and attention."),"1ab",1]; }
				else { results = [(gC(charA).getFormattedName() + " considers " + gC(charB).getFormattedName() + " " + gC(charA).posPr + " protegee."),"1ab",2]; }
			} else if ( dsBalance <= -0.25 ) { // Submission is dominant
				if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " looks at " + gC(charB).getFormattedName() + " with interest and respect."),"1aa",0]; }
				else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " has considerable trust and respect for " + gC(charB).getFormattedName() + "."),"1aa",1]; }
				else { results = [(gC(charA).getFormattedName() + " holds great trust and devotion for " + gC(charB).getFormattedName() + "."),"1aa",2]; }
			} else { // No domination
				if ( (ri*2.3) >= (fr+ro) ) { // Rivalry leaning
					if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " is interested in " + gC(charB).getFormattedName() + "."),"1aca",0]; }
					else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " sees a friend and a rival in " + gC(charB).getFormattedName() + "."),"1aca",1]; }
					else { results = [(gC(charA).getFormattedName() + " is bound to " + gC(charB).getFormattedName() + " by love and rivalry."),"1aca",2]; }
				} else if ( fr > ro ) { // Friendship is dominant
					if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " likes " + gC(charB).getFormattedName() + "."),"1acb",0]; }
					else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " considers " + gC(charB).getFormattedName() + " a companion."),"1acb",1]; }
					else { results = [(gC(charA).getFormattedName() + " would trust " + gC(charB).getFormattedName() + " with " + gC(charA).posPr + " life."),"1acb",2]; }
				} else { // Romance is dominant
					if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " likes " + gC(charB).getFormattedName() + "."),"1acc",0]; }
					else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " is falling for " + gC(charB).getFormattedName() + "."),"1acc",1]; }
					else { results = [(gC(charA).getFormattedName() + " is deeply in love with " + gC(charB).getFormattedName() + "."),"1acc",2]; }
				}
			}
		} else { // Sexually focused
			var dsBalance = (dom-sub) / (se*1.5);
			inValue = se*1.5;
			if ( inValue > 15 ) { intensity = 2; }
			else if ( inValue > 7 ) { intensity = 1; }
			if ( dsBalance >= 0.25 ) { // Domination is dominant
				if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " lusts after " + gC(charB).getFormattedName() + "."),"1bb",0]; }
				else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " wishes to ravage " + gC(charB).getFormattedName() + "."),"1bb",1]; }
				else { results = [(gC(charA).getFormattedName() + " feels complete by having " + gC(charB).getFormattedName() + " below " + gC(charA).refPr + "."),"1bb",2]; }
			} else if ( dsBalance <= -0.25 ) { // Submission is dominant
				if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " is aroused by " + gC(charB).getFormattedName() + "."),"1ba",0]; }
				else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " looks up to " + gC(charB).getFormattedName() + " with respect and lust."),"1ba",1]; }
				else { results = [(gC(charA).getFormattedName() + " melts in desire and devotion for " + gC(charB).getFormattedName() + "."),"1ba",2]; }
			} else { // No domination
				if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " lusts after " + gC(charB).getFormattedName() + "."),"1bc",0]; }
				else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " gets excited with " + gC(charB).getFormattedName() + "'s company."),"1bc",1]; }
				else { results = [(gC(charA).getFormattedName() + " holds great desire to have " + gC(charB).getFormattedName() + " in " + gC(charA).posPr + " arms."),"1bc",2]; }				
			}
		}
	} else { // Negative relationship
		if ( (ri+en) > (se*1.5) ) { // Not sexually focused
			var dsBalance = (dom-sub) / (ri+en);
			inValue = ri+en;
			if ( inValue > 15 ) { intensity = 2; }
			else if ( inValue > 7 ) { intensity = 1; }
			if ( dsBalance >= 0.25 ) { // Domination is dominant
				if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " finds " + gC(charB).getFormattedName() + " annoying."),"2cb",0]; }
				else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " is often demeaning towards " + gC(charB).getFormattedName() + "."),"2cb",1]; }
				else { results = [(gC(charA).getFormattedName() + " is glad to have " + gC(charB).getFormattedName() + " under " + gC(charA).posPr + " foot."),"2cb",2]; }
			} else if ( dsBalance <= -0.25 ) { // Submission is dominant
				if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " is scared of " + gC(charB).getFormattedName() + "."),"2ca",0]; }
				else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " is obedient towards " + gC(charB).getFormattedName() + "."),"2ca",1]; }
				else { results = [(gC(charA).getFormattedName() + " can't even think about going against " + gC(charB).getFormattedName() + "'s word."),"2ca",2]; }
			} else { // DS is not dominant
				if ( ri > en ) { // Rivalry is dominant
					if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " is cautious about " + gC(charB).getFormattedName() + "."),"2cca",0]; }
					else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " is tense around " + gC(charB).getFormattedName() + "."),"2cca",1]; }
					else { results = [(gC(charA).getFormattedName() + " sees " + gC(charB).getFormattedName() + " as " + gC(charA).posPr + " nemesis."),"2cca",2]; }
				} else { // Enmity is dominant
					if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " is annoyed about " + gC(charB).getFormattedName() + "."),"2ccb",0]; }
					else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " thinks " + gC(charB).getFormattedName() + " is dangerous."),"2ccb",1]; }
					else { results = [(gC(charA).getFormattedName() + " thinks " + gC(charB).getFormattedName() + " is scum."),"2ccb",2]; }					
				}
			}
		} else { // Sexually focused
			var dsBalance = (dom-sub) / (ri+en);
			inValue = ri+en;
			if ( inValue > 15 ) { intensity = 2; }
			else if ( inValue > 7 ) { intensity = 1; }
			if ( dsBalance >= 0.25 ) { // Domination is dominant
				if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " lusts after " + gC(charB).getFormattedName() + "'s body."),"2db",0]; }
				else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " desire to have " + gC(charB).getFormattedName() + " under " + gC(charA).posPr + " grasp."),"2db",1]; }
				else { results = [(gC(charA).getFormattedName() + " sees an alluring toy in " + gC(charB).getFormattedName() + "."),"2db",2]; }
			} else if ( dsBalance <= 0.25 ) { // Submission is dominant
				if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " is scared of " + gC(charB).getFormattedName() + "."),"2da",0]; }
				else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " thinks " + gC(charB).getFormattedName() + " is dangerous... But also thrilling."),"2da",1]; }
				else { results = [(gC(charA).getFormattedName() + " finds guilty pleasure in obeying " + gC(charB).getFormattedName() + "."),"2da",2]; }
			} else { // DS is not dominant
				if ( intensity == 0 ) { results = [(gC(charA).getFormattedName() + " dislikes lusting after " + gC(charB).getFormattedName() + "."),"2dc",0]; }
				else if ( intensity == 1 ) { results = [(gC(charA).getFormattedName() + " desires " + gC(charB).getFormattedName() + "'s body."),"2dc",1]; }
				else { results = [(gC(charA).getFormattedName() + " feels great lust for " + gC(charB).getFormattedName() + ", despite everything else."),"2dc",2]; }
			}
		}
	}
	
	return results;
}

window.getAverageRelationStatBetweenCharAndGroup = function(stat,charA,charList) { // Returns the average level of the relationship stat "stat" between the character "charA" and each character in the list "charList". Result is altered to make sure it won't be zero.
	var average = 1;
	var it = 0;
	for ( var cK of charList ) {
		if ( rLvlAbt(charA,cK,stat) != undefined ) {
			average += rLvlAbt(charA,cK,stat);
			it++;
		}
	}
	return average;
}
window.getRelationshipStatProportionBetweenCharAndGroup = function(statsA,statsB,charA,charList,flagProportional) { // Using the previous function, returns the fraction of the sum of all statsA the sum of all statsB returned by getAverageRelationStatBetweenCharAndGroup(). Result is altered to make sure it won't be zero. If flagProportional is true, statsA and statsB will be divided by the total amount of stats to be accounted for in each list
	var topAverage = 1;
	var botAverage = 1;
	var result = 0;
	var it = 0;
	for ( var st of statsA ) {
		var stAv = getAverageRelationStatBetweenCharAndGroup(st,charA,charList);
		if ( stAv != undefined ) {
			topAverage += stAv;
			if ( flagProportional ) { it++; }
		}
	}
	if ( flagProportional && it != 0 ) {
		topAverage *= 1/it;
		it = 0;
	}
	for ( var st of statsB ) {
		var stAv = getAverageRelationStatBetweenCharAndGroup(st,charA,charList);
		if ( stAv != undefined ) {
			botAverage += stAv;
			if ( flagProportional ) { it++; }
		}
	}
	if ( flagProportional && it != 0 ) {
		topAverage *= 1/it;
	}
	result = topAverage / botAverage; // Get the fraction between statsA and statsB
	return result;
}

////////// RELATIONSHIPTYPE CLASS  //////////
// A relationship type is a specific form or relationship that follows specific rules

window.RelationshipType = function(actor,target,type,name,shortName,roleName,persistence,days,hierarchy) {
	this.actor = actor;
	this.target = target;
	this.type = type; // servitude / companionship / tutorship
	this.persistence = persistence; // temporary / continued
	this.hierarchy = hierarchy; // ega / sub / dom
	this.days = days;
	this.name = name; // How it is shown in game
	this.shortName = shortName; // How it is abreviated
	this.roleName = roleName;
	
	this.getTooltip = function() {
		return "";
	}
	
	this.dailyEffect = null; // If appliable, this is a function that gets executed daily
							 // If a function, it returns a description of the result
	
	this.forcedToFollow = false; // Has to follow target when asked, no favor exchange
	this.forcedToAssistAssault = false; // Has to assist target in assault when asked, no favor exchange
	this.forcedToSex = false; // Has to join target in sex
	
	this.disallowedAssault = false; // It's not possible to assault target
	this.disallowedChallenge = false; // It's not possible to challenge target
	this.liberationChallenge = false; // It's not possible to challenge target
	
	this.finishRelTypeExtra = function() {
		return true;
	}
	
	this.supportInfamy = 0;
}

window.gRelTypeAb = function(charA,charB) {
	var relType = null;
	var rel = gC(charA).relations[charB];
	if ( rel ) {
		relType = rel.relType;
	}
	
	return relType;
}
window.finishRelType = function(charA,charB) {
	var relType = gRelTypeAb(charA,charB);
	var description = "";
	if ( relType ) {
		gC(charA).relations[charB].relType.finishRelTypeExtra();
		gC(charB).relations[charA].relType.finishRelTypeExtra();
		description = "The " + relType.name + " relationship between " + gC(charA).name + " and " + gC(charB).name + " has finished.";
		if ( relType.hierarchy == "ega" ) {
			gC(charA).egaChars = arrayMinusA(gC(charA).egaChars,charB);
			gC(charB).egaChars = arrayMinusA(gC(charB).egaChars,charA);
		} else if ( relType.hierarchy == "dom" ) {
			gC(charA).subChars = arrayMinusA(gC(charA).subChars,charB);
			gC(charB).domChar = null;
		} else if ( relType.hierarchy == "sub" ) {
			gC(charA).domChar = null;
			gC(charB).subChars = arrayMinusA(gC(charB).subChars,charA);
		}
		gC(charA).relations[charB].relType = null;
		gC(charB).relations[charA].relType = null;
	}
	return description;
}

window.createRelTypeServitudeSub = function(actor,target,days) {
	var relType = new RelationshipType(actor,target,"servitude","servitude",colorText("Sv","violet"),"servant","temporary",days,"sub");
	relType.forcedToFollow = true;
	relType.forcedToAssistAssault = true;
	relType.forcedToSex = true;
	relType.disallowedAssault = true;
	relType.liberationChallenge = true;
	relType.dailyEffect = function() {
		var meritLoss = 1;
		var submissionGain = 50;
		gC(this.actor).changeMerit(-meritLoss);
		gC(this.actor).relations[this.target].submission.stv += submissionGain;
		
		var description = gC(this.actor).name + " has lost " + meritLoss + " merit. " + gC(this.actor).name + "'s submission towards " + gC(this.target).name + " is growing.";
		return description;
	}
	relType.getTooltip = relTypeServitudeTooltip;
	
	gC(actor).domChar = target;
	gC(actor).relations[target].relType = relType;
	
	gC(actor).relations[target].submission.levelMod += 4;
	gC(actor).relations[target].sexualTension.levelMod += 2;
	
	relType.finishRelTypeExtra = function() {
		gC(this.actor).relations[this.target].submission.levelMod -= 4;
		gC(this.actor).relations[this.target].sexualTension.levelMod -= 2;
	}
}
window.createRelTypeServitudeDom = function(actor,target,days) {
	var relType = new RelationshipType(actor,target,"servitude","servitude",colorText("Mst","purple"),"master","temporary",days,"dom");
	relType.disallowedAssault = true;
	relType.disallowedChallenge = true;
	relType.dailyEffect = function() {
		var meritGain = 1;
		var dominationGain = 50;
		gC(this.actor).changeMerit(meritGain);
		gC(this.actor).relations[this.target].domination.stv += dominationGain;
		
		var description = gC(this.actor).name + " has won " + meritGain + " merit. " + gC(this.actor).name + "'s domination towards " + gC(this.target).name + " is growing.";
		return description;
	}
	relType.getTooltip = relTypeServitudeTooltip;
	
	gC(actor).subChars.push(target);
	gC(actor).relations[target].relType = relType;
	
	gC(actor).relations[target].domination.levelMod += 4;
	gC(actor).relations[target].sexualTension.levelMod += 2;
	
	relType.finishRelTypeExtra = function() {
		gC(this.actor).relations[this.target].domination.levelMod -= 4;
		gC(this.actor).relations[this.target].sexualTension.levelMod -= 2;
	}
}

window.createRelTypeTutorshipSub = function(actor,target,days) {
	var relType = new RelationshipType(actor,target,"tutorship","tutorship",colorText("Pu","violet"),"pupil","temporary",days,"sub");
	relType.forcedToFollow = true;
	relType.forcedToAssistAssault = false;
	relType.forcedToSex = false;
	relType.disallowedAssault = true;
	relType.liberationChallenge = false;
	relType.dailyEffect = function() {
		var meritLoss = 0;
		var friendshipGain = 25;
		var submissionGain = 25;
		gC(this.actor).changeMerit(-meritLoss);
		gC(this.actor).relations[this.target].submission.stv += submissionGain;
		gC(this.actor).relations[this.target].friendship.stv += friendshipGain;
		
		var description = gC(this.actor).name + "'s submission towards " + gC(this.target).name + " is growing. " + gC(this.actor).name + "'s and " + gC(this.target).name + "'s friendship is growing.";
		return description;
	}
	relType.getTooltip = relTypeTutorshipTooltip;
	
	gC(actor).domChar = target;
	gC(actor).relations[target].relType = relType;
	
	gC(actor).relations[target].submission.levelMod += 2;
	gC(actor).relations[target].sexualTension.levelMod += 1;
	gC(actor).relations[target].friendship.levelMod += 2;
	gC(actor).relations[target].romance.levelMod += 1;
	
	relType.finishRelTypeExtra = function() {
		gC(this.actor).relations[this.target].submission.levelMod -= 2;
		gC(this.actor).relations[this.target].sexualTension.levelMod -= 1;
		gC(this.actor).relations[this.target].friendship.levelMod -= 2;
		gC(this.actor).relations[this.target].romance.levelMod -= 1;
	}
}
window.createRelTypeTutorshipDom = function(actor,target,days) {
	var relType = new RelationshipType(actor,target,"tutorship","tutorship",colorText("Tut","purple"),"tutor","temporary",days,"dom");
	relType.disallowedAssault = true;
	relType.disallowedChallenge = true;
	relType.dailyEffect = function() {
		var meritGain = 1;
		var friendshipGain = 25;
		var dominationGain = 25;
		gC(this.actor).changeMerit(meritGain);
		gC(this.actor).relations[this.target].domination.stv += dominationGain;
		gC(this.actor).relations[this.target].friendship.stv += friendshipGain;
		
		var description = gC(this.actor).name + " has won " + meritGain + " merit. " + gC(this.actor).name + "'s domination towards " + gC(this.target).name + " is growing. " + gC(this.actor).name + "'s and " + gC(this.target).name + "'s friendship is growing.";
		return description;
	}
	relType.getTooltip = relTypeTutorshipTooltip;
	
	gC(actor).subChars.push(target);
	gC(actor).relations[target].relType = relType;
	
	gC(actor).relations[target].domination.levelMod += 2;
	gC(actor).relations[target].sexualTension.levelMod += 1;
	gC(actor).relations[target].friendship.levelMod += 2;
	gC(actor).relations[target].romance.levelMod += 1;
	
	relType.finishRelTypeExtra = function() {
		gC(this.actor).relations[this.target].domination.levelMod -= 2;
		gC(this.actor).relations[this.target].sexualTension.levelMod -= 1;
		gC(this.actor).relations[this.target].friendship.levelMod -= 2;
		gC(this.actor).relations[this.target].romance.levelMod -= 1;
	}
}

window.createRelTypeCompanionship = function(actor,target,days) {
	var relType = new RelationshipType(actor,target,"companionship","companionship",colorText("Cm","green"),"companion","temporary",days,"ega");
	relType.forcedToFollow = false;
	relType.forcedToAssistAssault = true;
	relType.forcedToSex = false;
	relType.disallowedAssault = true;
	relType.disallowedChallenge = false;
	relType.liberationChallenge = false;
	relType.dailyEffect = function() {
		var friendshipGain = 25;
		var romanceGain = 25;
		gC(this.actor).relations[this.target].friendship.stv += friendshipGain;
		gC(this.actor).relations[this.target].romance.stv += romanceGain;
		
		var description = gC(this.actor).name + "'s friendship and romance towards " + gC(this.target).name + " are growing.";
		return description;
	}
	relType.getTooltip = relTypeCompanionshipTooltip;
	relType.supportInfamy = -1;
	
	gC(actor).egaChars.push(target);
	gC(actor).relations[target].relType = relType;
	
	gC(actor).relations[target].friendship.levelMod += 3;
	gC(actor).relations[target].romance.levelMod += 2;
	gC(actor).relations[target].sexualTension.levelMod += 1;
	
	relType.finishRelTypeExtra = function() {
		gC(this.actor).relations[this.target].friendship.levelMod -= 3;
		gC(this.actor).relations[this.target].romance.levelMod -= 2;
		gC(this.actor).relations[this.target].sexualTension.levelMod -= 1;
	}
}



	// Relatinship Types' Tooltips

window.relTypeServitudeTooltip = function() {
	var tt = "In a servitude relationship, the servant is expected to follow the orders of the master.\n"
		   + "Daily domination/submission gains.\n"
		   + "Flat domination/submission and sexual tension increases.\n"
		   + "Daily merit transfer from servant to master.\n"
		   + "The master may demand the servant to follow.\n"
		   + "The master may demand the servant to assist on assault.\n"
		   + "The master may demand sex from the servant.\n"
		   + "Neither master nor servant may assault each other.\n"
		   + "The master may not challenge the servant.\n"
		   + "The servant may challenge the master to regain their freedom.\n";
	return tt;
}

window.relTypeTutorshipTooltip = function() {
	var tt = "In a tutorship relationship, the pupil is expected to follow the orders of the tutor, in exchange for experience.\n"
		   + "Daily domination/submission gains. Daily friendship gains.\n"
		   + "Flat domination/submission, friendship, romance and sexual tension increases.\n"
		   + "Daily merit gain for tutor.\n"
		   + "The tutor may demand the pupil to follow.\n"
		   + "Neither tutor nor pupil may assault each other.\n"
		   + "The tutor may not challenge the pupil.\n"
		   + "When both tutor and pupil train a stat and the tutor excels at it,\nthe pupil will gain additional experience.\n";
	return tt;
}

window.relTypeCompanionshipTooltip = function() {
	var tt = "In a companionship relationship, companions are not allowed to assault each other.\n"
		   + "Daily friendship and romance gains.\n"
		   + "Flat friendship, romance and sexual tension increases.\n"
		   + "Companions may not assault each other.\n";
	return tt;
}

	// Print info functions
	
window.getRelTypeInTt = function(charA,charB) {
	// Abbreviation of charA's title in relationship with charB
	var title = "";
	var relType = gRelTypeAb(charA,charB);
	if ( relType ) {
		title = firstToCap(relType.roleName) + "\n";
	}
	return title;
}
window.getRelTypeAbr = function(charA,charB) {
	// Abbreviation of charA's title in relationship with charB
	var abr = "";
	var relType = gRelTypeAb(charA,charB);
	if ( relType ) {
		abr = '<span title="' + getRelTypeInTt(charA,charB) + relType.getTooltip() + '">' + relType.shortName + '</span>';
	}
	return abr;
}
window.getRelTypeName = function(charA,charB) {
	// charA's title in relationship with charB
	var abr = "";
	var relType = gRelTypeAb(charA,charB);
	if ( relType ) {
		abr = '<span title="' + getRelTypeInTt(charA,charB) + relType.getTooltip() + '">' + relType.roleName + '</span>';
	}
	return abr;
}
window.getRelTypeNameMayus = function(charA,charB) {
	// charA's title in relationship with charB
	var abr = "";
	var relType = gRelTypeAb(charA,charB);
	if ( relType ) {
		abr = '<span title="' + getRelTypeInTt(charA,charB) + relType.getTooltip() + '">' + firstToCap(relType.roleName) + '</span>';
	}
	return abr;
}

// Constructors, serializers, etc.
RelationshipType.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
RelationshipType.prototype.clone = function () {
	return (new RelationshipType())._init(this);
};
RelationshipType.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new RelationshipType())._init($ReviveData$)', ownData);
};


 ////////// PRE-BUILT CHARACTERS //////////
// This file provides functions that create each specific character with the appropiate attributes.
// This should make the StoryInit Passage more readable

// Characters
window.createPlayerCharacter = function() {
	var character = new Character("You" , "chPlayerCharacter");
	character.type = "candidate";
	
	character.setColors("Red","Crimson");
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","mountDick");
	character.saList.push("baKissLips","baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","taunt","baTease");
		// Don't push ("strokePussy","strokeBreasts","kissLips","frottage","frenchKiss","kneel","makeKneel","lickGroin","legHoldHead","mountFromBehind",
	//"penetratePussy","thrust","piston","finalPush",	"mountFaceToFace","getBlowjob","suckDick","lickPussy","interlockLegs","scissor");
	// Body
	// ("baKissLips","baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","kick","coldGuts","taunt","baTease")
	character.addFemaleParts();
	// Others
	character.names.push("the young Human");
	character.assignFemeninePronouns();
	
	character.icon = function() {
		return "[img[img/charIcons/pcIcon.png]]";
	}
	
	character.refugeRooms = [["mapTrainingGrounds","playerRoom"]];
	
	return character;
};
window.createGoddessHerald = function() {
	var character = new Character( "Mysterious Woman" , "chGoddessHerald" );
	character.setColors("DarkOrchid","DarkOrchid");
	// Stats
	character.physique.value = 16;
	character.agility.value = 16;
	character.resilience.value = 16;
	character.will.value = 10;
	character.intelligence.value = 16;
	character.perception.value = 16;
	character.empathy.value = 16;
	character.charisma.value = 10;
	character.luck.value = 16;
	// Moves
	character.saList.push("strokePussy");
	character.saList.push("strokeBreasts");
	character.saList.push("kissLips");
	character.saList.push("frenchKiss");
	character.saList.push("takeFromBehind");
	character.saList.push("thrust");
	character.saList.push("hypnoticGlance");
	// Body
	character.addFemaleParts();
	character.addBodypart("tail","tail");
	// Others
	character.assignFemeninePronouns();
	character.makeVirginitiesUnknown();
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/varyonte-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/varyonte-avatar.png]]";
	}
	//character.icon = function() { // Does she need an icon?
	//	return "[img[img/charIcons/nashIcon.png]]";
	
	character.fullPortraitL = "img/portraits/varyonte-full.png";
	character.avatarL = "img/portraits/varyonte-avatar.png";
	// character.iconL = "img/charIcons/nashIcon.png"; // Does she need an icon?
	
	return character;
};
window.createDrishtya = function() {
	var character = new Character( "Drishtya" , "chDummy" );
	character.setColors("DarkOrchid","DarkOrchid");
	
	// Others
	character.assignFemeninePronouns();
	
	delete character.combatAffinities;
	delete character.tastes;
	
	return character;
}

window.createNashillbyir = function() {
	var character = new Character("Nash", "chNash");
	character.type = "candidate";
	
	character.setColors("coral","coral");
	
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","mountDick");
	/* ["embers","freezeFeet","sparkingRubbing"]
	character.saList.push("baKissLips","baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","coldGuts","taunt","baTease");
	*/
	character.saList.push("baKissLips","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","taunt","sparkingRubbing");
	
	
	// Body
	character.addFemaleParts();
	// Others
	character.names.push("Nashillbyir");
	character.names.push("the Ashwalker");
	character.names.push("the fit Human");
	character.assignFemeninePronouns();
	//character.mapAi.type = "protagonist";
	
	character.likedTopics.push("training");
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/nash-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/nash-avatar.png]]";
	}
	character.icon = function() {
		return "[img[img/charIcons/nashIcon.png]]";
	}
	
	character.fullPortraitL = "img/portraits/nash-full.png";
	character.avatarL = "img/portraits/nash-avatar.png";
	character.iconL = "img/charIcons/nashIcon.png";
	
	// AI
	character.globalAi = createCandidateGlobalAi("chNash");
	
	// Affinities
	character.combatAffinities.physical.strength += 5;
	character.combatAffinities.weapon.strength += 10;
	character.combatAffinities.weapon.resistance += 10;
	character.combatAffinities.magic.frailty += 5;
	character.combatAffinities.pain.resistance += 10;
	
	// Personality
		// Tastes
	character.tastes.foreplay.w = 95;
	character.tastes.oral.w = 90;
	character.tastes.talk.w = 105;
	character.tastes.fullsex.w = 110;
	character.tastes.useDick.w = 120;
	character.tastes.targetDick.w = 115;
	character.tastes.targetPussy.w = 110;
	character.tastes.targetAnus.w = 105;
	character.tastes.useHands.w = 110;
	character.tastes.bondage.w = 115;
	character.tastes.useLegs.w = 105;
	character.tastes.usePain.w = 110;
	character.tastes.top.w = 110;
	character.tastes.bottom.w = 105;
	character.tastes.receivePain.w = 110;
	character.tastes.useBreasts.w = 90;
	character.tastes.targetBreasts.w = 95;
	character.tastes.charm.w = 105;
	character.tastes.teasing.w = 105;
	rankSexPreferences(character.tastes);
		
	// Drives
	setDriveValues(character.dImprovement,1800,4);
	setDriveValues(character.dPleasure,650,2);
	setDriveValues(character.dLove,750,2);
	setDriveValues(character.dCooperation,900,2);
	setDriveValues(character.dDomination,450,1);
	setDriveValues(character.dAmbition,500,1);
	
	// Attributes
	character.setBaseAttributes(14,16,12,8,10,14,10,12,12);
	character.setAffinities(1.1,1.2,1,0.8,0.9,1.1,0.9,1,1);
	
	
	character.refugeRooms = [["mapTrainingGrounds","nashRoom"]];
	
	return character;
}

window.createPadmiri = function() {
	var character  = new Character("Mir","chMir");
	character.type = "candidate";
	character.race = "leirien";
	
	character.setColors("palegreen","palegreen");
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","mountDick","vinesHoldArms");
	/* ["embers","freezeFeet","sparkingRubbing"]
	character.saList.push("baKissLips","baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","coldGuts","taunt","baTease");
	*/
	character.saList.push("baKissLips","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","freezeFeet","taunt","baTease","baVineArmLock","baRelaxingScent");
	
	character.extraSocIntList.push("relaxingScent");
	
	// Body
	character.addFemaleParts();
	// Others
	character.names.push("Padmiri");
	character.names.push("the gentle Leirien");
	character.names.push("the attractive Leirien");
	character.assignFemeninePronouns();
	//character.mapAi.type = "protagonist";
	
	character.likedTopics.push("flora");
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/mir-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/mir-avatar.png]]";
	}
	
	character.icon = function() {
		return "[img[img/charIcons/mirIcon.png]]";
	}
	
	character.fullPortraitL = "img/portraits/mir-full.png";
	character.avatarL = "img/portraits/mir-avatar.png";
	character.iconL = "img/charIcons/mirIcon.png";
	
	// AI
	character.globalAi = createCandidateGlobalAi("chMir");
	
	// Affinities
	character.combatAffinities.magic.strength += 5;
	character.combatAffinities.fire.weakness += 50;
	character.combatAffinities.pain.resistance += 10;
	
	// Personality
		// Tastes
	character.tastes.foreplay.w = 110;
	character.tastes.talk.w = 105;
	character.tastes.oral.w = 115;
	character.tastes.usePussy.w = 115;
	character.tastes.targetPussy.w = 105;
	character.tastes.targetDick.w = 105;
	character.tastes.useAnus.w = 85;
	character.tastes.useMouth.w = 115;
	character.tastes.targetMouth.w = 120;
	character.tastes.targetAnus.w = 85;
	character.tastes.useBreasts.w = 110;
	character.tastes.targetBreasts.w = 105;
	character.tastes.useEyes.w = 110;
	character.tastes.targetEyes.w = 110;
	character.tastes.top.w = 115;
	character.tastes.bottom.w = 115;
	character.tastes.domination.w = 85;
	character.tastes.submission.w = 90;
	character.tastes.bondage.w = 65;
	character.tastes.charm.w = 110;
	character.tastes.draining.w = 110;
	character.tastes.romantic.w = 115;
	character.tastes.usePain.w = 70;
	character.tastes.receivePain.w = 80;
	character.tastes.denial.w = 80;
	rankSexPreferences(character.tastes);
	
	// Base mood
	character.baseMood.friendly = 0;	
	
	// Drives
	setDriveValues(character.dImprovement,900,2);
	setDriveValues(character.dPleasure,450,1);
	setDriveValues(character.dLove,750,2);
	setDriveValues(character.dCooperation,1800,4);
	setDriveValues(character.dDomination,100,0);
	setDriveValues(character.dAmbition,800,2);
	
	// Attributes
	character.setBaseAttributes(8,10,14,12,12,16,14,10,12);
	character.setAffinities(0.8,0.9,1.1,1,1,1.2,1.1,0.9,1);
	
	character.refugeRooms = [["mapTrainingGrounds","mirRoom"]];
	
	return character;
}

window.createCarine = function() {
	var character  = new Character("Claw","chClaw");
	character.type = "candidate";
	character.race = "beastkin";
	
	character.addBodypart("tail","tail");
	
	character.setColors("gold","gold");
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","biteNeck","mountDick");
	/* ["embers","freezeFeet","sparkingRubbing"]
	character.saList.push("baKissLips","baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","coldGuts","taunt","baTease");
	*/
	character.saList.push("baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","taunt","catAspect","baScratch"); // 
	
	// Body
	character.addFemaleParts();
	// Others
	character.names.push("Carine");
	character.names.push("Fiercest Claw");
	character.names.push("the fierce Beastkin");
	character.names.push("the tiger-girl");
	character.assignFemeninePronouns();
	//character.mapAi.type = "protagonist";
	
	character.likedTopics.push("fauna");
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/claw-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/claw-avatar.png]]";
	}
	character.icon = function() {
		return "[img[img/charIcons/clawIcon.png]]";
	}
	
	character.fullPortraitL = "img/portraits/claw-full.png";
	character.avatarL = "img/portraits/claw-avatar.png";
	character.iconL = "img/charIcons/clawIcon.png";
	
	// AI
	character.globalAi = createCandidateGlobalAi("chClaw");
	
	// Affinities
	character.combatAffinities.pounce.strength += 10;
	character.combatAffinities.pounce.resistance += 10;
	character.combatAffinities.magic.frailty += 10;
	character.combatAffinities.social.weakness += 10;
	character.combatAffinities.pain.strength += 10;
	
	// Personality
		// Tastes
	character.tastes.foreplay.w = 95;
	character.tastes.oral.w = 105;
	character.tastes.fullsex.w = 115;
	character.tastes.talk.w = 85;
	character.tastes.useDick.w = 115;
	character.tastes.targetDick.w = 90;
	character.tastes.targetPussy.w = 110;
	character.tastes.usePussy.w = 110;
	character.tastes.targetAnus.w = 105;
	character.tastes.useBreasts.w = 95;
	character.tastes.useMouth.w = 90;
	character.tastes.targetMouth.w = 110;
	character.tastes.useLegs.w = 105;
	character.tastes.useTail.w = 95;
	character.tastes.top.w = 110;
	character.tastes.bottom.w = 90;
	character.tastes.domination.w = 120;
	character.tastes.submission.w = 75;
	character.tastes.teasing.w = 90;
	character.tastes.romantic.w = 80;
	character.tastes.bondage.w = 110;
	character.tastes.usePain.w = 120;
	character.tastes.denial.w = 110;
	rankSexPreferences(character.tastes);
	
	// Base mood
	character.baseMood.angry = 50;
	
	// Drives
	setDriveValues(character.dImprovement,1400,3);
	setDriveValues(character.dPleasure,750,2);
	setDriveValues(character.dLove,100,0);
	setDriveValues(character.dCooperation,0,0);
	setDriveValues(character.dDomination,1800,4);
	setDriveValues(character.dAmbition,1200,3);
	
	// Attributes
	character.setBaseAttributes(16,14,10,14,12,10,8,12,12);
	character.setAffinities(1.2,1.1,0.9,1.1,1,0.9,0.8,1,1);
	
	character.refugeRooms = [["mapTrainingGrounds","clawRoom"]];
	
	return character;
}

window.createValtan = function() {
	var character  = new Character("Val","chVal");
	character.type = "candidate";
	character.race = "shapeshifter";
	
	character.setColors("cornflowerblue","cornflowerblue");
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","slimeHug","mountDick");
	/* ["embers","freezeFeet","sparkingRubbing"]
	character.saList.push("baKissLips","baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","coldGuts","taunt","baTease");
	*/
	character.saList.push("baKissLips","baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","coldGuts","baTease","embers","freezeFeet","sparkingRubbing");
	// Body
	character.addFemaleParts();
	// Others
	character.names.push("Valtan");
	character.names.push("the mischievous Shapeshifter");
	character.names.push("the cunning woman");
	character.assignFemeninePronouns();
	//character.mapAi.type = "protagonist";
	
	character.likedTopics.push("dramas");
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/val-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/val-avatar.png]]";
	}
	character.icon = function() {
		return "[img[img/charIcons/valIcon.png]]";
	}
	
	character.fullPortraitL = "img/portraits/val-full.png";
	character.avatarL = "img/portraits/val-avatar.png";
	character.iconL = "img/charIcons/valIcon.png";
	
	// AI
	character.globalAi = createCandidateGlobalAi("chVal");
	
	// Affinities
	character.combatAffinities.sex.strength += 5;
	character.combatAffinities.sex.weakness += 5;
	character.combatAffinities.physical.frailty += 10;
	character.combatAffinities.social.strength += 5;
	character.combatAffinities.seduction.strength += 5;
	
	// Personality
		// Tastes
	character.tastes.foreplay.w = 100;
	character.tastes.oral.w = 110;
	character.tastes.talk.w = 120;
	character.tastes.fullsex.w = 110;
	character.tastes.usePussy.w = 115;
	character.tastes.useDick.w = 110;
	character.tastes.targetDick.w = 105;
	character.tastes.useMouth.w = 110;
	character.tastes.targetMouth.w = 115;
	character.tastes.useEyes.w = 115;
	character.tastes.targetEyes.w = 115;
	character.tastes.useLegs.w = 110;
	character.tastes.targetAnus.w = 115;
	character.tastes.teasing.w = 115;
	character.tastes.charm.w = 110;
	character.tastes.top.w = 95;
	character.tastes.bottom.w = 95;
	character.tastes.domination.w = 110;
	character.tastes.submission.w = 110;
	character.tastes.teasing.w = 120;
	character.tastes.bondage.w = 70;
	character.tastes.denial.w = 120;
	character.tastes.romantic.w = 105;
	character.tastes.draining.w = 110;
	character.tastes.receivePain.w = 110;
	rankSexPreferences(character.tastes);
	
	// Drives
	setDriveValues(character.dImprovement,850,2);
	setDriveValues(character.dPleasure,1800,4);
	setDriveValues(character.dLove,850,2);
	setDriveValues(character.dCooperation,350,1);
	setDriveValues(character.dDomination,1200,3);
	setDriveValues(character.dAmbition,500,1);
	
	// Attributes
	character.setBaseAttributes(10,10,10,10,14,12,16,14,14);
	character.setAffinities(0.9,0.9,0.9,0.9,1.1,1,1.2,1.1,1.1);
	
	character.refugeRooms = [["mapTrainingGrounds","valRoom"]];
	
	return character;
}

window.createMaaterasu = function() {
	var character  = new Character("Ate","chAte");
	character.type = "candidate";
	character.race = "aiishen";
	
	character.setColors("mediumvioletred","palevioletred");
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","mountDick");
	/* ["embers","freezeFeet","sparkingRubbing"]
	character.saList.push("baKissLips","baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","coldGuts","taunt","baTease");
	*/
	character.saList.push("baKissLips","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","embers","freezeFeet","sparkingRubbing","lightningDarts");
	// Body
	character.addFemaleParts();
	// Others
	character.names.push("Maaterasu");
	character.names.push("the talented Aiishen");
	character.assignFemeninePronouns();
	//character.mapAi.type = "protagonist";
	
	character.likedTopics.push("music");
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/ate-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/ate-avatar.png]]";
	}
	
	character.icon = function() {
		return "[img[img/charIcons/ateIcon.png]]";
	}
	
	character.fullPortraitL = "img/portraits/ate-full.png";
	character.avatarL = "img/portraits/ate-avatar.png";
	character.iconL = "img/charIcons/ateIcon.png";
	
	// AI
	character.globalAi = createCandidateGlobalAi("chAte");
	
	// Affinities
	character.combatAffinities.physical.resistance += 10;
	character.combatAffinities.physical.frailty += 20;
	character.combatAffinities.magic.strength += 10;
	character.combatAffinities.magic.weakness += 20;
	character.combatAffinities.social.resistance += 10;
	character.combatAffinities.social.frailty += 10;
	character.combatAffinities.pain.weakness += 10;
	
	// Personality
		// Tastes
	character.tastes.foreplay.w = 105;
	character.tastes.oral.w = 105;
	character.tastes.talk.w = 95;
	character.tastes.fullsex.w = 110;
	character.tastes.useDick.w = 110;
	character.tastes.targetDick.w = 110;
	character.tastes.usePussy.w = 110;
	character.tastes.targetPussy.w = 110;
	character.tastes.useLegs.w = 105;
	character.tastes.targetLegs.w = 105;
	character.tastes.useMouth.w = 105;
	character.tastes.useEyes.w = 85;
	character.tastes.targetEyes.w = 85;
	character.tastes.top.w = 105;
	character.tastes.bottom.w = 105;
	character.tastes.domination.w = 110;
	character.tastes.submission.w = 110;
	character.tastes.hypnosis.w = 110;
	character.tastes.charm.w = 95;
	character.tastes.romantic.w = 105;
	character.tastes.usePain.w = 95;
	character.tastes.receivePain.w = 85;
	rankSexPreferences(character.tastes);
	
	// Base mood
	character.baseMood.bored = 50;
	
	// Drives
	setDriveValues(character.dImprovement,1700,4);
	setDriveValues(character.dPleasure,200,0);
	setDriveValues(character.dLove,200,0);
	setDriveValues(character.dCooperation,200,0);
	setDriveValues(character.dDomination,200,0);
	setDriveValues(character.dAmbition,850,2);
	
	// Attributes
	character.setBaseAttributes(10,12,14,10,16,14,10,10,12);
	character.setAffinities(0.9,1,1.1,0.9,1.2,1.1,0.9,0.9,1);
	
	character.refugeRooms = [["mapTrainingGrounds","ateRoom"]];
	
	return character;
}

// Artume
window.createArtume = function() {
	var character = new Character("Artume", "chArt");
	character.type = "candidate";
	
	character.setColors("mediumseagreen","mediumseagreen");
	
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","mountDick");
	
	character.saList.push("baKissLips","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","taunt","embers","freezeFeet");
	
	
	// Body
	character.addFemaleParts();
	// Others
	character.names.push("Artume");
	character.names.push("the Gaanidan huntress");
	character.names.push("the nimble ranger");
	character.assignFemeninePronouns();
	
	character.likedTopics.push("fauna");
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/artume-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/artume-avatar.png]]";
	}
	character.icon = function() {
		return "[img[img/charIcons/artIcon.png]]";
	}
	
	character.fullPortraitL = "img/portraits/artume-full.png";
	character.avatarL = "img/portraits/artume-avatar.png";
	character.iconL = "img/charIcons/artIcon.png";
	
	// AI
	character.globalAi = createCandidateGlobalAi("chArt");
	
	// Affinities
	character.combatAffinities.physical.resistance += 10;
	character.combatAffinities.weapon.strength += 5;
	character.combatAffinities.pounce.strength += 5;
	character.combatAffinities.pounce.resistance += 10;
	character.combatAffinities.sex.weakness += 5;
	character.combatAffinities.spore.resistance += 10;
	
	// Personality
		// Tastes
	character.tastes.foreplay.w = 105;
	character.tastes.fullsex.w = 110;
	character.tastes.usePussy.w = 115;
	character.tastes.useAnus.w = 105;
	character.tastes.useBreasts.w = 105;
	character.tastes.useMouth.w = 110;
	character.tastes.targetTail.w = 110;
	character.tastes.bondage.w = 120;
	character.tastes.useLegs.w = 105;
	character.tastes.usePain.w = 110;
	character.tastes.bottom.w = 110;
	character.tastes.submission.w = 120;
	character.tastes.receivePain.w = 110;
	character.tastes.draining.w = 110;
	character.tastes.hypnosis.w = 105;
	character.tastes.talk.w = 85;
	character.tastes.charm.w = 95;
	character.tastes.romantic.w = 95;
	rankSexPreferences(character.tastes);
		
	// Drives
	setDriveValues(character.dImprovement,1000,4);
	setDriveValues(character.dPleasure,1350,5);
	setDriveValues(character.dLove,600,2);
	setDriveValues(character.dCooperation,350,1);
	setDriveValues(character.dDomination,350,1);
	setDriveValues(character.dAmbition,350,1);
	
	// Attributes
	character.setBaseAttributes(10,12,12,9,11,13,10,11,11);
	character.setAffinities(0.9,1.1,1.1,0.8,1,1.2,0.9,1,1);
	
	character.refugeRooms = [["mapTrainingGrounds","storage"]];
	
	return character;
}

// Warmest Hope
window.createWarmestHope = function() {
	var character  = new Character("Hope","chHope");
	character.type = "candidate";
	character.race = "beastkin";
	
	character.addBodypart("tail","tail");
	
	character.setColors("darkorange","darkorange");
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","mountDick","biteNeck");
	/* ["embers","freezeFeet","sparkingRubbing"]
	character.saList.push("baKissLips","baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","coldGuts","taunt","baTease");
	*/
	character.saList.push("baKissLips","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","embers","freezeFeet","sparkingRubbing","coldGuts","taunt","baTease","kick","flamingFan","flaringFeint");
	// Body
	character.addFemaleParts();
	// Others
	character.names.push("Warmest Hope");
	character.names.push("Hope");
	character.names.push("the daring fox-girl");
	character.names.push("the outspoken Beastkin");
	character.names.push("Ruri");
	character.assignFemeninePronouns();
	
	character.likedTopics.push("flora","music");
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/hope-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/hope-avatar.png]]";
	}
	
	character.icon = function() {
		return "[img[img/charIcons/hopeIcon.png]]";
	}
	
	character.fullPortraitL = "img/portraits/hope-full.png";
	character.avatarL = "img/portraits/hope-avatar.png";
	character.iconL = "img/charIcons/hopeIcon.png";
	
	// AI
	character.globalAi = createCandidateGlobalAi("chHope");
	
	// Affinities
	character.combatAffinities.magic.strength += 5;
	character.combatAffinities.fire.strength += 5;
	character.combatAffinities.ice.weakness += 5;
	character.combatAffinities.social.strength += 10;
	character.combatAffinities.social.weakness += 10;
	character.combatAffinities.pain.resistance += 10;
	character.combatAffinities.pounce.strength += 5;
	character.combatAffinities.pounce.resistance += 5;
	
	// Personality
		// Tastes
	character.tastes.talk.w = 110;
	character.tastes.fullsex.w = 105;
	character.tastes.oral.w = 105;
	character.tastes.usePussy.w = 110;
	character.tastes.targetPussy.w = 105;
	character.tastes.targetDick.w = 105;
	character.tastes.targetMouth.w = 115;
	character.tastes.useMouth.w = 90;
	character.tastes.useEyes.w = 110;
	character.tastes.targetEyes.w = 105;
	character.tastes.useLegs.w = 110;
	character.tastes.top.w = 110;
	character.tastes.bottom.w = 90;
	character.tastes.domination.w = 95;
	character.tastes.submission.w = 85;
	character.tastes.charm.w = 105;
	character.tastes.teasing.w = 110;
	rankSexPreferences(character.tastes);
	
	// Base mood
	character.baseMood.dominant = 5;
	
	// Drives
	setDriveValues(character.dImprovement,1100,4);
	setDriveValues(character.dPleasure,600,2);
	setDriveValues(character.dLove,700,3);
	setDriveValues(character.dCooperation,1750,6);
	setDriveValues(character.dDomination,1100,4);
	setDriveValues(character.dAmbition,1500,5);
	
	// Attributes
	character.setBaseAttributes(12,12,10,16,14,8,10,14,12);
	character.setAffinities(1,1,0.9,1.2,1.1,0.8,0.9,1.1,1);
	
	character.refugeRooms = [["mapTrainingGrounds","publicBaths"]];
	
	return character;
}

// Sturdiest Rock
window.createSturdiestRock = function() {
	var character  = new Character("Rock","chRock");
	character.type = "candidate";
	character.race = "beastkin";
	
	character.addBodypart("tail","tail");
	
	character.setColors("cadetblue","cadetblue");
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","biteNeck","mountDick");
	
	character.saList.push("baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","taunt","baScratch","freezeFeet","earthWall","quake"); // 
	
	// Body
	character.addMaleParts();
	// Others
	character.names.push("Rock");
	character.names.push("Sturdiest Rock");
	character.names.push("the kind Beastkin");
	character.names.push("the wolf-boy");
	character.names.push("Nou");
	character.assignMasculinePronouns();
	//character.mapAi.type = "protagonist";
	
	character.likedTopics.push("fauna");
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/rock-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/rock-avatar.png]]";
	}
	character.icon = function() {
		return "[img[img/charIcons/rockIcon.png]]";
	}
	
	character.fullPortraitL = "img/portraits/rock-full.png";
	character.avatarL = "img/portraits/rock-avatar.png";
	character.iconL = "img/charIcons/rockIcon.png";
	
	// AI
	character.globalAi = createCandidateGlobalAi("chRock");
	
	// Affinities
	character.combatAffinities.pounce.strength += 5;
	character.combatAffinities.pounce.resistance += 5;
	character.combatAffinities.fire.weakness += 10;
	character.combatAffinities.magic.frailty += 10;
	character.combatAffinities.social.weakness += 5;
	character.combatAffinities.pain.resistance += 10;
	character.combatAffinities.physical.resistance += 10;
	
	// Personality
		// Tastes
	character.tastes.foreplay.w = 105;
	character.tastes.oral.w = 105;
	character.tastes.useDick.w = 110;
	character.tastes.useMouth.w = 115;
	character.tastes.targetPussy.w = 110;
	character.tastes.targetMouth.w = 90;
	character.tastes.targetEyes.w = 105;
	character.tastes.targetBreasts.w = 105;
	character.tastes.top.w = 90;
	character.tastes.bottom.w = 110;
	character.tastes.domination.w = 80;
	character.tastes.submission.w = 95;
	character.tastes.charm.w = 105;
	character.tastes.romantic.w = 110;
	character.tastes.usePain.w = 105;
	rankSexPreferences(character.tastes);
	
	// Base mood
	character.baseMood.friendly = 5;
	
	// Drives
	setDriveValues(character.dImprovement,750,3);
	setDriveValues(character.dPleasure,650,2);
	setDriveValues(character.dLove,1000,4);
	setDriveValues(character.dCooperation,1500,5);
	setDriveValues(character.dDomination,300,1);
	setDriveValues(character.dAmbition,600,2);
	
	// Attributes
	character.setBaseAttributes(16,14,10,14,12,10,8,12,12);
	character.setAffinities(1.1,1,1.2,0.9,0.9,1,1.1,0.8,1);
	
	character.refugeRooms = [["mapTrainingGrounds","storage"]];
	
	return character;
}

// Nersmias
window.createNersmias = function() {
	var character  = new Character("Nersmias","chNer");
	character.type = "candidate";
	character.race = "shapeshifter";
	
	character.setColors("MediumOrchid","MediumOrchid");
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","biteNeck","mountDick");
	
	character.saList.push("baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","taunt","freezeFeet","sparkingRubbing","embers","realHypnoticGlance","slimeHug","baHypnoticGlance","baOrderKneeling","baOrderMasturbation","baCorrodeMind"); // 
	
	// Body
	character.addMaleParts();
	// Others
	character.names.push("Nersmias");
	character.names.push("Nersmias");
	character.names.push("Nersmias");
	character.names.push("the strict priest");
	character.names.push("the dutiful Shapeshifter");
	character.names.push("the watcher of order");
	character.assignMasculinePronouns();
	//character.mapAi.type = "protagonist";
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/nersmias-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/nersmias-avatar.png]]";
	}
	character.icon = function() {
		return "[img[img/charIcons/nerIcon.png]]";
	}
	
	character.fullPortraitL = "img/portraits/nersmias-full.png";
	character.avatarL = "img/portraits/nersmias-avatar.png";
	character.iconL = "img/charIcons/nerIcon.png";
	
	// AI
	character.globalAi = createCandidateGlobalAi("chNer");
	
	// Affinities
	character.combatAffinities.seduction.resistance += 10;
	character.combatAffinities.pounce.frailty += 10;
	character.combatAffinities.ice.strength += 5;
	character.combatAffinities.hypnosis.strength += 10;
	character.combatAffinities.hypnosis.weakness += 10;
	
	// Personality
		// Tastes
	character.tastes.foreplay.w = 95;
	character.tastes.oral.w = 105;
	character.tastes.fullsex.w = 110;
	character.tastes.talk.w = 105;
	character.tastes.useDick.w = 105;
	character.tastes.useMouth.w = 105;
	character.tastes.useEyes.w = 115;
	character.tastes.useHands.w = 110;
	character.tastes.targetPussy.w = 105;
	character.tastes.targetAnus.w = 110;
	character.tastes.targetBreasts.w = 105;
	character.tastes.top.w = 105;
	character.tastes.domination.w = 110;
	character.tastes.bondage.w = 105;
	character.tastes.hypnosis.w = 115;
	character.tastes.usePain.w = 115;
	character.tastes.denial.w = 110;
	rankSexPreferences(character.tastes);
	
	// Base mood
	character.baseMood.friendly = 5;
	
	// Drives
	setDriveValues(character.dImprovement,600,2);
	setDriveValues(character.dPleasure,300,1);
	setDriveValues(character.dLove,300,1);
	setDriveValues(character.dCooperation,300,1);
	setDriveValues(character.dDomination,900,3);
	setDriveValues(character.dAmbition,1200,4);
	
	// Attributes
	character.setBaseAttributes(13,15,15,17,17,15,13,19,11);
	character.setAffinities(0.9,1,1,1.1,1.1,1,0.9,1.2,0.8);
	
	character.refugeRooms = [["mapTrainingGrounds","storage"]];
	
	return character;
}

// Mesquelles
window.createMesquelles = function() {
	var character  = new Character("Mesquelles","chMes");
	character.type = "candidate";
	character.race = "shapeshifter";
	
	character.setColors("hotpink","hotpink");
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","slimeHug","mountDick");
	
	character.saList.push("baKissLips","baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","coldGuts","baTease","taunt","embers","freezeFeet","sparkingRubbing");
	// Body
	character.addFemaleParts();
	// Others
	character.names.push("Mesquelles");
	character.names.push("Mesquelles");
	character.names.push("Mesquelles");
	character.names.push("the daydreaming Shapeshifter");
	character.names.push("the creative girl");
	character.assignFemeninePronouns();
	//character.mapAi.type = "protagonist";
	
	character.likedTopics.push("dramas");
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/mesquelles-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/mesquelles-avatar.png]]";
	}
	character.icon = function() {
		return "[img[img/charIcons/mesIcon.png]]";
	}
	
	character.fullPortraitL = "img/portraits/mesquelles-full.png";
	character.avatarL = "img/portraits/mesquelles-avatar.png";
	character.iconL = "img/charIcons/mesIcon.png";
	
	// AI
	//character.globalAi = createCandidateGlobalAi("chMes");
	
	// Affinities
	character.combatAffinities.magic.strength += 5;
	character.combatAffinities.magic.weakness += 5;
	character.combatAffinities.physical.frailty += 5;
	character.combatAffinities.physical.weakness += 5;
	character.combatAffinities.social.strength += 5;
	
	// Personality
		// Tastes
	character.tastes.foreplay.w = 105;
	character.tastes.oral.w = 105;
	character.tastes.talk.w = 115;
	character.tastes.fullsex.w = 105;
	character.tastes.usePussy.w = 105;
	character.tastes.useBreasts.w = 105;
	character.tastes.useEyes.w = 110;
	character.tastes.useHands.w = 125;
	character.tastes.useLegs.w = 115;
	character.tastes.targetDick.w = 110;
	character.tastes.targetPussy.w = 115;
	character.tastes.targetBreasts.w = 115;
	character.tastes.targetHands.w = 105;
	character.tastes.targetLegs.w = 105;
	character.tastes.teasing.w = 105;
	character.tastes.charm.w = 110;
	character.tastes.romantic.w = 105;
	character.tastes.bondage.w = 80;
	character.tastes.romantic.w = 110;
	rankSexPreferences(character.tastes);
	
	// Drives
	setDriveValues(character.dImprovement,1350,4);
	setDriveValues(character.dPleasure,1350,4);
	setDriveValues(character.dLove,600,2);
	setDriveValues(character.dCooperation,600,2);
	setDriveValues(character.dDomination,450,1);
	setDriveValues(character.dAmbition,750,2);
	
	// Attributes
	character.setBaseAttributes(12,16,10,14,16,18,14,12,14);
	character.setAffinities(0.9,1.1,0.8,1,1.1,1.2,1,0.9,0.9);
	
	character.refugeRooms = [["mapTrainingGrounds","publicBaths"]];
	
	return character;
}

// Sillan
window.createSillan = function() {
	var character  = new Character("Sillan","chSil");
	character.type = "candidate";
	character.race = "shapeshifter";
	
	character.setColors("lightskyblue","lightskyblue");
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","slimeHug","mountDick");
	
	character.saList.push("baKissLips","baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","coldGuts","baTease","taunt","embers","freezeFeet","sparkingRubbing");
	// Body
	character.addFemaleParts();
	// Others
	character.names.push("Sillan");
	character.names.push("Sillan");
	character.names.push("Sillan");
	character.names.push("the shy Shapeshifter");
	character.names.push("the selfless girl");
	character.assignFemeninePronouns();
	//character.mapAi.type = "protagonist";
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/sillan-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/sillan-avatar.png]]";
	}
	character.icon = function() {
		return "[img[img/charIcons/silIcon.png]]";
	}
	
	character.fullPortraitL = "img/portraits/sillan-full.png";
	character.avatarL = "img/portraits/sillan-avatar.png";
	character.iconL = "img/charIcons/silIcon.png";
	
	// AI
	//character.globalAi = createCandidateGlobalAi("chMes");
	
	// Affinities
	character.combatAffinities.social.strength += 5;
	character.combatAffinities.social.weakness += 5;
	
	// Personality
		// Tastes
	character.tastes.foreplay.w = 105;
	character.tastes.oral.w = 105;
	character.tastes.talk.w = 100;
	character.tastes.fullsex.w = 105;
	character.tastes.usePussy.w = 110;
	character.tastes.useBreasts.w = 105;
	character.tastes.useEyes.w = 95;
	character.tastes.useLegs.w = 105;
	character.tastes.targetDick.w = 105;
	character.tastes.targetPussy.w = 110;
	character.tastes.targetBreasts.w = 105;
	character.tastes.targetHands.w = 110;
	character.tastes.targetEyes.w = 110;
	character.tastes.top.w = 90;
	character.tastes.bottom.w = 115;
	character.tastes.submission.w = 105;
	character.tastes.domination.w = 75;
	character.tastes.charm.w = 105;
	character.tastes.romantic.w = 110;
	character.tastes.denial.w = 70;
	character.tastes.usePain.w = 70;
	rankSexPreferences(character.tastes);
	
	// Drives
	setDriveValues(character.dImprovement,450,1);
	setDriveValues(character.dPleasure,600,2);
	setDriveValues(character.dLove,1350,4);
	setDriveValues(character.dCooperation,1500,5);
	setDriveValues(character.dDomination,200,0);
	setDriveValues(character.dAmbition,650,2);
	
	// Attributes
	character.setBaseAttributes(12,14,12,10,16,16,18,14,14);
	character.setAffinities(0.9,1,0.9,0.8,1.1,1.1,1.2,1,1);
	
	character.refugeRooms = [["mapTrainingGrounds","publicBaths"]];
	
	return character;
}


// Support functions

window.teachBasicMovesToCharacters = function(charKey) {
	var movesList = ["kneel","makeKneel","lickGroin","legHoldHead","mountFromBehind","penetratePussy","thrust","getBlowjob","suckDick",
				"strokeDick","lickPussy","interlockLegs","scissor","pushHipsBack","fuckFace","rideFace"];
	for ( var move of movesList ) {
		if ( State.variables[charKey].saList.includes(move) == false ) {
			State.variables[charKey].saList.push(move);
		}
	}
}

window.setUpTestsRoom = function() {
	for ( var charKey of ["chPlayerCharacter","chNash","chMir","chClaw","chVal","chAte"] ) {
		teachBasicMovesToCharacters(charKey);
		State.variables[charKey].sortSaList();
	}	
}

window.setUpRelations = function() {
	for ( var i of ["chPlayerCharacter","chNash","chMir","chClaw","chVal","chAte"] ) {
		// Max bars
		recalculateMaxBars(i);
		// Update drives
		updateCharacterDrives(i);
		// Create relations
		for ( var l of ["chPlayerCharacter","chNash","chMir","chClaw","chVal","chAte"] ) {
			if ( i != l ) {
				gC(i).relations[l] = new Relation(l);
			}
		}
	}
	// Mir - Nash
	State.variables.chMir.relations.chNash.friendship.stv = 100;
	State.variables.chNash.relations.chMir.friendship.stv = 100;
	// Mir - Val
	State.variables.chMir.relations.chVal.friendship.stv = 100;
	State.variables.chVal.relations.chMir.friendship.stv = 100;
	State.variables.chMir.relations.chVal.sexualTension.stv = 350;
	State.variables.chVal.relations.chMir.sexualTension.stv = 350;
	State.variables.chMir.relations.chVal.submission.stv = 350;
	State.variables.chVal.relations.chMir.domination.stv = 350;
	// Mir - Claw
	State.variables.chMir.relations.chClaw.enmity.stv = 350;
	State.variables.chClaw.relations.chMir.enmity.stv = 350;
	
	// Nash - Val
	State.variables.chVal.relations.chNash.friendship.stv = 350;
	State.variables.chNash.relations.chVal.friendship.stv = 350;
	State.variables.chNash.relations.chVal.sexualTension.stv = 100;
	State.variables.chVal.relations.chNash.sexualTension.stv = 100;
	// Nash - Claw
	State.variables.chNash.relations.chClaw.sexualTension.stv = 350;
	State.variables.chClaw.relations.chNash.sexualTension.stv = 350;
	State.variables.chNash.relations.chClaw.enmity.stv = 350;
	State.variables.chClaw.relations.chNash.enmity.stv = 350;
	State.variables.chNash.relations.chClaw.rivalry.stv = 350;
	State.variables.chClaw.relations.chNash.rivalry.stv = 350;
	
	// Val - Claw
	State.variables.chVal.relations.chClaw.friendship.stv = 100;
	State.variables.chClaw.relations.chVal.friendship.stv = 100;
	State.variables.chVal.relations.chClaw.sexualTension.stv = 350;
	State.variables.chClaw.relations.chVal.sexualTension.stv = 350;
	State.variables.chVal.relations.chClaw.rivalry.stv = 350;
	State.variables.chClaw.relations.chVal.rivalry.stv = 350;
	
	feedCandidatesRelationshipGoals();
}

//////// Other NPC colors

setup.drishtyaColor = "mediumvioletred";
setup.catriaColor = "peachpuff"; // Leap, Claw's mother

setup.meleshColor = "mediumaquamarine"; // Shapeshifter green genderfluid judge
setup.seeriaColor = "palevioletred"; // Shapeshifter purple female judge



 // Both vectors (frie,inti,flir,arou,domi,subm,bore,angr) (frie,sext,roma,domi,subm,riva,enmi)
///// MOOD VECTOR /////
// Vector containing mood data. Custom functions to sum mood vector and multiplying them by a given factor

window.MoodVector = function(frie,inti,flir,arou,domi,subm,bore,angr) {
	this.friendly = frie;
	this.intimate = inti;
	this.flirty = flir;
	this.aroused = arou;
	this.dominant = domi;
	this.submissive = subm;
	this.bored = bore;
	this.angry = angr;
}

window.sumMoodVectors = function(mv1,mv2) {
	var mVector = new MoodVector(mv1.friendly + mv2.friendly , mv1.intimate + mv2.intimate , mv1.flirty + mv2.flirty , mv1.aroused + mv2.aroused,
								 mv1.dominant + mv2.dominant , mv1.submissive + mv2.submissive , mv1.bored + mv2.bored , mv1.angry + mv2.angry );
	return mVector;
}

window.moodVectorXFactor = function(mv,factor) {
	var mVector = new MoodVector(mv.friendly * factor , mv.intimate * factor , mv.flirty * factor , mv.aroused * factor , mv.dominant * factor,
								 mv.submissive * factor , mv.bored * factor , mv.angry * factor );
	return mVector;
}

///// RELATION VECTOR /////

window.RelationVector = function(frie,sext,roma,domi,subm,riva,enmi) {
	this.friendship = frie;
	this.sexualTension = sext;
	this.romance = roma;
	this.domination = domi;
	this.submission = subm;
	this.rivalry = riva;
	this.enmity = enmi;
}

window.sumRelationVectors = function(rv1,rv2) {
	var rVector = new RelationVector(rv1.friendship + rv2.friendship , rv1.sexualTension + rv2.sexualTension , rv1.romance + rv2.romance ,
				rv1.domination + rv2.domination , rv1.submission + rv2.submission , rv1.rivalry + rv2.rivalry , rv1.enmity + rv2.enmity );
	return rVector;
}

window.relationVectorXFactor = function(rv,factor) {
	var rVector = new RelationVector(rv.friendship * factor , rv.sexualTension * factor , rv.romance * factor , rv.domination * factor ,
									 rv.submission * factor , rv.rivalry * factor , rv.enmity * factor );
	return rVector;
}

// frie,inti,flir,arou,domi,subm,bore,angr
// frie,sext,roma,domi,subm,riva,enmi
///// SOCIAL INTERACTIONS DATA /////

window.SocInt = function() {
	this.key = "key";
	this.title = "title";
	
	this.actor = null;
	this.target = null;
	this.observers = null;
	this.extraData = null;
	this.sis = null;
	
	this.tags = [];
	this.driveTags = [];
	this.strategyTags = [];
	this.socialDriveCost = 0;
	this.energyCost = 0;
	this.willpowerCost = 0;
	this.priority = 0;
	
	this.weight = 0;
	
	this.topic = "none";
	
	this.socIntDescription = "Description has not been set. Report this to Deep Interactivity.";
	
	this.isValid = function(sis,actor,target,observers,extraData) { return 0; }
		// Determines if the interaction may be granted to the player at the start of the round
	this.isUsable = function(sis,actor,target,observers,extraData) {
		// Determines if the interaction is usable on the selected target
		var flagUsable = false;
		if ( gC(actor).socialdrive.current >= this.socialDriveCost && gC(actor).energy.current >= this.energyCost && gC(actor).willpower.current >= this.willpowerCost ) {
			flagUsable = true;
		}
		return flagUsable;
	}
	this.getWeight = function(sis,actor,target,observers,extraData) { return 0; }
	
	this.calculateExtraEffect = function() { return null; }
	this.extraEffect = null;
	this.evaluateSuccess = function(actor,target,topic) { // Function for AI: It evalues the chance of the interaction's extra effect being successful.
		return true;
	}
	
	this.getMoodMultiplier = function() { return 1; }
	this.getMoodVectorTarget = function() { return null; }
	this.getMoodVectorActor = function() { return null; }
	this.getMoodVectorObservers = function() { return null; }
	
	this.getRelationMultiplier = function() { return 1; }
	this.getRelationVectorTarget = function() { return null; }
	this.getRelationVectorActor = function() { return null; }
	this.getRelationVectorObservers = function() { return null; }
	
	this.getLustDamage = function(actor,target) { return 0; }
	this.getWillpowerDamage = function(actor,target) { return 0; }
	this.getEnergyDamage = function(actor,target) { return 0; }
	this.furtherEffects = function(sis) { return 0; }
	
	this.getDescription = function() {
		//var desc = '<span style="color:darkgray"'+'>[' + this.title + ']</'+'span> ';
		var desc = "[" + this.title + "] ";
		   desc += gC(this.actor).formattedName + " -> " + gC(this.target).formattedName;
		return desc;
	}
}

// Create Social Interactions

	// Chat
window.getChatSocInt = function(type) {
	var socInt = new SocInt();
	socInt.key = "chat";
	socInt.title = "Chat";
	socInt.tags.push("friendly");
	socInt.socialDriveCost = 1;
	
	socInt.topic = type;
	socInt.weight = 10; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).mood.angry < 30 && gC(actor).mood.aroused < 60 && gC(actor).hasFreeBodypart("mouth") ) {
			flagValid = true;
		}
		return flagValid;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight;
		nWeight += (gC(actor).mood.friendly * 0.1);
		nWeight -= (gC(actor).mood.angry * 0.2);
		nWeight -= (gC(actor).mood.aroused * 0.1);
		return nWeight;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(2,0,0,0,0,0,0,0);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(1,0,0,0,0,0,0,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(1,0,0,0,0,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.01);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(2,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ (ktn(this.actor) + " commented some things about " + this.topic + ".") ,
								     (ktn(this.actor) + " and the others chatted about " + this.topic + ".") ,
								     (ktn(this.actor) + " asked the rest about " + this.topic + ".") ] );
		return desc;
	}
	
	switch(type) {
		case "weather":
		socInt.key += "Weather";
		socInt.title += " about weather";
			break;
		case "routine":
		socInt.key += "Routine";
		socInt.title += " about routine";
			break;
		case "feelings":
		socInt.key += "Feelings";
		socInt.title += " about feelings";
		socInt.tags.push("intimate");
		socInt.driveTags.push("dLove");
		socInt.calculateExtraEffect = function() {
			if ( gC(this.actor).mood.intimate > 50 || gC(this.actor).mood.angry > 30 ) {
				this.getDescription = function() {
					var desc = (ktn(this.actor) + " made a great effort to explain " + gC(this.actor).posPr + " feelings.");
					return desc;
				}
				this.getMoodVectorTarget = function() {
					var mVector = new MoodVector(2,2,0,0,0,0,-1,-1);
					return mVector;
				}
				this.getMoodVectorObservers = function() {
					var mVector = new MoodVector(2,2,0,0,0,0,-1,-1);
					return mVector;
				}
				this.getRelationVectorTarget = function() {
					var rVector = new RelationVector(3,0,3,0,0,-1,-1);
					return rVector;
				}
				this.getRelationVectorObservers = function() {
					var rVector = new RelationVector(2,0,2,0,0,-1,-1);
					return rVector;
				}
			}
		}
			break;
		case "activities":
		socInt.key += "Activities";
		socInt.title += " about activities";
			break;
	}
	return socInt;
}

	// Greet
window.getGreetSocInt = function(type) {
	var socInt = new SocInt();
	socInt.key = "greet";
	socInt.title = "Greet";
	socInt.socialDriveCost = 2;
	socInt.priority = 5;
	
	socInt.topic = type;
	socInt.weight = 50; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( State.variables.compass.sisList[sis.key].roundsCount < 1 && gC(actor).hasFreeBodypart("mouth") ) {
			flagValid = true;
		}
		return flagValid;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		return this.weight;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.04);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(3,0,0,0,0,0,0,0);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(1,0,0,0,0,0,0,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(3,0,0,0,0,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(2,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}

	switch(type) {
		case "friendly":				// Friendly
		socInt.key = "greetFriendly";
		socInt.title = "Friendly greet";
		socInt.tags.push("friendly");
		
		socInt.getWeight = function(sis,actor,target,observers,extraData) {
			return this.weight + gC(actor).mood.friendly * 0.5 + gC(actor).mood.intimate * 0.2 - gC(actor).mood.angry;
		}
		// Moods
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(3,0,0,0,0,0,0,-1);
			return mVector;
		}
		socInt.getMoodVectorActor = function() {
			var mVector = new MoodVector(1,0,0,0,0,0,0,-1);
			return mVector;
		}
		socInt.getMoodVectorObservers = function() {
			var mVector = new MoodVector(3,0,0,0,0,0,0,-1);
			return mVector;
		}
		// Relations
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(2,0,0,0,0,0,0);
			return rVector;
		}
		socInt.getRelationVectorActor = function() {
			var rVector = new RelationVector(1,0,0,0,0,0,0);
			return rVector;
		}
		socInt.getRelationVectorObservers = function() {
			var rVector = new RelationVector(1,0,0,0,0,0,0);
			return rVector;
		}
		socInt.getDescription = function() {
			var desc = "";
			var sisID = State.variables.compass.findFirstSisIdInvolvingCharacter(this.actor);
			if ( State.variables.compass.sisList[sisID].charList > 2 ) {
				desc = ktn(this.actor) + " greeted everyone.";
			} else {
				desc = ktn(this.actor) + " greeted " + ktn(this.target) + ".";
			}
			return desc;
		}
			break;
		case "warm":					// Warm
		socInt.key = "greetWarm";
		socInt.title = "Warm greet";
		socInt.tags = ["friendly","intimate"];
		socInt.socialDriveCost = 3;
	
		socInt.getWeight = function(sis,actor,target,observers,extraData) {
			return this.weight + gC(actor).mood.intimate * 0.5 + gC(actor).mood.friendly * 0.2 - gC(actor).mood.angry;
		}
		// Moods
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(2,2,0,0,0,0,0,-1);
			return mVector;
		}
		socInt.getMoodVectorActor = function() {
			var mVector = new MoodVector(1,2,0,0,0,0,0,-1);
			return mVector;
		}
		socInt.getMoodVectorObservers = function() {
			var mVector = new MoodVector(2,0,0,0,0,0,0,-1);
			return mVector;
		}
		// Relations
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(1,0,2,0,0,-1,-1);
			return rVector;
		}
		socInt.getRelationVectorActor = function() {
			var rVector = new RelationVector(1,0,1,0,0,-1,-1);
			return rVector;
		}
		socInt.getRelationVectorObservers = function() {
			var rVector = new RelationVector(1,0,0,0,0,0,0);
			return rVector;
		}
		socInt.getDescription = function() {
			var desc = randomFromList( [ (ktn(this.actor) + " hugged " + ktn(this.target) + ".") ,
										 (ktn(this.actor) + " held " + ktn(this.target) + "'s hands in salute.") ] );
			return desc;
		}
			break;
		case "flirtatious":				// Flirtatious
		socInt.key = "greetFlirtatious";
		socInt.title = "Flirty greet";
		socInt.tags = ["flirty"];
		socInt.driveTags.push("dPleasure");
		socInt.socialDriveCost = 3;
	
		socInt.getWeight = function(sis,actor,target,observers,extraData) {
			return this.weight + gC(actor).mood.flirty * 0.5 + gC(actor).mood.aroused * 0.2 - gC(actor).mood.angry * 0.5
							   + gC(actor).mood.dominant * 0.5;
		}
		// Moods
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(1,0,3,1,0,0,0,-1);
			return mVector;
		}
		socInt.getMoodVectorActor = function() {
			var mVector = new MoodVector(0,0,1,1,0,0,0,0);
			return mVector;
		}
		socInt.getMoodVectorObservers = function() {
			var mVector = new MoodVector(0,0,0,1,0,0,0,0);
			return mVector;
		}
		// Relations
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(0,2,1,0,0,0,0);
			return rVector;
		}
		socInt.getRelationVectorActor = function() {
			var rVector = new RelationVector(0,1,1,0,0,0,0);
			return rVector;
		}
		socInt.getRelationVectorObservers = function() {
			var rVector = new RelationVector(0,1,0,0,0,0,0);
			return rVector;
		}
		socInt.getDescription = function() {
			var desc = randomFromList( [ (ktn(this.actor) + " greeted " + ktn(this.target) + " with a spicy compliment.") ,
										 (ktn(this.actor) + " whispered something in " + ktn(this.target) + "'s ear when " + gC(this.actor).perPr
									   + " joined the conversation.") ] );
			return desc;
		}
			break;
		case "sad":						// Sad
		socInt.key = "greetSad";
		socInt.title = "Sad greet";
		socInt.tags = ["intimate","submissive"];
		socInt.getWeight = function(sis,actor,target,observers,extraData) {
			return this.weight + gC(actor).mood.bored * 0.5 + gC(actor).mood.angry * 0.5;
		}
		// Moods
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(0,2,0,0,2,0,0,-2);
			return mVector;
		}
		socInt.getMoodVectorActor = function() {
			var mVector = new MoodVector(0,2,0,0,0,2,0,0);
			return mVector;
		}
		socInt.getMoodVectorObservers = function() {
			var mVector = new MoodVector(0,0,0,0,0,0,0,-1);
			return mVector;
		}
		// Relations
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(1,0,1,2,0,0,-1);
			return rVector;
		}
		socInt.getRelationVectorActor = function() {
			var rVector = new RelationVector(0,0,1,0,2,0,-1);
			return rVector;
		}
		socInt.getRelationVectorObservers = function() {
			var rVector = new RelationVector(1,0,0,0,0,-1,0);
			return rVector;
		}
		socInt.getDescription = function() {
			var desc = randomFromList( [ (ktn(this.actor) + " greeted everyone with something in " + gC(this.actor).posPr + " eye.") ,
										 (ktn(this.actor) + " had a meek expression when " + gC(this.actor).perPr + " joined the conversation.") ] );
			return desc;
		}
			break;
		case "cold":					// Cold
		socInt.key = "greetCold";
		socInt.title = "Cold greet";
		socInt.tags = ["angry"];
		socInt.getWeight = function(sis,actor,target,observers,extraData) {
			return this.weight + gC(actor).mood.angry - gC(actor).mood.friendly * 0.5 - gC(actor).mood.intimate * 0.5;
		}
		// Moods
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(-2,-2,-2,-2,0,0,1,1);
			return mVector;
		}
		socInt.getMoodVectorActor = function() {
			var mVector = new MoodVector(-1,-1,-1,-1,0,-2,2,1);
			return mVector;
		}
		socInt.getMoodVectorObservers = function() {
			var mVector = new MoodVector(-1,-1,-1,-1,0,0,0,0);
			return mVector;
		}
		// Relations
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(-1,-1,0,-1,0,1,1);
			return rVector;
		}
		socInt.getRelationVectorActor = function() {
			var rVector = new RelationVector(-1,0,0,0,-1,1,1);
			return rVector;
		}
		socInt.getRelationVectorObservers = function() {
			var rVector = new RelationVector(0,0,0,0,0,0,0);
			return rVector;
		}
		socInt.getDescription = function() {
			var desc = randomFromList( [ (ktn(this.actor) + " greeted " + ktn(this.target) + " with contempt.") ,
										 (ktn(this.actor) + " saluted " + ktn(this.target) + " like you would salute villanous scum.") ,
										 (ktn(this.actor) + " greeted " + ktn(this.target) + " with a tense expression.") ] );
			return desc;
		}
			break; 
		case "respectful":				// Respectful
		socInt.key = "greetRespectful";
		socInt.title = "Respectful greet";
		socInt.tags = ["submissive"];
		socInt.getWeight = function(sis,actor,target,observers,extraData) {
			return this.weight + gC(actor).mood.submissive * 1.2;
		}
		// Moods
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(2,0,0,0,2,-2,0,-2);
			return mVector;
		}
		socInt.getMoodVectorActor = function() {
			var mVector = new MoodVector(1,0,0,0,-2,2,0,-2);
			return mVector;
		}
		socInt.getMoodVectorObservers = function() {
			var mVector = new MoodVector(0,0,0,0,-1,1,0,-1);
			return mVector;
		}
		// Relations
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(1,0,1,3,-1,-1,-1);
			return rVector;
		}
		socInt.getRelationVectorActor = function() {
			var rVector = new RelationVector(1,1,0,-1,2,-1,-1);
			return rVector;
		}
		socInt.getRelationVectorObservers = function() {
			var rVector = new RelationVector(0,0,0,0,0,0,0);
			return rVector;
		}
		socInt.getDescription = function() {
			var desc = randomFromList( [ (ktn(this.actor) + " bowed " + gC(this.actor).posPr + " head to " + ktn(this.target) + ".") ,
										 (ktn(this.actor) + " made a reverence to " + ktn(this.target) + "." ) ] );
			return desc;
		}	
			break;
	}
	return socInt;
}

	// Talk about
window.getTalkAboutSocInt = function(type) {
	var socInt = new SocInt();
	socInt.key = "talkAbout" + firstToCap(type);
	socInt.title = "Talk about " + type;
	socInt.socialDriveCost = 1;
	socInt.priority = 0;
	socInt.tags.push("friendly");
	
	socInt.topic = type;
	socInt.weight = 10; // Starting weight
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ (ktn(this.actor) + " shared some thoughts about " + this.topic + ".") ,
									 (ktn(this.actor) + " asked " + ktn(this.target) + " about " + this.topic + ".") ,
									 (ktn(this.actor) + " talked about " + this.topic + " in detail.") ] );
		return desc;
	}
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).hasFreeBodypart("mouth") ) {
			flagValid = true;
		}
		return flagValid;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		return this.weight;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(2,0,0,0,0,0,0,0);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(1,0,0,0,0,0,0,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(2,0,0,0,0,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(2,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}
	
	socInt.calculateExtraEffect = function() {
		if ( gC(this.target).likedTopics.includes(this.topic) ) {
			this.getDescription = function() {
				var desc = (ktn(this.actor) + " wanted to discuss about " + this.topic + ". " + ktn(this.target) + " loved to talk "
						 + "about one of " + gC(this.actor).posPr + " passions.");
				return desc;
			}
			this.getMoodVectorTarget = function() {
				var mVector = new MoodVector(4,2,0,0,0,0,-4,-2);
				return mVector;
			}
			this.getRelationVectorTarget = function() {
				var rVector = new RelationVector(4,0,2,0,0,0,-2);
				return rVector;
			}
		}
	}
	
	return socInt;
}

	// Gossip about
window.getGossipAbout = function(charKey,name) {
	var socInt = new SocInt();
	socInt.key = "gossipAbout" + firstToCap(charKey);
	socInt.title = "Gossip about " + name;
	socInt.socialDriveCost = 2;
	socInt.priority = 0;
	socInt.tags.push("friendly");
	
	socInt.topic = charKey;
	socInt.weight = 2; // Starting weight
	
	socInt.getDescription = function() {
		var desc = ktn(this.actor) + " asks " + ktn(this.target) + " about her opinion on " + ktn(this.topic) + " and " + gC(this.target).perPr
				 + " eagerly speaks " + gC(this.target).posPr + " mind.\n";
		desc	+= "__" + gC(this.target).getName() + "'s thoughts on " + gC(this.topic).getName() + "__\n";
		desc	+= getRelationshipDescription(this.target,this.topic)[0] + "\n";
		var rpNames = [ "Friendship", "Sexual Tension", "Romance", "Domination", "Submission", "Rivalry", "Enmity" ];
		var i = 0;
		for ( var relPar in gC(this.target).relations[this.topic] ) {
			if ( gC(this.target).relations[this.topic][relPar] instanceof RelPar ) {
				desc += rpNames[i] + " - Lvl: " + gC(this.target).relations[this.topic][relPar].level;
				var levelMod = gC(this.target).relations[this.topic][relPar].levelMod;
				if ( levelMod > 0 ) {
					desc += "+" + levelMod;
				} else if ( levelMod < 0 ) {
					desc += "-" + -levelMod;
				}
				desc += ">("
				      + formulaRelParTotalLevel(gC(this.target).relations[this.topic][relPar]) + ")"
				      + " | ST: " + gC(this.target).relations[this.topic][relPar].stv.toFixed(1)
				      + " (" + colorText((gC(this.target).relations[this.topic][relPar].stv * 0.05).toFixed(1),"red") + ")"
				      + " | LT: " + gC(this.target).relations[this.topic][relPar].ltv.toFixed(1)
				      + " (" + colorText((gC(this.target).relations[this.topic][relPar].stv * 0.01).toFixed(1),"green") + ")";
				if ( i < 6 ) { desc += "\n"; }
				i++;
			}
		}
		
		return desc;
	}

	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = true;
		if ( sis.charList.includes(this.topic) || ( gC(actor).hasFreeBodypart("mouth") == false ) ) {
			flagValid = false;
		}
		return flagValid;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight + gC(actor).mood.friendly * 0.03 + gC(actor).mood.intimate * 0.05;
		return this.weight;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(1,2,0,0,0,0,-1,0);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(1,1,0,0,0,0,-2,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,1,0,0,0,0,-2,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	return socInt;
}

	// Praise CHARACTER
window.getPraiseChar = function(charKey,name) {
	var socInt = new SocInt();
	socInt.key = "praiseChar" + firstToCap(charKey);
	socInt.title = "Praise " + name;
	socInt.socialDriveCost = 2;
	socInt.priority = 0;
	socInt.tags.push("friendly");
	
	socInt.topic = charKey;
	socInt.weight = 2; // Starting weight
	
	socInt.getDescription = function() {
		var desc = randomFromList( [
						(ktn(this.actor) + " speaks highly of " + ktn(this.topic) + ", hoping to persuade " + ktn(this.target) + " about " + gC(this.topic).posPr + " virtues."),
						(ktn(this.actor) + " comments that " + gC(this.actor).perPr + " holds " + ktn(this.topic) + " in high esteem."),
						(ktn(this.actor) + " only has nice words for " + ktn(this.topic) + ".") ] );
		desc += "\n" + ktn(this.target) + "'s opinion about " + ktn(this.topic) + " improved."
		
		return desc;
	}

	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = true;
		if ( sis.charList.includes(this.topic) || ( gC(actor).hasFreeBodypart("mouth") == false ) ) {
			flagValid = false;
		}
		return flagValid;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight + gC(actor).mood.friendly * 0.03 + gC(actor).mood.intimate * 0.05;
		return this.weight;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(1,2,0,0,0,0,-1,0);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(1,1,0,0,0,0,0,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(1,0,0,0,0,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	socInt.calculateExtraEffect = function() {
		var score = 0;
		// Does the target dislike the actor or the topic too much?
		score += rLvlAbt(this.target,this.actor,"friendship") * 1 + rLvlAbt(this.target,this.actor,"romance") * 1 - rLvlAbt(this.target,this.actor,"rivalry") * 1 - rLvlAbt(this.target,this.actor,"enmity") * 2;
		if ( gC(this.target).relations.hasOwnProperty(this.topic) ) {
			score += (rLvlAbt(this.target,this.topic,"friendship") * 1 + rLvlAbt(this.target,this.topic,"romance") * 1 - rLvlAbt(this.target,this.topic,"rivalry") * 1 - rLvlAbt(this.target,this.topic,"enmity") * 2) * (0.8 + limitedRandom(0.7));
		}
		
		if ( score >= 0 ) {
			// Success
			if ( gC(this.target).relations.hasOwnProperty(this.topic) ) {
				gC(this.target).relations[this.topic].friendship.stv += 5 + gC(this.actor).charisma.getValue() * 0.05;
				gC(this.target).relations[this.topic].enmity.stv -= 1 + gC(this.actor).charisma.getValue() * 0.02;
			}
		} else {
			// Failure
			this.getDescription = function() {
				var desc = (ktn(this.actor) + " spoke highly of " + ktn(this.topic) + ", but " + ktn(this.target) + " doesn't look convinced.\n" + ktn(this.target) + "'s opinion about " + ktn(this.topic) + " worsened.");
				return desc;
			}
			this.getMoodVectorTarget = function() {
				var mVector = new MoodVector(0,0,0,0,0,0,2,0);
				return mVector;
			}
			this.getRelationVectorTarget = function() {
				var rVector = new RelationVector(-1,0,0,0,0,0,0);
				return rVector;
			}
			if ( gC(this.target).relations.hasOwnProperty(this.topic) ) {
				gC(this.target).relations[this.topic].friendship.stv -= 2 + gC(this.actor).charisma.getValue() * 0.02;
				gC(this.target).relations[this.topic].enmity.stv += 2 + gC(this.actor).charisma.getValue() * 0.02;
			}
		}
	}
	socInt.evaluateSuccess = function(actor,target,topic) {
		var flagSuccess = false;
		var score = rLvlAbt(target,actor,"friendship") * 1 + rLvlAbt(target,actor,"romance") * 1 - rLvlAbt(target,actor,"rivalry") * 1 - rLvlAbt(target,actor,"enmity") * 2;
		score += limitedRandomInt(10) - 5;
		if ( score >= 0 ) { flagSuccess = true; }
		return flagSuccess;
	}
	
	return socInt;
}
	
	// Criticize CHARACTER
window.getCriticizeChar = function(charKey,name) {
	var socInt = new SocInt();
	socInt.key = "criticizeChar" + firstToCap(charKey);
	socInt.title = "Criticize " + name;
	socInt.socialDriveCost = 2;
	socInt.priority = 0;
	socInt.tags.push("angry");
	
	socInt.topic = charKey;
	socInt.weight = 2; // Starting weight
	
	socInt.getDescription = function() {
		var desc = randomFromList( [
						(ktn(this.actor) + " speaks ill of " + ktn(this.topic) + "."),
						(ktn(this.actor) + " complains about " + ktn(this.topic) + "'s attitude."),
						(ktn(this.actor) + " criticizes " + ktn(this.topic) + " behind " + gC(this.topic).posPr + " back.") ] );
		desc += "\n" + ktn(this.target) + "'s opinion about " + ktn(this.topic) + " worsened."
		
		return desc;
	}

	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = true;
		if ( sis.charList.includes(this.topic) || ( gC(actor).hasFreeBodypart("mouth") == false ) ) {
			flagValid = false;
		}
		return flagValid;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight + gC(actor).mood.friendly * 0.02 + gC(actor).mood.intimate * 0.03 + gC(actor).mood.bored * 0.02 + gC(actor).mood.angry * 0.01;
		return this.weight;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(1,0,0,0,0,0,-1,-1);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(1,0,0,0,0,0,1,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,0,0,0,1,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02); 
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	socInt.calculateExtraEffect = function() {
		var score = 0;
		// Does the target dislike the actor or the topic too much?
		score += rLvlAbt(this.target,this.actor,"friendship") * 1 + rLvlAbt(this.target,this.actor,"romance") * 1 - rLvlAbt(this.target,this.actor,"rivalry") * 1 - rLvlAbt(this.target,this.actor,"enmity") * 2;
		if ( gC(this.target).relations.hasOwnProperty(this.topic) ) {
			score -= (rLvlAbt(this.target,this.topic,"friendship") * 1 + rLvlAbt(this.target,this.topic,"romance") * 1 - rLvlAbt(this.target,this.topic,"rivalry") * 1 - rLvlAbt(this.target,this.topic,"enmity") * 2) * (0.8 + limitedRandom(0.7));
		}
		
		if ( score >= 0 ) {
			// Success
			if ( gC(this.target).relations.hasOwnProperty(this.topic) ) {
				gC(this.target).relations[this.topic].friendship.stv -= 2 + gC(this.actor).charisma.getValue() * 0.03;
				gC(this.target).relations[this.topic].enmity.stv += 4 + gC(this.actor).charisma.getValue() * 0.04;
				gC(this.target).relations[this.topic].rivalry.stv += 2 + gC(this.actor).charisma.getValue() * 0.02;
			}
		} else {
			// Failure
			this.getDescription = function() {
				var desc = (ktn(this.actor) + " denounced " + ktn(this.topic) + ", but " + ktn(this.target) + " doesn't look convinced.\n" + ktn(this.target) + "'s opinion about " + ktn(this.topic) + " improved slightly.");
				return desc;
			}
			this.getMoodVectorTarget = function() {
				var mVector = new MoodVector(0,0,0,0,0,0,2,2);
				return mVector;
			}
			this.getRelationVectorTarget = function() {
				var rVector = new RelationVector(-2,0,0,0,0,1,1);
				return rVector;
			}
			if ( gC(this.target).relations.hasOwnProperty(this.topic) ) {
				gC(this.target).relations[this.topic].friendship.stv += 1 + gC(this.actor).charisma.getValue() * 0.01;
			}
		}
	}
	socInt.evaluateSuccess = function(actor,target,topic) {
		var flagSuccess = false;
		var score = rLvlAbt(target,actor,"friendship") * 1 + rLvlAbt(target,actor,"romance") * 1 - rLvlAbt(target,actor,"rivalry") * 1 - rLvlAbt(target,actor,"enmity") * 2;
		if ( gC(target).relations.hasOwnProperty(topic) ) {
			score -= (rLvlAbt(target,topic,"friendship") * 1 + rLvlAbt(target,topic,"romance") * 1 - rLvlAbt(target,topic,"rivalry") * 1 - rLvlAbt(target,topic,"enmity") * 2) * (0.8 + limitedRandom(0.7));
		}
		score += limitedRandomInt(10) - 5;
		if ( score >= 0 ) { flagSuccess = true; }
		return flagSuccess;
	}
	
	return socInt;
}

	// Ask about values
window.getAskAboutValues = function(type) {
	var socInt = new SocInt();
	socInt.key = "askAboutValues";
	socInt.title = "Ask about values";
	socInt.socialDriveCost = 3;
	socInt.priority = 0;
	socInt.tags.push("intimate");
	
	socInt.topic = "none";
	socInt.weight = 5; // Starting weight
						// TO DO: Change back
	
				 // Both vectors (frie,inti,flir,arou,domi,subm,bore,angr) (frie,sext,roma,domi,subm,riva,enmi)
	
	socInt.getDescription = function() {
		var desc = ktn(this.actor) + " asks " + ktn(this.target) + " about " + gC(this.target).posPr + " values and " + gC(this.target).perPr + " shares " + gC(this.target).posPr + " thoughts.\n";
		desc += textCharactersDrives(this.target);
		
		return desc;
	}

	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).hasFreeBodypart("mouth") ) {
			flagValid = true;
		}
		return flagValid;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight + gC(actor).mood.friendly * 0.05 + gC(actor).mood.intimate * 0.15 - gC(actor).mood.angry * 0.10 - gC(actor).mood.bored * 0.05;
		return this.weight;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(1,2,0,0,0,0,-2,0);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(1,1,0,0,0,0,-2,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,1,0,0,0,0,-1,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(1,0,2,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,0,1,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	socInt.calculateExtraEffect = function() {
		var successVars = gC(this.target).mood.friendly + gC(this.target).mood.intimate * 2 + rLvlAbt(this.target,this.actor,"friendship") * 10 + rLvlAbt(this.target,this.actor,"romance") * 10;
		// Base difficulty: 25
		var failureVars = 25 + gC(this.target).mood.angry * 4 + gC(this.target).mood.bored * 2 + rLvlAbt(this.target,this.actor,"enmity") * 20;
		if ( failureVars > successVars ) {
			this.getDescription = function() {
				var desc = (ktn(this.target) + " does not wish to discuss " + gC(this.target).posPr + " values. " + firstToCap(gC(this.target).perPr) + " may reconsider it if " + gC(this.target).perPr + " was in a better mood.");
				desc 	+= " (" + successVars.toFixed(2) + " vs " + failureVars.toFixed(2) + ")";
				return desc;
			}
			this.getMoodVectorTarget = function() {
				var mVector = new MoodVector(-1,-2,-1,-1,0,-1,2,0);
				return mVector;
			}
			this.getMoodVectorActor = function() {
				var mVector = new MoodVector(0,0,0,0,0,0,1,0);
				return mVector;
			}
			this.getMoodVectorObservers = function() {
				var mVector = new MoodVector(0,0,0,0,0,0,2,0);
				return mVector;
			}
			this.getRelationVectorTarget = function() {
				var rVector = new RelationVector(0,0,0,0,-1,0,0);
				return rVector;
			}
			this.getRelationVectorActor = function() {
				var rVector = new RelationVector(0,0,0,0,0,0,0);
				return rVector;
			}
			this.getRelationVectorObservers = function() {
				var rVector = new RelationVector(0,0,0,0,0,0,0);
				return rVector;
			}
		}
	}
	socInt.evaluateSuccess = function(actor,target,topic) {
		var flagSuccess = false;
		var score = gC(target).mood.friendly + gC(target).mood.intimate * 2 + rLvlAbt(target,actor,"friendship") * 10 + rLvlAbt(target,actor,"romance") * 10 - (25 + gC(target).mood.angry * 4 + gC(target).mood.bored * 2 + rLvlAbt(target,actor,"enmity") * 20);
		score += limitedRandomInt(20) - 10;
		if ( score >= 0 ) { flagSuccess = true; }
		return flagSuccess;
	}
	return socInt;
}


	// Compliment
window.getComplimentSocInt = function(type) {
	var socInt = new SocInt();
	socInt.key = "compliment" + firstToCap(type);
	socInt.title = "Compliment " + type;
	socInt.socialDriveCost = 2;
	socInt.priority = 0;
	
	socInt.topic = type;
	socInt.weight = 5; // Starting weight
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ (ktn(this.actor) + " only has great things to say about " + ktn(this.target) + "'s " + this.topic + ".") ,
								     (ktn(this.actor) + " complimented " + ktn(this.target) + "'s " + this.topic + ".") ,
									 (ktn(this.actor) + " praised " + ktn(this.target) + "'s " + this.topic + " like " + gC(this.actor).posPr
									+ " life depended on it.") ] );
		return desc;
	}
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).hasFreeBodypart("mouth") ) {
			flagValid = true;
		}
		return flagValid;
	}
	
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight + gC(actor).mood.friendly * 0.05 + gC(actor).mood.intimate * 0.05 + gC(actor).mood.flirty * 0.05
					  - gC(actor).mood.angry * 0.05 - gC(actor).mood.bored * 0.05;
		return nWeight;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.04);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(3,1,0,0,0,0,0,-1);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(2,0,0,0,0,0,0,-1);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,0,0,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.04);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(3,0,1,0,0,-1,-1);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,0,0,0,0,-1,-1);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	
	switch(type) {
		case "mood":				// Friendly
		//socInt.key += "Mood";
		socInt.title = "Compliment mood";
		socInt.tags.push("friendly");
		socInt.driveTags.push("dCooperation");
		// Mood
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(3,0,0,0,0,0,0,-1);
			return mVector;
		}
		socInt.getMoodVectorActor = function() {
			var mVector = new MoodVector(2,0,0,0,0,0,0,-1);
			return mVector;
		}
		socInt.getMoodVectorObservers = function() {
			var mVector = new MoodVector(1,0,0,0,0,0,0,-1);
			return mVector;
		}
		// Relations
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(3,0,0,0,0,0,0);
			return rVector;
		}
		socInt.getRelationVectorActor = function() {
			var rVector = new RelationVector(2,0,0,0,0,0,0);
			return rVector;
		}
		socInt.getRelationVectorObservers = function() {
			var rVector = new RelationVector(1,0,0,0,0,0,0);
			return rVector;
		}
			break;
		case "looks":				// Looks
		//socInt.key += "Looks";
		socInt.title = "Compliment looks";
		socInt.tags.push("friendly","flirty","aroused");
		socInt.driveTags.push("dPleasure");
		// Moods
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(1,0,2,1,0,0,0,0);
			return mVector;
		}
		socInt.getMoodVectorActor = function() {
			var mVector = new MoodVector(0,0,1,1,0,0,0,0);
			return mVector;
		}
		socInt.getMoodVectorObservers = function() {
			var mVector = new MoodVector(0,0,0,1,0,0,0,0);
			return mVector;
		}
		// Relations
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(0,3,2,0,0,0,0);
			return rVector;
		}
		socInt.getRelationVectorActor = function() {
			var rVector = new RelationVector(0,2,1,0,0,0,0);
			return rVector;
		}
		socInt.getRelationVectorObservers = function() {
			var rVector = new RelationVector(0,0,0,0,0,0,0);
			return rVector;
		}
			break;
		case "personality":				// Looks
		//socInt.key += "Personality";
		socInt.title = "Compliment personality";
		socInt.tags.push("friendly","intimate","flirty");
		socInt.driveTags.push("dLove");
		// Moods
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(1,1,2,0,0,0,0,-1);
			return mVector;
		}
		socInt.getMoodVectorActor = function() {
			var mVector = new MoodVector(0,1,1,0,0,0,0,0);
			return mVector;
		}
		socInt.getMoodVectorObservers = function() {
			var mVector = new MoodVector(0,0,0,0,0,0,0,0);
			return mVector;
		}
		// Relations
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(2,0,3,0,0,0,0);
			return rVector;
		}
		socInt.getRelationVectorActor = function() {
			var rVector = new RelationVector(1,0,2,0,0,0,0);
			return rVector;
		}
		socInt.getRelationVectorObservers = function() {
			var rVector = new RelationVector(0,0,0,0,0,0,0);
			return rVector;
		}
			break;
	}
	return socInt;
}

	// Patronize
window.getPatronizeSocInt = function() {
	var socInt = new SocInt();
	socInt.key = "patronize";
	socInt.title = "Patronize";
	socInt.socialDriveCost = 2;
	socInt.priority = -5;
	
	socInt.weight = 10; // Starting weight
	socInt.tags.push("dominant");
	socInt.driveTags.push("dDomination");
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).hasFreeBodypart("mouth") ) {
			flagValid = true;
		}
		return flagValid;
	}
	
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight + gC(actor).mood.dominant * 0.2 - gC(actor).mood.submissive * 0.2 + gC(actor).mood.bored * 0.05;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ (ktn(this.actor) + " made light of " + ktn(this.target) + "'s opinions.") ,
									 (ktn(this.actor) + " dismissed " + ktn(this.target) + "'s thoughts.") ,
									 (ktn(this.actor) + " rested importance to " + ktn(this.target) + "'s concerns.") ] );
		return desc;
	}
	
	// Moods
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(-1,0,-1,0,0,3,0,1);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(0,0,0,0,3,0,0,-1);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,0,0,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.04);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(-1,0,0,0,4,0,1);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(0,0,0,3,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	// Extra effect
	socInt.calculateExtraEffect = function() {
		var chance = 5;
		if ( limitedRandomInt(100) <= chance ) {
			// Description
			// Effect
			this.furtherEffects = function(sis) {
				actorGetsCbAgainstTarget(this.target,this.actor);
				var eText = "\n" + gC(this.target).formattedName + " took great offense, and may decide to take " + gC(this.target).posPr + " revenge later.";
				sis.extraEffects += eText; 
			}
		}
	}
	
	return socInt;
}

	// Apologize
window.getApologizeSocInt = function() {
	var socInt = new SocInt();
	socInt.key = "apologize";
	socInt.title = "Apologize";
	socInt.socialDriveCost = 2;
	socInt.priority = 0;
	
	socInt.weight = 20; // Starting weight
	socInt.tags.push("submissive");
	socInt.driveTags.push("dCooperation");
	socInt.strategyTags.push("angerDown");
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = true;
		
		return flagValid;
	}
	
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight - gC(actor).mood.dominant * 0.2 + gC(actor).mood.submissive * 0.4 + gC(actor).mood.angry * 0.2;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [
								(ktn(this.actor) + " backed down and repented " + gC(this.actor).posPr + " attitude."),
								(ktn(this.actor) + " apologized to " + ktn(this.target) + "."),
								(ktn(this.actor) + " bowed " + gC(this.actor).posPr + " head in repentace.") ] );
		return desc;
	}
	
	// Moods
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(1,1,0,0,3,-1,0,-5);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(0,0,0,0,0,2,0,-3);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(1,0,0,0,0,0,0,-2);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.04);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(1,0,0,3,-1,-1,-1);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(0,0,0,0,2,-2,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(1,0,0,0,0,0,0);
		return rVector;
	}
	
	return socInt;
}

	// Cool moods down
window.getCoolMoodsDownSocInt = function() {
	var socInt = new SocInt();
	socInt.key = "coolMoodsDown";
	socInt.title = "Cool moods down";
	socInt.socialDriveCost = 2;
	socInt.priority = 0;
	
	socInt.weight = 5; // Starting weight
	socInt.tags.push("friendly");
	socInt.driveTags.push("dAmbition");
	socInt.strategyTags.push("angerDown");
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).hasFreeBodypart("mouth") ) {
			flagValid = true;
		}
		return flagValid;
	}
	
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight + gC(actor).mood.dominant * 0.1 + gC(actor).mood.bored * 0.2 + gC(actor).mood.angry * 0.2;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [
								(ktn(this.actor) + " suggested to cool the ambient down."),
								(ktn(this.actor) + " breathed calmly, and asked the other to do the same before continuing."),
								(ktn(this.actor) + " diplomatically asked to relax.") ] );
		return desc;
	}
	
	// Moods
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(0,0,-2,-2,-1,-2,1,-3);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(0,0,-2,-2,-2,-2,1,-4);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,-1,-1,-1,-1,1,-2);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.04);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(0,-1,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,-1,0,0,0,0,0);
		return rVector;
	}
	
	return socInt;
}
	
	// Assert yourself
window.getSelfAssertSocInt = function() {
	var socInt = new SocInt();
	socInt.key = "selfAssert";
	socInt.title = "Assert yourself";
	socInt.socialDriveCost = 2;
	socInt.priority = 0;
	
	socInt.weight = 5; // Starting weight
	socInt.tags.push("dominant");
	socInt.driveTags.push("dDomination","dAmbition");
	socInt.strategyTags.push("selfSubmissionDown");
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).hasFreeBodypart("mouth") && gC(actor).hasFreeBodypart("eyes") ) {
			flagValid = true;
		}
		return flagValid;
	}
	
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight + gC(actor).mood.submissive * 0.2 + gC(actor).mood.dominant * 0.2 + gC(actor).mood.angry * 0.2;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [
								(ktn(this.actor) + " complained about " + ktn(this.target) + "'s attitude."),
								(ktn(this.actor) + " crossed " + gC(this.actor).posPr + " arms, with an assertive expression."),
								(ktn(this.actor) + " locked " + gC(this.actor).posPr + " eyes on " + ktn(this.target) + "'s, challenging " + gC(this.target).posPr + " gaze.") ] );
		return desc;
	}
	
	// Moods
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(-2,0,-1,0,-2,0,0,0);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(-1,0,-1,0,0,-4,0,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(-1,0,-1,0,0,0,1,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.04);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(-1,0,0,-2,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(0,0,0,0,-2,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	return socInt;
}

	// GiveStroke
window.getGiveStrokeSocInt = function(type) {
	var socInt = new SocInt();
	socInt.key = "giveStroke";
	socInt.title = "Give Stroke";
	socInt.tags.push("intimate","aroused","dominant");
	socInt.driveTags.push("dLove");
	socInt.socialDriveCost = 4;
	
	socInt.topic = type;
	socInt.weight = 5; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).mood.angry < 20 && gC(actor).mood.submissive < 60 &&
		     ( gC(actor).mood.friendly > 20 || gC(actor).mood.aroused > 10 || gC(actor).mood.flirty > 10 ) &&
			 gC(actor).hasFreeBodypart("arms") ) {
			flagValid = true;
		}
		return flagValid;
	}
	// isUsable
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight;
		nWeight *= 1 + gC(actor).mood.dominant * 0.05 + gC(actor).mood.friendly * 0.01 + gC(actor).mood.intimate * 0.02
		         + gC(actor).mood.flirty * 0.02 + gC(actor).mood.aroused * 0.05;
		return nWeight;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.01);
		mult += (gC(this.actor).agility.getValue() * 0.03);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(1,2,0,2,-1,2,0,0);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(0,2,0,1,2,-1,0,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,1,0,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.01);
		mult += (gC(this.actor).agility.getValue() * 0.02);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(2,2,1,0,2,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,1,1,2,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,1,0,0,0,0,0);
		return rVector;
	}
	
	socInt.calculateExtraEffect = function() {
		var successVars = gC(this.target).mood.friendly + gC(this.target).mood.intimate + gC(this.target).mood.flirty + gC(this.target).mood.aroused
						+ gC(this.target).mood.submissive + rLvlAbt(this.target,this.actor,"submission") * 10 + rLvlAbt(this.target,this.actor,"sexualTension") * 10
						+ rLvlAbt(this.target,this.actor,"romance") * 10;
		// Base difficulty: 25
		var failureVars = 25 + gC(this.target).mood.dominant + gC(this.target).mood.angry + rLvlAbt(this.target,this.actor,"domination") * 10
						+ rLvlAbt(this.target,this.actor,"rivalry") * 10 + rLvlAbt(this.target,this.actor,"enmity") * 10;
		if ( failureVars > successVars ) {
			this.getDescription = function() {
				var desc = (ktn(this.actor) + " tried to have a kind gesture with " + ktn(this.target) + ", but " + gC(this.target).perPr + " refused!");
				desc 	+= " (" + successVars.toFixed(2) + " vs " + failureVars.toFixed(2) + ")";
				return desc;
			}
			this.getMoodVectorTarget = function() {
				var mVector = new MoodVector(0,-1,-1,-1,0,-2,0,2);
				return mVector;
			}
			this.getMoodVectorActor = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,-1,0,1,1);
				return mVector;
			}
			this.getMoodVectorObservers = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,0,0,0,0);
				return mVector;
			}
			this.getRelationVectorTarget = function() {
				var rVector = new RelationVector(0,0,0,0,-2,0,2);
				return rVector;
			}
			this.getRelationVectorActor = function() {
				var rVector = new RelationVector(0,0,0,-2,0,0,2);
				return rVector;
			}
			this.getRelationVectorObservers = function() {
				var rVector = new RelationVector(0,0,0,0,0,0,0);
				return rVector;
			}
		} else {
			this.getLustDamage = function(actor,target) {
				var damage = 0.5 + gCstat(actor,"charisma") * 0.005 + gCstat(actor,"agility") * 0.015;
				return damage;
			}
			this.furtherEffects = function(sis) {
				var eText = "\n" + gC(this.target).formattedName + " received " + textLustDamage(-gC(this.target).lust.attackInConversation(-this.getLustDamage(this.actor,this.target))) + ".";
				sis.extraEffects += eText; 
			}
		}
	}
	socInt.evaluateSuccess = function(actor,target,topic) {
		var flagSuccess = false;
		var score = gC(target).mood.friendly + gC(target).mood.intimate + gC(target).mood.flirty + gC(target).mood.aroused
						+ gC(target).mood.submissive + rLvlAbt(target,actor,"submission") * 10 + rLvlAbt(target,actor,"sexualTension") * 10
						+ rLvlAbt(target,actor,"romance") * 10 - ( 25 + gC(target).mood.dominant + gC(target).mood.angry + rLvlAbt(target,actor,"domination") * 10
						+ rLvlAbt(target,actor,"rivalry") * 10 + rLvlAbt(target,actor,"enmity") * 10);
		score += limitedRandomInt(20) - 10;
		if ( score >= 0 ) { flagSuccess = true; }
		return flagSuccess;
	}
	
	switch(type) {
		case "headpat":
		socInt.key = "giveStrokeHeadpat";
		socInt.title = "Give headpat";
		socInt.socialDriveCost++;
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(2,2,0,2,-1,3,0,0);
			return mVector;
		}
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(3,2,1,0,3,0,0);
			return rVector;
		}
		socInt.getDescription = function() {
			var desc = randomFromList( [ (ktn(this.actor) + " petted " + ktn(this.target) + "'s head.") ,
										 (ktn(this.actor) + " patted " + ktn(this.target) + " in the head.") ] );
			return desc;
		}
			break;
		case "face":
		socInt.key = "giveStrokeFace";
		socInt.title = "Stroke face";
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(2,3,0,2,-1,2,0,0);
			return mVector;
		}
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(2,2,3,0,2,0,0);
			return rVector;
		}
		socInt.getDescription = function() {
			var desc = randomFromList( [ (ktn(this.actor) + " briefly held " + ktn(this.target) + "'s cheek in " + gC(this.actor).posPr + " hand." ) ,
										 (ktn(this.actor) + " traced a line through " + ktn(this.target) + "'s face.") ] );
			return desc;
		}
			break;
		case "ear":
		socInt.key = "giveStrokeEar";
		socInt.title = "Stroke ear";	
		socInt.getDescription = function() {
			var desc = randomFromList( [ (ktn(this.actor) + " caressed " + ktn(this.target) + "'s ear.") ,
										 (ktn(this.actor) + " gently grabbed " + ktn(this.target) + "'s ear.") ] );
			return desc;
		}
			break;
	}
	
	return socInt;
}

	// AskForStroke
window.getAskForStrokeSocInt = function(type) {
	var socInt = new SocInt();
	socInt.key = "giveStroke";
	socInt.title = "Give Stroke";
	socInt.tags.push("friendly","aroused","submissive");
	socInt.socialDriveCost = 3;
	socInt.driveTags.push("dLove");
	
	socInt.topic = type;
	socInt.weight = 5; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).mood.angry < 20 &&
		( gC(actor).mood.friendly > 20 || gC(actor).mood.aroused > 10 || gC(actor).mood.flirty > 10 ) ) {
			flagValid = true;
		}
		return flagValid;
	}
	socInt.isUsable = function(sis,actor,target,observers,extraData) {
		// Determines if the interaction is usable on the selected target
		var flagUsable = false;
		if ( (gC(actor).socialdrive.current >= this.socialDriveCost) ) {
			flagUsable = true;
		}
		return flagUsable;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight;
		nWeight *= 1 + gC(actor).mood.submissive * 0.1 + gC(actor).mood.intimate * 0.03
		         + gC(actor).mood.flirty * 0.03 + gC(actor).mood.aroused * 0.05 - gC(actor).mood.dominant * 0.2;
		return nWeight;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(2,1,1,2,2,0,-1,-1);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(1,0,1,1,-1,3,0,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,1,0,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.02);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(2,2,2,2,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,1,1,0,2,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	switch(type) {
		case "headpat":
		socInt.key = "askForStrokeHeadpat";
		socInt.title = "Ask for headpat";
		socInt.socialDriveCost++;
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(1,1,0,2,3,-1,0,0);
			return mVector;
		}
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(3,2,1,3,0,0,0);
			return rVector;
		}
		socInt.getDescription = function() {
			var desc = randomFromList( [ (ktn(this.actor) + " asked " + ktn(this.target) + " for a headpat." ),
										 (ktn(this.actor) + " asked " + ktn(this.target) + " to pet " + gC(this.actor).posPr + " head with a "
										  + '"I broke no dishes!"' + " face.") ] );
			return desc;
		}
			break;
		case "face":
		socInt.key = "askForStrokeFace";
		socInt.title = "Ask for stroke face";
		socInt.tags.push("intimate");
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(1,2,1,2,3,0,0,0);
			return mVector;
		}
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(2,2,3,2,0,0,0);
			return rVector;
		}
		socInt.getDescription = function() {
			var desc = randomFromList( [ (ktn(this.actor) + " asked " + ktn(this.target) + " to caress " + gC(this.actor).posPr + " face.") ] );
			return desc;
		}
			break;
		case "ear":
		socInt.key = "askForStrokeEar";
		socInt.title = "Ask for stroke ear";	
		socInt.getDescription = function() {
			var desc = randomFromList( [ (ktn(this.actor) + " asked " + ktn(this.target) + " to caress " + gC(this.actor).posPr + " ear.") ] );
			return desc;
		}
			break;
	}
	
	socInt.calculateExtraEffect = function() {
		var successVars = gC(this.target).mood.friendly + gC(this.target).mood.intimate + gC(this.target).mood.flirty + gC(this.target).mood.aroused
						+ rLvlAbt(this.target,this.actor,"sexualTension") * 10 + rLvlAbt(this.target,this.actor,"romance") * 10;
		// Base difficulty: 15
		var failureVars = 15 + gC(this.target).mood.angry * 10 + rLvlAbt(this.target,this.actor,"rivalry") * 10
						+ rLvlAbt(this.target,this.actor,"enmity") * 10;
		if ( failureVars > successVars ) {
			this.getDescription = function() {
				var desc = (ktn(this.actor) + " asked " + ktn(this.target) + " to have a nice gesture, but " + gC(this.target).perPr + " refused!");
				desc 	+= " (" + successVars.toFixed(2) + " vs " + failureVars.toFixed(2) + ")";
				return desc;
			}
			this.getMoodVectorTarget = function() {
				var mVector = new MoodVector(0,-1,-1,-1,0,-2,0,2);
				return mVector;
			}
			this.getMoodVectorActor = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,-1,0,1,1);
				return mVector;
			}
			this.getMoodVectorObservers = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,0,0,0,0);
				return mVector;
			}
			this.getRelationVectorTarget = function() {
				var rVector = new RelationVector(0,0,0,0,-2,0,2);
				return rVector;
			}
			this.getRelationVectorActor = function() {
				var rVector = new RelationVector(0,0,0,-2,0,0,2);
				return rVector;
			}
			this.getRelationVectorObservers = function() {
				var rVector = new RelationVector(0,0,0,0,0,0,0);
				return rVector;
			}
		} else {
			this.getLustDamage = function(actor,target) {
				var damage = 0.5 + gCstat(target,"charisma") * 0.005 + gCstat(target,"agility") * 0.015;
				return damage;
			}
			this.furtherEffects = function(sis) {
				var eText = "\n" + gC(this.actor).formattedName + " received " + textLustDamage(-gC(this.actor).lust.attackInConversation(-this.getLustDamage(this.actor,this.target))) + ".";
				sis.extraEffects += eText; 
			}
		}
	}
	socInt.evaluateSuccess = function(actor,target,topic) {
		var flagSuccess = false;
		var score = gC(target).mood.friendly + gC(target).mood.intimate + gC(target).mood.flirty + gC(target).mood.aroused
						+ rLvlAbt(target,actor,"sexualTension") * 10 + rLvlAbt(target,actor,"romance") * 10 - ( 15 + gC(target).mood.angry * 10 + rLvlAbt(target,actor,"rivalry") * 10
						+ rLvlAbt(target,actor,"enmity") * 10 );
		score += limitedRandomInt(10) - 5;
		if ( score >= 0 ) { flagSuccess = true; }
		return flagSuccess;
	}
	
	return socInt;
}

	// Insult
window.getInsultSocInt = function(type) {
	var socInt = new SocInt();
	socInt.key = "insult";
	socInt.title = "Insult";
	socInt.tags.push("angry");
	socInt.strategyTags.push("romanceRival");
	socInt.socialDriveCost = 2;
	
	socInt.topic = type;
	socInt.weight = 10; // Starting weight
	
	socInt.getDescription = function() {
			var desc = randomFromList( [ (ktn(this.actor) + " said something about " + ktn(this.target) + "'s " + this.topic
										+ " that would have made " + gC(this.actor).posPr + " mother blush.") ,
										 (ktn(this.actor) + " isn't holding back to declare what " + gC(this.actor).perPr + " thinks about "
										+ ktn(this.target) + "'s " + this.topic + ".") ,
										 ("The screeching of metal cutlery rubbing against a sharp sword would have sounded better to " + ktn(this.target)
										+ "'s ears than what " + ktn(this.actor) + " had to say about " + gC(this.actor).posPr + " " + this.topic + ".") ] );
			return desc;
		}
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).mood.friendly < 40 && gC(actor).hasFreeBodypart("mouth") ) {
			flagValid = true;
		}
		return flagValid;
	}
	// isUsable
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight;
		nWeight *= 1 + gC(actor).mood.angry * 0.1 - gC(actor).mood.friendly * 0.05;
		return nWeight;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.04);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(-5,0,-2,0,0,0,1,5);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(-3,-1,-1,0,0,0,0,3);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(-1,0,-1,0,0,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.04);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(-2,0,0,0,0,8,8);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(-2,0,0,0,0,6,6);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	switch(type) {
		case "attitude":
		socInt.key = "insultAttitude";
		socInt.title = "Insult attitude";
			break;
		case "ideals":
		socInt.key = "insultIdeals";
		socInt.title = "Insult ideals";
		socInt.socialDriveCost++;
		socInt.getMoodVectorTarget = function() {
			var mVector = new MoodVector(-6,0,-4,0,0,0,0,8);
			return mVector;
		}
		socInt.getRelationVectorTarget = function() {
			var rVector = new RelationVector(-3,0,-3,0,0,10,10);
			return rVector;
		}
			break;
		case "looks":
		socInt.key = "insultLooks";
		socInt.title = "Insult looks";	
			break;
	}
	
	// Extra effect
	socInt.calculateExtraEffect = function() {
		var chance = 25;
		if ( limitedRandomInt(100) <= chance ) {
			// Description
			// Effect
			this.furtherEffects = function(sis) {
				actorGetsCbAgainstTarget(this.target,this.actor);
				var eText = "\n" + gC(this.target).formattedName + " took great offense, and may decide to take " + gC(this.target).posPr + " revenge later.";
				sis.extraEffects += eText; 
			}
		}
	}
	
	return socInt;
}

	// Hold hands
window.getHandholdingSocInt = function(type) {
	var socInt = new SocInt();
	socInt.key = "handholding";
	socInt.title = "Hold hands";
	socInt.socialDriveCost = 3;
	socInt.priority = 0;
	
	socInt.tags = ["intimate","flirty"];
	socInt.driveTags.push("dLove");
	
	socInt.weight = 20; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).mood.angry < 20 && gC(actor).hasFreeBodypart("arms") ) {
			flagValid = true;
		}
		return flagValid;
	}
	
	socInt.isUsable = function(sis,actor,target,observers,extraData) {
		// Determines if the interaction is usable on the selected target
		var flagUsable = false;
		if ( (gC(actor).socialdrive.current >= this.socialDriveCost) ) {
			flagUsable = true;
		}
		return flagUsable;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight;
		nWeight = 10 + gC(actor).mood.intimate * 0.05 + gC(actor).mood.flirty * 0.05 - gC(actor).mood.angry * 0.05;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ (ktn(this.actor) + " took " + ktn(this.target) + "'s hand and held it dearly.") ,
									 (ktn(this.actor) + " held " + ktn(this.target) + "'s hands.") ,
									 (ktn(this.actor) + " put some affection in " + ktn(this.target) + "'s hands with " + gC(this.actor).posPr + " her own.") ] );
		return desc;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).will.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(1,3,3,0,0,0,0,-1);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(0,2,2,0,0,0,0,-1);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,0,0,0,1,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).will.getValue() * 0.02);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(2,2,2,0,0,0,-1);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(2,2,2,0,0,0,-1);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	socInt.calculateExtraEffect = function() {
		var successVars = gC(this.target).mood.friendly + gC(this.target).mood.intimate + gC(this.target).mood.flirty + gC(this.target).mood.aroused
						+ gC(this.target).mood.submissive + rLvlAbt(this.target,this.actor,"submission") * 10 + rLvlAbt(this.target,this.actor,"sexualTension") * 10
						+ rLvlAbt(this.target,this.actor,"romance") * 10;
		// Base difficulty: 30
		var failureVars = 30 + gC(this.target).mood.dominant + gC(this.target).mood.angry + rLvlAbt(this.target,this.actor,"domination") * 10
						+ rLvlAbt(this.target,this.actor,"rivalry") * 10 + rLvlAbt(this.target,this.actor,"enmity") * 10;
		if ( failureVars > successVars ) {
			this.getDescription = function() {
				var desc = (ktn(this.actor) + " tried to have a kind gesture with " + ktn(this.target) + ", but " + gC(this.target).perPr + " refused!");
				desc 	+= " (" + successVars.toFixed(2) + " vs " + failureVars.toFixed(2) + ")";
				return desc;
			}
			this.getMoodVectorTarget = function() {
				var mVector = new MoodVector(0,-1,-1,-1,0,-2,0,2);
				return mVector;
			}
			this.getMoodVectorActor = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,-1,0,1,1);
				return mVector;
			}
			this.getMoodVectorObservers = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,0,0,0,0);
				return mVector;
			}
			this.getRelationVectorTarget = function() {
				var rVector = new RelationVector(0,0,0,0,-2,0,2);
				return rVector;
			}
			this.getRelationVectorActor = function() {
				var rVector = new RelationVector(0,0,0,-2,0,0,2);
				return rVector;
			}
			this.getRelationVectorObservers = function() {
				var rVector = new RelationVector(0,0,0,0,0,0,0);
				return rVector;
			}
		}
	}
	socInt.evaluateSuccess = function(actor,target,topic) {
		var flagSuccess = false;
		var score = gC(target).mood.friendly + gC(target).mood.intimate + gC(target).mood.flirty + gC(target).mood.aroused
						+ gC(target).mood.submissive + rLvlAbt(target,actor,"submission") * 10 + rLvlAbt(target,actor,"sexualTension") * 10
						+ rLvlAbt(target,actor,"romance") * 10 - ( 30 + gC(target).mood.dominant + gC(target).mood.angry + rLvlAbt(target,actor,"domination") * 10
						+ rLvlAbt(target,actor,"rivalry") * 10 + rLvlAbt(target,actor,"enmity") * 10);
		score += limitedRandomInt(20) - 10;
		if ( score >= 0 ) { flagSuccess = true; }
		return flagSuccess;
	}
	
	return socInt;
}

	// Embrace 
window.getEmbraceSocInt = function(type) {
	var socInt = new SocInt();
	socInt.key = "embrace";
	socInt.title = "Embrace";
	socInt.socialDriveCost = 4;
	socInt.priority = 0;
	
	socInt.tags = ["intimate"];
	socInt.driveTags.push("dLove");
	
	socInt.weight = 20; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).mood.angry < 15 && ( gC(actor).mood.intimate > 35 ) && ( gC(actor).hasFreeBodypart("arms") ) ) {
			flagValid = true;
		}
		return flagValid;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight;
		nWeight *= 1 + gC(actor).mood.intimate * 0.1 + gC(actor).mood.flirty * 0.02 - gC(actor).mood.angry * 0.2;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ (ktn(this.actor) + " took " + ktn(this.target) + " into " + gC(this.actor).posPr + " arms.") ,
									 (ktn(this.actor) + " hugged " + ktn(this.target) + "'s waist.") ,
									 (ktn(this.actor) + " held " + ktn(this.target) + " so close to " + gC(this.actor).refPr
									+ " that it looked like " + ktn(this.actor) + " needed " + gC(this.target).comPr + " to breathe.") ] );
		return desc;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).will.getValue() * 0.01 + gC(this.actor).physique.getValue() * 0.01 + gC(this.actor).resilience.getValue() * 0.01);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(0,5,2,1,0,0,0,-2);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(0,4,1,1,0,0,0,-2);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,0,0,0,1,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).will.getValue() * 0.01 + gC(this.actor).physique.getValue() * 0.01 + gC(this.actor).resilience.getValue() * 0.01);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(2,2,4,0,0,0,-2);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(2,2,4,0,0,0,-2);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	socInt.calculateExtraEffect = function() {
		var successVars = gC(this.target).mood.friendly + gC(this.target).mood.intimate + gC(this.target).mood.flirty + gC(this.target).mood.aroused
						+ gC(this.target).mood.submissive + rLvlAbt(this.target,this.actor,"submission") * 10 + rLvlAbt(this.target,this.actor,"sexualTension") * 10
						+ rLvlAbt(this.target,this.actor,"romance") * 10;
		// Base difficulty: 40
		var failureVars = 40 + gC(this.target).mood.dominant + gC(this.target).mood.angry + rLvlAbt(this.target,this.actor,"domination") * 10
						+ rLvlAbt(this.target,this.actor,"rivalry") * 10 + rLvlAbt(this.target,this.actor,"enmity") * 10;
		if ( failureVars > successVars ) {
			this.getDescription = function() {
				var desc = (ktn(this.actor) + " tried to have an intimate gesture with " + ktn(this.target) + ", but " + gC(this.target).perPr + " refused!");
				desc 	+= " (" + successVars.toFixed(2) + " vs " + failureVars.toFixed(2) + ")";
				return desc;
			}
			this.getMoodVectorTarget = function() {
				var mVector = new MoodVector(0,-1,-1,-1,0,-2,0,2);
				return mVector;
			}
			this.getMoodVectorActor = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,-1,0,1,1);
				return mVector;
			}
			this.getMoodVectorObservers = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,0,0,0,0);
				return mVector;
			}
			this.getRelationVectorTarget = function() {
				var rVector = new RelationVector(0,0,0,0,-2,0,2);
				return rVector;
			}
			this.getRelationVectorActor = function() {
				var rVector = new RelationVector(0,0,0,-2,0,0,2);
				return rVector;
			}
			this.getRelationVectorObservers = function() {
				var rVector = new RelationVector(0,0,0,0,0,0,0);
				return rVector;
			}
		} else {
			this.getLustDamage = function(actor,target) {
				var damage = 0.5 + gCstat(actor,"will") * 0.01 + gCstat(actor,"physique") * 0.01 + gCstat(actor,"resilience") * 0.01;
				return damage;
			}
			this.furtherEffects = function(sis) {
				var eText = "\n" + gC(this.target).formattedName + " received " + textLustDamage(-gC(this.target).lust.attackInConversation(-this.getLustDamage(this.actor,this.target))) + ".";
				sis.extraEffects += eText; 
			}
		}
	}
	socInt.evaluateSuccess = function(actor,target,topic) {
		var flagSuccess = false;
		var score = gC(target).mood.friendly + gC(target).mood.intimate + gC(target).mood.flirty + gC(target).mood.aroused
						+ gC(target).mood.submissive + rLvlAbt(target,actor,"submission") * 10 + rLvlAbt(target,actor,"sexualTension") * 10
						+ rLvlAbt(target,actor,"romance") * 10 - (40 + gC(target).mood.dominant + gC(target).mood.angry + rLvlAbt(target,actor,"domination") * 10
						+ rLvlAbt(target,actor,"rivalry") * 10 + rLvlAbt(target,actor,"enmity") * 10);
		score += limitedRandomInt(20) - 10;
		if ( score >= 0 ) { flagSuccess = true; }
		return flagSuccess;
	}
	
	return socInt;
}

	// Sensual Stroke
window.getSensualStroke = function(type) {
	var socInt = new SocInt();
	socInt.key = "sensualStroke";
	socInt.title = "Stroke";
	socInt.socialDriveCost = 3;
	socInt.priority = 0;
	
	socInt.tags = ["aroused"];
	socInt.driveTags.push("dPleasure");
	
	socInt.topic = type;
	
	socInt.weight = 15; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).mood.angry < 20 && ( gC(actor).mood.aroused > 25 ) && gC(actor).hasFreeBodypart("arms") ) {
			flagValid = true;
		}
		return flagValid;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight;
		nWeight *= 1 + gC(actor).mood.aroused * 0.8 + gC(actor).mood.flirty * 0.4 - gC(actor).mood.angry * 0.1;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ (ktn(this.actor) + " put a lot of care when " + gC(this.actor).perPr + " caressed " + ktn(this.target) + "'s "
									+ this.topic + ", looking for the perfect balance between giving pleasure and leaving " + gC(this.target).comPr
									+ " wanting for more.") ] );
		return desc;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.01) + (gC(this.actor).will.getValue() * 0.01) + (gC(this.actor).agility.getValue() * 0.02);
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(0,1,2,3,0,0,0,0);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(0,0,1,2,0,0,0,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,1,0,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += (gC(this.actor).charisma.getValue() * 0.01) + (gC(this.actor).will.getValue() * 0.01) + (gC(this.actor).agility.getValue() * 0.02);
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(1,4,1,0,1,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,3,1,1,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	switch(type) {
		case "legs":
			socInt.key = "sensualStrokeLegs";
			socInt.title = "Stroke legs";
			break;
	}
	
	socInt.calculateExtraEffect = function() {
		var successVars = gC(this.target).mood.friendly + gC(this.target).mood.intimate + gC(this.target).mood.flirty + gC(this.target).mood.aroused
						+ gC(this.target).mood.submissive + rLvlAbt(this.target,this.actor,"submission") * 10 + rLvlAbt(this.target,this.actor,"sexualTension") * 10
						+ rLvlAbt(this.target,this.actor,"romance") * 10;
		// Base difficulty: 60
		var failureVars = 60 + gC(this.target).mood.dominant + gC(this.target).mood.angry + rLvlAbt(this.target,this.actor,"domination") * 10
						+ rLvlAbt(this.target,this.actor,"rivalry") * 10 + rLvlAbt(this.target,this.actor,"enmity") * 10;
		if ( failureVars > successVars ) {
			this.getDescription = function() {
				var desc = (ktn(this.actor) + " tried to have an intimate gesture with " + ktn(this.target) + ", but " + gC(this.target).perPr + " refused!");
				desc 	+= " (" + successVars.toFixed(2) + " vs " + failureVars.toFixed(2) + ")";
				return desc;
			}
			this.getMoodVectorTarget = function() {
				var mVector = new MoodVector(0,-1,-1,-1,0,-2,0,2);
				return mVector;
			}
			this.getMoodVectorActor = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,-1,0,1,1);
				return mVector;
			}
			this.getMoodVectorObservers = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,0,0,0,0);
				return mVector;
			}
			this.getRelationVectorTarget = function() {
				var rVector = new RelationVector(0,0,0,0,-2,0,2);
				return rVector;
			}
			this.getRelationVectorActor = function() {
				var rVector = new RelationVector(0,0,0,-2,0,0,2);
				return rVector;
			}
			this.getRelationVectorObservers = function() {
				var rVector = new RelationVector(0,0,0,0,0,0,0);
				return rVector;
			}
		} else {
			this.getLustDamage = function(actor,target) {
				var damage = 1 + gCstat(actor,"will") * 0.01 + gCstat(actor,"charisma") * 0.01 + gCstat(actor,"agility") * 0.02;
				return damage;
			}
			this.furtherEffects = function(sis) {
				var eText = "\n" + gC(this.target).formattedName + " received " + textLustDamage(-gC(this.target).lust.attackInConversation(-this.getLustDamage(this.actor,this.target))) + ".";
				sis.extraEffects += eText; 
			}
		}
	}
	socInt.evaluateSuccess = function(actor,target,topic) {
		var flagSuccess = false;
		var score = gC(target).mood.friendly + gC(target).mood.intimate + gC(target).mood.flirty + gC(target).mood.aroused
						+ gC(target).mood.submissive + rLvlAbt(target,actor,"submission") * 10 + rLvlAbt(target,actor,"sexualTension") * 10
						+ rLvlAbt(target,actor,"romance") * 10 - ( 60 + gC(target).mood.dominant + gC(target).mood.angry + rLvlAbt(target,actor,"domination") * 10
						+ rLvlAbt(target,actor,"rivalry") * 10 + rLvlAbt(target,actor,"enmity") * 10);
		score += limitedRandomInt(20) - 10;
		if ( score >= 0 ) { flagSuccess = true; }
		return flagSuccess;
	}
	
	return socInt;
}
window.getStrokeButtSocInt = function() {
	var socInt = new SocInt();
	socInt.key = "strokeButt";
	socInt.title = "Stroke butt";
	socInt.socialDriveCost = 4;
	socInt.priority = 0;
	
	socInt.tags = ["aroused","dominant"];
	socInt.driveTags.push("dPleasure");
	
	socInt.weight = 10; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).mood.angry < 15 && ( gC(actor).mood.aroused > 35 ) && gC(actor).hasFreeBodypart("arms") ) {
			flagValid = true;
		}
		return flagValid;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight;
		nWeight *= 1 + gC(actor).mood.aroused * 1 + gC(actor).mood.flirty * 0.2 - gC(actor).mood.angry * 0.1;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ 
								(ktn(this.actor) + " discreetly rested " + gC(this.actor).posPr + " hand on " + ktn(this.target) + "'s ass, acting like it was a most natural gesture."),
								(ktn(this.actor) + " took a handful of " + ktn(this.target) + "'s buttocks and massaged it."),
								(ktn(this.actor) + "'s hand grabbed " + ktn(this.target) + "'s butt and played with it like it was its toy.") ] );
								
		return desc;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += ((gC(this.actor).will.getValue() * 0.02) + (gC(this.actor).agility.getValue() * 0.01) + (gC(this.actor).physique.getValue() * 0.01));
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(0,0,2,4,-1,2,0,0);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(0,0,1,3,1,-1,0,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,1,-1,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += ((gC(this.actor).will.getValue() * 0.02) + (gC(this.actor).agility.getValue() * 0.01) + (gC(this.actor).physique.getValue() * 0.01));
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(0,5,2,0,3,0,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(0,3,1,2,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	socInt.calculateExtraEffect = function() {
		var successVars = gC(this.target).mood.friendly * 0.5 + gC(this.target).mood.intimate * 0.5 + gC(this.target).mood.flirty + gC(this.target).mood.aroused * 2
						+ gC(this.target).mood.submissive + rLvlAbt(this.target,this.actor,"submission") * 15 + rLvlAbt(this.target,this.actor,"sexualTension") * 10
						+ rLvlAbt(this.target,this.actor,"romance") * 5;
		// Base difficulty: 75
		var failureVars = 75 + gC(this.target).mood.dominant + gC(this.target).mood.angry + rLvlAbt(this.target,this.actor,"domination") * 15
						+ rLvlAbt(this.target,this.actor,"rivalry") * 10 + rLvlAbt(this.target,this.actor,"enmity") * 20;
		if ( failureVars > successVars ) {
			this.getDescription = function() {
				var desc = (ktn(this.actor) + " tried to grab " + ktn(this.target) + "'s butt, but was met with reprobation!");
				desc 	+= " (" + successVars.toFixed(2) + " vs " + failureVars.toFixed(2) + ")";
				return desc;
			}
			this.getMoodVectorTarget = function() {
				var mVector = new MoodVector(-1,-1,-1,1,0,-2,0,3);
				return mVector;
			}
			this.getMoodVectorActor = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,-1,0,1,1);
				return mVector;
			}
			this.getMoodVectorObservers = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,0,0,0,0);
				return mVector;
			}
			this.getRelationVectorTarget = function() {
				var rVector = new RelationVector(-1,0,0,0,-2,0,2);
				return rVector;
			}
			this.getRelationVectorActor = function() {
				var rVector = new RelationVector(0,-1,0,-1,0,0,1);
				return rVector;
			}
			this.getRelationVectorObservers = function() {
				var rVector = new RelationVector(-1,0,0,0,0,0,0);
				return rVector;
			}
		} else {
			this.getLustDamage = function(actor,target) {
				var damage = 2 + ((gC(this.actor).will.getValue() * 0.02) + (gC(this.actor).agility.getValue() * 0.01) + (gC(this.actor).physique.getValue() * 0.01));
				return damage;
			}
			this.furtherEffects = function(sis) {
				var eText = "\n" + gC(this.target).formattedName + " received " + textLustDamage(-gC(this.target).lust.attackInConversation(-this.getLustDamage(this.actor,this.target))) + ".";
				sis.extraEffects += eText; 
			}
		}
	}
	socInt.evaluateSuccess = function(actor,target,topic) {
		var flagSuccess = false;
		var score = gC(target).mood.friendly * 0.5 + gC(target).mood.intimate * 0.5 + gC(target).mood.flirty + gC(target).mood.aroused * 2
						+ gC(target).mood.submissive + rLvlAbt(target,actor,"submission") * 15 + rLvlAbt(target,actor,"sexualTension") * 10
						+ rLvlAbt(target,actor,"romance") * 5 - ( 75 + gC(target).mood.dominant + gC(target).mood.angry + rLvlAbt(target,actor,"domination") * 15
						+ rLvlAbt(target,actor,"rivalry") * 10 + rLvlAbt(target,actor,"enmity") * 20 );
		score += limitedRandomInt(20) - 10;
		if ( score >= 0 ) { flagSuccess = true; }
		return flagSuccess;
	}

	return socInt;
}
window.getTeaseCrotchSocInt = function() {
	var socInt = new SocInt();
	socInt.key = "teaseCrotch";
	socInt.title = "Tease crotch";
	socInt.socialDriveCost = 5;
	socInt.priority = 0;
	
	socInt.tags = ["aroused"];
	socInt.driveTags.push("dPleasure");
	
	socInt.weight = 10; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).mood.angry < 20 && ( gC(actor).mood.aroused > 40 ) && gC(actor).hasFreeBodypart("arms") ) {
			flagValid = true;
		}
		return flagValid;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight;
		nWeight *= 1 + gC(actor).mood.aroused * 0.9 + gC(actor).mood.flirty * 0.3 - gC(actor).mood.angry * 0.2;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ 
								(ktn(this.actor) + " slid a finger next to " + ktn(this.target) + "'s nethers, teasing " + gC(this.target).comPr + "."),
								(ktn(this.actor) + " teased " + ktn(this.target) + " crotch with " + gC(this.actor).posPr + " hands."),
								(ktn(this.actor) + " caressed " + ktn(this.target) + "'s waist, dangerously close to " + gC(this.target).posPr + " genitals.") ] );
								
		return desc;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += ((gC(this.actor).will.getValue() * 0.02) + (gC(this.actor).agility.getValue() * 0.03));
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(0,1,3,5,-1,1,-3,0);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(0,0,2,3,0,-1,-2,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,2,-1,0,-1,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += ((gC(this.actor).will.getValue() * 0.02) + (gC(this.actor).agility.getValue() * 0.03));
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(0,6,3,0,2,1,0);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(0,4,2,2,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,1,0,0,0,0,0);
		return rVector;
	}
	
	socInt.calculateExtraEffect = function() {
		var successVars = gC(this.target).mood.friendly * 0.5 + gC(this.target).mood.intimate * 0.5 + gC(this.target).mood.flirty + gC(this.target).mood.aroused * 2
						+ gC(this.target).mood.submissive + rLvlAbt(this.target,this.actor,"submission") * 15 + rLvlAbt(this.target,this.actor,"sexualTension") * 10
						+ rLvlAbt(this.target,this.actor,"romance") * 5;
		// Base difficulty: 75
		var failureVars = 75 + gC(this.target).mood.dominant + gC(this.target).mood.angry + rLvlAbt(this.target,this.actor,"domination") * 10
						+ rLvlAbt(this.target,this.actor,"rivalry") * 10 + rLvlAbt(this.target,this.actor,"enmity") * 20;
		if ( failureVars > successVars ) {
			this.getDescription = function() {
				var desc = (ktn(this.actor) + " teased " + ktn(this.target) + "'s nethers, but " + gC(this.target).perPr + " reprobated the gesture!");
				desc 	+= " (" + successVars.toFixed(2) + " vs " + failureVars.toFixed(2) + ")";
				return desc;
			}
			
			this.getMoodVectorTarget = function() {
				var mVector = new MoodVector(-1,-2,-1,1,0,-2,-1,3);
				return mVector;
			}
			this.getMoodVectorActor = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,-1,0,1,1);
				return mVector;
			}
			this.getMoodVectorObservers = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,0,0,0,0);
				return mVector;
			}
			this.getRelationVectorTarget = function() {
				var rVector = new RelationVector(-1,0,0,0,-2,0,2);
				return rVector;
			}
			this.getRelationVectorActor = function() {
				var rVector = new RelationVector(0,-1,0,-1,0,0,1);
				return rVector;
			}
			this.getRelationVectorObservers = function() {
				var rVector = new RelationVector(-1,0,0,0,0,0,0);
				return rVector;
			}
		} else {
			this.getLustDamage = function(actor,target) {
				var damage = 2.5 + ((gC(this.actor).will.getValue() * 0.02) + (gC(this.actor).agility.getValue() * 0.03));
				return damage;
			}
			this.furtherEffects = function(sis) {
				var eText = "\n" + gC(this.target).formattedName + " received " + textLustDamage(-gC(this.target).lust.attackInConversation(-this.getLustDamage(this.actor,this.target))) + ".";
				sis.extraEffects += eText; 
			}
		}
	}
	socInt.evaluateSuccess = function(actor,target,topic) {
		var flagSuccess = false;
		var score = gC(target).mood.friendly * 0.5 + gC(target).mood.intimate * 0.5 + gC(target).mood.flirty + gC(target).mood.aroused * 2
						+ gC(target).mood.submissive + rLvlAbt(target,actor,"submission") * 15 + rLvlAbt(target,actor,"sexualTension") * 10
						+ rLvlAbt(target,actor,"romance") * 5 - (75 + gC(target).mood.dominant + gC(target).mood.angry + rLvlAbt(target,actor,"domination") * 10
						+ rLvlAbt(target,actor,"rivalry") * 10 + rLvlAbt(target,actor,"enmity") * 20);
		score += limitedRandomInt(20) - 10;
		if ( score >= 0 ) { flagSuccess = true; }
		return flagSuccess;
	}
	
	return socInt;
}

	// Kiss
window.getKissSocInt = function(type) {
	var socInt = new SocInt();
	socInt.key = "kiss";
	socInt.title = "Kiss";
	socInt.socialDriveCost = 5;
	socInt.priority = 0;
	
	socInt.tags = ["intimate","aroused"];
	socInt.driveTags.push("dLove");
	
	socInt.weight = 25; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).mood.angry < 15 && ( gC(actor).mood.intimate > 30 || gC(actor).mood.aroused > 30 )
			 && gC(actor).hasFreeBodypart("mouth") ) {
			flagValid = true;
		}
		return flagValid;
	}
	socInt.isUsable = function(sis,actor,target,observers,extraData) {
		// Determines if the interaction is usable on the selected target
		var flagUsable = false;
		if ( (gC(actor).socialdrive.current >= this.socialDriveCost) && gC(actor).hasFreeBodypart("mouth") ) {
			flagUsable = true;
		}
		return flagUsable;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight;
		nWeight *= 1 + gC(actor).mood.intimate * 0.1 + gC(actor).mood.aroused * 0.1 - gC(actor).mood.angry * 0.2;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ (ktn(this.actor) + " placed " + gC(this.actor).posPr + " lips on " + ktn(this.target) + "'s.") ,
									 (ktn(this.actor) + " joined " + gC(this.actor).posPr + " mouth with " + ktn(this.target) + "'s.") ,
									 (ktn(this.actor) + " and " + ktn(this.target) + " shared an intimate moment when their tongues "
									+ "tried to fuse into one.") ] );
		return desc;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += ( gC(this.actor).will.getValue() * 0.015 + gC(this.actor).charisma.getValue() * 0.015
		      + gC(this.actor).agility.getValue() * 0.015 + gC(this.actor).empathy.getValue() * 0.015 );
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(1,3,2,3,0,0,0,-1);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(1,2,1,2,0,0,0,-1);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,1,0,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += ( gC(this.actor).will.getValue() * 0.015 + gC(this.actor).charisma.getValue() * 0.015
		      + gC(this.actor).agility.getValue() * 0.015 + gC(this.actor).empathy.getValue() * 0.015 );
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(1,3,3,0,0,0,-1);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,3,3,0,0,0,-1);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	socInt.calculateExtraEffect = function() {
		var successVars = gC(this.target).mood.friendly + gC(this.target).mood.intimate + gC(this.target).mood.flirty + gC(this.target).mood.aroused
						+ gC(this.target).mood.submissive + rLvlAbt(this.target,this.actor,"submission") * 10 + rLvlAbt(this.target,this.actor,"sexualTension") * 10
						+ rLvlAbt(this.target,this.actor,"romance") * 10;
		// Base difficulty: 50
		var failureVars = 50 + gC(this.target).mood.dominant + gC(this.target).mood.angry + rLvlAbt(this.target,this.actor,"domination") * 10
						+ rLvlAbt(this.target,this.actor,"rivalry") * 10 + rLvlAbt(this.target,this.actor,"enmity") * 10;
		if ( failureVars > successVars ) {
			this.getDescription = function() {
				var desc = (ktn(this.actor) + " tried to have an intimate gesture with " + ktn(this.target) + ", but " + gC(this.target).perPr + " refused!");
				desc 	+= " (" + successVars.toFixed(2) + " vs " + failureVars.toFixed(2) + ")";
				return desc;
			}
			this.getMoodVectorTarget = function() {
				var mVector = new MoodVector(0,-1,-1,-1,0,-2,0,2);
				return mVector;
			}
			this.getMoodVectorActor = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,-1,0,1,1);
				return mVector;
			}
			this.getMoodVectorObservers = function() {
				var mVector = new MoodVector(-1,-1,-1,-1,0,0,0,0);
				return mVector;
			}
			this.getRelationVectorTarget = function() {
				var rVector = new RelationVector(0,0,0,0,-2,0,2);
				return rVector;
			}
			this.getRelationVectorActor = function() {
				var rVector = new RelationVector(0,0,0,-2,0,0,2);
				return rVector;
			}
			this.getRelationVectorObservers = function() {
				var rVector = new RelationVector(0,0,0,0,0,0,0);
				return rVector;
			}
		} else {
			this.getLustDamage = function(actor,target) {
				var damage = 1 + gCstat(actor,"will") * 0.01 + gCstat(actor,"charisma") * 0.01 + gCstat(actor,"agility") * 0.02;
				return damage;
			}
			this.furtherEffects = function(sis) {
				var eText = "\n" + gC(this.target).formattedName + " received " + textLustDamage(-gC(this.target).lust.attackInConversation(-this.getLustDamage(this.actor,this.target))) + ".";
				sis.extraEffects += eText; 
			}
		}
	}
	socInt.evaluateSuccess = function(actor,target,topic) {
		var flagSuccess = false;
		var score = gC(target).mood.friendly + gC(target).mood.intimate + gC(target).mood.flirty + gC(target).mood.aroused
						+ gC(target).mood.submissive + rLvlAbt(target,actor,"submission") * 10 + rLvlAbt(target,actor,"sexualTension") * 10
						+ rLvlAbt(target,actor,"romance") * 10 - ( 50 + gC(target).mood.dominant + gC(target).mood.angry + rLvlAbt(target,actor,"domination") * 10
						+ rLvlAbt(target,actor,"rivalry") * 10 + rLvlAbt(target,actor,"enmity") * 10);
		score += limitedRandomInt(20) - 10;
		if ( score >= 0 ) { flagSuccess = true; }
		return flagSuccess;
	}
	
	return socInt;
}

///// EXTRA SOCIAL INTERACTIONS /////

	// Hypnotic Glance
window.getHypnoticGlanceSocInt = function(type) {
	var socInt = new SocInt();
	socInt.key = "hypnoticGlance";
	socInt.title = "Hypnotic Glance";
	socInt.socialDriveCost = 3;
	socInt.willpowerCost = 2;
	
	socInt.tags = ["dominant"];
	socInt.driveTags.push("dDomination");
	
	socInt.weight = 10; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		var flagValid = false;
		if ( gC(actor).hasFreeBodypart("eyes") ) {
			flagValid = true;
		}
		return flagValid;
	}
	socInt.isUsable = function(sis,actor,target,observers,extraData) {
		// Determines if the interaction is usable on the selected target
		var flagUsable = false;
		if ( (gC(actor).socialdrive.current >= this.socialDriveCost && gC(actor).energy.current >= this.energyCost && gC(actor).willpower.current >= this.willpowerCost) && gC(actor).hasFreeBodypart("eyes") ) {
			flagUsable = true;
		}
		return flagUsable;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight;
		//nWeight *= 1 + gC(actor).mood.intimate * 0.1 + gC(actor).mood.aroused * 0.1 - gC(actor).mood.angry * 0.2;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ (ktn(this.actor) + " looks at " + ktn(this.target) + " in a notoriously confident way. " + ktn(this.target) + " listens to " + gC(this.actor).posPr + " every word..."),
									 (ktn(this.actor) + " maintains a mesmerizing expression that " + ktn(this.target) + " can't keep " + gC(this.target).posPr + " eyes off."),
									 ("As " + ktn(this.actor) + " talks, " + ktn(this.target) + " can't draw " + gC(this.target).posPr + " eyes off " + gC(this.actor).posPr + " face.")
									] );
		return desc;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += ( gCstat(this.actor,"charisma") * 0.035 + gCstat(this.actor,"will") * 0.015 );
		return mult;
	}
	socInt.getMoodVectorTarget = function() {
		var mVector = new MoodVector(0,0,0,1,-1,3,0,-1);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(0,0,0,0,2,0,0,0);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,0,0,0,0,1);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() {
		var mult = 1;
		mult += ( gCstat(this.actor,"charisma") * 0.035 + gCstat(this.actor,"will") * 0.015 );
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(0,0,0,0,3,0,-1);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(0,0,0,2,0,0,0);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	socInt.getWillpowerDamage = function(actor,target) {
		var damage = 1 + gCstat(actor,"will") * 0.025 + gCstat(actor,"charisma") * 0.015;
		return damage;
	}
	socInt.furtherEffects = function(sis) {
		if ( this.actor == "chPlayerCharacter" ) { addToStVarsList("monActUs"); }
		var eText = "\n" + gC(this.target).formattedName + " received " + textWillpowerDamage(-gC(this.target).willpower.attackInConversation(-this.getWillpowerDamage(this.actor,this.target))) + ".";
		sis.extraEffects += eText; 
	}
	
	return socInt;
}

	// Relaxing incense
window.getRelaxingScent = function(type) {
	var socInt = new SocInt();
	socInt.key = "relaxingScent";
	socInt.title = "Relaxing Scent";
	socInt.socialDriveCost = 3;
	socInt.priority = 0;
	
	socInt.tags = ["friendly","intimate","submissive"];
	socInt.driveTags.push("dCooperation");
	socInt.strategyTags.push("angerDown","selfSubmissionDown");
	
	socInt.weight = 10; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		return true;
	}
	socInt.isUsable = function(sis,actor,target,observers,extraData) {
		// Determines if the interaction is usable on the selected target
		var flagUsable = false;
		if ( (gC(actor).socialdrive.current >= this.socialDriveCost) ) {
			flagUsable = true;
		}
		return flagUsable;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight + gC(actor).mood.submissive * 0.1 + gC(actor).mood.friendly * 0.05 - gC(actor).mood.angry * 0.1;
		//nWeight *= 1 + gC(actor).mood.intimate * 0.1 + gC(actor).mood.aroused * 0.1 - gC(actor).mood.angry * 0.2;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ ( "A relaxing scent fills the air, and it soon fills your lungs." ),
									 ( ktn(this.actor) + " smells funny... And the smell makes you want to close your eyes."),
									 ( "A gentle fragance is coming from " + ktn(this.actor) + "." )
									] );
		return desc;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += ( gCstat(this.actor,"will") * 0.025 + gCstat(this.actor,"resilience") * 0.015 + gCstat(this.actor,"luck") * 0.015 );
		return mult;
	}
	socInt.getMoodVectorTarget = function() { // (frie,inti,flir,arou,domi,subm,bore,angr)
		var mVector = new MoodVector(1,1,0,0,-2,0,0,-3);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(0,1,0,0,0,0,0,-2);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(1,1,0,0,-2,0,0,-3);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() { // frie,sext,roma,domi,subm,riva,enmi
		var mult = 1;
		mult += ( gCstat(this.actor,"will") * 0.025 + gCstat(this.actor,"resilience") * 0.015 + gCstat(this.actor,"luck") * 0.015 );
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(1,0,0,-1,0,-1,-1);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,0,0,-1,0,-1,-1);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(1,0,0,-1,0,-1,-1);
		return rVector;
	}
	
	return socInt;
}

	// Telephatic connection
window.getTelephaticConnection = function(type) {
	var socInt = new SocInt();
	socInt.key = "telephaticConnection";
	socInt.title = "Telephatic Connection";
	socInt.socialDriveCost = 2;
	socInt.willpowerCost = 2;
	socInt.priority = 0;
	
	socInt.tags = ["friendly","intimate"];
	socInt.driveTags = ["dLove"];
	
	socInt.weight = 10; // Starting weight
	
	socInt.isValid = function(sis,actor,target,observers,extraData) {
		return true;
	}
	socInt.isUsable = function(sis,actor,target,observers,extraData) {
		// Determines if the interaction is usable on the selected target
		var flagUsable = false;
		if ( (gC(actor).socialdrive.current >= this.socialDriveCost && gC(actor).energy.current >= this.energyCost && gC(actor).willpower.current >= this.willpowerCost) ) {
			flagUsable = true;
		}
		return flagUsable;
	}
	socInt.getWeight = function(sis,actor,target,observers,extraData) {
		var nWeight = this.weight + gC(actor).mood.intimate * 0.1 + gC(actor).mood.friendly * 0.05 - gC(actor).mood.angry * 0.2 - gC(actor).mood.bored * 0.05;
		return nWeight;
	}
	
	socInt.getDescription = function() {
		var desc = randomFromList( [ ( ktn(this.actor) + "'s and " + ktn(this.target) + "'s eyes meet, and their faces freeze for a moment." ),
									 ( ktn(this.actor) + " has captured " + ktn(this.target) + "'s attention. They do not need words to express their feelings." )
									] );
		return desc;
	}
	
	socInt.getMoodMultiplier = function() {
		var mult = 1;
		mult += ( gCstat(this.actor,"will") * 0.025 + gCstat(this.actor,"intelligence") * 0.015 + gCstat(this.actor,"empathy") * 0.015 );
		return mult;
	}
	socInt.getMoodVectorTarget = function() { // (frie,inti,flir,arou,domi,subm,bore,angr)
		var mVector = new MoodVector(2,5,0,0,0,0,-1,-3);
		return mVector;
	}
	socInt.getMoodVectorActor = function() {
		var mVector = new MoodVector(1,4,0,0,0,0,-1,-2);
		return mVector;
	}
	socInt.getMoodVectorObservers = function() {
		var mVector = new MoodVector(0,0,0,0,0,0,0,0);
		return mVector;
	}
	
	socInt.getRelationMultiplier = function() { // frie,sext,roma,domi,subm,riva,enmi
		var mult = 1;
		mult += ( gCstat(this.actor,"will") * 0.025 + gCstat(this.actor,"intelligence") * 0.015 + gCstat(this.actor,"empathy") * 0.015 );
		return mult;
	}
	socInt.getRelationVectorTarget = function() {
		var rVector = new RelationVector(2,0,5,0,0,0,-1);
		return rVector;
	}
	socInt.getRelationVectorActor = function() {
		var rVector = new RelationVector(1,0,3,0,0,0,-1);
		return rVector;
	}
	socInt.getRelationVectorObservers = function() {
		var rVector = new RelationVector(0,0,0,0,0,0,0);
		return rVector;
	}
	
	return socInt;
	
}

////////// SOCIAL INTERACTIONS DATABASE //////////
// Social Interactions Database, get their requirements, effects, etc. from here

window.siDatabase = function() {
	// Greet
	this.greetFriendly = getGreetSocInt("friendly");
	this.greetWarm = getGreetSocInt("warm");
	this.greetFlirtatious = getGreetSocInt("flirtatious");
	this.greetCold = getGreetSocInt("cold");
	this.greetSad = getGreetSocInt("sad");
	this.greetRespectful = getGreetSocInt("respectful");
	// Chat
	this.chatWeather = getChatSocInt("weather");
	this.chatRoutine = getChatSocInt("routine");
	this.chatFeelings = getChatSocInt("feelings");
	this.chatActivities = getChatSocInt("activities");
	// Talk about
	this.talkAboutFauna = getTalkAboutSocInt("fauna");
	this.talkAboutFlora = getTalkAboutSocInt("flora");
	this.talkAboutTraining = getTalkAboutSocInt("training");
	this.talkAboutDramas = getTalkAboutSocInt("dramas");
	this.talkAboutMusic = getTalkAboutSocInt("music");
	// Gossip about
	this.gossipAboutChPlayerCharacter = getGossipAbout("chPlayerCharacter","Player");
	this.gossipAboutChVal = getGossipAbout("chVal","Valtan");
	this.gossipAboutChMir = getGossipAbout("chMir","Padmiri");
	this.gossipAboutChNash = getGossipAbout("chNash","Nashillbyir");
	this.gossipAboutChClaw = getGossipAbout("chClaw","Claw");
	this.gossipAboutChAte = getGossipAbout("chAte","Maaterasu");
	// Praise/Criticize char
	var it = 0;
	var charNames = ["Player","Valtan","Padmiri","Nashillbyir","Claw","Maaterasu"];
	for ( var charKey of ["chPlayerCharacter","chVal","chMir","chNash","chClaw","chAte"] ) {
		this[("praiseChar" + firstToCap(charKey))] = getPraiseChar(charKey,charNames[it]);
		this[("criticizeChar" + firstToCap(charKey))] = getCriticizeChar(charKey,charNames[it]);
		it++;
	}
	// Ask about values
	this.askAboutValues = getAskAboutValues("nothing");
	// Compliment
	this.complimentMood = getComplimentSocInt("mood");
	this.complimentLooks = getComplimentSocInt("looks");
	this.complimentPersonality = getComplimentSocInt("personality");
	// Patronize, apologize, cool moods down, assert yourself
	this.patronize = getPatronizeSocInt();
	this.apologize = getApologizeSocInt();
	this.coolMoodsDown = getCoolMoodsDownSocInt();
	this.selfAssert = getSelfAssertSocInt();
	// Give Stroke
	this.giveStrokeEar = getGiveStrokeSocInt("ear");
	this.giveStrokeFace = getGiveStrokeSocInt("face");
	this.giveStrokeHeadpat = getGiveStrokeSocInt("headpat");
	// Ask for stroke
	this.askForStrokeEar = getAskForStrokeSocInt("ear");
	this.askForStrokeFace = getAskForStrokeSocInt("face");
	this.askForStrokeHeadpat = getAskForStrokeSocInt("headpat");
	// Insult
	this.insultAttitude = getInsultSocInt("attitude");
	this.insultIdeals = getInsultSocInt("ideals");
	this.insultLooks = getInsultSocInt("looks");
	// Physical
	this.handholding = getHandholdingSocInt("");
	this.embrace = getEmbraceSocInt("");
	this.sensualStrokeLegs = getSensualStroke("legs");
	this.strokeButt = getStrokeButtSocInt();
	this.teaseCrotch = getTeaseCrotchSocInt();
	this.kiss = getKissSocInt("kiss");
};

window.siExtraDatabase = function() {
	// Hypnosis
	this.hypnoticGlance = getHypnoticGlanceSocInt("hypnoticGlance");
	this.relaxingScent = getRelaxingScent();
}

setup.siList = new siDatabase();
setup.siListExtra = new siExtraDatabase();

window.getSiByKey = function(key) {
	if ( setup.siList.hasOwnProperty(key) ) {
		return setup.siList[key];
	} else {
		return setup.siListExtra[key];
	}
}

window.getAllSocialInteractions = function() {
	var siList = []; // Social Interaction Keys
	
	for ( var si in setup.siList ) {
		if ( setup.siList[si].hasOwnProperty("title") ) {
//		if ( setup.siList[si] instanceof SocInt ) {
			siList.push(setup.siList[si].key);
		}
	}
	
	return siList;
}
window.getAllCharExtraSocialInteractions = function(charKey) {
	var extraSiList = []; // Social Interactions Keys
	
	for ( var si of gC(charKey).extraSocIntList ) {
		if ( setup.siListExtra[si].hasOwnProperty("title") ) {
			extraSiList.push(setup.siListExtra[si].key);
		}
	}
	
	return extraSiList
}
// Constructors, serializers, etc.
siDatabase.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
siDatabase.prototype.clone = function () {
	return (new siDatabase())._init(this);
};
siDatabase.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new siDatabase())._init($ReviveData$)', ownData);
};

siExtraDatabase.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
siExtraDatabase.prototype.clone = function () {
	return (new siExtraDatabase())._init(this);
};
siExtraDatabase.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new siExtraDatabase())._init($ReviveData$)', ownData);
};





setup.conversationRelationMultiplier = 3; // Conversation relationship changes are multiplied by this constant.

////////// SIS Player Info  //////////
// Short set of data containing controls info
window.SisPlayerInfo = function() {
	this.currentTarget = "";
	this.lastTarget = "";
	
	this.currentInteraction = "";
	
	this.flagRejectedSis = false;
	this.rejectedSisPassage = "";
	this.playerPrompt = "";
	
	this.clean = function() {
		this.currentTarget = "";
		this.lastTarget = "";
		
		this.currentInteraction = "";
	}
	this.autoSelectNewTarget = function() {
		var flagChosenTarget = false;
		for ( var character of State.variables.compass.sisList[State.variables.compass.pcSis].charList ) {
			if ( flagChosenTarget == false && character != "chPlayerCharacter" ) {
				this.currentTarget = character;
				this.lastTarget = character;
				flagChosenTarget = true;
			}
		}
	}
}

window.selectTarget = function(character) {
	// This function would be a part of SisPlayerInfo, but I can't directly access the object from HTML
	State.variables.sisPlayerInfo.currentTarget = character;
	// This receives HTML format, not Twine format. A fix would be useful
	/*
	document.getElementById("playerInteractions").innerHTML =
	State.variables.compass.sisList[State.variables.compass.pcSis].formatPlayerInteractionsToTarget(
		character,State.variables.compass.sisList[State.variables.compass.pcSis].getPlayerOfferedInteractions()
	);
	*/
}

State.variables.sisPlayerInfo = new SisPlayerInfo();

// Constructors, serializers, etc.
SisPlayerInfo.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
SisPlayerInfo.prototype.clone = function () {
	return (new SisPlayerInfo())._init(this);
};
SisPlayerInfo.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new SisPlayerInfo())._init($ReviveData$)', ownData);
};

////////// SOCIAL INTERACTIONS SYSTEM CLASS  //////////
// Social Interaction "Event"

window.SocIntSys = function(key,charList) {
	this.key = key;
	this.charList = charList; // List of char keys
	this.charInteractions = []; // List of lists. Each list represents the interactions offered to each character participating in the conversation,
								// the list's position is the same as its character's position in this.charList
	
	this.importantMessages = "";
	this.interactionsDescription = "";
	this.moodChangesDescription = "";
	this.relationChangesDescription = "";
	this.expGainsDescription = "";
	this.descriptionsText = ""; // Sums all descriptions about the last round's results
	
	this.passageText = "TestText";
	
	this.flagPlayerLeftAlone = false;
	
	this.flagPlayerIsPrompted = false;
	this.playerPromptText = "";
	
	this.flagPlayerTakenToScene = false;
	
		// Data
	this.roundsCount = 0;
	this.roundsData = []; // Each dot in the list is a round, represented as a list "[]"
						  // Each dot in the new list is one character's data, represented as a list "[]"
						  // Each dot is this new list is: character's key "chChar", target's key "chTarget", interaction's key, "chatWhatever"
						  
	this.charMoodChanges = []; // It gains each character as a property, its value is a mood vector
	this.charRelChanges = []; // It gains each character as a property, which gains each other character as its own property, their values
							  // are relationship vectors
	this.extraEffects = "";
	
	this.tempLeftSis = [];
	
	// UI
	this.formatPassageText = function() {
		
		this.passageText = "";
		
		if ( State.variables.sisPlayerInfo.playerPrompt == "" && State.variables.sisPlayerInfo.flagRejectedSis == false && this.flagPlayerIsPrompted == false ) {
			// Important messages
			if ( this.importantMessages != "" ) {
				this.passageText += "<div class='standardBox'>" + colorText(this.importantMessages,"red") + "</div>\n";
				this.importantMessages = "";
			}
			
			// If player left or forced to leave, button to leave
			if ( this.flagPlayerTakenToScene == true ) {
				this.passageText += this.getButtonTakenToScene() + "\n\n";
			}
			else if ( this.charList.includes("chPlayerCharacter") == false ) {
				this.passageText += this.getButtonForcedOutOfSis() + "\n\n";
			}
			
			// Characters
			this.passageText += "<div class='standardBox'>" + "Characters present: " + getCharNames(this.charList) + "</div>\n";
			
			this.formatDescription();
			if ( this.descriptionsText != "" ) {
				this.passageText += "<div class='standardBox'>" + this.descriptionsText + "</div>\n"; 
			}
			
			this.moodChangesDescription = "";
			this.descriptionsText = "";
			
			// Is player alone?
			if ( this.flagPlayerLeftAlone == false || this.charList.length > 1 ) {  // Player not alone
				this.flagPlayerLeftAlone = false;
				
				if ( this.charList.includes("chPlayerCharacter") ) {
					// Targets
					this.passageText += this.formatTargetsButtons() + "\n";
					
					// Interactions
					var it = 0;
					var itA = this.charList[it];
					while ( itA != "chPlayerCharacter" ) {
						it++;
						itA = this.charList[it];
					}
				}
				
				this.passageText += this.formatPlayerInteractionsToTarget(State.variables.sisPlayerInfo.currentTarget,this.charInteractions[it]);
				
				var flagExtraOptions = true;
				if ( this.flagPlayerTakenToScene == true ) {
					flagExtraOptions = false;
				} else if ( gC("chPlayerCharacter").followingTo != "" ) {
					if ( (gC("chPlayerCharacter").followingTo == gC("chPlayerCharacter").domChar) || ((gC("chPlayerCharacter").followingForDebt == true) && rFavor("chPlayerCharacter",gC("chPlayerCharacter").followingTo) > 0 ) ) {
						flagExtraOptions = false;
					}
				}
				
				if ( flagExtraOptions ) {
					if ( gC("chPlayerCharacter").followingTo == "" ) {
						// Specific interactions
						this.passageText += "\n" + this.getButtonSisSpecifics();
					}
					
					// Get out of SIS
					this.passageText += "\n" + this.getButtonEndSis();
				}
			}
			else { // Player alone
				this.passageText += this.getButtonEndDeadSis();
			}
		}
		else if ( State.variables.sisPlayerInfo.playerPrompt != "" ) {
			this.passageText = State.variables.sisPlayerInfo.playerPrompt;
			State.variables.sisPlayerInfo.playerPrompt = "";
		}
		else if ( this.flagPlayerIsPrompted ) {
			this.passageText = this.playerPromptText;
		}
		else {
			this.passageText = State.variables.sisPlayerInfo.rejectedSisPassage;
		}
		
	}
	
	this.formatTargetsButtons = function() {
		var potentialTargets = [];
		for ( var c of this.charList ) {
			if ( c != "chPlayerCharacter" ) {
				potentialTargets.push(c);
			}
		}
		
		var flagNoTarget = false;
		if ( State.variables.sisPlayerInfo.currentTarget == "" ) {
			flagNoTarget = true;
			State.variables.sisPlayerInfo.currentTarget = potentialTargets[0];
		}
		var i = 0;
		
		var bText = '<span style="color:darkgray"'+'>__Target__:\n</'+'span>' + "<" + "html>\n";
		for ( var t of potentialTargets ) {
			bText += "<input type='radio' id='" + t + "' name='target' value='" + t + "' ";
			if ( (flagNoTarget == true && i == 0) || State.variables.sisPlayerInfo.lastTarget == t ) {
				bText += 'checked="checked" ';
			}
			bText += 'onclick="selectTarget(' + "'" + t + "'" + ')">\n';
			bText += "<label for='" + t + "'>" + firstToCap(gC(t).name) + "</" + "label><br>";
			i++;
		}
		bText += "</" + "html>";
		
		return bText;
	}
	
	this.formatMoodChanges = function() {
		
		var desc = ""; // '<span style="color:darkgray"'+'>__Mood changes__:\n</'+'span>';
		for ( var cmc in this.charMoodChanges ) {
			if ( this.charMoodChanges[cmc].hasOwnProperty("friendly") ) {
				desc += gC(this.charMoodChanges[cmc].name).formattedName + ": ";
				for ( var m of ["friendly","intimate","flirty","aroused","dominant","submissive","bored","angry"] ) {
					if ( this.charMoodChanges[cmc][m] != 0 ) {
						desc += '<span title="' + firstToCap(m) + '">' + img(m) + '</' + 'span>' + " " //  firstToCap(m[0]) + m[1] +
						      + this.charMoodChanges[cmc][m].toFixed(2) + " "; //| ";
						// <span title="Hover text">[[test]]</span>
					}
				}
				desc += "\n";
			}
		}
		if ( desc != "" ) {
			this.moodChangesDescription = '<span style="color:darkgray"'+'>__Mood changes__:\n</'+'span>' + desc;
		} else {
			this.moodChangesDescription = "";
		}
	}
	
	this.formatRelationChanges = function() {
		var desc = "";
		var i = 0;
		for ( var crc in this.charRelChanges ) {
			if ( this.charRelChanges[crc].hasOwnProperty("name") ) {
				if ( this.charRelChanges[crc].name == "chPlayerCharacter" ) {
					// Player changes towards
					for ( var ch in this.charRelChanges[crc] ) {
						if ( this.charRelChanges[crc][ch].hasOwnProperty("name") ) {
							var tDesc = "";
							var anyChange = false;
							tDesc += gC("chPlayerCharacter").formattedName + " -> " + gC(this.charRelChanges[crc][ch].name).formattedName + ": ";
							for ( var t of ["friendship","sexualTension","romance","domination","submission","rivalry","enmity"] ) {
								if ( this.charRelChanges[crc][ch][t] != 0 ) {
									anyChange = true;
									tDesc += '<span title="' + firstToCap(t) + '">' + firstToCap(t[0]) + t[1] + '</' + 'span>' + ": "
										  + this.charRelChanges[crc][ch][t].toFixed(2) + " | ";
								}
							}
							if ( anyChange ) {
								if ( i > 0 ) { desc += "\n"; }
								desc += tDesc;
								i++;
							}							
						}
					}
				}
				else if ( this.charRelChanges[crc].hasOwnProperty("chPlayerCharacter") ) {
					// Changes towards Player
					var tDesc = "";
					var anyChange = false;
					tDesc += gC(this.charRelChanges[crc].name).formattedName + " -> " + gC("chPlayerCharacter").formattedName + ": ";
					for ( var t of ["friendship","sexualTension","romance","domination","submission","rivalry","enmity"] ) {
						if ( this.charRelChanges[crc].chPlayerCharacter[t] != 0 ) {
							anyChange = true;
							tDesc += '<span title="' + firstToCap(t) + '">' + firstToCap(t[0]) + t[1] + '</' + 'span>' + ": "
							      + this.charRelChanges[crc].chPlayerCharacter[t].toFixed(2) + " | ";
						}
					}
					if ( anyChange ) {
						if ( i > 0 ) { desc += "\n"; }
						desc += tDesc;
						i++;
					}
				}
			}
		}
		if ( desc != "" ) {
			this.relationChangesDescription = '<span style="color:darkgray"'+'>__Relation changes__:</'+'span>\n' + desc;
		}
	}
	
	this.formatDescription = function() {
		this.descriptionsText = "";
		
		if ( this.interactionsDescription != "" ) {
			this.descriptionsText += '<span style="color:darkgray"'+'>__Results__:\n</'+'span> ';
			this.descriptionsText += this.interactionsDescription + "\n";
		}
		this.formatMoodChanges();
		this.formatRelationChanges();
		if ( this.moodChangesDescription != "" ) {
			this.descriptionsText += this.moodChangesDescription + "\n";
		}
		if ( this.relationChangesDescription != "" ) {
			this.descriptionsText += this.relationChangesDescription;
		}
		if ( this.expGainsDescription != "" ) {
			this.descriptionsText += '\n\n<span style="color:darkgray"'+'>__Experience__:</'+'span>' + this.expGainsDescription;
		}
		if ( this.extraEffects != "" ) {
			this.descriptionsText += '\n\n<span style="color:darkgray"'+'>__Extra effects__:</'+'span>' + this.extraEffects;
			this.extraEffects = "";
		}
	}
	
	this.formatInteractionChoice = function(si) {
		var iText = "";
		
		if ( getSiByKey(si).isUsable(this,"chPlayerCharacter",State.variables.sisPlayerInfo.currentTarget,[],0) == false ) {
			iText = '<span style="color:firebrick"'+'>Locked: ' + getSiByKey(si).title + " (Cost: " + getSiByKey(si).socialDriveCost;
				if ( getSiByKey(si).energyCost > 0 ) {
					iText += ", " + getSiByKey(si).energyCost;
				}
				if ( getSiByKey(si).willpowerCost > 0 ) {
					iText += ", " + getSiByKey(si).willpowerCost;
				}
       		iText += ")" + '</'+'span>';
		} else {
			iText = "- ";
			for ( var tag of getSiByKey(si).tags ) {
					iText += '<span title="' + firstToCap(tag) + '">' + img(tag) + "</" + "span> ";
			}
			iText += this.getButtonPlayerPicksAction(si,State.variables.sisPlayerInfo.currentTarget)
			      + " (Cost: " + '<span style="color:khaki"' + '>' + getSiByKey(si).socialDriveCost + '</'+'span>';
				  if ( getSiByKey(si).energyCost > 0 ) {
					  iText += ', <span style="color:darkslateblue"' + '>' + getSiByKey(si).energyCost + '</' + 'span>'
				  }
				  if ( getSiByKey(si).willpowerCost > 0 ) {
					  iText += ', <span style="color:limegreen"' + '>' + getSiByKey(si).willpowerCost + '</' + 'span>'
				  }
			iText += ')';
		}
		
		return iText;
	}
	
	this.formatPlayerInteractionsToTarget = function(target,interactionsList) {
		var iText = "";
		
		if ( this.charList.includes("chPlayerCharacter") ) {
			//iText += "\* " + this.getButtonPlayerDoesNothing() + "\n";
		}
		
		iText += '<p id="playerInteractions">';
		
		if ( this.charList.includes("chPlayerCharacter") ) {
			iText += "\* " + this.getButtonPlayerDoesNothing() + " <br>";
			for ( var interaction of interactionsList ) {
				if ( getSiByKey(interaction).isUsable(this,"chPlayerCharacter",target,[],0) == false ) {
				iText += '<span style="color:firebrick"'+'>Locked: ' + getSiByKey(interaction).title + " (Cost: "
					  + getSiByKey(interaction).socialDriveCost + ")" + '</'+'span>';
				}
				else {
					iText += "\* ";
					for ( var tag of getSiByKey(interaction).tags ) {
						iText += '<span title="' + firstToCap(tag) + '">' + img(tag) + "</" + "span> ";
					}
					iText += this.getButtonPlayerPicksAction(interaction,State.variables.sisPlayerInfo.currentTarget)
					  + " (Cost: " + '<span style="color:khaki"' + '>' + getSiByKey(interaction).socialDriveCost + '</'+'span>)';
				}
				iText += "<br>";
			}
		}
		
		iText += '</' + 'p>';
		return iText;
	}
	
	
	// Logic
	this.getAllValidInteractionsChar = function(character) {
		
		var allInteractions = getAllSocialInteractions(); // These are keys
		var allExtraInteractions = getAllCharExtraSocialInteractions(character);
		var validInteractions = [];
		
		for ( var iKey of allInteractions.concat(allExtraInteractions) ) {
			if ( getSiByKey(iKey).isValid(this,character,"chDummy",[],null) ) {
				var valid = true;
				if ( gSettings().lewdMales == "disable" ) {
					if ( character != "chPlayerCharacter" && gC(character).perPr == "he" ) {
						if ( getSiByKey(iKey).tags.includes("flirty") || getSiByKey(iKey).tags.includes("aroused") ) {
							valid = false;
						}
					}
				}
				if ( valid ) {
					validInteractions.push(iKey);
				}
			}
		}
		
		return validInteractions;
	}
	
	this.getOfferedInteractionsToChar = function(character,numInteractions) {
		// Generates potential interactions for a character to choose from
		// numInteractions is the amount of requested interactions
		
		var validInteractions = this.getAllValidInteractionsChar(character);
		var wList = new weightedList();
		var viAmount = 0;
		var nInteractions = numInteractions;
		
		for ( var interaction of validInteractions ) {	// wList is turned into a list containing all valid interactions, with their corresponding weight
			wList[interaction] = new weightedElement(interaction,getSiByKey(interaction).getWeight(this,character,"chDummy",[],null));
			viAmount++;
		}
		if ( nInteractions > viAmount ) {  // If the amount of requested interactions is bigger than available interactions, less interactions
										   // will be returned
			nInteractions = viAmount;
		}
		
		var offInteractionsList = [];
		var oilN = 0;
		var newInteraction = "";
		
		while ( oilN < nInteractions ) {  // Interactions added to offeredInteractionsList will be removed from wList
			newInteraction = randomFromWeightedList(wList);
			offInteractionsList.push(newInteraction);
			wList[newInteraction] = false;
			oilN++;
		}
		
		return offInteractionsList;
	}
	
	this.npcsMakeInterRoundDecisions = function() {
		var allowOtherCostlyDecisions = true;
		var actions = [];
		var chars = [];
		
		for ( var character of this.charList ) { chars.push(character) }
		for ( var character of chars ) {
			gC(character).wasPromptedInCurrentSisRound = false;
		}
		for ( var character of this.charList ) {	// Get all actions from characters
			if ( character != "chPlayerCharacter" && gC(character).followingTo == "" ) {
				var charAction = gC(character).socialAi.getInterRoundBehavior(this);
				
				if ( charAction[0] != "none" ) {
					actions.push([character].concat(charAction));
				}
			}
		}
		for ( var action of actions ) {				// Execute all actions, provided it's possible
			var actor = action[0];
			var target = action[2];
			if ( this.tempLeftSis.includes(actor) == false && this.tempLeftSis.includes(target) == false ) {
					if ( target == "" ) {
						switch(action[1]) {
							case "leave":							// Leaving
								this.tempLeftSis.push(actor);
								this.charsLeaveSis(getCharGroup(actor));
								this.importantMessages += getCharNames(getCharGroup(actor)) + " has left the conversation.\n";
								if ( actor == State.variables.sisPlayerInfo.currentTarget ) {
									State.variables.sisPlayerInfo.autoSelectNewTarget();
								}
								break;
						}
					}
					else if ( this.charList.includes(target) && gC(target).wasPromptedInCurrentSisRound == false ) {
						if ( target == "chPlayerCharacter" ) { gC("chPlayerCharacter").wasPromptedInCurrentSisRound = true; }
						switch(action[1]) {
							case "leave":							// Leaving
								this.charsLeaveSis(getCharGroup(actor));
								this.importantMessages += gC(actor).getName() + " has left the conversation.\n";
								if ( actor == State.variables.sisPlayerInfo.currentTarget ) {
									State.variables.sisPlayerInfo.autoSelectNewTarget();
								}
								break;
						}
						if ( action[1] != "leave" ) {
							if ( allowOtherCostlyDecisions ) {
								this.executeStandardSistEffects(action[1],actor,target);
								allowOtherCostlyDecisions = false;
							}
						}
					}
			}
		}
		for ( var character of chars ) {
			gC(character).wasPromptedInCurrentSisRound = false;
		}
	}
	this.executeStandardSistEffects = function(sistId,actor,target) {
		// This gets executed when a character other than the player's executes a sist. For player, check processTopicResult()
		// var sist = State.variables.sistDB[sistId];
		var sist = setup.sistDB[sistId];
		if ( sist.isPossible(actor,target) ) { // Is it possible
			if ( gC(actor).socialdrive.current >= sist.getSocialdriveOfferCost(actor,target) ) {
				gC(actor).socialdrive.current -= sist.getSocialdriveOfferCost(actor,target);
				if ( target == "chPlayerCharacter" ) {
					sist.askToPlayer(actor,target,this.key);
				}
				else { // Is it successful
					var isSuccessful = sist.isSuccessful(actor,target);
					this.importantMessages += isSuccessful[2] + "\n";
					if ( isSuccessful[0] ) {
						gC(actor).wasPromptedInCurrentSisRound = true;
						gC(target).wasPromptedInCurrentSisRound = true;
						sist.getSuccessEffect(actor,target);
					}
					else {
						sist.getFailEffect(actor,target);
					}
				}
			}
		}
		
	}
	
	this.applyExpGains = function(charsNactions) {
		var roundMult = this.roundsCount * 0.2 - ((this.roundsCount * 0.2) % 1);
		if ( roundMult > 3 ) { roundMult = 3; }
		if ( roundMult >= 1 ) {
			var mult = roundMult * ( 0.4 + this.charList.length * 0.3 );
			for ( var cNa of charsNactions ) {
				var charKey = cNa[0];
				var chaExp = 2 * gC(charKey).charisma.affinity * mult;
				var empExp = 2 * gC(charKey).empathy.affinity * mult;
				gC(charKey).charisma.experience += chaExp;
				gC(charKey).empathy.experience += empExp;
				this.expGainsDescription += "\n" + gC(charKey).getFormattedName() + " has gained " + chaExp.toFixed(1) + " and " + empExp.toFixed(1) + " charisma and empathy exp.";
			}
		}
	}
	
	// Logic (The heavy stuff)
	this.preInitiateNewRoundNoPC = function(flagInterrounds) {
		if ( flagInterrounds ) {
			this.npcsMakeInterRoundDecisions();
		}
		if ( this.charList.length > 0 ) {
			this.initiateNewRound();
		}
	}
	this.preInitiateNewRoundWithPC = function() {
		this.npcsMakeInterRoundDecisions();
	}
	this.initiateNewRound = function() {
		if ( State.variables.compass.flagEndedScenario == false ) {
			var newSevent = createSystemEventSisRound(this.charList,this.key);
			State.variables.compass.ongoingEvents.push(newSevent);

			State.variables.compass.sortOnGoingEventsByTime();
		} else {
			
		}
	}
	this.processRound = function() {
		this.tempLeftSis = [];
		// Data clean
		this.charMoodChanges = [];
		this.charRelChanges = [];
		this.interactionsDescription = "";
		this.expGainsDescription = "";
		
		// Get interactions and order them
		this.charInteractions = [];
		this.feedCharInteractionsOptionsList();
		var charsNactions = []; // List of lists with charKeys, targetKeys and interactions keys,
								// such as [["chVal","chNash","flirt"],["chNash","chVal","patronize"]]
							
		charsNactions = this.processCharsInteractions();
		charsNactions = this.orderInteractions(charsNactions);
		
		var interactionsList = [];
		for ( var cNa in charsNactions ) {
			if (charsNactions[cNa][2] != "doNothing" && charsNactions[cNa][2] != "") {
				var valid = true;
				if ( gSettings().lewdMales == "disable" ) {
					if ( getSiByKey(charsNactions[cNa][2]).tags.includes("flirty") || getSiByKey(charsNactions[cNa][2]).tags.includes("aroused") ) {
						if ( isLewdingPossible(charsNactions[cNa][0],charsNactions[cNa][1]) == false ) {
							valid = false;
						}
					}
				}
				if ( valid ) {
					interactionsList.push(this.createInteraction(charsNactions[cNa]));
				}
			}
		}
		// Process interactions' logic
		for ( var interaction of interactionsList ) {
			this.interactionExtraEffect(interaction);
			this.interactionMoodChanges(interaction);
			this.interactionRelationChanges(interaction);
			interaction.furtherEffects(this);
			gC(interaction.actor).socialdrive.current -= interaction.socialDriveCost;
			gC(interaction.actor).willpower.current -= interaction.willpowerCost;
			gC(interaction.actor).energy.current -= interaction.energyCost;
			this.interactionsDescription += interaction.getDescription() + "\n";
		}
		
		this.applyExpGains(charsNactions);
		
		// Remember player pick
		State.variables.sisPlayerInfo.lastTarget = State.variables.sisPlayerInfo.currentTarget;
			
		// End round
		this.roundsData.push(charsNactions);
		this.roundsCount++;
	}
	
	this.processCharsInteractions = function() {
		var results = [];
		for ( var character of this.charList ) {
			if ( character == "chPlayerCharacter" ) {
				if ( State.variables.sisPlayerInfo.currentInteraction != "none" ) {
					results.push([character,State.variables.sisPlayerInfo.currentTarget,State.variables.sisPlayerInfo.currentInteraction]);
				}
			}
			else {
				// TO DO: AI
				// Temporary: AI characters use a random weighted action
				/*
				var target = randomFromList(arrayMinusA(this.charList,character));			// Target is chosen at random
				
				if ( target != undefined && target != null ) {
					// TO DO
					var offeredInteractions = this.getOfferedInteractionsToChar(character,getCharsNumberInteractions(character));	// Character is offered interactions
					
					var usableInteractions = [];
					for ( var interaction of offeredInteractions ) {							// Unusable interactions are purged
						if ( interaction != "errorWList" ) {
							if ( getSiByKey(interaction).isUsable(this,character,target,[],null) ) {
								usableInteractions.push(interaction);
							}
						}
					}
					
					if ( usableInteractions.length > 0 ) {										// A command for the character to use interaction on target
																								// is pushed to results
						results.push([character,target,gC(character).socialAi.chooseSISinteraction(target,usableInteractions)]);
						// randomFromList(usableInteractions)]);
													   // Edit this randomFromList -> Function that receives actor,target and possible interactions,
													   // and chooses the most appropiate one
					}
				}
				*/
				
				var offeredInteractions = this.getOfferedInteractionsToChar(character,getCharsNumberInteractions(character));	// Character is offered interactions
				
				var usableInteractions = [];
				for ( var interaction of offeredInteractions ) {							// Unusable interactions are purged
					if ( interaction != "errorWList" ) {
						if ( getSiByKey(interaction).isUsable(this,character,character,[],null) ) {
							usableInteractions.push(interaction);
						}
					}
				}
					
				var chosenInteraction = chooseActorsSISinteractionTarget(character,this,usableInteractions);
				results.push([character,chosenInteraction[1],chosenInteraction[0]]);
			}
		}
		return results;
	}
	this.orderInteractions = function(charsNactions) {
		// TO DO
		return charsNactions;
	}
	this.createInteraction = function(cNa) {
		var draftInteraction = getSiByKey(cNa[2]);
		var interaction = JSON.parse(JSON.stringify(draftInteraction));
		//var interaction = Object.assign({}, getSiByKey(cNa[2])); // Copies interaction from the data base
		interaction.actor = cNa[0];
		interaction.target = cNa[1];
		interaction.observers = [];
		for ( var c of this.charList ) {
			if ( c != cNa[0] && c!= cNa[1] ) {
				interaction.observers.push(c);
			}
		}
		interaction.extraData = null;
		interaction.sis = this.key;
		
		return interaction;
	}
	
	this.interactionExtraEffect = function(interaction) {
		interaction.extraEffect = interaction.calculateExtraEffect();
	}
	this.interactionMoodChanges = function(interaction) {
		var moodMultiplier = interaction.getMoodMultiplier();
		
		// Target
		var mVt = gC(interaction.target).applyMoodyMoodVector(moodVectorXFactor(interaction.getMoodVectorTarget(),moodMultiplier));
		this.setCharMoodChange(interaction.target,mVt);
		// Actor
		var mVa = gC(interaction.actor).applyMoodyMoodVector(moodVectorXFactor(interaction.getMoodVectorActor(),moodMultiplier));
		this.setCharMoodChange(interaction.actor,mVa);
		// Observers
		for ( var obs of interaction.observers ) {
			var mVo = gC(obs).applyMoodyMoodVector(moodVectorXFactor(interaction.getMoodVectorObservers(),moodMultiplier));
			this.setCharMoodChange(obs,mVo);
		}
	}
	this.interactionRelationChanges = function(interaction) {
		var relationMultiplier = interaction.getRelationMultiplier() * setup.conversationRelationMultiplier;
		
		// Target
		var rV = gC(interaction.target).applyRelationVector(interaction.actor,relationVectorXFactor(interaction.getRelationVectorTarget(),relationMultiplier));
		this.setCharRelationChange(interaction.target,interaction.actor,rV);
		
		// Actor
		rV = gC(interaction.actor).applyRelationVector(interaction.target,relationVectorXFactor(interaction.getRelationVectorActor(),relationMultiplier));
		this.setCharRelationChange(interaction.actor,interaction.target,rV);
		// Observers
		for ( var obs of interaction.observers ) {
			rV = gC(obs).applyRelationVector(interaction.actor,relationVectorXFactor(interaction.getRelationVectorObservers(),relationMultiplier));
			this.setCharRelationChange(obs,interaction.actor,rV);
		}
	}
	
	this.charLeavesSisAiProtocol = function(charKey) {
		if ( charKey != "chPlayerCharacter" ) {
			// gC(charKey).mapAi.state != "idle" && 
			if ( gC(charKey).followingTo == "" ) {
				// gC(charKey).mapAi.state = "idle";
				if ( State.variables.compass.findFirstEventInvolvingCharacter(charKey) == null ) {
					gC(charKey).mapAi.state = "idle";
				}
				gC(charKey).mapAi.main();
			}
		}
	}
	
	// Management
	this.getAllPossibleInteractions = function(character,target) {
		var allSocInt = getAllSocialInteractions();
		var charSocInt = []; // Valid social interactions for character
		for ( var si of allSocInt ) {
				charSocInt.push(si);
		}
		return charSocInt;
	}

	this.playerRequestsJoin = function() {
		var i = this.getCorrespondingRoundEventPos();
		if ( i != -1 ) {
			var remainingTime = State.variables.compass.ongoingEvents[i].timeRemaining;
			if ( remainingTime != 5 ) {
				State.variables.compass.advanceTime(remainingTime);
			}
		}
	}

	this.charJoinsSis = function(character) {
		if ( this.charList.includes(character) == false ) {
			gC(character).mapAi.state = "active";
			this.charList.push(character);
			if ( character == "chPlayerCharacter" ) {
				State.variables.compass.pcSis = this.key;
				State.variables.sisPlayerInfo.autoSelectNewTarget();
			}
		}
	}
	this.charsJoinSis = function(charList) {
		for ( var charKey of charList ) {
			this.charJoinsSis(charKey);
		}
	}

	this.charLeavesSis = function(character) {
		this.charLeavesSisAiProtocol(character);
		this.charList = arrayMinusA(this.charList,character);
		
		if ( character == "chPlayerCharacter" ) { // Player clause
			State.variables.sisPlayerInfo.clean();
			if ( (this.charList.length > 1) && (this.getCorrespondingRoundEventPos() == -1) ) {
				// If there's no associated event, Player leaves, and there are other characters in conversation,
				// generate new round event
				this.preInitiateNewRoundNoPC(false);
			}
		}
		
		var i = this.getCorrespondingRoundEventPos(); // Remove characters from corresponding event
		if ( i != -1 ) {
			State.variables.compass.ongoingEvents[i].removeCharFromEvent(character); // characters = arrayMinusA(State.variables.compass.ongoingEvents[i].characters,character);
		}
		
		if ( gC(character).followedBy.length > 0 ) { // Followers leave
			for ( var charKey of  gC(character).followedBy ) {
				if ( this.charList.includes(charKey) ) {
					this.charLeavesSis(charKey);
				}
			}
		}
		
		if ( this.charList.length < 2 ) { // Check Sis End
			if ( this.charList[0] == "chPlayerCharacter" ) {
				this.flagPlayerLeftAlone = true;
			}
			else {
				this.remainingCharsLeaveSis();
			}
			
			if ( i != -1 ) {
				State.variables.compass.ongoingEvents[i].forceEnd();
				if ( this.charList.length == 1 ) {
					State.variables.compass.ongoingEvents[i].removeCharFromEvent(this.charList[0]);
				}
			}
		}
		
		if ( this.charList.includes("chPlayerCharacter") ) { // Autoselect new player's target
			State.variables.sisPlayerInfo.autoSelectNewTarget();
		}
	}
	this.charsLeaveSis = function(charList) {
		for ( var character of charList ) {
			// AI
			this.charLeavesSisAiProtocol(character);
			this.charList = arrayMinusA(this.charList,character);
			
			if ( character == "chPlayerCharacter" ) {
				State.variables.sisPlayerInfo.clean();
			}
			
			// Remove characters from corresponding event
			var i = this.getCorrespondingRoundEventPos(); 
			if ( i != -1 ) {
				State.variables.compass.ongoingEvents[i].removeCharFromEvent(character); // characters = arrayMinusA(State.variables.compass.ongoingEvents[i].characters,character);
			}
		}
		if ( this.charList.length < 2 ) {
			if ( this.charList[0] == "chPlayerCharacter" ) {
				this.flagPlayerLeftAlone = true;
			}
			else {
				this.remainingCharsLeaveSis();
			}
		}
		if ( (this.charList.length > 1) && (this.getCorrespondingRoundEventPos() == -1) ) {
			// If there's no associated event, Player leaves, and there are other characters in conversation,
			// generate new round event
			this.preInitiateNewRoundNoPC(false);
		}
	}
	this.remainingCharsLeaveSis = function() {
		for ( var character of this.charList ) {
			if ( character == "chPlayerCharacter" ) {
				State.variables.sisPlayerInfo.clean();
			}
			else {
				this.charLeavesSis(character);
				this.charLeavesSisAiProtocol(character);
			}
		}
	}
	
	this.playerPicksInteraction = function(interactionKey) {
		State.variables.sisPlayerInfo.currentInteraction = interactionKey;
		// This must be working later
		// State.variables.compass.advanceTime(5);
		this.initiateNewRound();
		State.variables.compass.pushAllTimeToAdvance();
	}
	this.playerDoesNotPickInteraction = function(interactionKey) {
		State.variables.sisPlayerInfo.currentInteraction = "none";
		// This must be working later
		// State.variables.compass.advanceTime(5);
		this.initiateNewRound();
		State.variables.compass.pushAllTimeToAdvance();
	}
	
	this.feedCharInteractionsOptionsList = function() {
		var i = 0;
		if ( this.charInteractions.length != this.charList.length ) {
			for ( var character of this.charList ) {
				this.charInteractions[i] = this.getOfferedInteractionsToChar(character,(getCharsNumberInteractions(character)));
				i++;
			}
		}
	}
	
	this.getPlayerOfferedInteractions = function() {
		// Finds the SIS' assigned interactions for the player and returns them
		var it = 0;
		var itA = this.charList[it];
		while ( itA != "chPlayerCharacter" ) {
			it++;
			itA = this.charList[it];
		}
		return this.charInteractions[it];
	}
	
	this.getCorrespondingRoundEventPos = function() {
		var i = 0;
		var j = -1;
		for ( var sEvent of State.variables.compass.ongoingEvents ) {
			if ( sEvent.title == "sisRound" ) {
				if ( sEvent.sisKey == this.key ) {
					j = i;
				}
			}
			i++;
		}
		return j;
	}
	
	this.setSisPlayerPrompt = function(promptText,extra,rejectCost,actor,target,sT) {
		// Extra is a keyword that specifies specific behavior
		this.flagPlayerIsPrompted = true;
		this.playerPromptText = promptText;
		switch ( extra ) {
			case "default":
				this.playerPromptText += "\n" + this.getButtonRejectSisPrompt(rejectCost,sT,actor,target);
				break;
			case "relTypeForcesToAccept":
				this.playerPromptText += "\n" + colorText("Locked:","firebrick") + " Your special relationship doesn't allow you to refuse.";
				break;
			case "noExtra":
				break;
		}
	}
	this.endSisPlayerPrompt = function() {
		this.flagPlayerIsPrompted = false;
		this.playerPromptText = "";
	}
	
	// Data
	this.setCharMoodChange = function(character,moodVector) {
		if ( this.charMoodChanges.hasOwnProperty(character) ) {
			this.charMoodChanges[character] = sumMoodVectors(this.charMoodChanges[character],moodVector);
			this.charMoodChanges[character].name = character;
		} else {
			this.charMoodChanges[character] = moodVector;
			this.charMoodChanges[character].name = character;
		}
	}
	this.setCharRelationChange = function(actor,target,relationVector) {
		if ( this.charRelChanges.hasOwnProperty(actor) == false ) {
			this.charRelChanges[actor] = [];
			this.charRelChanges[actor].name = actor;
		}
		if ( this.charRelChanges[actor].hasOwnProperty(target) ) {
			this.charRelChanges[actor][target] = sumRelationVectors(relationVector,this.charRelChanges[actor][target]);
			this.charRelChanges[actor][target].name = target;
		} else {
			this.charRelChanges[actor][target] = relationVector;
			this.charRelChanges[actor][target].name = target;
		}
	}
	
	// Buttons
	this.getButtonPlayerDoesNothing = function() {
		var bText = "<<l" + "ink [[Do nothing|Social Interactions]]>><<s" + "cript>>\n";
		bText 	 += "State.variables.compass.sisList[" + this.key + "].playerDoesNotPickInteraction();";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	this.getButtonPlayerPicksAction = function(actionKey,target) {
		var bText = "<<l" + "ink [[" + getSiByKey(actionKey).title + "|Social Interactions]]>><<s" + "cript>>\n";
		bText 	 += "State.variables.compass.sisList[" + this.key + "].playerPicksInteraction('" + actionKey + "');";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	this.getButtonEndSis = function() {
		var bText = "<<l" + "ink [[Leave conversation|Map]]>><<s" + "cript>>\n";
		bText	 += "playerLeavesSis();\n";
		//bText 	 += "State.variables.compass.sisList[" + this.key + "].charsLeaveSis(getCharGroup('chPlayerCharacter'));";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	this.getButtonEndDeadSis = function() {
		var bText = "<<l" + "ink [[Leave|Map]]>><<s" + "cript>>\n";
		bText 	 += "State.variables.compass.sisList[" + this.key + "].charsLeaveSis(getCharGroup('chPlayerCharacter'));";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	this.getButtonSisSpecifics = function() {
		var bText = "<<l" + "ink [[Specific Topics|Social Interactions Specifics]]>><<s" + "cript>>\n";
		bText	 += "State.variables.sisSpecifics.playerTarget = State.variables.sisPlayerInfo.currentTarget;\n";
		bText	 += 'State.variables.sisPlayerInfo.lastTarget = State.variables.sisPlayerInfo.currentTarget;\n';
		bText 	 += 'State.variables.sisPlayerInfo.currentTarget = "";\n';
		bText 	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}

	this.getButtonRejectSisPrompt = function(cost,sT,actor,target) {
		var bText = "<<l" + "ink [[Reject|Social Interactions]]>><<s" + "cript>>\n";
		bText	 += "State.variables.chPlayerCharacter.willpower.current -=" + cost + ";\n";
		if ( sT != -1 ) {
			bText += "setup.sistDB['" + sT + "'].getFailEffect('" + actor + "','chPlayerCharacter');\n";
		}
		bText 	 += "State.variables.compass.sisList[" + this.key + "].endSisPlayerPrompt();";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		if ( cost > 0 ) {
			if ( gC("chPlayerCharacter").willpower.current >= cost ) {
				bText += " ( Cost: " + colorText(cost.toFixed(1),"darkslateblue") + " ) ";
			} else {
				bText = colorText("Locked: ","firebrick") + "Not enough willpower.";
			}
		}
		return bText;		
	}

	this.getButtonForcedOutOfSis = function() {
		var bText = "<<l" + "ink [[Continue to map|Map]]>><<s" + "cript>>\n";
		// bText 	 += "State.variables.compass.sisList[" + this.key + "].charsLeaveSis(getCharGroup('chPlayerCharacter'));";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}

	this.getButtonTakenToScene = function() {
		var bText = "<<l" + "ink [[Continue to scene|Scene]]>><<s" + "cript>>\n";
		bText	 += "State.variables.compass.sisList[" + this.key + "].flagPlayerTakenToScene = 'false';\n";
		bText	 += "State.variables.sc.formatScenePassage();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}

	// Provide info
	this.getValidProposedCharacters = function(proposerCharacter) {
		// Returns a list with the SIS' characters that proposerCharacter may make specific proposals to, such as leaving to have sex
		var validCharsList = [];
		for ( var charKey of this.charList ) {
			if ( (gC(charKey).followingTo == "" || gC(charKey).followingTo == proposerCharacter) && ( charKey != proposerCharacter ) ) {
				validCharsList.push(charKey);
			}
		}
		
		return validCharsList;
	}
};

window.playerLeavesSis = function() {
	var sisId = State.variables.compass.findFirstSisIdInvolvingCharacter("chPlayerCharacter");
	var playerFollowsTo = gC("chPlayerCharacter").followingTo;
	if ( playerFollowsTo == "" ) {
		State.variables.compass.sisList[sisId].charsLeaveSis(getCharGroup('chPlayerCharacter'));
	} else {
		charUnfollowsChar("chPlayerCharacter",playerFollowsTo);
		State.variables.compass.sisList[sisId].charsLeaveSis(['chPlayerCharacter']);
	}
}

// Constructors, serializers, etc.
SocIntSys.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
SocIntSys.prototype.clone = function () {
	return (new SocIntSys())._init(this);
};
SocIntSys.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new SocIntSys())._init($ReviveData$)', ownData);
};

// Auxiliar Functions

window.siCharismaVsEmpathy = function(charA,charB) {
	var result = 1.0;
	result = gC(charA).charisma.getValue() / gC(charB).empathy.getValue();
	return result;
}
window.siCharismaVsAll = function(charA,charB) {
	
}

window.getButtonExitRejectedSis = function() {
		var bText = "<<l" + "ink [[Continue|Map]]>><<s" + "cript>>\n";
		bText	 += "State.variables.sisPlayerInfo.flagRejectedSis = false;\n";
		bText	 += "State.variables.sisPlayerInfo.rejectedSisPassage = '';\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
}

window.getCharsNumberInteractions = function(charKey) {
	var n = scoreIntoInteractions(getScoreInteractions(charKey));
	return n;
}
window.getScoreInteractions = function(actor) {
	var score = gCstat(actor,"empathy") * 1.2 + gCstat(actor,"charisma") * 0.6 + gCstat(actor,"luck") * 0.2;
	return score;
}
window.scoreIntoInteractions = function(score) {
	var n = 3;
	if ( score >= 190 ) { n = 10; }
	else if ( score >= 155 ) { n = 9; }
	else if ( score >= 115 ) { n = 8; }
	else if ( score >= 80 ) { n = 7; }
	else if ( score >= 50 ) { n = 6; }
	else if ( score >= 30 ) { n = 5; }
	else if ( score >= 20 ) { n = 4; }
	return n;
}


////////// PERSONAL ROOM CLASS  //////////
// Information regarding the options at the player's personal room

window.PersonalRoom = function() {
	this.roomState = "main"; // Alts: "charInfo" , "merchants" , "equipment" , "customizeMood" , "scrolls" , "candidatesComparison" , "endDayScreen"
	
	this.availableCharsInfo = [ "chPlayerCharacter" , "chNash", "chMir", "chVal", "chClaw", "chAte" ];
	this.checkedCharacter = "chPlayerCharacter";
	this.selectedScroll = "none";
	
	this.lastAutosaveDay = -1;
	
	// UI
	
	this.roomText = "";
	this.newDayInfo = "";
	
	this.prMessages = "";
	
	this.autosavePossible = true;
	
};

// Methods
PersonalRoom.prototype.formatRoomText = function() {
		switch(this.roomState) {
			case "main":
				this.roomText = '<div style="text-align: center;">' + State.variables.daycycle.returnMonthDay() + "</div>\n"
				this.roomText += this.prMessages;
				if ( this.prMessages != "" ) { this.roomText += "\n"; }
				this.roomText += '<<s' + 'cript>>attemptAutosave();<</s' + 'cript>> \ ';
				this.roomText += "__Personal room__\nThe water flows quietly.\n";				// Description
				this.roomText += '<span style="color:green">You can save the game.</span>\n'; // You can save msg
				this.roomText += this.getButtonFinishDay() + "\n";								  // New day
				this.roomText += "\n__Characters info__:\n" 										// Characters info
				 
				this.roomText += this.getButtonsCharInfo() + "\n";
				this.roomText += getButtonMerchants();
				this.roomText += this.getButtonEquipment() + "\n";
				this.roomText += this.getButtonActions() + "\n";
				this.roomText += this.getButtonSetSexPreferences() + this.getButtonCustomizeMood() + "\n";
				this.roomText += this.getButtonComparisonChart() + "\n"
				if ( State.variables.chPlayerCharacter.studiedScrolls.length > 0 ) {
					this.roomText += this.getButtonReadScrolls() + "\n";
				}
				this.roomText += "\n" + this.getButtonSettings() + '\n\n'; // Link to settings
				this.roomText += setup.cheatMenuLinkText; // Cheats
				this.roomText += getHotfixButton();
				break;
			case "charInfo": 																	// Char info screen
				this.roomText  = "" + this.getButtonBackToMain() + "\n";
				this.roomText += this.getCharacterInfo(this.checkedCharacter);
				break;
			case "merchants":
				this.roomText = getMerchantsWindow();
				break;
			case "equipment":
				this.roomText = getEquipmentWindow();
				break;
			case "actions":
				this.roomText = getActionsWindow();
				break;
			case "customizeMood":
				this.roomText = getCustomizeMoodWindow();
				break;
			case "scrolls":
				if ( this.selectedScroll == "none" ) {
					this.roomText = this.getReReadScrollsPassage();
				} else {
					this.roomText = this.getReReadScrollPassage(this.selectedScroll);
				}
				break;
			case "candidatesComparison":
				this.roomText = this.getCandidatesComparisonPassage();
				break;
			case "endDayScreen":
				this.roomText = '<div style="text-align: center;">' + State.variables.daycycle.returnMonthDay() + "</div>\n"
				if ( this.newDayInfo == "" ) {
					this.roomText = "Nothing relevant is happening.\n\n";
				} else {
					this.roomText += this.newDayInfo + "\n";
					this.newDayInfo = "";
				}
				this.roomText += this.getButtonNewDay();
				this.roomText += "\n<<" + "script>>State.variables.personalRoom.roomState = 'main';<</" + "script>> \ ";
				break;
		}
		this.roomText += "\n<<" + "script>>State.variables.eventsCalendar.activeEvent = false;<</" + "script>> \ ";
		
		// TO DO: REMOVE
		State.variables.sisSpecifics = new SisSpecifics();
	}
	
	// Buttons
	
PersonalRoom.prototype.getButtonBackToMain = function() {
		var bText = "<<l" + "ink [[Go back|Personal Room]]>><<s" + "cript>>";;
		bText 	 += "State.variables.personalRoom.roomState = 'main';\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
PersonalRoom.prototype.getButtonsCharInfo = function() {
		var bText = "";
		for ( var character of getActiveSimulationCharactersArray() ) {
			if ( isCurrentStoryStateInMainLoop() || getCandidatesKeysArray().includes(character) ) {
				bText += "<<l" + "ink [[" + gC(character).name + "|Personal Room]]>><<s" + "cript>>";
				bText += "State.variables.personalRoom.roomState = 'charInfo';\n";
				bText += "State.variables.personalRoom.checkedCharacter = '" + character + "';";
				//bText += "$rightUiBar.stow()";
				bText += "<</s" + "cript>><</l" + "ink>> " + gC(character).icon();
				if ( gRelTypeAb(character,"chPlayerCharacter") ) {
					bText += " (" + getRelTypeAbr(character,"chPlayerCharacter") + ")";
				}
				if ( getCandidatesKeysArray().includes(character) == false ) {
					bText += " " + colorText("Guest","limegreen");
				}
				bText += "\n";
			}
		}
		return bText;
	}
	
PersonalRoom.prototype.getButtonEquipment = function() {
		var bText = "<<l" + "ink [[Equipment|Personal Room]]>><<s" + "cript>>";
			bText += "State.variables.personalRoom.roomState = 'equipment';\n";
			bText += "State.variables.selectedEquip = '';\n";
			bText += "State.variables.selectedChar = '';\n";
			bText += "State.variables.roomMessage = '';\n";
			bText += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
PersonalRoom.prototype.getButtonActions = function() {
		var bText = "<<l" + "ink [[Actions|Personal Room]]>><<s" + "cript>>";
			bText += "State.variables.personalRoom.roomState = 'actions';\n";
			bText += "State.variables.roomMessage = '';\n";
			bText += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
PersonalRoom.prototype.getButtonCustomizeMood = function() {
		var bText = "<<l" + "ink [[Customize Player Mood|Personal Room]]>><<s" + "cript>>";
			bText += "State.variables.personalRoom.roomState = 'customizeMood';\n";
			bText += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
PersonalRoom.prototype.getButtonSetSexPreferences = function() {
	var bText = ""
	if ( State.variables.StVarsList.includes("chTts") == false ) {
		bText = "''\!\!\!'' <<l" + "ink [[Set your character's sex preferences|Player Sex Preferences Customization Menu]]>><<s" + "cript>>";
		bText += "setUpSexPreferencesMenu();\n";
		bText += "<</s" + "cript>><</l" + "ink>>\n";
	}
	return bText;
}
	
PersonalRoom.prototype.getButtonReadScrolls = function() {
		var bText = "<<l" + "ink [[Check studied scrolls|Personal Room]]>><<s" + "cript>>";
			bText += "State.variables.personalRoom.roomState = 'scrolls';\n";
			bText += "State.variables.personalRoom.selectedScroll = 'none';\n";
			bText += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
PersonalRoom.prototype.getButtonReadScroll = function(scrollKey) {
		var bText = "<<l" + "ink [[" + setup.scrollsList[scrollKey].title + "|Personal Room]]>><<s" + "cript>>";
			bText += "State.variables.personalRoom.roomState = 'scrolls';\n";
			bText += "State.variables.personalRoom.selectedScroll = '" + scrollKey + "';\n";
			bText += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
PersonalRoom.prototype.getButtonComparisonChart = function() {
		var bText = "<<l" + "ink [[Candidates Comparison|Personal Room]]>><<s" + "cript>>";
			bText += "State.variables.personalRoom.roomState = 'candidatesComparison';\n";
			bText += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
PersonalRoom.prototype.getButtonFinishDay = function() {
		var bText = "<<l" + "ink [[Rest and initiate a new day|Personal Room]]>><<s" + "cript>>";
			bText += "State.variables.personalRoom.roomState = 'endDayScreen';\n";
			bText += "State.variables.personalRoom.endDayEffects();\n";
			bText += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}

	
PersonalRoom.prototype.getButtonNewDay = function() {
		return State.variables.eventsCalendar.getEndDayButton();
	}
	
PersonalRoom.prototype.getButtonSettings = function() {
		var bText = '<<link [[Settings|Settings]]>' + '><<s' + 'cript>>State.variables.settings.setExitPassage("Personal Room");'
				  + 'State.variables.settings.formatAllChoices();<</s' + 'cript>><</l' + 'ink>>';
		return bText;
	}

	// Character info
	
PersonalRoom.prototype.getCharacterInfo = function(character) {
		// <p><img src="img/logo.png" alt="alt text" style="float: right">Text here</p>
		var iText = "<div><p>";
		
		if ( gC(character).fullPortrait != null ) {															// Image
			iText += '<div class="portraitBox"><img src="' + gC(character).fullPortraitL + '" alt="" style="float: right"></div>'
		} else if ( gC(character).avatar != null ) {
			iText += '<div class="portraitBox"><img src="' + gC(character).avatarL + '" alt="" style="float: right"></div>'
		}
		
		// Name, merit, money
		iText += "<div class='standardBox'>    __" + gC(this.checkedCharacter).getFormattedName() + "__:\n";							// Name
		if ( gC(character).type == "candidate" ) {
			iText += "Merit: " + gC(character).merit;
			iText += " | Infamy: " + gC(character).infamy + "/" + State.variables.settings.infamyLimit;
			if ( character == "chPlayerCharacter" ) {
				iText += " | Money: " + gC(character).money.toFixed(0);
			}
			iText += "</div>\n";
		}
		
		// Special relationships
		var tempText = "";
		if ( gC(character).domChar ) {
			tempText += "Submissive relationship: "
					  + gC(gC(character).domChar).getFormattedName() + ": " + getRelTypeNameMayus(gC(character).domChar,character);
					  if ( gRelTypeAb(gC(character).domChar,character).persistence == "temporary" ) {
						  tempText += " | Days remaining: " + gRelTypeAb(gC(character).domChar,character).days;
					  }
		}
		if ( gC(character).subChars.length > 0 ) {
			tempText += "Dominant relationships: ";
			for ( var sChar of gC(character).subChars ) {
				tempText += "\n" + gC(sChar).getFormattedName() + ": " + getRelTypeNameMayus(sChar,character);
					  if ( gRelTypeAb(sChar,character).persistence == "temporary" ) {
						  tempText += " | Days remaining: " + gRelTypeAb(sChar,character).days;
					  }
			}
		}
		if ( gC(character).egaChars.length > 0 ) {
			if ( tempText != "" ) { tempText += "\n"; }
			tempText += "Egalitarian relationships: ";
			for ( var eChar of gC(character).egaChars ) {
				tempText += "\n" + gC(eChar).getFormattedName() + ": " + getRelTypeNameMayus(eChar,character);
					  if ( gRelTypeAb(eChar,character).persistence == "temporary" ) {
						  tempText += " | Days remaining: " + gRelTypeAb(eChar,character).days;
					  }
			}
		}
		if ( tempText != "" ) {
			iText += "<div class='standardBox'>__Special Relationships__:\n";
			iText += tempText;
			iText += "</div>\n";
		}
		
		// Base stats
		iText += "<div class='standardBox'>__Stats__:\n";																				// Stats
		iText += colorText("Max lust: ","lightcoral") + gC(character).lust.max.toFixed(0) + " ; " + colorText("Max willpower: ","darkslateblue") + gC(character).willpower.max.toFixed(0) + " \n";
		iText += colorText("Max energy: ","limegreen") + gC(character).energy.max.toFixed(0) + " ; " + colorText("Max social drive: ","khaki") + gC(character).socialdrive.max.toFixed(0) + " \n";
		iText += "\nPhysique: " + gC(character).physique.value.toFixed(0) + " (" + gC(character).physique.getValue().toFixed(1) + ")";
		if ( character == "chPlayerCharacter" ) { iText += " | " + getTextStatExp(gC(character).physique); }
		iText += " | " + getTextStatAff(gC(character).physique);
		iText += "\nAgility: " + gC(character).agility.value.toFixed(0) + " (" + gC(character).agility.getValue().toFixed(1) + ")";
		if ( character == "chPlayerCharacter" ) { iText += " | " + getTextStatExp(gC(character).agility); }
		iText += " | " + getTextStatAff(gC(character).agility);
		iText += "\nResilience: " + gC(character).resilience.value.toFixed(0) + " (" + gC(character).resilience.getValue().toFixed(1) + ")";
		if ( character == "chPlayerCharacter" ) { iText += " | " + getTextStatExp(gC(character).resilience); }
		iText += " | " + getTextStatAff(gC(character).resilience);
		
		iText += "\nWill: " + gC(character).will.value.toFixed(0) + " (" + gC(character).will.getValue().toFixed(1) + ")";
		if ( character == "chPlayerCharacter" ) { iText += " | " + getTextStatExp(gC(character).will); }
		iText += " | " + getTextStatAff(gC(character).will);
		iText += "\nIntelligence: " + gC(character).intelligence.value.toFixed(0) + " (" + gC(character).intelligence.getValue().toFixed(1) + ")";
		if ( character == "chPlayerCharacter" ) { iText += " | " + getTextStatExp(gC(character).intelligence); }
		iText += " | " + getTextStatAff(gC(character).intelligence);
		iText += "\nPerception: " + gC(character).perception.value.toFixed(0) + " (" + gC(character).perception.getValue().toFixed(1) + ")";
		if ( character == "chPlayerCharacter" ) { iText += " | " + getTextStatExp(gC(character).perception); }
		iText += " | " + getTextStatAff(gC(character).perception);
		
		iText += "\nEmpathy: " + gC(character).empathy.value.toFixed(0) + " (" + gC(character).empathy.getValue().toFixed(1) + ")";
		if ( character == "chPlayerCharacter" ) { iText += " | " + getTextStatExp(gC(character).empathy); }
		iText += " | " + getTextStatAff(gC(character).empathy);
		iText += "\nCharisma: " + gC(character).charisma.value.toFixed(0) + " (" + gC(character).charisma.getValue().toFixed(1) + ")";
		if ( character == "chPlayerCharacter" ) { iText += " | " + getTextStatExp(gC(character).charisma); }
		iText += " | " + getTextStatAff(gC(character).charisma);
		iText += "\nLuck: " + gC(character).luck.value.toFixed(0) + " (" + gC(character).luck.getValue().toFixed(1) + ")";
		if ( character == "chPlayerCharacter" ) { iText += " | " + getTextStatExp(gC(character).luck); }
		iText += " | " + getTextStatAff(gC(character).luck);
		iText += "</div>\n";
		
		// Relationships
		if ( character != "chPlayerCharacter" ) {			// Relationship
			iText += "<div class='standardBox'>__" + gC(character).name + "'s thoughts on you__:\n";
			iText += getRelationshipDescription(character,"chPlayerCharacter")[0] + "\n";
			var i = 0;
			var rpNames = [ "Friendship", "Sexual Tension", "Romance", "Domination", "Submission", "Rivalry", "Enmity" ];
			for ( var relPar in gC(character).relations["chPlayerCharacter"] ) {
				if ( gC(character).relations["chPlayerCharacter"][relPar] instanceof RelPar ) {
					iText += rpNames[i] + " - Lvl: " + gC(character).relations["chPlayerCharacter"][relPar].level;
					var levelMod = gC(character).relations["chPlayerCharacter"][relPar].levelMod;
					if ( levelMod > 0 ) {
						iText += "+" + levelMod;
					} else if ( levelMod < 0 ) {
						iText += "-" + -levelMod;
					}
					iText += ">("
						   + + formulaRelParTotalLevel(gC(character).relations["chPlayerCharacter"][relPar]) + ")"
						   + " | ST: " + gC(character).relations["chPlayerCharacter"][relPar].stv.toFixed(1)
						   + " (" + colorText((gC(character).relations["chPlayerCharacter"][relPar].stv * 0.05).toFixed(1),"red") + ")"
						   + " | LT: " + gC(character).relations["chPlayerCharacter"][relPar].ltv.toFixed(1)
						   + " (" + colorText((gC(character).relations["chPlayerCharacter"][relPar].stv * 0.01).toFixed(1),"green") + ")";
					if ( i < 6 ) { iText += "\n"; }
					i++;
				}
			}
			iText += "\nFavor owed to you: " + gC(character).relations.chPlayerCharacter.favor.toFixed(2);
			iText += "</div>";
			
			iText += "\n<div class='standardBox'>__Your thoughts on " + gC(character).name + "__:\n";
			iText += getRelationshipDescription("chPlayerCharacter",character)[0] + "\n";
			i = 0;
			for ( var relPar in gC("chPlayerCharacter").relations[character] ) {
				if ( gC("chPlayerCharacter").relations[character][relPar] instanceof RelPar ) {
					iText += rpNames[i] + " - Lvl: " + gC("chPlayerCharacter").relations[character][relPar].level;
					var levelMod = gC("chPlayerCharacter").relations[character][relPar].levelMod;
					if ( levelMod > 0 ) {
						iText += "+" + levelMod;
					} else if ( levelMod < 0 ) {
						iText += "-" + -levelMod;
					}
					iText += ">(" + formulaRelParTotalLevel(gC("chPlayerCharacter").relations[character][relPar]) + ")"
						   + " | ST: " + gC("chPlayerCharacter").relations[character][relPar].stv.toFixed(1)
						   + " (" + colorText((gC("chPlayerCharacter").relations[character][relPar].stv * 0.05).toFixed(1),"red") + ")"
						   + " | LT: " + gC("chPlayerCharacter").relations[character][relPar].ltv.toFixed(1)
						   + " (" + colorText((gC("chPlayerCharacter").relations[character][relPar].stv * 0.01).toFixed(1),"green") + ")";
					if ( i < 6 ) { iText += "\n"; }
					i++;
				}
			}
			iText += "\nFavor owed to " + gC(character).name + ": " + gC("chPlayerCharacter").relations[character].favor.toFixed(2);
			iText += "</div>";
			
			iText += "\nST stands for Short Term, LT stands for Long Term. ST values slowly decay, and a portion is turned into LT at the end of the day.\n"
		}
		
			// Drives
		if ( character != "chPlayerCharacter" ) {
			// Extra conditions
			if ( gC(character).domChar == "chPlayerCharacter" || gC(character).subChars.includes("chPlayerCharacter") || gC(character).egaChars.includes("chPlayerCharacter") ) {
				var drivesDesc = "\n<div class='standardBox'>__" + gC(character).name + "'s drives__:\n";
				drivesDesc += textCharactersDrives(character) + "</div>";
				iText += drivesDesc;
			}
		}
		
		// Sexual preferences
		if ( character == "chPlayerCharacter" || gC(character).domChar == "chPlayerCharacter" || gC(character).subChars.includes("chPlayerCharacter") || gC(character).egaChars.includes("chPlayerCharacter") ) {
			var prefsDesc = "\n<div class='standardBox'>__" + gC(character).name + "'s sex preferences__:\n";
			prefsDesc += textCharactersTastes(character) + "</div>";
			iText += prefsDesc;
		}
		
		// Virginities
		if ( character == "chPlayerCharacter" || gC(character).domChar == "chPlayerCharacter" || gC(character).subChars.includes("chPlayerCharacter") || gC(character).egaChars.includes("chPlayerCharacter") ) {
			var virginitiesText = getCharsVirginityChart(character);
			if ( virginitiesText != "" ) {
				iText += "\n<div class='standardBox'>__Virginities__:\n";
				iText += virginitiesText + "</div>";
			}
		}
		
		iText += "</p></div>";
		
		
		return iText;
	}
	
	// Scrolls
	
PersonalRoom.prototype.getReReadScrollsPassage = function() {
		var passageText = "__Studied scrolls__:\n";
		for ( var scr of gC("chPlayerCharacter").studiedScrolls ) {
			passageText += "- " + this.getButtonReadScroll(scr) + "\n";
		}
		passageText += "\n" + this.getButtonBackToMain();
		return passageText;
	}
PersonalRoom.prototype.getReReadScrollPassage = function(scrollKey) {
		var passageText = "__" + setup.scrollsList[scrollKey].title + "__:\n\n"
						+ setup.scrollsList[scrollKey].getContent() + "\n\n"
						+ this.getButtonReadScrolls() + "\n"
						+ this.getButtonBackToMain();
		return passageText;
	}

	// Candidates Comparison|Personal
	
PersonalRoom.prototype.getCandidatesComparisonPassage = function() {
		var passageText = "__Candidates Comparison__:\n";
		passageText += '<table><tr><td>__Candidate__</td><td>__Merit__</td><td>__Infmy__</td><td>__Ph__</td><td>__Ag__</td><td>__Re__</td><td>__Wi__</td><td>__In__</td><td>__Pe__</td><td>__Ch__</td><td>__Em__</td><td>__Lu__</td></tr>';
		for ( var charKey of getCandidatesKeysArray() ) {
			passageText += '<tr><td>' + gC(charKey).getFormattedName() + '</td><td>' + gC(charKey).merit + '</td><td>' + gC(charKey).infamy + '</td><td>' + gC(charKey).physique.value + '</td><td>' + gC(charKey).agility.value + '</td><td>' + gC(charKey).resilience.value + '</td><td>' + gC(charKey).will.value + '</td><td>' + gC(charKey).intelligence.value + '</td><td>' + gC(charKey).perception.value + '</td><td>' + gC(charKey).charisma.value + '</td><td>' + gC(charKey).empathy.value + '</td><td>' + gC(charKey).luck.value + '</td></tr>';
		}
		if ( State.variables.activeSimulationCharacters.length > 6 && isCurrentStoryStateInMainLoop() ) {
			passageText += '<tr><td>' + "Guests" + '</td><td>' + '</td><td>' + '</td><td>' + '</td><td>' + '</td><td>' + '</td><td>' + '</td><td>' + '</td><td>' + '</td><td>' + '</td><td>' + '</td><td>' + '</td></tr>';
			for ( var charKey of getActiveSimulationCharactersArray() ) {
				if ( getCandidatesKeysArray().includes(charKey) == false ) {
					passageText += '<tr><td>' + gC(charKey).getFormattedName() + '</td><td>' + gC(charKey).merit + '</td><td>' + gC(charKey).infamy + '</td><td>' + gC(charKey).physique.value + '</td><td>' + gC(charKey).agility.value + '</td><td>' + gC(charKey).resilience.value + '</td><td>' + gC(charKey).will.value + '</td><td>' + gC(charKey).intelligence.value + '</td><td>' + gC(charKey).perception.value + '</td><td>' + gC(charKey).charisma.value + '</td><td>' + gC(charKey).empathy.value + '</td><td>' + gC(charKey).luck.value + '</td></tr>';
				}
			}
		}
		passageText += '</table>\n';
		passageText += this.getButtonBackToMain();
		return passageText;
	}

	// Logic
	
PersonalRoom.prototype.initPersonalRoom = function() {
		State.variables.compass.currentMap = "none";
		State.variables.personalRoom.autosavePossible = true;
		applyPunishmentsToCandidates();
		spawnMerchants();
		npcsBuyItems();
		npcsEquipBondage();
		
		State.variables.sc.cleanScene();
		refreshUIbars();
		removeLeftOverData();
	}
	
window.removeLeftOverData = function() {
	if ( State.variables.selectStatListBoxes != undefined ) {
		delete State.variables.selectStatListBoxes;
	}
}
	
PersonalRoom.prototype.endDayEffects = function() {
		State.variables.logL1 = [];
		State.variables.eventsCalendar.stablishTomorrowsEvent();
		
		State.variables.personalRoom.autosavePossible = false;
		
		// New day
		State.variables.daycycle.addDays(1);
		for ( var character of getActiveSimulationCharactersArray() ) {
			gC(character).restoreBars(); // Energy bars
			gC(character).mood.resetMood(); // Moods
			
			gC(character).studiedScrollToday = false;
			
			gC(character).cbl = [];
		}
		
		// Set time
		State.variables.daycycle.hours = State.variables.simCycPar.templeNewDayTime;
		State.variables.daycycle.minutes = 0;
		
		// Level up stats
		for ( var character of getActiveSimulationCharactersArray() ) {
			//			for ( var stat of State.variables.baseStats ) {
			for ( var stat of setup.baseStats ) {
				if ( gC(character)[stat].tryLevelUp() ) {
					// Notify level up
					if ( character == "chPlayerCharacter" ) {
						this.newDayInfo += "Your " + stat + " has increased to " + gC(character)[stat].value + ".\n";
					}
					addPointsToDrive(gC(character).dImprovement,(gC(character)[stat].value / 5));
				}
			}
			recalculateMaxBars(character);
			// State.variables[character].recalculateMaxBars();
		}
		
		// Relations and mood
		this.endDayRelationMoodEffects();

		// Daily sex checks
		for ( var character of getActiveSimulationCharactersArray() ) {
			if ( gC(character).hasOwnProperty("daysWithoutSex") ) {
				gC(character).daysWithoutSex += 1;
				gC(character).sexScenesToday = 0;
			}
			delete gC(character).dayTags;
		}

		// Infamy
		for ( var charKey of getActiveSimulationCharactersArray() ) {
			var infamyChange = ((gC(charKey).infamy - (gC(charKey).infamy % 10)) / 10 ) + 1;
			gC(charKey).changeInfamy(-infamyChange);
			if ( gC(charKey).globalAi.hasOwnProperty("attackedToday") ) {
				gC(charKey).globalAi.attackedToday = false;
			}
		}

		// Altered States
		for ( var charKey of getActiveSimulationCharactersArray() ) {
			for ( var as of gC(charKey).alteredStates ) {
				if ( as.scope == "days" ) {
					as.remainingDays--;
					if ( as.remainingDays <= 0 ) {
						as.flagRemove = true;
					}
				}
			}
			gC(charKey).cleanStates();
		}

		// Equipment
		for ( var equip of State.variables.equipmentList ) {
			if ( equip.days > 1 ) {
				equip.days--;
			} else if ( equip.days == 1 ) {
				unequipObject(equip.id);
			}
		}
				
		// Fix stats
		for ( var character of getActiveSimulationCharactersArray() ) {
			fixCharacterStatModifiers(character);
		}
		
		checkCharListForSexTastesRebalance(getActiveSimulationCharactersArray());
		
		// Despawn merchants
		State.variables.currentMerchants = [];
	}
PersonalRoom.prototype.endDayRelationMoodEffects = function() {
		var relTypesToFinish = [];
		var i = 0;
		for ( var mood of ["friendly","intimate","flirty","aroused","dominant","submissive","bored","angry"] ) {
			gC("chPlayerCharacter").baseMood[mood] = State.variables.playerCustomMoods[i];
			i++;
		}
		for ( var character of getActiveSimulationCharactersArray() ) {
			// Relations
			for ( var rel in gC(character).relations ) {
				if ( gC(character).relations[rel] instanceof Relation ) {
					var iRelation = gC(character).relations[rel];
					//var mult = 1.0; // Decay value is multiplied by this
					if ( gC(character).relations[rel].processNewDay() ) {
						// Notify relation change
						if ( character == "chPlayerCharacter" ) {
							this.newDayInfo += "Your opinion of " + gC(iRelation.target).name + " is changing.\n";
						}
						else if ( iRelation.target == "chPlayerCharacter" ) {
							this.newDayInfo += gC(character).name + "'s opinion of you is changing.\n";
						}
					}
					var rType = iRelation.relType
					if ( rType ) { // Special relationship
						// Effect
						this.newDayInfo += rType.dailyEffect() + "\n";
						// Rest days
						if ( rType.persistence == "temporary" ) {
							rType.days--;
							if ( rType.days == 0 ) {
								// Mark to finish
								relTypesToFinish.push([rType.actor,rType.target]);
							}
						}
					}
				}
			}
			// Mood
			gC(character).restoreMood();
		}
		
		// Finish marked special relationship
		for ( var rts of relTypesToFinish ) {
			if ( gRelTypeAb(rts[0],rts[1]) ) {
				this.newDayInfo += finishRelType(rts[0],rts[1]);
			}
		}
	}
	
PersonalRoom.prototype.initializeNewDay = function() {
		if ( isCurrentStoryStateInMainLoop() ) {
			// Temple period
			initTrainingPeriodPassionTemple();
			
			// AI social and training priorities
			for ( var character of arrayMinusA(getActiveSimulationCharactersArray(),"chPlayerCharacter") ) {
				setSocialAiCandidateGoals(gC(character).socialAi);
				setTrainingGoals(character);
			}
		} else if ( State.variables.storyState == storyState.firstAdventure ) {
			// Gleaming Caverns Period
			initAdventurePeriodGleamingCaverns();
		}
		
		// Clean compass
		State.variables.compass.debugInfo = "";
	}
	

// Sex preferences

window.checkCharListForSexTastesRebalance = function(charList) {
	for ( var charKey of charList ) {
		if ( limitedRandomInt(16) < 4 ) {
			rebalanceCharsSexTastes(charKey);
		}
	}
}
window.rebalanceCharsSexTastes = function(charKey) {
	var totalPoints = 0;
	var pointsThreshold = 3600;
	// Is rebalance required?
	for ( var t in gC(charKey).tastes ) {
		if ( gC(charKey).tastes[t] instanceof weightedElement ) {
			totalPoints += gC(charKey).tastes[t].w
		}
	}
	// Execute rebalance
	if ( totalPoints > pointsThreshold ) {
		var chosenTastes = [randomFromWeightedList(gC(charKey).tastes),randomFromWeightedList(gC(charKey).tastes),randomFromWeightedList(gC(charKey).tastes),randomFromWeightedList(gC(charKey).tastes),randomFromWeightedList(gC(charKey).tastes)];
		for ( var taste of chosenTastes ) {
			if ( gC(charKey).tastes[taste].w > 30 ) {
				gC(charKey).tastes[taste].w -= 5;
			}
		}
	}
	rankSexPreferences(gC(charKey).tastes);
}

window.setUpSexPreferencesMenu = function() {
	State.variables.chosenRankTwoTastes = ["","","",""];
	State.variables.chosenRankOneTastes = ["","","","","","","",""];
}
window.processSexPreferencesMenu = function() {
	var rankTwoTastes = [];
	var rankOneTastes = [];
	for ( var t of State.variables.chosenRankTwoTastes ) {
		if ( rankTwoTastes.includes(t) == false ) {
			rankTwoTastes.push(t);
		}
	}
	for ( var t of State.variables.chosenRankOneTastes ) {
		if ( rankTwoTastes.includes(t) == false && rankOneTastes.includes(t) == false ) {
			rankOneTastes.push(t);
		}
	}
	for ( var t of rankTwoTastes ) {
		gC("chPlayerCharacter").tastes[t].w += 40;
	}
	for ( var t of rankOneTastes ) {
		gC("chPlayerCharacter").tastes[t].w += 20;
	}
	delete State.variables.chosenRankTwoTastes;
	delete State.variables.chosenRankOneTastes;
	rebalanceCharsSexTastes("chPlayerCharacter");
	State.variables.StVarsList.push("chTts");
}

// Windows
window.getEquipmentWindow = function() {
	var shownItems = [];
	var displayedChars = ["chPlayerCharacter"];
	if ( gC("chPlayerCharacter").domChar != null ) { displayedChars.push(gC("chPlayerCharacter").domChar); }
	if ( gC("chPlayerCharacter").egaChars.length > 0 ) { displayedChars = displayedChars.concat(gC("chPlayerCharacter").egaChars); }
	if ( gC("chPlayerCharacter").subChars.length > 0 ) { displayedChars = displayedChars.concat(gC("chPlayerCharacter").subChars); }
	var wText = '<<removeclass "#right-ui-bar" "stowed">> \ ' + "__Equipment Menu__\n\n";
	if ( State.variables.roomMessage != "" ) {
		wText += State.variables.roomMessage + "\n\n";
	}
			// Owned items equipped on someone
	wText += "__Equipped items__:\n";
	
	for ( var cK of displayedChars ) {
		var cKtext = getTextEquippedItemsOnChar(cK);
		if ( cKtext != "" ) { wText += cKtext + "\n"; }
		shownItems = shownItems.concat(getItemIDsEquippedOnChar(cK));
	}
	for ( var equip of State.variables.equipmentList ) {
		if ( equip.owner == "chPlayerCharacter" && shownItems.includes(equip.id) == false ) {
			if ( equip.equippedOn != null ) {
				shownItems.push(equip.id);
				var equipData = getEquipDataById(equip.id);
				wText += equipData.name + getItemDescriptionById(equip.id) + " - Equipped on " + gC(equip.equippedOn).getFormattedName() + ". Days: " + equip.days
						// Button to unequip item
					   + ". <<l" + "ink [[Unequip|Personal Room]]>><<s" + "cript>>"
					   + "unequipObject(" + equip.id + ");\n"
					   + "<</s" + "cript>><</l" + "ink>>\n";
			}
		}
	}
			// Owned unequipped items
	wText += "\n__Unequipped items__:\n";
	for ( var equip of State.variables.equipmentList ) {
		if ( equip.owner == "chPlayerCharacter" && equip.equippedOn == null ) {
			var equipData = getEquipDataById(equip.id);
			wText += '<<radiobutton "$selectedEquip" "' + equip.id + '" autocheck>> ' + equipData.name + getItemDescriptionById(equip.id) + '\n';
		}
	}


			// Equippable characters
	wText += "\n__Characters__:\n";
	wText += '<<radiobutton "$selectedChar" "chPlayerCharacter" autocheck>> ' + gC("chPlayerCharacter").getFormattedName() + "\n";
	for ( var charKey of State.variables.chPlayerCharacter.subChars ) {
		wText += '<<radiobutton "$selectedChar" "' + charKey + '" autocheck>> ' + gC(charKey).getFormattedName() + "\n";
	}
			// Attempt equip item button
	wText += "\n<<l" + "ink [[Equip item|Personal Room]]>><<s" + "cript>>"
			+ "attemptEquipSelectedItem();\n"
			+ "<</s" + "cript>><</l" + "ink>>\n";
	// Exit menu button
	wText += "\n<<l" + "ink [[Exit equipment menu|Personal Room]]>><<s" + "cript>>"
			+ "State.variables.personalRoom.roomState = 'main';\n"
			+ "delete State.variables.selectedEquip;\n"
			+ "delete State.variables.selectedChar;\n"
			+ "delete State.variables.roomMessage;\n"
			+ "<</s" + "cript>><</l" + "ink>>\n";
	return wText;
}
window.getTextEquippedItemsOnChar = function(charKey) {
	var wText = "";
	for ( var bpi in gC(charKey).body ) {
		if ( gC(charKey).body[bpi] instanceof Bodypart ) {
			var bp = gC(charKey).body[bpi];
			if ( bp.bondage != -1 ) {
				var equip = State.variables.equipmentList[bp.bondage];
				var equipData = getEquipDataById(bp.bondage);
				wText += equipData.name + getItemDescriptionById(equip.id) + " - Equipped on " + gC(equip.equippedOn).getFormattedName() + " by " + gC(equip.owner).getFormattedName() + ". Days: " + equip.days;
				if ( equip.owner == "chPlayerCharacter" ) {
					// Button to unequip item
					wText += " <<l" + "ink [[Unequip|Personal Room]]>><<s" + "cript>>"
						   + "unequipObject(" + equip.id + ");\n"
						   + "<</s" + "cript>><</l" + "ink>>\n";
				} else {
					wText += "\n";
				}					
			}
		}
	}
	return wText;
}
window.getItemIDsEquippedOnChar = function(charKey) {
	var bondageList = [];
	for ( var bpi in gC(charKey).body ) {
		if ( gC(charKey).body[bpi] instanceof Bodypart ) {
			var bp = gC(charKey).body[bpi];
			if ( bp.bondage != -1 ) {
				bondageList.push(parseInt(bp.bondage));
			}
		}
	}
	return bondageList;
}

window.getActionsWindow = function() {
	var wText = '<<removeclass "#right-ui-bar" "stowed">> \ ' + "__Actions Menu__\n"
			  + "This window will display information about all actions known by you or the other Candidates.\n\n";
	// Collect actions
	var actionsList = [];
	for ( var cK of getActiveSimulationCharactersArray() ) {
		for ( var act of gC(cK).saList ) {
			if ( actionsList.includes(act) == false ) {
				actionsList.push(act);
			}
		}
	}
	// Order actions
	actionsList = orderActionsList(actionsList);
	// Display actions list
	for ( var act of actionsList ) {
		var actDesc = setup.saList[act].description;
		wText += "\- <span title=" + '"' + actDesc + '">' + setup.saList[act].name + "</span>^^(?)^^" ;
		// Sex/Battle scene icons
		if ( setup.saList[act].tags.includes("ss") ) {
			wText += colorText(" Sex","lightpink");
		}
		if ( setup.saList[act].tags.includes("bs") ) {
			wText += colorText(" Btl","coral");
		}
		// Learned icon
		if ( gC("chPlayerCharacter").saList.includes(act) ) {
			wText += colorText(" Learned","yellowgreen");
		}
		if ( setup.saList[act].tags.includes("ss") ) {
			if ( setup.saList[act].flavorTags.includes("position") ) {
				// Positions
				wText += colorText(" Pos","burlywood");
			} else if ( setup.saList[act].flavorTags.includes("continuedAction") ) {
				// Continued actions
				wText += colorText(" Con","burlywood");
			} else {
				// Basic actions
				wText += colorText(" Bas","burlywood");
			}
		} else {
			if ( setup.saList[act].affinities.includes("pounce") ) {
				// Pounce
				wText += colorText(" Pnc","goldenrod");
			} else {
				// Everything else
				wText += colorText(" Bas","goldenrod");
			}
		}
		wText += "\n";
	}
	// Exit menu button
	wText += "\n<<l" + "ink [[Exit actions menu|Personal Room]]>><<s" + "cript>>"
			+ "State.variables.personalRoom.roomState = 'main';\n"
			+ "<</s" + "cript>><</l" + "ink>>\n";
	return wText;
}
window.orderActionsList = function(actList) {
	var nActList = [];
	var startingActions = [];
	var sSingleActions = [];
	var sContinuedActions = [];
	var sPositionActions = [];
	var bNormalActions = [];
	var bPounceActions = [];
	
	for ( var act of actList ) {
		if ( act == "doNothing" || act == "struggle" ) {
			startingActions.push(act);
		} else {
			if ( setup.saList[act].tags.includes("ss") ) {
				// Sex actions
				if ( setup.saList[act].flavorTags.includes("position") ) {
					// Positions
					sPositionActions.push(act);
				} else if ( setup.saList[act].flavorTags.includes("continuedAction") ) {
					// Continued actions
					sContinuedActions.push(act);
				} else {
					// Basic actions
					sSingleActions.push(act);
				}
			} else {
				// Battle actions
				if ( setup.saList[act].affinities.includes("pounce") ) {
					// Pounce
					bPounceActions.push(act);
				} else {
					// Everything else
					bNormalActions.push(act);
				}
			}
		}
	}
	
	nActList = startingActions.concat(sSingleActions).concat(sContinuedActions).concat(sPositionActions).concat(bNormalActions).concat(bPounceActions);
	return nActList;
}

window.attemptEquipSelectedItem = function() {
	var resultMessage = "";
	if ( State.variables.selectedEquip != "" && State.variables.selectedChar != "" ) {
		if ( mayEquipmentBePut(State.variables.selectedEquip,State.variables.selectedChar) ) {
			var days = 1;
			if ( State.variables.selectedChar == "chPlayerCharacter" ) { days = -1; }
			else { days = getRelation(State.variables.selectedChar,"chPlayerCharacter").relType.days; }
			equipObjectOnWearer(State.variables.selectedEquip,State.variables.selectedChar,days);
			if ( days == -1 ) {
				resultMessage = "The selected item was equipped. You may remove it at any time.";
			} else {
				resultMessage = "The selected item was equipped for " + days + " day/s.";
			}
		} else {
			resultMessage = "The selected item couldn't be equipped on the selected character.";
		}
	} else {
		resultMessage = "You must select an item and a character to equip an item.";
	}
	State.variables.roomMessage = resultMessage;
}

window.getCustomizeMoodWindow = function() {
	var wText = "__Customize Mood Menu__\nSet each mood's desired value.\nYour character's mood will gradually move towards your set values.\nUse only positive integer numbers.\n\nCurrent maximum modifier: " + getCharsMaximumMoodModifier("chPlayerCharacter").toFixed(1) + "\n\n";
	var moodsList = [ "Friendly","Intimate","Flirty","Aroused","Dominant","Submissive","Bored","Angry" ];
	var currentMoodMods = State.variables.playerCustomMoods;
	var i = 0;
	for ( var mood of moodsList ) {
		wText += mood + ": " + '<<textbox "$playerCustomMoods[' + i + ']" "' + currentMoodMods[i] + '">>\n';
		i++;
	}
	wText += "\n<<l" + "ink [[Update|Personal Room]]>><<s" + "cript>>"
			+ "updatePlayerCustomMoods();\n"
			+ "<</s" + "cript>><</l" + "ink>>\n";
	wText += "<<l" + "ink [[Update and exit menu|Personal Room]]>><<s" + "cript>>"
			+ "State.variables.personalRoom.roomState = 'main';\n"
			+ "updatePlayerCustomMoods();\n"
			+ "<</s" + "cript>><</l" + "ink>>\n";
	return wText;
}
window.updatePlayerCustomMoods = function() {
	var maxMoodMod = getCharsMaximumMoodModifier("chPlayerCharacter");
	var currentMood = 0;
	var i = 0;
	for ( var mood of State.variables.playerCustomMoods ) {
		if ( isNaN(mood) ) {
			State.variables.playerCustomMoods[i] = 0;
		} else if ( mood <= 0 ) {
			State.variables.playerCustomMoods[i] = 0;
		} else if ( mood >= maxMoodMod ) {
			State.variables.playerCustomMoods[i] = maxMoodMod;
		}
		i++;
	}
}

// Virginities
window.getCharsVirginityChart = function(charKey) {
	var cText = "";
	for ( var it in gC(charKey).virginities ) {
		if ( gC(charKey).virginities[it] instanceof Virginity ) {
			var virginity = gC(charKey).virginities[it];
			if ( virginity.taken && virginity.enabled && gC(charKey).body.hasOwnProperty(virginity.type) ) {
				if ( cText != "" ) { cText += "\n"; }
				cText += `${virginity.name}: `;
				switch(virginity.ctxt) {
					case "bs":
						cText += `Taken by ${virginity.takerName} during battle.`;
						break;
					case "forced":
						cText += `Taken by ${virginity.takerName}.`
						break;
					case "given":
						cText += `Given to ${virginity.takerName}.`
						break;
				}
			}
		}
	}
	return cText;
}

// Merchants
window.spawnMerchants = function() {
	for ( var merchantID of State.variables.enabledMerchants ) {
		if ( State.variables.currentMerchants.includes(merchantID) == false ) {
			if ( limitedRandomInt(100) <= getMerchantDataByID(merchantID).chance ) {
				State.variables.currentMerchants.push(merchantID);
			}
		}
	}
}

window.getButtonMerchants = function() {
		var bText = "";
		if ( State.variables.currentMerchants.length > 0 ) {
			bText = "<<l" + "ink [[Merchants|Personal Room]]>><<s" + "cript>>";
				bText += "State.variables.personalRoom.roomState = 'merchants';\n";
				bText += "<</s" + "cript>><</l" + "ink>> (" + State.variables.currentMerchants.length + ")\n\n";
		}
		return bText;
}
window.getMerchantsWindow = function() {
	var wText = "__Merchants Menu__:\nCurrent money: " + gC("chPlayerCharacter").money.toFixed(1) + "\n\n";
	// Print merchants
	for ( var merchantID of State.variables.currentMerchants ) {
		var merData = getMerchantDataByID(merchantID);
		wText += "__" + merData.name + "__:\n"
			   + '//' + merData.getDescription() + '//\n';
			// Print buy item buttons
				for ( var itemType of merData.getSoldItems() ) {
					wText += "- " + getBuyItemButtonByID(itemType) + "\n";
				}
			// New line
		wText += "\n";
	}
	wText += "\n<<l" + "ink [[Exit merchants menu|Personal Room]]>><<s" + "cript>>"
			+ "State.variables.personalRoom.roomState = 'main';\n"
			+ "<</s" + "cript>><</l" + "ink>>\n";
	return wText;
}
window.getBuyItemButtonByID = function(id) {
	var itemData = setup.equipDataList[id];
	var bText = "";
	if ( itemData.price > gC("chPlayerCharacter").money ) { // Not enough money
		bText = colorText(itemData.name,"firebrick") + getItemDescriptionBySetupId(id) + colorText(" - Cost: " + itemData.price,"firebrick") + " - You don't have enough money.";
	} else {
		bText = "<<l" + "ink [[" + itemData.name + "|Personal Room]]>><<s" + "cript>>"
			+ "charBuysItem('chPlayerCharacter','" + id + "');\n"
			+ "<</s" + "cript>><</l" + "ink>>" + getItemDescriptionBySetupId(id) + " - Cost: " + itemData.price;
	}
	return bText;
}

// AI

window.getAvailableItemsIDs = function() {
	var availableItemsIDs = [];
	for ( var merchantID of State.variables.currentMerchants ) {
		for ( var itemID of getMerchantDataByID(merchantID).getSoldItems() ) {
			if ( availableItemsIDs.includes(itemID) == false ) {
				availableItemsIDs.push(itemID);
			}
		}
	}
	return availableItemsIDs;
}
window.excludeItemsByPrice = function(itemsList,money) {
	var newItemsList = [];
	for ( var item of itemsList ) {
		if ( setup.equipDataList[item].price <= money ) {
			newItemsList.push(item);
		}
	}
	return newItemsList;
}
window.getBuyableWeaponsIDs = function(buyableItems) {
	var weaponsList = [];
	for ( var item of buyableItems ) {
		if ( equipmentIsWeapon(setup.equipDataList[item]) ) {
			weaponsList.push(item);
		}
	}
	return weaponsList;
}
window.getBuyableBondageIDs = function(buyableItems) {
	var bondagesList = [];
	for ( var item of buyableItems ) {
		if ( equipmentIsBondage(setup.equipDataList[item]) ) {
			bondagesList.push(item);
		}
	}
	return bondagesList;
}
window.npcsBuyItems = function() {
	var availableItemsIDs = getAvailableItemsIDs();
	for ( var character of getActiveSimulationCharactersArray() ) {
		var buyableItemsIDs = excludeItemsByPrice(availableItemsIDs,gC(character).money);
		if ( character != "chPlayerCharacter" ) {
			// Weapons
			var currentWeaponValue = 0;
			var buyableWeaponsList = getBuyableWeaponsIDs(buyableItemsIDs);
			if ( buyableWeaponsList.length > 0 ) { // Assign values to buyable weapons
				var bestCandidateWeaponValue = -1;
				var bestCandidateWeaponID = -1;
				if ( gC(character).weaponID != -1 ) {
					currentWeaponValue = npcValuesWeapon(character,getEquipDataById(gC(character).weaponID)) * 1.3;
				}
				// Find best buyable weapon
				for ( var buyableWeapon of buyableWeaponsList ) {
					var currentBuyableWeaponValue = npcValuesWeapon(character,setup.equipDataList[buyableWeapon]);
					if ( currentBuyableWeaponValue > bestCandidateWeaponValue ) {
						bestCandidateWeaponValue = currentBuyableWeaponValue;
						bestCandidateWeaponID = buyableWeapon;
					}
				}
				// Check is best buyable weapon better
				if ( bestCandidateWeaponID != -1 ) {
					if ( bestCandidateWeaponValue > currentWeaponValue ) {
						unequipObject(gC(character).weaponID);
						var newWeaponID = charBuysItem(character,bestCandidateWeaponID);
						equipObjectOnWearer(newWeaponID,character,-1);
					}
				}
			}
			// Bondage
			var buyableBondageList = getBuyableBondageIDs(buyableItemsIDs);
			if ( buyableBondageList.length > 0 ) {
				var bondageToBuyList = []; // List of lists: [BondageId,BondageScore]
				var bestBondageScore = -1;
				for ( var buyableBondage of buyableBondageList ) {
					var newString = [buyableBondage];
					
					newString.push(npcValuesBondage(character,buyableBondage));
					bondageToBuyList.push(newString);
				}
				for ( var buyableBondage of bondageToBuyList ) {
					if ( buyableBondage[1] > bestBondageScore ) {
						bestBondageScore = buyableBondage[1];
					}
				}
				var newBondageToBuyList = []; // List of bondage IDs with best score, one of these will be chosen at random
				for ( var buyableBondage of bondageToBuyList ) {
					if ( buyableBondage[1] == bestBondageScore ) {
						newBondageToBuyList.push(buyableBondage[0]);
					}
				}
				if ( newBondageToBuyList.length > 0 ) {
					var idToBuy = randomFromList(newBondageToBuyList); // Select item out of those with best score
					charBuysItem(character,idToBuy); // Buy selected item
				}
			}
		}
	}
}	
window.npcsEquipBondage = function() {
	for ( var character of getActiveSimulationCharactersArray() ) {
		if ( character != "chPlayerCharacter" ) {
			var activeSubChars = gC(character).subChars;
			var usableBondage = getCharsUnusedBondage(character);
			
			while ( activeSubChars.length > 0 && usableBondage.length > 0 ) {
				var newActiveSubChars = [];
				for ( var subChar of activeSubChars ) {
					var flagTryingToDominate = true;
					if ( gRelTypeAb(character,subChar) == "tutorship" ) {
						// Relationship is tutorship, does tutor want to dominate?
						if ( (getCharsDrivePercent(character,"dDomination") * 2 + getCharsDrivePercent(character,"dAmbition") + getCharsDrivePercent(character,"dPleasure")) < 0.8 ) {
							flagTryingToDominate = false;
							if ( (getCharsDrivePercent(character,"dDomination") * 2 + getCharsDrivePercent(character,"dAmbition") + getCharsDrivePercent(character,"dPleasure")) > 0.5 && getItemListEquippableOnChar(subChar,usableBondage).length > 0 ) {
								// Soft domination
								var softBondage = findValidSoftBondageOnTargetFromActor(getItemListEquippableOnChar(subChar,usableBondage),subChar,character);
								if ( softBondage != -1 ) {
									equipObjectOnWearer(chosenBondageId,subChar,gRelTypeAb(character,subChar).days);
								}
							}
						}
					}
					// Check if there are no valid items for current char
					if ( flagTryingToDominate && getItemListEquippableOnChar(subChar,usableBondage).length > 0 ) {
						// Check if char is within power threshold
						if ( isSubOverDomsPowerThreshold(subChar,character) == false ) { // Check if true
							// Removed from new active sub chars
						} else {
							var chosenBondageId = chooseBestBondageForTargetByActor(getItemListEquippableOnChar(subChar,usableBondage),subChar,character);
							equipObjectOnWearer(chosenBondageId,subChar,gRelTypeAb(character,subChar).days);
							if ( subChar == "chPlayerCharacter" ) {
								State.variables.personalRoom.prMessages += gC(character).getFormattedName() + " has locked " + getEquipDataById(chosenBondageId).name + " on " + gC(subChar).getFormattedName() + ". It will remain locked for as many days as your special relationship is expected to last.\n";
							}
							arrayMinusA(usableBondage,chosenBondageId);
							newActiveSubChars.push(subChar);
						}
					}
				}
				activeSubChars = newActiveSubChars;
			}
		}
	}
}

// Engine

State.variables.personalRoom = new PersonalRoom();

window.attemptAutosave = function() {
	State.variables.compass.cleanLeftoverData();
	State.variables.personalRoom.prMessages = "";
	if ( gSettings().autosaving == "enable" && State.variables.personalRoom.autosavePossible ) {
		if ( State.variables.personalRoom.lastAutosaveDay != State.variables.daycycle.day ) {
			Save.slots.save(7);
			State.variables.personalRoom.lastAutosaveDay = State.variables.daycycle.day;
		}
	}
}

// Constructors, serializers, etc.
PersonalRoom.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
PersonalRoom.prototype.clone = function () {
	return (new PersonalRoom())._init(this);
};
PersonalRoom.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new PersonalRoom())._init($ReviveData$)', ownData);
};

// GLOBAL MAP EVENTS //

window.createTrainingEndEvent = function(minutes) {
	var sEvent = new systemEvent(minutes,["chDummy"],"scenarioEnd","End of training",function(cList) {
			// Finish map period
			State.variables.compass.finishMapSimulation();
			
			// Initialize Jobs
			State.variables.jobsAssigner.initJobsAssigner();
			
			// UI
			State.variables.compass.scenarioEndPassage = "The training period is over. The Candidates will now reunite to pick today's jobs.\n\n"
													   + "[[Continue|Jobs Screen]]";
		}
	);
	sEvent.executeWithoutCharacters = true;
	sEvent.priority = 100;
	return sEvent;
}

window.createSocializationEndEvent = function(minutes) {
	var sEvent = new systemEvent(minutes,["chDummy"],"scenarioEnd","End of training",function(cList) {
			State.variables.compass.finishMapSimulation();
			
			State.variables.compass.scenarioEndPassage = "The socialization period is over. The Candidates will now return to their rooms"
													   + " and end the day.\n\n"
													   + '<<' + 'link [[Continue|Personal Room]]>><<' + 'script>>'
													   + 'State.variables.personalRoom.initPersonalRoom();'
													   + '<</s' + 'cript>><</' + 'link>>';
		}
	);
	sEvent.executeWithoutCharacters = true;
	sEvent.priority = 100;
	return sEvent;
}


window.createFakePeriodEndEvent = function(minutes) {
	var sEvent = new systemEvent(minutes,["chDummy"],"scenarioEnd","End of training",function(cList) {
			// Finish map period
			State.variables.compass.finishMapSimulation();
			
			// UI
			State.variables.compass.scenarioEndPassage = "The fake period is over. Going back to debug menu.\n\n"
													   + "[[Continue|Quickstarts]]";
		}
	);
	sEvent.priority = 100;
	return sEvent;
}

window.createTestMapEndEvent = function(minutes) {
	var sEvent = new systemEvent(minutes,["chDummy"],"scenarioEnd","End of training",function(cList) {
			// Finish map period
			State.variables.compass.finishMapSimulation();
			//deinitMapGleamingCaverns();
			initMapTrainingGrounds();
			
			// UI
			State.variables.compass.scenarioEndPassage = "The test is over. Shutting down Gleaming Caverns and initializating Passion Temple. Going back to debug menu.\n\n"
													   + "[[Continue|Quickstarts]]";
		}
	);
	sEvent.priority = 100;
	return sEvent;
}


window.createAdventureEndEvent = function(minutes) {
	var sEvent = new systemEvent(minutes,["chDummy"],"scenarioEnd","End of day",function(cList) {
			State.variables.compass.finishMapSimulation();
			
			State.variables.compass.scenarioEndPassage = "The day is over. The Candidates will now return to their rooms"
													   + " and end the day.\n\n"
													   + '<<' + 'link [[Continue|Personal Room]]>><<' + 'script>>'
													   + 'State.variables.personalRoom.initPersonalRoom();'
													   + '<</s' + 'cript>><</' + 'link>>';
		}
	);
	sEvent.executeWithoutCharacters = true;
	sEvent.priority = 100;
	return sEvent;
}

///// STATS CHART FUNCTIONS /////
// These functions create the proper code for HTML to generate graphs

window.createHorizontalGraph = function(fontSize,width,barsInfo,tooltipText) {
	// Font size: Percentage of standard font size ; Width: Absolute pixels
	// barsInfo: List: each component is a list: first component is color, second component is percentage
	
	var gText = "<ul title='" + tooltipText + "' style='list-style:none; width:100%; font-size:" + fontSize + "%; width:" + width + "px;'>\n";
	for ( var barInfo of barsInfo ) {
		gText += createHorizontalGraphBar(barInfo[0],barInfo[1]);
	}
	gText += "</ul>";
	return gText;
}

window.createHorizontalGraphBar = function(color,percentage) {
	var p = percentage;
	if ( p < 2 ) {
		p = 2;
	}
	var bText = "<li style='background:" + color + "; color:" + color + "; width:" + p + "%;' >.</li>\n";
	return bText;
}

///// Supporter tools data - Free version /////
// Creates pseudo-links to access supporter tools, except that they're locked
// In the supporter version file, these are real links

setup.quickstartLinkText = '<span style="color:firebrick">Locked: Get the Supporter Version on Patreon to access the Quickstart Menu.</span>';
setup.cheatMenuLinkText = '<span style="color:firebrick">Locked: Get the Supporter Version on Patreon to access the Cheat Menu.</span>';

window.SupToolsData = function() {
	
	this.quickstartRoomPassage = "";
	
	this.cheatMenuRoomPassage = "";
}

State.variables.supToolsData = new SupToolsData();

// Constructors, serializers, etc.
SupToolsData.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
SupToolsData.prototype.clone = function () {
	return (new SupToolsData())._init(this);
};
SupToolsData.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new SupToolsData())._init($ReviveData$)', ownData);
};

///// STORY EVENT FUNCTIONS /////

window.initializeSeStretchingHelp = function() {
	setPasChars([getPresentCharByKey("chNash")]);
	setRoomIntro("mapTrainingGrounds","dummies");
	State.variables.eventsCalendar.setFinishEventButton("Continue","setNoPasChars()");
	State.variables.StVars.futaNash = false;
	if ( State.variables.chNash.body.hasOwnProperty("dick") ) {
		State.variables.StVars.futaNash = true;
	}
	State.variables.StVars.seshFlirty = false;
	if ( State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv > 100 ) {
		State.variables.StVars.seshFlirty = true;
	}
}
window.initializeSeHumming = function() {
	setPasChars([getPresentCharByKey("chAte")]);
	setRoomIntro("mapTrainingGrounds","amphitheater");
	if ( gC("chPlayerCharacter").perception.getValue() > 9 || gC("chPlayerCharacter").empathy.getValue() > 11
		 || gC("chPlayerCharacter").luck.getValue() > 10 || gC("chPlayerCharacter").charisma.getValue() > 11 ) {
		State.variables.StVars.seHummingCopyCheck = true;
	} else {
		State.variables.StVars.seHummingCopyCheck = false;
	}
	if ( gC("chPlayerCharacter").perception.getValue() > 10 || gC("chPlayerCharacter").empathy.getValue() > 11
		 || gC("chPlayerCharacter").luck.getValue() > 11 || gC("chPlayerCharacter").charisma.getValue() > 11 ) {
		State.variables.StVars.seHummingHarmonyCheck = true;
	} else {
		State.variables.StVars.seHummingHarmonyCheck = false;
	}
	if ( gC("chPlayerCharacter").perception.getValue() > 11 || gC("chPlayerCharacter").intelligence.getValue() > 11
		 || gC("chPlayerCharacter").luck.getValue() > 11 || gC("chPlayerCharacter").charisma.getValue() > 11 ) {
		State.variables.StVars.seHummingImproviseCheck = true;
	} else {
		State.variables.StVars.seHummingImproviseCheck = false;
	}
}

window.initializeSeEthicsOfPower = function() {
	setPasChars([getPresentCharByKey("chClaw"),getPresentCharByKey("chMir")]);
	setRoomIntro("mapTrainingGrounds","grandHall");
	if ( (gC("chPlayerCharacter").intelligence.getValue() + gC("chPlayerCharacter").empathy.getValue()) > 24 ) {
		State.variables.StVars.seEthicsOfPowMUcheck = true;
	} else {
		State.variables.StVars.seEthicsOfPowMUcheck = false;
	}
}

window.initializeSeStayingHydrated = function() {
	charactersLearnSceneActions(["chMir","chVal"],["getBlowjob","legHoldHead","fuckFace","suckDick","lickPussy","rideFace","pushHipsBack"]);
	setPasChars([getPresentCharByKey("chNash"),getPresentCharByKey("chVal"),getPresentCharByKey("chMir"),getPresentCharByKey("chAte")]);
	setRoomIntro("mapTrainingGrounds","diningHall");
}

window.initializeSeFriendBackAtHome = function() {
	setRoomIntro("mapTrainingGrounds","lake");
	State.variables.StVars.SeFbahHowsSill = false;
	State.variables.StVars.SeFbahWhatsSill = false;
	State.variables.StVars.SeFbahWhyTakePlaceSill = false;
	State.variables.StVars.SeFbahRegretSill = false;
	State.variables.StVars.SeFbahAnyQuestions = "none";
}
window.SeFriendBackAtHomeCheck = function() {
	if ( State.variables.StVars.SeFbahHowsSill || State.variables.StVars.SeFbahWhatsSill || State.variables.StVars.SeFbahWhyTakePlaceSill ) {
		State.variables.StVars.SeFbahAnyQuestions = "some";
	}
	if ( State.variables.StVars.SeFbahHowsSill && State.variables.StVars.SeFbahWhatsSill && State.variables.StVars.SeFbahRegretSill ) {
		State.variables.StVars.SeFbahAnyQuestions = "all";
	}
}

window.initializeSeMagicClass = function() {
	setRoomIntro("mapTrainingGrounds","field");
	setPasChars([getPresentCharByKey("chMir"),getPresentCharByKey("chNash"),getPresentCharByKey("chClaw"),getPresentCharByKey("chVal"),getPresentCharByKey("chAte")]);
	State.variables.StVars.seMagicClassClawCheck = false;
	if ( (gCstat("chPlayerCharacter","agility") + gCstat("chPlayerCharacter","perception")) > 20 ) {
		State.variables.StVars.seMagicClassClawCheck = true;
	}
}

window.initializeSeStretchingHelpII = function() {
	setRoomIntro("mapTrainingGrounds","dummies");
	setPasChars([getPresentCharByKey("chNash"),getPresentCharByKey("chClaw")]);
	
	State.variables.StVars.seStHeIINashInvites = true;
	// If Nash dislikes the player, she won't invite to stretch
	if ( ( rLvlAbt("chNash","chPlayerCharacter","rivalry") + rLvlAbt("chNash","chPlayerCharacter","enmity") * 2 - rLvlAbt("chNash","chPlayerCharacter","friendship") ) > 3 ) {
		State.variables.StVars.seStHeIINashInvites = false;
	}
	// If Nash lusts after the player, she will grope the player
	if ( rLvlAbt("chNash","chPlayerCharacter","sexualTension") > 2 ) {
		State.variables.StVars.StretchingHelpGroped = "true";
	}
	// If Nash likes the player and is lustful, she will invite to have sex
	if ( ( rLvlAbt("chNash","chPlayerCharacter","sexualTension") + rLvlAbt("chNash","chPlayerCharacter","romance") ) > 2 ) {
		State.variables.StVars.StretchingHelpResult = "sexual";
	}
	
	State.variables.StVars.seStHeIIMayRejectSex = true;
	State.variables.StVars.seStHeIIwillpowerHit = rLvlAbt("chPlayerCharacter","chNash","sexualTension") + rLvlAbt("chPlayerCharacter","chNash","submission") - rLvlAbt("chPlayerCharacter","chNash","domination");
	if ( State.variables.StVars.seStHeIIwillpowerHit < 0 ) {
		State.variables.StVars.seStHeIIwillpowerHit = 0;
	}
	else {
		State.variables.StVars.seStHeIIwillpowerHit *= 20;
		if ( State.variables.StVars.seStHeIIwillpowerHit > gC("chPlayerCharacter").willpower.max ) {
			State.variables.StVars.seStHeIIMayRejectSex = false;
		}
	}
}

window.initializeSeFlirtingAdvice = function() {
	setRoomIntro("mapTrainingGrounds","diningHall");
	setPasChars([getPresentCharByKey("chAte"),getPresentCharByKey("chNash"),getPresentCharByKey("chMir"),getPresentCharByKey("chVal"),getPresentCharByKey("chClaw")]);
	State.variables.StVars.flirtingAdviceChecks = [ false , false , false , false ];
	// Physique + Agility check gCstat = function(charKey,stat)
	if ( gCstat("chPlayerCharacter","physique") + gCstat("chPlayerCharacter","agility") >= 24 ) {
		State.variables.StVars.flirtingAdviceChecks[0] = true;
	}
	// Empathy check
	if ( gCstat("chPlayerCharacter","empathy") >= 13 ) {
		State.variables.StVars.flirtingAdviceChecks[1] = true;
	}
	// Charisma check
	if ( gCstat("chPlayerCharacter","charisma") >= 13 ) {
		State.variables.StVars.flirtingAdviceChecks[2] = true;
	}
	// Charisma + Intelligence check
	if ( gCstat("chPlayerCharacter","charisma") + gCstat("chPlayerCharacter","intelligence") >= 24 ) {
		State.variables.StVars.flirtingAdviceChecks[3] = true;
	}
}

window.initializeSeDrishtyaTutorShip = function() {
	setRoomIntro("mapTrainingGrounds","southNaturalWall");
	setPasChars([getPresentCharByKey("chNash"),getPresentCharByKey("chAte"),getPresentCharByKey("chVal"),getPresentCharByKey("chMir")]);
	State.variables.StVars.DrishtyaTutorLifeAsCandidate = "";
	State.variables.StVars.DrishtyaTutorThoughtsOnPeers = "";
	State.variables.StVars.DrishtyaTutorReachedQuestions = false;
	State.variables.StVars.DrishtyaTutorBehindTheRest = false;
	State.variables.StVars.DrishtyaTutorStrengthenBonds = false;
	State.variables.StVars.DrishtyaTutorDominatingOthers = false;
	State.variables.StVars.DrishtyaTutorLeaveTheTemple = false;
	State.variables.StVars.DrishtyaTutorEmpathyCheck = false;
	State.variables.StVars.VaryonteTutorHasDick = false;
	// Empathy check
	if ( gCstat("chPlayerCharacter","empathy") >= 15 ) {
		State.variables.StVars.DrishtyaTutorEmpathyCheck = true;
	}
	if ( gC("chPlayerCharacter").hasFreeBodypart("dick") ) {
		State.variables.StVars.VaryonteTutorHasDick = true;
	}
}

window.initializeSeBeatingKittyIntoFriendship = function() {
	// Init StVars
	State.variables.StVars.playerJoinedBkifBattle = false;
	State.variables.StVars.drishtyaSawVaryonteMoves = false;
	
	// Change map rules
	State.variables.settings.followingAllowed = true;
	State.variables.settings.relationshipTypesAllowed = true;
	State.variables.settings.challengingAllowed = true;
	State.variables.settings.assaultingAllowed = true;
	
	State.variables.StVars.BkifNashRelScore = rLvlAbt("chNash","chPlayerCharacter","friendship") + rLvlAbt("chNash","chPlayerCharacter","romance") * 2 + rLvlAbt("chNash","chPlayerCharacter","submission") - rLvlAbt("chNash","chPlayerCharacter","domination") - rLvlAbt("chNash","chPlayerCharacter","enmity");
	
	State.variables.StVars.BkifStakes = "servitude";
	if ( gSettings().servitudeRelationships == "disable" ) {
		if ( gSettings().battleDefeatSex == "enable" ) {
			State.variables.StVars.BkifStakes = "sex";
		} else {
			State.variables.StVars.BkifStakes = "humilliation";
		}
	}
	
	setRoomIntro("mapTrainingGrounds","field");
	setPasChars([getPresentCharByKey("chNash"),getPresentCharByKey("chClaw"),getPresentCharByKey("chAte"),getPresentCharByKey("chVal"),getPresentCharByKey("chMir")]);
}

window.finishSeBtif = function() {
	for ( var charKey of ["chPlayerCharacter","chNash","chClaw","chVal"] ) {
		gC(charKey).lust.current = gC(charKey).lust.max;
	}
}

window.initializeSeBkifOutcome = function () {
	State.variables.StVars.clawLostBkif = false;
	if ( gC("chClaw").baseMood.angry == 0 ) { State.variables.StVars.clawLostBkif = true; }
	
	// Reset Claw's base mood
	gC("chClaw").baseMood.angry = 0;
	gC("chClaw").mood.angry = 0;
	
	// Checks
	State.variables.StVars.check1 = false;
	if ( gC("chPlayerCharacter").physique.affinity >= 1.10 || gC("chPlayerCharacter").agility.affinity >= 1.10 || gC("chPlayerCharacter").resilience.affinity >= 1.10 ) {
		State.variables.StVars.check1 = true;
	}
	State.variables.StVars.check2 = false;
	if ( gC("chPlayerCharacter").will.getValue() >= 12 ) {
		State.variables.StVars.check2 = true;
	}
	State.variables.StVars.check3 = false;
	if ( gC("chPlayerCharacter").intelligence.getValue() >= 13 || gC("chPlayerCharacter").empathy.getValue() >= 13 || gC("chPlayerCharacter").luck.getValue() >= 13 ) {
		State.variables.StVars.check3 = true;
	}
	State.variables.StVars.check4 = false;
	if ( ( gC("chPlayerCharacter").subChars.length == 0 ) && ( gC("chPlayerCharacter").domChar == null ) && ( gC("chNash").domChar == null ) && ( gRelTypeAb("chPlayerCharacter","chNash") == null ) ) {
	State.variables.StVars.check4 = true;
	}
	State.variables.StVars.check5 = false;
	if ( gC("chPlayerCharacter").physique.getValue() >= 14 || gC("chPlayerCharacter").agility.getValue() >= 14 || gC("chPlayerCharacter").resilience.getValue() >= 14 ) {
		State.variables.StVars.check5 = true;
	}
	
	State.variables.StVars.BkifNashRelScore = rLvlAbt("chNash","chPlayerCharacter","friendship") + rLvlAbt("chNash","chPlayerCharacter","romance") * 2 + rLvlAbt("chNash","chPlayerCharacter","submission") - rLvlAbt("chNash","chPlayerCharacter","domination") - rLvlAbt("chNash","chPlayerCharacter","enmity");
	
	// Initiate UI
	setRoomIntro("mapTrainingGrounds","fulfillmentCorridor");
	setPasChars([getPresentCharByKey("chAte"),getPresentCharByKey("chNash")]);
}

window.initializeSeAspiringTreeClimber = function () {
	gC("chClaw").agility.addExperience(1000);
	// Checks
	State.variables.StVars.check1 = false;
	if ( gC("chPlayerCharacter").saList.includes("baHypnoticGlance") ) {
		State.variables.StVars.check1 = "hypnosis";
	} else if ( gC("chPlayerCharacter").saList.includes("baEnergyDrainingKiss") ) {
		State.variables.StVars.check1 = "draining";
	} else if ( gC("chPlayerCharacter").saList.includes("baEtherealChains") ) {
		State.variables.StVars.check1 = "bondage";
	}
	
	State.variables.StVars.check2 = false; // Climb tree
	if ( ( gCstat("chPlayerCharacter","physique") + gCstat("chPlayerCharacter","resilience") + (gCstat("chPlayerCharacter","agility") / 2) ) >= 28 ) {
		State.variables.StVars.check2 = true;
	}
	State.variables.StVars.check3 = false; // Jump tree
	if ( ( gCstat("chPlayerCharacter","physique") + gCstat("chPlayerCharacter","agility") ) >= 26 ) {
		State.variables.StVars.check3 = true;
	}
	State.variables.StVars.check4 = false; // Jump at Claw
	if ( ( gCstat("chPlayerCharacter","physique") + gCstat("chPlayerCharacter","agility") + gCstat("chPlayerCharacter","perception") + gCstat("chPlayerCharacter","luck") ) >= 48 ) {
		State.variables.StVars.check4 = true;
	}
	State.variables.StVars.check5 = false; // Hold Claw down
	if ( ( gCstat("chPlayerCharacter","physique") + gCstat("chPlayerCharacter","resilience") ) >= 28 ) {
		State.variables.StVars.check5 = true;
	}
	State.variables.StVars.check6 = false; // Hypnotize Claw
	if ( ( gCstat("chPlayerCharacter","will") + gCstat("chPlayerCharacter","charisma") ) >= 26 ) {
		State.variables.StVars.check6 = true;
	}
	State.variables.StVars.check7 = false; // Bind Claw
	if ( ( gCstat("chPlayerCharacter","intelligence") + gCstat("chPlayerCharacter","will") ) >= 26 ) {
		State.variables.StVars.check7 = true;
	}
	State.variables.StVars.check8 = false; // Drain Claw
	if ( ( gCstat("chPlayerCharacter","agility") + gCstat("chPlayerCharacter","charisma") ) >= 26 ) {
		State.variables.StVars.check8 = true;
	}
	State.variables.StVars.check9 = false; // Claw is submissive
	if ( gC("chPlayerCharacter").subChars.includes("chClaw") ) {
		State.variables.StVars.check9 = true;
	}
	State.variables.StVars.check10 = false; // Claw is dominant
	if ( gC("chClaw").subChars.includes("chPlayerCharacter") ) {
		State.variables.StVars.check10 = true;
	}
	
	// Initiate UI
	setRoomIntro("mapTrainingGrounds","forest");
	setPasChars([getPresentCharByKey("chClaw")]);
}

window.initializeSeLuringMasquerade = function () {
	gC("chVal").charisma.addExperience(1000);
	charactersLearnSceneActions(["chVal"],["baBorrowedIdentity"]);
	// Checks
	State.variables.StVars.check1 = false; // Discovers plot check
	if ( ( gCstat("chPlayerCharacter","empathy") >= 13 ) || ( gCstat("chPlayerCharacter","perception") >= 13 ) || ( gCstat("chPlayerCharacter","intelligence") >= 14 ) ) {
		State.variables.StVars.check1 = true;
	}
	
	// Initiate UI
	setRoomIntro("mapTrainingGrounds","lake");
	setPasChars([]);
}

window.initializeSeGiftsForNature = function() {
	// Checks
	State.variables.StVars.check1 = false; // Avoid parasafi flower check
	if ( ( gCstat("chPlayerCharacter","will") >= 13 ) || ( gCstat("chPlayerCharacter","perception") >= 14 ) || ( gCstat("chPlayerCharacter","agility") >= 14 ) ) {
		State.variables.StVars.check1 = true;
	}
	
	// Conversation flags
	State.variables.StVars.check2 = false; // How does a gardener help me
	State.variables.StVars.check3 = false; // Gardener is selfish
	State.variables.StVars.check4 = false; // Gardener dislikes protegee
	State.variables.StVars.check5 = false; // Would want a gardener
	State.variables.StVars.check6 = false; // Would want to garden Mir
	State.variables.StVars.check7 = false; // Ask about Padmiri's gardener
	State.variables.StVars.check8 = false; // You would be a selfish gardener
	State.variables.StVars.check9 = false; // Selfish + domination
	
	// Initiate UI
		//setRoomIntro("mapTrainingGrounds","lake");
	setPasChars([getPresentCharByKey("chMir")]);
}

window.initializeSeDiscoveringTheOthers = function() {
	// Checks
	State.variables.StVars.check1 = false; // Int check
	if ( gCstat("chPlayerCharacter","intelligence") >= 14 || gCstat("chPlayerCharacter","perception") >= 15 ) {
		State.variables.StVars.check1 = true;
	}
	State.variables.StVars.check2 = false; // Cha check
	if ( gCstat("chPlayerCharacter","charisma") >= 14 ) {
		State.variables.StVars.check2 = true;
	}
	State.variables.StVars.check3 = false; // Emp check
	if ( gCstat("chPlayerCharacter","empathy") >= 13 ) {
		State.variables.StVars.check3 = true;
	}
	State.variables.StVars.check4 = 0; // Relation check
	State.variables.StVars.check4 += rLvlAbt("chAte","chPlayerCharacter","friendship") * 1 + rLvlAbt("chAte","chPlayerCharacter","romance") * 1 - rLvlAbt("chAte","chPlayerCharacter","rivalry") * 2 - rLvlAbt("chAte","chPlayerCharacter","enmity") * 4;
	
	// Initiate UI
	setRoomIntro("mapTrainingGrounds","westLibrary");
	setPasChars([getPresentCharByKey("chAte")]);
	
	// New social action
	State.variables.chAte.extraSocIntList.push("relaxingScent");
}

window.effectsSeDiscoveringTheOthersEarlyEnd = function() {
	if ( limitedRandomInt(100) > 49 ) {
		// Val gives advice to Ate
		State.variables.chVal.relations.chAte.friendship.stv += 350;
		State.variables.chAte.relations.chVal.friendship.stv += 350;
		State.variables.chVal.relations.chAte.sexualTension.stv += 350;
		State.variables.chAte.relations.chVal.sexualTension.stv += 350;
		addPointsToDrive(gC("chAte").dPleasure,50);
		addPointsToDrive(gC("chAte").dDomination,50);
		State.variables.chVal.socialdrive.current -= 25;
	} else {
		// Mir gives advice to Ate
		State.variables.chMir.relations.chAte.friendship.stv += 350;
		State.variables.chAte.relations.chMir.friendship.stv += 350;
		State.variables.chMir.relations.chAte.romance.stv += 350;
		State.variables.chAte.relations.chMir.romance.stv += 350;
		addPointsToDrive(gC("chAte").dLove,50);
		addPointsToDrive(gC("chAte").dCooperation,50);
		State.variables.chMir.socialdrive.current -= 25;
	}
}

window.initializeSeTheMerchants = function() {
	// Clean old variables
	cleanPrologueStoryVars();
	// Shrezdill - Old Ashwalker Candidate
	// Abibdill - Weapons merchant
	// Nimeresh - Bondage merchant
	// Enable and set merchants
	State.variables.enabledMerchants.push(0);
	State.variables.enabledMerchants.push(30);
	if ( State.variables.currentMerchants.includes(30) == false ) {
		State.variables.currentMerchants.push(30);
	}
	if ( State.variables.currentMerchants.includes(0) == false ) {
		State.variables.currentMerchants.push(0);
	}
	
	// Relation changes
	State.variables.chVal.relations.chMir.submission.stv += 150;
	State.variables.chMir.relations.chVal.domination.stv += 150;
	State.variables.StVars.check2 = 0;
	State.variables.StVars.check3 = 0;
	State.variables.StVars.check4 = 0;
	State.variables.StVars.check10 = false;
	
	// Checks
		// Character choice
	var nashScore = rLvlAbt("chNash","chPlayerCharacter","sexualTension") * 2 + rLvlAbt("chNash","chPlayerCharacter","romance") + rLvlAbt("chNash","chPlayerCharacter","domination") - rLvlAbt("chNash","chPlayerCharacter","submission");
	var mirScore = rLvlAbt("chMir","chPlayerCharacter","sexualTension") * 2 + rLvlAbt("chMir","chPlayerCharacter","romance") + rLvlAbt("chMir","chPlayerCharacter","domination") - rLvlAbt("chMir","chPlayerCharacter","submission");
	var valScore = rLvlAbt("chVal","chPlayerCharacter","sexualTension") * 2 + rLvlAbt("chVal","chPlayerCharacter","romance") + rLvlAbt("chVal","chPlayerCharacter","domination") - rLvlAbt("chVal","chPlayerCharacter","submission");
	if ( nashScore >= mirScore && nashScore >= valScore ) {
		State.variables.StVars.check1 = "nash";
	} else if ( valScore >= mirScore ) {
		State.variables.StVars.check1 = "val";
	} else {
		State.variables.StVars.check1 = "mir";
	}
	
		// Mir, Nash, Val, cost
	State.variables.StVars.check2 = (rLvlAbt("chPlayerCharacter","chMir","submission") - rLvlAbt("chPlayerCharacter","chMir","domination")) * 20 + rLvlAbt("chPlayerCharacter","chMir","sexualTension") * 10;
	if ( State.variables.StVars.check2 <= 10 ) { State.variables.StVars.check2 = 10; }
	State.variables.StVars.check3 = (rLvlAbt("chPlayerCharacter","chNash","submission") - rLvlAbt("chPlayerCharacter","chNash","domination")) * 20 + rLvlAbt("chPlayerCharacter","chNash","sexualTension") * 10;
	if ( State.variables.StVars.check3 <= 10 ) { State.variables.StVars.check3 = 10; }
	State.variables.StVars.check4 = (rLvlAbt("chPlayerCharacter","chVal","submission") - rLvlAbt("chPlayerCharacter","chVal","domination")) * 20 + rLvlAbt("chPlayerCharacter","chVal","sexualTension") * 10;
	if ( State.variables.StVars.check4 <= 10 ) { State.variables.StVars.check4 = 10; }
	if ( State.variables.StVars.check2 > State.variables.chPlayerCharacter.willpower.current || State.variables.StVars.check3 > State.variables.chPlayerCharacter.willpower.current || State.variables.StVars.check4 > State.variables.chPlayerCharacter.willpower.current ) {
		State.variables.StVars.check10 = true;
	}
	
		// Nash, Mir, Val, Ate, Claw checks
	State.variables.StVars.check5 = false;
	if ( (gCstat("chPlayerCharacter","charisma") + gCstat("chPlayerCharacter","will") + rLvlAbt("chNash","chPlayerCharacter","submission") + rLvlAbt("chNash","chPlayerCharacter","sexualTension") - rLvlAbt("chNash","chPlayerCharacter","domination") ) >= 28 ) { State.variables.StVars.check5 = "true"; }
	State.variables.StVars.check6 = false;
	if ( (gCstat("chPlayerCharacter","charisma") + gCstat("chPlayerCharacter","will") + rLvlAbt("chMir","chPlayerCharacter","submission") + rLvlAbt("chMir","chPlayerCharacter","sexualTension") - rLvlAbt("chMir","chPlayerCharacter","domination") ) >= 27 ) { State.variables.StVars.check6 = "true"; }
	State.variables.StVars.check7 = false;
	if ( (gCstat("chPlayerCharacter","agility") + gCstat("chPlayerCharacter","will") + rLvlAbt("chVal","chPlayerCharacter","submission") + rLvlAbt("chVal","chPlayerCharacter","sexualTension") - rLvlAbt("chVal","chPlayerCharacter","domination") ) >= 29 ) { State.variables.StVars.check7 = "true"; } 
	State.variables.StVars.check8 = false;
	if ( (gCstat("chPlayerCharacter","luck") + gCstat("chPlayerCharacter","will") + rLvlAbt("chAte","chPlayerCharacter","submission") + rLvlAbt("chAte","chPlayerCharacter","sexualTension") - rLvlAbt("chAte","chPlayerCharacter","domination") ) >= 25 ) { State.variables.StVars.check8 = "true"; }
	State.variables.StVars.check9 = false;
	if ( (gCstat("chPlayerCharacter","agility") + gCstat("chPlayerCharacter","will") + rLvlAbt("chClaw","chPlayerCharacter","submission") + rLvlAbt("chClaw","chPlayerCharacter","sexualTension") - rLvlAbt("chClaw","chPlayerCharacter","domination") ) >= 26 ) { State.variables.StVars.check9 = "true"; }
	
	// Initiate UI
	setRoomIntro("mapTrainingGrounds","grandHall");
	setPasChars([getPresentCharByKey("chNash"),getPresentCharByKey("chVal"),getPresentCharByKey("chMir"),getPresentCharByKey("chAte"),getPresentCharByKey("chClaw")]);
}

window.effectsSeTheMerchantsEnd = function() {
	createEquipment(equipmentType.KNUCKLES,"chClaw");
	createEquipment(equipmentType.WAND,"chMir");
	createEquipment(equipmentType.HANDFAN,"chVal");
	createEquipment(equipmentType.WAND,"chAte");
	createStartingPunishmentBondage();
}

window.cleanPrologueStoryVars = function() {
	for ( var stvar of ["firstDayWashed","firstDayTuto","ghAnnoyed","gh0","gh1","gh2","firstDayElderA","firstDayElderAndAshwalkers","pcDoom","pcMainDoom","pcBoon","pcMainBoon","firstDayTalkedToElder","metNash","metClaw","metVal","firstDayMirsFlower","nashRival","FirstDayWaitedWith","FirstDayNashRival","FirstDayMetAllCandidates","seMagicClassClawCheck","futaNash","seshFlirty","StretchingHelpResult","StretchingHelpGroped","seHummingCopyCheck","seHummingHarmonyCheck","seHummingImproviseCheck","seEthicsOfPowMUcheck","SeFbahHowsSill","SeFbahWhatsSill","SeFbahWhyTakePlaceSill","SeFbahRegretSill","SeFbahAnyQuestions","seStHeIINashInvites","seStHeIIMayRejectSex","seStHeIIwillpowerHit","flirtingAdviceChecks","DrishtyaTutorLifeAsCandidate","DrishtyaTutorThoughtsOnPeers","DrishtyaTutorReachedQuestions","DrishtyaTutorBehindTheRest","DrishtyaTutorStrengthenBonds","DrishtyaTutorDominatingOthers","DrishtyaTutorEmpathyCheck","DrishtyaTutorLeaveTheTemple","VaryonteTutorHasDick"] ) {
		if ( State.variables.StVars[stvar] != undefined ) {
			State.variables.StVars[stvar];
		}
	}
}

// Version 0.3

window.initializeGleamingCavernsOverview = function() {
	setPasChars([getPresentCharByKey("chMir"),getPresentCharByKey("chAte"),getPresentCharByKey("chClaw"),getPresentCharByKey("chNash"),getPresentCharByKey("chVal")]);
	setRoomIntro("mapTrainingGrounds","diningHall");
	for ( var cK of getCandidatesKeysArray() ) {
		for ( var at of setup.baseStats ) {
			gC(cK)[at].affinity -= 0.1;
		}
		gC(cK).charisma.affinity += 0.50;
		gC(cK).empathy.affinity += 0.40;
	}
}

window.initializePostAdventurePlaceholder = function() {
	for ( var cK of getCandidatesKeysArray() ) {
		for ( var at of setup.baseStats ) {
			gC(cK)[at].affinity += 0.1;
		}
		gC(cK).charisma.affinity -= 0.50;
		gC(cK).empathy.affinity -= 0.40;
	}
}

window.initializeSeTGoL = function() {
	// Checks
	State.variables.StVars.check1 = false; // Appeal to Ate's pride
	if ( (gCstat("chPlayerCharacter","charisma") * 1.2 + gCstat("chPlayerCharacter","empathy")) >= 25 ) {
		State.variables.StVars.check1 = true;
	}
	
	setPasChars([getPresentCharByKey("chVal"),getPresentCharByKey("chClaw")]);
	setRoomIntro("mapTrainingGrounds","eastBridge");
}

window.initializeMartialTutorshipI = function() {
	setPasChars([getPresentCharByKey("chNash")]);
	setRoomIntro("mapTrainingGrounds","dummies");
	
	// Check player weapon
	var pWeapon = "none";
	//var wType = getEquipById(gC("chPlayerCharacter").weaponID).type;
	if ( gC("chPlayerCharacter").weaponID == -1 ) {
	} else if ( getEquipById(gC("chPlayerCharacter").weaponID).type == equipmentType.STAFFOFBATTLE ) {
		pWeapon = "staff";
	} else {
		pWeapon = "other";
	}
	State.variables.StVars.check1 = pWeapon;
	// Placeholder variables
	State.variables.StVars.check2 = "";
	State.variables.StVars.check3 = "";
	// Checks
	State.variables.StVars.check4 = gCstat("chPlayerCharacter","resilience") * 1.3 + gCstat("chPlayerCharacter","physique");
	State.variables.StVars.check5 = gCstat("chPlayerCharacter","physique") * 1 + gCstat("chPlayerCharacter","agility") * 1.3 + gCstat("chPlayerCharacter","perception") * 1.3;
	State.variables.StVars.check6 = gCstat("chPlayerCharacter","agility") * 1.1 + gCstat("chPlayerCharacter","perception");
	State.variables.StVars.check7 = gCstat("chPlayerCharacter","agility") * 1 + gCstat("chPlayerCharacter","physique") * 1.1;
	
	State.variables.chNash.energy.current -= 10;
	State.variables.chNash.combatAffinities.weapon.strength += 5;
}

window.initializeShunnedByHerOwn = function() {
	setPasChars([getPresentCharByKey("chNash"),getPresentCharByKey("chMir")]);
	setRoomIntro("mapTrainingGrounds","amphitheater");
	
	// Affinities towards player, Nash's Player vs Mir, Mir's Player vs Nash
	State.variables.StVars.check1 = rLvlAbt("chNash","chPlayerCharacter","romance") * 2 + rLvlAbt("chNash","chPlayerCharacter","friendship") + rLvlAbt("chNash","chPlayerCharacter","sexualTension") - rLvlAbt("chNash","chPlayerCharacter","enmity") * 2 - rLvlAbt("chNash","chMir","romance") * 2 - rLvlAbt("chNash","chMir","friendship") - rLvlAbt("chNash","chMir","sexualTension") + rLvlAbt("chNash","chMir","enmity");
	State.variables.StVars.check2 = rLvlAbt("chMir","chPlayerCharacter","romance") * 2 + rLvlAbt("chMir","chPlayerCharacter","friendship") + rLvlAbt("chMir","chPlayerCharacter","sexualTension") - rLvlAbt("chMir","chPlayerCharacter","enmity") * 2 - rLvlAbt("chMir","chNash","romance") * 2 - rLvlAbt("chMir","chNash","friendship") - rLvlAbt("chMir","chNash","sexualTension") + rLvlAbt("chMir","chNash","enmity");
	
	// Affinities towards Valtan
	State.variables.StVars.check3 = rLvlAbt("chNash","chVal","friendship") * 2 + rLvlAbt("chNash","chVal","romance") - rLvlAbt("chNash","chVal","enmity") * 2 + getCharsDrive("chNash","dLove") - getCharsDrive("chNash","dDomination"); // Positive: Nash supports Valtan's love
	State.variables.StVars.check4 = rLvlAbt("chClaw","chVal","friendship") * 1 + rLvlAbt("chClaw","chVal","romance") - rLvlAbt("chClaw","chVal","rivalry") - rLvlAbt("chClaw","chVal","enmity") * 2 - getCharsDrive("chClaw","dDomination") + getCharsDrive("chClaw","dCooperation") - getCharsDrive("chClaw","dAmbition") + getCharsDrive("chClaw","dLove"); // Negative: Claw supports Valtan getting excluded
	State.variables.StVars.check5 = 2 + rLvlAbt("chMir","chVal","friendship") - rLvlAbt("chMir","chVal","enmity") + getCharsDrive("chVal","dLove") - getCharsDrive("chVal","dPleasure"); // Trusts Valtan's love to be sincere
	
	State.variables.StVars.check6 = (gCstat("chPlayerCharacter","charisma") + gCstat("chPlayerCharacter","empathy") + gCstat("chPlayerCharacter","luck") * 0.5) * 0.1 // Player's conversation influence
	
	for ( var cK of ["chNash","chMir","chClaw","chAte"] ) {
		gC(cK).supsValLove = 0;
		gC(cK).supsValPardon = 0;
	}
	gC("chNash").supsValLove += rLvlAbt("chNash","chVal","friendship") * 2 + rLvlAbt("chNash","chVal","romance") - rLvlAbt("chNash","chVal","enmity") * 2 + getCharsDrive("chNash","dLove") - getCharsDrive("chNash","dDomination") - getCharsDrive("chVal","dPleasure");
	gC("chNash").supsValPardon += rLvlAbt("chNash","chVal","friendship") * 2 + rLvlAbt("chNash","chVal","romance") * 2 - rLvlAbt("chNash","chVal","enmity") * 2 + getCharsDrive("chNash","dCooperation") - getCharsDrive("chNash","dDomination") -  getCharsDrive("chNash","dAmbition") - getCharsDrive("chVal","dPleasure");
	gC("chClaw").supsValPardon += rLvlAbt("chClaw","chVal","friendship") * 1 + rLvlAbt("chClaw","chVal","romance") - rLvlAbt("chClaw","chVal","rivalry") - rLvlAbt("chClaw","chVal","enmity") * 2 - getCharsDrive("chClaw","dDomination") + getCharsDrive("chClaw","dCooperation") - getCharsDrive("chClaw","dAmbition") + getCharsDrive("chClaw","dLove");
	gC("chClaw").supsValLove += rLvlAbt("chClaw","chVal","friendship") * 2 + rLvlAbt("chClaw","chVal","romance") - rLvlAbt("chClaw","chVal","enmity") * 2 - getCharsDrive("chClaw","dDomination") + getCharsDrive("chClaw","dCooperation") + getCharsDrive("chClaw","dLove") - 3;
	gC("chMir").supsValLove += rLvlAbt("chMir","chVal","friendship") - rLvlAbt("chMir","chVal","enmity") + getCharsDrive("chVal","dLove") - getCharsDrive("chVal","dPleasure") + getCharsDrive("chMir","dLove") - getCharsDrive("chVal","dPleasure");
	gC("chMir").supsValPardon += rLvlAbt("chMir","chVal","friendship") - rLvlAbt("chMir","chVal","enmity") + getCharsDrive("chVal","dLove") - getCharsDrive("chVal","dPleasure") + getCharsDrive("chMir","dLove") + getCharsDrive("chMir","dCooperation") +  + getCharsDrive("chMir","dAmbition") - getCharsDrive("chVal","dPleasure");
	gC("chAte").supsValLove += rLvlAbt("chAte","chVal","friendship") + rLvlAbt("chAte","chVal","romance") - rLvlAbt("chAte","chVal","enmity") + getCharsDrive("chAte","dLove") + getCharsDrive("chAte","dCooperation") + (- getCharsDrive("chAte","dImprovement") - getCharsDrive("chAte","dAmbition")) * 0.5 - getCharsDrive("chVal","dPleasure");
	gC("chAte").supsValPardon += rLvlAbt("chAte","chVal","friendship") + rLvlAbt("chAte","chVal","romance") - rLvlAbt("chAte","chVal","enmity") + getCharsDrive("chAte","dLove") + getCharsDrive("chAte","dCooperation") + getCharsDrive("chAte","dAmbition") - getCharsDrive("chAte","dDomination") - getCharsDrive("chVal","dPleasure");
	
	for ( var cK of ["chPlayerCharacter","chNash","chMir","chClaw"] ) {
		gC(cK).charisma.experience += 500;
		gC(cK).empathy.experience += 500;
	}
	gC("chAte").charisma.experience += 500;
	gC("chAte").empathy.experience += 500;
	gC("chVal").will.experience += 1000;
}

window.initializeSeFaK = function() {
	charactersLearnSceneActions(["chClaw","chMir"],["giveBlowjob","giveCunnilingus","getBlowjob","legHoldHead","suckDick","lickPussy","fuckFace","rideFace"]);
	State.variables.StVars.check1 = [false,false,false,false,false]; // Used harassment options ; show skin, masturbate, eat out, moan, exhibitionism
	State.variables.StVars.check2 = 0; // Padmiri hot and bothered score
	State.variables.StVars.check3 = 0; // Padmiri submission score
	State.variables.StVars.check4 = [false,false,false]; // Player has free collar, chastity belt, chastity cage
	
	for ( var eq of State.variables.equipmentList ) {
		if ( eq.owner == "chPlayerCharacter" && eq.equippedOn == null ) {
			if ( eq.type == "b0" ) {
				if ( gC("chMir").hasFreeBodypart("neck") ) {
					State.variables.StVars.check4[0] = eq.id;
				}
			} else if ( eq.type == "b7" ) {
				if ( gC("chMir").hasFreeBodypart("pussy") ) {
					State.variables.StVars.check4[1] = eq.id;
				}
			} else if ( eq.type == "b8" ) {
				if ( gC("chMir").hasFreeBodypart("dick") ) {
					State.variables.StVars.check4[2] = eq.id;
				}
			}
		}
	}
	
	setPasChars([getPresentCharByKey("chClaw"),getPresentCharByKey("chMir")]);
	setRoomIntro("mapTrainingGrounds","westLibrary");
}
window.seFaKpadmiriBotheredScore = function() {
	State.variables.StVars.check2 = 0;
	var bars = getBarPercentage("chMir","lust") + getBarPercentage("chMir","willpower");
	if ( bars <= 1.4 ) {
		State.variables.StVars.check2 = 3;
	} else if ( bars <= 1.6 ) {
		State.variables.StVars.check2 = 2;
	} else if ( bars <= 1.8 ) {
		State.variables.StVars.check2 = 1;
	}
}
window.seFaKupdatePadmiriSubmissionScore = function() {
	State.variables.StVars.check3 = State.variables.StVars.check2 * 3 + rLvlAbt("chMir","chPlayerCharacter","sexualTension") + rLvlAbt("chMir","chPlayerCharacter","submission") + rLvlAbt("chMir","chClaw","sexualTension") - rLvlAbt("chMir","chPlayerCharacter","enmity") + gC("chMir").dPleasure.level;
}

window.initializeBondageAwakening = function() {
	//setPasChars([getPresentCharByKey("chMir"),getPresentCharByKey("chClaw"),getPresentCharByKey("chNash")]);
	setPasChars([]);
	setRoomIntro("mapTrainingGrounds","lake");
	State.variables.StVars.check1 = getCharsDrive("chMir","dDomination") * 2 + getCharsDrive("chMir","dAmbition") + getCharsDrive("chMir","dPleasure") - getCharsDrive("chMir","dCooperation") - getCharsDrive("chMir","dLove"); // Padmiri's aggressiveness
	State.variables.StVars.check2 = false; // Player has chains
	State.variables.StVars.check3 = gCstat("chPlayerCharacter","intelligence") * 2 + gCstat("chPlayerCharacter","will") * 2 + gCstat("chPlayerCharacter","luck"); // Chains attack check
	State.variables.StVars.check4 = false; // Player has hypnosis
	State.variables.StVars.check5 = (gCstat("chPlayerCharacter","charisma") * 2 + gCstat("chPlayerCharacter","will")) * 0.2 + rLvlAbt("chMir","chPlayerCharacter","submission"); // Hypnosis attack check
	State.variables.StVars.check6 = getCharsDrive("chMir","dPleasure") + rLvlAbt("chMir","chNash","sexualTension") + rLvlAbt("chMir","chClaw","sexualTension");
	State.variables.StVars.check7 = getCharsDrive("chMir","dPleasure") + rLvlAbt("chMir","chNash","sexualTension") + rLvlAbt("chMir","chClaw","sexualTension") + rLvlAbt("chMir","chPlayerCharacter","sexualTension");
	State.variables.StVars.check8 = [false,false,false,false]; // Tried actions: Complained to Mir, Asked Mir, Confronted them, Suggest to leave
	State.variables.StVars.check9 = rLvlAbt("chMir","chPlayerCharacter","submission") * 2 + rLvlAbt("chMir","chPlayerCharacter","friendship") + rLvlAbt("chMir","chPlayerCharacter","friendship") - rLvlAbt("chMir","chPlayerCharacter","enmity") * 2; // Order Padmiri check
	State.variables.StVars.check10 = rLvlAbt("chMir","chPlayerCharacter","domination") * 2 + rLvlAbt("chMir","chPlayerCharacter","romance") + rLvlAbt("chMir","chPlayerCharacter","romance") - rLvlAbt("chMir","chPlayerCharacter","enmity") * 2; // Beg Padmiri check
	
	if ( gC("chPlayerCharacter").saList.includes("baEtherealChains") ) {
		State.variables.StVars.check2 = true;
	}
	if ( gC("chPlayerCharacter").saList.includes("baHypnoticGlance") ) {
		State.variables.StVars.check4 = true;
	}
	
	gC("chNash").relations.chClaw.enmity.stv += 250;
	gC("chNash").relations.chClaw.rivalry.stv += 250;
	gC("chClaw").relations.chNash.enmity.stv += 250;
	gC("chClaw").relations.chNash.rivalry.stv += 250;
}

///// Adventures /////

window.initGleamingCavernsSecondDay = function() {
	setPasChars([]);
	setRoomIntro("mapGleamingCaverns","templeStorage");
	
	gC("chGoddessHerald").name = "Varyonte";
	gC("chGoddessHerald").formattedName = '<span style="color:'+gC("chGoddessHerald").nameColor+'">'+gC("chGoddessHerald").name+'</span>';
	gC("chGoddessHerald").names = [ gC("chGoddessHerald").getName() , gC("chGoddessHerald").getName() , gC("chGoddessHerald").getName() ];
}

window.initGleamingCavernsDayPlaceholder = function() {
	
}




//////// EVENTS CALENDAR ////////
// This class saves routines to determine which story events will be shown and when

// Ctrl + f: ECtag to find the actual events calendar.

window.EventsCalendar = function() {
	
	// This must be set to true when any event starts. It must be set to false when any event ends.
	// This must be considered on general-functions' refreshUIbars()
	this.activeEvent = false;
	
	// New day standards
	this.newDayLinkMessage = "Continue";
	this.newDayPassage = "Map";
	this.finishEventButton = "";
	
	this.playedStoryEvents = [];
}
	
	EventsCalendar.prototype.getEndDayButton = function() {
		// This gets called at the end of the day in resting rooms.
		// This function should be edited by stablishTomorrowsEvent() regularly
		return this.getStandardNewDayButton();
	}
	EventsCalendar.prototype.customEventScript = function() {
		// This function should be edited by stablishTomorrowsEvent() regularly
		return 0;
	}
	
	EventsCalendar.prototype.newDayScript = function() { 
		State.variables.personalRoom.initializeNewDay();
	}
	
	EventsCalendar.prototype.getStandardNewDayButton = function() {
		var bText = "<<l" + "ink [[" + this.newDayLinkMessage + "|" + this.newDayPassage + "]]>><<s" + "cript>>\n"
				  + "State.variables.eventsCalendar.newDayScript();\n"
				  + "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}	
	EventsCalendar.prototype.getNewDayButtonCustomMessage = function(message) {
		var bText = "<<l" + "ink [[" + message + "|" + this.newDayPassage + "]]>><<s" + "cript>>\n"
				  + "State.variables.eventsCalendar.getStandardNewDayButton();\n"
				  + "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
	// Events
							// STABLISH TOMORROW'S EVENT
	EventsCalendar.prototype.stablishTomorrowsEvent = function() {
		
		// Standard new day functions: if they aren't edited later in this function, they retain their usual behavior
		this.getEndDayButton = function() {
			return this.getStandardNewDayButton();
		}
		this.customEventScript = blankFunction;
		
		// Main switch
		// ECtag
		switch (State.variables.daycycle.month) {
			case 1:
				switch (State.variables.daycycle.day) {
					case 1:
						this.customEventScript = initializeSeMagicClass;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE Magic Class Start");
						}
						break;
					case 2:
						this.customEventScript = initializeSeStretchingHelp;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE Stretching Help Start");
						}
						break;
					case 3:
						this.customEventScript = initializeSeHumming;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE Humming Start");
						}
						break;
					case 4:
						this.customEventScript = initializeSeEthicsOfPower;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE EthicsOfPow Start");
						}
						break;
					case 5:
						this.customEventScript = initializeSeStayingHydrated;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE Staying Hydrated Start");
						}
						break;
					case 6:
						this.customEventScript = initializeSeFriendBackAtHome;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE Friend Back At Home Start");
						}
						break;
					case 7:
						this.customEventScript = initializeSeStretchingHelpII;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE Stretching Help II Nash Meets Claw");
						}
						break;
					case 8:
						this.customEventScript = initializeSeFlirtingAdvice;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE Flirting Advice Start");
						}
						break;
					case 9:
						this.customEventScript = initializeSeDrishtyaTutorShip;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE Drishtya Tutorship I Start");
						}
						break;
					case 10:
						this.customEventScript = initializeSeTheMerchants;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE The Merchants Start");
						}
						break;
					case 11:
						this.customEventScript = initializeSeBeatingKittyIntoFriendship;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE Beating Kitty Into Friendship Start");
						}
						break;
					case 12:
						this.customEventScript = initializeSeBkifOutcome;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE BKIF Outcome Start");
						}
						break;
					case 18:
						this.customEventScript = initializeGleamingCavernsOverview;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE Gleaming Caverns Overview Start");
						}
						break;
					case 21:
						this.customEventScript = initializeShunnedByHerOwn;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("SE ShunnedByHerOwn Start");
						}
						break;
					case 25:
						this.customEventScript = initializeGleamingCavernsAdventure;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("FA ReachedTheSwamp Start");
						}
						break;
					case 28:
						this.customEventScript = initGleamingCavernsSecondDay;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("FA VaryontesOffer1");
						}
						break;
					case 29:
						this.customEventScript = initGleamingCavernsDayPlaceholder;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("FA 0.3.3 Placeholder Story Event");
						}
						break;
					case 30:
						this.customEventScript = initGleamingCavernsDayPlaceholder;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("FA 0.3.3 Placeholder Story Event");
						}
						break;
				}
				break;
			case 2:
				switch (State.variables.daycycle.day) {
					case 1:
						this.customEventScript = initGleamingCavernsDayPlaceholder;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("FA 0.3.3 Placeholder Story Event");
						}
						break;
					case 2:
						this.customEventScript = initGleamingCavernsDayPlaceholder;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("FA 0.3.3 Placeholder Story Event");
						}
						break;
					case 3:
						this.customEventScript = finishGleamingCavernsAdventure;
						this.getEndDayButton = function() {
							return this.getButtonToEvent("FA 0.3.3 Placeholder Story Event");
						}
						break;
				}
		}
		
		if ( this.customEventScript == blankFunction ) {
			// Attempt to initiate random event
			var selectedEvent = chooseRandomStoryEvent();
			
			if ( selectedEvent != "errorWList" ) {
				this.getEndDayButton = function() {
					return this.getButtonToEvent(setup.eventsMetaInfo[selectedEvent].initialPassage);
				}
				this.customEventScript = setup.eventsMetaInfo[selectedEvent].initializeFunction;
				State.variables.eventsCalendar.playedStoryEvents.push(selectedEvent);
			}
		}
	}
	window.blankFunction = function() {
		return 0;
	}
	
	EventsCalendar.prototype.getButtonToEvent = function(firstEventPassageName) {
		var bText = "<<l" + "ink [[" + this.newDayLinkMessage + "|" + firstEventPassageName + "]]>><<s" + "cript>>\n"
				  + "State.variables.eventsCalendar.activeEvent = true;\n"
				  + "State.variables.eventsCalendar.newDayScript();\n"
				  + "State.variables.eventsCalendar.customEventScript();\n"
				  + "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
	EventsCalendar.prototype.setFinishEventButton = function(message,script) {
		this.finishEventButton = this.getNewDayButtonCustomMessageCustomScript(message,script);
	}
	EventsCalendar.prototype.getNewDayButtonCustomMessageCustomScript = function(message,script) {
		var bText = "<<l" + "ink [[" + message + "|" + this.newDayPassage + "]]>><<s" + "cript>>\n"
				  + "State.variables.eventsCalendar.activeEvent = false;\n"
				  + script
				  + "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	EventsCalendar.prototype.cleanUIscriptText = function() {
		var sText = 'setNoPasChars();\n'
	}

State.variables.eventsCalendar = new EventsCalendar();
State.variables.eventsCalendar.setFinishEventButton("Continue","setNoPasChars()");

// Constructors, serializers, etc.
EventsCalendar.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
EventsCalendar.prototype.clone = function () {
	return (new EventsCalendar())._init(this);
};
EventsCalendar.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new EventsCalendar())._init($ReviveData$)', ownData);
};


//////// STORY EVENT META INFO ////////
// These objects contain relevant information for story events, to be used by events calendar to dynamically select events

window.eventMetaInfo = function(name,key,initializeFunction,initialPassage,checkRequirements,getWeight) {
	this.name = name;
	this.key = key;
	this.initializeFunction = initializeFunction;
	this.initialPassage = initialPassage;
	this.checkRequirements = checkRequirements;
	this.getWeight = getWeight;
}

setup.eventsMetaInfo = [];
setup.eventsMetaInfo["atc0"] = new eventMetaInfo(
	"Aspiring Tree Climber",
	"atc0",
	initializeSeAspiringTreeClimber, // initFunc
	"SE Aspiring TC Start",
	function() { // Reqs
		var allowed = true;
		if ( gC("chPlayerCharacter").body.hasOwnProperty("arms") && gC("chPlayerCharacter").body.hasOwnProperty("legs") ) {
			if ( gC("chPlayerCharacter").body.arms.state != "free" || gC("chPlayerCharacter").body.legs.state != "free" ) {
				allowed = false;
			}
		} else {
			allowed = false;
		}
		if ( gC("chClaw").body.hasOwnProperty("arms") && gC("chClaw").body.hasOwnProperty("legs") ) {
			if ( gC("chClaw").body.arms.state != "free" || gC("chClaw").body.legs.state != "free" ) {
				allowed = false;
			}
		} else {
			allowed = false;
		}
		return allowed;
	},
	function() { // Weight
		var weight = 120;
		return weight;
	}
);
setup.eventsMetaInfo["lm0"] = new eventMetaInfo(
	"Luring Masquerade",
	"lm0",
	initializeSeLuringMasquerade, // initFunc
	"Luring Masquerade Start",
	function() { // Reqs
		var allowed = true;
		if ( gC("chVal").body.hasOwnProperty("legs") && gC("chPlayerCharacter").body.hasOwnProperty("legs") ) {
			if ( gC("chVal").body.legs.state != "free" || gC("chPlayerCharacter").body.legs.state != "free" ) {
				allowed = false;
			}
		} else {
			allowed = false;
		}
		if ( allowed ) {
			if ( gC("chPlayerCharacter").subChars.includes("chVal") || gC("chPlayerCharacter").subChars.includes("chMir") ) {
				allowed = false;
			} else if ( gC("chVal").subChars.includes("chPlayerCharacter") || gC("chVal").subChars.includes("chMir") ) {
				allowed = false;
			} else if ( gC("chMir").subChars.includes("chVal") || gC("chMir").subChars.includes("chPlayerCharacter") ) {
				allowed = false;
			} 
		}
		if ( allowed ) {
			if ( gC("chVal").egaChars.includes("chPlayerCharacter") || gC("chVal").egaChars.includes("chMir") ) {
				allowed = false;
			}
		}
		return allowed;
	},
	function() { // Weight
		var weight = 70;
		weight += rLvlAbt("chVal","chPlayerCharacter","sexualTension") * 3 + rLvlAbt("chVal","chPlayerCharacter","rivalry") * 3 + rLvlAbt("chVal","chMir","sexualTension") * 3 + rLvlAbt("chVal","chMir","rivalry") * 3;
		return weight;
	}
);
setup.eventsMetaInfo["gfn0"] = new eventMetaInfo(
	"Gifts For Nature",
	"gfn0",
	initializeSeGiftsForNature, // initFunc
	"SE Gifts For Nature Start",
	function() { // Reqs
		var allowed = true;
		
		return allowed;
	},
	function() { // Weight
		var weight = 100;
		return weight;
	}
);
setup.eventsMetaInfo["dto0"] = new eventMetaInfo(
	"Discovering The Others",
	"dto0",
	initializeSeDiscoveringTheOthers, // initFunc
	"SE Discovering The Others Start",
	function() { // Reqs
		var allowed = true;
		
		return allowed;
	},
	function() { // Weight
		var weight = 70;
		weight += rLvlAbt("chAte","chPlayerCharacter","friendship") * 5 + rLvlAbt("chAte","chPlayerCharacter","romance") * 5 - rLvlAbt("chAte","chPlayerCharacter","rivalry") * 2 - rLvlAbt("chAte","chPlayerCharacter","enmity") * 5;
		return weight;
	}
);
setup.eventsMetaInfo["gol0"] = new eventMetaInfo(
	"The Grapes of Lust",
	"gol0",
	initializeSeTGoL, // initFunc
	"SE TGoL Start",
	function() { // Reqs
		var allowed = true;
		
		if ( gC("chVal").domChar == "chPlayerCharacter" || gC("chVal").domChar == "chAte" || gC("chPlayerCharacter").domChar == "chVal" || gC("chAte").domChar == "chVal" || gC("chAte").domChar == "chPlayerCharacter" || (gC("chVal").hasFreeBodypart("pussy") == false) || (gC("chPlayerCharacter").hasFreeBodypart("mouth") == false) || (gC("chAte").hasFreeBodypart("mouth") == false) ) {
			allowed = false;
		}
		
		return allowed;
	},
	function() { // Weight
		var weight = 65;
		weight += gC("chAte").dImprovement.level * 5;
		return weight;
	}
);
setup.eventsMetaInfo["mt1"] = new eventMetaInfo(
	"Martial Tutorship I",
	"mt1",
	initializeMartialTutorshipI, // initFunc
	"SE MartialTutorshipI Start",
	function() { // Reqs
		var allowed = false;
		
		if ( gC("chPlayerCharacter").domChar == "chNash" ) {
			if ( gRelTypeAb("chPlayerCharacter","chNash").type == "tutorship" ) {
				if ( gC("chNash").hasFreeBodypart("arms") && gC("chNash").hasFreeBodypart("legs") ) {
					if ( ( gC("chPlayerCharacter").hasFreeBodypart("arms") || getEquipById(gC("chPlayerCharacter").body.arms.bondage).owner == "chNash" ) && ( gC("chPlayerCharacter").hasFreeBodypart("legs") || getEquipById(gC("chPlayerCharacter").body.legs.bondage).owner == "chNash" ) ) {
						allowed = true;
					}
				}
			}
		}
		
		return allowed;
	},
	function() { // Weight
		var weight = 300;
		return weight;
	}
);
setup.eventsMetaInfo["fak0"] = new eventMetaInfo(
	"Flaunting A Kitty",
	"fak0",
	initializeSeFaK, // initFunc
	"SE FAK Start",
	function() { // Reqs
		var allowed = false;
		
		if ( gC("chClaw").domChar == "chPlayerCharacter" && gC("chMir").domChar == null ) {
			if ( gCstat("chPlayerCharacter","charisma") >= 12 ) {
				if ( gC("chMir").hasFreeBodypart("pussy") && gC("chClaw").hasFreeBodypart("mouth") ) {
					allowed = true;
				}
			}
		}
		
		return allowed;
	},
	function() { // Weight
		var weight = 100;
		weight += (rLvlAbt("chMir","chPlayerCharacter","sexualTension") + rLvlAbt("chMir","chClaw","sexualTension") + rLvlAbt("chMir","chPlayerCharacter","submission")) * 10 + (gC("chMir").dPleasure.level * 10);
		return weight;
	}
);
setup.eventsMetaInfo["BAw0"] = new eventMetaInfo(
	"Bondage Awakening",
	"BAw0",
	initializeBondageAwakening, // initFunc
	"SE BoAw Start",
	function() { // Reqs
		var allowed = false;
		
		if ( gC("chClaw").domChar != "chNash" && gC("chClaw").domChar != "chPlayerCharacter" && gC("chClaw").domChar != "chMir" ) {
			if ( gC("chNash").domChar != "chClaw" && gC("chNash").domChar != "chMir" && gC("chNash").domChar != "chPlayerCharacter" ) {
				if ( gC("chMir").domChar != "chPlayerCharacter" && gC("chMir").domChar != "chNash" && gC("chMir").domChar != "chClaw" ) {
					if ( gC("chPlayerCharacter").domChar != "chNash" && gC("chPlayerCharacter").domChar != "chMir" && gC("chPlayerCharacter").domChar != "chClaw" ) {
						if ( gC("chNash").hasFreeBodypart("arms") && gC("chNash").hasFreeBodypart("legs") && gC("chClaw").hasFreeBodypart("arms") && gC("chClaw").hasFreeBodypart("legs") && gC("chMir").hasFreeBodypart("arms") && gC("chPlayerCharacter").hasFreeBodypart("arms") ) {
							allowed = true;
						}
					}
				}
			}
		}
		
		return allowed;
	},
	function() { // Weight
		var weight = 50;
		weight += rLvlAbt("chNash","chClaw","enmity") * 5 + rLvlAbt("chNash","chClaw","rivalry") * 3 + rLvlAbt("chClaw","chNash","enmity") * 5 + rLvlAbt("chClaw","chNash","rivalry") * 3 - rLvlAbt("chNash","chClaw","friendship") - rLvlAbt("chClaw","chNash","friendship") - rLvlAbt("chNash","chClaw","romance") - rLvlAbt("chClaw","chNash","romance");
		return weight;
	}
);

window.chooseRandomStoryEvent = function() {
	var result = "errorWList"; // Default error string returned by bugged weighted lists. If this is the end result, no event will be initialized
	var validEvents = []; // Event tags
	for ( var se in setup.eventsMetaInfo ) {
		if ( setup.eventsMetaInfo[se] instanceof eventMetaInfo ) { // Is an event
			if ( State.variables.eventsCalendar.playedStoryEvents.includes(setup.eventsMetaInfo[se].key) == false ) { // Event hasn't been played
				if ( setup.eventsMetaInfo[se].checkRequirements() ) { // Requirements are passed
					validEvents.push(setup.eventsMetaInfo[se].key);
				}
			}
		}
	}
	
	if ( validEvents.length > 0 ) {
		var wL = new weightedList();
		var i = 0;
		for ( var se of validEvents ) {
			wL[i] = new weightedElement(se,setup.eventsMetaInfo[se].getWeight());
			i++;
		}
		
		result = randomFromWeightedList(wL);
	}
	
	return result;
}

window.gEMI = function(eventFlag) {
	return setup.eventsMetaInfo[eventFlag];
}






////////// SIS Specifics  //////////

// Short set of data containing controls info
window.SisSpecifics = function() {
	this.playerTarget = "";
	
	this.passageText = "";
	this.resultsText = "";
	this.targetText = "";
	this.choicesText = "";
	this.exitsText = "";
	
	this.flagSissEnd = false;
	this.continueButton = "";

}

		// UI
	SisSpecifics.prototype.formatPassageText = function() {
		if ( this.flagSissEnd == false && State.variables.sisPlayerInfo.flagRejectedSis != true ) {		// Normal behavior
			this.formatTargetsText();
			this.formatChoicesText();
			this.formatExitsText();
			
			this.passageText = "";
			if ( this.resultsText != "" ) {
				this.passageText += this.resultsText + "\n\n";
				this.resultsText = "";
			}
			
			this.passageText += this.targetText + "\n\n";
			this.passageText += this.choicesText + "\n";
			this.passageText += this.exitsText;
		}
		else if ( State.variables.sisPlayerInfo.flagRejectedSis ) { // Interactions were rejected
			this.passageText = State.variables.sisPlayerInfo.rejectedSisPassage;
		}
		else {								// Proposal accepted. Siss ends and a button is offered to do so
			this.passageText = "";
			if ( this.resultsText != "" ) {
				this.passageText += this.resultsText + "\n\n";
				this.resultsText = "";
			}
			this.passageText += this.continueButton;
		}
	}
	SisSpecifics.prototype.formatTargetsText = function() {
		this.targetText = "__Discussing with " + gC(this.playerTarget).formattedName + "__:\n"
					    + "Favor owed: " + State.variables.chPlayerCharacter.relations[this.playerTarget].favor;
	}
	
	SisSpecifics.prototype.formatChoicesText = function() {
		this.choicesText = "";
		var i = 0;
		for ( var sT of setup.sistTypes ) {
			var sist = setup.sistDB[sT];
			var extraPars = sist.recursiveSelfSummon("chPlayerCharacter",this.playerTarget);
			if ( extraPars == null ) {
				if ( sist.isPossible("chPlayerCharacter",this.playerTarget) ) {
					this.choicesText += this.getButtonTopicChoice(sist,("setup.sistDB['" + sT + "']")) + sist.subtitle + "\n";
				}
			} else if ( extraPars.length >= 1 ) {
				for ( var par of extraPars ) {
					if ( sist.isPossible("chPlayerCharacter",this.playerTarget,par) ) {
						this.choicesText += this.getButtonTopicChoiceExtraPar(sist,("setup.sistDB['" + sT + "']"),par) + sist.subtitle + "\n";
					}
				}
			}
		}
		/*
		for ( var sist of setup.sistDB ) {
			if ( sist.isPossible("chPlayerCharacter",this.playerTarget) ) {
				this.choicesText += this.getButtonTopicChoice(sist,("setup.sistDB[" + i + "]")) + sist.subtitle + "\n";
			}
			i++;
		}
		*/
	}
	SisSpecifics.prototype.getButtonTopicChoice = function(sisTopic,sisTopicCaller) {
		var bText = "";
		var socialdriveCost = sisTopic.getSocialdriveOfferCost("chPlayerCharacter",this.playerTarget);
		if ( gC("chPlayerCharacter").socialdrive.current >= socialdriveCost ) {
			bText = "<<l" + "ink [[" + sisTopic.title + "|Social Interactions Specifics]]>><<s" + "cript>>";
			bText 	 += "State.variables.sisSpecifics.processTopicResult('chPlayerCharacter','" + this.playerTarget + "'," + sisTopicCaller + ");\n";
			bText	 += "<</s" + "cript>><</l" + "ink>> (Cost: " + colorText(socialdriveCost,"khaki") + ") ";
		} else {
			bText = colorText("Locked (not enough social drive): ","firebrick") + sisTopic.title;
		}
		return bText;
	}
	SisSpecifics.prototype.getButtonTopicChoiceExtraPar = function(sisTopic,sisTopicCaller,extraPar) {
		var bText = "";
		var socialdriveCost = sisTopic.getSocialdriveOfferCost("chPlayerCharacter",this.playerTarget);
		if ( gC("chPlayerCharacter").socialdrive.current >= socialdriveCost ) {
			bText = "<<l" + "ink [[" + sisTopic.getTitle(extraPar) + "|Social Interactions Specifics]]>><<s" + "cript>>";
			bText 	 += "State.variables.sisSpecifics.processTopicResultExtraPar('chPlayerCharacter','" + this.playerTarget + "'," + sisTopicCaller + ",'" + extraPar + "');\n";
			bText	 += "<</s" + "cript>><</l" + "ink>> (Cost: " + colorText(socialdriveCost,"khaki") + ") ";
		} else {
			bText = colorText("Locked (not enough social drive): ","firebrick") + sisTopic.getTitle(extraPar);
		}
		return bText;
	}
	
	SisSpecifics.prototype.formatExitsText = function() {
		var bText = "<<l" + "ink [[Back to interactions|Social Interactions]]>><<s" + "cript>>\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>\n";
		bText	 += "<<l" + "ink [[Leave conversation|Map]]>><<s" + "cript>>\n";
		bText 	 += "State.variables.compass.sisList[State.variables.compass.pcSis].charsLeaveSis(getCharGroup('chPlayerCharacter'));\n";
		bText	 += "State.variables.sisSpecifics.playerTarget = State.variables.sisPlayerInfo.currentTarget;\n";
		bText 	 += "<</s" + "cript>><</l" + "ink>>";
		this.exitsText = bText;
	}

		// Logic
	SisSpecifics.prototype.processTopicResult = function(actor,target,sisTopic) {
		// This gets executed when the player executes a sist. For npcs, check executeStandardSistEffects()
		var resultsText = "";
		var rejectionCostText = "";
		// Apply social drive cost
		gC(actor).socialdrive.changeValue(-sisTopic.getSocialdriveOfferCost(actor,target));
		// Check if successful
		var desire = sisTopic.getDesire(actor,target);
		var isSuccessful = sisTopic.isSuccessful(actor,target);
		var willpowerRejectCost = sisTopic.getWillpowerRejectCost(actor,target);
		var effect = 0;
		if ( isSuccessful[0] == true ) { // Offer accepted
			resultsText = sisTopic.getSuccessMessage(actor,target);
			effect = sisTopic.getSuccessEffect(actor,target);
		}
		else if ( willpowerRejectCost > gC(target).willpower.current ) { // Forced to accept offer due to lack of willpower
			resultsText = "Not enough " + colorText("willpower","darkslateblue"); + " to reject! " + gC(target).getFormattedName() + " resented that. " + sisTopic.getSuccessMessage(actor,target);
			gC(target).relations[actor].enmity.stv += 10;
			gC(target).relations[actor].rivalry.stv += 10;
			effect = sisTopic.getSuccessEffect(actor,target);
		}
		else { // Rejects offer, may take willpower damage
			resultsText = sisTopic.getFailMessage(actor,target);
			effect = sisTopic.getFailEffect(actor,target);
			// Willpower rejecting cost
			gC(target).willpower.current -= willpowerRejectCost;
			if ( willpowerRejectCost > 0 ) {
				rejectionCostText = "\n" + gC(target).getFormattedName() + " spent " + colorText((willpowerRejectCost.toFixed(2) + " willpower "),"darkslateblue") + "to reject the offer.";
			}
		}
		resultsText += "\n" + desire[1] + "\n" + isSuccessful[1] + rejectionCostText; // isSuccessful[1] returns a string detailing why that was the result
		this.resultsText += resultsText;
	}
	SisSpecifics.prototype.processTopicResultExtraPar = function(actor,target,sisTopic,extraPar) {
		// This gets executed when the player executes a sist. For npcs, check executeStandardSistEffects()
		var resultsText = "";
		var rejectionCostText = "";
		// Apply social drive cost
		gC(actor).socialdrive.changeValue(-sisTopic.getSocialdriveOfferCost(actor,target,extraPar));
		// Check if successful
		var desire = sisTopic.getDesire(actor,target,extraPar);
		var isSuccessful = sisTopic.isSuccessful(actor,target,extraPar);
		var willpowerRejectCost = sisTopic.getWillpowerRejectCost(actor,target,extraPar);
		var effect = 0;
		if ( isSuccessful[0] == true ) { // Offer accepted
			resultsText = sisTopic.getSuccessMessage(actor,target,extraPar);
			effect = sisTopic.getSuccessEffect(actor,target,extraPar);
		}
		else if ( willpowerRejectCost > gC(target).willpower.current ) { // Forced to accept offer due to lack of willpower
			resultsText = "Not enough " + colorText("willpower","darkslateblue"); + " to reject! " + gC(target).getFormattedName() + " resented that. " + sisTopic.getSuccessMessage(actor,target,extraPar);
			gC(target).relations[actor].enmity.stv += 10;
			gC(target).relations[actor].rivalry.stv += 10;
			effect = sisTopic.getSuccessEffect(actor,target,extraPar);
		}
		else { // Rejects offer, may take willpower damage
			resultsText = sisTopic.getFailMessage(actor,target,extraPar);
			effect = sisTopic.getFailEffect(actor,target,extraPar);
			// Willpower rejecting cost
			gC(target).willpower.current -= willpowerRejectCost;
			if ( willpowerRejectCost > 0 ) {
				rejectionCostText = "\n" + gC(target).getFormattedName() + " spent " + colorText((willpowerRejectCost.toFixed(2) + " willpower "),"darkslateblue") + "to reject the offer.";
			}
		}
		resultsText += "\n" + desire[1] + "\n" + isSuccessful[1] + rejectionCostText; // isSuccessful[1] returns a string detailing why that was the result
		this.resultsText += resultsText;
	}

		// Management
	SisSpecifics.prototype.cleanSiss = function() {
		this.playerTarget = "";
		this.resultsText = "";
		this.flagSissEnd = false;
		this.continueButton = "";
	}

State.variables.sisSpecifics = new SisSpecifics();

window.getDesireTooltip = function() {
	var tText = '<span title="Desire is the inner temptation of the character to accept a proposal, regardless of their most consciouss rationality. When desire is high enough, the character will be forced to spend willpower in order to reject proposals, and they will only be able to accept if their willpower is low enough.">^^(?)^^</span>';
	return tText;
}

// Constructors, serializers, etc.
SisSpecifics.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
SisSpecifics.prototype.clone = function () {
	return (new SisSpecifics())._init(this);
};
SisSpecifics.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new SisSpecifics())._init($ReviveData$)', ownData);
};

////////// SIS Topics //////////

// Short set of data containing controls info
window.sisTopic = function(title) {
	this.title = title;
	this.subtitle = "";
	this.getTitle = function(extraPar) {
		return this.title;
	}
	
	this.isPossible = function(actor,target) {
		return true;
	}
	
	this.getDesire = function(actor,target) {
		// Returns a 2-elements array. First element is the total desire. Second element is a string detailing desire calculation.
		return [0,"0 desire as default."];
	}
	this.getSocialdriveOfferCost = function(actor,target) {
		return 10;
	}
	this.getWillpowerRejectCost = function(actor,target) {
		var cost = 0;
		var desire = this.getDesire(actor,target)[0];
		if ( desire > 20 ) {
			cost = desire - 20;
		}
		return cost;
	}
	
	this.isSuccessful = function(actor,target) {
		// Returns a 2-elements array. First element is result as true/false. Second element is a string detailing success chances
		return [true,""];
	}
	this.getFailMessage = function(actor,target) {
	}
	this.getFailEffect = function(actor,target) {
	}
	this.getSuccessMessage = function(actor,target) {
	}
	this.getSuccessEffect = function(actor,message) {
	}
	this.askToPlayer = null;
	this.getButtonPlayerAccepts = null;
	
	this.recursiveSelfSummon = function(actor,target) {
		// If returns null, the sisTopic has no recursive self summon
		// If returns a list with more than 0 elements, the topic is repeatedly called with an extra parameter per element in the list
		return null;
	}
}

window.genericSistEffectsPlusPc = function(actors,targets,plusEffects) {
	var allChars = getCharGroup(actors[0]).concat(getCharGroup(targets[0]));
	
	// Clean SISS
	State.variables.sisSpecifics.cleanSiss();
	
	// Clean SIS
	var pcSis = State.variables.compass.pcSis;
	State.variables.compass.sisList[pcSis].charsLeaveSis(allChars);
	
	// Extra effects
	plusEffects(actors,targets);
}
window.genericSistEffects = function(actors,targets) {
	var sisId = State.variables.compass.findFirstSisIdInvolvingCharacter(actors[0]);
	var allChars = actors.concat(targets);
	
	// Chars leave Sis
	State.variables.compass.sisList[sisId].charsLeaveSis(allChars);
	// Notify SIS if Player needs button to leave to scene
	if ( gC(actors[0]).followedBy.includes("chPlayerCharacter") || gC(targets[0]).followedBy.includes("chPlayerCharacter") )  {
		State.variables.compass.sisList[sisId].flagPlayerTakenToScene = true;
	}
}

	// Offer sex
window.createSistEgalitarianSex = function() {
	var sist = new sisTopic("Invite to have sex (Equal terms)");
	sist.sT = setup.sistType.egalitarianSex;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		if ( isLewdingPossible(actor,target) && ( gC(target).type == "candidate" ) && ( State.variables.compass.findFirstSisIdInvolvingCharacter(actor) != -1 ) && ((gC(target).followingTo == "") || (gC(target).followingTo == actor) ) ) {
			if ( getSisCharIsIn(actor).getValidProposedCharacters(actor).includes(target) ) {
				flagPossible = true;
			}
		}
		return flagPossible;
	}
	
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var baseDifficulty = -10;
		var moodFactor = gC(target).mood.flirty * 0.05 + gC(target).mood.aroused * 0.1 - gC(target).mood.angry * 0.3 - gC(target).mood.bored * 0.3
					   +  gC(target).mood.submissive * 0.05 - gC(target).mood.dominant * 0.1;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 4 + rLvlAbt(target,actor,"sexualTension") * 8
							 + rLvlAbt(target,actor,"submission") * 4 + rLvlAbt(target,actor,"domination") * -8
							 + rLvlAbt(target,actor,"enmity") * -8;
		var statsFactor = gCstat(actor,"charisma") - gCstat(target,"will");
		var hadSexFactor = gC(target).daysWithoutSex * 3 - gC(target).sexScenesToday * 3;
		var missingLustFactor = (1 - getBarPercentage(target,"lust")) * 50;
		desire = baseDifficulty + moodFactor + relationshipFactor + statsFactor + missingLustFactor + hadSexFactor;
		var desireString = "Desire" + getDesireTooltip() + ": Base difficulty (" + baseDifficulty.toFixed(2) + ") + Mood (" + moodFactor.toFixed(2) + ") + Relationship ("
						 + relationshipFactor.toFixed(2) + ") + Stats (" + statsFactor.toFixed(2) + ") + Lust (" + missingLustFactor.toFixed(2) + ") + Sex life (" + hadSexFactor.toFixed(2) + ") = Total (" + desire.toFixed(2) + ").";
		
		return [desire,desireString];
	}
	
	sist.doesCharJoinGroup = function(charKey,actor,charList) {
		var result = false;
		var target = charKey;
		var relType = gRelTypeAb(target,actor);
		
		var baseDifficulty = -10; // -10
		var targetMoodFactor = gC(target).mood.flirty * 0.1 + gC(target).mood.intimate * 0.1 + gC(target).mood.aroused * 0.2
							 + gC(target).mood.angry * -0.3 + gC(target).mood.bored * (-0.3) + gC(target).mood.submissive * 0.1
							 + gC(target).mood.dominant * -0.2;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 1 + rLvlAbt(target,actor,"sexualTension") * 2
							 + rLvlAbt(target,actor,"submission") * 2 + rLvlAbt(target,actor,"domination") * -2
							 + rLvlAbt(target,actor,"enmity") * -3 + rLvlAbt(target,actor,"rivalry") * -1;
		var drivesFactor = gC(target).dLove.level * 2 + gC(target).dPleasure.level * 4 - gC(target).dImprovement.level * 3 - gC(target).dDomination.level * 3;
		var powerGrowthFactor = -((quantifyCharacterStats(target) - 110) / 9);
		if ( powerGrowthFactor < 0 ) { powerGrowthFactor = 0; }
		var simulationState = 0;
		if ( State.variables.simCycPar.templeDayPeriod == "training" ) {
			simulationState = -20;
		}
		var missionFactor = 0;
		if ( gC(target).mission == "haveSex" ) { missionFactor += 10; }
		else if ( gC(target).mission == "haveDomSex" ) { missionFactor -= 5; }
		
		var semifinalValue = targetMoodFactor + relationshipFactor + baseDifficulty + simulationState + drivesFactor + missionFactor + powerGrowthFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		
		if ( finalValue >= 0 ) { result = true; }
		
		return result;
	}
	
	sist.isSuccessful = function(actor,target) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		var relType = gRelTypeAb(target,actor);
		
		if ( relType ) {
			if ( relType.forcedToSex ) {
				result = true;
				stringResult = gC(target).getFormattedName() + " is bound by your relationship to accept.";
			}
		}
		if ( result == false ) {
		var baseDifficulty = -10; // -10
		var targetMoodFactor = gC(target).mood.flirty * 0.1 + gC(target).mood.intimate * 0.1 + gC(target).mood.aroused * 0.2
							 + gC(target).mood.angry * -0.3 + gC(target).mood.bored * (-0.3) + gC(target).mood.submissive * 0.1
							 + gC(target).mood.dominant * -0.2;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 1 + rLvlAbt(target,actor,"sexualTension") * 2
							 + rLvlAbt(target,actor,"submission") * 2 + rLvlAbt(target,actor,"domination") * -2
							 + rLvlAbt(target,actor,"enmity") * -3 + rLvlAbt(target,actor,"rivalry") * -1
		var willpowerCostFactor = this.getWillpowerRejectCost(actor,target) / 2;
		var drivesFactor = gC(target).dLove.level * 2 + gC(target).dPleasure.level * 4 - gC(target).dImprovement.level * 3 - gC(target).dDomination.level * 3;
		var powerGrowthFactor = -((quantifyCharacterStats(target) - 110) / 9);
		if ( powerGrowthFactor < 0 ) { powerGrowthFactor = 0; }
		var simulationState = 0;
		if ( State.variables.simCycPar.templeDayPeriod == "training" ) {
			simulationState = -20;
		}
		if ( returnCharsUnlockedGenitals(target).length == 0 ) {
			simulationState -= 20;
		}
		var missionFactor = 0;
		if ( gC(target).mission == "haveSex" ) { missionFactor += 10; }
		else if ( gC(target).mission == "haveDomSex" ) { missionFactor -= 5; }
		
		var semifinalValue = targetMoodFactor + relationshipFactor + baseDifficulty + simulationState + willpowerCostFactor + drivesFactor + missionFactor + powerGrowthFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		result = false;
		if ( finalValue >= 0 ) { result = true; }
		secondStringResult = gC(actor).getFormattedName() + " invited " + gC(target).getFormattedName() + " to have sex and ";
		if ( result ) { stringResult = "Success!"; secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { stringResult = "Failure."; secondStringResult += gC(target).perPr + " refused."; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Base dif.: " + baseDifficulty
					  + ", Others: " + simulationState + ", Luck: " + luckFactor.toFixed(2) + ", Drives: " + drivesFactor.toFixed(2) + ", Desire: " + willpowerCostFactor.toFixed(2) + ", Intentions: " + missionFactor.toFixed(2) + ", Growth: " + powerGrowthFactor.toFixed(2) + " - Result: " + finalValue.toFixed(2);
		}
		
		secondStringResult = gC(actor).getFormattedName() + " invited " + gC(target).getFormattedName() + " to have sex and ";
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
		
		return [result,stringResult,secondStringResult];		
	}
	sist.getFailMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing bored.";
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		gC(target).mood.bored += 10;
		if ( gC(target).mood.bored > 100 ) {
			gC(target).mood.bored = 100;
		}
	}
	sist.getSuccessMessage = function(actor,target) {
		var sisId = State.variables.compass.findFirstSisIdInvolvingCharacter(actor);
		var sisCharList = State.variables.compass.sisList[sisId].charList;
		var joinedGroup = getCharGroup(actor).concat(getCharGroup(target));
		var additionalChars = recruitCharsInSis(sisCharList,actor,joinedGroup,this.doesCharJoinGroup);
		var message = "";
		if ( additionalChars.length > 0 ) {
			var stringedAddChars = [];
			for ( var cK of additionalChars ) {
				stringedAddChars.push(gC(cK).getFormattedName())
			}
			message = firstToCap(gC(target).perPr) + " agreed, and " + stringArrayToText(stringedAddChars) + " decided to join as well. You take them to a secluded place...";
		} else {
			message = firstToCap(gC(target).perPr) + " agreed. You take " + gC(target).formattedName + " to a secluded place...";
		}
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
			
		var sisId = State.variables.compass.findFirstSisIdInvolvingCharacter(actor);
		var sisCharList = State.variables.compass.sisList[sisId].charList;
		var joinedGroup = getCharGroup(actor).concat(getCharGroup(target));
		var additionalChars = recruitCharsInSis(sisCharList,actor,joinedGroup,this.doesCharJoinGroup);
		
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			var addCharsString = [];
			for ( var cK of additionalChars ) { addCharsString.push("'" + cK + "'"); }
			
			var bText = "<<l" + "ink [[Continue|Scene]]>><<s" + "cript>>\n";
			bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['" + target + "'].concat([" + addCharsString + "]),sistEgalitarianSexEffects);\n";
			bText	 += "<</s" + "cript>><</l" + "ink>>";
			
			State.variables.sisSpecifics.continueButton = bText;
		} else {
			var playerInAdditionalGroup = false;
			var playerMustBePrompted = false;
			
			if ( target != "chPlayerCharacter" && gC("chPlayerCharacter").followingTo == "" && sisCharList.includes("chPlayerCharacter") ) {
				playerMustBePrompted = true;
			} else  {
				for ( var cK of additionalChars ) {
					if ( gC(cK).followedBy.includes("chPlayerCharacter") ) {
						playerInAdditionalGroup = true;
					}
				}
			}
			
			if ( playerMustBePrompted ) {
				// Prompt Text:
				// Accept button: Ega sex starts, add chars get called, player group gets added
				// Reject button: Ega sex starts, add chars get called
				var addCharsString = [];
				var joiningCharsNames = [];
				var charsWillAlsoJoin = "";
				for ( var cK of additionalChars ) {
					addCharsString.push("'" + cK + "'");
					joiningCharsNames.push(gC(cK).getFormattedName());
				}
				if ( additionalChars.length > 0 ) {
					charsWillAlsoJoin = getCharNames(additionalChars);
				}
				
				var promptText = gC(actor).getFormattedName() + " invited " + gC(target).getFormattedName() + " to have sex and " + gC(target).perPr + " accepted.";
				if ( charsWillAlsoJoin != "" ) {
					promptText += " " + charsWillAlsoJoin + " will also join.";
				}
				promptText += "\nWould you like to partake?\n"
							   + "<<l" + "ink [[Join|Scene]]>><<s" + "cript>>\n" // Join button
							   + "genericSistEffects(getCharGroup('" + actor + "'),getCharGroup('" + target + "').concat([" + addCharsString + "]).concat(getCharGroup('chPlayerCharacter')),sistEgalitarianSexEffects);\n"
							   + "sistEgalitarianSexEffects(['" + actor + "'],['" + target + "'],getCharGroup('chPlayerCharacter').concat([" + addCharsString + "]));\n"
							   + "<</s" + "cript>><</l" + "ink>>\n"
							   + "<<l" + "ink [[Refuse|Social Interactions]]>><<s" + "cript>>\n" // Reject button
							   + "genericSistEffects(getCharGroup('" + actor + "'),getCharGroup('" + target + "').concat([" + addCharsString + "]),sistEgalitarianSexEffects);\n"
							   + "sistEgalitarianSexEffects(['" + actor + "'],['" + target + "'],[" + addCharsString + "]);\n"
							   + "<</s" + "cript>><</l" + "ink>>\n";
				State.variables.sisPlayerInfo.playerPrompt = promptText;
			} else {
				if ( playerInAdditionalGroup ) {
					var promptText = gC(gC("chPlayerCharacter").followingTo).getFormattedName() + " decided to join " + gC(actor).getFormattedName() + " and " + gC(target).getFormattedName() + " for sex and is dragging you along.\n[[Continue|Scene]]"; 
					State.variables.sisPlayerInfo.playerPrompt = promptText;
				}
				
				genericSistEffects(getCharGroup(actor),getCharGroup(target).concat(additionalChars));
				sistEgalitarianSexEffects([actor],[target],additionalChars);
			}
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " wants to have sex with you on equal conditions.\n" + this.getDesire(actor,target)[1] + "\n\n"
					   + this.getButtonPlayerAccepts(actor);
		var promptMode = "default";
		if ( gRelTypeAb("chPlayerCharacter",actor) ) {
			if ( gRelTypeAb("chPlayerCharacter",actor).forcedToSex ) {
				promptMode = "relTypeForcesToAccept";
			}
		}
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,promptMode,this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		// Get extra joining chars
		// Add extra joining chars to description
		// Add extra joining chars to script
		var sisId = State.variables.compass.findFirstSisIdInvolvingCharacter(actor);
		var sisCharList = State.variables.compass.sisList[sisId].charList;
		var joinedGroup = getCharGroup(actor).concat(getCharGroup("chPlayerCharacter"));
		var additionalChars = recruitCharsInSis(sisCharList,actor,joinedGroup,this.doesCharJoinGroup);
		
		var addCharsString = [];
		for ( var cK of additionalChars ) { addCharsString.push("'" + cK + "'"); }
		
		var bText = "<<l" + "ink [[Accept|Scene]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['chPlayerCharacter'].concat([" + addCharsString + "]),sistEgalitarianSexEffects);\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		
		if ( additionalChars.length > 0 ) {
			var stringedAddChars = [];
			for ( var cK of additionalChars ) {
				stringedAddChars.push(gC(cK).getFormattedName())
			}
			bText += " " + stringArrayToText(stringedAddChars) + " will also join."
		}
		
		return bText;
	}
	return sist;
}

window.sistEgalitarianSexEffects = function(actors,targets,additionalChars) {
	// Dirty fixes
	if ( additionalChars == undefined ) { additionalChars = []; }
	for ( var charKey of targets ) {
		if ( getCharGroup(targets[0]).includes(charKey) == false ) {
			if ( additionalChars.includes(charKey) == false ) {
				additionalChars.push(charKey);
			}
		}
	}
	//	//  //	//
	var flagPlayerIsInvolved = false;
	if ( actors.concat(targets).concat(additionalChars).includes("chPlayerCharacter") || gC(actors[0]).followedBy.includes("chPlayerCharacter") || gC(targets[0]).followedBy.includes("chPlayerCharacter") ) { flagPlayerIsInvolved = true; }
	var actor = actors[0];
	var target = targets[0];
	
	var associatedChars = [];
	
	// Relocate actor and target
	if ( gC(actor).getRefugeRoomInMap() != "none" ) {
		State.variables.compass.moveCharsToRoom(getCharGroup(actor).concat(getCharGroup(target)).concat(additionalChars),gC(actor).getRefugeRoomInMap());
	}
	
	// Start appropiate event
	State.variables.compass.characterEventEndsPrematurely(target);
	State.variables.compass.characterEventEndsPrematurely(actor);
	var eventCharList = removeDuplicatesFromList(getCharGroup(actor).concat(getCharGroup(target)).concat(additionalChars));
		// Set "noLead" scene flag to appropriate characters
	for ( var charKey of eventCharList ) {
		if ( charKey != actor && charKey != target ) {
			if ( eventCharList.includes(gC(charKey).domChar) ) {
				addSceneTagToChar("noLead",charKey);
			}
		}
	}
	eventToPile(createSystemEventStandardSexScene(eventCharList));
	if ( flagPlayerIsInvolved ) {
		State.variables.compass.pushAllTimeToAdvance();
	}
	
	// Start Sex Scene
	if ( flagPlayerIsInvolved ) {
		if ( target == "chPlayerCharacter" ) {
			target = actor;
			actor = "chPlayerCharacter";
		}
		if ( getCharGroup(actor).includes(target) ) {
			State.variables.sc.startScene(
		"ss","dynamic",getCharGroup(actor),additionalChars,"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		} else {
			State.variables.sc.startScene(
		"ss","dynamic",getCharGroup(actor),getCharGroup(target).concat(additionalChars),"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		}
		State.variables.sc.endSceneScript = processGenericSexSceneEffects;
		
		for ( var charKey of getCharGroup(actor).concat(getCharGroup(target)).concat(additionalChars) ) {
			if ( charKey != "chPlayerCharacter" ) {
				gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
				gC(charKey).aiAlgorythm.setRoleEqualFooting();
			}
		}
	} else {
		if ( getCharGroup(actor).includes(target) ) {
			State.variables.sc.startScene(
		"ss","dynamic",getCharGroup(actor),additionalChars,"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		} else {
			State.variables.sc.startScene(
		"ss","dynamic",getCharGroup(actor),getCharGroup(target).concat(additionalChars),"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		}
		State.variables.sc.endSceneScript = processGenericSexSceneEffects;
		
		for ( var charKey of getCharGroup(actor).concat(getCharGroup(target)).concat(additionalChars) ) {
			if ( charKey != "chPlayerCharacter" ) {
				gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
				gC(charKey).aiAlgorythm.setRoleEqualFooting();
			}
		}
		
		State.variables.sc.autoResolveScene();
	}
	
	if ( flagPlayerIsInvolved ) {
		State.variables.sc.formatScenePassage();
	}
}

window.createSistExcludingEgalitarianSex = function() {
	var sist = new sisTopic("Invite to have sex (Equal terms, exclusive)");
	sist.subtitle += '<span title="Unassociated third characters on this conversation will not be invited.">^^(?)^^</span>';
	sist.sT = setup.sistType.egalitarianExcludingSex;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		if ( isLewdingPossible(actor,target) && ( gC(target).type == "candidate" ) && ( State.variables.compass.findFirstSisIdInvolvingCharacter(actor) != -1 ) && ((gC(target).followingTo == "") || (gC(target).followingTo == actor) ) ) {
			if ( getSisCharIsIn(actor).getValidProposedCharacters(actor).includes(target) ) {
				var independentChars = 0;
				for ( var charKey of getSisCharIsIn(actor).charList ) {
					if ( gC(charKey).followingTo == "" ) {
						independentChars++;
					}
				}
				if ( independentChars > 2 ) {
					flagPossible = true;
				}
			}
		}
		return flagPossible;
	}
	
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var baseDifficulty = -10;
		var moodFactor = gC(target).mood.flirty * 0.05 + gC(target).mood.aroused * 0.1 - gC(target).mood.angry * 0.3 - gC(target).mood.bored * 0.3
					   +  gC(target).mood.submissive * 0.05 - gC(target).mood.dominant * 0.1;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 4 + rLvlAbt(target,actor,"sexualTension") * 8
							 + rLvlAbt(target,actor,"submission") * 4 + rLvlAbt(target,actor,"domination") * -8
							 + rLvlAbt(target,actor,"enmity") * -8;
		var statsFactor = gCstat(actor,"charisma") - gCstat(target,"will");
		var hadSexFactor = gC(target).daysWithoutSex * 3 - gC(target).sexScenesToday * 3;
		var missingLustFactor = (1 - getBarPercentage(target,"lust")) * 50;
		desire = baseDifficulty + moodFactor + relationshipFactor + statsFactor + missingLustFactor + hadSexFactor;
		var desireString = "Desire" + getDesireTooltip() + ": Base difficulty (" + baseDifficulty.toFixed(2) + ") + Mood (" + moodFactor.toFixed(2) + ") + Relationship ("
						 + relationshipFactor.toFixed(2) + ") + Stats (" + statsFactor.toFixed(2) + ") + Lust (" + missingLustFactor.toFixed(2) + ") + Sex life (" + hadSexFactor.toFixed(2) + ") = Total (" + desire.toFixed(2) + ").";
		
		return [desire,desireString];
	}
	
	sist.isSuccessful = function(actor,target) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		var relType = gRelTypeAb(target,actor);
		
		if ( relType ) {
			if ( relType.forcedToSex ) {
				result = true;
				stringResult = gC(target).getFormattedName() + " is bound by your relationship to accept.";
			}
		}
		if ( result == false ) {
		var baseDifficulty = -10; // -10
		var targetMoodFactor = gC(target).mood.flirty * 0.1 + gC(target).mood.intimate * 0.1 + gC(target).mood.aroused * 0.2
							 + gC(target).mood.angry * -0.3 + gC(target).mood.bored * (-0.3) + gC(target).mood.submissive * 0.1
							 + gC(target).mood.dominant * -0.2;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 1 + rLvlAbt(target,actor,"sexualTension") * 2
							 + rLvlAbt(target,actor,"submission") * 2 + rLvlAbt(target,actor,"domination") * -2
							 + rLvlAbt(target,actor,"enmity") * -3 + rLvlAbt(target,actor,"rivalry") * -1
		var willpowerCostFactor = this.getWillpowerRejectCost(actor,target) / 2;
		var drivesFactor = gC(target).dLove.level * 2 + gC(target).dPleasure.level * 4 - gC(target).dImprovement.level * 3 - gC(target).dDomination.level * 3;
		var powerGrowthFactor = -((quantifyCharacterStats(target) - 110) / 9);
		if ( powerGrowthFactor < 0 ) { powerGrowthFactor = 0; }
		var simulationState = 0;
		if ( State.variables.simCycPar.templeDayPeriod == "training" ) {
			simulationState = -20;
		}
		if ( returnCharsUnlockedGenitals(target).length == 0 ) {
			simulationState -= 20;
		}
		var missionFactor = 0;
		if ( gC(target).mission == "haveSex" ) { missionFactor += 10; }
		else if ( gC(target).mission == "haveDomSex" ) { missionFactor -= 5; }
		
		var semifinalValue = targetMoodFactor + relationshipFactor + baseDifficulty + simulationState + willpowerCostFactor + drivesFactor + missionFactor + powerGrowthFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		result = false;
		if ( finalValue >= 0 ) { result = true; }
		secondStringResult = gC(actor).getFormattedName() + " invited " + gC(target).getFormattedName() + " to have sex and ";
		if ( result ) { stringResult = "Success!"; secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { stringResult = "Failure."; secondStringResult += gC(target).perPr + " refused."; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Base dif.: " + baseDifficulty
					  + ", Others: " + simulationState + ", Luck: " + luckFactor.toFixed(2) + ", Drives: " + drivesFactor.toFixed(2) + ", Desire: " + willpowerCostFactor.toFixed(2) + ", Intentions: " + missionFactor.toFixed(2) + ", Growth: " + powerGrowthFactor.toFixed(2) + " - Result: " + finalValue.toFixed(2);
		}
		
		secondStringResult = gC(actor).getFormattedName() + " invited " + gC(target).getFormattedName() + " to have sex and ";
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
		
		return [result,stringResult,secondStringResult];		
	}
	sist.getFailMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing bored.";
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		gC(target).mood.bored += 10;
		if ( gC(target).mood.bored > 100 ) {
			gC(target).mood.bored = 100;
		}
	}
	sist.getSuccessMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " agreed. You take " + gC(target).formattedName + " to a secluded place...";
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			
			var bText = "<<l" + "ink [[Continue|Scene]]>><<s" + "cript>>\n";
			bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['" + target + "'],sistExcludingEgalitarianSexEffects);\n";
			bText	 += "<</s" + "cript>><</l" + "ink>>";
			
			State.variables.sisSpecifics.continueButton = bText;
		} else {
			genericSistEffects(getCharGroup(actor),getCharGroup(target));
			sistExcludingEgalitarianSexEffects([actor],[target]);
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " wants to have sex with you on equal conditions.\n" + this.getDesire(actor,target)[1] + "\n\n"
					   + this.getButtonPlayerAccepts(actor);
		var promptMode = "default";
		if ( gRelTypeAb("chPlayerCharacter",actor) ) {
			if ( gRelTypeAb("chPlayerCharacter",actor).forcedToSex ) {
				promptMode = "relTypeForcesToAccept";
			}
		}
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,promptMode,this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		var bText = "<<l" + "ink [[Accept|Scene]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['chPlayerCharacter'],sistExcludingEgalitarianSexEffects);\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	return sist;
}

window.sistExcludingEgalitarianSexEffects = function(actors,targets) {
	var flagPlayerIsInvolved = false;
	if ( actors.concat(targets).includes("chPlayerCharacter") || gC(actors[0]).followedBy.includes("chPlayerCharacter") || gC(targets[0]).followedBy.includes("chPlayerCharacter") ) { flagPlayerIsInvolved = true; }
	var actor = actors[0];
	var target = targets[0];
	
	// Relocate actor and target
	if ( gC(actor).getRefugeRoomInMap() != "none" ) {
		State.variables.compass.moveCharsToRoom(getCharGroup(actor).concat(getCharGroup(target)),gC(actor).getRefugeRoomInMap());
	}
	
	// Start appropiate event
	State.variables.compass.characterEventEndsPrematurely(target);
	State.variables.compass.characterEventEndsPrematurely(actor);
	var eventCharList = removeDuplicatesFromList(getCharGroup(actor).concat(getCharGroup(target)));
		// Set "noLead" scene flag to appropriate characters
	for ( var charKey of eventCharList ) {
		if ( charKey != actor && charKey != target ) {
			if ( eventCharList.includes(gC(charKey).domChar) ) {
				addSceneTagToChar("noLead",charKey);
			}
		}
	}
	eventToPile(createSystemEventStandardSexScene(eventCharList));
	if ( flagPlayerIsInvolved ) {
		State.variables.compass.pushAllTimeToAdvance();
	}
	
	// Start Sex Scene
	if ( flagPlayerIsInvolved ) {
		if ( target == "chPlayerCharacter" ) {
			target = actor;
			actor = "chPlayerCharacter";
		}
		if ( getCharGroup(actor).includes(target) ) {
			State.variables.sc.startScene(
		"ss","dynamic",getCharGroup(actor),[],"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		} else {
			State.variables.sc.startScene(
		"ss","dynamic",getCharGroup(actor),getCharGroup(target),"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		}
		State.variables.sc.endSceneScript = processGenericSexSceneEffects;
		
		for ( var charKey of getCharGroup(actor).concat(getCharGroup(target)) ) {
			if ( charKey != "chPlayerCharacter" ) {
				gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
				gC(charKey).aiAlgorythm.setRoleEqualFooting();
			}
		}
	} else {
		if ( getCharGroup(actor).includes(target) ) {
			State.variables.sc.startScene(
		"ss","dynamic",getCharGroup(actor),[],"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		} else {
			State.variables.sc.startScene(
		"ss","dynamic",getCharGroup(actor),getCharGroup(target),"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		}
		State.variables.sc.endSceneScript = processGenericSexSceneEffects;
		
		for ( var charKey of getCharGroup(actor).concat(getCharGroup(target)) ) {
			if ( charKey != "chPlayerCharacter" ) {
				gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
				gC(charKey).aiAlgorythm.setRoleEqualFooting();
			}
		}
		
		State.variables.sc.autoResolveScene();
	}
	
	if ( flagPlayerIsInvolved ) {
		State.variables.sc.formatScenePassage();
	}
}

window.createSistSubmissiveSex = function() {
	var sist = new sisTopic("Invite to have sex (Player submissive)");
	sist.sT = setup.sistType.submissiveSex;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		if ( isLewdingPossible(actor,target) && ( gC(target).type == "candidate" ) && ( State.variables.compass.findFirstSisIdInvolvingCharacter(actor) != -1 ) && ((gC(target).followingTo == "") || (gC(target).followingTo == actor) ) ) {
			if ( getSisCharIsIn(actor).getValidProposedCharacters(actor).includes(target) ) {
				flagPossible = true;
			}
		}
		return flagPossible;
	}
	
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var baseDifficulty = 0;
		var moodFactor = gC(target).mood.flirty * 0.05 + gC(target).mood.aroused * 0.1 - gC(target).mood.angry * 0.3 - gC(target).mood.bored * 0.3
					   -  gC(target).mood.submissive * 0.05 + gC(target).mood.dominant * 0.05;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 4 + rLvlAbt(target,actor,"sexualTension") * 8
							 + rLvlAbt(target,actor,"submission") * -4 + rLvlAbt(target,actor,"domination") * 4
							 + rLvlAbt(target,actor,"rivalry") * 4;
		var statsFactor = gCstat(actor,"charisma") - gCstat(target,"will");
		var hadSexFactor = gC(target).daysWithoutSex * 3 - gC(target).sexScenesToday * 3;
		var missingLustFactor = (1 - getBarPercentage(target,"lust")) * 50;
		desire = baseDifficulty + moodFactor + relationshipFactor + statsFactor + missingLustFactor + hadSexFactor;
		var desireString = "Desire" + getDesireTooltip() + ": Base difficulty (" + baseDifficulty.toFixed(2) + ") + Mood (" + moodFactor.toFixed(2) + ") + Relationship ("
						 + relationshipFactor.toFixed(2) + ") + Stats (" + statsFactor.toFixed(2) + ") + Lust (" + missingLustFactor.toFixed(2) + ") + Sex life (" + hadSexFactor.toFixed(2) + ") = Total (" + desire.toFixed(2) + ").";
		
		return [desire,desireString];
	}
	
	sist.isSuccessful = function(actor,target) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		var relType = gRelTypeAb(target,actor);
		
		if ( relType ) {
			if ( relType.forcedToSex ) {
				result = true;
				stringResult = gC(target).getFormattedName() + " is bound by your relationship to accept.";
			}
		}
		if ( result == false ) {
		var baseDifficulty = -5; // -5;
		var targetMoodFactor = gC(target).mood.flirty * 0.1 + gC(target).mood.aroused * 0.3
							 + gC(target).mood.angry * -0.2 + gC(target).mood.bored * -0.4 + gC(target).mood.submissive * -0.2
							 + gC(target).mood.dominant * 0.1;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 1 + rLvlAbt(target,actor,"sexualTension") * 3
							 + rLvlAbt(target,actor,"submission") * -1 + rLvlAbt(target,actor,"domination") * 1
							 + rLvlAbt(target,actor,"enmity") * -2 + rLvlAbt(target,actor,"rivalry") * 2;
		var simulationState = 0;
		if ( returnCharsUnlockedGenitals(target).length == 0 ) {
			simulationState -= 20;
		}
		var willpowerCostFactor = this.getWillpowerRejectCost(actor,target) / 2;
		var drivesFactor = gC(target).dPleasure.level * 4 + gC(target).dDomination.level * 2 + gC(target).dAmbition.level * 2 - gC(target).dImprovement.level * 6;
		if ( State.variables.simCycPar.templeDayPeriod == "training" ) {
			simulationState = -20;
		}
		var powerGrowthFactor = -((quantifyCharacterStats(target) - 110) / 9);
		if ( powerGrowthFactor < 0 ) { powerGrowthFactor = 0; }
		var missionFactor = 0;
		if ( gC(target).mission == "haveSex" ) { missionFactor += 10; }
		else if ( gC(target).mission == "haveDomSex" ) { missionFactor += 20; }
		
		var semifinalValue = targetMoodFactor + relationshipFactor + baseDifficulty + simulationState + willpowerCostFactor + drivesFactor + missionFactor + powerGrowthFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		result = false;
		if ( finalValue >= 0 ) { result = true; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Base dif.: " + baseDifficulty
					  + ", Others: " + simulationState + ", Luck: " + luckFactor.toFixed(2) + ", Drives: " + drivesFactor.toFixed(2) + ", Desire: " + willpowerCostFactor.toFixed(2) + ", Intentions: " + missionFactor.toFixed(2) + ", Growth: " + powerGrowthFactor.toFixed(2) + " - Result: " + finalValue.toFixed(2);
		}
		
		secondStringResult = gC(actor).getFormattedName() + " invited " + gC(target).getFormattedName() + " to have sex and ";
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
					  
		return [result,stringResult,secondStringResult];	
	}
	sist.getFailMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing bored. " + gC(actor).getFormattedName() + " felt humilliated and will resent that.";
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		gC(target).mood.bored += 10;
		if ( gC(target).mood.bored > 100 ) {
			gC(target).mood.bored = 100;
		}
		gC(actor).relations[target].enmity.stv += 10;
		gC(actor).relations[target].rivalry.stv += 10;
	}
	sist.getSuccessMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " agreed. You take " + gC(target).formattedName + " to a secluded place, enjoying the anticipating of submitting...";
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
		gC(actor).relations[target].submission.stv += 10;
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			
			var bText = "<<l" + "ink [[Continue|Scene]]>><<s" + "cript>>\n";
			bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['" + target + "'],sistSubmissiveSexEffects);\n";
			bText	 += "<</s" + "cript>><</l" + "ink>>";
			
			State.variables.sisSpecifics.continueButton = bText;
		} else {
			genericSistEffects(getCharGroup(actor),getCharGroup(target));
			sistSubmissiveSexEffects([actor],[target]);
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " wants to have sex with you at the top.\n" + this.getDesire(actor,target)[1] + "\n\n"
					   + this.getButtonPlayerAccepts(actor);
		var promptMode = "default";
		if ( gRelTypeAb("chPlayerCharacter",actor) ) {
			if ( gRelTypeAb("chPlayerCharacter",actor).forcedToSex ) {
				promptMode = "relTypeForcesToAccept";
			}
		}
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,promptMode,this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		var bText = "<<l" + "ink [[Accept|Scene]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['chPlayerCharacter'],sistSubmissiveSexEffects);\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
	return sist;
}

window.sistSubmissiveSexEffects = function(actors,targets) {
	var flagPlayerIsInvolved = false;
	if ( actors.concat(targets).includes("chPlayerCharacter") || gC(actors[0]).followedBy.includes("chPlayerCharacter") || gC(targets[0]).followedBy.includes("chPlayerCharacter") ) { flagPlayerIsInvolved = true; }
	var actor = actors[0];
	var target = targets[0];
	
	// Relocate actor and target
	if ( gC(actor).getRefugeRoomInMap() != "none" ) {
		State.variables.compass.moveCharsToRoom(getCharGroup(actor).concat(getCharGroup(target)),gC(actor).getRefugeRoomInMap());
	}
		
	// Start appropiate event
	State.variables.compass.characterEventEndsPrematurely(target);
	State.variables.compass.characterEventEndsPrematurely(actor);
	var eventCharList = removeDuplicatesFromList(getCharGroup(actor).concat(getCharGroup(target)));
	eventToPile(createSystemEventStandardSexScene(eventCharList));
	if ( flagPlayerIsInvolved ) {
		State.variables.compass.pushAllTimeToAdvance();
	}
	
	// Start Sex Scene
	var actorO = actor;
	var targetO = target;
	var tFlag = false;
	if ( flagPlayerIsInvolved ) {
		if ( target == "chPlayerCharacter" ) {
			target = actor;
			actor = "chPlayerCharacter";
			tFlag = true;
		}
		if ( getCharGroup(actor).includes(target) ) {
			State.variables.sc.startScene(
		"ss","fixed",getCharGroup(actor),[],"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		} else {
			State.variables.sc.startScene(
		"ss","fixed",getCharGroup(actor),getCharGroup(target),"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		}
		State.variables.sc.endSceneScript = processGenericSexSceneEffects;
		
		if ( tFlag ) {
			gC(actor).hasLead = true;
		} else {
			gC(target).hasLead = true;
		}
		for ( var charKey of getCharGroup(actor).concat(getCharGroup(target)) ) {
			if ( charKey != "chPlayerCharacter" ) {
				gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
				if ( charKey == target ) {
					gC(charKey).aiAlgorythm.setRoleDomination();
				} else {
					gC(charKey).aiAlgorythm.setRoleSubmission();
				}
			}
		}
	} else {
		if ( getCharGroup(actor).includes(target) ) {
			State.variables.sc.startScene(
		"ss","fixed",getCharGroup(actor),[],"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		} else {
			State.variables.sc.startScene(
		"ss","fixed",getCharGroup(actor),getCharGroup(target),"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		}
		State.variables.sc.endSceneScript = processGenericSexSceneEffects;
		
		for ( var charKey of getCharGroup(actor).concat(getCharGroup(target)) ) {
			if ( charKey != "chPlayerCharacter" ) {
				gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
				if ( charKey == target ) {
					gC(charKey).aiAlgorythm.setRoleDomination();
				} else {
					gC(charKey).aiAlgorythm.setRoleSubmission();
				}
			}
		}
		
		State.variables.sc.autoResolveScene();
	}
	
	if ( flagPlayerIsInvolved ) {
		State.variables.sc.formatScenePassage();
	}
}

window.createSistDominantSex = function() {
	var sist = new sisTopic("Invite to have sex (Player Dominant)");
	sist.sT = setup.sistType.dominantSex;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		if ( isLewdingPossible(actor,target) && ( gC(target).type == "candidate" ) && ( State.variables.compass.findFirstSisIdInvolvingCharacter(actor) != -1 ) && ((gC(target).followingTo == "") || (gC(target).followingTo == actor) ) ) {
			if ( getSisCharIsIn(actor).getValidProposedCharacters(actor).includes(target) ) {
				flagPossible = true;
			}
		}
		return flagPossible;
	}
	
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var baseDifficulty = -20;
		var moodFactor = gC(target).mood.flirty * 0.05 + gC(target).mood.aroused * 0.1 - gC(target).mood.angry * 0.3 - gC(target).mood.bored * 0.3
					   +  gC(target).mood.submissive * 0.05 - gC(target).mood.dominant * 0.15;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 4 + rLvlAbt(target,actor,"sexualTension") * 8
							 + rLvlAbt(target,actor,"submission") * 4 + rLvlAbt(target,actor,"domination") * -12
							 + rLvlAbt(target,actor,"enmity") * -12;
		var statsFactor = gCstat(actor,"charisma") - gCstat(target,"will");
		var hadSexFactor = gC(target).daysWithoutSex * 3 - gC(target).sexScenesToday * 3;
		var missingLustFactor = (1 - getBarPercentage(target,"lust")) * 50;
		desire = baseDifficulty + moodFactor + relationshipFactor + statsFactor + missingLustFactor + hadSexFactor;
		var desireString = "Desire" + getDesireTooltip() + ": Base difficulty (" + baseDifficulty.toFixed(2) + ") + Mood (" + moodFactor.toFixed(2) + ") + Relationship ("
						 + relationshipFactor.toFixed(2) + ") + Stats (" + statsFactor.toFixed(2) + ") + Lust (" + missingLustFactor.toFixed(2) + ") + Sex life (" + hadSexFactor.toFixed(2) + ") = Total (" + desire.toFixed(2) + ").";
		
		return [desire,desireString];
	}
	
	sist.isSuccessful = function(actor,target) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		var relType = gRelTypeAb(target,actor);
		
		if ( relType ) {
			if ( relType.forcedToSex ) {
				result = true;
				stringResult = gC(target).getFormattedName() + " is bound by your relationship to accept.";
			}
		}
		if ( result == false ) {
		var baseDifficulty = -20; // -20
		var targetMoodFactor = gC(target).mood.flirty * 0.1 + gC(target).mood.intimate * 0.1 + gC(target).mood.aroused * 0.2
							 + gC(target).mood.angry * -0.5 + gC(target).mood.bored * -0.2 + gC(target).mood.submissive * 0.2
							 + gC(target).mood.dominant * -0.4;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 1 + rLvlAbt(target,actor,"sexualTension") * 2
							 + rLvlAbt(target,actor,"submission") * 3 + rLvlAbt(target,actor,"domination") * -3
							 + rLvlAbt(target,actor,"enmity") * -3 + rLvlAbt(target,actor,"rivalry") * -3;
		var simulationState = 0;
		if ( returnCharsUnlockedGenitals(target).length == 0 ) {
			simulationState -= 20;
		}
		var willpowerCostFactor = this.getWillpowerRejectCost(actor,target) / 2;
		var drivesFactor = gC(target).dPleasure.level * 4 + gC(target).dLove.level * 4 - gC(target).dDomination.level * 3 - gC(target).dAmbition.level * 3 - gC(target).dImprovement.level * 4;
		if ( State.variables.simCycPar.templeDayPeriod == "training" ) {
			simulationState = -20;
		}
		
		var powerGrowthFactor = -((quantifyCharacterStats(target) - 110) / 9);
		if ( powerGrowthFactor < 0 ) { powerGrowthFactor = 0; }
		var missionFactor = 0;
		if ( gC(target).mission == "haveSex" ) { missionFactor += 5; }
		else if ( gC(target).mission == "haveDomSex" ) { missionFactor -= 20; }
		
		var semifinalValue = targetMoodFactor + relationshipFactor + baseDifficulty + simulationState + willpowerCostFactor + drivesFactor + missionFactor + powerGrowthFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		result = false;
		if ( finalValue >= 0 ) { result = true; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Base dif.: " + baseDifficulty
					  + ", Others: " + simulationState + ", Luck: " + luckFactor.toFixed(2) + ", Drives: " + drivesFactor.toFixed(2) + ", Desire: " + willpowerCostFactor.toFixed(2) + ", Intentions: " + missionFactor.toFixed(2) + ", Growth: " + powerGrowthFactor.toFixed(2) + " - Result: " + finalValue.toFixed(2);
		}
		
		secondStringResult = gC(actor).getFormattedName() + " invited " + gC(target).getFormattedName() + " to have sex and ";
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
		
		return [result,stringResult,secondStringResult];	
	}
	sist.getFailMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing bored.";
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		gC(target).mood.bored += 10;
		if ( gC(target).mood.bored > 100 ) {
			gC(target).mood.bored = 100;
		}
	}
	sist.getSuccessMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " agreed. You take " + gC(target).formattedName + " to a secluded place...";
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			
			var bText = "<<l" + "ink [[Continue|Scene]]>><<s" + "cript>>\n";
			bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['" + target + "'],sistDominantSexEffects);\n";
			bText	 += "<</s" + "cript>><</l" + "ink>>";
			
			State.variables.sisSpecifics.continueButton = bText;
		} else {
			genericSistEffects(getCharGroup(actor),getCharGroup(target));
			sistDominantSexEffects([actor],[target]);
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " wants to have sex with you at the bottom.\n" + this.getDesire(actor,target)[1] + "\n\n"
					   + this.getButtonPlayerAccepts(actor);
		var promptMode = "default";
		if ( gRelTypeAb("chPlayerCharacter",actor) ) {
			if ( gRelTypeAb("chPlayerCharacter",actor).forcedToSex ) {
				promptMode = "relTypeForcesToAccept";
			}
		}
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,promptMode,this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		var bText = "<<l" + "ink [[Accept|Scene]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['chPlayerCharacter'],sistDominantSexEffects);\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
	return sist; 
}

window.sistDominantSexEffects = function(actors,targets) {
	var flagPlayerIsInvolved = false;
	if ( actors.concat(targets).includes("chPlayerCharacter") || gC(actors[0]).followedBy.includes("chPlayerCharacter") || gC(targets[0]).followedBy.includes("chPlayerCharacter") ) { flagPlayerIsInvolved = true; }
	var actor = actors[0];
	var target = targets[0];
	
	// Relocate actor and target
	if ( gC(actor).getRefugeRoomInMap() != "none" ) {
		State.variables.compass.moveCharsToRoom(getCharGroup(actor).concat(getCharGroup(target)),gC(actor).getRefugeRoomInMap());
	}
	
	
	// Start appropiate event
	State.variables.compass.characterEventEndsPrematurely(target);
	State.variables.compass.characterEventEndsPrematurely(actor);
	var eventCharList = removeDuplicatesFromList(getCharGroup(actor).concat(getCharGroup(target)));
	eventToPile(createSystemEventStandardSexScene(eventCharList));
	if ( flagPlayerIsInvolved ) {
		State.variables.compass.pushAllTimeToAdvance();
	}
	
	// Start Sex Scene
	if ( flagPlayerIsInvolved ) {
		var actorO = actor;
		var targetO = target;
		var tFlag = false;
		if ( target == "chPlayerCharacter" ) {
			target = actor;
			actor = "chPlayerCharacter";
			tFlag = true;
		}
		if ( getCharGroup(actor).includes(target) ) {
			State.variables.sc.startScene(
		"ss","fixed",getCharGroup(actor),[],"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		} else {
			State.variables.sc.startScene(
		"ss","fixed",getCharGroup(actor),getCharGroup(target),"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		}
		State.variables.sc.endSceneScript = processGenericSexSceneEffects;
		
		if ( tFlag ) {
			gC(target).hasLead = true;
		} else {
			gC(actor).hasLead = true;
		}
		for ( var charKey of getCharGroup(actor).concat(getCharGroup(target)) ) {
			if ( charKey != "chPlayerCharacter" ) {
				gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
				if ( charKey == actor ) {
					gC(charKey).aiAlgorythm.setRoleDomination();
				} else {
					gC(charKey).aiAlgorythm.setRoleSubmission();
				}
			}
		}		
	} else {
		if ( getCharGroup(actor).includes(target) ) {
			State.variables.sc.startScene(
		"ss","fixed",getCharGroup(actor),[],"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		} else {
			State.variables.sc.startScene(
		"ss","fixed",getCharGroup(actor),getCharGroup(target),"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		}
		State.variables.sc.endSceneScript = processGenericSexSceneEffects;
		
		for ( var charKey of getCharGroup(actor).concat(getCharGroup(target)) ) {
			if ( charKey != "chPlayerCharacter" ) {
				gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
				if ( charKey == actor ) {
					gC(charKey).aiAlgorythm.setRoleDomination();
				} else {
					gC(charKey).aiAlgorythm.setRoleSubmission();
				}
			}
		}

		State.variables.sc.autoResolveScene();
	}
	
	if ( flagPlayerIsInvolved ) {
		State.variables.sc.formatScenePassage();
	}
}

window.createSistBorrowedDominantSex = function() {
	var sist = new sisTopic("Ask to borrow submissives for sex (Player Dominant)");
	sist.sT = setup.sistType.borrowedSex;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		if ( isLewdingPossible(actor,target) && ( gC(target).type == "candidate" ) && ( State.variables.compass.findFirstSisIdInvolvingCharacter(actor) != -1 ) && ((gC(target).followingTo == "") || (gC(target).followingTo == actor) ) ) {
			for ( var charKey of gC(target).subChars ) {
				if ( getSisCharIsIn(actor).charList.includes(charKey) ) {
					flagPossible = true;
				}
			}
		}
		return flagPossible;
	}
	
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var baseDifficulty = -100;
		var moodFactor = gC(target).mood.friendly * 0.05 + gC(target).mood.intimate * 0.05 - gC(target).mood.flirty * 0.03 - gC(target).mood.aroused * 0.05 - gC(target).mood.angry + gC(target).mood.submissive * 0.05 - gC(target).mood.dominant * 0.05;
		var relationshipFactor = rLvlAbt(target,actor,"friendship") * 8 + rLvlAbt(target,actor,"sexualTension") * 2
							 + rLvlAbt(target,actor,"submission") * 4 + rLvlAbt(target,actor,"domination") * -8
							 + rLvlAbt(target,actor,"enmity") * -12;
		var statsFactor = gCstat(actor,"charisma") - gCstat(target,"will");
		var hadSexFactor = - (gC(target).daysWithoutSex * 3 - gC(target).sexScenesToday * 3);
		var missingLustFactor = - ((1 - getBarPercentage(target,"lust")) * 50);
		desire = baseDifficulty + moodFactor + relationshipFactor + statsFactor + missingLustFactor + hadSexFactor;
		var desireString = "Mood (" + moodFactor.toFixed(2) + ") + Relationship ("
						 + relationshipFactor.toFixed(2) + ") + Stats (" + statsFactor.toFixed(2) + ") + Lust (" + missingLustFactor.toFixed(2) + ") + Sex life (" + hadSexFactor.toFixed(2) + ") = Total (" + desire.toFixed(2) + ").";
		
		return [desire,desireString];
	}
	
	sist.isSuccessful = function(actor,target) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		var relType = gRelTypeAb(target,actor);
		
		if ( result == false ) {
		var baseDifficulty = -30;
		var targetMoodFactor = gC(target).mood.friendly * 0.1 - gC(target).mood.flirty * 0.05 + gC(target).mood.intimate * 0.05
							 - gC(target).mood.aroused * 0.2 + gC(target).mood.angry * -0.5
							 + gC(target).mood.submissive * 0.1 + gC(target).mood.dominant * -0.2;
		var relationshipFactor = rLvlAbt(target,actor,"friendship") * 3 - rLvlAbt(target,actor,"sexualTension") * 2
							 + rLvlAbt(target,actor,"submission") * 2 + rLvlAbt(target,actor,"domination") * -2
							 + rLvlAbt(target,actor,"enmity") * -3 + rLvlAbt(target,actor,"rivalry") * -2;
		var simulationState = 0;
		var willpowerCostFactor = 0;
		var drivesFactor = gC(target).dCooperation.level * 2 + gC(target).dLove.level * 2 - gC(target).dDomination.level * 3;
		if ( State.variables.simCycPar.templeDayPeriod == "training" ) {
			simulationState = 10;
		}
		
		var powerGrowthFactor = 0;
		var missionFactor = 0;
		if ( gC(target).mission == "haveSex" ) { missionFactor -= 10; }
		else if ( gC(target).mission == "haveDomSex" ) { missionFactor -= 20; }
		
		var semifinalValue = targetMoodFactor + relationshipFactor + baseDifficulty + simulationState + drivesFactor + missionFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		result = false;
		if ( finalValue >= 0 ) { result = true; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Base dif.: " + baseDifficulty
					  + ", Others: " + simulationState + ", Luck: " + luckFactor.toFixed(2) + ", Drives: " + drivesFactor.toFixed(2) + ", Intentions: " + missionFactor.toFixed(2) + " - Result: " + finalValue.toFixed(2);
		}
		
		secondStringResult = gC(actor).getFormattedName() + " asked " + gC(target).getFormattedName() + " to borrow " + gC(target).posPr + " submissives for sex and ";
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
		
		return [result,stringResult,secondStringResult];	
	}
	sist.getFailMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing annoyed.";
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		gC(target).mood.bored += 10;
		if ( gC(target).mood.bored > 100 ) {
			gC(target).mood.bored = 100;
		}
		gC(target).mood.angry += 10;
		if ( gC(target).mood.angry > 100 ) {
			gC(target).mood.angry = 100;
		}
	}
	sist.getSuccessMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " agreed. You take " + gC(target).posPr + " submissives to a secluded place...\n"
					+ colorText((gC(actor).getFormattedName() + "'s and " + gC(target).getFormattedName() + "'s friendship has increased.\n"),"khaki")
					+ colorText((gC(target).getFormattedName() + "'s romance with " + gC(target).posPr + " submissives has slightly decreased.\n"),"gray")
					+ gC(actor).getFormattedName() + "'s and " + gC(target).getFormattedName() + "'s cooperation drives have increased.";
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			
			var bText = "<<l" + "ink [[Continue|Scene]]>><<s" + "cript>>\n";
			bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['" + target + "'],sistBorrowedDominantSexEffects);\n";
			bText	 += "<</s" + "cript>><</l" + "ink>>";
			
			State.variables.sisSpecifics.continueButton = bText;
		} else {
			genericSistEffects(getCharGroup(actor),getCharGroup(target));
			sistBorrowedDominantSexEffects([actor],[target]);
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " wants to borrow your submissives for sex.\n\n"
					   + this.getButtonPlayerAccepts(actor);
		var promptMode = "default";
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,promptMode,this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		var bText = "<<l" + "ink [[Accept|Social Interactions]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['chPlayerCharacter'],sistBorrowedDominantSexEffects);\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	
	return sist; 
}

window.sistBorrowedDominantSexEffects = function(actors,targets) {
	var flagPlayerIsInvolved = false;
	var actor = actors[0];
	var target = targets[0];
	
	var teamB = [];
	for ( var cK of gC(target).followedBy ) {
		if ( gC(cK).domChar == target ) {
			teamB.push(cK);
			charUnfollowsChar(cK,target);
		}
	}
	
	// Relationship chand drive changes
	getRelation(actor,target).friendship.stv += 60 * teamB.length;
	getRelation(target,actor).friendship.stv += 60 * teamB.length;
	for ( var cK of teamB ) {
		getRelation(cK,target).romance.stv -= 20;
	}
	gC(actor).dCooperation.value += 10;
	gC(target).dCooperation.value += 10;
	// // //
	
	if ( actors.concat(teamB).includes("chPlayerCharacter") || gC(actors[0]).followedBy.includes("chPlayerCharacter") ) { flagPlayerIsInvolved = true; }
	
	// Relocate actor and target
	if ( gC(actor).getRefugeRoomInMap() != "none" ) {
		State.variables.compass.moveCharsToRoom(getCharGroup(actor).concat(teamB),gC(actor).getRefugeRoomInMap());
	}
	
	
	// Start appropiate event
	for ( var cK of teamB ) {
		State.variables.compass.characterEventEndsPrematurely(cK);
	}
	State.variables.compass.characterEventEndsPrematurely(actor);
	var eventCharList = removeDuplicatesFromList(getCharGroup(actor).concat(teamB));
	
	eventToPile(createSystemEventAltDominantSexEffects(getCharGroup(actor),teamB));

	if ( flagPlayerIsInvolved ) {
		State.variables.compass.pushAllTimeToAdvance();
	}
}

	// Offer special relationships
window.createSistOfferServitudeAsMaster = function() {
	var sist = new sisTopic("Invite to initiate Servitude Relationship as your Servant");
	sist.subtitle += '<span title="' + relTypeServitudeTooltip() + '">^^(?)^^</span>';
	sist.sT = setup.sistType.servitudeAsMaster;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		// Actor is candidate, actor and target have no special relationship, actor has no dominant, target has no submissives,
		// special relationships are allowed
		if ( (gSettings().servitudeRelationships == "enable") && ( gC(actor).type == "candidate" ) &&
			( gRelTypeAb(actor,target) == null ) && ( gC(actor).domChar == null ) && ( gC(target).domChar == null )
		  && ( gC(target).subChars.length < 1 ) && ( State.variables.settings.relationshipTypesAllowed ) && ((gC(target).followingTo == "") || (gC(target).followingTo == actor) ) ) {
			flagPossible = true;
		}
		return flagPossible;
	}
	
	sist.getSocialdriveOfferCost = function(actor,target) {
		return 25;
	}
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var baseDifficulty = -25;
		var moodFactor = gC(target).mood.intimate * 0.05 - gC(target).mood.angry * 0.5 - gC(target).mood.bored * 0.3
					   +  gC(target).mood.submissive * 0.05 - gC(target).mood.dominant * 0.1;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 2 + rLvlAbt(target,actor,"sexualTension") * 5
							 + rLvlAbt(target,actor,"submission") * 5 + rLvlAbt(target,actor,"domination") * -5
							 + rLvlAbt(target,actor,"rivalry") * 5;
		var statsFactor = quantifyCharacterStats(actor) - quantifyCharacterStats(target) * 1.2;
		desire = baseDifficulty + moodFactor + relationshipFactor + statsFactor;
		var desireString = "Desire" + getDesireTooltip() + ": Base difficulty (" + baseDifficulty.toFixed(2) + ") + Mood (" + moodFactor.toFixed(2) + ") + Relationship ("
						 + relationshipFactor.toFixed(2) + ") + Stats (" + statsFactor.toFixed(2) + ") = Total (" + desire.toFixed(2) + ").";
		
		return [desire,desireString];
	}
	
	sist.isSuccessful = function(actor,target) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		
		var baseDifficulty = 125;
		var targetMoodFactor = gC(target).mood.submissive * 0.4 + gC(target).mood.dominant * -0.6 + gC(target).mood.intimate * 0.1
							 + gC(target).mood.aroused * 0.2 + gC(target).mood.bored * -0.2 + gC(target).mood.angry * -0.5;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 2 + rLvlAbt(target,actor,"sexualTension") * 2
							 + rLvlAbt(target,actor,"submission") * 4 + rLvlAbt(target,actor,"domination") * -5
							 + rLvlAbt(target,actor,"enmity") * -7 + rLvlAbt(target,actor,"rivalry") * -3;
		var drivesFactor = gC(target).dDomination.level * -2 + gC(target).dAmbition.level * -2;
		if ( ( rLvlAbt(target,actor,"sexualTension") + rLvlAbt(target,actor,"romance") ) > ( rLvlAbt(target,actor,"enmity") * 5 + rLvlAbt(target,actor,"rivalry") * 5 + 3 ) ) {
			drivesFactor += gC(target).dPleasure.level * 2 + gC(target).dLove.level * 2;
		}
		var willpowerCostFactor = this.getWillpowerRejectCost(actor,target) / 2;
							 
		var semifinalValue = targetMoodFactor + relationshipFactor + drivesFactor + willpowerCostFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		if ( finalValue >= baseDifficulty ) { result = true; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Drives: " + drivesFactor + ", Willpower cost: " + willpowerCostFactor.toFixed(2) + ", Luck: " + luckFactor.toFixed(2)
					  + " -> Result: " + finalValue.toFixed(2) + " VS Difficulty: " + baseDifficulty;
		
		secondStringResult = gC(actor).getFormattedName() + " invited " + gC(target).getFormattedName() + " to become " + gC(target).posPr + " master and " + gC(target).perPr;
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
		
		return [result,stringResult,secondStringResult];	
	}
	sist.getFailMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing angry.";
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		gC(target).mood.angry += 10;
		if ( gC(target).mood.angry > 100 ) {
			gC(target).mood.angry = 100;
		}
	}
	sist.getSuccessMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " agreed. " + gC(target).formattedName + " will now serve you.";
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			
			var bText = "<<l" + "ink [[Continue|Social Interactions]]>><<s" + "cript>>\n";
			bText    += "createRelTypeServitudeDom('" + actor + "','" + target + "'," + gSettings().relationshipsDuration + ");\n";
			bText	 += "createRelTypeServitudeSub('" + target + "','" + actor + "'," + gSettings().relationshipsDuration + ");\n";
			bText	 += "State.variables.sisSpecifics.flagSissEnd = false;\n";
			bText	 += "<</s" + "cript>><</l" + "ink>>";
			
			State.variables.sisSpecifics.formatChoicesText();
			
			State.variables.sisSpecifics.continueButton = bText;
		} else {
			genericSistEffects(getCharGroup(actor),getCharGroup(target));
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " wants to initiate a servitude relationship with you as " + gC(actor).posPr + " servant.\n\n"
					   + this.getButtonPlayerAccepts(actor);
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,"default",this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		var bText = "<<l" + "ink [[Accept|Social Interactions]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "createSistOfferServitudeAsMaster.getSuccessEffect('" + actor + "','chPlayerCharacter');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	return sist;
}
window.createSistOfferServitudeAsServant = function() {
	var sist = new sisTopic("Invite to initiate Servitude Relationship as your Master");
	sist.subtitle += '<span title="' + relTypeServitudeTooltip() + '">^^(?)^^</span>';
	sist.sT = setup.sistType.servitudeAsServant;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		// Target is candidate, actor and target have no special relationship, actor has no submissive, target has no dominant,
		// special relationships are allowed
		if ( (gSettings().servitudeRelationships == "enable") && ( gC(target).type == "candidate" ) &&
			( gRelTypeAb(actor,target) == null ) && ( gC(target).domChar == null ) && ( gC(actor).domChar == null )
		  && ( gC(actor).subChars.length < 1 ) && ( State.variables.settings.relationshipTypesAllowed ) && ((gC(target).followingTo == "") || (gC(target).followingTo == actor) ) ) {
			flagPossible = true;
		}
		return flagPossible;
	}
	
	sist.getSocialdriveOfferCost = function(actor,target) {
		return 25;
	}
	
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var baseDifficulty = 10;
		var moodFactor = gC(target).mood.friendly * 0.05 + gC(target).mood.intimate * 0.1 - gC(target).mood.angry * 0.5 - gC(target).mood.bored * 0.3
					   -  gC(target).mood.submissive * 0.1 + gC(target).mood.dominant * 0.1;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 2 + rLvlAbt(target,actor,"sexualTension") * 5
							 + rLvlAbt(target,actor,"submission") * -5 + rLvlAbt(target,actor,"domination") * 5
							 + rLvlAbt(target,actor,"enmity") * -10 + rLvlAbt(target,actor,"rivalry") * 5;
		var statsFactor = quantifyCharacterStats(target) - quantifyCharacterStats(actor) * 1.2;
		desire = baseDifficulty + moodFactor + relationshipFactor + statsFactor;
		var desireString = "Desire" + getDesireTooltip() + ": Base difficulty (" + baseDifficulty.toFixed(2) + ") + Mood (" + moodFactor.toFixed(2) + ") + Relationship ("
						 + relationshipFactor.toFixed(2) + ") + Stats (" + statsFactor.toFixed(2) + ") = Total (" + desire.toFixed(2) + ").";
		
		return [desire,desireString];
	}
	
	sist.isSuccessful = function(actor,target) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		
		var baseDifficulty = -10;
		var targetMoodFactor = gC(target).mood.submissive * -0.6 + gC(target).mood.dominant * 0.4 + gC(target).mood.intimate * 0.1
							 + gC(target).mood.aroused * 0.4 + gC(target).mood.bored * -0.4 + gC(target).mood.angry * -0.4;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 4 + rLvlAbt(target,actor,"sexualTension") * 10
							 + rLvlAbt(target,actor,"submission") * -5 + rLvlAbt(target,actor,"domination") * 10
							 + rLvlAbt(target,actor,"enmity") * 5 + rLvlAbt(target,actor,"rivalry") * 5;
		var drivesFactor = gC(target).dDomination.level * 4 + gC(target).dAmbition.level * 4 - gC(target).dCooperation.level * 2;
		var willpowerCostFactor = this.getWillpowerRejectCost(actor,target) / 2;
							 
		var semifinalValue = targetMoodFactor + relationshipFactor + drivesFactor + willpowerCostFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		if ( finalValue >= baseDifficulty ) { result = true; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Drives: " + drivesFactor + ", Willpower cost: " + willpowerCostFactor.toFixed(2) + ", Luck: " + luckFactor.toFixed(2)
					  + " -> Result: " + finalValue.toFixed(2) + " VS Difficulty: " + baseDifficulty;
		
		secondStringResult = gC(actor).getFormattedName() + " invited " + gC(target).getFormattedName() + " to become " + gC(target).posPr + " servant and " + gC(target).perPr;
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
		
		return [result,stringResult,secondStringResult];	
	}
	sist.getFailMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing angry.";
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		gC(target).mood.angry += 10;
		if ( gC(target).mood.angry > 100 ) {
			gC(target).mood.angry = 100;
		}
	}
	sist.getSuccessMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " agreed. " + gC(target).formattedName + " will now expect you to serve " + gC(target).comPr + ".";
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			
			var bText = "<<l" + "ink [[Continue|Social Interactions]]>><<s" + "cript>>\n";
			bText    += "createRelTypeServitudeSub('" + actor + "','" + target + "'," + gSettings().relationshipsDuration + ");\n";
			bText	 += "createRelTypeServitudeDom('" + target + "','" + actor + "'," + gSettings().relationshipsDuration + ");\n";
			bText	 += "State.variables.sisSpecifics.flagSissEnd = false;\n";
			bText	 += "<</s" + "cript>><</l" + "ink>>";
			
			State.variables.sisSpecifics.formatChoicesText();
			
			State.variables.sisSpecifics.continueButton = bText;
		} else {
			genericSistEffects(getCharGroup(actor),getCharGroup(target));
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " wants to initiate a servitude relationship with you as " + gC(actor).posPr + " master.\n\n"
					   + this.getButtonPlayerAccepts(actor);
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,"default",this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		var bText = "<<l" + "ink [[Accept|Social Interactions]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "createSistOfferServitudeAsServant.getSuccessEffect('" + actor + "','chPlayerCharacter');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	return sist;
}

window.createSistOfferTutorshipAsTutor = function() {
	var sist = new sisTopic("Invite to initiate Tutorship Relationship as your Pupil");
	sist.subtitle += '<span title="' + relTypeTutorshipTooltip() + '">^^(?)^^</span>';
	sist.sT = setup.sistType.tutorshipAsTutor;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		// Actor is candidate, actor and target have no special relationship, actor has no dominant, target has no submissives,
		// special relationships are allowed
		if ( (gSettings().relationshipTypesAllowed == true) && ( gC(actor).type == "candidate" ) &&
			( gRelTypeAb(actor,target) == null ) && ( gC(actor).domChar == null )
		  && ( gC(target).subChars.length < 1 ) && ( gC(target).domChar == null ) && ((gC(target).followingTo == "") || (gC(target).followingTo == actor) ) ) {
			flagPossible = true;
		}
		return flagPossible;
	}
	
	sist.getSocialdriveOfferCost = function(actor,target) {
		return 25;
	}
	
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var baseDifficulty = -20;
		var moodFactor = gC(target).mood.friendly * 0.05 + gC(target).mood.intimate * 0.1 - gC(target).mood.angry * 0.5 - gC(target).mood.bored * 0.3
					   +  gC(target).mood.submissive * 0.05 - gC(target).mood.dominant * 0.1;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 5 + rLvlAbt(target,actor,"sexualTension") * 2
							 + rLvlAbt(target,actor,"submission") * 5 + rLvlAbt(target,actor,"domination") * -10
							 + rLvlAbt(target,actor,"enmity") * -10;
		var statsFactor = quantifyCharacterStats(actor) - quantifyCharacterStats(target) * 1.2;
		desire = baseDifficulty + moodFactor + relationshipFactor + statsFactor;
		var desireString = "Desire" + getDesireTooltip() + ": Base difficulty (" + baseDifficulty.toFixed(2) + ") + Mood (" + moodFactor.toFixed(2) + ") + Relationship ("
						 + relationshipFactor.toFixed(2) + ") + Stats (" + statsFactor.toFixed(2) + ") = Total (" + desire.toFixed(2) + ").";
		
		return [desire,desireString];
	}
	
	sist.isSuccessful = function(actor,target) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		
		var baseDifficulty = 75; // 50;
		var targetMoodFactor = gC(target).mood.submissive * 0.3 + gC(target).mood.dominant * -0.5 + gC(target).mood.intimate * 0.2
							 + gC(target).mood.aroused * 0.1 + gC(target).mood.bored * -0.2 + gC(target).mood.angry * -0.5;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 3 + rLvlAbt(target,actor,"sexualTension") * 1
							 + rLvlAbt(target,actor,"submission") * 4 + rLvlAbt(target,actor,"domination") * -5
							 + rLvlAbt(target,actor,"enmity") * -5 + rLvlAbt(target,actor,"rivalry") * -3;
		var competitionFactor = 0;
		var infamyFactor = 0;
		var drivesFactor = gC(target).dDomination.level * -2 + gC(target).dAmbition.level * -2;
		
		if ( gC(target).type == "candidate" ) { // More likely to accept if weaker than the average candidate and weaker than potential tutor
			var averageStr = quantifyAverageCandidateVacuumStrength();
			var selfStr = quantifyCharacterVacuumStrength(target);
			var actStr = quantifyCharacterVacuumStrength(actor);
			if ( selfStr < averageStr && actStr > (selfStr * 1.1) ) {
				competitionFactor += 10;
				competitionFactor += (actStr - selfStr);
				drivesFactor += gC(target).dImprovement * 4 + gC(target).dCooperation * 2;
			} else {
				competitionFactor -= 50;
			}
		}
		if ( gC(actor).infamy > gC(target).infamy ) {
			infamyFactor = ( gC(actor).infamy - gC(target).infamy ) * 2;
		}
		
		
		var willpowerCostFactor = this.getWillpowerRejectCost(actor,target) / 2;
							 
		var semifinalValue = targetMoodFactor + relationshipFactor + competitionFactor + infamyFactor + drivesFactor + willpowerCostFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		if ( finalValue >= baseDifficulty ) { result = true; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Competition: " + competitionFactor.toFixed(2) + ", Infamy: " + infamyFactor.toFixed(2) + ", Drives: " + drivesFactor + ", Willpower cost: " + willpowerCostFactor.toFixed(2) + ", Luck: " + luckFactor.toFixed(2)
					  + " -> Result: " + finalValue.toFixed(2) + " VS Difficulty: " + baseDifficulty;
		
		secondStringResult = gC(actor).getFormattedName() + " invited " + gC(target).getFormattedName() + " to become " + gC(target).posPr + " tutor and " + gC(target).perPr;
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
		
		return [result,stringResult,secondStringResult];	
	}
	sist.getFailMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing bored.";
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		gC(target).mood.bored += 10;
		if ( gC(target).mood.bored > 100 ) {
			gC(target).mood.bored = 100;
		}
	}
	sist.getSuccessMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " agreed. " + gC(target).formattedName + " will now be learning from you.";
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			
			var bText = "<<l" + "ink [[Continue|Social Interactions]]>><<s" + "cript>>\n";
			bText    += "createRelTypeTutorshipDom('" + actor + "','" + target + "'," + gSettings().relationshipsDuration + ");\n";
			bText	 += "createRelTypeTutorshipSub('" + target + "','" + actor + "'," + gSettings().relationshipsDuration + ");\n";
			bText	 += "State.variables.sisSpecifics.flagSissEnd = false;\n";
			bText	 += "<</s" + "cript>><</l" + "ink>>";
			
			State.variables.sisSpecifics.formatChoicesText();
			
			State.variables.sisSpecifics.continueButton = bText;
		} else {
			createRelTypeTutorshipDom(actor,target,gSettings().relationshipsDuration);
			createRelTypeTutorshipSub(target,actor,gSettings().relationshipsDuration);
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " wants to initiate a tutorship relationship with you as " + gC(actor).posPr + " pupil.\n\n"
					   + this.getButtonPlayerAccepts(actor);
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,"default",this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		var bText = "<<l" + "ink [[Accept|Social Interactions]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "createSistOfferTutorshipAsTutor.getSuccessEffect('" + actor + "','chPlayerCharacter');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	return sist;
}
window.createSistOfferTutorshipAsPupil = function() {
	var sist = new sisTopic("Invite to initiate Tutorship Relationship as your Tutor");
	sist.subtitle += '<span title="' + relTypeTutorshipTooltip() + '">^^(?)^^</span>';
	sist.sT = setup.sistType.tutorshipAsPupil;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		// Target is candidate, actor and target have no special relationship, actor has no submissive, target has no dominant,
		// special relationships are allowed
		if ( ( gRelTypeAb(actor,target) == null ) && ( gC(target).domChar == null ) && ( gC(actor).domChar == null )
		  && ( gC(actor).subChars.length < 1 ) && ( State.variables.settings.relationshipTypesAllowed ) && ((gC(target).followingTo == "") || (gC(target).followingTo == actor) ) ) {
			flagPossible = true;
		}
		return flagPossible;
	}
	
	sist.getSocialdriveOfferCost = function(actor,target) {
		return 25;
	}
	
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var baseDifficulty = 10;
		var moodFactor = gC(target).mood.friendly * 0.05 + gC(target).mood.intimate * 0.1 - gC(target).mood.angry * 0.5 - gC(target).mood.bored * 0.3
					   -  gC(target).mood.submissive * 0.1 + gC(target).mood.dominant * 0.05;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 5 + rLvlAbt(target,actor,"sexualTension") * 2
							 + rLvlAbt(target,actor,"submission") * -5 + rLvlAbt(target,actor,"domination") * 2
							 + rLvlAbt(target,actor,"enmity") * -10;
		var statsFactor = quantifyCharacterStats(target) - quantifyCharacterStats(actor) * 1.2;
		desire = baseDifficulty + moodFactor + relationshipFactor + statsFactor;
		var desireString = "Desire" + getDesireTooltip() + ": Base difficulty (" + baseDifficulty.toFixed(2) + ") + Mood (" + moodFactor.toFixed(2) + ") + Relationship ("
						 + relationshipFactor.toFixed(2) + ") + Stats (" + statsFactor.toFixed(2) + ") = Total (" + desire.toFixed(2) + ").";
		
		return [desire,desireString];
	}
	
	
	sist.isSuccessful = function(actor,target) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		
		var baseDifficulty = 25; // 25;
		var targetMoodFactor = gC(target).mood.submissive * -0.4 + gC(target).mood.dominant * 0.6 + gC(target).mood.intimate * 0.3
							 + gC(target).mood.aroused * 0.15 + gC(target).mood.bored * -0.2 + gC(target).mood.angry * -0.4;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 6 + rLvlAbt(target,actor,"sexualTension") * 3
							 + rLvlAbt(target,actor,"submission") * -4 + rLvlAbt(target,actor,"domination") * 8
							 + rLvlAbt(target,actor,"enmity") * -5 + rLvlAbt(target,actor,"rivalry") * 1;
		var competitionFactor = 0;
		var willpowerCostFactor = this.getWillpowerRejectCost(actor,target) / 2;
		
		if ( gC(target).type == "candidate" ) { // More likely to accept if weaker than the average candidate and weaker than potential tutor
			var averageStr = quantifyAverageCandidateVacuumStrength();
			var selfStr = quantifyCharacterVacuumStrength(target);
			var actStr = quantifyCharacterVacuumStrength(actor);
			if ( actStr < averageStr && (actStr * 1.1) < selfStr ) {
				competitionFactor += 10;
			} else {
				competitionFactor -= 50;
			}
		}
							 
		var semifinalValue = targetMoodFactor + relationshipFactor + competitionFactor + willpowerCostFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		if ( finalValue >= baseDifficulty ) { result = true; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Competition: " + competitionFactor.toFixed(2) + ", Willpower cost: " + willpowerCostFactor.toFixed(2) + ", Luck: " + luckFactor.toFixed(2)
					  + " -> Result: " + finalValue.toFixed(2) + " VS Difficulty: " + baseDifficulty;
		
		secondStringResult = gC(actor).getFormattedName() + " invited " + gC(target).getFormattedName() + " to become " + gC(target).posPr + " pupil and " + gC(target).perPr;
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
		
		return [result,stringResult,secondStringResult];	
	}
	sist.getFailMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing bored.";
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		gC(target).mood.bored += 10;
		if ( gC(target).mood.bored > 100 ) {
			gC(target).mood.bored = 100;
		}
	}
	sist.getSuccessMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " agreed. " + gC(target).formattedName + " will now expect you to listen to " + gC(target).comPr + ".";
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			
			var bText = "<<l" + "ink [[Continue|Social Interactions]]>><<s" + "cript>>\n";
			bText    += "createRelTypeTutorshipSub('" + actor + "','" + target + "'," + gSettings().relationshipsDuration + ");\n";
			bText	 += "createRelTypeTutorshipDom('" + target + "','" + actor + "'," + gSettings().relationshipsDuration + ");\n";
			bText	 += "State.variables.sisSpecifics.flagSissEnd = false;\n";
			bText	 += "<</s" + "cript>><</l" + "ink>>";
			
			State.variables.sisSpecifics.formatChoicesText();
			
			State.variables.sisSpecifics.continueButton = bText;
		} else {
			createRelTypeTutorshipDom(target,actor,gSettings().relationshipsDuration);
			createRelTypeTutorshipSub(actor,target,gSettings().relationshipsDuration);
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " wants to initiate a tutorship relationship with you as " + gC(actor).posPr + " tutor.\n\n"
					   + this.getButtonPlayerAccepts(actor);
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,"default",this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		var bText = "<<l" + "ink [[Accept|Social Interactions]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "createSistOfferTutorshipAsPupil.getSuccessEffect('" + actor + "','chPlayerCharacter');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	return sist;
}

window.createSistOfferCompanionship = function() {
	var sist = new sisTopic("Invite to initiate Companionship Relationship");
	sist.subtitle += '<span title="' + relTypeCompanionshipTooltip() + '">^^(?)^^</span>';
	sist.sT = setup.sistType.companionship;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		// Target is candidate, actor and target have no special relationship
		// special relationships are allowed
		if ( ( gRelTypeAb(actor,target) == null )
		  && ( State.variables.settings.relationshipTypesAllowed ) && ((gC(target).followingTo == "") || (gC(target).followingTo == actor) ) ) {
			flagPossible = true;
		}
		return flagPossible;
	}
	
	sist.getSocialdriveOfferCost = function(actor,target) {
		return 25;
	}
	
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var baseDifficulty = -10;
		var moodFactor = gC(target).mood.friendly * 0.05 + gC(target).mood.intimate * 0.1 - gC(target).mood.angry * 0.5 - gC(target).mood.bored * 0.3
					   +  gC(target).mood.submissive * 0.05 - gC(target).mood.dominant * 0.05;
		var relationshipFactor = rLvlAbt(target,actor,"friendship") * 5 + rLvlAbt(target,actor,"romance") * 5 + rLvlAbt(target,actor,"sexualTension") * 2
							 + rLvlAbt(target,actor,"submission") * 5 - rLvlAbt(target,actor,"domination") * 10
							 + rLvlAbt(target,actor,"rivalry") * -5 + rLvlAbt(target,actor,"enmity") * -10;
		var statsFactor = (quantifyCharacterStats(actor) - quantifyCharacterStats(target) * 1.2) / 9;
		desire = baseDifficulty + moodFactor + relationshipFactor + statsFactor;
		var desireString = "Desire" + getDesireTooltip() + ": Base difficulty (" + baseDifficulty.toFixed(2) + ") + Mood (" + moodFactor.toFixed(2) + ") + Relationship ("
						 + relationshipFactor.toFixed(2) + ") + Stats (" + statsFactor.toFixed(2) + ") = Total (" + desire.toFixed(2) + ").";
		
		return [desire,desireString];
	}
	
	
	sist.isSuccessful = function(actor,target) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		
		var baseDifficulty = 50; // 50;
		var targetMoodFactor = gC(target).mood.submissive * 0.2 + gC(target).mood.dominant * -0.6 + gC(target).mood.intimate * 0.4
							 + gC(target).mood.friendly * 0.2 + gC(target).mood.bored * -0.2 + gC(target).mood.angry * -0.4;
		var relationshipFactor = rLvlAbt(target,actor,"friendship") * 4 + rLvlAbt(target,actor,"romance") * 6 + rLvlAbt(target,actor,"sexualTension") * 2
							 + rLvlAbt(target,actor,"submission") * 4 + rLvlAbt(target,actor,"domination") * -6
							 + rLvlAbt(target,actor,"enmity") * -6 + rLvlAbt(target,actor,"rivalry") * -4;
		var competitionFactor = (quantifyCharacterVacuumStrength(actor) - quantifyCharacterVacuumStrength(target)) / 9;
		var drivesFactor = gC(target).dCooperation.level * 4 + gC(target).dLove.level * 2 - gC(target).dDomination.level * 4 - gC(target).dAmbition.level * 1;
		var willpowerCostFactor = this.getWillpowerRejectCost(actor,target) / 2;
							 
		var semifinalValue = targetMoodFactor + relationshipFactor + competitionFactor + drivesFactor + willpowerCostFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		if ( finalValue >= baseDifficulty ) { result = true; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Competition: " + competitionFactor.toFixed(2) + ", Willpower cost: " + willpowerCostFactor.toFixed(2) + ", Drives factor: " + drivesFactor.toFixed(2) + ", Luck: " + luckFactor.toFixed(2)
					  + " -> Result: " + finalValue.toFixed(2) + " VS Difficulty: " + baseDifficulty;
		
		secondStringResult = gC(actor).getFormattedName() + " invited " + gC(target).getFormattedName() + " to become " + gC(target).posPr + " companion and ";
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
		
		return [result,stringResult,secondStringResult];	
	}
	sist.getFailMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing bored.";
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		gC(target).mood.bored += 10;
		if ( gC(target).mood.bored > 100 ) {
			gC(target).mood.bored = 100;
		}
		if ( target == "chPlayerCharacter" ) {
			gC(actor).mission = "raiseFriendship";
		}
	}
	sist.getSuccessMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " agreed. " + gC(target).formattedName + " will now look after you.";
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			
			var bText = "<<l" + "ink [[Continue|Social Interactions]]>><<s" + "cript>>\n";
			bText    += "createRelTypeCompanionship('" + actor + "','" + target + "'," + gSettings().relationshipsDuration + ");\n";
			bText	 += "createRelTypeCompanionship('" + target + "','" + actor + "'," + gSettings().relationshipsDuration + ");\n";
			bText	 += "State.variables.sisSpecifics.flagSissEnd = false;\n";
			bText	 += "<</s" + "cript>><</l" + "ink>>";
			
			State.variables.sisSpecifics.formatChoicesText();
			
			State.variables.sisSpecifics.continueButton = bText;
		} else {
			createRelTypeCompanionship(target,actor,gSettings().relationshipsDuration);
			createRelTypeCompanionship(actor,target,gSettings().relationshipsDuration);
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " wants to initiate a companionship relationship with you.\n\n"
					   + this.getButtonPlayerAccepts(actor);
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,"default",this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		var bText = "<<l" + "ink [[Accept|Social Interactions]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "createSistOfferCompanionship().getSuccessEffect('" + actor + "','chPlayerCharacter');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	return sist;
}

	// Bondage
window.createSistUnlockTargetsGenitals = function() {
	var sist = new sisTopic("Unlock target's genitals");
	sist.subtitle += '<span title="' + "If the target has genitals locked by items owned by the actor, these will be freed. If the target has locked their own genitals and is the actor's submissive, those will be unlocked as well." + '">^^(?)^^</span>';
	sist.sT = setup.sistType.unlockTargetsGenitals;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		var unlockableGenitals = [];
		// Unlockable by actor
		unlockableGenitals = getActorsGenitalsLockedByTarget(target,actor);
		// Unlockable by target
		if ( gC(target).domChar == actor ) {
			unlockableGenitals = unlockableGenitals.concat(getActorsGenitalsLockedByTarget(target,target));
		}
		if ( unlockableGenitals.length > 0 ) { flagPossible = true; }
		return flagPossible;
	}
	
	sist.getSocialdriveOfferCost = function(actor,target) {
		return 0;
	}
	
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var desireString = "";
		
		return [desire,desireString];
	}
	
	
	sist.isSuccessful = function(actor,target) {
		var result = true;
		var stringResult = "Success.";
		var secondStringResult = gC(actor).getFormattedName() + " unlocked " + gC(target).getFormattedName() + "'s locked lower parts.";
				
		return [result,stringResult,secondStringResult];	
	}
	sist.getFailMessage = function(actor,target) {
		var message = "This shouldn't happen.";
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		
	}
	sist.getSuccessMessage = function(actor,target) {
		var message = "You unlocked " + gC(target).getFormattedName() + "'s sex.";
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
		var unlockableGenitals = [];
		unlockableGenitals = getActorsGenitalsLockedByTarget(target,actor);
		if ( gC(target).domChar == actor ) {
			unlockableGenitals = unlockableGenitals.concat(getActorsGenitalsLockedByTarget(target,target));
		}
		for ( var genital of unlockableGenitals ) {
			applyAlteredState([target],createUnlockedBodypartForTheDay(genital));
		}
		
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			
			var bText = "<<l" + "ink [[Continue|Social Interactions]]>><<s" + "cript>>\n";
			bText 	 += "State.variables.sisSpecifics.cleanSiss();\n";
			bText	 += "<</s" + "cript>><</l" + "ink>>";
			
			State.variables.sisSpecifics.formatChoicesText();
			
			State.variables.sisSpecifics.continueButton = bText;
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " is unlocking your nethers.\n\n"
					   + this.getButtonPlayerAccepts(actor);
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,"noExtra",0,actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		var bText = "<<l" + "ink [[Accept|Social Interactions]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "createSistUnlockTargetsGenitals().getSuccessEffect('" + actor + "','chPlayerCharacter');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	return sist;
}

window.createSistUnlockActorsGenitals = function() {
	var sist = new sisTopic("Unlock own genitals");
	sist.subtitle += '<span title="' + "If the actor has genitals locked by items owned by the target, these will be freed, if the target agrees." + '">^^(?)^^</span>';
	sist.sT = setup.sistType.unlockActorsGenitals;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		var unlockableGenitals = [];
		// Unlockable by actor
		unlockableGenitals = getActorsGenitalsLockedByTarget(actor,target);
		if ( unlockableGenitals.length > 0 ) { flagPossible = true; }
		return flagPossible;
	}
	
	sist.getSocialdriveOfferCost = function(actor,target) {
		return 5;
	}
	
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var desireString = "Desire" + getDesireTooltip() + ": 0";
		
		return [desire,desireString];
	}
		
	sist.isSuccessful = function(actor,target) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		
		var baseDifficulty = 30; // 30;
		var targetMoodFactor = gC(target).mood.friendly * 0.02 + gC(target).mood.intimate * 0.03 + gC(target).mood.aroused * 0.04 + gC(target).mood.flirty * 0.06 - gC(target).mood.angry * 0.5 - gC(target).mood.bored * 0.3 + gC(target).mood.submissive * 0.05 - gC(target).mood.dominant * 0.2;
		var relationshipFactor = rLvlAbt(target,actor,"friendship") * 2 + rLvlAbt(target,actor,"romance") * 1 + rLvlAbt(target,actor,"sexualTension") * 2
							 + rLvlAbt(target,actor,"submission") * 2 - rLvlAbt(target,actor,"domination") * 8
							 + rLvlAbt(target,actor,"rivalry") * -5 + rLvlAbt(target,actor,"enmity") * -10;
		var drivesFactor = gC(target).dCooperation.level * 2 + gC(target).dLove.level * 2 - gC(target).dDomination.level * 4;
		var willpowerCostFactor = 0;
							 
		var semifinalValue = targetMoodFactor + relationshipFactor + drivesFactor + willpowerCostFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		if ( finalValue >= baseDifficulty ) { result = true; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Drives factor: " + drivesFactor.toFixed(2) + ", Luck: " + luckFactor.toFixed(2)
					  + " -> Result: " + finalValue.toFixed(2) + " VS Difficulty: " + baseDifficulty;
		
		secondStringResult = gC(actor).getFormattedName() + " asked " + gC(target).getFormattedName() + " to free " + gC(target).posPr + " lower parts and " + gC(target).perPr;
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
		
		return [result,stringResult,secondStringResult];	
	}
	sist.getFailMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing bored, yet confident." + gC(actor).formattedName + " is growing frustrated.\n"
					+ colorText(("Your submission towards " + gC(target).getName() + " has slightly grown."),"purple");
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		gC(target).mood.bored += 5;
		if ( gC(target).mood.bored > 100 ) {
			gC(target).mood.bored = 100;
		}
		gC(target).mood.dominant += 5;
		if ( gC(target).mood.dominant > 100 ) {
			gC(target).mood.dominant = 100;
		}
		gC(actor).mood.aroused += 10;
		if ( gC(actor).mood.aroused > 100 ) {
			gC(actor).mood.aroused = 100;
		}
		gC(actor).mood.submissive += 10;
		if ( gC(actor).mood.submissive > 100 ) {
			gC(actor).mood.submissive = 100;
		}
		gC(actor).mood.angry += 5;
		if ( gC(actor).mood.angry > 100 ) {
			gC(actor).mood.angry = 100;
		}
		// Relationship changes
		getRelation(actor,target).submission.stv += 20;
	}
	sist.getSuccessMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " agreed. " + gC(target).getFormattedName() + " will free your nethers.\n"
					+ "You are rapidly growing submissive and horny.\n"
					+ colorText(("Your submission and friendship towards " + gC(target).getName() + " are growing."),"purple");
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
		// Altered states
		var unlockableGenitals = [];
		unlockableGenitals = getActorsGenitalsLockedByTarget(actor,target);
		for ( var genital of unlockableGenitals ) {
			applyAlteredState([actor],createUnlockedBodypartForTheDay(genital));
		}
		// High submission
		gC(actor).mood.submissive += 50;
		if ( gC(actor).mood.submissive > 100 ) {
			gC(actor).mood.submissive = 100;
		}
		gC(actor).mood.aroused += 25;
		if ( gC(actor).mood.aroused > 100 ) {
			gC(actor).mood.aroused = 100;
		}
		// Relationship changes
		getRelation(actor,target).submission.stv += 40;
		getRelation(actor,target).friendship.stv += 40;
		
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			
			var bText = "<<l" + "ink [[Continue|Social Interactions]]>><<s" + "cript>>\n";
			bText 	 += "State.variables.sisSpecifics.cleanSiss();\n";
			bText	 += "<</s" + "cript>><</l" + "ink>>";
			
			State.variables.sisSpecifics.formatChoicesText();
			
			State.variables.sisSpecifics.continueButton = bText;
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " is asking you to free " + gC(target).posPr + " private parts.\n\n"
					   + this.getButtonPlayerAccepts(actor);
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,"default",this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		var bText = "<<l" + "ink [[Accept|Social Interactions]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "createSistUnlockActorsGenitals().getSuccessEffect('" + actor + "','chPlayerCharacter');\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
	return sist;
}

	// Transformations
window.createSistTransformationScene = function() {
	var sist = new sisTopic("Ask to be transformed");
	sist.sT = setup.sistType.transformSelf;
	sist.isPossible = function(actor,target) {
		var flagPossible = false;
		if ( isLewdingPossible(actor,target) && ( State.variables.compass.findFirstSisIdInvolvingCharacter(actor) != -1 ) && ((gC(target).followingTo == "") || (gC(target).followingTo == actor) ) ) {
			if ( getSisCharIsIn(actor).getValidProposedCharacters(actor).includes(target) && getValidTfActors().includes(target) && doesCharHaveState(actor,"Tfmd") == false ) {
				flagPossible = true;
			}
		}
		return flagPossible;
	}
	
	sist.getDesire = function(actor,target) {
		var desire = 0;
		var baseDifficulty = -20;
		var moodFactor = gC(target).mood.flirty * 0.03 + gC(target).mood.aroused * 0.08 - gC(target).mood.angry * 0.5 - gC(target).mood.bored * 0.5
					   +  gC(target).mood.submissive * 0.05 - gC(target).mood.dominant * 0.15;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 3 + rLvlAbt(target,actor,"sexualTension") * 6
							 + rLvlAbt(target,actor,"submission") * 4 + rLvlAbt(target,actor,"domination") * -8
							 + rLvlAbt(target,actor,"enmity") * -12;
		var statsFactor = gCstat(actor,"charisma") - gCstat(target,"will");
		var hadSexFactor = gC(target).daysWithoutSex * 2 - gC(target).sexScenesToday * 6;
		var missingLustFactor = (1 - getBarPercentage(target,"lust")) * 35;
		var othersFactor = 0;
		if ( target == "chMes" ) { othersFactor += 20; }
		desire = baseDifficulty + moodFactor + relationshipFactor + statsFactor + missingLustFactor + hadSexFactor + othersFactor;
		var desireString = "Desire" + getDesireTooltip() + ": Base difficulty (" + baseDifficulty.toFixed(2) + ") + Mood (" + moodFactor.toFixed(2) + ") + Relationship ("
						 + relationshipFactor.toFixed(2) + ") + Stats (" + statsFactor.toFixed(2) + ") + Lust (" + missingLustFactor.toFixed(2) + ") + Sex life (" + hadSexFactor.toFixed(2) + ") + Others (" + othersFactor.toFixed(2) + ") = Total (" + desire.toFixed(2) + ").";
		
		return [desire,desireString];
	}
	
	sist.doesCharJoinGroup = function(charKey,actor,charList) {		
		return false;
	}
	
	sist.isSuccessful = function(actor,target) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		var relType = gRelTypeAb(target,actor);
		
		if ( relType ) {
			if ( relType.forcedToSex ) {
				result = true;
				stringResult = gC(target).getFormattedName() + " is bound by your relationship to accept.";
			}
		}
		if ( result == false ) {
		var baseDifficulty = -20; // -20
		var targetMoodFactor = gC(target).mood.flirty * 0.03 + gC(target).mood.intimate * 0.05 + gC(target).mood.aroused * 0.11
							 + gC(target).mood.angry * -0.4 + gC(target).mood.bored * (-0.4) + gC(target).mood.submissive * 0.1
							 + gC(target).mood.dominant * -0.25;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 0.8 + rLvlAbt(target,actor,"sexualTension") * 1.6
							 + rLvlAbt(target,actor,"submission") * 2 + rLvlAbt(target,actor,"domination") * -2.4
							 + rLvlAbt(target,actor,"enmity") * -5 + rLvlAbt(target,actor,"rivalry") * -0.8
		var willpowerCostFactor = this.getWillpowerRejectCost(actor,target) / 2;
		var drivesFactor = gC(target).dPleasure.level * 3 + gC(target).dImprovement.level * 1 - gC(target).dDomination.level * 2;
		var powerGrowthFactor = -((quantifyCharacterStats(target) - 110) / 11);
		if ( powerGrowthFactor < 0 ) { powerGrowthFactor = 0; }
		var simulationState = 0;
		if ( State.variables.simCycPar.templeDayPeriod == "training" ) {
			simulationState = -10;
		}
		if ( returnCharsUnlockedGenitals(target).length == 0 ) {
			simulationState -= 20;
		}
		var missionFactor = 0;
		if ( gC(target).mission == "haveSex" ) { missionFactor += 5; }
		else if ( gC(target).mission == "haveDomSex" ) { missionFactor -= 10; }
		var othersFactor = 0;
		if ( target == "chMes" ) { othersFactor += 20; }
		
		var semifinalValue = targetMoodFactor + relationshipFactor + baseDifficulty + simulationState + willpowerCostFactor + drivesFactor + missionFactor + powerGrowthFactor + othersFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		result = false;
		if ( finalValue >= 0 ) { result = true; }
		secondStringResult = gC(actor).getFormattedName() + " asked " + gC(target).getFormattedName() + " to perform a transformation and ";
		if ( result ) { stringResult = "Success!"; secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { stringResult = "Failure."; secondStringResult += gC(target).perPr + " refused."; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Base dif.: " + baseDifficulty
					  + ", Others: " + simulationState + ", Luck: " + luckFactor.toFixed(2) + ", Drives: " + drivesFactor.toFixed(2) + ", Desire: " + willpowerCostFactor.toFixed(2) + ", Intentions: " + missionFactor.toFixed(2) + ", Growth: " + powerGrowthFactor.toFixed(2) + ", Others: " + othersFactor.toFixed(2) + " - Result: " + finalValue.toFixed(2);
		}
		
		secondStringResult = gC(actor).getFormattedName() + " asked " + gC(target).getFormattedName() + " to perform a transformation and ";
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
		
		return [result,stringResult,secondStringResult];		
	}
	sist.getFailMessage = function(actor,target) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing bored.";
		return message;
	}
	sist.getFailEffect = function(actor,target) {
		gC(target).mood.bored += 10;
		if ( gC(target).mood.bored > 100 ) {
			gC(target).mood.bored = 100;
		}
	}
	sist.getSuccessMessage = function(actor,target) {
		var sisId = State.variables.compass.findFirstSisIdInvolvingCharacter(actor);
		var sisCharList = State.variables.compass.sisList[sisId].charList;
		var joinedGroup = getCharGroup(actor).concat(getCharGroup(target));
		var message = firstToCap(gC(target).perPr) + " agreed. You both leave to a secluded place...";
		return message;
	}
	sist.getSuccessEffect = function(actor,target) {
			
		var sisId = State.variables.compass.findFirstSisIdInvolvingCharacter(actor);
		var sisCharList = State.variables.compass.sisList[sisId].charList;
		var joinedGroup = getCharGroup(actor).concat(getCharGroup(target));
		
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			var addCharsString = [];
			
			var bText = "<<l" + "ink [[Continue|TF Std Menu]]>><<s" + "cript>>\n";
			bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['" + target + "'].concat([" + addCharsString + "]),sistTransformationEffects);\n";
			bText	 += "State.variables.tfTarget = 'chPlayerCharacter';State.variables.tfActor = '" + target + "';"
					  + "updateSelectedTransformationsText('chPlayerCharacter','" + State.variables.tfActor + "','TF Std Menu');<</s" + "cript>><</l"
					  + "ink>>";
			State.variables.sisSpecifics.continueButton = bText;
		} else {
			//genericSistEffects(getCharGroup(actor),getCharGroup(target).concat(additionalChars));
			//sistEgalitarianSexEffects([actor],[target],additionalChars);
		}
	}
	sist.askToPlayer = function(actor,target,sisKey) {
		var promptText = gC(actor).getFormattedName() + " wants you to perform a transformation on " + gC(actor).comPr + ".\n" + this.getDesire(actor,target)[1] + "\n\n"
					   + this.getButtonPlayerAccepts(actor);
		var promptMode = "default";
		if ( gRelTypeAb("chPlayerCharacter",actor) ) {
			if ( gRelTypeAb("chPlayerCharacter",actor).forcedToSex ) {
				promptMode = "relTypeForcesToAccept";
			}
		}
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,promptMode,this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor) {
		var sisId = State.variables.compass.findFirstSisIdInvolvingCharacter(actor);
		var sisCharList = State.variables.compass.sisList[sisId].charList;
		var joinedGroup = getCharGroup(actor).concat(getCharGroup("chPlayerCharacter"));
		
		var addCharsString = [];
		
		var bText = "<<l" + "ink [[Accept|Scene]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['chPlayerCharacter'].concat([" + addCharsString + "]),sistTransformationEffects);\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		
		return bText;
	}
	return sist;
}

window.createSistSubTransformationScene = function() {
	var sist = new sisTopic("Ask to transform sub");
	sist.sT = setup.sistType.transformSub;
	sist.getTitle = function(targetSub) {
		return "Ask to transform " + gC(targetSub).name;
	}
	sist.isPossible = function(actor,target,targetSub) {
		var flagPossible = false;
		if ( isLewdingPossible(actor,target) && ( State.variables.compass.findFirstSisIdInvolvingCharacter(actor) != -1 ) && ((gC(target).followingTo == "") || (gC(target).followingTo == actor) ) ) {
			if ( getSisCharIsIn(actor).getValidProposedCharacters(actor).includes(target) && getValidTfActors().includes(target) && doesCharHaveState(targetSub,"Tfmd") == false && gC(actor).subChars.includes(targetSub) && gC(actor).followedBy.includes(targetSub) ) {
				flagPossible = true;
			}
		}
		return flagPossible;
	}
	
	sist.getDesire = function(actor,target,targetSub) {
		var desire = 0;
		var baseDifficulty = -20;
		var moodFactor = gC(target).mood.flirty * 0.03 + gC(target).mood.aroused * 0.08 - gC(target).mood.angry * 0.5 - gC(target).mood.bored * 0.5
					   +  gC(target).mood.submissive * 0.05 - gC(target).mood.dominant * 0.15;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 3 + rLvlAbt(target,targetSub,"sexualTension") * 6
							 + rLvlAbt(target,actor,"submission") * 4 + rLvlAbt(target,actor,"domination") * -8
							 + rLvlAbt(target,actor,"enmity") * -12;
		var statsFactor = gCstat(actor,"charisma") - gCstat(target,"will");
		var hadSexFactor = gC(target).daysWithoutSex * 2 - gC(target).sexScenesToday * 6;
		var missingLustFactor = (1 - getBarPercentage(target,"lust")) * 35;
		var othersFactor = 0;
		if ( target == "chMes" ) { othersFactor += 20; }
		desire = baseDifficulty + moodFactor + relationshipFactor + statsFactor + missingLustFactor + hadSexFactor + othersFactor;
		var desireString = "Desire" + getDesireTooltip() + ": Base difficulty (" + baseDifficulty.toFixed(2) + ") + Mood (" + moodFactor.toFixed(2) + ") + Relationship ("
						 + relationshipFactor.toFixed(2) + ") + Stats (" + statsFactor.toFixed(2) + ") + Lust (" + missingLustFactor.toFixed(2) + ") + Sex life (" + hadSexFactor.toFixed(2) + ") + Others (" + othersFactor.toFixed(2) + ") = Total (" + desire.toFixed(2) + ").";
		
		return [desire,desireString];
	}
	
	sist.doesCharJoinGroup = function(charKey,actor,charList) {		
		return false;
	}
	
	sist.isSuccessful = function(actor,target,targetSub) {
		var result = false;
		var stringResult = "";
		var secondStringResult = "";
		var relType = gRelTypeAb(target,actor);
		
		if ( relType ) {
			if ( relType.forcedToSex ) {
				result = true;
				stringResult = gC(target).getFormattedName() + " is bound by your relationship to accept.";
			}
		}
		if ( result == false ) {
		var baseDifficulty = -20; // -20
		var targetMoodFactor = gC(target).mood.flirty * 0.03 + gC(target).mood.intimate * 0.05 + gC(target).mood.aroused * 0.11
							 + gC(target).mood.angry * -0.4 + gC(target).mood.bored * (-0.4) + gC(target).mood.submissive * 0.1
							 + gC(target).mood.dominant * -0.25;
		var relationshipFactor = rLvlAbt(target,actor,"romance") * 0.8 + rLvlAbt(target,targetSub,"sexualTension") * 1.6
							 + rLvlAbt(target,actor,"submission") * 2 + rLvlAbt(target,actor,"domination") * -2.4
							 + rLvlAbt(target,actor,"enmity") * -5 + rLvlAbt(target,actor,"rivalry") * -0.8
		var willpowerCostFactor = this.getWillpowerRejectCost(actor,target) / 2;
		var drivesFactor = gC(target).dPleasure.level * 3 + gC(target).dImprovement.level * 1 - gC(target).dDomination.level * 2;
		var powerGrowthFactor = -((quantifyCharacterStats(target) - 110) / 11);
		if ( powerGrowthFactor < 0 ) { powerGrowthFactor = 0; }
		var simulationState = 0;
		if ( State.variables.simCycPar.templeDayPeriod == "training" ) {
			simulationState = -10;
		}
		if ( returnCharsUnlockedGenitals(target).length == 0 ) {
			simulationState -= 20;
		}
		var missionFactor = 0;
		if ( gC(target).mission == "haveSex" ) { missionFactor += 5; }
		else if ( gC(target).mission == "haveDomSex" ) { missionFactor -= 10; }
		var othersFactor = 0;
		if ( target == "chMes" ) { othersFactor += 20; }
		
		var semifinalValue = targetMoodFactor + relationshipFactor + baseDifficulty + simulationState + willpowerCostFactor + drivesFactor + missionFactor + powerGrowthFactor + othersFactor;
		var sfvTenth = semifinalValue * 0.1;
		var diceThrow = luckedDiceThrow(gC(actor).luck.getValue());
		var luckFactor = (sfvTenth * 2 * diceThrow) - sfvTenth;
		
		var finalValue = semifinalValue + luckFactor;
		result = false;
		if ( finalValue >= 0 ) { result = true; }
		secondStringResult = gC(actor).getFormattedName() + " asked " + gC(target).getFormattedName() + " to perform a transformation on " + gC(targetSub).getFormattedName() + " and ";
		if ( result ) { stringResult = "Success!"; secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { stringResult = "Failure."; secondStringResult += gC(target).perPr + " refused."; }
		stringResult += " Mood: " + targetMoodFactor.toFixed(2) + ", Relationship: " + relationshipFactor.toFixed(2) + ", Base dif.: " + baseDifficulty
					  + ", Others: " + simulationState + ", Luck: " + luckFactor.toFixed(2) + ", Drives: " + drivesFactor.toFixed(2) + ", Desire: " + willpowerCostFactor.toFixed(2) + ", Intentions: " + missionFactor.toFixed(2) + ", Growth: " + powerGrowthFactor.toFixed(2) + ", Others: " + othersFactor.toFixed(2) + " - Result: " + finalValue.toFixed(2);
		}
		
		secondStringResult = gC(actor).getFormattedName() + " asked " + gC(target).getFormattedName() + " to perform a transformation on " + gC(targetSub).getFormattedName() + " and ";
		if ( result ) { secondStringResult += gC(target).perPr + " accepted."; }
		else 		  { secondStringResult += gC(target).perPr + " refused."; }
		
		return [result,stringResult,secondStringResult];		
	}
	sist.getFailMessage = function(actor,target,targetSub) {
		var message = firstToCap(gC(target).perPr) + " refused. " + gC(target).formattedName + " is growing bored.";
		return message;
	}
	sist.getFailEffect = function(actor,target,targetSub) {
		gC(target).mood.bored += 10;
		if ( gC(target).mood.bored > 100 ) {
			gC(target).mood.bored = 100;
		}
	}
	sist.getSuccessMessage = function(actor,target,targetSub) {
		var sisId = State.variables.compass.findFirstSisIdInvolvingCharacter(actor);
		var sisCharList = State.variables.compass.sisList[sisId].charList;
		var joinedGroup = getCharGroup(actor).concat(getCharGroup(target));
		var message = firstToCap(gC(target).perPr) + " agreed. You both leave to a secluded place...";
		return message;
	}
	sist.getSuccessEffect = function(actor,target,targetSub) {
		var sisId = State.variables.compass.findFirstSisIdInvolvingCharacter(actor);
		var sisCharList = State.variables.compass.sisList[sisId].charList;
		var joinedGroup = getCharGroup(actor).concat(getCharGroup(target));
		
		if ( actor == "chPlayerCharacter" ) {
			State.variables.sisSpecifics.flagSissEnd = true;
			var addCharsString = [];
			
			var bText = "<<l" + "ink [[Continue|TF Std Menu]]>><<s" + "cript>>\n";
			bText	 += "genericSistEffectsPlusPc(['" + actor + "'],['" + target + "'].concat([" + addCharsString + "]),sistTransformationEffects);\n";
			bText	 += "State.variables.tfTarget = '" + targetSub + "';State.variables.tfActor = '" + target + "';"
					  + "updateSelectedTransformationsText('" + targetSub + "','" + State.variables.tfActor + "','TF Std Menu');<</s" + "cript>><</l"
					  + "ink>>";
			State.variables.sisSpecifics.continueButton = bText;
		} else {
			//genericSistEffects(getCharGroup(actor),getCharGroup(target).concat(additionalChars));
			//sistEgalitarianSexEffects([actor],[target],additionalChars);
		}
	}
	sist.askToPlayer = function(actor,target,sisKey,targetSub) {
		var promptText = gC(actor).getFormattedName() + " wants you to perform a transformation on " + gC(targetSub).getFormattedName() + ".\n" + this.getDesire(actor,target)[1] + "\n\n"
					   + this.getButtonPlayerAccepts(actor);
		var promptMode = "default";
		if ( gRelTypeAb("chPlayerCharacter",actor) ) {
			if ( gRelTypeAb("chPlayerCharacter",actor).forcedToSex ) {
				promptMode = "relTypeForcesToAccept";
			}
		}
		State.variables.compass.sisList[sisKey].setSisPlayerPrompt(promptText,promptMode,this.getWillpowerRejectCost(actor,target),actor,target,this.sT);
	}
	sist.getButtonPlayerAccepts = function(actor,targetSub) {
		var sisId = State.variables.compass.findFirstSisIdInvolvingCharacter(actor);
		var sisCharList = State.variables.compass.sisList[sisId].charList;
		var joinedGroup = getCharGroup(actor).concat(getCharGroup("chPlayerCharacter"));
		
		var addCharsString = [];
		
		var bText = "<<l" + "ink [[Accept|Scene]]>><<s" + "cript>>\n";
		bText	 += "getSisCharIsIn('chPlayerCharacter').endSisPlayerPrompt();\n";
		bText	 += "genericSistEffectsPlusPc(['" + targetSub + "'],['chPlayerCharacter'].concat([" + addCharsString + "]),sistTransformationEffects);\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		
		return bText;
	}
	sist.recursiveSelfSummon = function(actor,target) {
		var targets = [];
		for ( var cK of gC(actor).followedBy ) {
			if ( gC(actor).subChars.includes(cK) ) {
				targets.push(cK);
			}
		}
		return targets;
	}
	return sist;
}

window.sistTransformationEffects = function(actors,targets,additionalChars) {
	State.variables.sisSpecifics.passageText = "";
	if ( actors[0] == "chPlayerCharacter" ) {
		setupTfMenu(actors[0],targets[0],"TF Std Menu");
	} else {
		// Define conditions and start event
		
		State.variables.compass.pushAllTimeToAdvance();
	}
	
	/*
	// Start Sex Scene
	if ( flagPlayerIsInvolved ) {
		if ( target == "chPlayerCharacter" ) {
			target = actor;
			actor = "chPlayerCharacter";
		}
		if ( getCharGroup(actor).includes(target) ) {
			State.variables.sc.startScene(
		"ss","dynamic",getCharGroup(actor),additionalChars,"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		} else {
			State.variables.sc.startScene(
		"ss","dynamic",getCharGroup(actor),getCharGroup(target).concat(additionalChars),"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		}
		State.variables.sc.endSceneScript = processGenericSexSceneEffects;
		
		for ( var charKey of getCharGroup(actor).concat(getCharGroup(target)).concat(additionalChars) ) {
			if ( charKey != "chPlayerCharacter" ) {
				gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
				gC(charKey).aiAlgorythm.setRoleEqualFooting();
			}
		}
	} else {
		if ( getCharGroup(actor).includes(target) ) {
			State.variables.sc.startScene(
		"ss","dynamic",getCharGroup(actor),additionalChars,"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		} else {
			State.variables.sc.startScene(
		"ss","dynamic",getCharGroup(actor),getCharGroup(target).concat(additionalChars),"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
		}
		State.variables.sc.endSceneScript = processGenericSexSceneEffects;
		
		for ( var charKey of getCharGroup(actor).concat(getCharGroup(target)).concat(additionalChars) ) {
			if ( charKey != "chPlayerCharacter" ) {
				gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
				gC(charKey).aiAlgorythm.setRoleEqualFooting();
			}
		}
		
		State.variables.sc.autoResolveScene();
	}
	
	if ( flagPlayerIsInvolved ) {
		State.variables.sc.formatScenePassage();
	}
	*/
}


// Constructors, serializers, etc.
sisTopic.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
sisTopic.prototype.clone = function () {
	return (new sisTopic())._init(this);
};
sisTopic.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new sisTopic())._init($ReviveData$)', ownData);
};

// Auxiliars

window.recruitCharsInSis = function(charList,actor,joinedChars,evaluationFunction) {
	var joiningChars = [];
	var validChars = [];
	for ( var charKey of charList ) {
		if ( joinedChars.includes(charKey) == false && gC(charKey).followingTo == "" && charKey != "chPlayerCharacter" ) {
			validChars.push(charKey);
		}
	}
	for ( var charKey of validChars ) {
		if ( evaluationFunction(charKey,actor,joinedChars.concat(joiningChars)) ) {
			joiningChars.push(charKey);
			for ( var follower of gC(charKey).followedBy ) {
				joiningChars.push(follower);
			}
		}
	}
	return joiningChars;
}

////////// SIS Topics Database //////////

setup.sistType = {
	egalitarianSex: "t0",
	egalitarianExcludingSex: "t1",
	submissiveSex: "t2",
	dominantSex: "t3",
	borrowedSex: "t4",
	
	unlockTargetsGenitals: "o0",
	unlockActorsGenitals: "o1",
	
	servitudeAsMaster: "r0",
	servitudeAsServant: "r1",
	tutorshipAsTutor: "r2",
	tutorshipAsPupil: "r3",
	companionship: "r4",
	
	transformSelf: "f0",
	transformSub: "f1"
}

setup.sistTypes = [ "t0","t1","t2","t3","t4",
					"o0","o1",
					"r0","r1","r2","r3","r4",
					"f0", "f1" ];

setup.sistDB = [];
setup.sistDB[setup.sistType.egalitarianSex] = new createSistEgalitarianSex();
setup.sistDB[setup.sistType.egalitarianExcludingSex] = new createSistExcludingEgalitarianSex();
setup.sistDB[setup.sistType.submissiveSex] = new createSistSubmissiveSex();
setup.sistDB[setup.sistType.dominantSex] = new createSistDominantSex();
setup.sistDB[setup.sistType.borrowedSex] = new createSistBorrowedDominantSex();

setup.sistDB[setup.sistType.unlockTargetsGenitals] = new createSistUnlockTargetsGenitals();
setup.sistDB[setup.sistType.unlockActorsGenitals] = new createSistUnlockActorsGenitals();

setup.sistDB[setup.sistType.servitudeAsMaster] = new createSistOfferServitudeAsMaster();
setup.sistDB[setup.sistType.servitudeAsServant] = new createSistOfferServitudeAsServant();
setup.sistDB[setup.sistType.tutorshipAsTutor] = new createSistOfferTutorshipAsTutor();
setup.sistDB[setup.sistType.tutorshipAsPupil] = new createSistOfferTutorshipAsPupil();
setup.sistDB[setup.sistType.companionship] = new createSistOfferCompanionship();

setup.sistDB[setup.sistType.transformSelf] = createSistTransformationScene();
setup.sistDB[setup.sistType.transformSub] = createSistSubTransformationScene();
// TRAINING MAP ACTIONS //

// Auxiliar

// Actions
	// Scrolls
window.createSystemEventSearchForScrolls = function(minutes,characters) {
	var sEvent = new systemEvent(10,characters,"searchForScrolls","Searching for scrolls",function(cList) {
		var eventResults = "";
		if ( cList.length > 0 ) {
		
			// Get potential scrolls
			var availableScrolls = getScrollsCharMayFind(cList[0]);
			var newScrollsI = availableScrolls.length; // Amount of new scrolls to find
			if ( newScrollsI > 3 ) { newScrollsI = 3; }
			
			// Form weighted list
			var wList = new weightedList();
			for ( var scr of availableScrolls ) {
				wList[scr] = new weightedElement(scr,setup.scrollsList[scr].getWeight());
			}
		
			// Get found scrolls
			var foundScrolls = [];
			var s = "";
			while ( newScrollsI > 0 ) {
				s = randomFromWeightedList(wList);
				foundScrolls.push(s);
				delete wList[s];
				newScrollsI--;
			}
			
			// Add scrolls to characters' found scrolls
			for ( var scr of foundScrolls ) {
				for ( var character of characters ) {
					if ( gC(character).foundScrolls.includes(scr) == false ) {
						gC(character).foundScrolls.push(scr);
					}
				}
			}	
		
			// Message
			var eventResults = "";
			var scrollsTitles = [];
			for ( var scr of foundScrolls ) {
				scrollsTitles.push(setup.scrollsList[scr].title);
			}
			eventResults += stringArrayToText(scrollsTitles) + " were found.\n\n";
		}
			
			return eventResults;
		}
	);
	sEvent.flagMayBeInterrupted = false;
	sEvent.applyEffectIfForcedToEnd = false;
	sEvent.priority = 2;
	return sEvent;
}
window.createSearchForScrollsAction = function() {
	var action = new mapAction("searchForScrolls","Search for new scrolls",createSystemEventSearchForScrolls,false);
	action.description = "The characters will look for useful, unread scrolls around the library.";
	action.tags.push("scrolls","searchScrolls");
	action.recMins = 10;
	return action;
}

window.createStyduRandomScrollMapAction = function() { // Only for NPCs
	var action = new mapAction("studyScroll","Study a random scroll",createSystemEventStudyRandomScroll,false);
	action.description = "Map action for Candidate NPCs. They will study a randomly selected scroll.";
	action.tags.push("scrolls","studyScroll");
	action.recMins = 30;
	action.flexibleTimes = false;
	return action;
}

window.createSystemEventStudyRandomScroll = function(minutes,characters) {
	var sEvent = new systemEvent(30,characters,"studyScroll","Studying a scroll",function(cList) {
		var eventMsg = "";
		if ( cList.length > 0 ) {
			var validScrolls = []; // Select potentially valid scrolls
			for ( var scr of gC(characters[0]).foundScrolls ) {
				if ( gC(characters[0]).studiedScrolls.includes(scr) == false ) {
					validScrolls.push(scr);
				}
			}
			var scrollKey = randomFromList(validScrolls);
			
			var nCharacters = [];
			for ( var character of characters ) { // Select valid characters
				if ( gC(character).studiedScrolls.includes(scrollKey) == false ) {
					nCharacters.push(character);
					gC(character).studiedScrolls.push(scrollKey);
				}
			}
			reorderCharactersStudiedScrolls(characters); // Variable cleaning
			for ( var character of nCharacters ) { gC(character).studiedScrollToday = true; } // Set studied today flag
			
			var eventMsg = setup.scrollsList[scrollKey].firstTimeEffect(nCharacters) // Effect and results message
						 + "\n__" + setup.scrollsList[scrollKey].title + "__:\n\n"
						 + setup.scrollsList[scrollKey].getContent() + "\n\n";
			return eventMsg;
		}
		}
	);
	sEvent.flagMayBeInterrupted = false;
	sEvent.applyEffectIfForcedToEnd = false;
	sEvent.priority = 2;
	return sEvent;
}
window.createSystemEventStudySpecificScroll = function(characters,scrollKey) {
	var sEvent = new systemEvent(30,characters,"studyScroll","Studying a scroll",function(cList) {
			var eventMsg = "This shouldn't happen.";
			if ( setup.scrollsList[scrollKey] != undefined ) {
				var nCharacters = []; // Select valid characters
				for ( var character of cList ) {
					if ( gC(character).studiedScrolls.includes(scrollKey) == false ) {
						nCharacters.push(character);
						gC(character).studiedScrolls.push(scrollKey);
					}
				}
				reorderCharactersStudiedScrolls(cList); // Variable cleaning
				for ( var character of nCharacters ) { gC(character).studiedScrollToday = true; } // Set studied today flag
				
				eventMsg = setup.scrollsList[scrollKey].firstTimeEffect(nCharacters) // Effect and results message
							 + "\n__" + setup.scrollsList[scrollKey].title + "__:\n\n"
							 + setup.scrollsList[scrollKey].getContent() + "\n\n";
			} else {
			}
			return eventMsg;
		}
	);
	sEvent.flagMayBeInterrupted = false;
	sEvent.applyEffectIfForcedToEnd = false;
	sEvent.priority = 2;
	return sEvent;
}

window.getButtonMapMenuSelectScroll = function() {
	var bText = "<<l" + "ink [[Pick|Map]]>><<s" + "cript>>\n";
		bText 	 += "State.variables.compass.flagMenuInMap = true;\n";
		bText 	 += "formatPassageMenuSelectScroll();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
window.formatPassageMenuSelectScroll = function() {
	var passageText = "__Pick a scroll__:\n";
	for ( var scr of gC("chPlayerCharacter").foundScrolls ) {
		if ( gC("chPlayerCharacter").studiedScrolls.includes(scr) == false ) {
			// Command to start study specific scroll event
			passageText += "- " + '<<link [[' + setup.scrollsList[scr].title + '|Interlude]]>><<script>>'
						 + 'State.variables.compass.ongoingEvents.push(createSystemEventStudySpecificScroll(getPlayerCharsGroup(),"' + scr + '"));\n'
						 + 'State.variables.compass.sortOnGoingEventsByTime();\n'
						 + 'signCharsActive(getPlayerCharsGroup());\n'
						 + 'State.variables.compass.flagMenuInMap = false;\n'
						 + 'State.variables.compass.mapMenuPassage = "";\n'
						 + 'State.variables.compass.pushAllTimeToAdvance();'
						 + '<</' + 'script>><</' + 'link>> - ' + getScrollTypeText(setup.scrollsList[scr]) + '\n';
		}
	}
	passageText += "\n" + getButtonExitMapMenu("Exit Menu");
	State.variables.compass.mapMenuPassage = passageText;
}
window.getButtonExitMapMenu = function(buttonName) {
	var bText = "<<l" + "ink [[" + buttonName + "|Map]]>><<s" + "cript>>\n";
		bText 	 += "State.variables.compass.flagMenuInMap = false;\n";
		bText 	 += "State.variables.compass.mapMenuPassage = '';\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;	
}


	// SIS
window.createSystemEventSisRound = function(characters,sisKey) {
	var sEvent = new systemEvent(5,characters,"sisRound","Social Interactions Round",function(cList) {
			State.variables.compass.sisList[this.sisKey].processRound();
			if ( State.variables.compass.sisList[this.sisKey].charList.includes("chPlayerCharacter") ) {
				State.variables.compass.sisList[this.sisKey].preInitiateNewRoundWithPC();
			} else {
				State.variables.compass.sisList[this.sisKey].preInitiateNewRoundNoPC(true);
			}
		}
	);
	sEvent.createdAtMin = State.variables.daycycle.minutes;
	sEvent.sisKey = sisKey;
	sEvent.flagMayBeInterrupted = true;
	sEvent.applyEffectIfForcedToEnd = false;
	sEvent.flagSignCharsAsIdleOnEnd = false;
	sEvent.flagDontPushTimeYet = true;
	sEvent.priority = 4;
	return sEvent;
}

	// Scenes
window.createSystemEventScene = function(characters,minutes,label) {
	var sEvent = new systemEvent(minutes,characters,"scene","Scene",function(cList) {
		}
	);
	sEvent.flagMayBeInterrupted = false;
	sEvent.flagMayChangeGroups = false;
	sEvent.label = label;
	sEvent.priority = 5;
	sEvent.applyEffectIfForcedToEnd = false;
	return sEvent;
}
window.createSystemEventStandardSexScene = function(characters) {
	var sEvent = new systemEvent(20,characters,"scene","Scene",function(cList) {
		}
	);
	sEvent.flagMayBeInterrupted = false;
	sEvent.flagMayChangeGroups = false;
	sEvent.label = "sexScene";
	sEvent.priority = 5;
	sEvent.applyEffectIfForcedToEnd = false;
	return sEvent;
}

window.createSystemEventDominantSexEffects = function(characters) {
	var sEvent = new systemEvent(20,characters,"scene","Scene",function(characters) {
			var dommingChar = characters[0];
			var dommedChars = arrayMinusA(characters,dommingChar);
			
			if ( characters.length >= 2 ) {
				// Start scene
				State.variables.sc.startScene(
			"ss","fixed",[dommingChar],dommedChars,"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
				State.variables.sc.endSceneScript = processGenericSexSceneEffects;
				// Assign AI
				for ( var charKey of characters ) {
					if ( charKey == "chPlayerCharacter" ) {
					} else if ( charKey == dommingChar ) {
						gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
						gC(charKey).aiAlgorythm.setRoleDomination();
					} else {
						gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
						gC(charKey).aiAlgorythm.setRoleSubmission();
					}
				}
				// Assign lead
				gC(dommingChar).hasLead = true;
				// Auto-solve?
				if ( characters.includes("chPlayerCharacter") == false ) {
					State.variables.sc.autoResolveScene();
				}
			}
		}
	);
	sEvent.flagMayBeInterrupted = false;
	sEvent.flagMayChangeGroups = false;
	sEvent.label = "sexScene";
	sEvent.priority = 5;
	sEvent.applyEffectIfForcedToEnd = false;
	return sEvent;
}

window.createSystemEventAltDominantSexEffects = function(charsA,charsB) {
	var characters = charsA.concat(charsB);
	var sEvent = new systemEvent(20,characters,"scene","Scene",function(characters) {
			var dommingChar = this.charsA[0];
			var dommedChars = arrayMinusA(characters,dommingChar);
			
			if ( characters.length >= 2 ) {
				// Start scene
				State.variables.sc.startScene(
			"ss","fixed",[dommingChar],dommedChars,"The water flows quietly.",endConditionTurns,gSettings().stdSxScDur,"Scene Results");
				State.variables.sc.endSceneScript = processGenericSexSceneEffects;
				// Assign AI
				for ( var charKey of characters ) {
					if ( charKey == "chPlayerCharacter" ) {
					} else if ( charKey == dommingChar ) {
						gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
						gC(charKey).aiAlgorythm.setRoleDomination();
					} else {
						gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
						gC(charKey).aiAlgorythm.setRoleSubmission();
					}
				}
				// Assign lead
				gC(dommingChar).hasLead = true;
				// Auto-solve?
				if ( characters.includes("chPlayerCharacter") == false ) {
					State.variables.sc.autoResolveScene();
				}
			}
		}
	);
	sEvent.charsA = charsA;
	sEvent.charsB = charsB;
	sEvent.flagMayBeInterrupted = false;
	sEvent.flagMayChangeGroups = false;
	sEvent.label = "sexScene";
	sEvent.priority = 5;
	sEvent.applyEffectIfForcedToEnd = false;
	return sEvent;
}

window.createSystemEventStandardTransformationScene = function(charsA,charsB,description,checkEndScene,endScenePassage,
		tfGoals,tfActors,tfTarget,tfTemporary,genderChange,avatarFileName,portraitFileName,tfMenuPassage) {
	var allChars = charsA.concat(charsB);
	var sEvent = new systemEvent(20,allChars,"scene","Scene",function(cList) {
			// var desc = getRoomInfoA(gC(this.characters[0]).currentRoom).description;
			State.variables.sc.startTfScene("ss","dynamic",this.charsA,this.charsB,this.description,isTfSceneFinished,1,this.endScenePassage,
		this.tfGoals,this.tfActors,this.tfTarget,4,this.tfTemporary,7,this.genderChange,this.avatarFileName,this.portraitFileName);
			for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
				if ( charKey != "chPlayerCharacter" ) {
					gC(charKey).aiAlgorythm = createAiWeightedMissionsByTaste();
				}
			}
			if ( this.tfMenuPassage == "FASE MorphHut MorphMenu" ) {
				State.variables.sc.endSceneScript = tfGleamingCavernsEndScript;
			} else {
				State.variables.sc.endSceneScript = tfStandardEndScript;
			}
			State.variables.sc.tfPassage = tfMenuPassage;
			if ( this.characters.includes("chPlayerCharacter") == false ) {
				State.variables.sc.autoResolveScene();
			} else {
				State.variables.sc.formatScenePassage();
			}
		}
	);
	sEvent.charsA = charsA;
	sEvent.charsB = charsB;
	sEvent.description = description;
	sEvent.endScenePassage = endScenePassage;
	sEvent.tfGoals = tfGoals;
	sEvent.tfActors = tfActors;
	sEvent.tfTarget = tfTarget;
	sEvent.tfTemporary = tfTemporary;
	sEvent.genderChange = genderChange;
	sEvent.avatarFileName = avatarFileName;
	sEvent.portraitFileName = portraitFileName;
	sEvent.flagMayBeInterrupted = false;
	sEvent.flagMayChangeGroups = false;
	sEvent.tfMenuPassage = tfMenuPassage;
	sEvent.label = "sexScene";
	sEvent.priority = 5;
	sEvent.applyEffectIfForcedToEnd = false;
	// Relocate actor and target
	var actor = allChars[0]
	if ( gC(actor).getRefugeRoomInMap() != "none" && State.variables.storyState != storyState.firstAdventure ) {
		State.variables.compass.moveCharsToRoom(charsA.concat(charsB),gC(actor).getRefugeRoomInMap());
	}
	// Pre-conditions to start event
	for ( var cK of allChars ) {
		State.variables.compass.characterEventEndsPrematurely(cK);		
	}
	
	return sEvent;
}

window.createSystemEventBattle = function(charactersTeamA,charactersTeamB,spectators,minutes,label) {
	var allChars = charactersTeamA.concat(charactersTeamB.concat(spectators));
	var sEvent = new systemEvent(minutes,characters,"battle","Battle",function(cList) {
			var desc = getRoomInfoA(gC(this.characters[0]).currentRoom).description;
			State.variables.sc.startScene("bs","none",this.charactersTeamA,this.charactersTeamB,desc,endConditionStandardBattle,0,"Map");
			for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
				if ( charKey != "chPlayerCharacter" ) {
					gC(charKey).aiAlgorythm = createAiEarlyStrategic();
				}
			}
			if ( this.characters.includes("chPlayerCharacter") == false ) {
				State.variables.sc.autoResolveScene();
			}
		}
	);
	sEvent.charactersTeamA = charactersTeamA;
	sEvent.charactersTeamB = charactersTeamB;
	sEvent.spectators = spectators;
	sEvent.flagMayBeInterrupted = false;
	sEvent.flagMayChangeGroups = false;
	sEvent.label = label;
	sEvent.priority = 5;
	sEvent.applyEffectIfForcedToEnd = false;
	return sEvent;
}
window.createSystemEventStandardAssault = function(charactersTeamA,charactersTeamB,spectators) {
	var allChars = charactersTeamA.concat(charactersTeamB.concat(spectators));
	var characters = allChars;
	var sEvent = new systemEvent(20,characters,"battle","Battle",function(cList) {
			var desc = getRoomInfoA(gC(this.characters[0]).currentRoom).description;
			State.variables.sc.startScene("bs","none",this.charactersTeamA,this.charactersTeamB,desc,endConditionStandardBattle,0,"Scene Results"); // Start scene
			State.variables.sc.setBattleParameters(3,this.charactersTeamA[0],this.charactersTeamB[0]); // Battle parameters
			State.variables.sc.endSceneScript = processGenericMapBattleEffects; // Set generic battle effects
			for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
				if ( charKey != "chPlayerCharacter" ) {
					gC(charKey).aiAlgorythm = createAiEarlyStrategic();
				}
			}
			for ( var extraMessage of this.extraMessages ) {
				if ( State.variables.sc.importantMessages != "" ) { State.variables.sc.importantMessages += "\n"; }
				State.variables.sc.importantMessages += extraMessage;
			}
			if ( this.characters.includes("chPlayerCharacter") == false ) {
				State.variables.sc.autoResolveScene();
			}
		}
	);
	sEvent.charactersTeamA = charactersTeamA;
	sEvent.charactersTeamB = charactersTeamB;
	sEvent.spectators = spectators;
	sEvent.flagMayBeInterrupted = false;
	sEvent.flagMayChangeGroups = false;
	sEvent.label = "assault";
	sEvent.priority = 5;
	sEvent.applyEffectIfForcedToEnd = false;
	return sEvent;
}
window.createSystemEventStandardChallenge = function(charactersTeamA,charactersTeamB,spectators,stakes) {
	var allChars = charactersTeamA.concat(charactersTeamB.concat(spectators));
	var characters = allChars;
	var sEvent = new systemEvent(20,characters,"battle","Battle",function(cList) {
			var desc = getRoomInfoA(gC(this.characters[0]).currentRoom).description;
			State.variables.sc.startScene("bs","none",this.charactersTeamA,this.charactersTeamB,desc,endConditionStandardBattle,0,"Scene Results"); // Start scene
			State.variables.sc.setBattleParameters(stakes,this.charactersTeamA[0],this.charactersTeamB[0]); // Battle parameters
			State.variables.sc.endSceneScript = processGenericMapBattleEffects; // Set generic battle effects
			for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
				if ( charKey != "chPlayerCharacter" ) {
					gC(charKey).aiAlgorythm = createAiEarlyStrategic();
				}
			}
			for ( var extraMessage of this.extraMessages ) {
				if ( State.variables.sc.importantMessages != "" ) { State.variables.sc.importantMessages += "\n"; }
				State.variables.sc.importantMessages += extraMessage;
			}
			if ( this.characters.includes("chPlayerCharacter") == false ) {
				State.variables.sc.autoResolveScene();
			}
		}
	);
	sEvent.charactersTeamA = charactersTeamA;
	sEvent.charactersTeamB = charactersTeamB;
	sEvent.spectators = spectators;
	sEvent.flagMayBeInterrupted = false;
	sEvent.flagMayChangeGroups = false;
	sEvent.label = "challenge";
	sEvent.priority = 5;
	sEvent.applyEffectIfForcedToEnd = false;
	return sEvent;
}

window.createSystemEventLiberationChallenge = function(charactersTeamA,charactersTeamB,spectators) {
	var allChars = charactersTeamA.concat(charactersTeamB.concat(spectators));
	var characters = allChars;
	var sEvent = new systemEvent(20,characters,"battle","Battle",function(cList) {
			var desc = getRoomInfoA(gC(this.characters[0]).currentRoom).description;
			State.variables.sc.startScene("bs","none",this.charactersTeamA,this.charactersTeamB,desc,endConditionStandardBattle,0,"Scene Results"); // Start scene
			State.variables.sc.setBattleParameters(1,this.charactersTeamA[0],this.charactersTeamB[0]); // Battle parameters
			State.variables.sc.endSceneScript = processLiberationChallengeEffects; // Set generic battle effects
			for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
				if ( charKey != "chPlayerCharacter" ) {
					gC(charKey).aiAlgorythm = createAiEarlyStrategic();
				}
			}
			if ( this.characters.includes("chPlayerCharacter") == false ) {
				State.variables.sc.autoResolveScene();
			}
		}
	);
	sEvent.charactersTeamA = charactersTeamA;
	sEvent.charactersTeamB = charactersTeamB;
	sEvent.spectators = spectators;
	sEvent.flagMayBeInterrupted = false;
	sEvent.flagMayChangeGroups = false;
	sEvent.label = "liberationChallenge";
	sEvent.priority = 5;
	sEvent.applyEffectIfForcedToEnd = false;
	return sEvent;
}

// Special

	// Respec
window.createRespecAction = function() {
	var action = new mapAction("respect","Accept the green orb's gift",createSystemEventSearchForScrolls,false);
	action.description = "The characters will look for useful, unread scrolls around the library.";
	action.tags.push("scrolls","searchScrolls");
	action.recMins = 10;
	sEvent.priority = 9;
	return action;
}
window.getButtonMapMenuRespec = function() {
	var bText = "<<l" + "ink [[Accept the green orb's gift|Map]]>><<s" + "cript>>\n";
		bText 	 += "State.variables.compass.flagMenuInMap = true;\n";
		bText 	 += "formatPassageMenuRespect();\n";
		bText	 += "<</s" + "cript>><</l" + "ink>>";
		return bText;
	}
window.formatPassageMenuRespect = function() {
	var passageText = '<span style="color:gray">//"Greetings, Candidate. Are you here to accept the gift?"//</span>\n\n';
	passageText += '<span style="color:khaki">You may switch three pairs of stats. The switched stats will exchange their values, experience and affinities. You may only do this once.</span>\n\n';
	var i = 1;
	while ( i < 7 ) {
		State.variables.StVars[("check" + i)] = "physique";
		i++;
	}
	i = 1;
	while ( i < 4 ) {
		passageText += `Pair ${i}: ` + '<<listbox "$StVars.check' + i + '" autoselect>>\n';
		for ( var st of getStatNamesArray() ) {
			passageText += '<<option "' + firstToCap(st) + '" "' + st + '">>\n';
		}
		passageText += '<</listbox>> - <<listbox "$StVars.check' + (i+3) + '" autoselect>>\n';
		for ( var st of getStatNamesArray() ) {
			passageText += '<<option "' + firstToCap(st) + '" "' + st + '">>\n';
		}
		passageText += '<</listbox>>\n';
		i++;
	}
	passageText += '\n <<link [[Respec your talents|Interlude]]>><<s' + 'cript>>'
				 + 'State.variables.compass.ongoingEvents.push(createSystemEventRespec(getPlayerCharsGroup()));\n'
				 + 'State.variables.compass.sortOnGoingEventsByTime();\n'
				 + 'signCharsActive(getPlayerCharsGroup());\n'
				 + 'State.variables.compass.flagMenuInMap = false;\n'
				 + 'State.variables.compass.mapMenuPassage = "";\n'
				 + 'State.variables.compass.pushAllTimeToAdvance();'
				 + '<</' + 'script>><</' + 'link>>\n';
	passageText += "\n" + getButtonExitMapMenu("Cancel Respec");
	State.variables.compass.mapMenuPassage = passageText;
}
window.createSystemEventRespec = function(characters) {
	var sEvent = new systemEvent(30,characters,"respec","Respec-ing",function(cList) {
			var eventMsg = "Taototh projects the orb's energy over you, covering you in light. The secrets of your body, your psyche, your soul, are all laid nude to him, and he carefully manipulates them.\n\n"
			+ "A long while later, the orb shatters, and you realize you were out of yourself. When you recover consciousness, you feel like a completely new person.\n\n";
			reassignPlayerStats();
			return eventMsg;
		}
	);
	sEvent.flagMayBeInterrupted = false;
	sEvent.applyEffectIfForcedToEnd = false;
	return sEvent;
}


////////// NPC-SIS-AI CLASS //////////

window.NpcSisAi = function(charKey) {
	this.charKey = charKey;
	this.type = "generic";
	
	this.getInterRoundBehavior = function(SIS) { // Character returns specific behavior to be executed between SIS rounds, such as
												 // leaving the SIS or making a proposal
												 // First parameter is the type of action, second parameter is the action's extra data
		return ["none",""];
	}
};

window.setCustomSisAi = function(charKey) {
	gC(charKey).sisAi.getInterRoundBehavior = function(SIS) {
		if ( SIS.roundsCount > 1 ) {
			//return ["leave",""];
			return ["dominantSex","chPlayerCharacter"];
		} else {
			gC(charKey).mapAi.type = "balancedTraining";
			gC(charKey).mapAi.createNewMission = cMissionBalancedRandomTrain;
			return ["none",""];
		}
	}
}

// Constructors, serializers, etc.
NpcSisAi.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
NpcSisAi.prototype.clone = function () {
	return (new NpcSisAi())._init(this);
};
NpcSisAi.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new NpcSisAi())._init($ReviveData$)', ownData);
};

////// MAP PLAYER PROMPTS //////
// Functions used to generate prompts sent to player under specific circumstances

window.getButtonAcceptConversation = function(askingCharacter) {
	var bText = "<<l" + "ink [[Accept conversation|Social Interactions]]>><<s" + "cript>>\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "State.variables.compass.createNewSis(getCharGroup('chPlayerCharacter').concat(getCharGroup('" + askingCharacter + "')));\n";
	bText	 += "State.variables.compass.cleanPhantasmEvents();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>";
	return bText;
}
window.getButtonRejectConversation = function(askingCharacter) {
	var bText = "<<l" + "ink [[Reject|Map]]>><<s" + "cript>>\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "State.variables." + askingCharacter + ".mapAi.state = 'idle';\n";
	bText	 += "State.variables.compass.pushAllTimeToAdvance();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>";
	return bText;
}
window.getButtonAcceptConversationInterrupted = function(askingCharacter) {
	var bText = "<<l" + "ink [[Accept conversation|Social Interactions]]>><<s" + "cript>>\n";
	bText 	 += "State.variables.compass.findFirstEventInvolvingPlayer().forceEnd();\n"; // Interrupt player's current event
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "State.variables.compass.createNewSis(getCharGroup('chPlayerCharacter').concat(getCharGroup('" + askingCharacter + "')));\n";
	bText	 += "State.variables.compass.cleanPhantasmEvents();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>"
	bText	 += " (This will interrupt your current activity)";	// Warning
	return bText;
}
window.getButtonRejectConversationInterrupted = function(askingCharacter) {
	var bText = "<<l" + "ink [[Reject|Map]]>><<s" + "cript>>\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "State.variables." + askingCharacter + ".mapAi.state = 'idle';\n";
	bText	 += "State.variables.compass.pushAllTimeToAdvance();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>";
	return bText;
}

// Buttons Battles
window.getButtonBeingAssaulted = function(assaultingCharacter) {
	var bText = "<<l" + "ink [[Fight back|Scene]]>><<s" + "cript>>\n";
	bText	 += "State.variables.compass.pushAllTimeToAdvance();\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>"
	return bText;
}
window.getButtonAcceptChallenge = function(challengingCharacter,stakes) {
	// Initiate challenge battle, assign infamy
	var bText = "<<l" + "ink [[Accept challenge|Scene]]>><<s" + "cript>>\n";
	bText	 += "initiateNpcToPlayerAcceptedChallenge('" + challengingCharacter + "'," + stakes + ");\n";
	bText	 += "State.variables.compass.pushAllTimeToAdvance();\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>"
	return bText;
}
window.getButtonRejectChallenge = function(challengingCharacter,stakes) {
	var returnPassage = getPlayerReturnScreen();
	// Initiate challenge battle, assign infamy and merit
	var bText = "<<l" + "ink [[Refuse challenge|" + returnPassage + "]]>><<s" + "cript>>\n";
	bText	 += "State.variables." + challengingCharacter + ".changeInfamy(1);\n";
	bText	 += "State.variables." + challengingCharacter + ".changeMerit(1);\n";
	bText	 += "State.variables.chPlayerCharacter.changeMerit(-1);\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	//bText	 += "State.variables." + challengingCharacter + ".mapAi.state = 'idle';\n";
	bText	 += "State.variables.compass.pushAllTimeToAdvance();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>"
	return bText;
}

// Follow
window.getButtonNpcAsksToFollowThemAccept = function(actor) {
	var followingForDebt = true;
	if ( gRelTypeAb("chPlayerCharacter",actor) ) { // Check if player is forced to follow	
		if ( gRelTypeAb("chPlayerCharacter",actor).forcedToFollow ) {
			followingForDebt = false;
		}
	}
	var bText = "<<l" + "ink [[Accept|Map]]>><<s" + "cript>>\n";
	bText	 += "charFollowsChar('chPlayerCharacter','" + actor + "'," + followingForDebt + ");\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>"
	return bText;
}
window.getButtonNpcAsksToFollowThemReject = function(actor) {
	var returnPassage = getPlayerReturnScreen();
	var bText = "<<l" + "ink [[Refuse|" + returnPassage + "]]>><<s" + "cript>>\n";
	bText	 += "charArefusesToFollowCharacterB('chPlayerCharacter','" + actor + "');\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>"
	return bText;
}
window.getButtonNpcAsksToFollowPlayerAccept = function(actor) {
	var returnPassage = getPlayerReturnScreen();
	var bText = "<<l" + "ink [[Accept|" + returnPassage + "]]>><<s" + "cript>>\n";
	bText	 += "charFollowsChar('" + actor + "','chPlayerCharacter',false);\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>"
	return bText;
}
window.getButtonNpcAsksToFollowPlayerReject = function(actor) {
	var returnPassage = getPlayerReturnScreen();
	var bText = "<<l" + "ink [[Refuse|" + returnPassage + "]]>><<s" + "cript>>\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>"
	return bText;
}
window.getButtonNpcAsksToUnfollowThemAccept = function(actor) {
	var returnPassage = getPlayerReturnScreen();
	var bText = "<<l" + "ink [[Accept|" + returnPassage + "]]>><<s" + "cript>>\n";
	bText	 += "charUnfollowsChar('chPlayerCharacter','" + actor + "');\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>"
	return bText;
}
window.getButtonNpcAsksToUnfollowThemReject = function(actor) {
	var returnPassage = getPlayerReturnScreen();
	var bText = "<<l" + "ink [[Refuse|" + returnPassage + "]]>><<s" + "cript>>\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>"
	return bText;
}
window.getButtonNpcAsksToUnfollowPlayerAccept = function(actor) {
	var returnPassage = getPlayerReturnScreen();
	var bText = "<<l" + "ink [[Accept|" + returnPassage + "]]>><<s" + "cript>>\n";
	bText	 += "charUnfollowsChar('" + actor + "','chPlayerCharacter');\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>"
	return bText;
}
window.getButtonNpcAsksToUnfollowPlayerReject = function(actor) {
	var returnPassage = getPlayerReturnScreen();
	var bText = "<<l" + "ink [[Refuse|" + returnPassage + "]]>><<s" + "cript>>\n";
	bText	 += "State.variables.compass.finishPlayerPrompt();\n";
	bText	 += "<</s" + "cript>><</l" + "ink>>"
	return bText;
}

// Auxiliar

window.getPlayerReturnScreen = function() {
	var passage = "Map";
	if ( State.variables.compass.getCharacterSisId("chPlayerCharacter") != -1 ) {
		passage = "Social Interactions";
	}
	return passage;
}

////////////////////////////////


///// Some auxiliar functions /////
	// Pseudo-global variables used by NpcGlobalAi. 
window.gBarLowThreshold = function() { return 0.25; }
window.gBarMediumThreshold = function() { return 0.5; }
window.gBarHighThreshold = function() { return 0.75; }


////////// NPC-GLOBAL-AI CLASS //////////

window.NpcGlobalAi = function(charKey) {
	this.charKey = charKey;
	this.type = "static";
	
	this.getMission = function() {
		return [];
	}
	
	this.generateMissionChoices = function() {
		return [];
	}
	
	this.generalEvaluations = function() {
		return true;
	}
};

window.createCandidateGlobalAi = function(charKey) {
	var globalAi = new NpcGlobalAi(charKey);
	globalAi.type = "candidateTemple";
	globalAi.attackedToday = false;
	
	globalAi.generalEvaluations = function() {
		// Get followers
		if ( gSettings().followingAllowed ) {
			charactersGetsForcedFollowers(this.charKey);
			var dangerProportion = this.evaluateDangerState();
			if ( dangerProportion != 0 ) {
				if ( dangerProportion > 2.3 ) {
					// Case 1: Danger way too high, follow someone
					if ( this.findBestCharToFollow() == false ) {
						// Try following someone at least
						this.findBestFollower();
					}
				} else if ( dangerProportion > 1.1 ) {
					// Case 2: Danger too high, get a follower
					if ( this.findBestFollower() == false ) {
						// Try following someone at least
						this.findBestCharToFollow();
					}
				} else if ( dangerProportion < 0.52 ) {
					// Case 3: Danger too low, if has non-essential followers, drop one
					this.findBestCharToLeave();
				}
			}
		}
		// Join assaults
		if ( gSettings().assaultingAllowed ) {
			var joinedChar = considerPossibleAssaults(this.charKey);
			
			if ( joinedChar != "" ) {
				addCharsTeamToCharsBattle(this.charKey,joinedChar);
				gC(this.charKey).mapAi.signActive();
				gC(this.charKey).mapAi.goalsList = [];
			}
		}
		return true;
	}
	globalAi.evaluateDangerState = function() {
		// The Candidate evaluates their situation in the training/socialization period and potential danger from other Candidates
		var dangerProportion = 0; // Fraction that determines how powerful is the most dangerous Candidate in comparison to self
		var aggressiveCandidates = []; // Find Candidates who have accumulated a certain amount of infamy
		for ( var charKey of getActiveSimulationCharactersArray() ) {
			if ( charKey != this.charKey ) {
				if ( gC(charKey).infamy > 5 ) {
					aggressiveCandidates.push(charKey);
				}
			}
		}
		if ( aggressiveCandidates.length > 0 ) {
			var selfStrength = quantifyCharactersGroupStrength(this.charKey); // Strength of this character's group
			var mostDangerousStrength = 0; // Find strength of most dangerous enemy
			var currentEvaluation = 0;
			for ( var charKey of aggressiveCandidates ) {
				if ( gC(charKey).followingTo == "" ) {
					currentEvaluation = quantifyCharactersGroupStrength(charKey);
					if ( currentEvaluation > mostDangerousStrength ) {
						mostDangerousStrength = currentEvaluation;
					}
				}
			}
			if ( mostDangerousStrength > 0 ) {
				dangerProportion = mostDangerousStrength / selfStrength;
			}
		}
		return dangerProportion;
	}
	globalAi.findBestFollower = function() {
		var foundFollower = false;
		var potentialFollowers = [];
		var currentRoom = gC(this.charKey).currentRoom;
		var charsInRoom = getRoomA(currentRoom).characters;
		for ( var charKey of charsInRoom ) { // Find potential followers
			if ( charKey != this.charKey && gC(charKey).followingTo == "" && gC(charKey).followedBy.length == 0 ) {
				potentialFollowers.push(charKey);
			}
		}
		if ( potentialFollowers.length > 0 ) { // Find best follower
			var currentChoice = "";
			var currentBestScore = -10;
			for ( var potFollower of potentialFollowers ) {
				var favor = rFavor(potFollower,this.charKey);
				var infamy = gC(potFollower).infamy;
				var relation = rLvlAbt(this.charKey,potFollower,"friendship") + rLvlAbt(this.charKey,potFollower,"romance") * 2 - rLvlAbt(this.charKey,potFollower,"enmity") * 3;
				var currentScore = favor - infamy + relation;
				if ( currentScore > currentBestScore ) {
					currentBestScore = currentScore;
					currentChoice = potFollower;
				}
			}
			if ( currentChoice != "" ) { // Ask to follow
				foundFollower = npcProposalFollowMe(this.charKey,currentChoice);
			}
		}
		return foundFollower;
	}
	
	globalAi.findBestCharToFollow = function() {
		var foundFollowed = false;
		var potentialFolloweds = [];
		var currentRoom = gC(this.charKey).currentRoom;
		var charsInRoom = getRoomA(currentRoom).characters;
		for ( var charKey of charsInRoom ) { // Find potential followeds
			if ( charKey != this.charKey && gC(charKey).followingTo == "" ) {
				potentialFolloweds.push(charKey);
			}
		}
		if ( potentialFolloweds.length > 0 ) { // Find best followed
			var currentChoice = "";
			var currentBestScore = -5;
			for ( var potFollowed of potentialFolloweds ) {
				var infamy = gC(potFollowed).infamy * 2;
				var relation = rLvlAbt(this.charKey,potFollowed,"friendship") + rLvlAbt(this.charKey,potFollowed,"romance") * 2 - rLvlAbt(this.charKey,potFollowed,"enmity") * 3;
				var currentScore = - infamy + relation;
				if ( currentScore > currentBestScore ) {
					currentBestScore = currentScore;
					currentChoice = potFollowed;
				}
			}
			if ( currentChoice != "" ) { // Ask to follow
				foundFollowed = npcProposalFollowYou(this.charKey,currentChoice);
			}
		}
		return foundFollowed;
	} 
	globalAi.findBestCharToLeave = function() {
		var leftFollower = false;
		var potentialUnfollowers = [];
		for ( var charKey of gC(this.charKey).followedBy ) {
			if ( gC(charKey).followingForDebt ) {
				potentialUnfollowers.push(charKey);
			}
		}
		if ( potentialUnfollowers.length > 0 ) {
			leftFollower = npcProposalUnfollowMe(this.charKey,potentialUnfollowers[0]);
		}
		
		return leftFollower;
	}	
		
	globalAi.generateRestMissionChoice = function() {
		var mChoice = cRestMissionChoice(this.charKey);
		
		mChoice.weight = 1;
		if ( gC(this.charKey).lust.current < ( gC(this.charKey).lust.max * gBarLowThreshold() ) ) { mChoice.weight *= 10; }
		if ( gC(this.charKey).willpower.current < ( gC(this.charKey).willpower.max * gBarLowThreshold() ) ) { mChoice.weight *= 10; }
		if ( gC(this.charKey).energy.current < ( gC(this.charKey).energy.max * gBarLowThreshold() ) ) { mChoice.weight *= 10; }
		if ( gC(this.charKey).socialdrive.current < ( gC(this.charKey).socialdrive.max * gBarLowThreshold() ) ) { mChoice.weight *= 10; }
		
		return mChoice;
	}
	globalAi.generateTrainingChoices = function(charKey) {
		return [cTrainAgilityMissionChoice(charKey),cTrainCharismaMissionChoice(charKey),cTrainEmpathyMissionChoice(charKey),
				cTrainIntelligenceMissionChoice(charKey),cTrainLuckMissionChoice(charKey),cTrainPerceptionMissionChoice(charKey),
				cTrainPhysiqueMissionChoice(charKey),cTrainResilienceMissionChoice(charKey),cTrainWillMissionChoice(charKey)];
	}
	globalAi.generateScrollsChoices = function() {
		var choices = [];
		if ( State.variables.simCycPar.templeDayPeriod != "training" ) {
			var choiceSearch = cSearchScrollsMissionChoice(this.charKey);
			var choiceStudy = cStudyScrollMissionChoice(this.charKey);
			if ( choiceSearch.isValid() ) {
				choiceSearch.weight = 40;
				choices.push(choiceSearch);
			}
			if ( choiceStudy.isValid() ) {
				choiceStudy.weight = 60;
				choices.push(choiceStudy);
			}
		}
		
		return choices;
	}
	
	globalAi.generateAdvancedSocializationChoices = function() {
		var mChoices = [];
		
		// Generate targets
		var allyTargets = [];
		var loveTargets = [];
		var covetTargets = [];
		var enemyTargets = [];
		var allTargets = [];
		
		for ( var charKey of getCurrentMap().characters ) {
			if ( charKey != this.charKey ) {
				if ( mayCharBeApproached(this.charKey,charKey) ) {
					if ( gC(this.charKey).socialAi.allyTs.includes(charKey) ) {
						allyTargets.push(charKey);
					}
					if ( gC(this.charKey).socialAi.loveTs.includes(charKey) ) {
						loveTargets.push(charKey);
					}
					if ( gC(this.charKey).socialAi.covetTs.includes(charKey) ) {
						covetTargets.push(charKey);
					}
					if ( gC(this.charKey).socialAi.rivalTs.includes(charKey) ) {
						enemyTargets.push(charKey);
					}
					allTargets.push(charKey);
				}
			}
		}
		
		if ( allTargets.length > 0 && getBarPercentage(this.charKey,"socialdrive") >= 0.25 ) {
			var selectedChar = "";
			if ( (gC(this.charKey).mood.angry + gC(this.charKey).mood.bored * 0.5 - 15 ) < ( gC(this.charKey).mood.friendly + gC(this.charKey).mood.flirty ) ) {
				// Nurture friendship, flirt, seduce, taunt
				// Friendship
				if ( limitedRandomInt(10) >= 2 && loveTargets.length > 0 ) {
					selectedChar = randomFromList(allyTargets);
				} else {
					selectedChar = randomFromList(allTargets);
				}
				var frChoice = cAdvancedScialGoalMissionChoice(this.charKey,selectedChar,"raiseFriendship");
				var weight = 2 + gC(this.charKey).dLove.level * 1 + gC(this.charKey).dCooperation.level * 1 - gC(this.charKey).mood.angry * 0.1;
				if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 3 + allyTargets.length * 2; }
				frChoice.weight = weight;
				if ( frChoice.weight > 0 ) { mChoices.push(frChoice); }
				
				// Flirt
				if ( limitedRandomInt(10) >= 2 && loveTargets.length > 0 ) {
					selectedChar = randomFromList(loveTargets);
				} else {
					selectedChar = randomFromList(allTargets);
				}
				var flChoice = cAdvancedScialGoalMissionChoice(this.charKey,selectedChar,"flirt");
				weight = 3 + gC(this.charKey).dLove.level * 1 + gC(this.charKey).dPleasure.level * 1 + gC(this.charKey).dCooperation.level * 1 - gC(this.charKey).mood.angry * 0.1 + gC(this.charKey).mood.flirty * 0.1;
				if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 3 + loveTargets.length * 2; }
				frChoice.weight = weight;
				if ( frChoice.weight > 0 && isLewdingPossible(this.charKey,selectedChar) ) { mChoices.push(flChoice); }
				
				// Seduce
				if ( limitedRandomInt(10) >= 2 && loveTargets.length > 0 ) {
					selectedChar = randomFromList(covetTargets);
				} else {
					selectedChar = randomFromList(allTargets);
				}
				var sdChoice = cAdvancedScialGoalMissionChoice(this.charKey,selectedChar,"seduce");
				weight = 3 + + gC(this.charKey).dPleasure.level * 2 + gC(this.charKey).dDomination.level * 1 - gC(this.charKey).mood.angry * 0.1 + gC(this.charKey).mood.aroused * 0.1;
				if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 3 + covetTargets.length * 2; }
				frChoice.weight = weight;
				if ( frChoice.weight > 0 && isLewdingPossible(this.charKey,selectedChar) ) { mChoices.push(sdChoice); }
				
				if ( returnCharsUnlockedGenitals(this.charKey).length > 0 ) {
					// Have sex
					var sexDollTargets = [];
					for ( var sexDoll of gC(this.charKey).subChars ) {
						var relType = gRelTypeAb(sexDoll,this.charKey);
						if ( relType ) {
							if ( relType.forcedToSex ) { sexDollTargets.push(sexDoll); }
						}
					}	
					var hsTargets = covetTargets.concat(loveTargets).concat(sexDollTargets);
					if ( (hsTargets.length) > 0 ) {
						selectedChar = randomFromList(hsTargets);
						var hsChoice = cAdvancedScialGoalMissionChoice(this.charKey,selectedChar,"haveSex");
						var weight = 2 + gC(this.charKey).dLove.level * 1 + gC(this.charKey).dPleasure.level * 1 - gC(this.charKey).mood.angry * 0.1 + gC(this.charKey).mood.aroused * 0.1 + (1 - getBarPercentage(this.charKey,"lust")) * 20;
						if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 3 + hsTargets.length * 2; }
						weight = weight * ((3 - gC(this.charKey).sexScenesToday * 2 + gC(this.charKey).daysWithoutSex) / 3);
						hsChoice.weight = weight;
						if ( hsChoice.weight > 0 ) { mChoices.push(hsChoice); }
					}
					
					// Have dominating sex
					var dsTargets = covetTargets.concat(sexDollTargets).concat(sexDollTargets);
					if ( (dsTargets.length) > 0 ) {
						selectedChar = randomFromList(dsTargets);
						var dsChoice = cAdvancedScialGoalMissionChoice(this.charKey,selectedChar,"haveDomSex");
						var weight = 2 + gC(this.charKey).dPleasure.level * 2 + gC(this.charKey).dDomination.level * 2 - gC(this.charKey).mood.angry * 0.1 + gC(this.charKey).mood.aroused * 0.1 + (1 - getBarPercentage(this.charKey,"lust")) * 10;
						if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 3 + dsTargets.length * 2; }
						if ( getCharsDrivePercent(this.charKey,"dDomination") < 0.15 ) {
							weight = 0;
						} else if ( getCharsDrivePercent(this.charKey,"dDomination") + getCharsDrivePercent(this.charKey,"dAmbition") > 0.4 ) {
							weight *= 2;
						}
						weight = weight * ((3 - gC(this.charKey).sexScenesToday * 2 + gC(this.charKey).daysWithoutSex) / 3);
						dsChoice.weight = weight;
						if ( dsChoice.weight > 0 ) { mChoices.push(dsChoice); }
					}
				} else {
					var validKeyholders = arrayMinusA(getActorsKeyholders(this.charKey),this.charKey);
					if ( validKeyholders.length > 0 ) {
						selectedChar = randomFromList(validKeyholders);
						var fgChoice = cAdvancedScialGoalMissionChoice(this.charKey,selectedChar,"haveSex");
						var weight = 2 + gC(this.charKey).dPleasure.level * 2 + gC(this.charKey).mood.aroused * 0.2 + (1 - getBarPercentage(this.charKey,"lust")) * 20;
						if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 4; }
						weight = weight * ((3 - gC(this.charKey).sexScenesToday * 2 + gC(this.charKey).daysWithoutSex) / 3);
						fgChoice.weight = weight;
						if ( fgChoice.weight > 0 ) { mChoices.push(fgChoice); }
					}
				}
				
				// Get alliance
				var alTargets = allyTargets.concat(loveTargets);
				if ( alTargets.length > 0 ) {
					
					selectedChar = randomFromList(alTargets);
					var gaChoice = cAdvancedScialGoalMissionChoice(this.charKey,selectedChar,"getAlliance");
					var weight = 2 + gC(this.charKey).dLove.level * 1 + gC(this.charKey).dCooperation.level * 2 - gC(this.charKey).mood.angry * 0.1 + gC(this.charKey).mood.intimate * 0.1;
					if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2 + alTargets.length * 1.5; }
					if ( gC(this.charKey).egaChars.length < 2 ) {
						weight *= 0.5;
					} else if ( gC(this.charKey).egaChars.length >= 2 ) {
						weight = 0;
					}

					gaChoice.weight = weight;
					if ( gaChoice.weight > 0 ) { mChoices.push(gaChoice); }
					
				}
				
			}
			if ( (gC(this.charKey).mood.angry + 15 ) > ( gC(this.charKey).mood.friendly + gC(this.charKey).mood.flirty ) && enemyTargets.length > 0 ) {
				// Taunt
				selectedChar = randomFromList(enemyTargets);
				var tnChoice = cAdvancedScialGoalMissionChoice(this.charKey,selectedChar,"taunt");
				var weight = 4 + gC(this.charKey).mood.angry * 0.1 - gC(this.charKey).mood.friendly * 0.1;
				if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2 + enemyTargets.length * 2; }
				tnChoice.weight = weight;
				if ( tnChoice.weight > 0 ) { mChoices.push(tnChoice); }
			}
		}
		
		if ( gC(this.charKey).hasFreeBodypart("mouth") == false ) {
			for ( var mCh of mChoices ) {
				mCh.weight *= 0.2;
			}
		}
		
		return mChoices;
	}
	globalAi.generateSocializationChoices = function() {
		var mChoices = [];
		// Choose target
		var charsOnMap = getCurrentMap().characters;
		charsOnMap = arrayMinusA(charsOnMap,this.charKey);
		var weightedChars = listIntoWeightedList(charsOnMap);
		for ( var wItem in weightedChars ) {
			if ( weightedChars[wItem] instanceof weightedElement ) {
				weightedChars[wItem].w = getSocialPriorityAgainstTarget(gC(this.charKey).socialAi,weightedChars[wItem].content);
			}
		}
		var selectedChar = randomFromWeightedList(weightedChars);	

		// Find servants
		var subChars = gC(this.charKey).subChars;
		
		// Generic socialization mission choice
				
		var mChoice = cSocializationGoalsMissionChoice(this.charKey,selectedChar);
		
		// Weighted
		mChoice.weight = 5 + gC(this.charKey).dPleasure.level * 1 + gC(this.charKey).dLove.level * 1 + gC(this.charKey).dCooperation.level * 1;
		  // Higher weight if not training period
		if ( State.variables.simCycPar.templeDayPeriod != "training" ) {
			mChoice.weight += 5;
			mChoice.weight += gC(this.charKey).dPleasure.level * ( 5 + gC(this.charKey).daysWithoutSex ) + gC(this.charKey).dLove.level * 5 + gC(this.charKey).dCooperation.level * 5;
		}
		  // Lesser weight if character is angry or bored
		mChoice.weight -= (gC(this.charKey).mood.angry + (gC(this.charKey).mood.bored * 0.5));
		if ( mChoice.weight < 0 ) { mChoice.weight = 0; }
		if ( gC(this.charKey).socialdrive.current < 40 ) {
			mChoice.weight = 0;
		}
		
		mChoice.weight -= ( gC(this.charKey).mood.angry + gC(this.charKey).mood.bored >= 25 );
		
		if ( mChoice.weight != 0 ) { mChoices.push(mChoice); }
		
		// Socialize with servant mission choice
		if ( subChars.length > 0 ) {
			var mChoice2 = cSocializationGoalsMissionChoice(this.charKey,randomFromList(subChars));
			if ( State.variables.simCycPar.templeDayPeriod != "training" ) {
				mChoice2.weight = 20 + gC(this.charKey).daysWithoutSex * ( 20 + gC(this.charKey).dPleasure.level * 10 );
			} else { mChoice2.weight = 0; }
			mChoices.push(mChoice2);
		}
		return mChoices;
	}
	
	globalAi.generateAdvancedCombatChoices = function() {
		var mChoices = [];
		
		if ( gSettings().challengingAllowed || gSettings().assaultingAllowed ) {
			// Get potential targets
			var potentialChallengeTargets = [];
			var potentialAssaultTargets = [];
			var potentialRandomChallenge = [];
			var potentialRandomAssault = [];
			var potentialChallengeRivals = [];
			var potentialAssaultRivals = [];
			var potentialChallengeConquests = [];
			var potentialAssaultConquests = [];
			var validSubSource = [];
			var oppressors = [];
			var validAssaultOppressors = [];
			var validCasusBelliRetribution = [];
		
			for ( var cK of getActiveSimulationCharactersArray() ) {
				if ( cK != this.charKey && gC(cK).followingTo == "" ) {
					if ( gC(cK).domChar == null ) {
						validSubSource.push(cK);
					}
					if ( quantifyCharactersGroupStrength(cK) < quantifyCharactersGroupStrength(this.charKey) * 1.1 && isAssaultPossible(this.charKey,cK) ) { // Assault targets
						potentialAssaultTargets.push(cK);
						if ( gC(this.charKey).socialAi.rivalTs.includes(cK) ) {
							potentialAssaultRivals.push(cK);
						}
						if ( gC(this.charKey).socialAi.conquestTs.includes(cK) ) {
							potentialAssaultConquests.push(cK);
						}
						if ( oppressors.includes(cK) ) {
							validAssaultOppressors.push(cK);
						}
						if ( gC(this.charKey).cbl.includes(cK) ) {
							validCasusBelliRetribution.push(cK);
						}
					} else if ( quantifyCharactersGroupStrength(cK) < quantifyCharactersGroupStrength(this.charKey) * 0.9 ) { // Casus belli targets
						if ( gC(this.charKey).cbl.includes(cK) ) {
							validCasusBelliRetribution.push(cK);
						}
					}
					if ( quantifyCharacterStrength(cK) < quantifyCharacterStrength(this.charKey) * 1.1 && isChallengePossible(this.charKey,cK) ) { // Challenge targets
						potentialChallengeTargets.push(cK);
						if ( gC(this.charKey).socialAi.rivalTs.includes(cK) ) {
							potentialChallengeRivals.push(cK);
						}
						if ( gC(this.charKey).socialAi.conquestTs.includes(cK) ) {
							potentialChallengeConquests.push(cK);
						}
					}
				}
			}
			for ( var cK of getActiveSimulationCharactersArray() ) {
				if ( gC(this.charKey).socialAi.loveTs.includes(cK) == false ) {
					if ( (gC(cK).domChar != "") && (gC(cK).domChar != null) && (gC(cK).domChar != this.charKey) ) {
						if ( gRelTypeAb(cK,gC(cK).domChar).type == "servitude" ) {
							oppressors.push(gC(cK).domChar);
						}
					}
				}
			}
			
			// Potential missions
			if ( potentialAssaultTargets.length > 0 || potentialChallengeTargets.length > 0 && ( gC(this.charKey).infamy < getCharsInfamyLimit(this.charKey) ) ) {
				var selectedChar = "";
				// Challenge mission
				var challengeFactor = 8 + (getCharsDrivePercent(this.charKey,"dImprovement") + getCharsDrivePercent(this.charKey,"dAmbition")) * 5;
				if ( potentialChallengeTargets.length > 0 ) {
					selectedChar = randomFromList(potentialChallengeTargets);
					var chChoice = cChallengeGoalsMissionChoice(this.charKey,selectedChar,"challenge");
					var weight = 1 + gC(this.charKey).dImprovement.level + gC(this.charKey).dAmbition.level;
					if ( gC(this.charKey).infamy == 0 ) { weight += 6; }
					if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2; }
					chChoice.weight = weight;
					if ( chChoice.weight > 0 && canActorAttackTarget(this.charKey,selectedChar) ) { mChoices.push(chChoice); }
				}
				
				// Gain merit	
				var meritFactor = getCharsDrivePercent(this.charKey,"dAmbition") * 6;
				if ( meritFactor > 1 && potentialChallengeTargets.length > 0 ) {
					selectedChar = randomFromList(potentialChallengeTargets.concat(potentialChallengeRivals));
					var hmChoice = cChallengeGoalsMissionChoice(this.charKey,selectedChar,"humilliate");
					var weight = 1 + gC(this.charKey).dAmbition.level * 2;
					if ( gC(this.charKey).infamy == 0 ) { weight += 4; }
					if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2; }
					hmChoice.weight = weight;
					if ( hmChoice.weight > 0 && canActorAttackTarget(this.charKey,selectedChar) ) { mChoices.push(hmChoice); }
				}
				// Weaken enemy
				if (  potentialChallengeRivals.length > 0 ) {
					selectedChar = randomFromList(potentialChallengeRivals);
					var weChoice = cChallengeGoalsMissionChoice(this.charKey,selectedChar,"weakenEnemy");
					var weight = 3 * (quantifyCharacterStats(selectedChar) / quantifyCharacterStats(this.charKey)) + gC(selectedChar).infamy - gC(this.charKey).infamy;
					if ( gC(this.charKey).infamy == 0 ) { weight += 6; }
					if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2; }
					weChoice.weight = weight;
					if ( weChoice.weight > 0 && canActorAttackTarget(this.charKey,selectedChar) ) { mChoices.push(weChoice); }
				} else if ( potentialAssaultRivals.length > 0 ) {
					selectedChar = randomFromList(potentialAssaultRivals);
					var weChoice = cAssaultGoalsMissionChoice(this.charKey,selectedChar,"weakenEnemy");
					var weight = 10 + (quantifyCharacterStats(selectedChar) - quantifyCharacterStats(this.charKey));
					if ( gC(this.charKey).infamy == 0 ) { weight += 6; }
					if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2; }
					weChoice.weight = weight;
					if ( weChoice.weight > 0 && canActorAttackTarget(this.charKey,selectedChar) ) { mChoices.push(weChoice); }
				}
				// Gain domination
				var dominationFactor = (getCharsDrivePercent(this.charKey,"dDomination") + getCharsDrivePercent(this.charKey,"dPleasure") * 0.5) * 6;
				if ( dominationFactor > 1.2 ) {
					var challengeConquestTs = potentialChallengeConquests.concat(potentialChallengeConquests).concat(potentialChallengeTargets);
					var assaultConquestTs = potentialAssaultConquests.concat(potentialAssaultConquests).concat(potentialAssaultConquests);
					if (  challengeConquestTs.length > 0 ) {
						selectedChar = randomFromList(challengeConquestTs);
						var gdChoice = cChallengeGoalsMissionChoice(this.charKey,selectedChar,"gainDomination");
						var weight = 1 + gC(this.charKey).dDomination.level * 2;
						if ( gC(this.charKey).infamy == 0 ) { weight += 7; }
						if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2; }
						gdChoice.weight = weight;
						if ( gdChoice.weight > 0 && canActorAttackTarget(this.charKey,selectedChar) ) { mChoices.push(gdChoice); }
					} else if ( assaultConquestTs.length > 0 ) {
						selectedChar = randomFromList(assaultConquestTs);
						var gdChoice = cAssaultGoalsMissionChoice(this.charKey,selectedChar,"gainDomination");
						var weight = 1 + gC(this.charKey).dDomination.level * 2;
						if ( gC(this.charKey).infamy == 0 ) { weight += 7; }
						if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2; }
						gdChoice.weight = weight;
						if ( gdChoice.weight > 0 && canActorAttackTarget(this.charKey,selectedChar) ) { mChoices.push(gdChoice); }
					}
				}
				// Force sex
				var forceSexFactor = (getCharsDrivePercent(this.charKey,"dDomination") * 0.5 + getCharsDrivePercent(this.charKey,"dPleasure")) * 6;
				if ( forceSexFactor > 1.2 ) {
					var challengeConquestTs = potentialChallengeConquests.concat(potentialChallengeConquests).concat(potentialChallengeTargets);
					var assaultConquestTs = potentialAssaultConquests.concat(potentialAssaultConquests).concat(potentialAssaultConquests);
					if (  challengeConquestTs.length > 0 ) {
						selectedChar = randomFromList(challengeConquestTs);
						var fsChoice = cChallengeGoalsMissionChoice(this.charKey,selectedChar,"forceSex");
						var weight = 1 + gC(this.charKey).dPleasure.level * 2 + gC(this.charKey).daysWithoutSex;
						if ( gC(this.charKey).infamy == 0 ) { weight += 7; }
						if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2; }
						fsChoice.weight = weight;
						if ( fsChoice.weight > 0 && canActorAttackTarget(this.charKey,selectedChar) && isLewdingPossible(this.charKey,selectedChar) ) { mChoices.push(fsChoice); }
					} else if ( assaultConquestTs.length > 0 ) {
						selectedChar = randomFromList(assaultConquestTs);
						var fsChoice = cAssaultGoalsMissionChoice(this.charKey,selectedChar,"forceSex");
						var weight = 1 + gC(this.charKey).dPleasure.level * 2 + gC(this.charKey).daysWithoutSex;
						if ( gC(this.charKey).infamy == 0 ) { weight += 7; }
						if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2; }
						fsChoice.weight = weight;
						if ( fsChoice.weight > 0 && canActorAttackTarget(this.charKey,selectedChar) && isLewdingPossible(this.charKey,selectedChar) ) { mChoices.push(fsChoice); }
					}
				}
				// Gain submissive
				var gainSubFactor = (getCharsDrivePercent(this.charKey,"dAmbition") * 3 + getCharsDrivePercent(this.charKey,"dDomination")) * 4;
				if ( gainSubFactor > 1.3 && ( (gC(this.charKey).infamy * 1.8) < gSettings().infamyLimit ) ) {
					var challengeConquestTs = potentialChallengeConquests.concat(potentialChallengeRivals).concat(potentialChallengeTargets);
					var assaultConquestTs = potentialAssaultConquests.concat(potentialAssaultRivals).concat(potentialAssaultConquests);
					var challengeTs = [];
					var assaultTs = [];
					for ( var c of challengeConquestTs ) {if ( validSubSource.includes(c) ) { challengeTs.push(c); } }
					for ( var c of assaultConquestTs ) { if ( validSubSource.includes(c) ) { assaultTs.push(c); } }
					if (  challengeTs.length > 0 ) {
						selectedChar = randomFromList(challengeTs);
						var fdChoice = cChallengeGoalsMissionChoice(this.charKey,selectedChar,"gainSubmissive");
						var weight = 1 + gC(this.charKey).dAmbition.level + gC(this.charKey).dPleasure.level + gC(this.charKey).dDomination.level; 
						if ( gC(this.charKey).infamy == 0 ) { weight += 13; }
						if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2; }
						fdChoice.weight = weight;
						if ( fdChoice.weight > 0 && canActorAttackTarget(this.charKey,selectedChar) ) { mChoices.push(fdChoice); }
					} else if ( assaultTs.length > 0 ) {
						selectedChar = randomFromList(assaultTs);
						var fdChoice = cAssaultGoalsMissionChoice(this.charKey,selectedChar,"gainSubmissive");
						var weight = 1 + gC(this.charKey).dAmbition.level + gC(this.charKey).dPleasure.level + gC(this.charKey).dDomination.level; 
						if ( gC(this.charKey).infamy == 0 ) { weight += 13; }
						if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2; }
						fdChoice.weight = weight;
						if ( fdChoice.weight > 0 && canActorAttackTarget(this.charKey,selectedChar) ) { mChoices.push(fdChoice); }
					}
				}
				// Liberate friend
				var liberateFriendFactor = (getCharsDrivePercent(this.charKey,"dCooperation")+ getCharsDrivePercent(this.charKey,"dLove")) * 6;
				if ( validAssaultOppressors.length > 0 && liberateFriendFactor > 1.8 ) {
					selectedChar = randomFromList(validAssaultOppressors);
					var lfChoice = cAssaultGoalsMissionChoice(this.charKey,selectedChar,"liberateFriend");
					var weight = 1 + gC(this.charKey).dCooperation.level * 2 + gC(this.charKey).dLove.level * 2; 
					if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2.5; }
					lfChoice.weight = weight;
					if ( lfChoice.weight > 0 && canActorAttackTarget(this.charKey,selectedChar) ) { mChoices.push(lfChoice); }
				}
				// Casus belli retribution
				if ( validCasusBelliRetribution.length > 0 ) {
					selectedChar = randomFromList(validCasusBelliRetribution);
					var cbrChoice = cAssaultGoalsMissionChoice(this.charKey,selectedChar,"cbRetribution");
					var weight = 1 - gC(this.charKey).dCooperation.level * 1 + gC(this.charKey).dAmbition.level * 1 + gC(this.charKey).dDomination.level * 2;
					if ( State.variables.simCycPar.templeDayPeriod != "training" ) { weight *= 2.5; }
					cbrChoice.weight = weight;
					if ( cbrChoice.weight > 0 && canActorAttackTarget(this.charKey,selectedChar) ) { mChoices.push(cbrChoice); }
				}
			}
		}
		
		return mChoices;
	}
	globalAi.generateCombatChoices = function() {
		var choices = [];
		
		if ( gSettings().challengingAllowed || gSettings().assaultingAllowed ) {
			var selfStrength = quantifyCharactersGroupStrength(this.charKey);
			var potentialTargets = [];
			for ( var cK of getActiveSimulationCharactersArray() ) {
				if ( cK != this.charKey && gC(cK).followingTo == "" ) {
					if ( quantifyCharactersGroupStrength(cK) < quantifyCharactersGroupStrength(this.charKey) * 1.1 ) {
						potentialTargets.push(cK);
					}
				}
			}
			var selectedTarget = "";
			var highestScore = -1000;
			for ( var posTarget of potentialTargets ) {
				var currentScore = (selfStrength / quantifyCharactersGroupStrength(posTarget)) * 20 + gC(posTarget).infamy + limitedRandomInt(15)
								 + rLvlAbt(this.charKey,posTarget,"rivalry") * 2;
				if ( currentScore > highestScore ) {
					highestScore = currentScore;
					selectedTarget = posTarget;
				}
			}
			if ( selectedTarget != "" ) {
				var mChoice1 = cChallengeGoalsMissionChoice(this.charKey,selectedTarget,"challenge");
				var mChoice2 = cAssaultGoalsMissionChoice(this.charKey,selectedTarget,"assault");
				
				// WEIGHT WEIGHTS
				if ( State.variables.simCycPar.templeDayPeriod != "training" ) {
					mChoice1.weight += 10 + gC(this.charKey).dAmbition.level * 6 + gC(this.charKey).dImprovement.level * 3;
					mChoice2.weight += 10 + gC(this.charKey).dAmbition.level * 3 + gC(this.charKey).dDomination.level * 6;
				}
				mChoice2.weight -= gC(this.charKey).infamy;
				
				var generalWeightMult = 0.2;
				mChoice1.weight *= generalWeightMult * 2;
				mChoice2.weight *= generalWeightMult;
				
				if ( this.attackedToday ) {
					mChoice1.weight *= 0.1;
					mChoice2.weight *= 0.1;
				}
				
				if ( mChoice1.weight < 0 ) { mChoice1.weight = 0; }
				if ( mChoice2.weight < 0 ) { mChoice2.weight = 0; }
				choices.push(mChoice1);
				choices.push(mChoice2);
			}
		}
		
		return choices;
	}
	
	globalAi.generateMissionChoices = function() {
		// this->Generate stat goals
		var mChoices = [];
		
		// Training
		for ( var choice of this.generateTrainingChoices(this.charKey) ) {
			mChoices.push(choice);
		}
		mChoices.push(this.generateRestMissionChoice());
		
		if ( gC(this.charKey).mood.angry < 25 && gC(this.charKey).mood.bored < 25 && gSettings().talkingAllowed ) {
			// Social
			for ( var choice of this.generateAdvancedSocializationChoices() ) {
				mChoices.push(choice);
			}
		}
		
		// Scrolls
		for ( var choice of this.generateScrollsChoices(this.charKey) ) {
			mChoices.push(choice);
		}
		
		// Combat
		if ( gSettings().challengingAllowed || gSettings().assaultingAllowed ) {
			for ( var choice of this.generateAdvancedCombatChoices(this.charKey) ) {
				mChoices.push(choice);
			}/*
			for ( var choice of this.generateCombatChoices(this.charKey) ) {
				mChoices.push(choice);
			}*/
		}
		
		return mChoices;
	}
	globalAi.purgeChoicesAtLowBars = function(choices) {
		var nChoices = [];
		for ( var choice of choices ) {
			for ( var rBar of choice.reqBars ) {
				if ( gC(this.charKey)[rBar].current < gC(this.charKey)[rBar].max * 0.2 ) {
					// Purge choice if the character has any of its required bars below 20% of the required value
					choice.weight = 0;
				}
			}
			if ( choice.weight > 0 ) {
				nChoices.push(choice);
			}
		}
		return nChoices;
	}
	globalAi.getWeightedRandomMissionChoices = function(choices) {
		
		var wList = new weightedList();
		var i = 0;
		var result = null;
		if ( choices.length > 0 ) {
			for ( var choice of choices ) {
				wList[i] = new weightedElement(i,choice.weight);
				i++;
			}
			result = choices[randomFromWeightedList(wList)];
			if ( result == "errorWList" ) { result = null; }
		}
		return result;
	}
	globalAi.getMission = function() {
		var choices = this.generateMissionChoices();
		choices = this.purgeChoicesAtLowBars(choices);
		var choice = this.getWeightedRandomMissionChoices(choices);
		gC(this.charKey).mission = choice.title;
		// Logging //
		if ( State.variables.log[choice.title] == undefined ) {
			State.variables.log[choice.title] = 1;
		} else {
			State.variables.log[choice.title] += 1;
		}
		//         //
		
		return choice.getCommandsList(this.charKey);
	}
	
	return globalAi;
}

window.createCandidateGcAi = function(charKey) {
	var globalAi = new NpcGlobalAi(charKey);
	globalAi.type = "candidateGc";
	
	globalAi.generalEvaluations = function() {
	}
	
	globalAi.generateRestMissionChoice = function() {
		var mChoice = cRestMissionChoice(this.charKey);
		
		mChoice.weight = 1;
		if ( gC(this.charKey).lust.current < ( gC(this.charKey).lust.max * gBarLowThreshold() ) ) { mChoice.weight *= 10; }
		if ( gC(this.charKey).willpower.current < ( gC(this.charKey).willpower.max * gBarLowThreshold() ) ) { mChoice.weight *= 10; }
		if ( gC(this.charKey).energy.current < ( gC(this.charKey).energy.max * gBarLowThreshold() ) ) { mChoice.weight *= 10; }
		if ( gC(this.charKey).socialdrive.current < ( gC(this.charKey).socialdrive.max * gBarLowThreshold() ) ) { mChoice.weight *= 10; }
		
		return mChoice;
	}
	globalAi.generateTrainingChoices = function(charKey) {
		return [cTrainCharismaMissionChoice(charKey),cTrainEmpathyMissionChoice(charKey),
				cTrainIntelligenceMissionChoice(charKey),cTrainPerceptionMissionChoice(charKey),
				cTrainPhysiqueMissionChoice(charKey),cTrainResilienceMissionChoice(charKey)];
	}
	
	globalAi.generateMissionChoices = function() {
		// this->Generate stat goals
		var mChoices = [];
		
		// Training
		for ( var choice of this.generateTrainingChoices(this.charKey) ) {
			mChoices.push(choice);
		}
		mChoices.push(this.generateRestMissionChoice());
		
		return mChoices;
	}
	globalAi.getMission = function() {
		var choices = this.generateMissionChoices();
		choices = this.purgeChoicesAtLowBars(choices);
		var choice = this.getWeightedRandomMissionChoices(choices);
		gC(this.charKey).mission = choice.title;
		
		return choice.getCommandsList(this.charKey);
	}
	
	return globalAi;
}
window.createValGcAi = function(charKey) {
	var globalAi = new NpcGlobalAi(charKey);
	globalAi.type = "valGc";
	
	globalAi.generalEvaluations = function() {
	}
	
	globalAi.generateRestMissionChoice = function() {
		var mChoice = cRestMissionChoice(this.charKey);
		
		mChoice.weight = 1;
		if ( gC(this.charKey).lust.current < ( gC(this.charKey).lust.max * gBarLowThreshold() ) ) { mChoice.weight *= 10; }
		if ( gC(this.charKey).willpower.current < ( gC(this.charKey).willpower.max * gBarLowThreshold() ) ) { mChoice.weight *= 10; }
		if ( gC(this.charKey).energy.current < ( gC(this.charKey).energy.max * gBarLowThreshold() ) ) { mChoice.weight *= 10; }
		if ( gC(this.charKey).socialdrive.current < ( gC(this.charKey).socialdrive.max * gBarLowThreshold() ) ) { mChoice.weight *= 10; }
		
		return mChoice;
	}
	globalAi.generateTrainingChoices = function(charKey) {
		return [cTrainLuckMissionChoice(charKey)];
	}
	
	globalAi.generateMissionChoices = function() {
		// this->Generate stat goals
		var mChoices = [];
		
		// Training
		for ( var choice of this.generateTrainingChoices(this.charKey) ) {
			mChoices.push(choice);
		}
		mChoices.push(this.generateRestMissionChoice());
		
		return mChoices;
	}
	globalAi.getMission = function() {
		var choices = this.generateMissionChoices();
		choices = this.purgeChoicesAtLowBars(choices);
		var choice = this.getWeightedRandomMissionChoices(choices);
		gC(this.charKey).mission = choice.title;
		
		return choice.getCommandsList(this.charKey);
	}
	
	return globalAi;
}

	// Aux methods
NpcGlobalAi.prototype.purgeChoicesAtLowBars = function(choices,charKey) {
	var nChoices = [];
	for ( var choice of choices ) {
		for ( var rBar of choice.reqBars ) {
			if ( gC(this.charKey)[rBar].current < gC(this.charKey)[rBar].max * 0.2 ) {
				// Purge choice if the character has any of its required bars below 20% of the required value
				choice.weight = 0;
			}
		}
		if ( choice.weight > 0 ) {
			nChoices.push(choice);
		}
	}
	return nChoices;
}
NpcGlobalAi.prototype.getWeightedRandomMissionChoices = function(choices) {
	var wList = new weightedList();
	var i = 0;
	var result = null;
	if ( choices.length > 0 ) {
		for ( var choice of choices ) {
			wList[i] = new weightedElement(i,choice.weight);
			i++;
		}
		result = choices[randomFromWeightedList(wList)];
		if ( result == "errorWList" ) { result = null; }
	}
	return result;
}

// Constructors, serializers, etc.
NpcGlobalAi.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
NpcGlobalAi.prototype.clone = function () {
	return (new NpcGlobalAi())._init(this);
};
NpcGlobalAi.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new NpcGlobalAi())._init($ReviveData$)', ownData);
};

////////// SELF-EVALUATION //////////
// A few functions that allow a character to evaluate their own situation, consider dangers and determine safety requirements

////////// GLOBAL-AI MISSION-CHOICE CLASS //////////

window.missionChoice = function(title) {
	// General data about the mission type. These are selected and used by globalAi to understand details about the mission type.
	// They also contain references to the functions that create the missions themselves.
	this.title = title;
	this.weight = 10;
	this.reqBars = [];
	this.tags = [];
	this.isValid = function() {
		return true;
	}
	this.getCommandsList = function() {
		return [];
	}
};

	// Training
window.cTrainPhysiqueMissionChoice = function(character) {
	var mChoice = new missionChoice("trainPhysique");
	mChoice.reqBars.push("energy");
	mChoice.tags = ["physique"];
	mChoice.isValid = function() {
		// Return valid if at least one action in map allows training of physique
		return ( getAllActionsOnMapThat(getCurrentMap(),getCharGroup(character),function(action) { return action.tags.includes("physique"); }).length > 0 );		
	}
	mChoice.getCommandsList = function() {
		return cMissionActionTag(getCurrentMap(),getCharGroup(character),"physique");
	}
	mChoice.weight = 4 + gC(character).dImprovement.level * 5 + gC(character).dAmbition.level * 2;
	if ( gC(character).globalAi.statGoals != undefined ) {
		mChoice.weight += gC(character).globalAi.statGoals[0] - gC(character).physique.value;
	}
	return mChoice;
}
window.cTrainAgilityMissionChoice = function(character) {
	var mChoice = new missionChoice("trainAgility");
	mChoice.reqBars.push("energy");
	mChoice.tags = ["agility"];
	mChoice.isValid = function() {
		// Return valid if at least one action in map allows training of physique
		return ( getAllActionsOnMapThat(getCurrentMap(),getCharGroup(character),function(action) { return action.tags.includes("agility"); }).length > 0 );		
	}
	mChoice.getCommandsList = function() {
		return cMissionActionTag(getCurrentMap(),getCharGroup(character),"agility");
	}
	mChoice.weight = 4 + gC(character).dImprovement.level * 5 + gC(character).dAmbition.level * 2;
	if ( gC(character).globalAi.statGoals != undefined ) {
		mChoice.weight += gC(character).globalAi.statGoals[1] - gC(character).agility.value;
	}
	return mChoice;
}
window.cTrainResilienceMissionChoice = function(character) {
	var mChoice = new missionChoice("trainResilience");
	mChoice.reqBars.push("energy");
	mChoice.tags = ["resilience"];
	mChoice.isValid = function() {
		// Return valid if at least one action in map allows training of physique
		return ( getAllActionsOnMapThat(getCurrentMap(),getCharGroup(character),function(action) { return action.tags.includes("resilience"); }).length > 0 );		
	}
	mChoice.getCommandsList = function() {
		return cMissionActionTag(getCurrentMap(),getCharGroup(character),"resilience");
	}
	mChoice.weight = 4 + gC(character).dImprovement.level * 5 + gC(character).dAmbition.level * 2;
	if ( gC(character).globalAi.statGoals != undefined ) {
		mChoice.weight += gC(character).globalAi.statGoals[2] - gC(character).resilience.value;
	}
	return mChoice;
}
window.cTrainWillMissionChoice = function(character) {
	var mChoice = new missionChoice("trainWill");
	mChoice.reqBars.push("willpower");
	mChoice.tags = ["will"];
	mChoice.isValid = function() {
		// Return valid if at least one action in map allows training of physique
		return ( getAllActionsOnMapThat(getCurrentMap(),getCharGroup(character),function(action) { return action.tags.includes("will"); }).length > 0 );		
	}
	mChoice.getCommandsList = function() {
		return cMissionActionTag(getCurrentMap(),getCharGroup(character),"will");
	}
	mChoice.weight = 4 + gC(character).dImprovement.level * 5 + gC(character).dAmbition.level * 2;
	if ( gC(character).globalAi.statGoals != undefined ) {
		mChoice.weight += gC(character).globalAi.statGoals[3] - gC(character).will.value;
	}
	return mChoice;
}
window.cTrainIntelligenceMissionChoice = function(character) {
	var mChoice = new missionChoice("trainIntelligence");
	mChoice.reqBars.push("willpower");
	mChoice.tags = ["intelligence"];
	mChoice.isValid = function() {
		// Return valid if at least one action in map allows training of physique
		return ( getAllActionsOnMapThat(getCurrentMap(),getCharGroup(character),function(action) { return action.tags.includes("intelligence"); }).length > 0 );		
	}
	mChoice.getCommandsList = function() {
		return cMissionActionTag(getCurrentMap(),getCharGroup(character),"intelligence");
	}
	mChoice.weight = 4 + gC(character).dImprovement.level * 5 + gC(character).dAmbition.level * 2;
	if ( gC(character).globalAi.statGoals != undefined ) {
		mChoice.weight += gC(character).globalAi.statGoals[4] - gC(character).intelligence.value;
	}
	return mChoice;
}
window.cTrainPerceptionMissionChoice = function(character) {
	var mChoice = new missionChoice("trainPerception");
	mChoice.reqBars.push("willpower");
	mChoice.tags = ["perception"];
	mChoice.isValid = function() {
		// Return valid if at least one action in map allows training of physique
		return ( getAllActionsOnMapThat(getCurrentMap(),getCharGroup(character),function(action) { return action.tags.includes("percetion"); }).length > 0 );		
	}
	mChoice.getCommandsList = function() {
		return cMissionActionTag(getCurrentMap(),getCharGroup(character),"perception");
	}
	mChoice.weight = 4 + gC(character).dImprovement.level * 5 + gC(character).dAmbition.level * 2;
	if ( gC(character).globalAi.statGoals != undefined ) {
		mChoice.weight += gC(character).globalAi.statGoals[5] - gC(character).perception.value;
	}
	return mChoice;
}
window.cTrainEmpathyMissionChoice = function(character) {
	var mChoice = new missionChoice("trainEmpathy");
	mChoice.reqBars.push("socialdrive");
	mChoice.tags = ["empathy"];
	mChoice.isValid = function() {
		// Return valid if at least one action in map allows training of physique
		return ( getAllActionsOnMapThat(getCurrentMap(),getCharGroup(character),function(action) { return action.tags.includes("empathy"); }).length > 0 );		
	}
	mChoice.getCommandsList = function() {
		return cMissionActionTag(getCurrentMap(),getCharGroup(character),"empathy");
	}
	mChoice.weight = 4 + gC(character).dImprovement.level * 5 + gC(character).dAmbition.level * 2;
	if ( gC(character).globalAi.statGoals != undefined ) {
		mChoice.weight += gC(character).globalAi.statGoals[6] - gC(character).empathy.value;
	}
	return mChoice;
}
window.cTrainCharismaMissionChoice = function(character) {
	var mChoice = new missionChoice("trainCharisma");
	mChoice.reqBars.push("socialdrive");
	mChoice.tags = ["charisma"];
	mChoice.isValid = function() {
		// Return valid if at least one action in map allows training of physique
		return ( getAllActionsOnMapThat(getCurrentMap(),getCharGroup(character),function(action) { return action.tags.includes("charima"); }).length > 0 );		
	}
	mChoice.getCommandsList = function() {
		return cMissionActionTag(getCurrentMap(),getCharGroup(character),"charisma");
	}
	mChoice.weight = 4 + gC(character).dImprovement.level * 5 + gC(character).dAmbition.level * 2;
	if ( gC(character).globalAi.statGoals != undefined ) {
		mChoice.weight += gC(character).globalAi.statGoals[7] - gC(character).charisma.value;
	}
	return mChoice;
}
window.cTrainLuckMissionChoice = function(character) {
	var mChoice = new missionChoice("trainLuck");
	mChoice.tags = ["luck"];
	mChoice.isValid = function() {
		// Return valid if at least one action in map allows training of physique
		return ( getAllActionsOnMapThat(getCurrentMap(),getCharGroup(character),function(action) { return action.tags.includes("luck"); }).length > 0 );		
	}
	mChoice.getCommandsList = function() {
		return cMissionActionTag(getCurrentMap(),getCharGroup(character),"luck");
	}
	mChoice.weight = 4 + gC(character).dImprovement.level * 5 + gC(character).dAmbition.level * 2;
	if ( gC(character).globalAi.statGoals != undefined ) {
		mChoice.weight += gC(character).globalAi.statGoals[8] - gC(character).luck.value;
	}
	return mChoice;
}

	// Rest
window.cRestMissionChoice = function(character) {
	var mChoice = new missionChoice("rest");
	mChoice.tags = ["rest"];
	mChoice.isValid = function() {
		// Return valid if at least one action in map allows to rest
		return ( getAllActionsOnMapThat(getCurrentMap(),getCharGroup(character),function(action) { return action.tags.includes("rest"); }).length > 0 );		
	}
	mChoice.getCommandsList = function() {
		return cMissionActionTag(getCurrentMap(),getCharGroup(character),"rest");
	}
	return mChoice;
}

	// Scrolls
window.cSearchScrollsMissionChoice = function(character) {
	var mChoice = new missionChoice("searchScrolls");
	mChoice.tags = ["searchScrolls"];
	mChoice.isValid = function() {
		var flagValid = false;
		// If character may find at least one scroll and there's a room that allows searching for scrolls, it's valid
		if ( getScrollsCharMayFind(character).length > 0 ) {
			if ( getAllActionsOnMapThat(getCurrentMap(),getCharGroup(character),function(action) { return action.tags.includes("searchScrolls"); }).length > 0 ) {
				flagValid = true;
			}
		}
		return flagValid;
	}
	mChoice.getCommandsList = function() {
		return cMissionActionTag(getCurrentMap(),getCharGroup(character),"searchScrolls");
	}
	return mChoice;
}
window.cStudyScrollMissionChoice = function(character) {
	var mChoice = new missionChoice("studyScroll");
	mChoice.tags = ["studyScroll"];
	mChoice.isValid = function() {
		var flagValid = false;
		// If character may study at least one scroll and there's a room that allows studying scrolls, it's valid
		if ( (gC(character).studiedScrolls.length < gC(character).foundScrolls.length) && (gC(character).studiedScrollToday == false) ) {
			if ( getAllActionsOnMapThat(getCurrentMap(),getCharGroup(character),function(action) { return action.tags.includes("studyScroll"); }).length > 0 ) {
				flagValid = true;
			}
		}
		return flagValid;
	}
	mChoice.getCommandsList = function() {
		return cMissionActionTag(getCurrentMap(),getCharGroup(character),"studyScroll");
	}
	return mChoice;
}

	// Socialization
window.cSocializationGoalsMissionChoice = function(character,targetCharacter) {
	var mChoice = new missionChoice("socializationGoals");
	mChoice.isValid = function() {
		return ( getCurrentMap().characters.includes(targetCharacter) );
	}
	mChoice.getCommandsList = function() {
		return cMissionPursueAndTalkTo(getCurrentMap(),getCharGroup(character),targetCharacter);
	}
	return mChoice;
}
window.cAdvancedScialGoalMissionChoice = function(actor,target,missionName) {
	var mChoice = new missionChoice(missionName);
	mChoice.isValid = function() {
		return ( getCurrentMap().characters.includes(target) );
	}
	mChoice.getCommandsList = function() {
		return cMissionPursueAndTalkTo(getCurrentMap(),getCharGroup(actor),target);
	}
	return mChoice;
}

	// Combat
window.cChallengeGoalsMissionChoice = function(character,targetCharacter,missionName) {
	var mChoice = new missionChoice(missionName);
	mChoice.isValid = function() {
		var isValid = false;
		if ( getCurrentMap().character.includes(targetCharacter) && isChallengePossible(character,targetCharacter) ) {
			isValid = true;
		}
		return isValid;
	}
	mChoice.getCommandsList = function() {
		return cMissionPursueAndChallenge(getCharGroup(character),targetCharacter);
	}
	return mChoice;
}
window.cAssaultGoalsMissionChoice = function(character,targetCharacter,missionName) {
	var mChoice = new missionChoice(missionName);
	mChoice.isValid = function() {
		var isValid = false;
		if ( getCurrentMap().character.includes(targetCharacter) && isAssaultPossible(character,targetCharacter) ) {
			isValid = true;
		}
		return isValid;
	}
	mChoice.getCommandsList = function() {
		return cMissionPursueAndAssault(getCharGroup(character),targetCharacter);
	}
	return mChoice;
}

	// Join assault
window.considerPossibleAssaults = function(charKey) {
	var joinedChar = "";
	var potentialTargets = [];		
	var potentialTargetsValues = [];
	
	// Find potential targets
	var currentRoom = gC(charKey).currentRoom;
	var charsInRoom = getRoomA(currentRoom).characters;
	for ( var target of charsInRoom ) {
		if ( target != charKey && gC(target).followingTo == "" ) {
			var sEvent = getCharsActiveEvent(target);
			if ( mayBattleBeJoinedByChar(sEvent,charKey) ) {
				potentialTargets.push(target);
			}
		}
	}
	
	// Assign score to join assault
	var requiredScore = 5 + gC(charKey).dImprovement.level * 2 + gC(charKey).dDomination.level * 2 - gC(charKey).dAmbition.level - gC(charKey).dCooperation.level * 3 + quantifyCharacterTiredness(charKey) * 5;
	
	// Assign scores to potential targets
	var i = 0;
	for ( var pt of potentialTargets ) {
		potentialTargetsValues.push(assignValueToAssaultChoice(charKey,pt));
		//pt.value = assignValueToAssaultChoice(charKey,pt);
	}
	
	// Get highest score
	var highestScore = -1;
	var chosenTarget = "";
	for ( var pt of potentialTargets ) {
		if ( highestScore < potentialTargetsValues[i] ) {
			highestScore = potentialTargetsValues[i];
			chosenTarget = pt;
		}
		i++;
	}
	
	// If highest score is higher than assigned score, return corresponding char
	if ( highestScore > requiredScore ) {
		if ( chosenTarget != "" ) {
			joinedChar = chosenTarget;
		}
	}
	
	return joinedChar;
}
window.assignValueToAssaultChoice = function(consideringChar,consideredChar) {
	// This function assumes that considered char is in an assault event
	var opposingChar = "";
	var handicap = 0;
	var sEvent = getCharsActiveEvent(consideredChar);
	var flagIsTargetAttacking = false;
	if ( sEvent.charactersTeamA[0] == consideredChar ) {
		flagIsTargetAttacking = true;
		opposingChar = sEvent.charactersTeamB[0];
		handicap = -10;
	} else {
		opposingChar = sEvent.charactersTeamA[0];
	}
	return ( assignValueToCharInAssault(consideringChar,consideredChar) + assignValueToCharInAssault(consideringChar,opposingChar) + handicap );
}
window.assignValueToCharInAssault = function(consideringChar,consideredChar) {
	var result = 0;
	var strengthDifference = quantifyCharacterStats(consideringChar) - quantifyCharacterStats(consideredChar); // More likely to help weaker characters
	var relationFactor = rLvlAbt(consideringChar,consideredChar,"friendship") * 1 + rLvlAbt(consideringChar,consideredChar,"romance") * 2
						+ rLvlAbt(consideringChar,consideredChar,"sexualTension") * 1 + rLvlAbt(consideringChar,consideredChar,"domination") * 1
						+ rLvlAbt(consideringChar,consideredChar,"submission") * 1 - rLvlAbt(consideringChar,consideredChar,"rivalry") * 2
						- rLvlAbt(consideringChar,consideredChar,"enmity") * 4;
	var infamyFactor = gC(consideredChar).infamy * -1;
	var meritFactor = gC(consideringChar).merit - gC(consideredChar).merit;
	if ( meritFactor > 0 ) { meritFactor = 0; }
	result = strengthDifference + relationFactor + infamyFactor;
	return result;
}

// Constructors, serializers, etc.
missionChoice.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
missionChoice.prototype.clone = function () {
	return (new missionChoice())._init(this);
};
missionChoice.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new missionChoice())._init($ReviveData$)', ownData);
};

// Auxiliars

window.setTrainingGoals = function(charKey) {
	// Get average stat
	var averageStat = quantifyCharacterStats(charKey) / 9;
	// Create string at globalAi
	gC(charKey).globalAi.statGoals = [];
	// Link affinity to stat goal
	for ( var stat of getStatNamesArray() ) {
		var sData = gC(charKey)[stat];
		gC(charKey).globalAi.statGoals.push(((averageStat + 2) * sData.affinity * sData.affinity));
	}
}

window.quantifyCharacterVacuumStrength = function(charKey) {
	var str = 0;
	for ( var cStat of getStatNamesArray() ) {
		str += gCstat(charKey,cStat);
	}
	return str;
}
window.quantifyAverageCandidateVacuumStrength = function() {
	var aveStr = 0;
	for ( var charKey of getActiveSimulationCharactersArray() ) {
		aveStr += quantifyCharacterVacuumStrength(charKey);
	}
	aveStr = aveStr / 6;
	return aveStr;
}

window.quantifyCharacterStats = function(charKey) {
	var str = 0;
	for ( var cStat of getStatNamesArray() ) {
		str += gCstat(charKey,cStat);
	}
	return str;
}
window.quantifyCharacterStrength = function(charKey) {
	var str = 0;
	for ( var cStat of getStatNamesArray() ) {
		str += gCstat(charKey,cStat);
	}
	if ( gC(charKey).willpower.current < 30 ) {
		str *= 0.95;
	}
	if ( gC(charKey).willpower.current < 10 ) {
		str *= 0.9;
	}
	if ( gC(charKey).energy.current < 30 ) {
		str *= 0.95;
	}
	if ( gC(charKey).energy.current < 10 ) {
		str *= 0.9;
	}
	if ( gC(charKey).socialdrive.current < 30 ) {
		str *= 0.95;
	}
	if ( gC(charKey).socialdrive.current < 10 ) {
		str *= 0.95;
	}
	str *= gC(charKey).lust.current * 0.01;
	return str;
}
window.quantifyCharactersGroupStrength = function(charKey) {
	var str = 0;
	for ( var charKey of getCharGroup(charKey) ) {
		str += quantifyCharacterStrength(charKey);
	}
	return str;
}
window.proportionQuantifiedCharactersStrength = function(charA,charB) {
	var proportion = quantifyCharacterStrength(charA) / quantifyCharacterStrength(charB);
	return proportion;
}

window.quantifyCharacterTiredness = function(charKey) {
						// ( Bar max - bar current ) / bar max ; if bar current == Result is 0 -> 1 ; if bar current == max -> Result is 0
	var tiredness = 0 + ((gC(charKey).lust.max - gC(charKey).lust.current) / gC(charKey).lust.max) +
						((gC(charKey).energy.max - gC(charKey).energy.current) / gC(charKey).energy.max) / 3 +
						((gC(charKey).willpower.max - gC(charKey).willpower.current) / gC(charKey).willpower.max) / 3 +
						((gC(charKey).socialdrive.max - gC(charKey).socialdrive.current) / gC(charKey).socialdrive.max) / 3;
	return tiredness;
}

window.canActorAttackTarget = function(actor,target) { // Checks if the actor may use any action other than "doNothing" against the target in a battle scene
	var flag = false;
	if ( simulateListValidBasicActionsOnTargetDuringCombat(actor,target).length > 0 ) { flag = true;}
	return flag;
}

// General evaluations auxiliar functions

window.charactersGetsForcedFollowers = function(charKey) {
	var currentRoom = gC(charKey).currentRoom;
	var charsInRoom = getRoomA(currentRoom).characters;
	for ( var target of charsInRoom ) {
		if ( target != charKey && gC(target).followingTo == "" ) {
			var relType = gRelTypeAb(target,charKey);
			if ( relType != null ) {
				if ( relType.forcedToFollow == true ) {
					// Target character's relationship forces them to follow
					npcProposalFollowMe(charKey,target);
				}
			}
		}
	}
}



////////// NPC-GLOBAL-AI CLASS //////////

window.NpcSocialAi = function(charKey) {
	this.charKey = charKey
	// Targets
	this.allyTs = [];
	this.loveTs = [];
	this.covetTs = [];
	this.conquestTs = [];
	this.rivalTs = [];
};

	// Methods
NpcSocialAi.prototype.stablishRelationshipGoal = function(target) {
		this[target] = new relationshipGoal(this.charKey,target);
	}
	
	// Choose social interaction in SIS
NpcSocialAi.prototype.chooseSISinteraction = function(target,interactionsList) {
		var wInteractionslist = listIntoWeightedList(interactionsList);
		for ( var wItem in wInteractionslist ) {
			
			if ( wInteractionslist[wItem] instanceof weightedElement ) {
				wInteractionslist[wItem].w = this.assignWeightToInteraction(target,wInteractionslist[wItem].content);
			}
		}
		var chosenInteraction = randomFromWeightedListPercentThreshold(wInteractionslist,0.3);
		//var chosenInteraction = randomFromWeightedList(wInteractionslist);
		return chosenInteraction;
	}

NpcSocialAi.prototype.assignWeightToInteraction = function(target,interactionKey) {
		var value = 100;
		var strategy = "friendly";
		var interaction = getSiByKey(interactionKey);
		if ( this.hasOwnProperty(target) ) {
			strategy = this[target].strategy;
		}
		
		switch(strategy) {
			case "friendly":
				if ( interaction.tags.includes("friendly") ) { value *= 2; }
				if ( interaction.tags.includes("intimate") ) { value *= 3; }
				if ( interaction.tags.includes("flirty") ) { value *= 2; }
				if ( interaction.tags.includes("aroused") ) { value *= 1.5; }
				if ( interaction.tags.includes("angry") ) { value *= 0.2; }
				break;
			case "rivalry":
				if ( interaction.tags.includes("friendly") ) { value *= 0.8; }
				if ( interaction.tags.includes("intimate") ) { value *= 0.5; }
				if ( interaction.tags.includes("flirty") ) { value *= 0.5; }
				if ( interaction.tags.includes("dominant") ) { value *= 2; }
				if ( interaction.tags.includes("submissive") ) { value *= 0.1; }
				if ( interaction.tags.includes("angry") ) { value *= 2.5; }
				break;
			case "romance":
				if ( interaction.tags.includes("friendly") ) { value *= 0.8; }
				if ( interaction.tags.includes("intimate") ) { value *= 2; }
				if ( interaction.tags.includes("flirty") ) { value *= 3; }
				if ( interaction.tags.includes("aroused") ) { value *= 3; }
				if ( interaction.tags.includes("angry") ) { value *= 0.1; }
				break;
		}
		if ( interaction.tags.includes("angry") ) {
			value *= 1 + ( (gC(this.charKey).mood.angry * 3) / 100 );
		}
		return value;
	}

NpcSocialAi.prototype.getInterRoundBehavior = function(sis) {
		var choice = "none";
		var target = "";
		
		// Characters following someone shouldn't be able to propose sex or leave SIS on their own
		if ( gC(this.charKey).followingTo == "" ) {
			// Check to propose sex
		
			// Get alliance
			if ( gC(this.charKey).mission == "getAlliance" ) {
				var validTarget = "";
				for ( var chKey of sis.charList ) {
					if ( gC(this.charKey).socialAi.allyTs.includes(chKey) ) {
						if ( setup.sistDB[setup.sistType.companionship].isSuccessful(this.charKey,chKey)[0] ) {
							validTarget = chKey;
						}
					}
				}
				if ( validTarget != "" ) {
					target = validTarget;
					choice = setup.sistType.companionship;
				}
		
			}
			// Check if demanding sex from sub is possible
			else if ( gC(this.charKey).subChars.length > 0 && gC(this.charKey).sexScenesToday < 1 && (gC(this.charKey).mission == "haveSex" || gC(this.charKey).mission == "haveDomSex") ) {
				var potentialSubs = [];
				for ( var chKey of sis.charList ) {
					if ( gC(this.charKey).subChars.includes(chKey) ) {
						if ( gRelTypeAb(chKey,this.charKey).forcedToSex ) {
							potentialSubs.push(chKey);
						}
					}
				}
				if ( potentialSubs.length > 0 ) {
					choice = setup.sistType.dominantSex;
					target = randomFromList(potentialSubs);
				}
			}
			if ( choice == "none" ) {
				// Standard sex checks
					// Sub-missions: any sex, egal sex, dominating sex
				var sexWantScore = 0;
				if ( getCharsDrivePercent(this.charKey,"dPleasure") <= 0.1 ) {
					sexWantScore = -1;
				} else if ( getCharsDrivePercent(this.charKey,"dPleasure") >= 0.2 ) {
					sexWantScore = 1;
				}
				if ( gC(this.charKey).mission == "getAlliance" ) {
					sexWantScore -= 3;
				}
		
				if ( 
						( gC(this.charKey).mood.flirty + gC(this.charKey).mood.aroused - gC(this.charKey).mood.angry + ((1 - getBarPercentage(this.charKey,"lust")) * 100) ) >= 50
						&& ( limitedRandomInt(10 + gC(this.charKey).daysWithoutSex + sexWantScore) > ( 6 + gC(this.charKey).sexScenesToday ) )
						&& ( gC(this.charKey).socialdrive.current >= 10 )
					) {
					var highestPriority = -1;
					var priorizedChar = "";
					// Get character with highest priority
					for ( var character of sis.getValidProposedCharacters(this.charKey) ) {
						if ( getSocialPriorityAgainstTarget(this,character) > highestPriority || highestPriority == -1 ) {
							highestPriority = getSocialPriorityAgainstTarget(this,character);
							priorizedChar = character;
						}
					}
		
					var allowedSex = true;
					if ( gC(this.charKey).subChars.includes(priorizedChar) ) {
						if ( limitedRandomInt(16) > 4 ) { allowedSex == false; }
					}
					if ( allowedSex ) {
						var domSexAllowed = true;
						var egaSexAllowed = true;
						var subSexAllowed = false;
						if ( gC(this.charKey).mission == "raiseFriendship" || gC(this.charKey).mission == "flirt" || gC(this.charKey).mission == "getAlliance" ) {
							domSexAllowed = false;
						}
						if ( gC(this.charKey).mission == "haveDomSex" || gC(this.charKey).mission == "seduce" || ( (gC(this.charKey).socialAi.covetTs.includes(priorizedChar) || gC(this.charKey).socialAi.conquestTs.includes(priorizedChar)) && gC(this.charKey).socialAi.allyTs.includes(priorizedChar) == false ) ) {
							egaSexAllowed = false;
						}
						if ( (gC(this.charKey).socialAi.covetTs.includes(priorizedChar) == false && gC(this.charKey).socialAi.conquestTs.includes(priorizedChar) == false) && (getCharsDrivePercent(this.charKey,"dPleasure")*2 > getCharsDrivePercent(this.charKey,"dDomination") + getCharsDrivePercent(this.charKey,"dAmbition")) && (gC(this.charKey).socialAi.loveTs.includes(priorizedChar) || gC(this.charKey).mission == "haveSex") && gC(priorizedChar).domChar != this.charKey ) {
							subSexAllowed = true;
						}
		
						// Check for dominant sex
						if ( (setup.sistDB[setup.sistType.dominantSex].isSuccessful(this.charKey,priorizedChar)[0] && domSexAllowed) ) {
							choice = setup.sistType.dominantSex;
							target = priorizedChar;
						} // Check for egalitarian sex
						else if ( (setup.sistDB[setup.sistType.egalitarianSex].isSuccessful(this.charKey,priorizedChar)[0] && egaSexAllowed) ) {
							choice = setup.sistType.egalitarianSex;
							target = priorizedChar;
						} else if ( setup.sistDB[setup.sistType.submissiveSex].isSuccessful(this.charKey,priorizedChar)[0] && subSexAllowed ) {
							choice = setup.sistType.submissiveSex;
							target = priorizedChar;
						}
					}
				}
			}
			// Check to leave SIS
			if ( choice == "none" ) {
				if ( gC(this.charKey).mood.angry > 20 ) {
					if ( limitedRandomInt(10) > 8 ) {
						choice = "leave";
					}
				}
				if ( gC(this.charKey).socialdrive.current < gC(this.charKey).socialdrive.max * 0.2 ) {
					if ( limitedRandomInt(10) > 8 ) {
						choice = "leave";
					}
				}
			}
		} 
		
		if ( gC(this.charKey).socialdrive.current < 1 ) {
			choice = "leave";
		}
		
		// Check require unlocked genitals
		if ( choice == setup.sistType.egalitarianSex || choice == setup.sistType.submissiveSex || choice == setup.sistType.dominantSex ) {
			if ( returnCharsUnlockedGenitals(this.charKey).length == 0 ) {
				if ( getActorsGenitalsLockedByTarget(this.charKey,target).length > 0 ) {
					choice = setup.sistType.unlockActorsGenitals;
				}
			}
		}
		
		return [choice,target];
	}

	// SIS
window.chooseActorsSISinteractionTarget = function(actor,sis,interactionsList) {
	rerollSocialMission(actor);
	// 2-elements arrays: 1st is interaction, 2nd is target
	var optionsList = [];
	for ( var interaction of interactionsList ) {
		if ( interaction != "doNothing" ) {
			for ( var target of sis.charList ) {
				if ( target != actor ) {
					var newOption = [interaction,target];
					optionsList.push(newOption);
				}
			}
		}
	}
	var lastOption = ["doNothing",actor];
	optionsList.push(lastOption);
	var wInteractionslist = listIntoWeightedList(optionsList);
	for ( var wItem in wInteractionslist ) {
		if ( wInteractionslist[wItem] instanceof weightedElement ) {
			wInteractionslist[wItem].w = assignWeightToActorsInteractionTarget(actor,wInteractionslist[wItem].content);
		}
	}
	var chosenInteraction = randomFromWeightedList(wInteractionslist); // Not final
	return chosenInteraction;
}
window.assignWeightToActorsInteractionTarget = function(actor,interactionTarget) {
	var interaction = getSiByKey(interactionTarget[0]);
	var target = interactionTarget[1];
	if ( (interactionTarget[0] != "doNothing") && (interaction.evaluateSuccess(actor,target,interaction.topic)) ) {
		var score = 30;
		var moodScore = 1;
		for ( var tag of interaction.tags ) {
			if ( tag != "friendly" ) {
				moodScore += (gC(actor).mood[tag] * 0.01) / interaction.tags.length;
			}
		}
		var drivesScore = 1;
		for ( var tag of interaction.driveTags ) {
			drivesScore *= getCharsDrivePercent(actor,tag) * 6;
		}
		if ( interaction.driveTags.length > 0 ) { drivesScore = drivesScore / interaction.driveTags.length; }
		var goalsScore = 0;
		if ( gC(actor).socialAi.allyTs.includes(target) ) {
			if ( interaction.tags.includes("friendly") ) { goalsScore += 10; }
			if ( interaction.tags.includes("intimate") ) { goalsScore += 10; }
			if ( interaction.tags.includes("angry") ) { goalsScore -= 10; }
			if ( interaction.tags.includes("submissive") ) { goalsScore -= 2; }
			if ( getCharsMissionTitle(actor) == "raiseFriendship" ) {
				goalsScore *= 1.5;
			} else if ( getCharsMissionTitle(actor) == "getAlliance" ) {
				goalsScore *= 3;
			}
		}
		if ( gC(actor).socialAi.loveTs.includes(target) ) {
			if ( interaction.tags.includes("intimate") ) { goalsScore += 5; }
			if ( interaction.tags.includes("flirty") ) { goalsScore += 10; }
			if ( interaction.tags.includes("aroused") ) { goalsScore += 10; }
			if ( interaction.tags.includes("dominant") ) { goalsScore += 5; }
			if ( interaction.tags.includes("angry") ) { goalsScore -= 10; }
			if ( getCharsMissionTitle(actor) == "flirt" || getCharsMissionTitle(actor) == "haveSex" ) {
				goalsScore *= 2;
			}
		}
		if ( gC(actor).socialAi.covetTs.includes(target) ) {
			if ( interaction.tags.includes("flirty") ) { goalsScore += 10; }
			if ( interaction.tags.includes("aroused") ) { goalsScore += 10; }
			if ( interaction.tags.includes("dominant") ) { goalsScore += 40; }
			if ( interaction.tags.includes("submissive") ) { goalsScore -= 20; }
			if ( interaction.tags.includes("angry") ) { goalsScore -= 10; }
			if ( getCharsMissionTitle(actor) == "seduce" || getCharsMissionTitle(actor) == "haveSex" || getCharsMissionTitle(actor) == "haveDomSex" ) {
				goalsScore *= 2;
			}
		}
		if ( gC(actor).socialAi.conquestTs.includes(target) ) {
			if ( interaction.tags.includes("flirty") ) { goalsScore += 5; }
			if ( interaction.tags.includes("aroused") ) { goalsScore += 5; }
			if ( interaction.tags.includes("dominant") ) { goalsScore += 60; }
			if ( interaction.tags.includes("submissive") ) { goalsScore -= 30; }
			if ( interaction.tags.includes("angry") ) { goalsScore += 5; }
			if ( getCharsMissionTitle(actor) == "seduce" || getCharsMissionTitle(actor) == "haveDomSex" ) {
				goalsScore *= 1.5;
			}
		}
		if ( gC(actor).socialAi.rivalTs.includes(target) ) {
			if ( interaction.tags.includes("dominant") ) { goalsScore += 10; }
			if ( interaction.tags.includes("submissive") ) { goalsScore -= 30; }
			if ( interaction.tags.includes("angry") ) { goalsScore += 30; }
			if ( getCharsMissionTitle(actor) == "taunt" ) {
				goalsScore *= 2;
			}
		}
		var strategyScore = 0;
		for ( var tag of interaction.strategyTags ) {
			switch(tag) {
				case "angerDown":
					if ( ( gC(actor).socialAi.allyTs.includes(target) || gC(actor).socialAi.loveTs.includes(target) || gC(actor).socialAi.covetTs.includes(target) ) && gC(target).mood.anger >= 10 ) {
						strategyScore += 15;
						if ( getCharsMissionTitle(actor) == "raiseFriendship" || getCharsMissionTitle(actor) == "flirt" || getCharsMissionTitle(actor) == "getAlliance" ) {
							strategyScore *= 2;
						}
					} else {
						strategyScore = -100;
					}
					break;
				case "selfSubmissionDown":
					if ( ((gC(actor).mood.submission + gC(target).mood.domination - gC(actor).mood.domination - gC(target).mood.submission - rLvlAbt(actor,target,"romance")) >= 15) && ( getCharsDrivePercent(actor,"dDomination") > 0.12 || getCharsDrivePercent(actor,"dAmbition") > 0.12 ) ) {
						strategyScore += 15 * ( getCharsDrivePercent(actor,"dDomination") + getCharsDrivePercent(actor,"dAmbition") ) * 12;
						if ( getCharsMissionTitle(actor) == "seduce" || getCharsMissionTitle(actor) == "haveDomSex" ) {
							strategyScore *= 2;
						}
					} else {
						strategyScore = -100;
					}
					break;
				case "romanceRival":
					
					break;
			}
		}
		
		score = (score + goalsScore + strategyScore) * moodScore * drivesScore;
		
		if ( score > 10 ) {
			if ( interaction.tags.includes("angry") ) {
				if ( (gC(actor).socialAi.rivalTs.includes(target) == false) && ( (rLvlAbt(actor,target,"rivalry") * 1 + rLvlAbt(actor,target,"enmity")) * 2 < ( rLvlAbt(actor,target,"romance") + rLvlAbt(actor,target,"friendship") + 3 ) ) && (gC(actor).mood.angry <= 10) ) {
					score *= 0.3;
				}
			}
		}
		if ( getBarPercentage(actor,"socialdrive") < 0.3 ) {
			score = score * (10 - interaction.socialDriveCost) * 0.1;
		}
		if ( score <= 1 ) { score = 1; }
	} else {
		var score = 1;
	}
	
	if ( getCharGroup(actor).includes(target) == false ) { score *= 2; }
	
	return score;
}

window.setSocialAiCandidateGoals = function(socialAi) {
	var actor = socialAi.charKey;
	
	// Simple and functional version of this function.
	// One character will be selected as romance target. This character will receive much higher priority.
	// All other characters will be set to either "friendly" or "dominate"
	
	var romanceTargetId = 0;
	var currentTargetScore = 0;
	var currentCandidateScore = 0;
	var i = 0;
	
	// Updating to targets lists
	// Amount of required targets for each list
	
	var allyTN = getAllyTN(actor);
	var loveTN = getLoveTN(actor);
	var covetTN = getCovetTN(actor);
	var conquestTN = getConquestTN(actor);
	var rivalTN = getRivalTN(actor);

	var oldTs = [];
	for ( var ts of ["allyTs","loveTs","covetTs","conquestTs","rivalTs"] ) {
		oldTs[ts] = socialAi[ts];
	}
	
	socialAi.allyTs = getTs(actor,allyTN,scorePotentialAlly);
	socialAi.loveTs = getTs(actor,loveTN,scorePotentialLove);
	socialAi.covetTs = getTs(actor,covetTN,scorePotentialCovet);
	socialAi.conquestTs = getTs(actor,conquestTN,scorePotentialConquest);
	socialAi.rivalTs = getTs(actor,rivalTN,scorePotentialRival);
	
	if ( socialAi.rivalTs.length == 0 ) {
		var potentialRivals = getTs(actor,1,scorePotentialRival);
		if ( potentialRivals.length > 0 ) {
			if ( potentialRivals[0][1] >= 10 ) { // First potential rival's score passes threshold
				socialAi.rivalTs = [potentialRivals[0]];
			}
		}
	}
	
	// Old Ts have a chance of being passed over to the next day
	for ( var ts of ["allyTs","loveTs","covetTs","conquestTs","rivalTs"] ) {
		for ( var t of oldTs[ts] ) {
			if ( socialAi[ts].includes(t) == false ) {
				if ( limitedRandomInt(64) > 32 ) {
					socialAi[ts].push(t);
				}
			}
		}
	}
}

window.getSocialStrategyAgainstTarget = function(socialAi,target) {
	var strategy = "friendly";
	if ( socialAi.hasOwnProperty(target) ) {
		strategy = socialAi[target].strategy;
	}
	return strategy;
}
window.getSocialPriorityAgainstTarget = function(socialAi,target) {
	var priority = 5 + limitedRandomInt(10);
	
	if ( socialAi.allyTs.includes(target) ) {
		priority += 5;
	}
	if ( socialAi.loveTs.includes(target) ) {
		priority += 7;
	}
	if ( socialAi.covetTs.includes(target) ) {
		priority += 5;
	}
	if ( socialAi.conquestTs.includes(target) ) {
		priority += 3;
	}
	if ( socialAi.rivalTs.includes(target) ) {
		priority += 3;
	}
	/*
	if ( socialAi.hasOwnProperty(target) ) {
		priority = socialAi[target].weight;
	}
	*/
	return priority;
}

window.rerollSocialMission = function(actor) {
	// Check angry reroll
	if ( gC(actor).mood.angry > ( gC(actor).mood.friendly + gC(actor).mood.flirty + 20 ) ) {
		if ( gC(actor).mission != "taunt" ) {
			gC(actor).mission = "";
		}
	} else if ( gC(actor).mission == "raiseFriendship" ) {
		if ( (gC(actor).mood.flirty + gC(actor).mood.aroused) > (gC(actor).mood.friendly * 2 + 10) ) {
			gC(actor).mission = "flirt";
		}
	}
}

	// Target types
	
window.getAllyTN = function(charKey) {
	var tn = 1;
	if ( getCharsDrivePercent(charKey,"dCooperation") >= 0.4 ) {
		tn = 4;
	} else if ( getCharsDrivePercent(charKey,"dCooperation") >= 0.3 ) {
		tn = 3;
	} else if ( getCharsDrivePercent(charKey,"dCooperation") >= 0.2 ) {
		tn = 2;
	}
	if ( quantifyCharacterVacuumStrength(charKey) < quantifyAverageCandidateVacuumStrength() ) {
		tn++;
	}
	return tn;
}
window.getLoveTN = function(charKey) {
	var tn = 0;
	if ( getCharsDrivePercent(charKey,"dLove") >= 0.25 ) {
		tn = 2;
	} else if ( getCharsDrivePercent(charKey,"dLove") >= 0.15 ) {
		tn = 1;
	}
	if ( getCharsDrivePercent(charKey,"dPleasure") >= 0.25 ) {
		tn++;
	}
	if ( getCharsDrivePercent(charKey,"dCooperation") >= 0.25 ) {
		tn++;
	}
	if ( getCharsDrivePercent(charKey,"dAmbition") >= 0.3 ) {
		tn--;
	}
	return tn;
}
window.getCovetTN = function(charKey) {
	var tn = 1;
	if ( getCharsDrivePercent(charKey,"dPleasure") >= 0.15 ) {
		tn++;
		if ( getCharsDrivePercent(charKey,"dPleasure") >= 0.25 ) {
			tn++;
		}
	}
	if ( getCharsDrivePercent(charKey,"dDomination") >= 0.2 ) {
		tn++;
	}
	if ( getCharsDrivePercent(charKey,"dImprovement") >= 0.2 ) {
		tn--;
	}

	return tn;
}
window.getConquestTN = function(charKey) {
	var tn = 0;
	if ( getCharsDrivePercent(charKey,"dDomination") >= 0.15 ) {
		tn++;
		if ( getCharsDrivePercent(charKey,"dDomination") >= 0.25 ) {
			tn++;
		}
	}
	if ( getCharsDrivePercent(charKey,"dAmbition") >= 0.2 ) {
		tn++;
		if ( getCharsDrivePercent(charKey,"dAmbition") >= 0.3 ) {
			tn++;
		}
	}
	if ( getCharsDrivePercent(charKey,"dCooperation") >= 0.2 ) {
		tn--;
	}
	return tn;
}
window.getRivalTN = function(charKey) {
	var tn = 0;
	if ( ( getCharsDrivePercent(charKey,"dAmbition") + getCharsDrivePercent(charKey,"dImprovement") * 0.5) >= 0.25 ) {
		tn++;
		if ( ( getCharsDrivePercent(charKey,"dAmbition") + getCharsDrivePercent(charKey,"dImprovement") * 0.5) >= 0.35 ) {
			tn++;
		}
	}
	return tn;	
}

	// Fill target lists
setup.randomTargetScore = 2.0;

window.addScoredElementToSortedList = function(sortedList,scoredElement) {
	// Sorted list is an array of 2-sized arrays, position 0 is target, position 1 is score
	var l = sortedList.length;
	
	if ( l == 0 ) {
		sortedList = [scoredElement];
	} else {
		var i = l - 1;
		while ( i > -1 ) {
			if ( scoredElement[1] < sortedList[i][1] ) {
				if ( i == l - 1) {
					sortedList.push(scoredElement);
				} else {
					sortedList.splice(i+1,0,scoredElement);
				}
				i = -2;
			}
			i--;
		}
		if ( i == -1 ) {
			sortedList.splice(0,0,scoredElement);
		}
	}
	return sortedList;
}


window.getTs = function(charKey,TN,scoreFunction) {
	var Ts = [];
	if ( TN > 0 ) {
		var potentialTargets = []; // Array of 2-sized arrays, position 0 is target, position 1 is score
		for ( var target of getActiveSimulationCharactersArray() ) {
			if ( target != charKey) {
				var scoredTarget = [target,scoreFunction(charKey,target)];
				if ( scoredTarget[1] >= 0 ) {
					//potentialTargets = addScoredElementToSortedList(potentialTargets,scoredTarget);
					potentialTargets = addScoredElementToSortedList(potentialTargets,scoredTarget);
				}
			}
		}
		var n = 0;
		while ( n < TN ) {
			if ( potentialTargets[n] != undefined ) {
				Ts.push(potentialTargets[n][0]);
			} else {
				n = TN;
			}
			n++;
		}
	}
	return Ts;
}

window.getRivalTs = function(charKey,rivalTN) {
	var rivalTs = [];
	if ( rivalTN > 0 ) {
		var potentialTargets = []; // Array of 2-sized arrays, position 0 is target, position 1 is score
		for ( var target of getActiveSimulationCharactersArray() ) {
			if ( target != charKey) {
				var scoredTarget = [target,scorePotentialRival(charKey,target)];
				if ( scoredTarget[1] >= 0 ) {
					addScoredElementToSortedList(potentialTargets,scoredTarget);
				}
			}
		}
		var n = 0;
		while ( n < rivalTN ) {
			rivalTs.push(potentialTargets[n][0]);
		}
	}
	return rivalTs;
}
window.scorePotentialAlly = function(actor,target) {
	var score = 0;
	
	var relationScore = rLvlAbt(actor,target,"friendship") * 2 + rLvlAbt(actor,target,"romance") * 1 - rLvlAbt(actor,target,"rivalry") * 1 - rLvlAbt(actor,target,"enmity") * 2;
	var dominationScore = rLvlAbt(actor,target,"domination") - rLvlAbt(actor,target,"submission");
	var powerScore = (quantifyCharacterVacuumStrength(target) / quantifyAverageCandidateVacuumStrength());
	
	score += relationScore;
	if ( dominationScore < 0 ) { score += dominationScore * 2; }
	if ( powerScore >= 1 ) { score += powerScore * 10; }
	
	score += score * limitedRandom(setup.randomTargetScore);
	return score;
}
window.scorePotentialLove = function(actor,target) {
	var score = 0;
	
	var relationScore = rLvlAbt(actor,target,"romance") * 2 + rLvlAbt(actor,target,"sexualTension") * 1 - rLvlAbt(actor,target,"enmity") * 3;
	var domSubScore = (rLvlAbt(actor,target,"domination") + rLvlAbt(actor,target,"submission")) * 0.1;
	var powerScore = (quantifyCharacterVacuumStrength(target) / quantifyAverageCandidateVacuumStrength());
	
	score += relationScore;
	score += domSubScore;
	if ( powerScore >= 1 ) { score += powerScore * 10; }
	
	score += score * limitedRandom(setup.randomTargetScore);
	return score;
}
window.scorePotentialCovet = function(actor,target) {
	var score = 0;
	
	var relationScore = rLvlAbt(actor,target,"sexualTension") * 2 - rLvlAbt(actor,target,"friendship") * 1 + rLvlAbt(actor,target,"romance") * 1 - rLvlAbt(actor,target,"enmity") * 2;
	var dominationScore = rLvlAbt(actor,target,"domination") - rLvlAbt(actor,target,"submission");
	
	score += relationScore;
	if ( dominationScore > 0 ) { score += relationScore; }
	
	score += score * limitedRandom(setup.randomTargetScore);
	
	if ( gC(actor).domChar == target ) { score = -50; }
	
	return score;
}
window.scorePotentialConquest = function(actor,target) {
	var score = 0;
	
	var relationScore = rLvlAbt(actor,target,"sexualTension") * 2 + rLvlAbt(actor,target,"rivalry") * 1 - rLvlAbt(actor,target,"friendship") * 1 - rLvlAbt(actor,target,"romance") * 1;
	var dominationScore = rLvlAbt(actor,target,"domination") - rLvlAbt(actor,target,"submission");
	var powerScore = (quantifyCharacterVacuumStrength(actor) - quantifyCharacterVacuumStrength(target)) * 30 / quantifyAverageCandidateVacuumStrength;
	
	score += relationScore;
	if ( dominationScore < 10 && dominationScore > 0 ) { score += dominationScore * 2; }
	if ( powerScore > 0 ) { score += powerScore * ( 1 + (getCharsDrivePercent(actor,"dDomination") - getCharsDrivePercent(actor,"dAmbition")) * 5 ); }
	
	score += score * limitedRandom(setup.randomTargetScore);
	
	if ( gC(actor).domChar == target ) { score = -50; }
	
	return score;
}
window.scorePotentialRival = function(actor,target) {
	var score = 0;
	
	var relationScore = rLvlAbt(actor,target,"rivalry") * 1.5 + rLvlAbt(actor,target,"enmity") * 2 - rLvlAbt(actor,target,"friendship") * 1 - rLvlAbt(actor,target,"romance") * 1.5;
	var submissionScore = rLvlAbt(actor,target,"submission") - rLvlAbt(actor,target,"domination");
	var meritScore = gC(target).merit - gC(actor).merit;
	var infamyScore = gC(target).infamy - gC(actor).infamy;
	
	score += relationScore;
	if ( submissionScore > 0 ) { score += submissionScore * getCharsDrivePercent(actor,"dAmbition") * 5; }
	if ( meritScore > 0 ) { score += meritScore; }
	if ( infamyScore > 0 ) { score += infamyScore * getCharsDrivePercent(actor,"dCooperation") * 5; }
	
	score += score * limitedRandom(setup.randomTargetScore);
	
	if ( gC(actor).domChar == target ) { score = -50; }
	
	return score;
}

window.testRelationScores = function() {
gC("chNash").relations["chMir"].sexualTension.level = 5;
gC("chNash").relations["chMir"].romance.level = 4;
gC("chNash").relations["chMir"].rivalry.level = 5;
gC("chNash").relations["chVal"].enmity.level = 5;
gC("chNash").relations["chVal"].rivalry.level = 5;
gC("chNash").relations["chClaw"].friendship.level = 5;
gC("chNash").relations["chClaw"].domination.level = 5;


gC("chVal").relations["chMir"].domination.level = 5;
gC("chVal").relations["chMir"].sexualTension.level = 5;
gC("chVal").relations["chMir"].friendship.level = 5;
gC("chVal").relations["chAte"].rivalry.level = 5;
gC("chVal").relations["chMir"].submission.level = 5;
gC("chVal").relations["chMir"].sexualTension.level = 5;

State.variables.chVal.infamy = 15;
State.variables.chAte.merit = 15;
State.variables.chMir.will.value = 50;
}

// Constructors, serializers, etc.
NpcSocialAi.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
NpcSocialAi.prototype.clone = function () {
	return (new NpcSocialAi())._init(this);
};
NpcSocialAi.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new NpcSocialAi())._init($ReviveData$)', ownData);
};

////////// RELATIONSHIP-GOALS CLASS //////////

window.relationshipGoal = function(actor,target) {
	this.actor = actor;
	this.target = target;
	this.weight = 10;
	this.strategy = "friendly";
};

// Constructors, serializers, etc.
relationshipGoal.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
relationshipGoal.prototype.clone = function () {
	return (new relationshipGoal())._init(this);
};
relationshipGoal.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new relationshipGoal())._init($ReviveData$)', ownData);
};


window.feedCandidatesRelationshipGoals = function() {
	/*
	var candidates = [ "chNash", "chMir", "chVal", "chAte", "chClaw" ];
	var allCandidates = candidates.concat(["chPlayerCharacter"]);
	
	for ( var candidate of candidates ) {
		for ( var targetCandidate of allCandidates ) {
			if ( candidate != targetCandidate ) {
				gC(candidate).socialAi.stablishRelationshipGoal(targetCandidate);
			}
		}
	}*/
}


////////// SCROLL CLASS //////////

window.Scroll = function(key,title,type) {
	this.key = key;
	this.title = title;
	this.type = type;
	
	this.getWeight = function(character) {
		return 20;
	}
	
	this.mayBeFound = function(character) {
		return true;
	}
	this.firstTimeEffect = function(characters) {
		return "0";
	}
	this.getContent = function() {
		return "Standard scroll content";
	}
	
}

		// LORE
// On Aether
window.getScrollOnAetherContent = function() {
	var content = "Aether flows through all things, and all things that move are moved by aether. Aether is the vital energy of the Goddess, her will and her very self. Life, formed by it, is but a gift that She grants us mortals.\n\n"
				+ "Aether is strengthened by the passion each living being puts into life, and deteriorates when the life holding on to it loses its capacity to leave its mark in the world. A life unable to hold strong aether is a life that is about to expire.\n\n"
				+ "Because aether is required for life to exist, life can only be created when aether gives it form. The strongest time for aether to leave and join a living creature, is when that creature shares its love and its carnal passion. When compatible creatures under the right circumstances exchange their passion, some of their aether is fused, and a new life is created.\n\n"
				+ "There are two forms of aether: natural aether and vital aether. Natural aether is present in all parts of the world, and gives it form: warmth, cold, the movement of water, or the light of the sky are all kinds of natural aether. Vital aether is condensed natural aether that holds a life together. A living being's vital aether is constantly gained and lost in small quantities, when it absorbs natural aether or its vital aether turns back into natural aether. Magic is the process in which conscious creatures control the flow of aether for a given purpose, as it was taught to us by the Goddess.";
	return content;
}
window.createScrollOnAether = function() {
	var scr = new Scroll("onAether","On Aether","lore");
	scr.firstTimeEffect = function(characters) {
		var textResults = "";
		var expPoints = 50;
		for ( var character of characters ) {
			gC(character).intelligence.addExperience(expPoints);
			textResults += gC(character).getFormattedName() + " gained " + (expPoints * gC(character).intelligence.affinity).toFixed(1) + " intelligence experience points.\n";
		}
		return textResults;
	}
	scr.getContent = getScrollOnAetherContent;
	return scr;
}

// On family
window.getScrollOnFamilyContent = function() {
	var content = "Families are the unions between persons who share many dimensions of their lives, such are their roofs and their blood. These groups of people often share certain duties towards each other.\n\n"
				+ "Life in the Confined Valley is diverse, both in their customs and their very nature. This is why families in the Valley are diverse as well. Most Gaanidan and Ashwalker families are started with the union of one man and one woman, in the case of the former they last for the rest of their lives and they often limit sexual activities to those with that one partner, while the latter are much more flexible in both aspects, but it is suspected that Ashwalkers used to follow customs similar to the Gaanidan ones ages ago, when they hadn't been for long in the Valley.\n\n"
				+ "Leirien families are led by a Matriarch or Patriarch, who watches over all of their members, solving disputes and providing guidance and education. The size of these families mostly depend on the capacity and resolve of this leading figure, and the average would be a couple dozens of members per family. When a Leirien reaches maturity, they leave their family and join a different one.\n\n"
				+ "In the case of the Beastkin, it is a recent development that they are forming harem families, led and controlled by a strong and dominant man or woman, who tries and brings those they feel attracted to to their flock. Before this, they didn't have any standard model of family, and each person decided what kind of family they wanted to form a part of at any given stage of their lives and tried to act accordingly.\n\n"
				+ "The most peculiar situation is perhaps that of the Shapeshifters, who have no families at all, or perhaps they have one single family, composed by every member of their tribe. This could be related to how unique is the Shapeshifter birth, which takes place in large bodies of water where these peoples have sex with frequency, after unclear and perhaps variable amounts of time since the presumed conception, a process that makes it impossible to determine a Shapeshifter's parents.";
	return content;
}
window.createScrollOnFamily = function() {
	var scr = new Scroll("onFamily","On Family","lore");
	scr.firstTimeEffect = function(characters) {
		var textResults = "";
		var expPoints = 50;
		for ( var character of characters ) {
			gC(character).empathy.addExperience(expPoints);
			textResults += gC(character).getFormattedName() + " gained " + (expPoints * gC(character).empathy.affinity).toFixed(1) + " empathy experience points.\n";
		}
		return textResults;
	}
	scr.getContent = getScrollOnFamilyContent;
	return scr;
}

// The Wilds
window.getScrollTheWildsContent = function() {
	var content = "Not everywhere in the Confined Valley is safe. Outside of the tribes, creatures and monsters that do not share the values of civilized peoples hunt for prey. While it is unheard of a monster from the Valley to take someone's life, they desire their energy and rob it, sometimes even kidnapping their victims to feed on them for long periods of time.\n\n"
				+ "The members of the tribes who do not wander off have nothing to fear, as the creatures have learned to respect us when we're in large numbers, but those who wish to travel and meet other tribes or explore the Valley must be considerably cautious. It is advisable to be accompanied by strong companions, as well as being able to put on a fight by yourself.";
	return content;
}
window.createScrollTheWilds = function() {
	var scr = new Scroll("theWilds","The Wilds","lore");
	scr.firstTimeEffect = function(characters) {
		var textResults = "";
		var expPoints = 50;
		for ( var character of characters ) {
			gC(character).perception.addExperience(expPoints);
			textResults += gC(character).getFormattedName() + " gained " + (expPoints * gC(character).perception.affinity).toFixed(1) + " perception experience points.\n";
		}
		return textResults;
	}
	scr.getContent = getScrollTheWildsContent;
	return scr;
}

// Gleaming Caverns
window.getScrollGleamingCavernsContent = function() {
	var content = "The Shapeshifter tribe finds their home at the south of the Confined Valley, in a system of caves known as the Gleaming Caverns. The Caverns are hardly a hospitable environment for most forms of life, as food is scarce, its tunnels labyrinthine, and floods a most common issue - all of them conditions that the Shapeshifters aptly managed to adapt to.\n\n" +
	"The Caverns owe their name to the gleaming crystals, a rare material that's difficult to find at any place other than this area. Their most peculiar traits are that they disrupt the flow of aether within living beings they're in touch with, but whenever the aether is infused in them from a distance, they temporarily turn gelatinous, which allows to shape them into any desired form. As their name suggests, the crystals emit light, but they will stop doing so after a long time until they're exposed to the Sun. It is through the laborious effort of Shapeshifters that gleaming crystals are periodically charged and placed through some of the Caverns' corridors, effectively making them Gleaming.\n\n" +
	"The forests surrounding the Caverns are rich in ponds, marshes and rivers that find the end of their lives, carrying water that gets permeated into the ground, only to later fall down to its subterranean tunnels. Through most of them, the flow of the water is irregular and fairly unpredictable, sometimes even causing whole routes to flood. A few of them have exceptionally consistent precipitations, which made Shapeshifters decide to settle in them.\n\n" +
	"The tribe's construction efforts were focused in three areas: the building of their own village, paving selected tunnels to prevent travellers from getting lost in them, and the development of infrastructure to control the flow of water. Some of the most relevant places of their town are their assembly, often used as a theater, the Harmony Temple, under indirect control of the High Priestess, and their workshops, which contain furnaces and other tools to craft different types of ceramics.";
	return content;
}
window.createScrollGleamingCaverns = function() {
	var scr = new Scroll("gleamingCaverns","Gleaming Caverns","lore");
	scr.firstTimeEffect = function(characters) {
		var textResults = "";
		var expPoints = 75;
		for ( var character of characters ) {
			gC(character).perception.addExperience(expPoints);
			textResults += gC(character).getFormattedName() + " gained " + (expPoints * gC(character).perception.affinity).toFixed(1) + " perception experience points.\n";
		}
		return textResults;
	}
	scr.getContent = getScrollGleamingCavernsContent;
	scr.mayBeFound = function(characters) {
		var flag = false;
		if ( State.variables.daycycle.day > 12 || State.variables.daycycle.month > 1 ) {
			flag = true;
		}
		return flag;
	}
	return scr;
}

// Shapeshifter Customs
window.getScrollShapeshifterCustomsContent = function() {
	var content = "The most characteristic trait of the Shapeshifters is, naturally, their ability to change their forms, which is in turn the central stone of their social customs. Those members of the tribe who supplant someone else's identity must only do it for limited periods of time, and the consequent deception, if it exists, must be repaired shortly. Those who decide to take different forms for long periods of time must not hide their identity. Those who break these rules will be shunned by the community, those who break them with the intent of perverting the consent or decisions of others will be severely punished - those who target the whole tribe will be subjected to exile.\n\n" +
	"These severe rules are relaxed during the Twisted Festival, a yearly festivity where everyone is allowed to use anyone's form to prank others - and everyone is expected to avoid taking anything seriously. The main activity of this festival is a theater play which has a central theme and a few script guidelines, but the performers are allowed to improvise, change roles, and significantly alter the story. When a new generation of Candidates to High Priestess is being trained, they're expected to participate as performers.\n\n" +
	"Their economic activities may be summed up in these four activities: the collecting of minerals, crystals and dyes through the Gleaming Caverns and its surrounding zones, the crafting of ceramics and tools, the construction and repairing of buildings and paths, and the recharging of gleaming crystals. It is first attempted to distribute these tasks among all the Shapeshifters that want them.\n\n" +
	"Whenever there are small disputes or important events that require action by the whole tribe, a resolution will be settled by a council of judges, which are randomly selected among all adult Shapeshifters every three years, or, in the case of matters of extraordinary gravity, by the whole tribe in assembly.";
	return content;
}
window.createScrollShapeshifterCustoms = function() {
	var scr = new Scroll("shapeshifterCustoms","Shapeshifter Customs","lore");
	scr.firstTimeEffect = function(characters) {
		var textResults = "";
		var expPoints = 75;
		for ( var character of characters ) {
			gC(character).empathy.addExperience(expPoints);
			textResults += gC(character).getFormattedName() + " gained " + (expPoints * gC(character).perception.affinity).toFixed(1) + " empathy experience points.\n";
		}
		return textResults;
	}
	scr.getContent = getScrollShapeshifterCustomsContent;
	scr.mayBeFound = function(characters) {
		var flag = false;
		if ( State.variables.daycycle.day > 12 || State.variables.daycycle.month > 1 ) {
			flag = true;
		}
		return flag;
	}
	return scr;
}

		// SHORT STORIES
// Basic of sex
window.getScrollTheBasicsOfSexContent = function() {
	var content = 'Tags: Futanari, Female x FemHerm\n\n'
				+ '//"I have always wanted you."// The words escaped her mouth in a single moment, fast and short as the pause that interrupted their kiss.\n\n'
				+ '//"I know. And now you have me all to yourself"//, replied her lover. The wolfgirl was embracing her companion around the waist, pushing her closer and closer to the wall. //"Tell me, Leap, is it true that you... below there..."//\n\n'
				+ '//"How about you find out by yourself?"// Leap took her feline friend\'s hand and placed it next to her own groin. Gillis\' curiosity overcame her nervousness, and moved a little to the left.\n\n'
				+ '//"Oh! It\'s true."//\n\n'
				+ '//"Of course it is. And you want it whole, don\'t you?"//\n\n'
				+ 'Gillis nodded quietly.\n\n'
				+ '//"Good."// Leap kissed the catgirl\'s cheek and dragged her tongue along her companion\'s ear. //"Turn around."//\n\n'
				+ '//"Eeeh? You want to do it from behind?"//\n\n'
				+ '//"Don\'t you?"//\n\n'
				+ 'Gillis blushed, but didn\'t reply. The wolfgirl placed a hand on her shoulder and the catgirl turned around by herself. Gillis was soon facing the wall, unable to decide if she should place her hands on it, when she felt her lover taking her pants down. Leap got up, held her close, and... //"Eek!"// ...the kitty felt her partner\'s cock touching her behinds. Her instincts fired up and she hugged the wall, but she immediately felt Leap again as she hugged her.\n\n'
				+ '//"Do you know why they called me Treacherous Leap in the Temple?"//\n\n'
				+ '//"...Because you jump on your enemies..."//\n\n'
				+ '//"From behind."// Gillis felt something hot touching her pussy, and despite not being able to see it, she knew exactly what it was. //"I\'m going in. Are you ready?"//\n\n'
				+ '//"Yes."// And Leap kissed her, and her dick kissed her insides.';
	return content;
}
window.createScrollTheBasicsOfSex = function() {
	var scr = new Scroll("theBasicsOfSex","The Basics of Sex","shortStory");
	scr.firstTimeEffect = function(characters) {
		var textResults = charactersLearnSceneActions(characters,["pushHipsBack","pushAssBack","scissor","thrust","mountFromBehind","rideDick","pushDickBack"]);
		return textResults;
	}
	scr.getContent = getScrollTheBasicsOfSexContent;
	return scr;
}

// The taste of pleasure
window.getScrollTheTasteOfPleasure = function() {
	var content = 'Tags: Male x Female, oral, shapeshifting/transformation, power exchange, roleplay, maledom, femsub\n\n'
				+ '//"Are you ready?"//\n\n'
				+ '//"I am. Here I go."// And his skin started taking form: the form of scales. They were pointy and sharp at first, but they got closer and joined each other, and they took a softer and softer texture, until his whole body was that of a lizardly humanoid.\n\n'
				+ '//"Tremble, slime! I have bested your companions and no one\'s here to defend you anymore. By right of conquest, you belong to me now!"//\n\n'
				+ '//"Oooh, nooo! My dear friends, who did their best to keep me safe! I can\'t believe you did this to them!"//\n\n'
				+ '//"And far worse things I\'ll do, if you don\'t accept your new place and serve me!"//\n\n'
				+ '//"I beg you not! I yield to you, my new master! Please leave them alone and tell me what it is that you desire!"//\n\n'
				+ '//"Lose not a single moment, and prove to me your submission. Come here and kneel before me."//\n\n'
				+ 'Tantian obeyed and knelt before the lizard, far more eager than she was suppossed to. //"Shall I pleasure you?"//\n\n'
				+ '//"You shall."// And Druzta showed the Shapeshifter woman his member.\n\n'
				+ 'She moved her nose close to his dick, and savoured its smell with a small breath first, and a far deeper one next. Then she stuck her tongue out, and traced a line with it along the spear. She placed small kisses here and there, put a lateral section of the member between her lips, and moved her mouth up and down, her tongue tasting every inch that got inside.\n\n'
				+ '//"I see you\'re enjoying your submission far too much... Slut."//\n\n'
				+ 'Tantian\'s left hand was massaging her own clitoris. //"Oooh, I\'m so sorry, my dearest companions. It appears I have got addicted to monster cock!"//\n\n'
				+ '//"Such a shame that they aren\'t awake to see it. Now eat it whole."//\n\n'
				+ 'And she obeyed. She put the tip inside first, and licked it throughly, while she massaged the rest of the dick with her right hand. The Shapeshifter woman moved her eyes up, and she found Druzta\'s satisfied smile, looking at her with approval. The reptilian man placed his hand on her head, and petted her. She decided to move on, and her lips advanced along the cock, slurping greedily. The lizard soon took the lead of the situation, as he pushed her head towards his groin, and his dick inside her. He was fucking her throat.\n\n'
				+ 'Tantian\'s right hand was struggling to keep his leg grabbed, in order to not to lose balance, but her other hand\'s fingers were penetrating her own pussy with harsh intensity. Just as she came, so did he, and she felt her semi-liquid gullet get filled with a new fluid. She gulped it on the go, and the dick immediately left her mouth.\n\n'
				+ 'Moments later, his partner was already turning back into his usual Shapeshifter self.\n\n'
				+ '//"Aaah, that wasn\'t easy. Did you like it?"// Druzta asked her.\n\n'
				+ '//"I loved it. ...What do you want me to turn into next time?"//';
	return content;
}
window.createScrollTheTasteOfPleasure = function() {
	var scr = new Scroll("theTasteOfPleasure","The Taste Of Pleasure","shortStory");
	scr.firstTimeEffect = function(characters) {
		var textResults = charactersLearnSceneActions(characters,["kneel","makeKneel","legHoldHead","getBlowjob","fuckFace","suckDick","lickPussy",
						  "rideFace","giveCunnilingus","giveBlowjob"]);
		return textResults;
	}
	scr.getContent = getScrollTheTasteOfPleasure;
	return scr;
}

// Surprised in the rear
window.getScrollSurprisedInTheRearContent = function() {
	var content = 'Tags: Male x Female, Teasing, Anal, Toys, Soft exhibitionism\n\n'
				+ 'The young couple had an uncommon privilege. While the vast majority of Ashwalkers who wanted to witness the dances or the fights had to walk through the whole village and take a seat before the stage, their house was fairly close to the amphitheater, and they could watch the spectacles from the terrace at their roof.\n\n'
				+ 'He, however, had woken up in a mischievous mood, and had other intentions. Just as the first dance started, he grabbed her butt. Vishllyin took it as a gesture of affection at first, but his middle finger soon traced a line... Straight to her ass.\n\n'
				+ '//"Oh, stop that."//\n\n'
				+ '//"Stop what?"//\n\n'
				+ 'She immediately realized the game. Hidden behind the terrace\'s walls, no one below could figure out something was going on behind her pants, but abrupt movements would definitely get someone\'s attention. Therefore, if she actually wanted to watch the dance, she couldn\'t fight this intruding hand.\n\n'
				+ '//"Hello, Vish! Hi Drill! You two sure are lucky, with the dances coming right to your home!"//\n\n'
				+ 'The couple greeted their unsuspecting neighbour below, Vishllyin showing a forced smile, Ashdrillyal with a confident, happy one, and the old woman went away to take her own seat.\n\n'
				+ '//"This idiot is going to get it."// thought Vish, and started massaging her own husband\'s anus. His expression changed, but not too much. //"Enjoying the dances, dear?"//\n\n'
				+ '//"Yes! It\'s amazing, the kind of moves they come up with."//\n\n'
				+ 'Behind their friendly words, they both had started fingering each other through their clothes. At the pace things were going, there would be no victor in this battle, and she wouldn\'t be able to pay attention to the dances at all.\n\n'
				+ '//"I need a small seep of water, I\'ll be right back."//\n\n'
				+ '//"Don\'t take too long, Vish. The show is very interesting today. It would be a shame if you missed it."//\n\n'
				+ '//"You\'ll swallow your words, asshole."// she thought.\n\n'
				+ 'When Vish came back, she put herself immediately next to her husband, and he didn\'t lose a moment to start fingering her again. Ashdrillyal got very confused, however, when he felt her wife\'s hand entering his pants from behind, her fist closed.\n\n'
				+ 'When he realized her intentions, it was already too late: the cold metal of the plug entered him in a single movement.\n\n'
				+ '//"Waaah!"// he fought to silence his own shout, to little use. A few spectators closest to their home turned back to check what was happening. //"It\'s... It\'s too beautiful! They have so much talent that I got excited. That\'s all."// He got confused faces from his fellow tribesmen.\n\n'
				+ '//"That\'s wonderful, dear. But please be quiet, and remain close to me."// With the safe end of the plug on her hand, Vish now held the asshole of her husband in place, confident that he would cause no more trouble for the rest of the day.'
	return content;
}
window.createScrollSurprisedInTheRear = function() {
	var scr = new Scroll("surprisedInTheRear","Surprised in the Rear","shortStory");
	scr.firstTimeEffect = function(characters) {
		var textResults = charactersLearnSceneActions(characters,['strokeAss','penetrateAss','analThrust','doublePenetration','doubleThrust','analMountDick','analRideDick','analPushDickBack']);
		return textResults;
	}
	scr.getContent = getScrollSurprisedInTheRearContent;
	return scr;
}

// Payback for the thief
window.getScrollPaybackForTheThiefContent = function() {
	var content = 'Tags: Female x Male, bondage, domination, femdom, malesub\n\n'
				+ 'She had earned the title of "The witch", and no other Leirien called her any other way anymore. It was an appropiate name, given her natural magical talent and her solitary life. She didn\'t hold any particularly mean grudges against anyone, but her condition made it important for her to always remain wary of any undesired visitors. This constant vigilance was what made her wake up, despite the remarkable quietness of the intruder. He was already leaving, but she immediately understood the situation and left the bed, and then the shack, and shouted to the fleeing catboy:'
				+ '//"I beg you to stop!"//\n\n'
				+ 'It was probably the strange choice of words that made the Beastkin man stop and turn back. He was fast and she wouldn\'t be able to catch him anymore, and that made him confident enough to decide that talking to her was worth satisfying his curiosity.\n\n'
				+ '//"You beg me? Aren\'t you the powerful witch of the forest?"//\n\n'
				+ '//"Your words flatter me, but I\'m no match against such an agile athlete in a race. Given that you hold the upper hand, perhaps you\'ll listen to my words?"//\n\n'
				+ '//"Very well. What do you have to say?"//\n\n'
				+ 'She managed to get a better look at him, and found that he was exceptionally handsome. He had lean and well marked facial features. His eyes appeared to have a most peculiar green colour.\n\n'
				+ '//"I understand that it\'s taken you a great effort to rob me, but what you hold is dear and precious to me."//\n\n'
				+ '//"Do you even know what I\'ve taken?"//\n\n'
				+ '//"Of course. You\'ve stolen my heart."//\n\n'
				+ '//"Your what?"//\n\n'
				+ 'And his surprise did the trick, and he fell to the ground. While they were talking, the cunning witch had been repositioning roots and vines that were close to the Beastkin, and it only took her a moment to throw them to his legs. A strong strike made him fall, and the second one got his ankles were bound. He reacted fast and struggled to liberate himself with his hands, but these, too, ended tied up.\n\n'
				+ 'The witch calmly walked up to the thieving catboy, who had both hands and feet stretched and locked, forming a cross, and was unable to leave the ground.\n\n'
				+ '//"The truth is that I haven\'t taken anything, I only wanted to take a look at you."//\n\n'
				+ '//"And my truth... Is that you have taken my heart..."// As she said this, she removed the man\'s pants, exposing his increasingly erect cock. //"But don\'t worry."// She licked her lips. //"I\'m going to fuck you until I get it back. ...Perhaps it\'ll take a few days."// And she lowered herself on him.';
	return content;
}
window.createScrollPaybackForTheThief = function() {
	var scr = new Scroll("paybackForTheThief","Payback for the thief","shortStory");
	scr.firstTimeEffect = function(characters) {
		var textResults = charactersLearnSceneActions(characters,['spanking','holdArms','vinesHoldArms']);
		return textResults;
	}
	scr.getContent = getScrollPaybackForTheThiefContent;
	return scr;
}

// Pillow feet fight
window.getScrollPillowFeetFightContent = function() {
	var content = 'Tags: Female x Female, footjob\n\n'
				+ 'It was an annoyingly warm night, but if there was something that made it even harder for Belluillsha to sleep, that was having to share a bedroll with Ninllinshian. The two women were proud Ashwalker warriors, and they formed part of an expedition to put a group of monsters that had been too cocky in their place. They had already fulfilled their mission, but on the way home, Ninllinshian had destroyed her own bedroll during a nightmare, and Belluillsha now had to share hers. Each of them had placed their heads on opposite ends, and their feets were close to each other\'s knees. It was a long bedroll.\n\n'
				+ '//"Fuck this."// Bell thought, and she hit her companion with her heel bone, which woke her up.\n\n'
				+ '//"Mmm... What happened?"//\n\n'
				+ '//"Nothing."//\n\n'
				+ 'Silence followed for a few seconds, but then Bell hit her again.\n\n'
				+ '//"Can you stop that?"//\n\n'
				+ '//"If you don\'t like it you can leave my bed!"//\n\n'
				+ '//"I already told you I\'m sorry. I don\'t want this either."//\n\n'
				+ 'And Bell did it yet again. //"Oh, you made it this time!"// And so, a feet fight got started. They weren\'t particularly strong kicks and they would hardly injure each other, but they were definitely annoying and they wouldn\'t be sleeping any time soon. But one of them... Wasn\'t like the others.\n\n'
				+ '//"Aww!"// Bell shouted.\n\n'
				+ '//"I\'m sorry! I didn\'t want to hit you there."//\n\n'
				+ '//"You\'ve kicked my cunt!"//\n\n'
				+ '//"It wasn\'t my intention!"//\n\n'
				+ 'Bell moved her own foot with decision, and placed it at Ninllin\'s private parts.\n\n'
				+ '//"Please don\'t, please don\'t, I told you I\'m sorry, I\'m-"// Ninllin was revolving to get her companion\'s foot off herself, to little use. But she didn\'t expect what came next. //"I.. Nn... Nnngghh? Why?"//\n\n'
				+ 'Bell was now massaging Ninllin\'s pussy with her feet. //"Shut up and behave."//\n\n'
				+ '//"Ok, ok. But please don\'t hurt me."//\n\n'
				+ 'Bell\'s left foot was describing circular movements on her companion\'s clitoris with incredible care, while the right one was trying to push its big toe inside. Not much time later, Bell changed her position and moved her left leg down...\n\n'
				+ '//"Lick my ankle"//, she ordered. And Ninllin complied, because the ankle wasn\'t as smelly as the foot itself, and she was scared of Bell.\n\n'
				+ 'Belluillsha sighed. It wasn\'t the most pleasing activity for herself, especially given that her own parts were still aching, but it would be worth it. Ninllinshian reached her orgasm a few minutes later, and she passed out.\n\n'
				+ '//"Lucky me that you\'re like this."// She left the bedroll, dragged her companion out, and entered it again, happy and ready to sleep. //"Get tapped in the knee and you wake up in a single moment, but cum your brains out and no one will wake you up."// She sighed. //"At least now I have the whole bedroll for myself."//';
	return content;
}
window.createScrollPillowFeetFight = function() {
	var scr = new Scroll("pillowFeetFight","Pillow Feet Fight","shortStory");
	scr.firstTimeEffect = function(characters) {
		var textResults = charactersLearnSceneActions(characters,['dickFootjob','pussyFootjob','lickLegs']);
		return textResults;
	}
	scr.getContent = getScrollPillowFeetFightContent;
	return scr;
	
}

// Punishing the traitors
window.getScrollPunishingTheTraitorsContent = function() {
	var content = 'Characters: Cainei (Gaanidan female), Wesia (Gaanidan female), Rasce (Gaanidan male)\n\n'
				+ 'Tags: Female x Male, Female x Male, bondage, domination, femdom, femsub, malesub, denial\n\n'
				+ '"Please, Cainei, think calmly about this... You\'re going too far."\n\n'
				+ 'The voice of her friend Rasce was the first thing Wesia heard when she woke up, but her fuzzy mind was going to need some more work to understand the situation. Her lazy eyes opened for half a second, and caught a glance of a foot massaging a dick. She made an extra effort to keep them open the next time, and she found their friend Cainei standing on her feet before Rasce who laid down on the floor, as she gave him a footjob.\n\n'
				+ '"Please, I beg you..."\n\n'
				+ '"Your begging isn\'t going to undo what you did." She replied merciless, without stopping.\n\n'
				+ 'A second inspection made Wesia notice an important detail of the scene: Rasce\'s arms and feet were chained, and he was immobilized.\n\n'
				+ '"What are you doing...?" Wesia asked, still confused. A third inspection made her realize an even more important issue: SHE was chained too. "Huh? What\'s going on!?"\n\n'
				+ '"That\'s what I\'d like to know too! What\'s going on with you, you little scum!" A furious Cainei replied. The massage against Rasce\'s dick was growing in intensity: Cainei\'s fingers grabbed the head of the penis and rubbed it aggressively.\n\n'
				+ '"Cainei, why are we chained!? Why am I chained!?"\n\n'
				+ '"If you don\'t know, you\'re even more guilty!"\n\n'
				+ '"Uugh-guugh..." Rasce groaned.\n\n'
				+ '"Ah, there you are." Said Cainei, who quickly retired her foot, and stepped on the base of Rasce\'s cock, making sure that no other part of it was getting contact with anything.\n\n'
				+ '"No, please, let me cum!"\n\n'
				+ '"Ah, but you\'re cumming alright." A small but long stream of cum sprouted from the sad dick, in what was probably the most frustrating and humilliating orgasm it had ever experienced. "This is what traitors like you deserve!"\n\n'
				+ '"Why... Why are you so cruel...?"\n\n'
				+ '"Cainei! Please tell me why you are doing this!" Wesia insisted.\n\n'
				+ '"Don\'t worry, Wesia. I\'m going to make you remember." The free woman walked towards her chained friend, and stepped on her pussy. "After your clit aches in heat and desperation like I\'m going to make it, you\'ll remember for a long, long time." Cainei\'s big toe started making circles on her prisoner\'s clitoris, ready to torture it.\n\n'
				+ '"But tell me at least what I did to make you angry!"\n\n'
				+ '"You...! You ate all of our sweets!" Cainei revealed, indignant.\n\n'
				+ '"What?"\n\n'
				+ '"You two left me with nothing!"\n\n'
				+ '"What!? Are you torturing us because we left you without sweets!?" Wesia couldn\'t believe her ears.\n\n'
				+ '"They were the special sweets that the Leirien gave us, and you never know how long it\'ll be until they bring more again! They\'re delicious, and now they\'re GONE!"\n\n'
				+ '"Cainei," Rasce intervened, "if it makes you feel better, they weren\'t even that good."'
				+ '"Don\'t lie to me, you bastard! You ate all of them!"\n\n'
				+ '"Agh! Rasce, don\'t make her angrier, she\'s hurting me..." Wesia complained.\n\n'
				+ '"You\'re going to be nothing but a drooling, pained dog in heat, when I\'m done with you."\n\n';
	return content;
}
window.createScrollPunishingTheTraitors = function() {
	var scr = new Scroll("punishingTheTraitors","Punishing The Traitors","shortStory");
	scr.firstTimeEffect = function(characters) {
		var textResults = charactersLearnSceneActions(characters,['denyOrgasm','teaseLockedPussy','teaseLockedDick','baTeaseLockedDick','baTeaseLockedPussy']);
		return textResults;
	}
	
	scr.getContent = getScrollPunishingTheTraitorsContent;
	scr.mayBeFound = function(characters) {
		var flag = false;
		if ( State.variables.daycycle.day > 10 || State.variables.daycycle.month > 1 ) {
			flag = true;
		}
		return flag;
	}
	return scr;
}

// Tribute for the Goddess
window.getScrollTributeForTheGoddess = function() {
	var content = 'Characters: Aspenn (Leirien male), Indomitable Will (Beastkin lion male), Wind (Beastkin bat male), Innocence (Beastkin bunny female), Wisdom (Beastkin fox female), Fury (Beastkin leopard male)\n\n' +
		'Tags: Orgy, Female x Male, Female x Female, Male x Male, Exhibitionism, Hypnosis, Vaginal, Oral, Anal, Facesitting\n\n' +
		'Note: While this text is based on the historical record, specific facts have most likely been altered for narrative purposes.\n\n' +
		'"Are your whelps ready?" Aspenn asked to the Beastkin leader.\n\n' +
		'Will looked around filled with distrust. The figure these peoples worshipped as their Goddess was at a platform at the top of the stairs, hidden behind an opaque veil. As it appeared, not even at this time would she bother to let him hear her voice. Will turned his eyes down, at the base of the hill. His people braced each other, not completely certain about their fate.\n\n' +
		'"As ready as they will ever be." He replied plainly.\n\n' +
		'"...But they could use some help, couldn\'t they?" The Leirien High Priest looked at his subordinates, and gestured them to proceed. The other priests went down the hill and took yellow and orange flowers out of leather bags, placing them around the Beastkin peoples. A small minority of them checked the flowers with curiosity, and they were the first ones to fall.\n\n' + 
		'"Wind, are you ok? You\'re making a strange face..."\n\n' +
		'Wind\'s face had gone from displaying excitement to dizziness, his bat face taking an unusual reddish colour. He was soon intensely gazing at his bunnygirl friend.\n\n' +
		'"W-Wind? You\'re scaring me. Please tell me you\'re ok..."\n\n' +
		'"Inno... Innocence, come here."\n\n' +
		'"Ah!?" His mouth assaulted hers, his hands explored her body with impatience. Was this really her friend Wind?\n\n' +
		'"What have you done?" asked Indomitable Will, half a hundred meters away, "What are you doing to my people!?"\n\n' +
		'"Relax. They\'re perfectly fine, and they will continue to be." Aspenn declared, with contrasting quietness. "We have just freed them from their natural inhibitions. For a while. That will help you fulfill your part of the deal."\n\n' +
		'"You..."\n\n' +
		'Down the hill, the events advanced with heated speed. Wind was rubbing his dick against Innocence\'s crotch, and he would enter her soon.\n\n' +'"Wind, you... Ah~" Innocence\'s protests were about to dissipate, when a new actor joined the play.\n\n' +
		'"Innocence, I\'ve always wanted to do this." And the young woman\'s lips met those of another friend of hers.\n\n' +
		'"Wisdom! You... Your husband!" Wisdom\'s husband, a leopard man named Fury, was caressing Wind from behind.\n\n' +
		'"It\'s fine. He wants this as much as I." Innocence\'s body was now being groped by both Wind and Wisdom, and her mind was starting to succumb to the flower\'s scent, even though she wasn\'t able to pay attention to the smell.\n\n' +
		'Wind laid the bunnygirl on the ground and kneeled before her, and Wisdom took position to sit on her face. Just as her friend\'s pussy hugged her nose and mouth, Wind\'s cock took Innocence\'s virginity. Behind him, Fury was about to be the first to enter Wind\'s ass.\n\n' +
		'"You\'re crossing a line here! Some of these men and women had promised to be loyal to each other, and now..."\n\n' +
		'"Will." Aspenn replied, his tone unwavering.\n\n' +
		'"Now they\'ve turned into this! This wasn\'t part of the deal!"\n\n' + 
		'"Will." it wasn\'t just Aspenn\'s voice this time.\n\n' +
		'"You are going to regret..."\n\n' +
		'"Behind you, Will." And Will felt it, the presence behind him that was now calling his name.\n\n' +
		'"Uh!? Who... Who are..."\n\n' +
		'"I\'m her who you have sworn your allegiance to."\n\n' +
		'"The veil..."\n\n' +
		'"Drop to your knees." She didn\'t need to repeat her words. As it turned out, his will wasn\'t so indomitable, after all. "Good. You know what you must do with your mouth, right?"\n\n'
		'"...Yes..."\n\n' +
		'"Who could have imagined it? Innocence\'s so enthusiastic about this!" Wisdom shouted as she rode the bunnygirl\'s face. "How is the bat, honey?"\n\n' +
		'"Much tighter than I expected." Fury replied heavily. "It\'s quite amazing. We should talk more often to these two." Neither Innocence nor Wind could reply: the former had enough with being able to breathe between Wisdom\'s aggressive movements, and the latter was too immersed in the pleasure that engulfed both his dick and his ass.\n\n' +
		'He wasn\'t the only one. Everyone around them was obeying their most primal impulses, exploring the bodies of their fellow tribespeoples in ways they had never ever imagined.\n\n' + 
		'"Stop sucking for a moment. Tell me why you\'re doing this."\n\n' +
		'"I\'m protecting my tribe. You... Demanded a tribute from us in order to be allowed to settle in the Valley, and..." Will was cut off.\n\n' +
		'"No. Tell me why you\'re really doing this."\n\n' +
		'"..." Will\'s mouth was open, but words had to fight their way out. "...Because you willed so, and your will is law."\n\n' +
		'"Honesty is a good trait. Yes... You may have your place here in the Valley, after all."\n\n' +
		'From that day onwards, the Beastkin became the fourth tribe that worshipped the Goddess, privileged proteges freed from the dangers of the outer world.';
	return content;
}
window.createScrollTributeForTheGoddess = function() {
	var scr = new Scroll("tributeForTheGoddess","Tribute for the Goddess","shortStory");
	scr.firstTimeEffect = function(characters) {
		// TO DO: Learn new positional actions
		var textResults = charactersLearnSceneActions(characters,['extraMountFromBehind','extraKneel','extraMakeKneel','extraLegHoldHead']);
		return textResults;
	}
	
	scr.getContent = getScrollTributeForTheGoddess;
	scr.mayBeFound = function(characters) {
		var flag = false;
		if ( State.variables.daycycle.day > 11 || State.variables.daycycle.month > 1 ) {
			flag = true;
		}
		return flag;
	}
	return scr;
}


	// GAMEPLAY
// The basics of combat
window.getScrollTheBasicsOfCombat = function() {
	var content = '' +
				  '"Warfare in these lands is unlike anything we\'ve ever seen. Strikes that have always ended someone else\'s life may do nothing more than incapacitate their targets, at most, and it only lasts for a short while. Accordingly, this land\'s creatures have developed their own ways of fighting, much more effective under these strange conditions.\n\n'
				  + 'Rather than sparring until they manage to land fatal blows, our enemies fight to exhaust us, to make us run out of strength until we barely have control over our legs. Once we\'re on the ground, they jump onto us and... Oh, gods! My feeble mind barely has the will to keep on writing. They try to make us cum!\n\n'
				  + 'As strange as it sounds, when we\'re fighting in these lands, the strength of an orgasm depletes our energies, forcing us to wait for a while until we get recovered. Most luckily, not only we have had no casualties, the enemy hasn\'t captured any of us, either! After the last skirmishes, we\'ve always managed to flee. Let\'s make use of this precious time to understand how to fight back.\n\n'
				  + 'It is of the highest priority that all of us that are capable of fighting learn to endure sexual pleasure. Every second we manage to resist without reaching climax is one second we get closer to victory. Some techniques we\'ve been discussing are controlling our breathing, leaving our minds blank or focusing our attention in our arms\' and legs\' muscles. I think I will call these techniques the "Cold Guts", because one truly has to be a cold bastard to take their attention away from sex when they\'re doing the deed.\n\n'
				  + 'The next moves we talked about were pouncing and struggling. Pouncing is what these lands\' creatures do when they find someone weakened: they jump on them, throw them to the ground and hold them down to have sex. While most wait until the jump is secure, those non-humans with animal parts are keen to try much earlier - and damn me if they\'re not good at it. Once we\'re pinned down, it\'s usually best to struggle as much as possible until we kick our enemies out, which seems to be much easier to do if we haven\'t done much physical or mental work earlier in the day."\n\n'
				  + 'Notes on fighting in the Confined Valley, by Teitu, Gaanidan Warrior';
	return content;
}
window.createScrollTheBasicsOfCombat = function() {
	var scr = new Scroll("theBasicsOfCombat","The Basics of Combat","gameplayTips");
	scr.firstTimeEffect = function(characters) {
		var textResults = charactersLearnSceneActions(characters,['coldGuts','pounceFrontal']);
		return textResults;
	}
	scr.getContent = getScrollTheBasicsOfCombat;
	return scr;
}

	// TUTORIALS
// A Proper Candidate
window.getScrollAProperCandidate = function() {
	var content = "I have found myself in the rare position of having to tutor not one, but two generations of Candidates. This particular position has given me such insight that it would be nothing but wasteful to not to share it as much as possible, not only with those I've had the pleasure of sharing my life with, but with the future generations as well.\n\n"
				+ "Today's text will discuss one of the fundamental concepts a Candidate should have in mind when pondering about how to make the best out of her training. It's clear to anyone who bothers to use their eyes that not everyone shares the same strengths: some people are fitter, smarter, or more charming, and these traits tend to change over time. Traditionally, the Passion Temple has categorized them in the following way:\n\n"
				+ "- __Physique__: The capacity of a character to exert physical strength. Used for many physical activities and taxing sexual actions. Raises lust and energy.\n"
				+ "- __Agility__: The ability of a character to execute tasks that require precision. Used for many sexual actions, and often used to evade physical attacks. Raises lust and energy.\n"
				+ "- __Resilience__: The capacity of a character to resist exhausting physical work and hits. Most commonly used to resist physical attacks and intense sexual pleasure. Raises lust and energy.\n"
				+ "- __Will__: Indicates the mental resilience of a character. Often used to resist temptations and evade magical attacks, sometimes useful to cast magic. Raises lust and willpower.\n"
				+ "- __Intelligence__: Refers to the strength of the mind. Most commonly used to cast complex, precise magic. Raises lust and willpower.\n"
				+ "- __Perception__: The capacity of a character to detect movements and sounds that would otherwise be ignored. Often useful to evade attacks. Raises lust and willpower.\n"
				+ "- __Empathy__: Indicates the ability of a character to understand the feelings and motivations of others. Most useful during socialization, also serves to resist social attacks. Raises lust and social drive.\n"
				+ "- __Charisma__: Refers to the ability of a character to get the most out of their expressions. Most useful during socialization, and it also powers social attacks. Raises lust and social drive.\n"
				+ "- __Luck__: In a world where everything is connected by aether, luck refers to the harmony of a character with all elements of the world. Improves in very small amounts your dealt sexual pleasure, damage, chances to land or evade attacks, and success during socialization.\n\n"
				+ "You must have noticed that the Training Grounds have the means to allow the Candidates to better themselves in all of them, but how much effort should each of them receive? The consensus tends to be that both putting all your effort into a single trait or distributing your efforts equally are misguided strategies in the long run. A more sensible approach is analyzing which ones are more important in your daily life and challenges, and approach them with proportional attention: if you rely in your peers for protection, it'd be most appropriate to polish your charms to keep them in your good sides; if you rely on magic to fulfill your goals, pay extra attention to your intelligence and will. Sometimes it's a good decision to dedicate a moderate amount of training to traits you don't directly use, but allow you to resist your daily life's challenges. Don't be afraid to commit excessive mistakes on your early days: you will have opportunities to get back on your feet.\n\n"
				+ "It should also be mentioned that people usually have more or less affinity towards some of these traits, which may be noticed by witnessing how much they improve with the same amount of effort. Naturally, it would be wise to rely on skills that your own body and mind are properly tuned with. While it's extremely rare, you may come across situations that could allow you to steer these affinities in more productive directions, should you decide it's worth it.";
	return content;
}
window.createScrollAProperCandidate = function() {
	var scr = new Scroll("aProperCandidate","A Proper Candidate","tutorial");
	scr.firstTimeEffect = function(characters) {
		var textResults = "";
		var expPoints = 50;
		for ( var character of characters ) {
			gC(character).resilience.addExperience(expPoints);
			textResults += gC(character).getFormattedName() + " gained " + (expPoints * gC(character).resilience.affinity).toFixed(1) + " resilience experience points.\n";
		}
		return textResults;
	}
	
	scr.getContent = getScrollAProperCandidate;
	scr.mayBeFound = function(characters) {
		var flag = false;
		if ( State.variables.daycycle.day > 2 || State.variables.daycycle.month > 1 ) {
			flag = true;
		}
		return flag;
	}
	return scr;
}

// The Arts of Socializing
window.getScrollTheArtsOfSocializing = function() {
	var content = "Talking to others is a task full of intricacies, even if we -or most of us- are intrinsecally equipped to have some sort of understanding. While some people move through social environments like they're fish in the water, some may lack some nuances, or may even be completely unaware that others measure their own moves with very specific goals in mind.\n\n"
				+ "While it may look like we have absolute free will over our own actions, the reality is that what we can say or think is limited by our own emotions and our understanding of ourselves, to the point that you may desire, in the depths of your heart, to grow closer with someone, but your heart will have trouble to allow you to take the first step. If you grow for long enough on some of your traits -fundamentally your empathy, but also your charisma and luck to some degree-, you will eventually find it easier for your guts to allow you to steer the conversation in a wider variety of directions.\n\n"
				+ "You must also be aware that your own emotions and mood will severely affect what your mind is willing to do: someone angry is more likely to scale a confrontation, while someone sinking in lust is prone to flirting - and everything that happens in a social environment will affect everyone's mood. Therefore, you must take into account several considerations: you should try to reach a state of mind favorable to your goals, you should try to make your peers reach a state of mind favorable to your goals, and some of your peers will try to get the others, including you, into a state of mind favorable to their goals. Your goals and those of your peers may allign, allign partially, be indifferent to each other or be completely incompatible. Make sure you notice what your peers are trying to achieve to react as fast as possible, if so you'd need. Everyone's mood has a resting point they will naturally move towards, so getting intimate, flirty or dominant enough with someone may be out of your reach today - keep training and it will become possible in the future.\n\n"
				+ "A common misconception is that charisma is the one and only trait a Candidate who wants to improve their socializing should be focusing on. While charisma is fundamental, especially to steer the initial course of a conversation, other traits also play a role, most commonly when the conversation takes a more physical turn. Will, agility, empathy, physique and luck are also occasionally useful.\n\n"
				+ "A final point that should be mentioned here are invitations and offers, which are accepted and rejected for all kinds of reasons, the most important ones usually being the person's mood, their relationship with the offering person, their desires, their goals and their values. The desire is a specially important one: when an offer in put on the table, the receiver may have a natural desire to accept it, even if their reason tells them otherwise. If this desire is strong enough, they may have to fight their willpower to reject the offer - and they may not be strong-willed enough to do so. In this case, they will accept the offer, but may hold some resentment towards the other person anyway.";
	return content;
}
window.createScrollTheArtsOfSocializing = function() {
	var scr = new Scroll("artsSocializing","The Arts Of Socializing","tutorial");
	scr.firstTimeEffect = function(characters) {
		var textResults = "";
		var expPoints = 50;
		for ( var character of characters ) {
			gC(character).empathy.addExperience(expPoints);
			textResults += gC(character).getFormattedName() + " gained " + (expPoints * gC(character).empathy.affinity).toFixed(1) + " empathy experience points.\n";
		}
		return textResults;
	}
	
	scr.getContent = getScrollTheArtsOfSocializing;
	scr.mayBeFound = function(characters) {
		var flag = false;
		if ( State.variables.daycycle.day > 2 || State.variables.daycycle.month > 1 ) {
			flag = true;
		}
		return flag;
	}
	return scr;
}

// The Arts of Bed
window.getScrollTheArtsOfBed = function() {
	var content = "The sexual arts should be a core skill for all Priestesses and Priests of the Goddess, for sex is not only a tool to keep the tribes united and harmonious, but also an instrument to gather aether.\n\n"
				+ "Some core concepts are desires and tastes for specific activities and actions - providing attention to your partners' preferences and desires is a great help to make your relations more satisfying. Desires are usually volatile, fleeting and easy to notice, and you can often evoke them with your own actions. Preferences tend to stay the same over time, but sometimes change due to each person's experiences, especially if they usually orgasm doing specific acts. If you get really close to someone, you should get some good insight of what their preferences currently are. Prior to that, you may infer some of their preferences by how much they like which acts.\n\n"
				+ "Once someone's excitement reaches its limit, they will orgasm, releasing some aether in the process. Reaching orgasm with your partners usually changes your predisposition towards them, especially regarding the context, such as how much people are sharing that intimate experience, who has the lead, and how long has it been since the last time the partners had sex. Unexperienced Candidates may not know that not all orgasms are equal, and some may be ruined or mindblowing. Ruined orgasms happen when the climax is interrupted or isn't allowed to properly conclude - they erode the victim's willpower and it's generally considered rude or outright hostile to ruin someone's orgasms. Mindblowing orgasms may take place depending on how much enjoyment the pleasured person has already had during the encounter, and how much their excitement is pushed far beyond its limits during climax. It is generally hard for new Candidates to get their partners to reach mindblowing orgasms. Regarding the changes in sexual preferences, both ruined and mindblowing orgasms have far greater effects in changing someone's tastes.\n\n"
				+ "Finally, I should make some mention of the lead during sex. Unless it has been previously decided that some people will or will not have the lead, each participant during sex will slowly get the chance to take the initiative. Keep in mind, however, that those with depleted willpower will have further trouble taking such initiative, which may render someone virtually submissive during an encounter which would have otherwise been on equal terms.";
	return content;
}
window.createScrollTheArtsOfBed = function() {
	var scr = new Scroll("artsBed","The Arts of Bed","tutorial");
	scr.firstTimeEffect = function(characters) {
		var textResults = "";
		var expPoints = 50;
		for ( var character of characters ) {
			gC(character).agility.addExperience(expPoints);
			textResults += gC(character).getFormattedName() + " gained " + (expPoints * gC(character).agility.affinity).toFixed(1) + " agility experience points.\n";
		}
		return textResults;
	}
	
	scr.getContent = getScrollTheArtsOfBed;
	scr.mayBeFound = function(characters) {
		var flag = false;
		if ( State.variables.daycycle.day > 2 || State.variables.daycycle.month > 1 ) {
			flag = true;
		}
		return flag;
	}
	return scr;
}

// The Arts of Combat
window.getScrollTheArtsOfCombat = function() {
	var content = "All Candidates should be well versed in the arts of battle, for being able to take up arms may be the difference between defending peace in the Valley and a painful descent into chaos. The generally accepted goal of combat is to bring your opponents into bursting aether out, which will incapacitate them for a while. This may be done through physical or magical means, but if your opponent is a person, and not a monster, sexual and social approaches may also work.\n\n"
				+ "A very important aspect of combat is control, or your capacity to stay on your feet and maintain your balance. While control is usually recovered on its own, once it's depleted, the combatant will remain extremely vulnerable to all kind of attacks, the most dangerous of which will lock them into an even more precarious position. If this happens, the only way to recover control is to deplete the control of your aggressor. Struggling is often a fairly direct and efficient method to achieve this goal, but it won't be as useful if you're missing willpower or energy, or if by some reason you're unable to move your arms or legs.\n\n"
				+ "Most actions you may use in combat have a chance to fail. By taking a moment to analyze the action, you may soon realize which traits are most effective for you or for your opponent to have when attempting to land them, or to evade them. It is fairly well known that pouncing on a target who has lost all their control will always be successful - it's not as well known that some types of actions are more or less likely to hit if you and your target are struggling hand to hand: projectiles will be less precise, hits will be less so, and contact actions will always be successful.\n\n"
				+ "Through my whole life, I've also noticed that some people have specific affinities with certain types of actions: some may be weaker to social attacks, or more effective when tempting their enemies with sex. When it comes to specific tribes, it looks like Leirien tend to be weak to fire attacks. The Aiishen usually have stronger magical attacks, weak defenses against magic, higher resistance against physical attacks, and weaker physical attacks. While it isn't intrinsic to them, quite a few Ashwalkers are particularly skillful at using weapons, which shouldn't surprise anyone who knows well their traditions.";
	return content;
}
window.createScrollTheArtsOfCombat = function() {
	var scr = new Scroll("artsCombat","The Arts of Combat","tutorial");
	scr.firstTimeEffect = function(characters) {
		var textResults = "";
		var expPoints = 50;
		for ( var character of characters ) {
			gC(character).will.addExperience(expPoints);
			textResults += gC(character).getFormattedName() + " gained " + (expPoints * gC(character).will.affinity).toFixed(1) + " will experience points.\n";
		}
		return textResults;
	}
	
	scr.getContent = getScrollTheArtsOfCombat;
	scr.mayBeFound = function(characters) {
		var flag = false;
		if ( State.variables.daycycle.day > 10 || State.variables.daycycle.month > 1 ) {
			flag = true;
		}
		return flag;
	}
	return scr;
}

// Deeper Relationships
window.getScrollDeeperRelationships = function() {
	var content = "It is sensible for a Candidate to plan ahead on which kind of relationships they wish to have with their peers, since weaving a stronger web of alliances than anyone else is a valid strategy to gaining the High Priestesshood - or at least to make sure that the winner is as favorable to you and your interests as possible.\n\n"
				+ "You are probably aware that relationships are complex dynamics that aren't easy to categorize. Love and desire, rivalry and enmity do not always go hand, and the complexities of the relationships you develop with your peers will be shaped by both your goals, theirs, and the life events that you have to go through. Remember that relationships that aren't constantly nurtured decay to become shadow of what they once were, but the past memories of your past love, passion and hate are hard to remove.\n\n"
				+ "Some generations of Candidates compete with specific rules involving special relationships. These are rules that temporarily shackle each person into a set of rules regarding how they must behave with each other. These special relationships may be egalitarian or hierarchical. Anyone may have as many egalitarian and dominant relationships as they wish, but only one submissive relationship at a time. If you have a submissive relationship, you will also be locked out of having any dominant relationships. These relationships usually change how each of their members view each other, but this is merely a temporary effect. Keep in mind that the duration of these special relationships may change as your training advances.\n\n"
				+ "Each person has their own values and goals in life, and this is usually even more important for Candidates, as one of them will hold considerable power over the Valley. These values and goals may be well defined, but they are never set in stone, and may change as the events change their holders. Your relationships with your peers and how you relate to each other will contribute to this - and in extreme cases, the combined efforts of several Candidates will create a dynamic where certain values will reign supreme. If everyone around you is obsessed about controlling others and not being controlled, power and domination will become universal values. Pay effort to build the Temple and Valley that you'd like to live in.";
	return content;
}
window.createScrollDeeperRelationships = function() {
	var scr = new Scroll("deeperRelationships","Deeper Relationships","tutorial");
	scr.firstTimeEffect = function(characters) {
		var textResults = "";
		var expPoints = 50;
		for ( var character of characters ) {
			gC(character).charisma.addExperience(expPoints);
			textResults += gC(character).getFormattedName() + " gained " + (expPoints * gC(character).charisma.affinity).toFixed(1) + " charisma experience points.\n";
		}
		return textResults;
	}
	
	scr.getContent = getScrollDeeperRelationships;
	scr.mayBeFound = function(characters) {
		var flag = false;
		if ( State.variables.daycycle.day > 10 || State.variables.daycycle.month > 1 ) {
			flag = true;
		}
		return flag;
	}
	return scr;
}

setup.scrollsList = [];
setup.scrollsList.onAether = createScrollOnAether();
setup.scrollsList.onFamily = createScrollOnFamily();
setup.scrollsList.theWilds = createScrollTheWilds();
setup.scrollsList.gleamingCaverns = createScrollGleamingCaverns();
setup.scrollsList.shapeshifterCustoms = createScrollShapeshifterCustoms();
setup.scrollsList.theBasicsOfSex = createScrollTheBasicsOfSex();
setup.scrollsList.theTasteOfPleasure = createScrollTheTasteOfPleasure();
setup.scrollsList.surprisedInTheRear = createScrollSurprisedInTheRear();
setup.scrollsList.paybackForTheThief = createScrollPaybackForTheThief();
setup.scrollsList.pillowFeetFight = createScrollPillowFeetFight();
setup.scrollsList.punishingTheTraitors = createScrollPunishingTheTraitors();
setup.scrollsList.theBasicsOfCombat = createScrollTheBasicsOfCombat();
setup.scrollsList.tributeForTheGoddess = createScrollTributeForTheGoddess();
setup.scrollsList.aProperCandidate = createScrollAProperCandidate();
setup.scrollsList.artsSocializing = createScrollTheArtsOfSocializing();
setup.scrollsList.artsBed = createScrollTheArtsOfBed();
setup.scrollsList.artsCombat = createScrollTheArtsOfCombat();
setup.scrollsList.deeperRelationships = createScrollDeeperRelationships();

window.getScrollsStringList = function() {
	var scrollsList = [];
	for ( var s in setup.scrollsList ) {
		if ( setup.scrollsList[s] instanceof Scroll ) {
			scrollsList.push(setup.scrollsList[s].key);
		}
	}
	return scrollsList;
}
window.getScrollsCharMayFind = function(character) {
	var scrollsList = getScrollsStringList();
	var newScrollsList = [];
	for ( var scr of scrollsList ) {
		if ( gC(character).foundScrolls.includes(scr) == false && setup.scrollsList[scr].mayBeFound(character) ) {
			newScrollsList.push(scr);
		}
	}
	return newScrollsList;
}

window.getScrollTypeText = function(scr) {
	var txt = ""
	switch ( scr.type ) {
		case "lore":
			txt = "Lore";
			break;
		case "shortStory":
			txt = "Short story";
			break;
		case "gameplayTips":
			txt = "Gameplay tips";
			break;
		case "tutorial":
			txt = "Tutorial";
	}
	return txt;
}

// Constructors, serializers, etc.
Scroll.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};

Scroll.prototype.clone = function () {
	return (new Scroll())._init(this);
};

Scroll.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Scroll())._init($ReviveData$)', ownData);
};
////////// BATTLE SCENE ACTIONS //////////

// Auxiliars //
window.evasionResults = function(hit,explanation) {
	this.hit = hit; // True or false
	this.explanation = explanation; // Text description with brief calculations
}
window.calculateEvasion = function(actionType,attacker,target,positiveVariables,negativeVariables) {
	var hit = false;
	
	switch ( actionType ) {
		case "pounce":
			if ( gC(target).control == 0 ) {
				hit = true;
				var explanation = "Target has no control left. Pounce succeeds!";
			}
			else {
				positiveVariables += gC(attacker).combatAffinities.pounce.strength - gC(attacker).combatAffinities.pounce.frailty;
				negativeVariables += gC(target).combatAffinities.pounce.resistance - gC(target).combatAffinities.pounce.weakness;
			}
			break;
		case "contact":
			if ( areCharactersPositionsConnected(attacker,target) ) {
				hit = true;
				var explanation = "Target is at contact distance. Contact succeds!";
			}
			break;
		case "trance":
			if ( areCharactersPositionsConnected(attacker,target) ) {
				hit = true;
				var explanation = "Target is entranced. Action succeds!";
			}
			break;
		case "hit":
			if ( areCharactersPositionsConnected(attacker,target) ) {
				positiveVariables += 20;
			}
			break;
		case "projectile":
			if ( areCharactersPositionsConnected(attacker,target) ) {
				negativeVariables += 20;
			}
			break;
		case "sound":
			break;
		case "vision":
			break;
		case "social":
			positiveVariables += 10;
			positiveVariables += (gC(attacker).combatAffinities.social.strength - gC(attacker).combatAffinities.social.frailty) / 2;
			negativeVariables += (gC(target).combatAffinities.social.resistance - gC(target).combatAffinities.social.weakness) / 2;
			break;
	}
	
	if ( hit == false ) {
		var dice = luckedDiceThrow((gC(attacker).luck.getValue() - gC(target).luck.getValue()) * 0.5 ) * 100;
		var total = dice + positiveVariables - negativeVariables;
		
		if ( ( total ) >= 50 ) {
			hit = true;
		}
		var explanation = "Evasion: ( Dice: " + dice.toFixed(1) + ", PV: " + positiveVariables.toFixed(1) + ", NV: " + negativeVariables.toFixed(1)
						+ " ) => " + total.toFixed(1);
						
		if ( hit ) { explanation += " > 50 => HIT"; }
		else { explanation += " < 50 => EVADED"; }
	}
	
	return (new evasionResults(hit,explanation));
}
window.attackResults = function(resultValue,explanations) {
	this.resultValue = resultValue;
	this.explanations = explanations;
}
window.calculateAttackEffects = function(attackType,actor,target,attackFlavors,initialValue) {
	var total = initialValue;
	var powerUp = 0;
	var powerDown = 0;
	for ( var flavor of attackFlavors ) {
		powerUp += gC(actor).combatAffinities[flavor].strength + gC(target).combatAffinities[flavor].weakness;
		powerDown += gC(actor).combatAffinities[flavor].frailty + gC(target).combatAffinities[flavor].resistance;
	}
	var total = initialValue * (( 1 + ( powerUp * 0.01 ) ) / ( 1 + powerDown * 0.01 ));
	if ( total < 0 ) { total = 0; }
	return total;
}

window.getWeaknessToAttackText = function(attackFlavors,target) {
	var weaknessMessage = "";
	var finalWeakness = 1.0;
	var powerUp = 0;
	var powerDown = 0;
	for ( var flavor of attackFlavors ) {
		powerUp += gC(target).combatAffinities[flavor].weakness;
		powerDown += gC(target).combatAffinities[flavor].resistance;
	}
	finalWeakness = 1.0 * (1 + ( powerUp * 0.01) ) / ( 1 + powerDown * 0.01 );
	if ( finalWeakness <= 0.65 ) {
		weaknessMessage = colorText("Frail attack. ","lightcyan");
	} else if ( finalWeakness <= 0.9 ) {
		weaknessMessage = colorText("Resisted attack. ","deepskyblue");
	} else if ( finalWeakness >= 1.5 ) {
		weaknessMessage = colorText("Devastating! ","orangered");
	} else if ( finalWeakness >= 1.1 ) {
		weaknessMessage = colorText("It was effective! ","darkorange");
	}
	
	return weaknessMessage;
}

// Actions //
window.createSaStruggle = function() {
	var sa = new sceneAction();
	sa.name = "Struggle";
	sa.key = "struggle";
	sa.actionType = "struggle";
	
	sa.targetType = "single";
	
	sa.tags.push("bs","sUse");
	sa.reqTags.push("diffTarget","struggle");
	
	sa.strategyTags.push("struggle");
	
	sa.description = "The character thrashes against their target to get off the ground.\n"
				   + "This attack damages the target's control. If it reaches zero, the character will be freed.\n"
				   + "\n\nStruggle."
				   + "\n\n__Influences__:\nControl damage: Proportion between actor's and target's physique, agility, resilience and will."
				   + "\nTarget's energy %, target's willpower %, target's arms state, target's legs state.";
	
	sa.doesHitLand = function(actor,target) {
		return new evasionResults(true,"");
	}
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = gC(actor).position.initiator;
		
		var flagGotOut = false;
		
		///// No evasion /////
		// Damage
		var inDamValue = ( 100 + gCstat(actor,"physique") + gCstat(actor,"agility") + gCstat(actor,"resilience") + gCstat(actor,"will") ) * 1.8
					   / ( 100 + gCstat(target,"physique") + gCstat(target,"agility") + gCstat(target,"resilience") + gCstat(target,"will") );
		inDamValue = inDamValue * ( ( 2 + getBarPercentage(actor,"energy") + getBarPercentage(actor,"willpower") ) / 4);
		if ( gC(actor).body.hasOwnProperty("arms") ) {
			if ( gC(actor).body.arms.state != "free" ) { inDamValue *= 0.8; }
		}
		if ( gC(actor).body.hasOwnProperty("legs") ) {
			if ( gC(actor).body.legs.state != "free" ) { inDamValue *= 0.8; }
		}
		var controlDamage = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
		if ( controlDamage < 0.8 ) { controlDamage = 0.8; }
		// Apply
		attackControl(target,controlDamage);
		if ( gC(target).control <= 0 ) {
			// Cancel position
			State.variables.sc.cancelPosition(target);
			// Actor recovers control
			gC(actor).lostControlTurns = 0;
			gainControlBack(actor);
			// Change description
			flagGotOut = true;
		}
		results.value = controlDamage;
		
		if ( flagGotOut ) {
			results.description += randomFromList( [
										(ktn(actor) + " pushed " + ktn(target) + " back!"),
										(ktn(actor) + " attacked " + ktn(target) + " and got free!"),
										(ktn(actor) + " managed to get free!")
									] );
		} else {
			results.description += randomFromList( [
										(ktn(actor) + " is fighting to leave " + ktn(target) + "'s clutches!"),
										(ktn(actor) + " struggles to get free!"),
										(ktn(actor) + " trashes back against " + ktn(target) + "!")
									] );
		}
		results.description += " " + ktn(target) + " received " + controlDamage.toFixed(1) + " control damage.";		
		
		return results;
	}
	return sa;
}

	// Basic sexual
	
window.createSaBaKissLips = function() {
	var sa = new sceneAction();
	sa.name = "Kiss lips";
	sa.key = "baKissLips";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.actorBpReqs.push("mouth");
	sa.targetBpReqs.push("mouth");
	
	sa.strategyTags.push("damage","sex","useMouth","targetMouth");
	sa.affinities.push("sex","useMouth","targetMouth");
	
	sa.description = "The character holds their target's head and kisses them.\n"
				   + "This attack damages the target.\n\nSingle target action."
				   + "\n\nInfluenced by agility and perception."
				   + "\n\nSexual contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's agility."
				   + "\nEvasion: Actor's agility x5, actor's perception x5, actor's control.\nTarget's agility x7, target's perception x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.25 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"agility") * 0.35 + gCstat(target,"perception") * 0.35 + gC(target).control * 4 + 10;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"agility") * 0.40;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			gC(target).lust.attack(-damage);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " kissed " + ktn(target) + "'s lips."),
										(ktn(actor) + " placed " + gC(actor).posPr + " own lips on " + ktn(target) + "'s."),
										(ktn(actor) + " tempted " + ktn(target) + "'s lips with " + gC(actor).posPr + " own.")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to kiss " + ktn(target) + ", but failed!\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaBaStrokeDick = function() {
	var sa = new sceneAction();
	sa.name = "Handjob";
	sa.key = "baStrokeDick";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.actorBpReqs.push("arms");
	sa.targetBpReqs.push("dick");
	
	sa.strategyTags.push("damage","sex","useArms","targetDick");
	sa.affinities.push("sex","useArms","targetDick");
	
	sa.description = "The character massages a dick.\n"
				   + "This attack damages the target.\n\nSingle target action."
				   + "\n\nSexual contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's agility."
				   + "\nEvasion: Actor's agility x5, actor's perception x5, actor's control.\nTarget's agility x7, target's perception x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.25 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"agility") * 0.35 + gCstat(target,"perception") * 0.35 + gC(target).control * 4 + 20;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"agility") * 0.5;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			gC(target).lust.attack(-damage);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " stroked " + ktn(target) + "'s " + dickWord() + "."),
										(ktn(actor) + " massaged " + ktn(target) + "'s " + dickWord() + "."),
										(ktn(actor) + " masturbated " + ktn(target) + "'s " + dickWord() + ".")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to stroke " + ktn(target) + ", but failed!\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaBaStrokePussy = function() {
	var sa = new sceneAction();
	sa.name = "Stroke pussy";
	sa.key = "baStrokePussy";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.actorBpReqs.push("arms");
	sa.targetBpReqs.push("pussy");
	
	sa.strategyTags.push("damage","sex","useArms","targetPussy");
	sa.affinities.push("sex","useArms","targetPussy");
	
	sa.description = "The character strokes a pussy.\n"
				   + "This attack damages the target.\n\nSingle target action."
				   + "\n\nSexual contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's agility."
				   + "\nEvasion: Actor's agility x5, actor's perception x5, actor's control.\nTarget's agility x7, target's perception x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.25 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"agility") * 0.35 + gCstat(target,"perception") * 0.35 + gC(target).control * 4 + 20;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"agility") * 0.5;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			gC(target).lust.attack(-damage);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " stroked " + ktn(target) + "'s " + pussyWord() + "."),
										(ktn(actor) + " caressed " + ktn(target) + "'s " + pussyWord() + "."),
										(ktn(actor) + " masturbated " + ktn(target) + "'s " + pussyWord() + ".")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to stroke " + ktn(target) + ", but failed!\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

		// Denial

window.createSaBaTeaseLockedDick = function() {
	var sa = new sceneAction();
	sa.name = "Tease locked dick";
	sa.key = "baTeaseLockedDick";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.actorBpReqs.push("arms");
	sa.targetLockedBpReqs.push("dick");
	
	sa.strategyTags.push("damage","sex","useArms","targetDick");
	sa.affinities.push("sex","useArms","targetDick");
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		
		if ( State.variables.settings.chastity == "disable" ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	
	sa.description = "The character taunts their target, reminding them of their locked dick.\n"
				   + "This attack damages the target. Extra damage if the target is close to orgasm.\n\nSingle target action."
				   + "\n\nSexual contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's agility."
				   + "\nEvasion: Actor's agility x5, actor's perception x5, actor's control.\nTarget's agility x7, target's perception x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.25 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"agility") * 0.35 + gCstat(target,"perception") * 0.35 + gC(target).control * 4 + 20;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"agility") * 0.5 + gCstat(actor,"empathy") * 0.5;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			gC(target).lust.attack(-damage);
			results.value = damage;
			var lustPc = getBarPercentage(target,"lust");
			// Description && limit KO
			results.description += randomFromList( [
										(ktn(actor) + " teased " + ktn(target) + "'s locked " + dickWord() + ", much to " + gC(target).posPr + " frustration."),
										(ktn(actor) + " massaged " + ktn(target) + "'s locked " + dickWord() + " causing " + gC(target).comPr + " some agony."),
										(ktn(actor) + " maliciously rubbed " + ktn(target) + "'s locked " + dickWord() + ".")
									] );
			var extraDamage = 0;
			if ( lustPc <= 0.1 ) {
				extraDamage = gC(target).lust.max;
				gC(target).lust.attack(-extraDamage);
				results.description += " " + randomFromList( [
										(ktn(target) + " gave in to the humilliation."),
										(ktn(target) + " couldn't hold the shame.")
									] );
			}
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage + extraDamage) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to tease " + ktn(target) + ", but failed!\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaBaTeaseLockedPussy = function() {
	var sa = new sceneAction();
	sa.name = "Tease locked pussy";
	sa.key = "baTeaseLockedPussy";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.actorBpReqs.push("arms");
	sa.targetLockedBpReqs.push("pussy");
	
	sa.strategyTags.push("damage","sex","useArms","targetPussy");
	sa.affinities.push("sex","useArms","targetPussy");
	
	sa.getIsAllowedBySettings = function() {
		var isAllowed = true;
		
		if ( State.variables.settings.chastity == "disable" ) {
			isAllowed = false;
		}
		
		return isAllowed;
	}
	
	sa.description = "The character taunts their target, reminding them of their locked pussy.\n"
				   + "This attack damages the target. Extra damage if the target is close to orgasm.\n\nSingle target action."
				   + "\n\nSexual contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's agility."
				   + "\nEvasion: Actor's agility x5, actor's perception x5, actor's control.\nTarget's agility x7, target's perception x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.25 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"agility") * 0.35 + gCstat(target,"perception") * 0.35 + gC(target).control * 4 + 20;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"agility") * 0.5 + gCstat(actor,"empathy") * 0.5;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			gC(target).lust.attack(-damage);
			results.value = damage;
			var lustPc = getBarPercentage(target,"lust");
			// Description && limit KO
			results.description += randomFromList( [
										(ktn(actor) + " teased " + ktn(target) + "'s locked " + pussyWord() + ", much to " + gC(target).posPr + " frustration."),
										(ktn(actor) + " massaged " + ktn(target) + "'s locked " + pussyWord() + " causing " + gC(target).comPr + " some agony."),
										(ktn(actor) + " maliciously rubbed " + ktn(target) + "'s locked " + pussyWord() + ".")
									] );
			var extraDamage = 0;
			if ( lustPc <= 0.1 ) {
				extraDamage = gC(target).lust.max;
				gC(target).lust.attack(-extraDamage);
				results.description += " " + randomFromList( [
										(ktn(target) + " gave in to the humilliation."),
										(ktn(target) + " couldn't hold the shame.")
									] );
			}
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage + extraDamage) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to tease " + ktn(target) + ", but failed!\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

	// Pounces and derived sexual

window.createSaNeutralFrontalPounce = function() {
	var sa = new sceneAction();
	sa.name = "Frontal Pounce";
	sa.key = "pounceFrontal";
	
	sa.actionType = "pounce";
	sa.targetType = "single";
	sa.energyCost = 5;
	
	sa.tags.push("bs","bPos");
	sa.reqTags.push("diffTarget","control");
	sa.actorBpReqs.push("legs");
	
	sa.strategyTags.push("pounce","bPos","frontal","subpar");
	sa.affinities.push("pounce","useDick","targetPussy");
	
	sa.description = "The character pushes their target to the ground, taking the initiative.\n"
				   + "Costs 5 energy.\n\nSingle target action."
				   + "\nActor requires control and free legs."
				   + "\n\nPounce attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1."
				   + "\nEvasion: Actor's agility x5, actor's physique x5, actor's control.\nTarget's agility x7, target's physique x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"physique") * 0.25 + gCstat(actor,"agility") * 0.25 + gC(actor).control * 5;
		var evasionMinus = gCstat(target,"physique") * 0.35 + gCstat(target,"agility") * 0.35 + gC(target).control * 15;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Initial damage
			var inDamValue = gCstat(actor,"physique") * 0.3 + gCstat(actor,"agility") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			gC(target).lust.attack(-damage);
			depleteControl(target);
			results.value = damage;
			
			// Position
			createBposFrontalPounce(actor,[target]);
				
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " pushed " + ktn(target) + " to the ground and started holding " + gC(target).comPr + " in place."),
										(ktn(actor) + " pounced on " + ktn(target) + " and mounted " + gC(target).comPr + "."),
										(ktn(actor) + " jumped on " + ktn(target) + " and trapped " + gC(target).comPr + " " + gC(target).refPr + ".")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to pounce on " + ktn(target) + ", but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaD2PfrontalPounce = function() {
	var sa = new sceneAction();
	sa.name = "Frontal Pounce D2P";
	sa.key = "pounceFrontalD2P";
	
	sa.actionType = "pounce";
	sa.targetType = "single";
	sa.energyCost = 5;
	
	sa.tags.push("bs","bPos");
	sa.reqTags.push("diffTarget","control");
	sa.actorBpReqs.push("legs","dick");
	sa.targetBpReqs.push("pussy");
	
	sa.strategyTags.push("pounce","bPos","useDick","targetPussy","frontal");
	sa.affinities.push("sex","pounce","useDick","targetPussy");
	
	sa.description = "The character pushes their target to the ground and initiates vaginal penetration.\n"
				   + "Costs 5 energy.\n\nSingle target action."
				   + "\nActor requires control and free legs and dick, target requires free pussy."
				   + "\n\nPounce attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1.\nContinued damage and self damage: Actor's and target's physique x1, actor's and target's resilience x1."
				   + "\nEvasion: Actor's agility x5, actor's physique x5, actor's control.\nTarget's agility x7, target's physique x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"physique") * 0.25 + gCstat(actor,"agility") * 0.25 + gC(actor).control * 5;
		var evasionMinus = gCstat(target,"physique") * 0.35 + gCstat(target,"agility") * 0.35 + gC(target).control * 15;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Initial damage
			var inDamValue = gCstat(actor,"physique") * 0.3 + gCstat(actor,"agility") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			gC(target).lust.attack(-damage);
			depleteControl(target);
			results.value = damage;
			
			// Position
			createBposDP2frontalPounce(actor,[target]);
				
			// Try virginities
			if ( gC(target).virginities.pussy.taken == false ) {
				var vd2 = colorText((gC(actor).name + " has taken " + gC(target).name + "'s vaginal virginity! "),"red") + provokeVirginityBonusRelationship(actor,target);
				gC(target).virginities.pussy.tryTakeVirginity(actor,"pounceFrontalD2P",vd2);
			}
			if ( gC(actor).virginities.dick.taken == false ) {
				var vd1 = colorText((gC(target).name + " has taken " + gC(actor).name + "'s penile virginity! "),"red") + provokeVirginityBonusRelationship(target,actor);
				gC(actor).virginities.dick.tryTakeVirginity(target,"pounceFrontalD2P",vd1);
			}			
				
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " pushed " + ktn(target) + " to the ground and started fucking " + gC(target).posPr + " " + pussyWord() + "."),
										(ktn(actor) + " pounced on " + ktn(target) + " and mounted " + gC(target).comPr + "."),
										(ktn(actor) + " jumped on " + ktn(target) + " and penetrated " + gC(target).comPr + ".")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to pounce on " + ktn(target) + ", but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaBaThrust = function() {
	var sa = new sceneAction();
	sa.name = "Thrust";
	sa.key = "baThrust";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("baPenetratePussy");
	
	sa.strategyTags.push("damage","sex","useDick","targetPussy");
	sa.affinities.push("sex","useDick","targetPussy");
	
	sa.description = "The character pushes their cock into their target's folds. Actor and target must already be connected.\n"
				   + "This attack damages the target, and the actor receives some retaliation.\n\nSingle target action."
				   + "\n\nSexual contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1, target's resilience x-1.\nSelf damage: Target's physique x1, target's agility x1, actor's resilience x-1.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = 1;
		var evasionMinus = 1;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"physique") * 0.6 + gCstat(actor,"agility") * 0.2 - gCstat(target,"resilience") * 0.2;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Retaliation
			var altAffinities = [ "sex","usePussy","targetDick" ];
			var inDamValue2 = gCstat(target,"physique") * 0.1 + gCstat(target,"agility") * 0.1 - gCstat(actor,"resilience") * 0.1;
			inDamValue2 = addLuckFactor(inDamValue2,0.1,gCstat(target,"luck"));
			var damage2 = calculateAttackEffects("lust",target,actor,altAffinities,inDamValue2);			
			// Apply
			gC(target).lust.attack(-damage);
			gC(actor).lust.attack(-damage2);
			results.value = damage;
			// Description
			results.description += randomFromList( [
									(ktn(actor) + " pushed " + gC(actor).posPr + " " + dickWord() + " deep into " + ktn(target) + "."),
									(ktn(actor) + " thrusted into " + ktn(target) + "."),
									(ktn(actor) + " penetrated " + ktn(target) + "'s " + randomFromList(["insides","pussy"]) + ".")
								] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + ktn(actor) + " received " + textLustDamage(damage2)
								 + " in retaliation.\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't happen.";
		}
		
		return results;
	}
	return sa;
}

window.createSaBaPushHipsBack = function() {
	var sa = new sceneAction();
	sa.name = "Push hips back";
	sa.key = "baPushHipsBack";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredPassiveCAs.push("baPenetratePussy");
	
	sa.strategyTags.push("damage","sex","usePussy","targetDick");
	sa.affinities.push("sex","usePussy","targetDick");
	
	sa.description = "The character pushes their hips back against someone else's dick. Target must already be penetrating the actor.\n"
				   + "This attack damages the target, and the actor receives some retaliation.\n\nSingle target action."
				   + "\n\nInfluenced by physique, agility and resilience."
				   + "\n\nSexual contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x4, actor's agility x1, target's resilience x-1.\nSelf damage: Target's physique x1, target's agility x1, actor's resilience x-1.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = 1;
		var evasionMinus = 1;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"physique") * 0.4 + gCstat(actor,"agility") * 0.1 - gCstat(target,"resilience") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Retaliation
			var altAffinities = [ "sex","useDick","targetPussy" ];
			var inDamValue2 = gCstat(target,"physique") * 0.1 + gCstat(target,"agility") * 0.1 - gCstat(actor,"resilience") * 0.1;
			inDamValue2 = addLuckFactor(inDamValue2,0.1,gCstat(target,"luck"));
			var damage2 = calculateAttackEffects("lust",target,actor,altAffinities,inDamValue2);			
			// Apply
			gC(target).lust.attack(-damage);
			gC(actor).lust.attack(-damage2);
			results.value = damage;
			// Description
			results.description += randomFromList( [
								(ktn(actor) + " pressed " + gC(actor).posPr + " hips back against " + ktn(target)
								+ ", getting impaled in " + gC(target).posPr + " their " + dickWord() + "."),
								(ktn(actor) + " pushed " + gC(actor).posPr + " " + pussyWord() + " hard against  "
								+ ktn(target) + "'s " + dickWord() + ".")
								] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + ktn(actor) + " received " + textLustDamage(damage2)
								 + " in retaliation.\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't happen.";
		}
		
		return results;
	}
	return sa;
}

window.createSaP2PfrontalPounce = function() {
	var sa = new sceneAction();
	sa.name = "Frontal Pounce P2P";
	sa.key = "pounceFrontalP2P";
	
	sa.actionType = "pounce";
	sa.targetType = "single";
	sa.energyCost = 5;
	
	sa.tags.push("bs","bPos");
	sa.reqTags.push("diffTarget","control");
	sa.actorBpReqs.push("legs","pussy");
	sa.targetBpReqs.push("pussy");
	
	sa.strategyTags.push("pounce","bPos","usePussy","targetPussy","frontal");
	sa.affinities.push("sex","pounce","usePussy","targetPussy");
	
	sa.description = "The character pushes their target to the ground and initiates scissoring.\n"
				   + "Costs 5 energy.\n\nSingle target action."
				   + "\nActor requires control and free legs and pussy, target requires free pussy."
				   + "\n\nPounce attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1.\nContinued damage and self damage: Actor's and target's physique x1, actor's and target's resilience x1."
				   + "\nEvasion: Actor's agility x5, actor's physique x5, actor's control.\nTarget's agility x7, target's physique x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"physique") * 0.25 + gCstat(actor,"agility") * 0.25 + gC(actor).control * 5;
		var evasionMinus = gCstat(target,"perception") * 0.35 + gCstat(target,"agility") * 0.35 + gC(target).control * 15;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Initial damage
			var inDamValue = gCstat(actor,"physique") * 0.3 + gCstat(actor,"agility") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			gC(target).lust.attack(-damage);
			depleteControl(target);
			results.value = damage;
			
			// Position
			createBposP2PfrontalPounce(actor,[target]);
				
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " pushed " + ktn(target) + " to the ground and started rubbing herself against " + gC(target).posPr
										+ " " + pussyWord() + "."),
										(ktn(actor) + " pounced on " + ktn(target) + " and began scissoring " + gC(target).comPr + ".")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to pounce on " + ktn(target) + ", but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaBaScissor = function() {
	var sa = new sceneAction();
	sa.name = "Scissor";
	sa.key = "baScissor";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("baScissoring");
	
	sa.strategyTags.push("damage","sex","usePussy","targetPussy");
	sa.affinities.push("sex","usePussy","targetPussy");
	
	sa.description = "The character rubs their intimate parts against their target's. Actor and target must already be scissoring.\n"
				   + "This attack damages the target, and the actor receives some retaliation.\n\nSingle target action."
				   + "\n\nSexual contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1, target's resilience x-1.\nSelf damage: Target's physique x1, target's agility x1, actor's resilience x-1.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = 1;
		var evasionMinus = 1;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"physique") * 0.6 + gCstat(actor,"agility") * 0.2 - gCstat(target,"resilience") * 0.2;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Retaliation
			var altAffinities = [ "sex","usePussy","targetPussy" ];
			var inDamValue2 = gCstat(target,"physique") * 0.1 + gCstat(target,"agility") * 0.1 - gCstat(actor,"resilience") * 0.1;
			inDamValue2 = addLuckFactor(inDamValue2,0.1,gCstat(target,"luck"));
			var damage2 = calculateAttackEffects("lust",target,actor,altAffinities,inDamValue2);			
			// Apply
			gC(target).lust.attack(-damage);
			gC(actor).lust.attack(-damage2);
			results.value = damage;
			// Description
			results.description += randomFromList( [
									(ktn(actor) + " frotted " + gC(actor).posPr + " own " + pussyWord() + " against " + ktn(target) + "'s."),
									(ktn(actor) + " slid " + gC(actor).posPr + " groin through " + ktn(target) + "'s " + pussyWord() + ", seeking pleasure."),
									(ktn(actor) + " squeezed " + ktn(target) + "'s groin against " + gC(actor).posPr + " own " + pussyWord() + ".")
								] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + ktn(actor) + " received " + textLustDamage(damage2)
								 + " in retaliation.\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't happen.";
		}
		
		return results;
	}
	return sa;
}

window.createSaBaScissorBack = function() {
	var sa = new sceneAction();
	sa.name = "Scissor back";
	sa.key = "baScissorBack";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredPassiveCAs.push("baScissoring");
	
	sa.strategyTags.push("damage","sex","usePussy","targetPussy");
	sa.affinities.push("sex","usePussy","targetPussy");
	
	sa.description = "The character pushes their groin back against their target's in retaliation. Target and actor must be scissoring.\n"
				   + "This attack damages the target, and the actor receives some retaliation.\n\nSingle target action."
				   + "\n\nSexual contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1, target's resilience x-1.\nSelf damage: Target's physique x1, target's agility x1, actor's resilience x-1.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = 1;
		var evasionMinus = 1;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"physique") * 0.4 + gCstat(actor,"agility") * 0.1 - gCstat(target,"resilience") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Retaliation
			var altAffinities = [ "sex","usePussy","targetPussy" ];
			var inDamValue2 = gCstat(target,"physique") * 0.1 + gCstat(target,"agility") * 0.1 - gCstat(actor,"resilience") * 0.1;
			inDamValue2 = addLuckFactor(inDamValue2,0.1,gCstat(target,"luck"));
			var damage2 = calculateAttackEffects("lust",target,actor,altAffinities,inDamValue2);			
			// Apply
			gC(target).lust.attack(-damage);
			gC(actor).lust.attack(-damage2);
			results.value = damage;
			// Description
			results.description += randomFromList( [
								(ktn(actor) + " locked " + ktn(target) + " back with " + gC(actor).posPr + " own legs, and frotted " + gC(actor).refPr + " against " + gC(target).comPr + "."),
								(ktn(actor) + " rubbed " + gC(actor).posPr + " own " + pussyWord() + " against " + ktn(target) + ".")
							] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + ktn(actor) + " received " + textLustDamage(damage2)
								 + " in retaliation.\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't happen.";
		}
		
		return results;
	}
	return sa;
}


window.createSaP2DfrontalPounce = function() {
	var sa = new sceneAction();
	sa.name = "Frontal Pounce P2D";
	sa.key = "pounceFrontalP2D";
	
	sa.actionType = "pounce";
	sa.targetType = "single";
	sa.energyCost = 5;
	
	sa.tags.push("bs","bPos");
	sa.reqTags.push("diffTarget","control");
	sa.actorBpReqs.push("legs","pussy");
	sa.targetBpReqs.push("dick");
	
	sa.strategyTags.push("pounce","bPos","usePussy","targetDick","frontal");
	sa.affinities.push("sex","pounce","usePussy","targetDick");
	
	sa.description = "The character pushes their target to the ground and rides their target's dick.\n"
				   + "Costs 5 energy.\n\nSingle target action."
				   + "\nActor requires control and free legs and pussy, target requires free dick."
				   + "\n\nPounce attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1.\nContinued damage and self damage: Actor's and target's physique x1, actor's and target's resilience x1."
				   + "\nEvasion: Actor's agility x5, actor's physique x5, actor's control.\nTarget's agility x7, target's physique x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"physique") * 0.25 + gCstat(actor,"agility") * 0.25 + gC(actor).control * 5;
		var evasionMinus = gCstat(target,"perception") * 0.35 + gCstat(target,"agility") * 0.35 + gC(target).control * 15;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Initial damage
			var inDamValue = gCstat(actor,"physique") * 0.3 + gCstat(actor,"agility") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			applyBarDamage(target,"lust",-damage);
			results.value = damage;
			
			// Position
			createBposP2DfrontalPounce(actor,[target]);
				
			// Try virginities
			if ( gC(target).virginities.dick.taken == false ) {
				var vd2 = colorText((gC(actor).name + " has taken " + gC(target).name + "'s penile virginity! "),"red") + provokeVirginityBonusRelationship(actor,target);
				gC(target).virginities.dick.tryTakeVirginity(actor,"pounceFrontalP2D",vd2);
			}
			if ( gC(actor).virginities.pussy.taken == false ) {
				var vd1 = colorText((gC(target).name + " has taken " + gC(actor).name + "'s vaginal virginity! "),"red") + provokeVirginityBonusRelationship(target,actor);
				gC(actor).virginities.pussy.tryTakeVirginity(target,"pounceFrontalP2D",vd1);
			}			
				
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " pushed " + ktn(target) + " to the ground and began riding " + gC(target).posPr + " " + dickWord() + "."),
										(ktn(actor) + " jumped on " + ktn(target) + " and lowered " + gC(actor).refPr + " down " + gC(target).posPr + " " + dickWord() + "."),
										(ktn(actor) + " pounced on " + ktn(target) + ", who saw " + gC(target).posPr + " " + dickWord() + " being engulfed by " + ktn(actor) + "'s " + pussyWord() + ".")
										
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to pounce on " + ktn(target) + ", but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaBaRideDick = function() {
	var sa = new sceneAction();
	sa.name = "Ride dick";
	sa.key = "baRideDick";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("baRidingDick");
	
	sa.strategyTags.push("damage","sex","usePussy","targetDick");
	sa.affinities.push("sex","usePussy","targetDick");
	
	sa.description = "The character forces their target's dick within themself. The character must already be riding their target.\n"
				   + "This attack damages the target, and the actor receives some retaliation.\n\nSingle target action."
				   + "\n\nSexual contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1, target's resilience x-1.\nSelf damage: Target's physique x1, target's agility x1, actor's resilience x-1.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = 1;
		var evasionMinus = 1;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"physique") * 0.6 + gCstat(actor,"agility") * 0.2 - gCstat(target,"resilience") * 0.2;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Retaliation
			var altAffinities = [ "sex","usePussy","targetDick" ];
			var inDamValue2 = gCstat(target,"physique") * 0.1 + gCstat(target,"agility") * 0.1 - gCstat(actor,"resilience") * 0.1;
			inDamValue2 = addLuckFactor(inDamValue2,0.1,gCstat(target,"luck"));
			var damage2 = calculateAttackEffects("lust",target,actor,altAffinities,inDamValue2);			
			// Apply
			gC(target).lust.attack(-damage);
			gC(actor).lust.attack(-damage2);
			results.value = damage;
			// Description
			results.description += randomFromList( [
									(ktn(actor) + " moved up and down through " + ktn(target) + "'s " + dickWord()),
									(ktn(actor) + " pushed " + gC(actor).posPr + " butt down against " + ktn(target) + ", taking " + gC(target).posPr + " whole " + dickWord() + " in the process."),
									(ktn(actor) + "'s " + pussyWord() + " tightens on " + ktn(target) + "'s " + dickWord() + ", without giving it a pause to breathe.")
								] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + ktn(actor) + " received " + textLustDamage(damage2)
								 + " in retaliation.\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't happen.";
		}
		
		return results;
	}
	return sa;
}

window.createSaBaPushDickBack = function() {
	var sa = new sceneAction();
	sa.name = "Push dick back";
	sa.key = "baPushDickBack";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredPassiveCAs.push("baRidingDick");
	
	sa.strategyTags.push("damage","sex","useDick","targetPussy");
	sa.affinities.push("sex","useDick","targetPussy");
	
	sa.description = "The character pushes their dick back against their target's in retaliation. Target must be riding the character.\n"
				   + "This attack damages the target, and the actor receives some retaliation.\n\nSingle target action."
				   + "\n\nSexual contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x3, actor's agility x1, target's resilience x-1.\nSelf damage: Target's physique x1, target's agility x1, actor's resilience x-1.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = 1;
		var evasionMinus = 1;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"physique") * 0.4 + gCstat(actor,"agility") * 0.1 - gCstat(target,"resilience") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Retaliation
			var altAffinities = [ "sex","useDick","targetPussy" ];
			var inDamValue2 = gCstat(target,"physique") * 0.1 + gCstat(target,"agility") * 0.1 - gCstat(actor,"resilience") * 0.1;
			inDamValue2 = addLuckFactor(inDamValue2,0.1,gCstat(target,"luck"));
			var damage2 = calculateAttackEffects("lust",target,actor,altAffinities,inDamValue2);			
			// Apply
			applyBarDamage(target,"lust",-damage);
			//gC(target).lust.attack(-damage);
			applyBarDamage(actor,"lust",-damage2);
			//gC(actor).lust.attack(-damage2);
			results.value = damage;
			// Description
			results.description += randomFromList( [
								(ktn(actor) + " pushed " + gC(actor).posPr + " " + dickWord() + " back against " + ktn(target) + "'s folds."),
								(ktn(actor) + " penetrates " + ktn(target) + " in retaliation."),
								(ktn(actor) + " struggles to push " + gC(actor).refPr + " deep within " + ktn(target) + ".")
							] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + ktn(actor) + " received " + textLustDamage(damage2)
								 + " in retaliation.\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't happen.";
		}
		
		return results;
	}
	return sa;
}

	// Draining
	
window.createSaBaEnergyDrainingKiss = function() {
	var sa = new sceneAction();
	sa.name = "Energy Draining Kiss";
	sa.key = "baEnergyDrainingKiss";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.actorBpReqs.push("mouth");
	sa.targetBpReqs.push("mouth");
	
	sa.strategyTags.push("damage","sex","useMouth","targetMouth","drain","damageEnergy");
	sa.affinities.push("sex","useMouth","targetMouth","drain");
	
	sa.getIsCustomAllowed = function(actionKey,actorKey,targetsKeys,skipLinkedCheck) {
		var isAllowed = true;
		if ( gC(targetsKeys[0]).race == "monster" ) {
			isAllowed = false;
		}
		return isAllowed;
	}
	
	sa.description = "The character kisses their target and drains their energy.\n"
				   + "This attack damages the target and drains their energy.\nRequires both characters to have a free mouth. The target may not be a monster."
				   + "\n\nSingle target action."
				   + "\n\nSexual draining contact attack."
				   + "\n\n__Influences__:\nDrain damage, energy drain damage: Actor's agility x3, actor's empathy x2."
				   + "\nEvasion: Actor's agility x5, actor's perception x5, actor's control.\nTarget's agility x7, target's perception x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.25 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"agility") * 0.35 + gCstat(target,"perception") * 0.35 + gC(target).control * 4 + 10;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		if ( actor == "chPlayerCharacter" ) { addToStVarsList("monActUs"); } 
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"agility") * 0.15 + gCstat(actor,"empathy") * 0.10;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			
			var inEnergyDrain = gCstat(actor,"agility") * 0.15 + gCstat(actor,"empathy") * 0.10;
			inEnergyDrain = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var energyDrain = calculateAttackEffects("lust",actor,target,this.affinities,inEnergyDrain);
			// Apply
			applyBarDamage(target,"lust",-damage);
			// gC(target).lust.attack(-damage);
			results.value = damage;
			var overflowMsg = applyBarDamage(target,"energy",-energyDrain);
			// gC(target).energy.attack(-energyDrain);
			gC(actor).energy.changeValue(energyDrain);
			// Description
			
			if ( gC(actor).race != "monster" ) {
				results.description += randomFromList( [
										(ktn(actor) + " took " + ktn(target) + "'s lips, stealing " + gC(target).posPr + " energy."),
										(ktn(actor) + " placed " + gC(actor).posPr + " own lips on " + ktn(target) + "'s and sucked " + gC(target).posPr + " energy out."),
										(ktn(target) + " felt " + gC(target).posPr + " energy slipping away when " + ktn(actor) + " kissed her.")
									] );
			} else {
				results.description += randomFromList( [
										(ktn(actor) + " chewed " + gC(actor).posPr + " teeth on " + ktn(target) + " sucking " + gC(target).posPr + " energy away."),
										(ktn(target) + " feels " + gC(target).posPr + " energy leaving " + gC(target).posPr + ", as " + ktn(actor) + " is sucking it away.")
									] );
			}
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + ktn(actor) + " drained "
								 + textEnergyDamage(energyDrain) + " from " + ktn(target) + "." + overflowMsg
								 + "\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to kiss " + ktn(target) + ", but failed!\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}
 
window.createSaBaDrainingKiss = function() {
	var sa = new sceneAction();
	sa.name = "Draining Kiss";
	sa.key = "baDrainingKiss";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.actorBpReqs.push("mouth");
	sa.targetBpReqs.push("mouth");
	
	sa.strategyTags.push("damage","sex","useMouth","targetMouth","drain");
	sa.affinities.push("sex","useMouth","targetMouth","drain");
	
	sa.getIsCustomAllowed = function(actionKey,actorKey,targetsKeys,skipLinkedCheck) {
		var isAllowed = true;
		if ( gC(targetsKeys[0]).race == "monster" ) {
			isAllowed = false;
		}
		return isAllowed;
	}
	
	sa.description = "The character kisses their target and drains their focus.\n"
				   + "This attack damages the target and heals the user.\nRequires both characters to have a free mouth. The target may not be a monster."
				   + "\n\nSingle target action."
				   + "\n\nSexual draining contact attack."
				   + "\n\n__Influences__:\nDrain damage: Actor's agility x4, actor's empathy x3."
				   + "\nEvasion: Actor's agility x5, actor's perception x5, actor's control.\nTarget's agility x7, target's perception x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.25 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"agility") * 0.35 + gCstat(target,"perception") * 0.35 + gC(target).control * 4 + 10;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		if ( actor == "chPlayerCharacter" ) { addToStVarsList("monActUs"); }
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"agility") * 0.2 + gCstat(actor,"empathy") * 0.15;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			
			// Apply
			applyBarDamage(target,"lust",-damage);
			// gC(target).lust.attack(-damage);
			gC(actor).lust.changeValue(damage);
			results.value = damage;
			// Description
			if ( gC(actor).race != "monster" ) {
				results.description += randomFromList( [
										(ktn(actor) + " took " + ktn(target) + "'s lips, stealing " + gC(target).posPr + " focus."),
										(ktn(actor) + " placed " + gC(actor).posPr + " own lips on " + ktn(target) + "'s and sucked " + gC(target).posPr + " concentration out."),
										(ktn(target) + " felt " + gC(target).posPr + " focus slipping away when " + ktn(actor) + " kissed " + gC(target).comPr)
									] );
			} else {
				results.description += randomFromList( [
										(ktn(actor) + " sucked " + ktn(target) + "'s skin, stealing " + gC(target).posPr + " focus."),
										(ktn(target) + " felt " + gC(target).posPr + " aether slipping away when " + ktn(actor) + " attacked " + gC(target).comPr + " with " + gC(actor).posPr + " tongue.")
									] );
			}
			results.description += " " + dmgEffMsg + ktn(actor) + " drained " + textLustDamage(damage) + " from " + ktn(target)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to kiss " + ktn(target) + ", but failed!\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}


	// Physical

window.createTackle = function() {
	var sa = new sceneAction();
	sa.name = "Tackle";
	sa.key = "tackle";
	
	sa.actionType = "hit";
	sa.targetType = "single";
	sa.energyCost = 3; 
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget","control");
	
	sa.requiresFree = true;
	
	sa.strategyTags.push("damage","physical","consumeEnergy","physicalDamage","damageControl");
	sa.affinities.push("physical");
	
	sa.description = "The character charges with their whole body, attempting to use their weight to throw their target to the ground. Risky.\n"
				   + "This attack damages the target and their control if it lands, but damages the actor's control otherwise.\nCosts 3 energy.\n\nSingle target action."
				   + "Actor requires control."
				   + "\n\nPhysical hit attack."
				   + "\n\n__Influences__:\nDamage: Actor's resilience x6, actor's physique x3, actor's agility x2, target's resilience x-1, target's agility x-1."
				   + "\nEvasion: Target's agility x6, target's perception x4, actor's control.\nTarget's perception x5, target's agility 5, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.3 + gCstat(actor,"resilience") * 0.25 + gCstat(actor,"perception") * 0.2 + gC(actor).control * 10 + 10;
		var evasionMinus = gCstat(target,"perception") * 0.25 + gCstat(target,"agility") * 0.25 + gC(target).control * 10;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"physique") * 0.15 + gCstat(actor,"resilience") * 0.3 + gCstat(actor,"agility") * 0.1 - gCstat(target,"resilience") * 0.05 - gCstat(target,"agility") * 0.05;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Control damage
			var controlDamage = 1.75; // 1.75 ~ 2.6
			controlDamage += ((luckedDiceThrow(gCstat(actor,"luck")) * 0.04) + (gCstat(actor,"physique") * 0.002 + (gCstat(actor,"resilience") * 0.0025)));
			// Apply
			applyBarDamage(target,"lust",-damage);
			attackControl(target,controlDamage);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " threw " + gC(actor).refPr + " against " + ktn(target) + ", knocking " + gC(target).comPr + " down."),
										(ktn(target) + " is unable to stop the impact of " + ktn(actor) + "'s tackle, and loses " + gC(target).posPr + " balance."),
										(ktn(actor) + " charges with all " + gC(actor).posPr + " weight against " + ktn(target) + ", breaking " + gC(target).posPr + " posture.")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + " and " + controlDamage.toFixed(1)
								 + " control damage. " + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			var selfControlDamage = 0.7 - (luckedDiceThrow(gCstat(actor,"luck")) * 0.3);
			attackControl(actor,selfControlDamage);
			results.value = 0;
			results.description = ktn(actor) + " charged against " + ktn(target) + " and tried to tackle " + gC(target).comPr + " down, but failed! " + ktn(actor) + " received " + selfControlDamage.toFixed(1) + " control damage. " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaKick = function() {
	var sa = new sceneAction();
	sa.name = "Kick";
	sa.key = "kick";
	
	sa.actionType = "hit";
	sa.targetType = "single";
	sa.energyCost = 2;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget","control");
	sa.actorBpReqs.push("legs");
	
	sa.requiresFree = true;
	
	sa.strategyTags.push("damage","physical","consumeEnergy","physicalDamage","damageControl","useLegs");
	sa.affinities.push("physical","kick");
	
	sa.description = "The character focuses their energy on their leg and foot to land a hit on their target.\n"
				   + "This attack damages the target and erodes their control.\nCosts 2 energy.\n\nSingle target action."
				   + "Actor requires control and free legs."
				   + "\n\nPhysical hit attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x5, actor's resilience x3, target's resilience x-2."
				   + "\nEvasion: Actor's agility x5, actor's perception x5, actor's control.\nTarget's agility x7, target's perception x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.25 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"agility") * 0.35 + gCstat(target,"perception") * 0.35 + gC(target).control * 4;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"physique") * 0.25 + gCstat(actor,"resilience") * 0.15 - gCstat(target,"resilience") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Control damage
			var controlDamage = 1.6; // 1.6 ~ 2.6
			controlDamage += ((luckedDiceThrow(gCstat(actor,"luck")) * 0.05) + (gCstat(actor,"physique") * 0.005));
			// Apply
			applyBarDamage(target,"lust",-damage);
			attackControl(target,controlDamage);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " landed a clean kick on " + ktn(target) + "."),
										(ktn(actor) + " struck a kick on " + ktn(target) + "."),
										(ktn(actor) + "'s foot provoked some ugly damage against " + ktn(target) + ".")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + " and " + controlDamage.toFixed(1)
								 + " control damage. " + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to kick " + ktn(target) + ", but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaColdGuts = function() {
	var sa = new sceneAction();
	sa.name = "Cold guts";
	sa.key = "coldGuts";
	
	sa.actionType = "special";
	sa.targetType = "self";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	
	sa.actorDisabledByAs = [ "CoGu" ];
	
	sa.strategyTags.push("buff","physical","alteredState","buffResilience","buffPhysique","buffWillpower","buffResistanceSex");
	sa.affinities.push();
	
	sa.description = "The character focuses their inner energy to gain higher resistance against any trial.\n"
				   + "The action increases the actor's physique, resilience, willpower and resistance to sex actions.\n\nSelf targeted action."
				   + "\n\nPhysical special attack."
				   + "\n\n__Influences__:\nIntensity: Actor's physique x1, actor's resilience x1, actor's will x1."; 
				   
	sa.doesHitLand = function(actor,target) {
		return new evasionResults(true,"");
	}		   				   
	
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = actor;
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Altered State
			var inIntensity = (gCstat(actor,"physique") + gCstat(actor,"resilience") + gCstat(actor,"will")) * 0.05;
			var asIntensity = addLuckFactor(inIntensity,0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			var altState = createAScoldGuts(asIntensity);
			// Apply
			applyAlteredState([actor],altState);
			results.value = asIntensity;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " is concentrating in properly using " + gC(actor).posPr + " inner energy."),
										(ktn(actor) + " is now focused."),
										(ktn(actor) + " has cleared " + gC(actor).posPr + " mind and is now ready.")
									] );
			// results.description += " " + ktn(target) + " received " + textLustDamage(damage) + ". " + generateSaCostsText(this,actor)
			//					 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't ever happen. Please notify me.";
		}
		
		return results;
	}
	return sa;
}

window.createSaCatAspect = function() {
	var sa = new sceneAction();
	sa.name = "Cat aspect";
	sa.key = "catAspect";
	
	sa.actionType = "special";
	sa.targetType = "self";
	
	sa.energyCost = 2;
	sa.willpowerCost = 2;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	
	sa.requiredRace = [ "beastkin" ];
	sa.actorDisabledByAs = [ "CaAs" ];
	
	sa.strategyTags.push("buff","physical","alteredState","buffAgility","buffPerception","buffControlRecovery");
	sa.affinities.push();
	
	sa.description = "The character enters in contact with their feline self, increasing their capabilities.\n"
				   + "The action increases the actor's agility, perception, control recovery and pounce affinity.\n\nSelf targeted action."
				   + "\n\nPhysical special attack."
				   + "\n\n__Influences__:\nIntensity: Actor's agility x1, actor's will x1, actor's luck x1."; 
				   
	sa.doesHitLand = function(actor,target) {
		return new evasionResults(true,"");
	}		   				   
	
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = actor;
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Altered State
			var inIntensity = (gCstat(actor,"agility") * 3 + gCstat(actor,"will") + gCstat(actor,"luck")) / 30;
			var asIntensity = addLuckFactor(inIntensity,0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			var altState = createAScatAspect(asIntensity);
			// Apply
			applyAlteredState([actor],altState);
			results.value = asIntensity;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + "'s eyes have darkened, and " + gC(actor).posPr + " nails are looking sharper. " + ktn(actor) + " is turning into a Cat Aspect."),
										(ktn(actor) + " feels the Cat's nimbleness flow through " + gC(actor).posPr + " body.")
									] );
			 results.description += " " + generateSaCostsText(this,actor);
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't ever happen. Please notify me.";
		}
		
		return results;
	}
	return sa;
}

		// Pain
		
window.createSaBaScratch = function() {
	var sa = new sceneAction();
	sa.name = "Scratch";
	sa.key = "baScratch";
	
	sa.actionType = "contact";
	sa.targetType = "single";
	sa.energyCost = 3;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("arms");
	
	sa.strategyTags.push("damage","physical","consumeEnergy","painDamage","stackPain","useArms","debuff");
	sa.affinities.push("pain");
	
	sa.description = "The character cuts their target with their claws.\n"
				   + "This attack damages the target's lust and energy, erodes their agility, increases their energy cost and weakness to pain damage.\nCosts 1 energy.\n\nSingle target action."
				   + "Actor requires free arms."
				   + "\n\nPain contact attack."
				   + "\n\n__Influences__:\nDamage, energy damage: Actor's agility x4, actor's physique x2, target's agility x-1, target's resilience x-1.\nEvasion: Actor's agility x7, actor's perception x5, target's agility x-5, target's perception x-5, actor's and target's control."; 
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.35 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"agility") * 0.25 + gCstat(target,"perception") * 0.25 + gC(target).control * 4;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   				   		
		
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"physique") * 0.08 + gCstat(actor,"agility") * 0.16 - gCstat(target,"agility") * 0.04 - gCstat(target,"resilience") * 0.04;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var inDamValue2 = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var damage2 = calculateAttackEffects("energy",actor,target,this.affinities,inDamValue2);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Altered state
			var asIntensity = addLuckFactor((gCstat(actor,"agility") * 0.06 + gCstat(actor,"perception") * 0.09),0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			var altState = createASscratched(asIntensity);
			// Apply
			applyBarDamage(target,"lust",-damage);
			applyBarDamage(target,"energy",-damage2);
			applyAlteredState([target],altState);
			results.value = damage;
			
			// Description
			results.description += randomFromList( [
										(ktn(actor) + "'s claws marked " + ktn(target) + "'s skin."),
										(ktn(actor) + " pierced " + ktn(target) + " with " + gC(actor).posPr + " claws."),
										(ktn(actor) + " scratched " + ktn(target) + ".")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + " and " + textEnergyDamage(damage2) + ". " + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to scratch " + ktn(target) + ", but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}


	// Magic
window.createHolyBlast = function() {
	var sa = new sceneAction();
	sa.name = "Holy Blast";
	sa.key = "holyBlast";
	
	sa.actionType = "projectile";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.getIsCustomAllowed = function(actionKey,actorKey,targetsKeys,skipLinkedCheck) {
		var isAllowed = true;
		if ( getBarPercentage(actorKey,"lust") <= 0.05 ) {
			isAllowed = false;
		}
		return isAllowed;
	}
	
	sa.strategyTags.push("damage","magic","holy");
	sa.affinities.push("magic","holy");
	
	sa.description = "The character sacrifices their energy to launch a blast of aether against their target.\n"
				   + "This attack damages the target, using the own actor's vitality.\nCosts 5% lust.\n\nSingle target action."
				   + "\n\nMagical holy projectile attack."
				   + "\n\n__Influences__:\nDamage: All stats of the actor.\nEvasion: All stats of the actor and the target, actor's and target's control."; 
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = quantifyCharacterStats(actor) * 0.2 + gC(actor).control * 3 + 15;
		var evasionMinus = quantifyCharacterStats(target) * 0.2 + gC(target).control * 2;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   				   
	
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = quantifyCharacterStats(actor) * 0.05;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			var fivePercentLust = gC(actor).lust.max * 0.05;
			// Apply
			applyBarDamage(target,"lust",-damage);
			gC(actor).lust.changeValue(-fivePercentLust);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " launched a blast of holy light against " + ktn(target) + ", burning " + gC(target).posPr + " skin."),
										(ktn(actor) + " sacrificed " + gC(actor).posPr + " vitality to the Goddess to cast retribution against " + ktn(target) + "."),
										(ktn(actor) + " casted divine punishment against " + ktn(target) + ", attacking " + gC(target).comPr + " with a holy blast.")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". "
								+ ktn(actor) + " sacrificed " + textLustDamage(fivePercentLust) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to cast divine punishment against " + ktn(target) + ", but the prayer went unanswered! "
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaEmbers = function() {
	var sa = new sceneAction();
	sa.name = "Embers";
	sa.key = "embers";
	
	sa.actionType = "projectile";
	sa.targetType = "single";
	sa.willpowerCost = 1;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.strategyTags.push("damage","magic","fire");
	sa.affinities.push("magic","fire");
	
	sa.description = "The character casts ignited dust and throws it against their target.\n"
				   + "This attack damages the target.\nCosts 1 willpower.\n\nSingle target action."
				   + "\n\nMagical fire projectile attack."
				   + "\n\n__Influences__:\nDamage: Actor's intelligence x2, actor's will x1, target's will x-1, target's resilience x-1.\nEvasion: Actor's intelligence x1, actor's perception x1, target's perception x-1, target's will x-1, actor's and target's control."; 
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"intelligence") * 0.25 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 2 + 15;
		var evasionMinus = gCstat(target,"will") * 0.25 + gCstat(target,"perception") * 0.25 + gC(target).control * 2;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   				   
	
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"intelligence") * 0.4 + gCstat(actor,"will") * 0.2 - gCstat(target,"will") * 0.2;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			applyBarDamage(target,"lust",-damage);
			// gC(target).lust.attack(-damage);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " threw burning dust against " + ktn(target) + "!"),
										(ktn(actor) + " casted ignited ashes and launched them towards " + ktn(target) + "."),
										(ktn(actor) + " burned " + ktn(target) + "'s skin with flying ashes.")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to burn " + ktn(target) + " with some embers, but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaFlamingFan = function() {
	var sa = new sceneAction();
	sa.name = "Flaming fan";
	sa.key = "flamingFan";
	
	sa.actionType = "projectile";
	sa.targetType = "group";
	sa.willpowerCost = 2;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.strategyTags.push("damage","magic","fire");
	sa.affinities.push("magic","fire");
	
	sa.description = "The character casts a wave of fire, dealing collateral damage to allies of the target.\n"
				   + "This attack damages the target and their allies. High chance of hitting.\nCosts 2 willpower.\n\nMultiple targets action."
				   + "\n\nMagical fire projectile attack."
				   + "\n\n__Influences__:\nDamage: Actor's intelligence x7, actor's will x4, target's will x-4, target's resilience x-1.\nEvasion: Actor's intelligence x4, actor's will x4, actor's perception x2, target's will x-5, target's perception x-5, actor's and target's control."; 
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"intelligence") * 0.2 + gCstat(actor,"perception") * 0.1 + gCstat(actor,"will") * 0.2 + gC(actor).control * 2 + 20;
		var evasionMinus = gCstat(target,"will") * 0.25 + gCstat(target,"perception") * 0.25 + gC(target).control * 2;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   				   
	
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			var colTargets = getCharsTeamMinusSelf(target);
			
			// Damage
			var inDamValue = gCstat(actor,"intelligence") * 0.35 + gCstat(actor,"will") * 0.2 - gCstat(target,"will") * 0.2;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			applyBarDamage(target,"lust",-damage);
			// gC(target).lust.attack(-damage);
			results.value = damage;
			// Description
			results.description += randomFromList( [
								("A fan of flames expands in front of " + ktn(actor) + ", scorching " + gC(actor).posPr + " enemies."),
								(ktn(actor) + " unleashes flames against " + ktn(target) + ", and they envolve everything around " + gC(target).comPr + "."),
								(ktn(actor) + "'s hands ignited the air in front of " + gC(actor).comPr + ", provoking a flare.")
							] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". "
			for ( var cT of colTargets ) {
				var cInDamValue = (gCstat(actor,"intelligence") * 0.35 + gCstat(actor,"will") * 0.2 - gCstat(cT,"will") * 0.2) * 0.3;
				cInDamValue = addLuckFactor(cInDamValue,0.1,gCstat(actor,"luck"));
				var colDamage = calculateAttackEffects("lust",actor,cT,this.affinities,cInDamValue);
				var dmgEffMsg = getWeaknessToAttackText(this.affinities,cT);
				applyBarDamage(cT,"lust",-colDamage);
				results.description += dmgEffMsg + ktn(cT) + " received " + textLustDamage(colDamage) + ". "
			}
			results.description += generateSaCostsText(this,actor) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to burn " + ktn(target) + " with some embers, but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaFreezeFeet = function() {
	var sa = new sceneAction();
	sa.name = "Freeze feet";
	sa.key = "freezeFeet";
	sa.actionType = "projectile";
	sa.targetType = "single";
	sa.willpowerCost = 3;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.strategyTags.push("debuff","damage","magic","ice","control","damageEnergy","damageControl","alteredState");
	sa.affinities.push("magic","ice");
	
	sa.description = "The character casts a frozen air stream aimed at their target's legs.\n"
				   + "This attack damages the target and reduces their energy, control and agility.\n\nSingle target action."
				   + "\n\nMagical ice projectile attack."
				   + "\n\n__Influences__:\nDamage: Actor's intelligence x2, actor's will x1, target's will x-1, target's resilience x-1.\nEnergy damage: Actor's intelligence x2, actor's will x1.\nEvasion: Actor's intelligence x7, actor's will x3, target's will x-10, actor's and target's control."; 
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"intelligence") * 0.35 + gCstat(actor,"will") * 0.15 + gC(actor).control * 2 + 15;
		var evasionMinus = gCstat(target,"will") * 0.5 + gC(target).control * 2;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"intelligence") * 0.2 + gCstat(actor,"will") * 0.1 - gCstat(target,"will") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Energy damage
			var inEnDamValue = gCstat(actor,"intelligence") * 0.1 + gCstat(actor,"will") * 0.05;
			inEnDamValue = addLuckFactor(inEnDamValue,0.1,gCstat(actor,"luck"));
			var energyDamage = calculateAttackEffects("energy",actor,target,this.affinities,inEnDamValue);
			// Control damage
			var controlDamage = 1; // 1 ~ 1.7
			controlDamage += ((luckedDiceThrow(gCstat(actor,"luck")) * 0.3) + (gCstat(actor,"intelligence") * 0.004));
			// Altered State
			var asIntensity = addLuckFactor((gCstat(actor,"intelligence") * 0.2),0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			var altState = createASfrozenFeet(asIntensity);
			// Apply
			applyBarDamage(target,"lust",-damage);
			var overflowMsg = applyBarDamage(target,"energy",-energyDamage);
			// gC(target).lust.attack(-damage);
			// gC(target).energy.attack(-energyDamage);
			attackControl(target,controlDamage);
			applyAlteredState([target],altState);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " casted a freezing dust against " + ktn(target) + "."),
										(ktn(actor) + " is sending frost air against " + ktn(target) + ".")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ", " + controlDamage.toFixed(1) + " control damage, and " + textEnergyDamage(energyDamage) + ". " + overflowMsg
								 + generateSaCostsText(this,actor) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to hit " + ktn(target) + "'s feet with cold winds, but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
		
	}
	return sa;
}

window.createSaSparkingRubbing = function() {
	var sa = new sceneAction();
	sa.name = "Sparking Rubbing";
	sa.key = "sparkingRubbing";
	sa.actionType = "contact";
	sa.targetType = "single";
	sa.willpowerCost = 2;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.strategyTags.push("debuff","damage","sex","magic","thunder","provokeWeaknessSex","alteredState");
	sa.affinities.push("sex","magic","thunder");
	
	sa.description = "The character rubs their target's erogenous zones with small electric shocks, increasing their sensitivity.\n"
				   + "This attack damages the target and increases their weakness against sex actions.\n\nSingle target action."
				   + "\n\nMagical thunder contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's intelligence x7, actor's agility x3, target's resilience x-2.\nEvasion: Actor's agility x5, actor's perception x5, target's agility x-7, target's perception x-7, actor's and target's control."; 
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.25 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"agility") * 0.35 + gCstat(target,"perception") * 0.35 + gC(target).control * 4 + 10;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"intelligence") * 0.35 + gCstat(actor,"agility") * 0.15 - gCstat(target,"resilience") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Altered State
			var asIntensity = addLuckFactor((gCstat(actor,"intelligence") * 0.1),0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			var altState = createASsensitizedGenitals(asIntensity);
			// Apply
			applyBarDamage(target,"lust",-damage);
			// gC(target).lust.attack(-damage);
			applyAlteredState([target],altState);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + "'s hands applied electric shocks against " + ktn(target) + " sensible zones."),
										(ktn(target) + " made a deaf scream when " + ktn(actor) + " touched " + gC(target).comPr + " with electrified hands."),
										(ktn(actor) + " massaged " + ktn(target) + "'s private parts and shocked them with magic.")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". "
								 + generateSaCostsText(this,actor) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to grab " + ktn(target) + " genitals, but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
		
	}
	return sa;
}

window.createSaLightningDarts = function() {
	var sa = new sceneAction();
	sa.name = "Lightning darts";
	sa.key = "lightningDarts";
	sa.actionType = "projectile";
	sa.targetType = "single";
	sa.willpowerCost = 3;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.strategyTags.push("damage","magic","thunder","control","damageEnergy","damageWillpower","damageControl");
	sa.affinities.push("magic","thunder");
	
	sa.description = "The character casts lightning rays, zapping their target and damaging their muscles.\n"
				   + "This attack damages the target's lust, energy, willpower and control.\n\nSingle target action."
				   + "\n\nMagical thunder projectile attack."
				   + "\n\n__Influences__:\nDamage: Actor's intelligence x14, actor's will x7, target's will x-10.\nEvasion: Actor's intelligence x7, actor's perception x3, target's will x-8, target's perception x-2, actor's and target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"intelligence") * 0.35 + gCstat(actor,"will") * 0.15 + gC(actor).control * 1 + 15;
		var evasionMinus = gCstat(target,"will") * 0.4 + gCstat(target,"perception") * 0.1 + gC(target).control * 1;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"intelligence") * 0.14 + gCstat(actor,"will") * 0.07 - gCstat(target,"will") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var inDamValue2 = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var inDamValue3 = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var energyDamage = calculateAttackEffects("energy",actor,target,this.affinities,inDamValue2);
			var willpowerDamage = calculateAttackEffects("willpower",actor,target,this.affinities,inDamValue3);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Control damage
			var controlDamage = 0.9; // 0.9 ~ 1.4
			controlDamage += ((luckedDiceThrow(gCstat(actor,"luck")) * 0.2) + (gCstat(actor,"intelligence") * 0.003));
			// Apply
			applyBarDamage(target,"lust",-damage);
			var overflowMsg = applyBarDamage(target,"energy",-energyDamage);
			var overflowMsg2 = applyBarDamage(target,"willpower",-willpowerDamage);
			attackControl(target,controlDamage);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " casted lightning darts against " + ktn(target) + ", interrupting " + gC(target).posPr + " plans."),
										(ktn(actor) + " conjured small thunders that flew from " + gC(actor).posPr + " hands straight to " + ktn(target) + "."),
										(ktn(target) + " was hit by " + ktn(actor) + "'s electric projectiles.")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ", " + controlDamage.toFixed(1) + " control damage. " + firstToCap(gC(target).perPr) + " also received " + textEnergyDamage(energyDamage) + ". " + overflowMsg + " " + firstToCap(gC(target).perPr) + " also received " + textWillpowerDamage(willpowerDamage) + ". " + overflowMsg2
								 + generateSaCostsText(this,actor) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to hit " + ktn(target) + "'s feet with lightning darts, but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
		
	}
	return sa;
}

window.createSaQuake = function() {
	var sa = new sceneAction();
	sa.name = "Quake";
	sa.key = "quake";
	
	sa.actionType = "projectile";
	sa.targetType = "group";
	sa.willpowerCost = 4;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.strategyTags.push("damage","magic","physical","damage","damageControl","group");
	sa.affinities.push("physical");
	
	sa.description = "The actor provokes a tremor on the ground, damaging the control of their enemies.\n"
				   + "This attack damages the all enemy targets and their control. High chance of hitting.\nCosts 4 willpower.\n\nMultiple targets action."
				   + "\n\nPhysical projectile attack."
				   + "\n\n__Influences__:\nDamage: Actor's resilience x6, actor's will x4, target's resilience x-3.\nEvasion: Actor's and target's resilience (x2), will (x2), perception (x1) and control."; 
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"resilience") * 0.2 + gCstat(actor,"perception") * 0.1 + gCstat(actor,"will") * 0.2 + gC(actor).control * 2 + 25;
		var evasionMinus = gCstat(target,"will") * 0.2 + gCstat(target,"resilience") * 0.2 + gCstat(target,"perception") * 0.1 + gC(target).control * 2;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   				   
	
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			var colTargets = getCharsTeamMinusSelf(target);
			
			// Damage
			var inDamValue = gCstat(actor,"resilience") * 0.3 + gCstat(actor,"will") * 0.2 - gCstat(target,"resilience") * 0.15;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Control damage
			var controlDamage = 1.4; // 1.4 ~ 2
			controlDamage += ((luckedDiceThrow(gCstat(actor,"luck")) * 0.02) + (gCstat(actor,"will") * 0.002 + (gCstat(actor,"resilience") * 0.002)));
			var controlDamage2 = controlDamage * 0.7;
			// Apply
			applyBarDamage(target,"lust",-damage);
			attackControl(target,controlDamage);
			results.value = damage;
			// Description
			results.description += randomFromList( [
								(ktn(actor) + " agitates the earth, provoking tremors among " + gC(actor).posPr + " foes' legs."),
								(ktn(actor) + " casts a quake against " + ktn(target) + ", damaging " + gC(target).posPr + " balance."),
								(ktn(actor) + " tears the floor's aether apart, provoking it to tremble.")
							] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + " and " + controlDamage.toFixed(1)
								 + " control damage. ";	
			for ( var cT of colTargets ) {
				var cInDamValue = (gCstat(actor,"resilience") * 0.3 + gCstat(actor,"will") * 0.2 - gCstat(cT,"resilience") * 0.15) * 0.3;
				cInDamValue = addLuckFactor(cInDamValue,0.1,gCstat(actor,"luck"));
				var colDamage = calculateAttackEffects("lust",actor,cT,this.affinities,cInDamValue);
				var dmgEffMsg = getWeaknessToAttackText(this.affinities,cT);
				applyBarDamage(cT,"lust",-colDamage);
			attackControl(cT,controlDamage2);
				results.description += dmgEffMsg + ktn(cT) + " received " + textLustDamage(colDamage) + " and " + controlDamage2.toFixed(1)
								 + " control damage. ";
			}
			results.description += generateSaCostsText(this,actor) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to provoke a quake against " + ktn(target) + ", but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

		// Mixed Physical-Magical
window.createFlaringFeint = function() {
	var sa = new sceneAction();
	sa.name = "Flaring Feint";
	sa.key = "flaringFeint";
	
	sa.actionType = "special";
	sa.targetType = "self";
	sa.willpowerCost = 2;
	sa.energyCost = 2;
	sa.priority = 3;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("control");
	
	sa.strategyTags.push("buff","magic","fire");
	sa.affinities.push("magic","fire");
	
	sa.description = "The actor ignites themself, charging their following attacks. Characters who enter in contact with the actor will be burnt.\n"
				   + "The action increases the agility, willpower, control recovery and fire strength of the character.\nCosts 2 willpower and 2 energy.\n\nSelf targeted action."
				   + "\n\nMagical special attack, increased priority."
				   + "\n\n__Influences__:\nIntensity: Actor's intelligence x3, actor's will x2, actor's agility x2."
				   + "\nDamage: Actor's intelligence x3, actor's will x2."; 
				   
	sa.doesHitLand = function(actor,target) {
		return new evasionResults(true,"");
	}		   				   
	
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = actor;
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Altered State
			var inIntensity = (gCstat(actor,"intelligence") * 3 + gCstat(actor,"will") * 2 + gCstat(actor,"agility") * 2) / 50;
			var asIntensity = addLuckFactor(inIntensity,0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			var altState = createASflaringFeint(asIntensity);
			// Apply
			applyAlteredState([actor],altState);
			results.value = asIntensity;
			
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " ignited " + gC(actor).refPr + " and jumped back, leaving a trail of ashes in " + gC(actor).posPr + " path."),
										(ktn(actor) + " spins in a ring of fire as " + gC(actor).perPr + " jumps away."),
										("Hungry flames bursted out of " + ktn(actor) + ", who is charging up " + gC(actor).posPr + " next attacks.")
									] );
			 results.description += " " + generateSaCostsText(this,actor);
			 
			 State.variables.sc.endRoundEffects.push(function() {
				var targets = [];
				var i = 0;
				for ( var t of State.variables.sc.teamAchosenTargets ) {
					if ( t == actor ) {
						if ( setup.saList[State.variables.sc.teamAchosenActions[i]].actionType == "contact" ||
							 setup.saList[State.variables.sc.teamAchosenActions[i]].actionType == "hit" || 
							 setup.saList[State.variables.sc.teamAchosenActions[i]].actionType == "pounce" ) {
							targets.push(State.variables.sc.teamAcharKeys[i]);
						}
					}
					i++;
				}
				i = 0;
				for ( var t of State.variables.sc.teamBchosenTargets ) {
					if ( t == actor ) {
						if ( setup.saList[State.variables.sc.teamBchosenActions[i]].actionType == "contact" ||
							 setup.saList[State.variables.sc.teamBchosenActions[i]].actionType == "hit" || 
							 setup.saList[State.variables.sc.teamBchosenActions[i]].actionType == "pounce" ) {
							targets.push(State.variables.sc.teamBcharKeys[i]);
						}
					}
					i++;
				}
				var damages = [];
				var msg = "";
				if ( targets.length > 0 ) {
					msg = ktn(actor) + "'s " + randomFromList(["flares","flames","fires"]) + " " + randomFromList(["lashed out against","burnt","hit"]) + " " + getCharKtns(targets) + " for ";
					var dmgsTxt = [];
					for ( var tar of targets ) {
						var inDamValue = (gCstat(actor,"intelligence") * 0.3 + gCstat(actor,"will") * 0.2) * 0.25;
						inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
						var damage = calculateAttackEffects("lust",actor,tar,["fire"],inDamValue);
						applyBarDamage(tar,"lust",-damage);
						damages.push(damage);
					}
					for ( var dmg of damages ) {
						dmgsTxt.push(colorText(dmg.toFixed(2),"lightcoral"));
					}
					msg += stringArrayToText(dmgsTxt) + colorText(" lust damage","lightcoral") + ".";
				}
				return msg;
			 });
			 
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't ever happen. Please notify me.";
		}
		
		return results;
	}
	return sa;
}

window.createEarthWall = function() {
	var sa = new sceneAction();
	sa.name = "Earth Wall";
	sa.key = "earthWall";
	
	sa.actionType = "special";
	sa.targetType = "self";
	sa.willpowerCost = 2;
	sa.priority = 3;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("control");
	
	sa.strategyTags.push("buff","physical");
	sa.affinities.push("physical");
	
	sa.description = "The actor builds earth walls with magic, protecting themself and their allies.\n"
				   + "For one turn, the whole team of the actor receives increased resilience and will, decreased perception, greatly increased pounce and physical resistances, slightly increased social and magical resistances.\nAdditionally, enemies using hit or pounce attacks will receive damage.\nCosts 2 willpower.\n\nSelf targeted action."
				   + "\n\nMagical special attack, increased priority."
				   + "\n\n__Influences__:\nIntensity: Actor's resilience x1, actor's will x1."
				   + "\nDamage: Actor's resilience x1, actor's will x1."; 
				   
	sa.doesHitLand = function(actor,target) {
		return new evasionResults(true,"");
	}		   				   
	
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = actor;
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Altered State
			var inIntensity = (gCstat(actor,"resilience") + gCstat(actor,"will")) / 13;
			var asIntensity = addLuckFactor(inIntensity,0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			var altState = createASearthWall(asIntensity);
			// Apply
			applyAlteredState(getCharsTeam(actor),altState);
			results.value = asIntensity;
			
			// Description
			results.description += randomFromList( [
								(ktn(actor) + " forces the earth to arise, protecting " + gC(actor).posPr + " allies."),
								("Earth walls arise from the ground in defense of " + ktn(actor) + " and " + gC(actor).posPr + " companions."),
								(ktn(actor) + " focuses " + gC(actor).posPr + " aether into dominating the ground, forcing it to rise in " + gC(actor).posPr + " defense.")
									] );
			 results.description += " " + generateSaCostsText(this,actor) + ".";
			 
			 State.variables.sc.endRoundEffects.push(function() {
				var targets = [];
				var i = 0;
				for ( var t of State.variables.sc.teamAchosenTargets ) {
					if ( getCharsTeam(actor).includes(t[0]) ) {
						if ( setup.saList[State.variables.sc.teamAchosenActions[i]].actionType == "hit" || 
							 setup.saList[State.variables.sc.teamAchosenActions[i]].actionType == "pounce" ) {
							targets.push(State.variables.sc.teamAcharKeys[i]);
						}
					}
					i++;
				}
				i = 0;
				for ( var t of State.variables.sc.teamBchosenTargets ) {
					if ( getCharsTeam(actor).includes(t[0]) ) {
						if ( setup.saList[State.variables.sc.teamBchosenActions[i]].actionType == "hit" || 
							 setup.saList[State.variables.sc.teamBchosenActions[i]].actionType == "pounce" ) {
							targets.push(State.variables.sc.teamBcharKeys[i]);
						}
					}
					i++;
				}
				var damages = [];
				var msg = "";
				if ( targets.length > 0 ) {
					msg = ktn(actor) + "'s walls get in the way of " + gC(actor).posPr + " enemies, and " + getCharKtns(targets) + " are hit for ";
					var dmgsTxt = [];
					for ( var tar of targets ) {
						var inDamValue = (gCstat(actor,"resilience") * 0.25 + gCstat(actor,"will") * 0.25) * 0.15;
						inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
						var damage = calculateAttackEffects("lust",actor,tar,["physical"],inDamValue);
						applyBarDamage(tar,"lust",-damage);
						damages.push(damage);
					}
					for ( var dmg of damages ) {
						dmgsTxt.push(colorText(dmg.toFixed(2),"lightcoral"));
					}
					msg += stringArrayToText(dmgsTxt) + colorText(" lust damage","lightcoral") + ".";
				}
				return msg;
			 });
			 
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't ever happen. Please notify me.";
		}
		
		return results;
	}
	return sa;
}

		// Bondage
		
window.createSaBaEtherealChains = function() {
	var sa = new sceneAction();
	sa.name = "Ethereal Chains";
	sa.key = "baEtherealChains";
	sa.actionType = "projectile";
	sa.targetType = "single";
	sa.willpowerCost = 4;
	
	sa.tags.push("bs","sUse");
	sa.reqTags.push("diffTarget","control");
	sa.targetBpReqs.push("arms");
	
	sa.strategyTags.push("magic","control","damageControl","alteredState","bondage");
	sa.affinities.push("magic");
	
	sa.description = "The character casts chains out of aether, and launches them against their target, aiming at locking their arms.\n"
				   + "Locks the enemy's arms, damages their control and reduces their physique and agility.\n"
				   + "Costs 4 willpower.\n\nSingle target action."
				   + "\nActor requires control. Target requires freed arms."
				   + "\n\nMagical projectile bondage attack."
				   + "\n\n__Influences__:\nControl damage: Actor's intelligence x7, actor's luck x%3.\nIntensity: Actor's intelligence x1.\nEvasion: Actor's intelligence x4, actor's will x3, actor's resilience x3, target's agility x-5, target's perception x-5, actor's and target's control."; 
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"intelligence") * 0.20 + gCstat(actor,"will") * 0.15 + gCstat(actor,"resilience") * 0.15 + gC(actor).control * 2 + 15;
		var evasionMinus = gCstat(target,"agility") * 0.25 + gCstat(target,"perception") * 0.25 + gC(target).control * 2;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		if ( actor == "chPlayerCharacter" ) { addToStVarsList("monActUs"); }
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Control damage
			var controlDamage = 1.6; // 1.6 ~ 2.4
			controlDamage += ((luckedDiceThrow(gCstat(actor,"luck")) * 0.2) + (gCstat(actor,"intelligence") * 0.006));
			
			// Altered State
			var asIntensity = addLuckFactor((gCstat(actor,"intelligence") * 0.1),0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			var altState = createASaetherialChainsArms(asIntensity);
			
			// Apply
			attackControl(target,controlDamage);
			applyAlteredState([target],altState);
			results.value = controlDamage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " casted chains out of aether, and launched them against " + ktn(target) + "."),
										(ktn(actor) + " conjured aetherial chains and attacked " + ktn(target) + "'s arms with them.")
									] );
			results.description += " " + ktn(target) + " received " + controlDamage.toFixed(1) + " control damage. " + ktn(target)
								 + "'s arms have been locked. "
								 + generateSaCostsText(this,actor) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to hit " + ktn(target) + " with aetherial chains, but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
		
	}
	return sa;
}

window.createSaBaVineArmLock = function() {
	var sa = new sceneAction();
	sa.name = "Vine Arm Lock";
	sa.key = "baVineArmLock";
	sa.actionType = "projectile";
	sa.targetType = "single";
	sa.willpowerCost = 5;
	
	sa.tags.push("bs","sUse");
	sa.reqTags.push("diffTarget","control");
	sa.targetBpReqs.push("arms");
	
	sa.strategyTags.push("control","damageControl","alteredState","bondage","debuff");
	sa.affinities.push("physical");
	
	sa.description = "The character hits their target with a vine whip, attempting to bind their arms with it.\n"
				   + "Locks the enemy's arms, damages their control, and reduces their agility and control recovery.\n"
				   + "Costs 5 willpower.\n\nSingle target action."
				   + "\nTarget requires freed arms."
				   + "\n\nPhysical projectile bondage attack."
				   + "\n\n__Influences__:\nControl damage: Actor's resilience x4, actor's intelligence x3, actor's luck x%3.\nIntensity: Actor's intelligence x1, actor's resilience x1.\nEvasion: Actor's intelligence x4, actor's perception x3, actor's resilience x3, target's agility x-5, target's agility x-5, actor's and target's control.";
				   
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"intelligence") * 0.20 + gCstat(actor,"perception") * 0.15 + gCstat(actor,"resilience") * 0.15 + gC(actor).control * 2 + 15;
		var evasionMinus = gCstat(target,"agility") * 0.25 + gCstat(target,"perception") * 0.25 + gC(target).control * 2;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Control damage
			var controlDamage = 1.3; // 1.3 ~ 2.3
			controlDamage += ((luckedDiceThrow(gCstat(actor,"luck")) * 0.3) + (gCstat(actor,"intelligence") * 0.003) + (gCstat(actor,"resilience") * 0.004));
			
			// Altered State
			var asIntensity = addLuckFactor((gCstat(actor,"intelligence") + (gCstat(actor,"resilience")) * 0.065),0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			// To Do: New altered state
			var altState = createASvinesLockArms(asIntensity);
			
			// Apply
			attackControl(target,controlDamage);
			applyAlteredState([target],altState);
			results.value = controlDamage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " whipped " + ktn(target) + " with vines, binding " + gC(target).posPr + " arms in the process."),
										(ktn(actor) + " launched a vine against " + ktn(target) + ", locking " + gC(target).posPr + " arms."),
										(ktn(actor) + " attacked " + ktn(target) + " with a vine, locking it around " + gC(target).posPr + " arms.")
									] );
			results.description += " " + ktn(target) + " received " + controlDamage.toFixed(1) + " control damage. " + ktn(target)
								 + "'s arms have been locked. "
								 + generateSaCostsText(this,actor) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to hit " + ktn(target) + " with vines, but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
		
	}
	return sa;
}

		// Spores
		
window.createSaRelaxingScent = function() {
	var sa = new sceneAction();
	sa.name = "Relaxing scent";
	sa.key = "baRelaxingScent";
	sa.actionType = "social";
	sa.targetType = "area";
	sa.willpowerCost = 3;
	
	// sa.actorDisabledByAs = [ "CoId" ];
	
	sa.requiredRace = [ "leirien" ];
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	
	sa.getIsAllowedBySettings = function() { // Fake settings
		var isAllowed = false;
		
		if ( ( State.variables.sc.teamAcharKeys.length + State.variables.sc.teamBcharKeys.length ) > 1 ) {
			isAllowed = true;
		}
		
		return isAllowed;
	}
	
	sa.strategyTags.push("social","alteredState","debuff");
	sa.affinities.push("social");
	
	sa.description = "The character releases special spores that induce those that breath them into a state of relaxation.\n"
				   + "Everyone but the actor will lose physique, agility, will and perception.\n"
				   + "\n\nSocial spore attack."
				   + "\n\n__Influences__:\nIntensity: Actor's resilience x1, actor's will x1"; 
				   
	sa.doesHitLand = function(actor,target) {
		return true;
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		// var evResults = this.doesHitLand(actor,target);
		
		if ( true ) { // Hit lands
			// Altered State
			var inIntensity = gCstat(actor,"resilience") * 0.075 + gCstat(actor,"will") * 0.05;
			var asIntensity = addLuckFactor(inIntensity,0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			
			/* Edits */
			var altState = createASrelaxingScent(asIntensity);
			// Apply
			var relaxedTargets = arrayMinusA(State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys),actor);
			applyAlteredState(relaxedTargets,altState);
			
			results.value = 1;
			// Description
				results.description += randomFromList( [
										( ktn(actor) + " appears to be throwing something into the air. A funny smell reaches everyone's noses, and they feel sleepy." ),
										( "A gentle scent is reaching everyone's noses, causing their eyes to fall. " + ktn(actor) + " looks uneffected." )
										] );
			results.description += " " + generateSaCostsText(this,actor) + ".";
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " couldn't launch the spores.";
		}
		
		return results;
		
	}
	return sa;
}


	// Social

window.createSaTaunt = function() {
	var sa = new sceneAction();
	sa.name = "Taunt";
	sa.key = "taunt";
	sa.actionType = "social";
	sa.targetType = "single";
	sa.socialdriveCost = 2;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.strategyTags.push("social","alteredState");
	sa.affinities.push("social","taunt");
	
	sa.description = "The character insults their target's honor.\n"
				   + "If successful, the target will lose luck, perception, agility and willpower, but will gain physique and physical damage.\n\nSingle target action."
				   + "\n\nSocial taunt attack."
				   + "\n\n__Influences__:\nControl damage: Actor's intelligence x7, actor's luck x%3.\nIntensity: Actor's intelligence x1.\nEvasion: Actor's charisma x7, actor's empathy x4, target's empathy x-5, target's will x-5."; 
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"charisma") * 0.35 + gCstat(actor,"empathy") * 0.15 + 25;
		var evasionMinus = gCstat(target,"empathy") * 0.25 + gCstat(target,"will") * 0.25;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Altered State
			var inIntensity = gCstat(actor,"charisma") * 0.13 + gCstat(actor,"empathy") * 0.06;
			var asIntensity = addLuckFactor(inIntensity,0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			var altState = createAStaunted(asIntensity);
			// Apply
			applyAlteredState([target],altState);
			results.value = 1;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " challenged " + ktn(target) + " to make a less shameful ahegao face today."),
										(ktn(actor) + " told " + ktn(target) + " their private parts are impressing for the wrong reasons."),
										(ktn(actor) + " told " + ktn(target) + " that " + gC(target).perPr + " should give in to " + gC(target).posPr
										+ " desires and beg for pleasure.")
									] );
			results.description += " " + generateSaCostsText(this,actor) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to taunt " + ktn(target) + ", but was ignored. " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
		
	}
	return sa;
}

window.createSaBaTease = function() {
	var sa = new sceneAction();
	sa.name = "Tease";
	sa.key = "baTease";
	sa.actionType = "social";
	sa.targetType = "single";
	sa.socialdriveCost = 2;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.strategyTags.push("social","seduction","alteredState","damage","debuff");
	sa.affinities.push("social","seduction");
	
	sa.description = "The character attempts to distract the enemy with sexual fantasies.\n"
				   + "The target will receive and deal increased sex damage."
				   + "\n\nSocial tease attack."
				   + "\n\n__Influences__:\nControl damage: Actor's intelligence x7, actor's luck x%3.\nIntensity: Actor's intelligence x1.\nEvasion: Actor's charisma x7, actor's empathy x4, target's empathy x-5, target's will x-5."; 
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"charisma") * 0.35 + gCstat(actor,"empathy") * 0.15 + 25;
		var evasionMinus = gCstat(target,"empathy") * 0.25 + gCstat(target,"will") * 0.25;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"charisma") * 0.075 + gCstat(actor,"empathy") * 0.025;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Altered State
			var inIntensity = gCstat(actor,"charisma") * 0.13 + gCstat(actor,"empathy") * 0.06;
			var asIntensity = addLuckFactor(inIntensity,0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			
			var possibleBps = [];
			for ( var bp of ["dick","pussy","mouth"] ) {
				if ( gC(target).body.hasOwnProperty(bp) ) {
					possibleBps.push(bp);
				}
			}
			if ( possibleBps.length >  0 ) {
				var chosenBp = randomFromList(possibleBps);
			} else {
				var chosenBp = "none";
			}
			
			var altState = createASteased(asIntensity,chosenBp);
			// Apply
			applyBarDamage(target,"lust",-damage);
			// gC(target).lust.attack(-damage);
			applyAlteredState([target],altState);
			results.value = 1;
			// Description
			switch (chosenBp) {
				case "dick":
				results.description += randomFromList( [
										(ktn(actor) + " told " + ktn(target) + " that " + gC(actor).perPr + " is about to turn " + gC(target).posPr + " " + dickWord() + " into cream."),
										(ktn(actor) + " challenged " + ktn(target) + " not to cum too fast once " + gC(actor).perPr + " gets started with " + gC(target).posPr + " " + dickWord() + ".") ] );
					break;
				case "pussy":
				results.description += randomFromList( [
										(ktn(actor) + " told " + ktn(target) + " " + gC(target).posPr + " " + pussyWord() + " will be a fountain before the battle is over."),
										(ktn(actor) + " told " + ktn(target) + " " + gC(target).perPr + " should stop fantasizing about getting " + gC(target).posPr + " " + pussyWord() + " pampered and start offering it with " + gC(target).posPr + " legs open instead.") ] );
					break;
				case "mouth":
				results.description += randomFromList( [
										(ktn(actor) + " invited " + ktn(target) + " to get on " + gC(target).posPr + " knees and taste " + gC(actor).posPr + " private parts."),
										(ktn(actor) + " told " + ktn(target) + " that obedient pets beg with their tongues out, so it was time for " + gC(target).comPr + " to play " + gC(target).posPr + " part.") ] );
					break;
				case "none":
					results.description += (ktn(actor) + " suggested perverse fantasies to " + ktn(target) + ".");
					break;
			}
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation; " " + generateSaCostsText(this,actor) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to tease " + ktn(target) + ", but was ignored. " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
		
	}
	return sa;
}

		// Hypnosis
	
window.createSaBaHypnoticGlance = function() {
	var sa = new sceneAction();
	sa.name = "Hypnotic Glance";
	sa.key = "baHypnoticGlance";
	sa.targetType = "single";
	sa.actionType = "social";
	sa.willpowerCost = 2;
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.actorBpReqs.push("eyes");
	sa.targetBpReqs.push("eyes");
	
	sa.strategyTags.push("social","hypnosis","alteredState","control","damageWillpower","damageControl",);
	sa.affinities.push("social","hypnosis");
	/* No doggy style yet
	sa.unvalidRelationalPositions.push(["takingFromBehind","takenFromBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastTarget","spitroastBehind"]);
	sa.unvalidRelationalPositions.push(["spitroastBehind","spitroastTarget"]);
	*/
	sa.description = "The character uses hypnotic magic to erode their target's willpower through a seductive glance.\n"
				   + "Actor must have access to target's eyes.\n"
				   + "The target will lose willpower, will, perception, control and control recovery.\nCosts 2 willpower."
				   + "\n\nSingle target action."
				   + "\n\nSocial hypnosis attack."
				   + "\n\n__Influences__:\nDamage and willpower damage: Actor's charisma x5, actor's will x2, target's will x-2.\nControl damage: Actor's will x6, actor's luck: x%1, target's will x-3.\nIntensity: Actor's intelligence x1.\nEvasion: Actor's charisma x5, actor's empathy x5, target's empathy x-2, target's will x-7, actor's and target's control."; 
			   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"charisma") * 0.25 + gCstat(actor,"will") * 0.25 + 15;
		var evasionMinus = gCstat(target,"empathy") * 0.1 + gCstat(target,"will") * 0.35;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
		
	sa.execute = function(actor,targetActors) {
		if ( actor == "chPlayerCharacter" ) { addToStVarsList("monActUs"); }
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Willpower Damage
			var inDamValue = gCstat(actor,"charisma") * 0.25 + gCstat(actor,"will") * 0.10 - gCstat(target,"will") * 0.1;
			var inDamValue2 = inDamValue / 2.5;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			inDamValue2 = addLuckFactor(inDamValue2,0.1,gCstat(actor,"luck")); 
			var damage = calculateAttackEffects("willpower",actor,target,this.affinities,inDamValue);
			var lustDamage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue2);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Control damage
			var controlDamage = 1.2; // 1.2 ~ 1.8
			controlDamage += ((luckedDiceThrow(gCstat(actor,"luck")) * 0.01) + (gCstat(actor,"will") * 0.006) - (gCstat(target,"will") * 0.003));
			
			// Altered State
			var inIntensity = gCstat(actor,"charisma") * 0.15 + gCstat(actor,"will") * 0.07 - gCstat(actor,"will") * 0.07;
			var asIntensity = addLuckFactor(inIntensity,0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			
			var altState = createAShypnosisStroke(asIntensity);
			// Apply
			applyBarDamage(target,"lust",-lustDamage);
			var overflowMsg = applyBarDamage(target,"willpower",-damage);
			// gC(target).willpower.attack(-damage);
			attackControl(target,controlDamage);
			applyAlteredState([target],altState);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " enraptured " + ktn(target) + "'s eyes, and " + gC(target).perPr
										+ " felt " + gC(target).posPr + " willpower slipping away."),
										(ktn(actor) + "'s eyes captured " + ktn(target) + "'s attention, and " + gC(target).perPr
										+ " felt " + gC(target).refPr + " getting lost in them.") ] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + controlDamage.toFixed(1) + " control damage, "
								 + textLustDamage(lustDamage) + " and " + textWillpowerDamage(damage) + "." + overflowMsg;
			results.description += " " + generateSaCostsText(this,actor) + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to nullify " + ktn(target) + "'s senses, but failed. " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

	// Transformation
	
window.createBorrowedIdentity = function() {
	var sa = new sceneAction();
	sa.name = "Borrowed identity";
	sa.key = "baBorrowedIdentity";
	sa.actionType = "social";
	sa.targetType = "area";
	sa.willpowerCost = 3;
	sa.socialdriveCost = 3;
	
	sa.actorDisabledByAs = [ "BoId" ];
	
	sa.requiredRace = [ "shapeshifter" ];
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	
	sa.getIsAllowedBySettings = function() { // Fake settings
		var isAllowed = false;
		
		if ( ( State.variables.sc.teamAcharKeys.length + State.variables.sc.teamBcharKeys.length ) > 1 ) {
			isAllowed = true;
		}
		
		return isAllowed;
	}
	
	sa.strategyTags.push("social","seduction","alteredState","buff","debuff");
	sa.affinities.push("social");
	
	sa.description = "The character transforms their shape to reselve that of someone else, trying to provoke chaos.\n"
				   + "The actor will gain charisma, other combatants will lose perception, empathy and charisma."
				   + "\n\nSocial taunt attack."
				   + "\n\n__Influences__:\nIntensity: Actor's charisma x1, actor's will x1, actor's empathy x1."; 
				   
	sa.doesHitLand = function(actor,target) {
		return true;
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		// var evResults = this.doesHitLand(actor,target);
		
		if ( true ) { // Hit lands
			// Select identity target
			var borrowedIdentity = randomFromList(arrayMinusA(State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys),actor));
			var confusedTargets = arrayMinusA(State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys),actor);
			// Altered State
			var inIntensity = gCstat(actor,"charisma") * 0.05 + gCstat(actor,"empathy") * 0.05 + gCstat(actor,"will") * 0.05;
			var asIntensity = addLuckFactor(inIntensity,0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			
			var altState = createASborrowedIdentity(asIntensity,borrowedIdentity);
			var altState2 = createASconfusedIdentities(asIntensity);
			// Apply
			applyAlteredState([actor],altState);
			applyAlteredState(confusedTargets,altState2);
			results.value = 1;
			// Description
				results.description += randomFromList( [
										ktn(actor) + "'s shape began to change... Until " + gC(actor).perPr + " turned into someone else. The others may think twice then they see " + gC(actor).comPr + ".",
										ktn(actor) + " stole someone's identity! This may provoke some chaos.",
										ktn(actor) + " is nowhere to be seen, for " + gC(actor).perPr + " has taken someone else's face." ] );
			results.description += " " + generateSaCostsText(this,actor) + ".";
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + "'s plot failed!";
		}
		
		return results;
		
	}
	return sa;
}

	// Weapons
// Staff of Battle
window.createStaffSwipe = function() {
	var sa = new sceneAction();
	sa.name = "Staff swipe";
	sa.key = "staffSwipe";
	
	sa.actionType = "hit";
	sa.targetType = "single";
	sa.energyCost = 3; 
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget","control");
	sa.actorBpReqs.push("arms");
	
	sa.requiresFree = true;
	
	sa.strategyTags.push("damage","physical","consumeEnergy","physicalDamage","damageControl");
	sa.affinities.push("physical","weapon");
	
	sa.description = "The character swipes their staff against their opponent, aiming to gain positional advantage.\n"
				   + "This attack damages the target and their control, and recovers the actor's control.\nCosts 3 energy.\n\nSingle target action."
				   + "Actor requires control and free arms."
				   + "\n\nPhysical hit attack."
				   + "\n\n__Influences__:\nDamage: Actor's resilience x5, actor's physique x3, target's resilience x-2."
				   + "\nEvasion: Actor's resilience x4, actor's agility x3, actor's perception x3, actor's control.\nTarget's agility x6, target's perception x5, target's resilience x3, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"resilience") * 0.20 + gCstat(actor,"agility") * 0.15 + gCstat(actor,"perception") * 0.15 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"resilience") * 0.15 + gCstat(target,"agility") * 0.30 + gCstat(target,"perception") * 0.25 + gC(target).control * 4;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		var recoveredControl = 0.20 + (luckedDiceThrow(gCstat(actor,"luck")) * 0.01) + (gCstat(actor,"physique") * 0.001 + (gCstat(actor,"resilience") * 0.001));
		attackControl(actor,-recoveredControl);
		var recControlMsg = ktn(actor) + " recovered " + recoveredControl.toFixed(2) + " control. ";
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"resilience") * 0.25 + gCstat(actor,"physique") * 0.15 - gCstat(target,"resilience") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Control damage
			var controlDamage = 1.4; // 1.4 ~ 2.4
			controlDamage += ((luckedDiceThrow(gCstat(actor,"luck")) * 0.05) + (gCstat(actor,"physique") * 0.0025 + (gCstat(actor,"resilience") * 0.0025)));
			// Apply
			applyBarDamage(target,"lust",-damage);
			attackControl(target,controlDamage);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " cut the air with " + gC(actor).posPr + " staff, badly hurting " + ktn(target) + "."),
										(ktn(actor) + " struck " + ktn(target) + " with " + gC(actor).posPr + " staff, pushing " + gC(target).comPr + " down."),
										(ktn(actor) + "'s feet danced to a better position as " + gC(actor).perPr + " landed a staff blow on " + ktn(target) + ".")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + " and " + controlDamage.toFixed(1)
								 + " control damage. " + recControlMsg + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to strike " + ktn(target) + ", but failed! " + recControlMsg + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

// Knuckles
window.createBoldJab = function() {
	var sa = new sceneAction();
	sa.name = "Bold jab";
	sa.key = "boldJab";
	
	sa.actionType = "hit";
	sa.targetType = "single";
	sa.energyCost = 2; 
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget","control");
	sa.actorBpReqs.push("arms");
	
	sa.requiresFree = true;
	
	sa.strategyTags.push("damage","physical","consumeEnergy","physicalDamage","damageControl");
	sa.affinities.push("physical","weapon");
	
	sa.description = "The character leaps around to land a punch at their target's sides. Risky.\n"
				   + "This attack damages the target and their control if it lands, but damages the actor's control otherwise.\nCosts 2 energy.\n\nSingle target action."
				   + "Actor requires control and free arms."
				   + "\n\nPhysical hit attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x5, actor's resilience x3, actor's agility x3, target's resilience x-1, target's agility x-1."
				   + "\nEvasion: Actor's agility x6, actor's physique x5, actor's perception x4, actor's control.\nTarget's perception x5, target's agility 5, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.3 + gCstat(actor,"physique") * 0.25 + gCstat(actor,"perception") * 0.2 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"perception") * 0.25 + gCstat(target,"agility") * 0.25 + gC(target).control * 4;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"physique") * 0.25 + gCstat(actor,"resilience") * 0.15 + gCstat(actor,"agility") * 0.1 - gCstat(target,"resilience") * 0.05 - gCstat(target,"agility") * 0.05;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Control damage
			var controlDamage = 1.75; // 1.75 ~ 2.9
			controlDamage += ((luckedDiceThrow(gCstat(actor,"luck")) * 0.05) + (gCstat(actor,"physique") * 0.0035 + (gCstat(actor,"agility") * 0.003)));
			// Apply
			applyBarDamage(target,"lust",-damage);
			attackControl(target,controlDamage);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " feinted " + ktn(target) + ", and managed to land a blow on " + gC(target).posPr + " lumbar region."),
										(ktn(actor) + " charged against " + ktn(target) + " and punched " + gC(target).posPr + " abdomen during the clash."),
										(ktn(actor) + " tackled " + ktn(target) + ", and landed an ugly punch during the aftermath.")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + " and " + controlDamage.toFixed(1)
								 + " control damage. " + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			var selfControlDamage = 0.4 - (luckedDiceThrow(gCstat(actor,"luck")) * 0.2);
			attackControl(actor,selfControlDamage);
			results.value = 0;
			results.description = ktn(actor) + " tried to strike " + ktn(target) + ", but failed! " + ktn(actor) + " received " + selfControlDamage.toFixed(1) + " control damage. " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

// Wand
window.createSaChannelAether = function() {
	var sa = new sceneAction();
	sa.name = "Channel aether";
	sa.key = "channelAether";
	
	sa.actionType = "special";
	sa.targetType = "self";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	
	sa.strategyTags.push("magic","recoverWillpower");
	sa.affinities.push("weapon");
	
	sa.description = "The character focuses on the energies surrounding them, absorbing unleashed aether.\n"
				   + "The action makes the actor recover a portion of their maximum willpower.\n\nSelf targeted action."
				   + "\n\nMagical special action."
				   + "\n\n__Influences__:\nIntensity: Actor's will x7, actor's intelligence x3, actor's luck %4."; 
				   
	sa.doesHitLand = function(actor,target) {
		return new evasionResults(true,"");
	}		   				   
	
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = actor;
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			var recoveredWillpower = gC(actor).willpower.max * ( (luckedDiceThrow(gCstat(actor,"luck"))) * 0.004 + gCstat(actor,"will") * 0.007 + gCstat(actor,"intelligence") * 0.003 );
			gC(actor).willpower.changeValue(recoveredWillpower);
			results.value = recoveredWillpower;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " absorbed unleashed aether."),
										(ktn(actor) + " focused on recovering " + gC(actor).posPr + " magical energy."),
										(ktn(actor) + " added wild, untamed aether to " + gC(actor).posPr + " own.")
									] );
			results.description += " " + ktn(actor) + " recovered " + textWillpowerPoints(recoveredWillpower) + ".";
			// results.description += " " + ktn(target) + " received " + textLustDamage(damage) + ". " + generateSaCostsText(this,actor)
			//					 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't ever happen. Please notify me.";
		}
		
		return results;
	}
	return sa;
}

// Wand
window.createSaFlaunt = function() {
	var sa = new sceneAction();
	sa.name = "Flaunt";
	sa.key = "flaunt";
	
	sa.actionType = "special";
	sa.targetType = "self";
	sa.socialdriveCost = 3; 
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	
	sa.actorDisabledByAs = [ "Flnt" ];
	
	sa.strategyTags.push("buff","social","alteredState");
	sa.affinities.push("weapon");
	
	sa.description = "The character shows proudly exposes their body, hitting their opponents with raw sex appeal.\n"
				   + "The action increases the actor's physique, agility, will, perception, charisma and damage dealt with sex actions.\n\nSelf targeted action."
				   + "\n\nSocial special action."
				   + "\n\n__Influences__:\nIntensity: Actor's charisma x3, actor's physique x1, actor's agility x1, actor's will x1.";
				   
	sa.doesHitLand = function(actor,target) {
		return new evasionResults(true,"");
	}		   				   
	
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = actor;
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Altered State
			var inIntensity = (gCstat(actor,"charisma") * 3 + gCstat(actor,"physique") + gCstat(actor,"agility") + gCstat(actor,"will")) * 0.025;
			var asIntensity = addLuckFactor(inIntensity,0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			var altState = createASflaunting(asIntensity);
			// Apply
			applyAlteredState([actor],altState);
			results.value = asIntensity;
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " wildly dances around, exposing " + gC(actor).posPr + " body."),
										(ktn(actor) + " extends " + gC(actor).posPr + " arm to the side and winks, taunting " + gC(actor).posPr + " opponent."),
										(ktn(actor) + " flaunts " + gC(actor).posPr + " body features, bursting with sex appeal.")
									] );
			results.description += " " + generateSaCostsText(this,actor) + ".";
			// results.description += " " + ktn(target) + " received " + textLustDamage(damage) + ". " + generateSaCostsText(this,actor)
			//					 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't ever happen. Please notify me.";
		}
		
		return results;
	}
	return sa;
}

// Hunting bow
window.createDisablingShot = function() {
	var sa = new sceneAction();
	sa.name = "Disabling shot";
	sa.key = "disablingShot";
	
	sa.actionType = "projectile";
	sa.targetType = "single";
	sa.energyCost = 2; 
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget","control");
	sa.actorBpReqs.push("arms");
	
	sa.requiresFree = true;
	
	sa.strategyTags.push("damage","physical","consumeEnergy","physicalDamage","damageControl");
	sa.affinities.push("physical","weapon");
	
	sa.description = "The character aims to shoot against the limbs of their target, damaging their control recovery.\n"
				   + "This attack damages the target, their control and their control recovery.\nCosts 2 energy.\n\nSingle target action."
				   + "Actor requires control and free arms."
				   + "\n\nPhysical projectile attack."
				   + "\n\n__Influences__:\nLust damage: Actor's agility x2, actor's physique x1, actor's perception x1, target's resilience x-1."
				   + "\nControl damage: Actor's luck x%3, actor's agility x2, actor's perception x1, actor's physique x1"
				   + "\nEvasion: Actor's agility x1, actor's perception x1, actor's control.\nTarget's agility x1, target's perception x1, target's control."
				   + "\nAltered state intensity: Actor's agility x1, actor's perception x1.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.25 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"agility") * 0.25 + gCstat(target,"perception") * 0.25 + gC(target).control * 4;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"agility") * 0.2 + gCstat(actor,"physique") * 0.1 + gCstat(actor,"perception") * 0.1 - gCstat(target,"resilience") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Control damage
			var controlDamage = 1; // 1 ~ 1.7
			controlDamage += ((luckedDiceThrow(gCstat(actor,"luck")) * 0.3) + gCstat(actor,"agility") * 0.002 + gCstat(actor,"perception") * 0.001 + gCstat(actor,"physique") * 0.001);
			// Altered State
			var asIntensity = addLuckFactor((gCstat(actor,"agility") * 0.07 + gCstat(actor,"perception") * 0.07),0.1,gCstat(actor,"luck"));
			var asIntensity = fixIntensity(asIntensity);
			var altState = createAStaintedControlRecovery(asIntensity);
			// Apply
			applyBarDamage(target,"lust",-damage);
			attackControl(target,controlDamage);
			applyAlteredState([target],altState);
			results.value = damage;
			// Description
			results.description += randomFromList( [
										("A nimble arrow cut the wind, hitting " + ktn(target) + "'s limbs."),
										(ktn(actor) + " carefully aimed at " + ktn(target) + "'s limbs, and " + gC(actor).posPr + " arrow hit the mark."),
										(ktn(actor) + " shot a projectile against " + ktn(target) + "'s weak spots, impairing " + gC(target).posPr + " movement.")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + " and " + controlDamage.toFixed(1)
								 + " control damage. "+ generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " aimed at " + ktn(target) + "'s weak spots, but failed the shot! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

// Dildo
window.createSaBaDildoPenetratePussy = function() {
	var sa = new sceneAction();
	sa.name = "Dildo-Pussy Penetration";
	sa.key = "baDildoPenetratePussy";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs","sUse");
	sa.reqTags.push("diffTarget","control","activePosition","unusedWeapon");
	sa.actorBpReqs.push("arms");
	sa.targetBpReqs.push("pussy");
	
	sa.strategyTags.push("damage","sex","targetPussy");
	sa.affinities.push("sex","targetPussy");
	
	sa.description = "The character starts penetrating their target's pussy with their dildo.\n"  
				   + "\nSingle target continued action.\nRequires an active position over the target, and the target must have a a free pussy."
				   + "\n\nContact attack." 
				   + "\n\n__Influences__:\Initial and continued damage: Actor's physique x2, actor's agility x1, target's resilience x-1.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"physique") * 0.25 + gCstat(actor,"agility") * 0.25 + gCstat(actor,"perception") * 0.25 + gC(actor).control * 5;
		var evasionMinus = gCstat(target,"perception") * 0.15 + gCstat(target,"agility") * 0.5;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}
	sa.execute = function(actor,targetsList) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetsList[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Initial damage
			var inDamValue = gCstat(actor,"physique") * 0.2 + gCstat(actor,"agility") * 0.1 - gCstat(actor,"resilience") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			gC(target).lust.attack(-damage);
			results.value = damage;
			
			// Position
			//createBposP2PfrontalPounce(actor,[target]);
			
			// Continued action
			State.variables.sc.continuedActions.push(createCaBaDildoPenetratePussy(actor,targetsList));
			
			// Description
			results.description += randomFromList( [
										(ktn(actor) + " pushed " + gC(actor).posPr + " dildo against " + ktn(target) + "'s lower entrance, penetrating " + gC(target).comPr + " fully."),
										(ktn(actor) + " filled " + ktn(target) + "'s " + pussyWord() + " with " + gC(actor).posPr + " " + randomFromList("dildo","weapon","tool","toy") + ", forcing pleasure into " + gC(target).comPr + ".")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to penetrate " + ktn(target) + "'s " + pussyWord() + " with " + gC(actor).posPr + " dildo, but failed! "	+ "\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createSaBaThrustDildo = function() {
	var sa = new sceneAction();
	sa.name = "Thrust Dildo";
	sa.key = "baThrustDildo";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("baDildoPenetratePussy");
	
	sa.strategyTags.push("damage","sex","targetPussy");
	sa.affinities.push("sex","targetPussy");
	
	sa.description = "The character pushes their dildo into their target's folds. Actor must be fucking their target with a dildo.\n"
				   + "This attack damages the target, and the actor receives some retaliation.\n\nSingle target action."
				   + "\n\nSexual contact attack."
				   + "\n\n__Influences__:\nDamage: Actor's physique x2, actor's agility x2, target's resilience x-1.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = 1;
		var evasionMinus = 1;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = (gCstat(actor,"physique") * 0.4 + gCstat(actor,"agility") * 0.4 - gCstat(target,"resilience") * 0.2) * 0.6;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);		
			// Apply
			gC(target).lust.attack(-damage);
			results.value = damage;
			// Description
			results.description += randomFromList( [
									(ktn(actor) + " pushed " + gC(actor).posPr + " " + randomFromList("dildo","toy","tool","weapon","dildo") + " deep into " + ktn(target) + "."),
									(ktn(actor) + " thrusted into " + ktn(target) + "'s " + pussyWord() + "."),
									(ktn(actor) + " penetrated " + ktn(target) + "'s " + randomFromList(["insides","pussy"]) + " with " + gC(actor).posPr + " " + randomFromList("dildo","toy","tool","weapon","dildo") + ".")
								] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + "." + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't happen.";
		}
		
		return results;
	}
	return sa;
}

	// MONSTERS

		// Flying Lookout
window.createBaOrderKneeling = function() {
	var sa = new sceneAction();
	sa.name = "Order kneeling";
	sa.key = "baOrderKneeling";
	
	sa.actionType = "pounce";
	sa.targetType = "single";
	sa.willpowerCost = 5;
	
	sa.tags.push("bs","bPos");
	sa.reqTags.push("diffTarget","control");
	sa.actorBpReqs.push("eyes");
	sa.targetBpReqs.push("eyes");
	
	sa.strategyTags.push("pounce","bPos","useEyes","targetEyes");
	sa.affinities.push("hypnosis","useEyes","targetEyes");
	
	sa.getIsCustomAllowed = function(actionKey,actorKey,targetsKeys,skipLinkedCheck) {
		var isAllowed = true;
		if ( gC(targetsKeys[0]).race == "monster" ) {
			isAllowed = false;
		}
		return isAllowed;
	}
	
	// To re-do
	sa.description = "The character influences their target to make them drop to their knees.\n"
				   + "\nSingle target action."
				   + "\nActor requires control and free eyes, target requires free eyes and not being a monster.\nCosts 5 willpower."
				   + "\n\nPounce attack."
				   + "\n\n__Influences__:\nDamage: Actor's will x2, actor's charisma x2, target's will x-1.\nContinued damage and self damage: Actor's and target's physique x1, actor's and target's resilience x1."
				   + "\nEvasion: Actor's will x5, actor's charisma x5, actor's control.\nTarget's will x7, target's charisma x7, target's control.";
	
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"charisma") * 0.25 + gCstat(actor,"will") * 0.25 + gC(actor).control * 5;
		var evasionMinus = gCstat(target,"will") * 0.35 + gCstat(target,"empathy") * 0.35 + gC(target).control * 15;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Initial damage
			var inDamValue = gCstat(actor,"will") * 0.2 + gCstat(actor,"charisma") * 0.2 - gCstat(target,"will") * 0.1;
			if ( inDamValue <= 0 ) { inDamValue = 0; }
			var inDamValue2 = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var damage2 = calculateAttackEffects("willpower",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			// Apply
			gC(target).lust.attack(-damage);
			var overflowMsg = applyBarDamage(target,"willpower",-damage2);
			depleteControl(target);
			results.value = damage;
			
			// Position
			createBposMakeKneel(actor,[target]);
				
			// Description
			results.description += randomFromList( [
										(ktn(target) + " accepts " + ktn(actor) + "'s suggestion to get on " + gC(target).posPr + " knees."),
										(ktn(target) + "'s will breaks down like a crystal urn fallen into the floor, and so fall " + gC(target).posPr + " legs."),
										(ktn(actor) + " traps " + ktn(target) + "'s eyes with " + gC(actor).posPr + " own, and " + gC(actor).posPr + " mind follows.")
									] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + " and " + textWillpowerDamage(damage2) + ". " + overflowMsg + " " + generateSaCostsText(this,actor)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to enrapture " + ktn(target) + "'s mind, but failed! " + generateSaCostsText(this,actor)
								+ ".\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}

window.createBaOrderMasturbation = function() {
	var sa = new sceneAction();
	sa.name = "Order masturbation";
	sa.key = "baOrderMasturbation";
	sa.actionType = "trance";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("baMakingKneel");
	
	sa.strategyTags.push("damage","sex","hypnosis");
	sa.affinities.push("sex","hypnosis");
	
	sa.getIsCustomAllowed = function(actionKey,actorKey,targetsKeys,skipLinkedCheck) {
		var isAllowed = true;
		if ( gC(targetsKeys[0]).race == "monster" ) {
			isAllowed = false;
		}
		return isAllowed;
	}
	
	sa.description = "The character orders their target to masturbate. The target must already be following the actor's orders.\n"
				   + "This attack makes the target attack themself.\nLess effective if the target does not have free arms.\nDamage gets shared between lust and willpower if the target has no free genitals.\n\nSingle target action."
				   + "\n\nSexual, hypnosis trance attack."
				   + "\n\n__Influences__:\nDamage: Target's agility xVar, target's physique xVar, target's will xVar.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = 1;
		var evasionMinus = 1;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			var freeArms = false;
			var freeGenitals = false;
			var extraTags = [];
			var validGenitalsWords = [];
			if ( gC(target).hasFreeBodypart("pussy") ) {
				freeGenitals = true;
				extraTags.push("targetPussy");
				extraTags.push("usePussy");
				validGenitalsWords.push(pussyWord());
			}
			if ( gC(target).hasFreeBodypart("dick") ) {
				freeGenitals = true;
				extraTags.push("targetDick");
				extraTags.push("useDick");
				validGenitalsWords.push(dickWord());
			}
			if ( gC(target).hasFreeBodypart("arms") ) {
				freeArms = true;
				extraTags.push("useArms");
				extraTags.push("targetArms");
			}
			if ( freeGenitals ) {
				// Damage
				var inDamValue = gCstat(target,"agility") * 0.3 + gCstat(target,"physique") * 0.2 - gCstat(target,"will") * 0.1;
				if ( freeArms == false ) { inDamValue *= 0.5; }
				inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
				var damage = calculateAttackEffects("lust",actor,target,this.affinities.concat(extraTags),inDamValue);
				var dmgEffMsg = getWeaknessToAttackText(this.affinities.concat(extraTags),target);
				// Apply
				gC(target).lust.attack(-damage);
				results.value = damage;
				// Description
				if ( freeArms ) {
					results.description += randomFromList( [
										("After receiving " + ktn(actor) + "'s order, " + ktn(target) + " " + randomFromList(["furiously","passionately","obsessively"]) + " pleasures " + gC(target).posPr + " " + randomFromList(validGenitalsWords) + "."),
										("As if it had been " + gC(target).posPr + " own idea, " + ktn(target) + " lowers " + gC(target).posPr + " hands down to " + gC(target).posPr + " nethers, and fulfilling " + ktn(actor) + "'s order.")
									] );
				} else {
					results.description += randomFromList( [
										(ktn(target) + " does " + gC(target).posPr + " best to fulfill " + ktn(actor) + "'s order to masturbate, but " + gC(target).posPr + " tied arms prevent " + gC(target).comPr + " from doing anything other than frotting " + gC(target).posPr + " legs."),
										(ktn(actor) + " orders " + ktn(target) + " to masturbate, but " + gC(target).perPr + " is only capable of frotting " + gC(target).refPr + " against " + gC(target).posPr + " thighs.")
									] );
				}
				results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + ". " + evResults.explanation;
			} else {
				// Damage
				var inDamValue = gCstat(target,"agility") * 0.3 + gCstat(target,"physique") * 0.1 - gCstat(target,"will") * 0.05;
				if ( freeArms == false ) { inDamValue *= 0.5; }
				var inDamValue2 = inDamValue * 0.5;
				inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
				inDamValue2 = addLuckFactor(inDamValue2,0.1,gCstat(actor,"luck"));
				var damage = calculateAttackEffects("lust",actor,target,this.affinities.concat(extraTags),inDamValue);
				var damage2 = calculateAttackEffects("willpower",actor,target,this.affinities.concat(extraTags),inDamValue);
				var dmgEffMsg = getWeaknessToAttackText(this.affinities.concat(extraTags),target);
				// Apply
				gC(target).lust.attack(-damage);
				var overflowMsg = applyBarDamage(target,"willpower",-damage2);
				results.value = damage;
				// Description
				if ( freeArms ) {
					results.description += randomFromList( [
										("After receiving " + ktn(actor) + "'s order, " + ktn(target) + " " + randomFromList(["furiously","passionately","obsessively"]) + " touches " + gC(target).posPr + " locked " + randomFromList(["genitals","nethers"]) + "."),
										("As if it had been " + gC(target).posPr + " own idea, " + ktn(target) + " lowers " + gC(target).posPr + " hands down to " + gC(target).posPr + " nethers, receiving only frustration in return.")
									] );
				} else {
					results.description += randomFromList( [
										(ktn(target) + " does " + gC(target).posPr + " best to fulfill " + ktn(actor) + "'s order to masturbate, but " + gC(target).posPr + " bound body prevent " + gC(target).comPr + " from doing anything other than shamefully frotting " + gC(target).posPr + " legs."),
										(ktn(actor) + " orders " + ktn(target) + " to masturbate, but " + gC(target).perPr + " is only capable of frotting " + gC(target).refPr + " against " + gC(target).posPr + " thighs.")
									] );
				}
				results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + " and " + textWillpowerDamage(damage2) + ". " + overflowMsg + " " + evResults.explanation;
			}
		} else { // Hit 
			results.value = 0;
			results.description = (ktn(actor) + " tried to force " + ktn(target) + " to masturbate, but failed!" + evResults.explanation);
		}
		
		return results;
	}
	return sa;
}

window.createBaCorrodeMind = function() {
	var sa = new sceneAction();
	sa.name = "Corrode Mind";
	sa.key = "baCorrodeMind";
	sa.actionType = "trance";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	sa.requiredActiveCAs.push("baMakingKneel");
	
	sa.strategyTags.push("damage","hypnosis");
	sa.affinities.push("hypnosis","useEyes","targetEyes");
	
	sa.strategyTags.push("damage","hypnosis");
	sa.affinities.push("hypnosis","useEyes","targetEyes");
	
	sa.description = "The character perfores the confines of the target's mind, damaging their lust and willpower.\n"
				   + "\nSingle target action.\n"
				   + "\nTrance hypnosis attack."
				   + "\n\n__Influences__:\nDamage: Actor's intelligence x2, actor's will x2, actor's charisma x2, target's will x-1.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = 1;
		var evasionMinus = 1;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"intelligence") * 0.2 + gCstat(actor,"will") * 0.2 + gCstat(actor,"charisma") * 0.2 - gCstat(target,"will") * 0.1;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage2 = calculateAttackEffects("willpower",actor,target,this.affinities,inDamValue*0.4);
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue*0.6);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);	
			// Apply
			gC(target).lust.attack(-damage);
			var overflowMsg = applyBarDamage(target,"willpower",-damage2);
			results.value = damage;
			// Description
			results.description += randomFromList( [
									(ktn(actor) + " eats away " + ktn(target) + "'s " + randomFromList(["concentration","balance","willpower","sanity"]) + "."),
									(ktn(actor) + " finds the weakest links in " + ktn(target) + "'s mind, and breaks them apart."),
									(ktn(target) + " feels " + gC(actor).posPr + " mind being picked apart by " + ktn(actor) + " claws.")
								] );
			results.description += " " + dmgEffMsg + ktn(target) + " received " + textLustDamage(damage) + " and " + textWillpowerDamage(damage2) + ". " + overflowMsg + " " + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = "This shouldn't happen.";
		}
		
		return results;
	}
	return sa;
}

		// Essence-sucker
window.createBaDrainingRoots = function() {
	var sa = new sceneAction();
	sa.name = "Draining roots";
	sa.key = "baDrainingRoots";
	sa.actionType = "contact";
	sa.targetType = "single";
	
	sa.tags.push("bs");
	sa.tags.push("sUse");
	sa.reqTags.push("diffTarget");
	
	sa.strategyTags.push("damage","sex","drain");
	sa.affinities.push("sex","drain");
	
	sa.requiredRace = [ "leirien" , "monster" ];
	
	sa.description = "The character connects their limbs with their target, sucking their aether.\n"
				   + "This attack damages the target and drains their lust.\nThe actor must be either a monster or a leirien."
				   + "\n\nSingle target action."
				   + "\n\nSexual draining contact attack."
				   + "\n\n__Influences__:\nDrain damage: Actor's resilience x5, actor's will x4, target's resilience x-2."
				   + "\nEvasion: Actor's agility x7, actor's perception x3, actor's control.\nTarget's agility x7, target's perception x7, target's control.";
				   
	sa.doesHitLand = function(actor,target) {
		var evasionPlus = gCstat(actor,"agility") * 0.35 + gCstat(actor,"perception") * 0.15 + gC(actor).control * 4;
		var evasionMinus = gCstat(target,"agility") * 0.35 + gCstat(target,"perception") * 0.35 + gC(target).control * 4 + 5;
		return calculateEvasion(this.actionType,actor,target,evasionPlus,evasionMinus);
	}		   			
				   
	sa.execute = function(actor,targetActors) {
		applySaCosts(this,actor);
		
		var results = new saResults;
		var target = targetActors[0];
		
		// Evasion
		var evResults = this.doesHitLand(actor,target);
		
		if ( evResults.hit ) { // Hit lands
			// Damage
			var inDamValue = gCstat(actor,"resilience") * 0.25 + gCstat(actor,"will") * 0.20 - gCstat(actor,"resilience") * 0.10;
			inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
			var damage = calculateAttackEffects("lust",actor,target,this.affinities,inDamValue);
			var dmgEffMsg = getWeaknessToAttackText(this.affinities,target);
			
			// Apply
			applyBarDamage(target,"lust",-damage);
			results.value = damage;
			
			gC(actor).lust.changeValue(damage);
			// Description
			results.description += randomFromList( [
									(ktn(actor) + " inserted " + gC(actor).posPr + " roots in " + ktn(target) + ", and started sucking " + gC(target).posPr + " aether."),
									(ktn(target) + " runs short of breath as " + ktn(actor) + " sucks " + gC(target).posPr + " aether away."),
									(ktn(target) + " is pained by the injection of " + ktn(actor) + " roots, which " + randomFromList(["eagerly","irredeemably","mercilessly"]) + " suck away " + gC(target).posPr + " aether.")
								] );
			results.description += " " + dmgEffMsg + ktn(actor) + " drained " + textLustDamage(damage) + " from " + ktn(target)
								 + ".\n" + evResults.explanation;
		} else { // Hit fails
			results.value = 0;
			results.description = ktn(actor) + " tried to drain " + ktn(target) + ", but failed!\n" + evResults.explanation;
		}
		
		return results;
	}
	return sa;
}
 


/* From stat-classes.js
window.alteredState = function(title,acr,scope,turns,provokeEffect,cancelEffect,description) {
	this.title = title;
	this.type = "none";
	this.acr = acr;
	this.scope = scope; // "scene", "days" or "equipment"
	this.remainingTurns = turns;
	this.provokeEffect = provokeEffect;
	this.cancelEffect = cancelEffect;
	this.description = description;
	this.remainingDays = -1; // If something other than -1, modify outside of constructor
	// this.turnEffect = function(character) -> Property added outside of constructor
	
	this.flagRemove = false;
}
*/

////////// ALTERED STATE CONSTRUCTORS //////////
// These are invoked by scene actions, events or others, and applied to a characterSet
// Max intensity = 10
window.fixIntensity = function(inIntensity) {
	var intensity = inIntensity;
	if ( intensity < 0 ) { intensity = 0; }
	else if ( intensity > 10 ) { intensity = 10; }
	return intensity;
}

window.createSensitizedTag = function(intensity,tag,name,abr,turns,description) {
	var provokeEffect = function(charKey) {
	}
	var cancelEffect  = function(charKey) {
	}
	var as = new alteredState(name,abr,"scene",turns,provokeEffect,cancelEffect,description);
	as.tag = tag;
	as.intensity = intensity;
	return as;	
}
// List: Pus+ ; Bre+ ; Dic+ ; Ass+ ; DicT ; PusT

window.createASfrozenFeet = function(intensity) {
	// Extra energy cost, control recovery reduction, agility loss (sum, mult) // Turns
	var eec = 5 + intensity * 1; // 5 ~ 15
	var crc = 0.05 + intensity * 0.005; // 0.05 ~ 0.1
	var als = 2 + intensity * 0.3; // 2 ~ 5
	var alm = 0.05 + intensity * 0.005; // 0.05 ~ 0.1
	var turns = 4 + limitedRandomInt(2); // 4 ~ 6
	var provokeEffect = function(charKey) {
		gC(charKey).energy.tainted += eec;
		gC(charKey).controlRecovery -= crc;
		gC(charKey).agility.sumModifier -= als;
		gC(charKey).agility.multModifier -= alm;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).energy.tainted -= eec;
		gC(charKey).controlRecovery += crc;
		gC(charKey).agility.sumModifier += als;
		gC(charKey).agility.multModifier += alm;
	}
	var description = "Intense cold in the legs and feet are causing mobility issues to this character.\n"
					+ "Loss of agility, weakened control recovery, energy becomes tainted.";
	var as = new alteredState("Frozen feet","FrFe","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	return as;
}

window.createASsensitizedGenitals = function(intensity) {
	// Extra sex weakness // Turns
	var esw = 10 + intensity * 1; // 10 - 20
	var turns = 4 + limitedRandomInt(2); // 4 ~ 6
	var provokeEffect = function(charKey) {
		gC(charKey).combatAffinities.sex.weakness += esw;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).combatAffinities.sex.weakness -= esw;
	}
	var description = "The contact with electric shocks have sensitized the genitals of this character.\n"
					+ "Increased damage from sex attacks.";
	var as = new alteredState("Sensitized genitals","SeGe","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	return as;
}

window.createAScoldGuts = function(intensity) {
	// Stats gain (phy,res,will) , increased lust resistance
	var sgs = 3 + intensity * 0.5; // 3 ~ 8
	var sgm = 0.1 + intensity * 0.08; // 0.1 ~ 0.18
	var isr = 10 + intensity * 1; // 10 ~ 20
	var turns = 5 + limitedRandomInt(7); // 5 ~ 7
	var provokeEffect = function(charKey) {
		gC(charKey).physique.sumModifier += sgs;
		gC(charKey).physique.multModifier += sgm;
		gC(charKey).resilience.sumModifier += sgs;
		gC(charKey).resilience.multModifier += sgm;
		gC(charKey).will.sumModifier += sgs;
		gC(charKey).will.multModifier += sgm;
		gC(charKey).combatAffinities.sex.resistance += isr;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).physique.sumModifier -= sgs;
		gC(charKey).physique.multModifier -= sgm;
		gC(charKey).resilience.sumModifier -= sgs;
		gC(charKey).resilience.multModifier -= sgm;
		gC(charKey).will.sumModifier -= sgs;
		gC(charKey).will.multModifier -= sgm;
		gC(charKey).combatAffinities.sex.resistance -= isr;
	}
	var description = "This character is focused in the proper use of their inner energy.\n"
					+ "Increased physique, resilience, will and resistance to sex actions.";
	var as = new alteredState("Cold guts","CoGu","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "buff";
	return as;
}

window.createAStaunted = function(intensity) {
	// Stats loss , Extra physical strength eps // Turns
	var sls = 4 + intensity * 0.3; // 4 ~ 7
	var slm = 0.07 + intensity * 0.008; // 0.07 ~ 0.18
	var eps = 10 + intensity * 0.5; // 10 ~ 15
	var turns = 4 + limitedRandomInt(2); // 4 ~ 6
	var provokeEffect = function(charKey) {
		gC(charKey).luck.sumModifier -= sls;
		gC(charKey).luck.multModifier -= slm;
		gC(charKey).perception.sumModifier -= sls;
		gC(charKey).perception.multModifier -= slm;
		gC(charKey).agility.sumModifier -= sls;
		gC(charKey).agility.multModifier -= slm;
		gC(charKey).will.sumModifier -= sls;
		gC(charKey).will.multModifier -= slm;
		gC(charKey).physique.sumModifier += sls;
		gC(charKey).physique.multModifier += slm;
		gC(charKey).combatAffinities.physical.strength += eps;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).luck.sumModifier += sls;
		gC(charKey).luck.multModifier += slm;
		gC(charKey).perception.sumModifier += sls;
		gC(charKey).perception.multModifier += slm;
		gC(charKey).agility.sumModifier += sls;
		gC(charKey).agility.multModifier += slm;
		gC(charKey).will.sumModifier += sls;
		gC(charKey).will.multModifier += slm;
		gC(charKey).physique.sumModifier -= sls;
		gC(charKey).physique.multModifier -= slm;
		gC(charKey).combatAffinities.physical.strength -= eps;
	}
	var description = "The ego of this character has been damaged.\n"
					+ "Loss of luck, perception, agility and will. Gain of physique and physical damage.";
	var as = new alteredState("Taunted","Tntd","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	return as;
}

window.createASteased = function(intensity, type) {
	// Sex weakness, sex strength, random sex type weakness // Turns
	var sType = "target" + firstToCap(type);
	var esw = 15 + intensity * 1; // 15 - 25
	var ess = 5 + intensity * 0.5; // 5 - 01
	var etw = 10 + intensity * 1; // 10 - 20
	var turns = 4 + limitedRandomInt(2); // 4 ~ 6
	var provokeEffect = function(charKey) {
		gC(charKey).combatAffinities.sex.weakness += esw;
		gC(charKey).combatAffinities.sex.strength += ess;
		if ( type != "targetNone" ) {
			gC(charKey).combatAffinities[sType].weakness += etw;
		}
	}
	var cancelEffect = function(charKey) {
		gC(charKey).combatAffinities.sex.weakness -= esw;
		gC(charKey).combatAffinities.sex.strength -= ess;
		if ( type != "targetNone" ) {
			gC(charKey).combatAffinities[sType].weakness -= etw;
		}
	}
	var description = "This character has their head filled with erotic fantasies.\n"
					+ "Increased received and provoked sex damage, specific sex-related weakness.";
	var as = new alteredState("Teased","Tsed","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	return as;
}

window.createASflaunting = function(intensity) {
	// Stats gain (phys, agil, will, perc, char) , increased sex damage
	var sgs = 3 + intensity * 0.2; // 3 ~ 5
	var sgm = 0.08 + intensity * 0.006; // 0.08 ~ 0.14
	var isd = 10 + intensity * 1; // 10 ~ 20
	var turns = 5 + limitedRandomInt(2); // 5 ~ 7
	var provokeEffect = function(charKey) {
		gC(charKey).physique.sumModifier += sgs;
		gC(charKey).physique.multModifier += sgm;
		gC(charKey).agility.sumModifier += sgs;
		gC(charKey).agility.multModifier += sgm;
		gC(charKey).will.sumModifier += sgs;
		gC(charKey).will.multModifier += sgm;
		gC(charKey).perception.sumModifier += sgs;
		gC(charKey).perception.multModifier += sgm;
		gC(charKey).charisma.sumModifier += sgs;
		gC(charKey).charisma.multModifier += sgm;
		gC(charKey).combatAffinities.sex.strength += isd;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).physique.sumModifier -= sgs;
		gC(charKey).physique.multModifier -= sgm;
		gC(charKey).agility.sumModifier -= sgs;
		gC(charKey).agility.multModifier -= sgm;
		gC(charKey).will.sumModifier -= sgs;
		gC(charKey).will.multModifier -= sgm;
		gC(charKey).perception.sumModifier -= sgs;
		gC(charKey).perception.multModifier -= sgm;
		gC(charKey).charisma.sumModifier -= sgs;
		gC(charKey).charisma.multModifier -= sgm;
		gC(charKey).combatAffinities.sex.strength -= isd;
	}
	var description = "This character is flaunting their body, intoxicating their opponents with sex appeal.\n"
					+ "Increased physique, agility, will, perception, charisma and effectiveness of sex actions.";
	var as = new alteredState("Flaunting","Flnt","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "buff";
	return as;
}

window.createASflaringFeint = function(intensity) {
	// Increased agility, will, control recovery, fire strength
	var sgs = 5 + intensity * 1.5; // 5 ~ 20
	var sgm = 0.2 + intensity * 0.02; // 0.2 ~ 0.4
	var icr = 0.1 + intensity * 0.01; // 0.1 ~ 0.2
	var ipa = 15 + intensity * 1.5; // 15 ~ 30
	var turns = 3 + limitedRandomInt(1); // 3 ~ 4
	var provokeEffect = function(charKey) {
		gC(charKey).agility.sumModifier += sgs;
		gC(charKey).agility.multModifier += sgm;
		gC(charKey).will.sumModifier += sgs;
		gC(charKey).will.multModifier += sgm;
		gC(charKey).controlRecovery += icr;
		gC(charKey).combatAffinities.fire.strength += ipa;
		gC(charKey).combatAffinities.fire.resistance += ipa;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).agility.sumModifier -= sgs;
		gC(charKey).agility.multModifier -= sgm;
		gC(charKey).will.sumModifier -= sgs;
		gC(charKey).will.multModifier -= sgm;
		gC(charKey).controlRecovery -= icr;
		gC(charKey).combatAffinities.fire.strength -= ipa;
		gC(charKey).combatAffinities.fire.resistance -= ipa;
	}
	var description = "The inner fire of this character is empowered.\n"
					+ "Increased agility, will, control recovery and fire affinity.";
	var as = new alteredState("Flaring feint","FlFn","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "buff";
	return as;
}

window.createASearthWall = function(intensity) {
	// Increased resilience and will, decreased perception, pounce, physical, magic, social resistances
	var sgs = 5 + intensity * 1.5; // 5 ~ 20
	var sgm = 0.2 + intensity * 0.4; // 0.2 ~ 0.6
	var iPr = 100 + intensity * 10; // 100 ~ 200
	var ipr = 70 + intensity * 7; // 70 ~ 140
	var imr = 20 + intensity * 2; // 20 ~ 40
	var provokeEffect = function(charKey) {
		gC(charKey).resilience.sumModifier += sgs;
		gC(charKey).resilience.multModifier += sgm;
		gC(charKey).will.sumModifier += sgs;
		gC(charKey).will.multModifier += sgm;
		gC(charKey).perception.sumModifier -= sgs;
		gC(charKey).perception.multModifier -= sgm;
		gC(charKey).combatAffinities.pounce.resistance += iPr;
		gC(charKey).combatAffinities.physical.resistance += ipr;
		gC(charKey).combatAffinities.magic.resistance += imr;
		gC(charKey).combatAffinities.social.resistance += imr;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).resilience.sumModifier -= sgs;
		gC(charKey).resilience.multModifier -= sgm;
		gC(charKey).will.sumModifier -= sgs;
		gC(charKey).will.multModifier -= sgm;
		gC(charKey).perception.sumModifier += sgs;
		gC(charKey).perception.multModifier += sgm;
		gC(charKey).combatAffinities.pounce.resistance -= iPr;
		gC(charKey).combatAffinities.physical.resistance -= ipr;
		gC(charKey).combatAffinities.magic.resistance -= imr;
		gC(charKey).combatAffinities.social.resistance -= imr;
	}
	var description = "This character is protected by earth walls.\n"
					+ "Increased resilience, will, decreased perception.\nGreatly increased pounce and physical resistances, slightly increased magical and social resistances.";
	var as = new alteredState("Earth Wall","EaWa","scene",1,provokeEffect,cancelEffect,description);
	as.type = "buff";
	return as;
}

window.createAStaintedControlRecovery = function(intensity) {
	// Control recovery reduction, agility loss (sum, mult) // Turns
	var crc = 0.1 + intensity * 0.01; // 0.1 ~ 0.2
	var turns = 4 + limitedRandomInt(2); // 4 ~ 6
	var provokeEffect = function(charKey) {
		gC(charKey).controlRecovery -= crc;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).controlRecovery += crc;
	}
	var description = "Damage in the limbs of this character has provoked a reduction in control recovery.\n"
					+ "Loss of agility, weakened control recovery, energy becomes tainted.";
	var as = new alteredState("Tainted control recovery","TCRc","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	return as;
}

// Hypnosis

window.createAShypnosisStroke = function(intensity) {
	// Will (sum,mult), perception(sum,mult), control recovery loss // Turns
	var wls = 2 + intensity * 0.2; // 2 ~ 4
	var wlm = 0.05 + intensity * 0.0005; // 0.05 ~ 1
	var pls = 2 + intensity * 0.2; // 2 ~ 4
	var plm = 0.05 + intensity * 0.0005; // 0.05 ~ 1
	var crl = 0.08 + intensity * 0.007; // 0.08 ~ 0.15
	var turns = 4 + limitedRandomInt(2); // 4 ~ 6
	
	var provokeEffect = function(charKey) {
		gC(charKey).controlRecovery -= crl;
		gC(charKey).will.sumModifier -= wls;
		gC(charKey).will.multModifier -= wlm;
		gC(charKey).perception.sumModifier -= pls;
		gC(charKey).perception.multModifier -= plm;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).controlRecovery += crl;
		gC(charKey).will.sumModifier += wls;
		gC(charKey).will.multModifier += wlm;
		gC(charKey).perception.sumModifier += pls;
		gC(charKey).perception.multModifier += plm;
	}
	var description = "This character has been confused and disoriented.\nLoss of will and perception, weakened control recovery.";
	
	var as = new alteredState("Hypnosis stroke","HySt","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	return as;
}

// Bondage

window.createASaetherialChainsArms = function(intensity) {
	// Phyisique, agility loss (sum, mult), locked arms // Turns
	var als = 3 + intensity * 0.5; // 3 ~ 8
	var alm = 0.12 + intensity * 0.012; // 0.12 ~ 0.24
	var pls = 3 + intensity * 0.5; // 3 ~ 8
	var plm = 0.12 + intensity * 0.01; // 0.12 ~ 0.2
	var turns = 4 + limitedRandomInt(1); // 4 ~ 5
	var provokeEffect = function(charKey) {
		gC(charKey).agility.sumModifier -= als;
		gC(charKey).agility.multModifier -= alm;
		gC(charKey).physique.sumModifier -= pls;
		gC(charKey).physique.multModifier -= plm;
		gC(charKey).body.arms.state = "locked";
	}
	var cancelEffect = function(charKey) {
		gC(charKey).agility.sumModifier += als;
		gC(charKey).agility.multModifier += alm;
		gC(charKey).physique.sumModifier += pls;
		gC(charKey).physique.multModifier += plm;
		gC(charKey).body.arms.state = "free";
	}
	var description = "Chains made out of aether block the movement of their arms.\n"
					+ "Arms locked, loss of phyique and agility.";
	var as = new alteredState("Chained arms","ChAr","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	return as;
}

window.createASaetChainedArms = function(intensity,days) {
	// Agility, physique loss // Days
	var sls = 2 + intensity * 0.4; // 2 - 6
	var slm = 0.08 + 0.008 * intensity; // 0.08 ~ 0.16
	var provokeEffect = function(cK) {
		gC(cK).agility.sumModifier -= this.sls;
		gC(cK).agility.multModifier -= this.slm;
		gC(cK).physique.sumModifier -= this.sls;
		gC(cK).physique.multModifier -= this.slm;
		gC(cK).body.arms.state = "locked";
	}
	var cancelEffect = function(cK) {
		gC(cK).agility.sumModifier += this.sls;
		gC(cK).agility.multModifier += this.slm;
		gC(cK).physique.sumModifier += this.sls;
		gC(cK).physique.multModifier += this.slm;
		gC(cK).body.arms.state = "free";
	}
	var description = "Aetherial chains crafted with extreme care block the movement of their arms.\n"
					+ "Arms locked, loss of physique and agility.";
	var as = new alteredState("Long-term chained arms","LCAr","days",days,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	as.sls = sls;
	as.slm = slm;
	return as;
}
window.createASaetChainedLegs = function(intensity,days) {
	// Agility, resilience loss // Days
	var sls = 2 + intensity * 0.4; // 2 - 6
	var slm = 0.08 + 0.008 * intensity; // 0.08 ~ 0.16
	var provokeEffect = function(cK) {
		gC(cK).agility.sumModifier -= this.sls;
		gC(cK).agility.multModifier -= this.slm;
		gC(cK).resilience.sumModifier -= this.sls;
		gC(cK).resilience.multModifier -= this.slm;
		gC(cK).body.legs.state = "locked";
	}
	var cancelEffect = function(cK) {
		gC(cK).agility.sumModifier += this.sls;
		gC(cK).agility.multModifier += this.slm;
		gC(cK).resilience.sumModifier += this.sls;
		gC(cK).resilience.multModifier += this.slm;
		gC(cK).body.legs.state = "free";
	}
	var description = "Aetherial chains crafted with extreme care block the movement of their legs.\n"
					+ "Arms locked, loss of resilience and agility.";
	var as = new alteredState("Long-term chained legs","LCLe","days",days,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	as.sls = sls;
	as.slm = slm;
	return as;
}
window.createASaetChainedMouth = function(intensity,days) {
	// Charisma loss // Days
	var sls = 4 + intensity * 0.8; // 4 - 12
	var slm = 0.12 + 0.024 * intensity; // 0.12 ~ 0.24
	var provokeEffect = function(cK) {
		gC(cK).charisma.sumModifier -= this.sls;
		gC(cK).charisma.multModifier -= this.slm;
		gC(cK).body.mouth.state = "locked";
	}
	var cancelEffect = function(cK) {
		gC(cK).charisma.sumModifier += this.sls;
		gC(cK).charisma.multModifier += this.slm;
		gC(cK).body.mouth.state = "free";
	}
	var description = "An aetherial gag crafted with extreme care blocks the mouth of this character.\n"
					+ "Arms locked, loss of charisma.";
	var as = new alteredState("Long-term gagged mouth","LGMo","days",days,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	as.sls = sls;
	as.slm = slm;
	return as;	
}

	// Vines

window.createASvinesLockArms = function(intensity) {
	// Agility loss (sum, mult), reduced control recovery locked arms // Turns
	var sls = 4 + intensity * 0.4; // 4 ~ 8
	var slm = 0.12 + intensity * 0.012; // 0.12 ~ 0.24
	var dcr = 0.05 + intensity * 0.01; // 0.05 ~ 0.15
	var turns = 4 + limitedRandomInt(1); // 4 ~ 5
	var provokeEffect = function(charKey) {
		gC(charKey).agility.sumModifier -= sls;
		gC(charKey).agility.multModifier -= slm;
		gC(charKey).controlRecovery -= dcr;
		gC(charKey).body.arms.state = "locked";
	}
	var cancelEffect = function(charKey) {
		gC(charKey).agility.sumModifier += sls;
		gC(charKey).agility.multModifier += slm;
		gC(charKey).controlRecovery += dcr;
		gC(charKey).body.arms.state = "free";
	}
	var description = "Vines are locking the arms of this character.\n"
					+ "Arms locked, loss of agility and control recovery.";
	var as = new alteredState("Vines Lock Arms","VnLk","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	return as;
}

window.createASvinChainedArms = function(intensity,days) {
	// Agility, physique loss // Days
	var sls = 2 + intensity * 0.4; // 2 - 6
	var slm = 0.08 + 0.008 * intensity; // 0.08 ~ 0.16
	var provokeEffect = function(cK) {
		gC(cK).agility.sumModifier -= this.sls;
		gC(cK).agility.multModifier -= this.slm;
		gC(cK).physique.sumModifier -= this.sls;
		gC(cK).physique.multModifier -= this.slm;
		gC(cK).body.arms.state = "locked";
	}
	var cancelEffect = function(cK) {
		gC(cK).agility.sumModifier += this.sls;
		gC(cK).agility.multModifier += this.slm;
		gC(cK).physique.sumModifier += this.sls;
		gC(cK).physique.multModifier += this.slm;
		gC(cK).body.arms.state = "free";
	}
	var description = "Extremely resilient vines block the movement of their arms.\n"
					+ "Arms locked, loss of physique and agility.";
	var as = new alteredState("Long-term vined arms","LVAr","days",days,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	as.sls = sls;
	as.slm = slm;
	return as;
}
window.createASvinChainedLegs = function(intensity,days) {
	// Agility, resilience loss // Days
	var sls = 2 + intensity * 0.4; // 2 - 6
	var slm = 0.08 + 0.008 * intensity; // 0.08 ~ 0.16
	var provokeEffect = function(cK) {
		gC(cK).agility.sumModifier -= this.sls;
		gC(cK).agility.multModifier -= this.slm;
		gC(cK).resilience.sumModifier -= this.sls;
		gC(cK).resilience.multModifier -= this.slm;
		gC(cK).body.legs.state = "locked";
	}
	var cancelEffect = function(cK) {
		gC(cK).agility.sumModifier += this.sls;
		gC(cK).agility.multModifier += this.slm;
		gC(cK).resilience.sumModifier += this.sls;
		gC(cK).resilience.multModifier += this.slm;
		gC(cK).body.legs.state = "free";
	}
	var description = "Extremely resilient vines block the movement of their legs.\n"
					+ "Arms locked, loss of resilience and agility.";
	var as = new alteredState("Long-term vined legs","LVAr","days",days,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	as.sls = sls;
	as.slm = slm;
	return as;
}
window.createASvinChainedMouth = function(intensity,days) {
	// Charisma loss // Days
	var sls = 4 + intensity * 0.8; // 4 - 12
	var slm = 0.12 + 0.024 * intensity; // 0.12 ~ 0.24
	var provokeEffect = function(cK) {
		gC(cK).charisma.sumModifier -= this.sls;
		gC(cK).charisma.multModifier -= this.slm;
		gC(cK).body.mouth.state = "locked";
	}
	var cancelEffect = function(cK) {
		gC(cK).charisma.sumModifier += this.sls;
		gC(cK).charisma.multModifier += this.slm;
		gC(cK).body.mouth.state = "free";
	}
	var description = "Extremely resilient vines block the mouth of this character.\n"
					+ "Mouth locked, loss of charisma.";
	var as = new alteredState("Long-term vine-gagged mouth","LVMo","days",days,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	as.sls = sls;
	as.slm = slm;
	return as;	
}

// Pain

window.createASscratched = function(intensity) {
	// Extra energy cost, extra pain damage, agility loss (sum, mult) // Turns
	var eec = 5 + intensity * 1; // 5 ~ 15
	var als = 2 + intensity * 0.2; // 2 ~ 4
	var alm = 0.05 + intensity * 0.005; // 0.05 ~ 0.1
	var epd = 8 + intensity * 0.8; // 0.08 ~ 0.16
	var turns = 4 + limitedRandomInt(1); // 4 ~ 5
	var provokeEffect = function(charKey) {
		gC(charKey).energy.tainted += eec;
		gC(charKey).agility.sumModifier -= als;
		gC(charKey).agility.multModifier -= alm;
		gC(charKey).combatAffinities.pain.weakness += epd;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).energy.tainted -= eec;
		gC(charKey).agility.sumModifier += als;
		gC(charKey).agility.multModifier += alm;
		gC(charKey).combatAffinities.pain.weakness -= epd;
	}
	var description = "This character has the mark of a scratch causing pain in their skin.\n"
					+ "Loss of agility, receives extra pain damage, energy becomes tainted.";
	var as = new alteredState("Scratched","Scra","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	return as;
}

// Animal aspects

window.createAScatAspect = function(intensity) {
	// Increased agility, perception, control recovery
	var sgs = 4 + intensity * 0.8; // 4 ~ 12
	var sgm = 0.12 + intensity * 0.012; // 0.12 ~ 0.24
	var icr = 0.1 + intensity * 0.01; // 0.1 ~ 0.2
	var ipa = 3 + intensity * 0.7; // 3 ~ 10
	var turns = 5 + limitedRandomInt(2); // 5 ~ 7
	var provokeEffect = function(charKey) {
		gC(charKey).agility.sumModifier += sgs;
		gC(charKey).agility.multModifier += sgm;
		gC(charKey).perception.sumModifier += sgs;
		gC(charKey).perception.multModifier += sgm;
		gC(charKey).controlRecovery += icr;
		gC(charKey).combatAffinities.pounce.strength += ipa;
		gC(charKey).combatAffinities.pounce.resistance += ipa;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).agility.sumModifier -= sgs;
		gC(charKey).agility.multModifier -= sgm;
		gC(charKey).perception.sumModifier -= sgs;
		gC(charKey).perception.multModifier -= sgm;
		gC(charKey).controlRecovery -= icr;
		gC(charKey).combatAffinities.pounce.strength -= ipa;
		gC(charKey).combatAffinities.pounce.resistance -= ipa;
	}
	var description = "This character is channeling a cat spirit, gaining physical capabilities.\n"
					+ "Increased agility, perception, control recovery and pounce affinity.";
	var as = new alteredState("Cat Aspect","CaAs","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "buff";
	return as;
}

// Transformations

window.createASborrowedIdentity = function(intensity, target) {
	// Stats gain , borrowed images
	var sgs = 2 + intensity * 0.8; // 2 ~ 10
	var sgm = 0.05 + intensity * 0.010; // 0.05 ~ 0.15
	var turns = 4; // 4
	var provokeEffect = function(charKey) {
		gC(charKey).charisma.sumModifier += sgs;
		gC(charKey).charisma.multModifier += sgm;
		gC(charKey).originalPortrait = gC(charKey).fullPortrait;
		gC(charKey).originalAvatar = gC(charKey).avatar;
		gC(charKey).fullPortrait = gC(target).fullPortrait;
		gC(charKey).avatar = gC(target).avatar;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).charisma.sumModifier -= sgs;
		gC(charKey).charisma.multModifier -= sgm;
		gC(charKey).fullPortrait = gC(charKey).originalPortrait;
		gC(charKey).avatar = gC(charKey).originalAvatar;
		gC(charKey).originalAvatar = null;
		gC(charKey).originalPortrait = null;
	}
	var description = "This character has stolen the identity of someone else.\n"
					+ "Increased charisma.";
	var as = new alteredState("Borrowed identity","BoId","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "buff";
	return as;
}

window.createASconfusedIdentities = function(intensity) {
	// Stats loss
	var sls = 5 + intensity * 0.5; // 5 ~ 10
	var slm = 0.1 + intensity * 0.01; // 0.1 ~ 0.20
	var turns = 4; // 4
	var provokeEffect = function(charKey) {
		gC(charKey).perception.sumModifier -= sls;
		gC(charKey).perception.multModifier -= slm;
		gC(charKey).empathy.sumModifier -= sls;
		gC(charKey).empathy.multModifier -= slm;
		gC(charKey).charisma.sumModifier -= sls;
		gC(charKey).charisma.multModifier -= slm;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).perception.sumModifier += sls;
		gC(charKey).perception.multModifier += slm;
		gC(charKey).empathy.sumModifier += sls;
		gC(charKey).empathy.multModifier += slm;
		gC(charKey).charisma.sumModifier += sls;
		gC(charKey).charisma.multModifier += slm;
	}
	var description = "This character has lost track of their enemies.\n"
					+ "Decreased perception, empathy, charisma.";
	var as = new alteredState("Confused identities","CoId","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	return as;
}

// Slime

window.createASslimed = function(intensity) {
	// Stats loss, lead recovery rate
	var sls = 5 + intensity * 0.5; // 5 ~ 10
	var slm = 0.05 + intensity * 0.015; // 0.05 ~ 0.15
	//var lrl = 0.15 + intensity * 0.015; // 0.15 ~ 0.3
	var turns = 3.5 + intensity * 0.2 + (limitedRandomInt(100) / 100); // 5 ~ 7
	var provokeEffect = function(charKey) {
		gC(charKey).agility.sumModifier -= sls;
		gC(charKey).agility.multModifier -= slm;
		//gC(charKey).leadMultiplier -= lrl;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).agility.sumModifier += sls;
		gC(charKey).agility.multModifier += slm;
		//gC(charKey).leadMultiplier += lrl;
	}
	var description = "This character has slime surrounding their body, limiting their mobility.\n"
					+ "Decreased agility.";
	var as = new alteredState("Slimed","Slmd","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	return as;
}

// Spores

window.createASrelaxingScent = function(intensity) {
	// Stats loss
	var sls = 2 + intensity * 0.3; // 2 ~ 5
	var slm = 0.04 + intensity * 0.004; // 0.05 ~ 0.10
	var turns = 4 + limitedRandomInt(1); // 4 ~ 5
	if ( intensity > 5 ) { turns++; } // ~ - 6
	var provokeEffect = function(charKey) {
		gC(charKey).physique.sumModifier -= sls;
		gC(charKey).physique.multModifier -= slm;
		gC(charKey).agility.sumModifier -= sls;
		gC(charKey).agility.multModifier -= slm;
		gC(charKey).perception.sumModifier -= sls;
		gC(charKey).perception.multModifier -= slm;
		gC(charKey).will.sumModifier -= sls;
		gC(charKey).will.multModifier -= slm;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).physique.sumModifier += sls;
		gC(charKey).physique.multModifier += slm;
		gC(charKey).agility.sumModifier += sls;
		gC(charKey).agility.multModifier += slm;
		gC(charKey).perception.sumModifier += sls;
		gC(charKey).perception.multModifier += slm;
		gC(charKey).will.sumModifier += sls;
		gC(charKey).will.multModifier += slm;
	}
	var description = "This character is feeling groggy.\n"
					+ "Decreased physique, agility, perception and will.";
	var as = new alteredState("Relaxing scent","RlSc","scene",turns,provokeEffect,cancelEffect,description);
	as.type = "debuff";
	return as;
}


		// Bondage

// Freed bodypart - Temporary customizable state. A bodypart gets unlocked for the duration of the scene
window.createUnlockedBodypartForScene = function(bodypart) {
	var provokeEffect = function(charKey) {
		this.endState = gC(charKey).body[this.bodypart].state;
		gC(charKey).body[this.bodypart].state = "free";
	}
	var cancelEffect = function(charKey) {
		gC(charKey).body[this.bodypart].state = this.endState;
	}
	var description = `The ${bodypart} of this character has been freed for this scene.`;
	var as = new alteredState(`Unlocked ${bodypart}`,"UnBp","scene",-1,provokeEffect,cancelEffect,description);
	as.bodypart = bodypart;
	as.endState = "free";
	as.type = "other";
	return as;
}

window.createUnlockedBodypartForTheDay = function(bodypart) {
	var provokeEffect = function(charKey) {
		this.endState = gC(charKey).body[this.bodypart].state;
		gC(charKey).body[this.bodypart].state = "free";
	}
	var cancelEffect = function(charKey) {
		gC(charKey).body[this.bodypart].state = this.endState;
	}
	var description = `The ${bodypart} of this character has been freed for this day.`;
	var as = new alteredState(`Unlocked ${bodypart}`,"UnBp","days",1,provokeEffect,cancelEffect,description);
	as.bodypart = bodypart;
	as.endState = "free";
	as.type = "other";
	return as;
}
		
// Nipplesuckers
window.createASnipplesuckers = function() {
	var nofunc = function() {
		return 0;
	}
	var description = "The nipple suckers attached to this character activate when aether starts moving.\n"
					+ "Lust damage received every turn.";
	var as = new alteredState("Nipple suckers","Npsk","equipment",-1,nofunc,nofunc,description);
	as.type = "debuff";
	as.turnEffect = function(character) {
		var description = "";
		var damage = 0.7;
		gC(character).lust.attack(-damage);
		description = "The nipple suckers are stimulating " + gC(character).getFormattedName() + "'s " + boobsWord() + " for " + textLustDamage(damage) + ".";
		return description;
	}
	return as;
}
		
// Buttplug
window.createASbuttplug = function() {
	var nofunc = function() {
		return 0;
	}
	var description = "The buttplug inserted in this character vibrates when aether starts moving.\n"
					+ "Lust damage received every turn.";
	var as = new alteredState("Buttplug","Btpg","equipment",-1,nofunc,nofunc,description);
	as.type = "debuff";
	as.turnEffect = function(character) {
		var description = "";
		var damage = 0.7;
		gC(character).lust.attack(-damage);
		description = "The buttplug is massaging " + gC(character).getFormattedName() + "'s " + assWord() + " for " + textLustDamage(damage) + ".";
		return description;
	}
	return as;
}




// Transformations
window.createFinishedTransformationAs = function(days,tfTypes) {
	State.variables.logL1.push(3);
	var provokeEffect = function(charKey) {
	}
	var cancelEffect = function(charKey) {
		tfASendEffects(charKey,this);
	}
	var description = "This character has been temporarily transformed.";
	var as = new alteredState("Transformed","Tfmd","days",days,provokeEffect,cancelEffect,description);
		// tfTypes
	as.tfTypes = [];
	for ( var tfGoal of State.variables.sc.tfGoals ) {
		switch (tfGoal) {
			case "addDick":
				if ( State.variables.sc.tfPermanentFlag != true ) {
					as.tfTypes.push("addDick");
				}
				break;
			case "addPussy":
				if ( State.variables.sc.tfPermanentFlag != true ) {
					as.tfTypes.push("addPussy");
				}
				break;
			case "removeDick":
				if ( State.variables.sc.tfPermanentFlag != true ) {
					as.tfTypes.push("removeDick");
				}
				break;
			case "removePussy":
				if ( State.variables.sc.tfPermanentFlag != true ) {
					as.tfTypes.push("removePussy");
				}
				break;
			case "rebuildFace":
				if ( State.variables.sc.hasOwnProperty("newPortraitFileName") ) {
					as.tfTypes.push("rebuildFigure");
				}
				if ( (State.variables.sc.genderChange == "feminize" || State.variables.sc.genderChange == "masculinize") ) {
					as.tfTypes.push("changedGender");
				}
				break;
		}
	}	
	as.remainingDays = days;
	as.type = "tf";
	return as;
}
	// Valid tfTypes: addDick, addPussy, removeDick, removePussy, rebuildFigure, changedGender

// Events and story
window.createFrozenPussy = function() {
	var provokeEffect = function(charKey) {
		gC(charKey).energy.tainted += 10;
		gC(charKey).controlRecovery -= 0.08;
		gC(charKey).agility.sumModifier -= 5;
		gC(charKey).agility.multModifier -= 0.1;
		gC(charKey).body.pussy.state = "locked";
	}
	var cancelEffect = function(charKey) {
		gC(charKey).energy.tainted -= 10;
		gC(charKey).controlRecovery += 0.08;
		gC(charKey).agility.sumModifier += 5;
		gC(charKey).agility.multModifier += 0.1;
		gC(charKey).body.pussy.state = "free";
	}
	var description = "A terrible cold has provoked the pussy of this character to turn rigid and frozen.";
	var as = new alteredState("Frozen pussy","FrPu","days",1,provokeEffect,cancelEffect,description);
	as.type = "other";
	return as;
}

window.createInjury = function() {
	var provokeEffect = function(charKey) {
		gC(charKey).energy.tainted += 20;
		gC(charKey).controlRecovery -= 0.1;
		gC(charKey).agility.sumModifier -= 3;
		gC(charKey).agility.multModifier -= 0.2;
		gC(charKey).physique.sumModifier -= 2;
		gC(charKey).physique.multModifier -= 0.1;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).energy.tainted -= 20;
		gC(charKey).controlRecovery += 0.1;
		gC(charKey).agility.sumModifier += 3;
		gC(charKey).agility.multModifier += 0.2;
		gC(charKey).physique.sumModifier += 2;
		gC(charKey).physique.multModifier += 0.1;
	}
	var description = "Physical damage has injured the body of this character, and it needs some time to get recovered.";
	var as = new alteredState("Injury","Injr","days",1,provokeEffect,cancelEffect,description);
	as.type = "other";
	return as;
}

window.createHypnosisResistanceBoon = function() {
	var provokeEffect = function(charKey) {
		gC(charKey).will.sumModifier += 5;
		gC(charKey).combatAffinities.hypnosis.resistance += 50;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).will.sumModifier -= 5;
		gC(charKey).will.value -= 2;
		gC(charKey).combatAffinities.hypnosis.resistance -= 50;
		gC(charKey).combatAffinities.hypnosis.weakness += 20;
	}
	var description = "This character has been booned with higher willpower, raising their will and their resistance to hypnosis attacks. A reverse effect may take place when it ends.";
	var as = new alteredState("Hypnosis Resistance","HyRe","days",5,provokeEffect,cancelEffect,description);
	as.type = "other";
	return as;
}

// Maps
window.createHeatedBath = function(intensity) {
	// Percentual stats gain (phy, agi, res) and affinities, lasts for one day
	var psg = 0.3;
	var afg = 0.2;
	var provokeEffect = function(charKey) {
		gC(charKey).physique.multModifier += 0.3;
		gC(charKey).resilience.multModifier += 0.3;
		gC(charKey).agility.multModifier += 0.3;
		gC(charKey).physique.affinity += 0.2;
		gC(charKey).resilience.affinity += 0.2;
		gC(charKey).agility.affinity += 0.2;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).physique.multModifier -= 0.3;
		gC(charKey).resilience.multModifier -= 0.3;
		gC(charKey).agility.multModifier -= 0.3;
		gC(charKey).physique.affinity -= 0.2;
		gC(charKey).resilience.affinity -= 0.2;
		gC(charKey).agility.affinity -= 0.2;
	}
	var description = "This character has taken a hot bath, relieving the pressure in their muscles.\n"
					+ "Increased multiplier and affinities for physique, agility and resilience.";
	var as = new alteredState("Heated bath","HeBa","days",1,provokeEffect,cancelEffect,description);
	as.remainingDays = 1;
	as.type = "dayBuff";
	return as;
}

window.createFrozenBath = function(intensity) {
	// Percentual stats gain (int, wll, per) and affinities, lasts for one day
	var psg = 0.3;
	var afg = 0.2;
	var provokeEffect = function(charKey) {
		gC(charKey).intelligence.multModifier += 0.3;
		gC(charKey).will.multModifier += 0.3;
		gC(charKey).perception.multModifier += 0.3;
		gC(charKey).intelligence.affinity += 0.2;
		gC(charKey).will.affinity += 0.2;
		gC(charKey).perception.affinity += 0.2;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).intelligence.multModifier -= 0.3;
		gC(charKey).will.multModifier -= 0.3;
		gC(charKey).perception.multModifier -= 0.3;
		gC(charKey).intelligence.affinity -= 0.2;
		gC(charKey).will.affinity -= 0.2;
		gC(charKey).perception.affinity -= 0.2;
	}
	var description = "This character has taken a frozen bath, forcing their mind to stay alert.\n"
					+ "Increased multiplier and affinities for intelligence, perception and will.";
	var as = new alteredState("Frozen bath","FrBa","days",1,provokeEffect,cancelEffect,description);
	as.remainingDays = 1;
	as.type = "dayBuff";
	return as;
}

window.createPublicBath = function(intensity) {
	// Percentual stats gain (cha, emp, lck) and affinities, lasts for one day
	var psg = 0.3;
	var afg = 0.2;
	var provokeEffect = function(charKey) {
		gC(charKey).charisma.multModifier += 0.3;
		gC(charKey).empathy.multModifier += 0.3;
		gC(charKey).luck.multModifier += 0.3;
		gC(charKey).charisma.affinity += 0.2;
		gC(charKey).empathy.affinity += 0.2;
		gC(charKey).luck.affinity += 0.2;
	}
	var cancelEffect = function(charKey) {
		gC(charKey).charisma.multModifier -= 0.3;
		gC(charKey).empathy.multModifier -= 0.3;
		gC(charKey).luck.multModifier -= 0.3;
		gC(charKey).charisma.affinity -= 0.2;
		gC(charKey).empathy.affinity -= 0.2;
		gC(charKey).luck.affinity -= 0.2;
	}
	var description = "This character has taken a bath in public, letting go of their shame.\n"
					+ "Increased multiplier and affinities for charisma, empathy and luck.";
	var as = new alteredState("Public bath","PuBa","days",1,provokeEffect,cancelEffect,description);
	as.remainingDays = 1;
	as.type = "dayBuff";
	return as;
}


///// BATTLE POSITIONS /////

	// Pounces

window.createBcaNeutralPounce = function(initiator,targetsList) {
	var ca = new continuedAction();
	ca.key = "mounting";
	ca.name = "Mounting";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.affinities = [];
	
	ca.execute = function() {
		var results = new saResults;
		var actor = this.initiator;
		var target = this.targetsList[0];
		
		results.value = 0;
				
		results.description += randomFromList( [
								(ktn(initiator) + " is holding " + ktn(target) + " in place."),
								(ktn(initiator) + " has mounted " + ktn(target) + " and won't let " + gC(target).comPr + " go."),
								(ktn(initiator) + " has trapped " + ktn(target) + " under " + gC(initiator).posPr + " weight.")
									] );
		
		return results;
	}	
	return ca;
}

window.createBposFrontalPounce = function(initiator, targetsList) {
	var target = targetsList[0];
	
	gC(initiator).position.makeActive(targetsList);
	gC(initiator).position.key = "frontalPounce";
	gC(initiator).position.name = "Mounting face to face";
	gC(initiator).position.description = ktn(initiator) + " is holding " + ktn(target) + randomFromList([" from above."," face to face."]);
	
	gC(initiator).position.cAction = createBcaNeutralPounce(initiator,targetsList);
	
	gC(target).position.makePassive(initiator);
	gC(target).position.key = "frontalPouncedD2P";
	gC(target).position.name = "Being mounted face to face";
	gC(target).position.description = ktn(initiator) + " is holding " + ktn(target) + randomFromList([" from above."," face to face."]);
}

window.createBcaD2Ppounce = function(initiator,targetsList) {
	var ca = new continuedAction();
	ca.key = "baPenetratePussy";
	ca.name = "Penetrating pussy";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "dick" ];
	ca.targetsBodyparts = [ "pussy" ];
	ca.occupyBodyparts();
	ca.affinities = [];
	
	ca.execute = function() {
		var results = new saResults;
		var actor = this.initiator;
		var target = this.targetsList[0];
		
		// Damage to target
		var actAffinities = ["sex","useDick","targetPussy"];
		var inDamValue = gCstat(actor,"physique") * 0.1 + gCstat(actor,"resilience") * 0.1;
		inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
		var damage = calculateAttackEffects("lust",actor,target,actAffinities,inDamValue);
		// Damage to actor
		var tarAffinities = ["sex","usePussy","targetDick"];
		var inDamValue2 = gCstat(target,"physique") * 0.04 + gCstat(target,"resilience") * 0.04;
		inDamValue2 = addLuckFactor(inDamValue2,0.1,gCstat(actor,"luck"));
		var damage2 = calculateAttackEffects("lust",target,actor,tarAffinities,inDamValue2);
		
		/*
		// Submissive loss of willpower
		if ( gC(target).hasLead == false && gC(target).position.key == "mountedFromBehind" ) {
			var exWillpowerDamage = (gC(this.initiator).will.getValue() / gC(target).will.getValue()) * 1;
			gC(target).willpower.changeValue(-exWillpowerDamage);
			results.description += ktn(target) + "'s submissive position made " + gC(target).comPr + " receive " + textWillpowerDamage(exWillpowerDamage) + ".";
		}
		*/
		
		// Apply effects
		gC(target).lust.attack(-damage);
		gC(actor).lust.attack(-damage2);
		results.value += damage;
				
		results.description += randomFromList( [
								(ktn(initiator) + " keeps penetrating " + ktn(target) + "'s " + pussyWord() + "."),
								(ktn(initiator) + " is fucking " + ktn(target) + "."),
								(ktn(target) + " is held by " + ktn(initiator) + " as " + gC(initiator).perPr + " fucks " + gC(target).comPr + ".")
									] );
		results.description += " " + ktn(target) + " received " + textLustDamage(damage) + ". ";
		results.description += ktn(initiator) + " received " + textLustDamage(damage2) + ". ";
		
		return results;
	}	
	return ca;
}

window.createBposDP2frontalPounce = function(initiator, targetsList) {
	var target = targetsList[0];
	
	gC(initiator).position.makeActive(targetsList);
	gC(initiator).position.key = "frontalPounceD2P";
	gC(initiator).position.name = "Mounting face to face";
	gC(initiator).position.description = ktn(initiator) + " is holding " + ktn(target) + randomFromList([" from above."," face to face."]);
	
	gC(initiator).position.cAction = createBcaD2Ppounce(initiator,targetsList);
	
	gC(target).position.makePassive(initiator);
	gC(target).position.key = "frontalPouncedD2P";
	gC(target).position.name = "Being mounted face to face";
	gC(target).position.description = ktn(initiator) + " is holding " + ktn(target) + randomFromList([" from above."," face to face."]);
}

window.createBcaP2Ppounce = function(initiator,targetsList) {
	var ca = new continuedAction();
	ca.key = "baScissoring";
	ca.name = "Scissoring";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "pussy" ];
	ca.targetsBodyparts = [ "pussy" ];
	ca.occupyBodyparts();
	ca.affinities = [];
	
	ca.execute = function() {
		var results = new saResults;
		var actor = this.initiator;
		var target = this.targetsList[0];
		
		// Damage to target
		var actAffinities = ["sex","usePussy","targetPussy"];
		var inDamValue = gCstat(actor,"physique") * 0.1 + gCstat(actor,"resilience") * 0.1;
		inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
		var damage = calculateAttackEffects("lust",actor,target,actAffinities,inDamValue);
		// Damage to actor
		var tarAffinities = ["sex","usePussy","targetPussy"];
		var inDamValue2 = gCstat(target,"physique") * 0.04 + gCstat(target,"resilience") * 0.04;
		inDamValue2 = addLuckFactor(inDamValue2,0.1,gCstat(actor,"luck"));
		var damage2 = calculateAttackEffects("lust",target,actor,tarAffinities,inDamValue2);
				
		// Apply effects
		gC(target).lust.attack(-damage);
		gC(actor).lust.attack(-damage2);
		results.value += damage;
				
		results.description += randomFromList( [
								(ktn(initiator) + " keeps rubbing herself against " + ktn(target) + "'s " + pussyWord() + "."),
								(ktn(initiator) + " is fucking " + ktn(target) + "."),
								(ktn(target) + " is held by " + ktn(initiator) + " and " + gC(initiator).posPr + " " + pussyWord() + " frotted.")
									] );
		results.description += " " + ktn(target) + " received " + textLustDamage(damage) + ". ";
		results.description += ktn(initiator) + " received " + textLustDamage(damage2) + ". ";
		
		return results;
	}	
	return ca;
}

window.createBposP2PfrontalPounce = function(initiator, targetsList) {
	var target = targetsList[0];
	
	gC(initiator).position.makeActive(targetsList);
	gC(initiator).position.key = "frontalPounceP2P";
	gC(initiator).position.name = "Mounting face to face";
	gC(initiator).position.description = ktn(initiator) + " is holding " + ktn(target) + randomFromList([" from above."," face to face."]);
	
	gC(initiator).position.cAction = createBcaP2Ppounce(initiator,targetsList);
	
	gC(target).position.makePassive(initiator);
	gC(target).position.key = "frontalPouncedP2P";
	gC(target).position.name = "Being mounted face to face";
	gC(target).position.description = ktn(initiator) + " is holding " + ktn(target) + randomFromList([" from above."," face to face."]);
}

window.createBcaP2Dpounce = function(initiator,targetsList) {
	var ca = new continuedAction();
	ca.key = "baRidingDick";
	ca.name = "Riding dick";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "pussy" ];
	ca.targetsBodyparts = [ "dick" ];
	ca.occupyBodyparts();
	ca.affinities = [];
	
	ca.execute = function() {
		var results = new saResults;
		var actor = this.initiator;
		var target = this.targetsList[0];
		
		// Damage to target
		var actAffinities = ["sex","usePussy","targetDick"];
		var inDamValue = gCstat(actor,"physique") * 0.1 + gCstat(actor,"resilience") * 0.1;
		inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
		var damage = calculateAttackEffects("lust",actor,target,actAffinities,inDamValue);
		// Damage to actor
		var tarAffinities = ["sex","useDick","targetPussy"];
		var inDamValue2 = gCstat(target,"physique") * 0.04 + gCstat(target,"resilience") * 0.04;
		inDamValue2 = addLuckFactor(inDamValue2,0.1,gCstat(actor,"luck"));
		var damage2 = calculateAttackEffects("lust",target,actor,tarAffinities,inDamValue2);
		
		/*
		// Submissive loss of willpower
		if ( gC(target).hasLead == false && gC(target).position.key == "mountedFromBehind" ) {
			var exWillpowerDamage = (gC(this.initiator).will.getValue() / gC(target).will.getValue()) * 1;
			gC(target).willpower.changeValue(-exWillpowerDamage);
			results.description += ktn(target) + "'s submissive position made " + gC(target).comPr + " receive " + textWillpowerDamage(exWillpowerDamage) + ".";
		}
		*/
		
		// Apply effects
		gC(target).lust.attack(-damage);
		gC(actor).lust.attack(-damage2);
		results.value += damage;
				
		results.description += randomFromList( [
								(ktn(initiator) + " rubs " + gC(initiator).posPr + " hips all around " + ktn(target) + "'s, sending shivers down both of their spines."),
								(ktn(initiator) + " keeps riding " + ktn(target) + "'s " + dickWord() + "."),
								(ktn(initiator) + " moves up and down along " + ktn(target) + "'s " + dickWord() + ", " + ktn(target) + " locked between " + gC(initiator).posPr + " legs.")
									] );
		results.description += " " + ktn(target) + " received " + textLustDamage(damage) + ". ";
		results.description += ktn(initiator) + " received " + textLustDamage(damage2) + ". ";
		
		return results;
	}	
	return ca;
}

window.createBposP2DfrontalPounce = function(initiator, targetsList) {
	var target = targetsList[0];
	
	gC(initiator).position.makeActive(targetsList);
	gC(initiator).position.key = "frontalPounceP2D";
	gC(initiator).position.name = "Mounting from above";
	gC(initiator).position.description = ktn(initiator) + " is holding " + ktn(target) + " below " + gC(initiator).posPr + " legs.";
	
	gC(initiator).position.cAction = createBcaP2Dpounce(initiator,targetsList);
	
	gC(target).position.makePassive(initiator);
	gC(target).position.key = "frontalPouncedP2D";
	gC(target).position.name = "Being mounted from above";
	gC(target).position.description = ktn(initiator) + " is holding " + ktn(target) + " below " + gC(initiator).posPr + " legs.";
}

	// Weapons
	
		// Secondary continued actions
window.createCaBaDildoPenetratePussy = function(initiator, targetsList) {
	var ca = new continuedAction();
	ca.key = "baDildoPenetratePussy";
	ca.name = "Dildo-Pussy penetration";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "arms" ];
	ca.targetsBodyparts = [ "pussy" ];
	ca.occupyBodyparts();
	ca.rank = 1;
	ca.affinities = ["targetPussy","sex"];
	ca.flavorTags = ["targetPussy","top","continuedAction"];
	ca.tags = ["activePosition"];
	ca.flagUsingWeapon = true;
	
	ca.execute = function() {
		var results = new saResults;
		var actor = ca.initiator;
		var target = targetsList[0];
		
		// Damage to target
		var actAffinities = ["sex","targetPussy"];
		var inDamValue = gCstat(actor,"physique") * 0.1 + gCstat(actor,"agility") * 0.1 - gCstat(target,"resilience") * 0.05;
		inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
		var lustDamage = calculateAttackEffects("lust",actor,target,actAffinities,inDamValue);
		
		// Apply effects
		gC(target).lust.attack(-lustDamage);
		
		results.value += lustDamage;
		results.description += randomFromList( [
								(ktn(initiator) + "'s dildo continues pleasuring " + ktn(target) + "'s insides."),
								(ktn(initiator) + " keeps penetrating " + ktn(target) + "'s " + pussyWord() + " with " + gC(initiator).posPr + " dildo."),
								(ktn(initiator) + " is fucking " + ktn(target) + " with " + gC(initiator).posPr + " dildo.") ] );
		results.description += " " + ktn(target) + " received " + textLustDamage(lustDamage) + ". "
		
		return results;
	}	
	return ca;
}

	// Others

window.createBposMakeKneel = function(initiator, targetsList) {
	var target = targetsList[0];
	
	gC(initiator).position.makeActive(targetsList);
	gC(initiator).position.key = "makeKneel";
	gC(initiator).position.name = "Making kneel";
	gC(initiator).position.description = ktn(target) + "'s cannot defy " + ktn(initiator) + "'s authority, and remains in " + gC(target).posPr + " knees.";
	
	gC(initiator).position.cAction = createBcaMakingKneel(initiator,targetsList);
	
	gC(target).position.makePassive(initiator);
	gC(target).position.key = "madeKneel";
	gC(target).position.name = "Being made to kneel";
	gC(initiator).position.description = ktn(target) + "'s cannot defy " + ktn(initiator) + "'s authority, and remains in " + gC(target).posPr + " knees.";
}

window.createBcaMakingKneel = function(initiator,targetsList) {
	var ca = new continuedAction();
	ca.key = "baMakingKneel";
	ca.name = "Making Kneel";
	ca.initiator = initiator;
	ca.targetsList = targetsList;
	ca.initiatorBodyparts = [ "eyes" ];
	ca.targetsBodyparts = [ "eyes" ];
	ca.occupyBodyparts();
	ca.affinities = ["hypnosis"];
	
	ca.execute = function() {
		var results = new saResults;
		var actor = this.initiator;
		var target = this.targetsList[0];
		
		// Damage to target
		var actAffinities = ["hypnosis","useEyes","targetEyes"];
		var inDamValue = gCstat(actor,"will") * 0.1 + gCstat(actor,"charisma") * 0.1;
		inDamValue = addLuckFactor(inDamValue,0.1,gCstat(actor,"luck"));
		var damage = calculateAttackEffects("willpower",actor,target,actAffinities,inDamValue);
		
		// Apply effects
		var overflowMsg = applyBarDamage(target,"willpower",-damage);
		results.value += damage;
				
		results.description += randomFromList( [
								(ktn(initiator) + " keeps " + gC(initiator).posPr + " eyes locked on " + ktn(target) + "'s, depriving " + gC(target).comPr + " of the freedom to stand up."),
								(ktn(initiator) + " keeps " + gC(initiator).posPr + " grip on " + ktn(target) + "'s mind, locking " + gC(target).comPr + " on " + gC(target).posPr + " knees."),
								(ktn(target) + " finds " + gC(target).refPr + " lost in the labyrinth of " + ktn(initiator) + "'s hypnotic clutch.")
									] );
		results.description += " " + ktn(target) + " received " + textWillpowerDamage(damage) + ". " + overflowMsg;
		
		return results;
	}	
	return ca;
}

////////// Battle demands //////////

	// Battle demand class
window.battleDemand = function(title) {
	this.title = title;
	this.subtitle = ""; // Additional explanation in the form of a tooltip
	
	this.isPossible = function(actor,target,battleWeight) {
		return false;
	}
	this.calculateInfamy = function(actor,target,battleWeight,infamyMultiplier ) {
		return 0;
	}
	this.generateDescription = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		return "noDescription";
	}
	this.provokeEffect = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		return 1;
	}
	this.resultMessage = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		return "noResultMessage";
	}
	this.getFormattedPlayerChoice = function(actor,target,stakes,infamyMultiplier,i) {
		var cText = "<<l" + "ink [[" + this.title + "|Scene Results]]>><<s" + "cript>>\n";
			cText += "setup.battleDemandsDB[" + i + "].provokeEffect('chPlayerCharacter','" + target + "'," + stakes + "," + infamyMultiplier + ",'','');\n";
			cText += "formatGenericBattlePlayerChoice(setup.battleDemandsDB[" + i + "].resultMessage('chPlayerCharacter','" + target + "'," + stakes + "," + infamyMultiplier + ",'',''),setup.battleDemandsDB[" + i + "].getPassageLink('" + actor + "','" + target + "'));\n";
			cText += "<</s" + "cript>><</l" + "ink>>" + this.subtitle + "\n";
		return cText;
	}
	this.getPassageLink = function(actor,target) {
		return "Map";
	}

	this.generateChoicesValuesForNpcs = function(actor,target,battleWeight,infamyMultiplier) {
		var extra1 = "";
		var extra2 = "";
		return [getBattleDemandChoiceValueNpc(-10,this,extra1,extra2)];
	}
}

window.getBattleDemandChoiceValueNpc = function(decisionValue,choiceDemand,extra1,extra2) {
	return [decisionValue,choiceDemand,extra1,extra2];
}

// Battle demands specifics

// Constructors, serializers, etc.
battleDemand.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
battleDemand.prototype.clone = function () {
	return (new battleDemand())._init(this);
};
battleDemand.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new battleDemand())._init($ReviveData$)', ownData);
};

////////// Battle Demands Database //////////
window.createBdemandDoNothing = function() {
	var bDemand = new battleDemand("Do nothing");
	var tooltip = "Renounce to your right to demand anything out of this battle.";
	bDemand.subtitle += '<span title="' + tooltip + '">(?)</span>';

	bDemand.isPossible = function(actor,target,battleWeight) {
		var isPossible = true;
		return isPossible;
	}
	bDemand.calculateInfamy = function(actor,target,battleWeight,infamyMultiplier ) {
		var infamy = 0;
		return infamy;
	}
	bDemand.generateDescription = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		return "noDescription";
	}
	bDemand.provokeEffect = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		// Infamy
		var infamyChange = -1;
		gC(actor).changeInfamy(infamyChange);
		// Relation changes
		getRelation(target,actor).enmity.stv -= 25;
		return 1;
	}
	bDemand.resultMessage = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		var infamyChange = 1;
		var msg = "In an act of generosity, " + gC(actor).getFormattedName() + " has refused to demand anything.\n"
				+ gC(actor).getFormattedName() + " lost " + infamyChange.toFixed(1) + " infamy.\n"
				+ gC(target).getFormattedName() + "'s enmity towards " + gC(actor).getFormattedName() + " has slightly decreased.";
		return msg;
	}
	
	// Base value of 5
	bDemand.generateChoicesValuesForNpcs = function(actor,target,battleWeight,infamyMultiplier) {
		var extra1 = "";
		var extra2 = "";
		return [getBattleDemandChoiceValueNpc(-1,this,extra1,extra2)];
	}
	
	return bDemand;
}

window.createBdemandHumillitation = function() {
	var bDemand = new battleDemand("Humilliate");
	var tooltip = "Humilliating a character grants you merit taken from them, increases your domination towards them and increases your rivalry.";
	bDemand.subtitle += '<span title="' + tooltip + '">(?)</span>';

	bDemand.isPossible = function(actor,target,battleWeight) {
		var isPossible = false;
		// Minimum battle weight = 1
		if ( gC(actor).type == "candidate" && gC(target).type == "candidate" ) {
			isPossible = true;
		}
		return isPossible;
	}
	bDemand.calculateInfamy = function(actor,target,battleWeight,infamyMultiplier ) {
		var infamy = 0;
		return infamy;
	}
	bDemand.generateDescription = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		return "noDescription";
	}
	bDemand.provokeEffect = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		var meritTaken = 2 * battleWeight;
		var dominationApplied = 50 * battleWeight;
		var rivalryApplied = 35 * battleWeight;
		// Merit
		gC(actor).changeMerit(meritTaken);
		gC(target).changeMerit(-meritTaken);
		// Domination
		getRelation(actor,target).domination.stv += dominationApplied;
		getRelation(target,actor).submission.stv += dominationApplied;
		// Rivalry
		getRelation(actor,target).rivalry.stv += rivalryApplied;
		getRelation(target,actor).rivalry.stv += rivalryApplied;
		// Sex preferences
		if ( limitedRandomInt(100) > 75 ) {
			gC(actor).tastes.domination.w += limitedRandomInt(6);
		}
		if ( limitedRandomInt(100) > 75 ) {
			gC(actor).tastes.submission.w += limitedRandomInt(8);
		}
		return 1;
	}
	bDemand.resultMessage = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		var meritTaken = 2 * battleWeight;
		var dominationApplied = 50 * battleWeight;
		var rivalryApplied = 35 * battleWeight;
		var msg = randomFromList( [
					(gC(actor).getFormattedName() + " made " + gC(target).getFormattedName() + " kneel on the ground and admit " + gC(target).posPr + " loss."),
					(gC(actor).getFormattedName() + " mocked " + gC(target).getFormattedName() + " and laughed at " + gC(target).posPr + " sad position."),
					(gC(actor).getFormattedName() + " made " + gC(target).getFormattedName() + " say that " + gC(target).perPr + " will be more obedient in the future.") ])
				+ "\n " + gC(actor).getFormattedName() + " took " + meritTaken.toFixed(1) + " merit from " + gC(target).getFormattedName() + ".\n"
				+ gC(actor).getFormattedName() + "'s domination towards " + gC(target).getFormattedName() + " has slightly grown.\n"
				+ "The rivalry between " + gC(actor).getFormattedName() + " and " + gC(target).getFormattedName() + " has slightly grown.";
		return msg;
	}
	
	bDemand.generateChoicesValuesForNpcs = function(actor,target,battleWeight,infamyMultiplier) {
		var extra1 = "";
		var extra2 = "";
		var infamyExcess = (this.calculateInfamy(actor,target,battleWeight,infamyMultiplier) + gC(actor).infamy - getCharsInfamyLimit(actor));
		if ( infamyExcess < 0 ) { infamyExcess = 0; }
		var relationFactor = rLvlAbt(actor,target,"rivalry") * 3 + rLvlAbt(actor,target,"enmity") * 3 - rLvlAbt(actor,target,"friendship") - rLvlAbt(actor,target,"romance") * 2 + rLvlAbt(actor,target,"submission") * 2;
		var meritDifference = gC(target).merit - gC(actor).merit;
		if ( meritDifference < 0 ) { meritDifference = 0; }
		else if ( meritDifference > 10 ) { meritDifference = 10; }
		meritDifference = meritDifference * getCharsDrivePercent(actor,"dAmbition") * 6;
		var drivesFactor = gC(actor).dAmbition.level * 0.5;
		var value = limitedRandomInt(2) + relationFactor - infamyExcess + meritDifference + drivesFactor;
		if ( gC(actor).mission == "humilliate" ) { value = (value + 10) * 2; }
		if ( gC(actor).mission == "gainDomination" ) { value = (value + 5) * 1.5; }
		if ( gC(actor).socialAi.rivalTs.includes(target) ) { value *= 1.3; }
		return [getBattleDemandChoiceValueNpc(value,this,extra1,extra2)];
	}
	
	return bDemand;
}

window.createBdemandForceSex = function() {
	var bDemand = new battleDemand("Demand sex");
	var tooltip = "Enforces sex with the defeated character, with the victor as the locked leading character.";
	bDemand.subtitle += '<span title="' + tooltip + '">(?)</span>';

	bDemand.isPossible = function(actor,target,battleWeight) {
		var isPossible = false;
		if ( isLewdingPossible(actor,target) && battleWeight >= 2 && gSettings().battleDefeatSex == "enable" ) {
			isPossible = true;
		}
		return isPossible;
	}
	bDemand.calculateInfamy = function(actor,target,battleWeight,infamyMultiplier) {
		var infamy = 3 * infamyMultiplier;
		return infamy;
	}
	bDemand.generateDescription = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		return "noDescription";
	}
	bDemand.provokeEffect = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		// Infamy
		gC(actor).changeInfamy(this.calculateInfamy(actor,target,battleWeight,infamyMultiplier))
		// Domination
		getRelation(actor,target).domination.stv += 10;
		getRelation(target,actor).submission.stv += 10;
		// Sexual tension
		getRelation(target,actor).sexualTension.stv += 10;
		// Rivalry
		getRelation(target,actor).rivalry.stv += 10;
		// Sex preferences
		if ( limitedRandomInt(100) > 75 ) {
			gC(actor).tastes.domination.w += limitedRandomInt(3);
		}
		if ( limitedRandomInt(100) > 75 ) {
			gC(actor).tastes.submission.w += limitedRandomInt(5);
		}
		// Dominant sex event - Dismantle groups , event, scene, sceneConsequences, chPlayerCharacter check
		for ( var charParticipant of [actor,target] ) {
			for ( var charFollower of gC(charParticipant).followedBy ) {
				charUnfollowsChar(charFollower,charParticipant);
			}
		}
		State.variables.compass.characterEventEndsPrematurely(target);
		State.variables.compass.characterEventEndsPrematurely(actor);
		
		// Relocate actor and target
		if ( gC(actor).getRefugeRoomInMap() != "none" ) {
			State.variables.compass.moveCharsToRoom([actor,target],gC(actor).getRefugeRoomInMap());
		}
		// Event
		eventToPile(createSystemEventDominantSexEffects([actor,target]));
		return 1;
	}
	bDemand.resultMessage = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		var infamy = this.calculateInfamy(actor,target,battleWeight,infamyMultiplier);
		var days = 3;
		
		var msg = gC(actor).getFormattedName() + " will take " + gC(target).getFormattedName() + " away to ravish " + gC(actor).comPr + ".\n"
				+ gC(actor).getFormattedName() + " will get " + infamy.toFixed(1) + " infamy.\n"
				+ gC(target).getFormattedName() + "'s submission, sexual tension and rivalry towards " + gC(actor).getFormattedName() + " have slightly increased.";
		return msg;
	}
	bDemand.getPassageLink = function(actor,target) {
		var passage = "Scene";
		if ( actor != "chPlayerCharacter" && target != "chPlayerCharacter" ) {
			passage = "Map";
		}
		return passage;
	}
	
	bDemand.generateChoicesValuesForNpcs = function(actor,target,battleWeight,infamyMultiplier) {
		var extra1 = "";
		var extra2 = "";
		var infamyExcess = (this.calculateInfamy(actor,target,battleWeight,infamyMultiplier) + gC(actor).infamy - getCharsInfamyLimit(actor));
		if ( infamyExcess < 0 ) { infamyExcess = 0; }
		var relationFactor = rLvlAbt(actor,target,"sexualTension") * 3 + rLvlAbt(actor,target,"rivalry") * 2 + rLvlAbt(actor,target,"submission") - rLvlAbt(actor,target,"friendship") * 1 - rLvlAbt(actor,target,"romance") * 1;
		var drivesFactor = gC(actor).dPleasure.level * 2;
		if ( getCharsDrivePercent(actor,"dPleasure") < 0.1 ) { drivesFactor = -25; }
		var value = 0 + limitedRandomInt(4) + relationFactor - infamyExcess + drivesFactor;
		if ( gC(actor).mission == "gainDomination" ) { value = (value + 8) * 1.8; }
		if ( gC(actor).mission == "forceSex" ) { value = (value + 10) * 2; }
		if ( gC(actor).socialAi.conquestTs.includes(target) ) { value *= 1.3; }
		if ( gC(actor).socialAi.covetTs.includes(target) ) { value *= 1.5; }
		return [getBattleDemandChoiceValueNpc(value,this,extra1,extra2)];
	}
	
	return bDemand;
}

window.createBdemandForceServitude = function() {
	var bDemand = new battleDemand("Force servitude");
	var tooltip = "Enforces a temporary servitude relationship with the loser as your servant. Large infamy gain.";
	bDemand.subtitle += '<span title="' + tooltip + '">(?)</span>';

	bDemand.isPossible = function(actor,target,battleWeight) {
		var isPossible = false;
		if ( gC(actor).type == "candidate" && gC(target).type == "candidate" && battleWeight >= 3 && gSettings().servitudeRelationships == "enable" ) {
			if ( gC(actor).domChar == null && gC(target).domChar == null && gC(target).subChars.length < 1 && gC(actor).egaChars.includes(target) == false ) {
				isPossible = true;
			}
		}
		return isPossible;
	}
	bDemand.calculateInfamy = function(actor,target,battleWeight,infamyMultiplier) {
		var infamy = 10 * infamyMultiplier;
		return infamy;
	}
	bDemand.generateDescription = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		return "noDescription";
	}
	bDemand.provokeEffect = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		// Infamy
		gC(actor).changeInfamy(this.calculateInfamy(actor,target,battleWeight,infamyMultiplier));
		// Domination
		getRelation(actor,target).domination.stv += 10;
		getRelation(target,actor).submission.stv += 10;
		// Rivalry
		getRelation(target,actor).rivalry.stv += 20;
		// Enmity
		getRelation(target,actor).enmity.stv += 20;
		// Special relationship
		createRelTypeServitudeDom(actor,target,gSettings().relationshipsDuration);
		createRelTypeServitudeSub(target,actor,gSettings().relationshipsDuration);
		// Sex preferences
		if ( limitedRandomInt(100) > 75 ) {
			gC(actor).tastes.domination.w += limitedRandomInt(4);
		}
		if ( limitedRandomInt(100) > 75 ) {
			gC(actor).tastes.submission.w += limitedRandomInt(6);
		}
		return 1;
	}
	bDemand.resultMessage = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		var infamy = this.calculateInfamy(actor,target,battleWeight,infamyMultiplier);
		var days = 3;
		
		var msg = gC(actor).getFormattedName() + " will force " + gC(target).getFormattedName() + " to be " + gC(actor).posPr + " servant for " + days +" days.\n"
				+ gC(actor).getFormattedName() + " will get " + infamy.toFixed(1) + " infamy. "
				+ gC(target).getFormattedName() + "'s submission, rivalry and enmity towards " + gC(actor).getFormattedName() + " have slightly increased.";
		return msg;
	}
	
	bDemand.generateChoicesValuesForNpcs = function(actor,target,battleWeight,infamyMultiplier) {
		var extra1 = "";
		var extra2 = "";
		var infamyExcess = (this.calculateInfamy(actor,target,battleWeight,infamyMultiplier) + gC(actor).infamy - getCharsInfamyLimit(actor));
		if ( infamyExcess < 0 ) { infamyExcess = 0; }
		var relationFactor = 4 + rLvlAbt(actor,target,"sexualTension") * 2 + rLvlAbt(actor,target,"rivalry") * 1 + rLvlAbt(actor,target,"enmity") * 2 - rLvlAbt(actor,target,"friendship") * 2 - rLvlAbt(actor,target,"romance") * 1;
		var meritDifference = gC(target).merit - gC(actor).merit;
		if ( meritDifference < 0 ) { meritDifference = 0; }
		else if ( meritDifference > 10 ) { meritDifference = 10; }
		var drivesFactor = gC(actor).dDomination.level * 1.5 + gC(actor).dAmbition.level * 0.5;
		if ( getCharsDrivePercent(actor,"dCooperation") > 0.25 ) { drivesFactor = -25; }
		var value = limitedRandomInt(4) + relationFactor - infamyExcess + meritDifference;
		if ( gC(actor).mission == "weakenEnemy" ) {	value = (value + 7) * 1.75; }
		if ( gC(actor).mission == "gainDomination" ) { value = (value + 5) * 1.5; }
		if ( gC(actor).mission == "forceSex" ) { value = (value + 3) * 1.3; }
		if ( gC(actor).mission == "gainSubmissive" ) { value = (value + 10) * 2; }
		if ( gC(actor).socialAi.covetTs.includes(target) ) { value *= 1.6; }
		if ( gC(actor).socialAi.conquestTs.includes(target) ) { value *= 2; }
		value *= (1 + gC(actor).tastes.domination.r * 0.2);
		return [getBattleDemandChoiceValueNpc(value,this,extra1,extra2)];
	}
	
	return bDemand;
}

window.createBdemandForceLiberation = function() {
	var bDemand = new battleDemand("Force liberation");
	var tooltip = "Enforces the liberation of a character subjugated by the target. Moderate infamy loss.";
	bDemand.subtitle += '<span title="' + tooltip + '">(?)</span>';
	
	// extra1 = Character to be liberated
	
	bDemand.isPossible = function(actor,target,battleWeight) {
		var isPossible = false;
		if ( gC(actor).type == "candidate" && gC(target).type == "candidate" && battleWeight >= 2 && gSettings().servitudeRelationships == "enable" ) {
			if ( gC(target).subChars.length > 0 ) {
				for ( var subChar of gC(target).subChars ) {
					if ( gC(target).relations[subChar].relType.type == "servitude" ) {
						isPossible = true;
					}
				}
			}
		}
		return isPossible;
	}
	bDemand.calculateInfamy = function(actor,target,battleWeight,infamyMultiplier) {
		var infamy = -5 * infamyMultiplier;
		return infamy;
	}
	bDemand.generateDescription = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		return "noDescription";
	}
	bDemand.provokeEffect = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		// Infamy
		gC(actor).changeInfamy(this.calculateInfamy(actor,target,battleWeight,infamyMultiplier));
		// Rivalry
		getRelation(target,actor).rivalry.stv += 25;
		if ( extra1 != actor ) {
			// Friendship
			getRelation(extra1,actor).friendship.stv += 100;
			// Romance
			getRelation(extra1,actor).friendship.stv += 100;
		}
		// Terminate special relationship
		finishRelType(target,extra1);		
		return 1;
	}
	bDemand.resultMessage = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		var infamy = this.calculateInfamy(actor,target,battleWeight,infamyMultiplier);
		var days = 3;
		var msg = gC(actor).getFormattedName() + " will liberate " + gC(extra1).getFormattedName() + " from " + gC(target).getFormattedName() + ".\n"
				+ gC(actor).getFormattedName() + " will lose " + -infamy.toFixed(1) + " infamy. "
				+ gC(target).getFormattedName() + "'s rivalry towards " + gC(actor).getFormattedName() + " has slightly increased.\n"
				+ gC(extra1).getFormattedName() + "'s friendship and romance towards " + gC(actor).getFormattedName() + " have increased.\n";
		return msg;
	}
	bDemand.getFormattedPlayerChoice = function(actor,target,stakes,infamyMultiplier,i) {
		var cText = "";
		for ( var subChar of gC(target).subChars ) {
			if ( gC(target).relations[subChar].relType.type == "servitude" ) {
				cText += "<<l" + "ink [[" + this.title + " of " + gC(subChar).getName() + "|Scene Results]]>><<s" + "cript>>\n"
					   + "setup.battleDemandsDB[" + i + "].provokeEffect('chPlayerCharacter','" + target + "'," + stakes + "," + infamyMultiplier + ",'" + subChar + "','');\n"
					   + "formatGenericBattlePlayerChoice(setup.battleDemandsDB[" + i + "].resultMessage('chPlayerCharacter','" + target + "'," + stakes + "," + infamyMultiplier + ",'" + subChar + "',''),setup.battleDemandsDB[" + i + "].getPassageLink());\n"
					   + "<</s" + "cript>><</l" + "ink>>" + this.subtitle + "\n";
			}
		}
		return cText;
	}
	
	bDemand.generateChoicesValuesForNpcs = function(actor,target,battleWeight,infamyMultiplier) {
		var choicesList = [];
		for ( var subChar of gC(target).subChars ) {
			if ( gC(target).relations[subChar].relType.type == "servitude" ) {
				var extra1 = subChar;
				var extra2 = "";
				var infamyExcess = gC(actor).infamy * 0.5;
				if ( infamyExcess < 0 ) { infamyExcess = 0; }
				var relationFactor = 3 + rLvlAbt(actor,subChar,"friendship") * 1 + rLvlAbt(actor,subChar,"romance") * 3 - rLvlAbt(actor,subChar,"rivalry") * 2 - rLvlAbt(actor,subChar,"enmity") * 3;
				var drivesFactor = gC(actor).dCooperation.level * 2;
				var value = limitedRandomInt(5) + relationFactor - infamyExcess + drivesFactor;
				
				if ( gC(actor).mission == "weakenEnemy" ) {	value = (value + 5) * 1.5; }
				if ( gC(actor).mission == "liberateFriend" && ( gC(actor).socialAi.allyTs.includes(subChar) || gC(actor).socialAi.loveTs.includes(subChar) ) ) {
					value = (value + 20) * 3;
				}
				if ( gC(actor).socialAi.loveTs.includes(subChar) ) { value *= 2; }
				if ( gC(actor).socialAi.allyTs.includes(subChar) ) { value *= 1.6; }	
		
				if ( choicesList.length == 0 ) { choicesList = [getBattleDemandChoiceValueNpc(value,this,extra1,extra2)]; }
				else { choicesList = choicesList.concat([getBattleDemandChoiceValueNpc(value,this,extra1,extra2)]); }
			}
		}
		return choicesList;
	}
	
	return bDemand;
}

window.createBdemandStealServant = function() {
	var bDemand = new battleDemand("Steal servant");
	var tooltip = "Steals the servant of your opponent. Large infamy gain.";
	bDemand.subtitle += '<span title="' + tooltip + '">(?)</span>';
	
	// extra1 = Character to be stolen
	
	bDemand.isPossible = function(actor,target,battleWeight) {
		var isPossible = false;
		if ( gC(actor).type == "candidate" && gC(target).type == "candidate" && battleWeight >= 3 && gSettings().servitudeRelationships == "enable" && gSettings().stealingServitudeAllowed == "enable" ) {
			if ( gC(target).subChars.length > 0 ) {
				for ( var subChar of gC(target).subChars ) {
					if ( gC(target).relations[subChar].relType.type == "servitude" ) {
						isPossible = true;
					}
				}
			}
		}
		return isPossible;
	}
	bDemand.calculateInfamy = function(actor,target,battleWeight,infamyMultiplier) {
		var infamy = 10 * infamyMultiplier;
		return infamy;
	}
	bDemand.generateDescription = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		return "noDescription";
	}
	bDemand.provokeEffect = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		// Infamy
		gC(actor).changeInfamy(this.calculateInfamy(actor,target,battleWeight,infamyMultiplier));
		// Domination
		getRelation(actor,extra1).domination.stv += 25;
		getRelation(extra1,actor).submission.stv += 25;
		// Enmity
		getRelation(extra1,actor).enmity.stv += 25;
		// Rivalry
		getRelation(target,actor).rivalry.stv += 50;
		// Terminate special relationship
		finishRelType(target,extra1);		
		// Create new servitude relationship
		createRelTypeServitudeDom(actor,extra1,gSettings().relationshipsDuration);
		createRelTypeServitudeSub(extra1,actor,gSettings().relationshipsDuration);
		return 1;
	}
	bDemand.resultMessage = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		var infamy = this.calculateInfamy(actor,target,battleWeight,infamyMultiplier);
		var days = 3;
		
		var msg = gC(actor).getFormattedName() + " will steal " + gC(extra1).getFormattedName() + " from " + gC(target).getFormattedName() + ", forcing servitude upon " + gC(extra1).comPr + " for " + days + " days.\n"
				+ gC(actor).getFormattedName() + " will gain " + infamy.toFixed(1) + " infamy.\n"
				+ gC(extra1).getFormattedName() + "'s submission and enmity towards " + gC(actor).getFormattedName() + " have slightly increased.\n"
				+ gC(target).getFormattedName() + "'s rivalry towards " + gC(actor).getFormattedName() + " has increased.\n";
				
		return msg;
	}
	bDemand.getFormattedPlayerChoice = function(actor,target,stakes,infamyMultiplier,i) {
		var cText = "";
		for ( var subChar of gC(target).subChars ) {
			if ( gC(target).relations[subChar].relType.type == "servitude" ) {
				cText += "<<l" + "ink [[" + this.title + " (" + gC(subChar).getName() + ")|Scene Results]]>><<s" + "cript>>\n"
					   + "setup.battleDemandsDB[" + i + "].provokeEffect('chPlayerCharacter','" + target + "'," + stakes + "," + infamyMultiplier + ",'" + subChar + "','');\n"
					   + "formatGenericBattlePlayerChoice(setup.battleDemandsDB[" + i + "].resultMessage('chPlayerCharacter','" + target + "'," + stakes + "," + infamyMultiplier + ",'" + subChar + "',''),setup.battleDemandsDB[" + i + "].getPassageLink());\n"
					   + "<</s" + "cript>><</l" + "ink>>" + this.subtitle + "\n";
			}
		}
		return cText;
	}
	
	bDemand.generateChoicesValuesForNpcs = function(actor,target,battleWeight,infamyMultiplier) {
		var choicesList = [];
		for ( var subChar of gC(target).subChars ) {
			if ( gC(target).relations[subChar].relType.type == "servitude" ) {
				var extra1 = subChar;
				var extra2 = "";
				var infamyExcess = (this.calculateInfamy(actor,target,battleWeight,infamyMultiplier) + gC(actor).infamy - getCharsInfamyLimit(actor));
				if ( infamyExcess < 0 ) { infamyExcess = 0; }
				var relationFactor = 3 + rLvlAbt(actor,subChar,"sexualTension") * 2 + rLvlAbt(actor,subChar,"rivalry") * 1 + rLvlAbt(actor,subChar,"enmity") * 2 - rLvlAbt(actor,subChar,"friendship") * 2 - rLvlAbt(actor,subChar,"romance") * 1;
				var drivesFactor = gC(actor).dDomination.level * 1.5 + gC(actor).dAmbition.level * 1;
				if ( getCharsDrivePercent(actor,"dCooperation") > 0.25 ) { drivesFactor = -25; }
				var value = limitedRandomInt(5) + relationFactor - infamyExcess;
				if ( gC(actor).mission == "weakenEnemy" ) {	value = (value + 3) * 1.3; }
				if ( gC(actor).mission == "gainSubmissive" ) { value = (value + 10) * 2; }
				if ( gC(actor).socialAi.conquestTs.includes(subChar) ) { value *= 2; }
				if ( gC(actor).socialAi.covetTs.includes(subChar) ) { value *= 1.6; }
				
				if ( choicesList.length == 0 ) { choicesList = [getBattleDemandChoiceValueNpc(value,this,extra1,extra2)]; }
				else { choicesList = choicesList.concat([getBattleDemandChoiceValueNpc(value,this,extra1,extra2)]); }
			}
		}
		return choicesList;
	}	
	
	return bDemand;
}

window.createBdemandForceBondage = function() {
	var bDemand = new battleDemand("Force bondage");
	var tooltip = "Forces the equipment of bondage on your opponent. Variable infamy gain.";
	bDemand.subtitle += '<span title="' + tooltip + '">(?)</span>';
	
	bDemand.isPossible = function(actor,target,battleWeight) {
		var isPossible = false;
		if ( gC(actor).type == "candidate" && gC(target).type == "candidate" && battleWeight >= 1 ) {
			
			for ( var eq of gC(actor).ownedEquipment ) {
				var equip = getEquipById(eq);
				if ( equip.equippedOn == null && getEquipDataById(equip.id).slotType == "bodypart" ) {
					if ( mayEquipmentBePut(equip.id,target) ) {
						isPossible = true;
					}
				}
			}
		}
		return isPossible;
	}
	bDemand.calculateInfamy = function(actor,target,battleWeight,infamyMultiplier) {
		var infamy = 0;
		return infamy;
	}
	bDemand.generateDescription = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		return "noDescription";
	}
	bDemand.provokeEffect = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		if ( actor != "chPlayerCharacter" ) {
			// Find valid bondage
			var bondageList = [];
			for ( var eq of gC(actor).ownedEquipment ) {
				var equip = getEquipById(eq);
				if ( equip.equippedOn == null && getEquipDataById(equip.id).slotType == "bodypart" ) {
					if ( mayEquipmentBePut(equip.id,target) ) {
						bondageList.push(equip);
					}
				}
			}
			// Assign scores
			var bondageScore = [];
			var physicalScore = gC(target).physique.value + gC(target).agility.value + gC(target).resilience.value;
			var magicalScore = gC(target).intelligence.value + gC(target).will.value + gC(target).perception.value;
			var socialScore = (gC(target).charisma.value + gC(target).empathy.value) * 1.5;
			var totalScore = physicalScore + magicalScore + socialScore;
			for ( var bondage of bondageList ) {
				var tags = getEquipDataById(bondage.id).strategyTags;
				if ( tags.includes("attackPhysical") ) {
					bondageScore.push(physicalScore);
				} else if ( tags.includes("attackMagic") ) {
					bondageScore.push(magicalScore);
				} else if ( tags.includes("attackSocial") ) {
					bondageScore.push(socialScore);
				} else {
					bondageScore.push(totalScore * 0.4);
				}
			}
			// Find best score
			var bestIndex = 0;
			var i = 0;
			var highestScore = -1;
			var diceScore = 0;
			for ( var score of bondageScore ) {
				diceScore = limitedRandomInt(score*score);
				if ( diceScore > highestScore ) {
					bestIndex = i;
					highestScore = diceScore; 
				}
				i++;
			}
			// AI equips bondage
			equipObjectOnWearer(bondageList[bestIndex].id,target,gSettings().equipmentDuration);
			gC(actor).changeInfamy(getEquipDataById(bondageList[bestIndex].id).infamy);
		} else {
			var passage = gC(target).getFormattedName() + "'s submission and rivalry towards " + gC(actor).getFormattedName() + " have slightly increased.\n\n"
					    + "__Equip on " + gC(target).getFormattedName() + "__:\n\n";
						
			// Find valid bondage
			var bondageList = [];
			for ( var eq of gC(actor).ownedEquipment ) {
				var equip = getEquipById(eq);
				if ( equip.equippedOn == null && getEquipDataById(equip.id).slotType == "bodypart" ) {
					if ( mayEquipmentBePut(equip.id,target) ) {
						bondageList.push(eq);
					}
				}
			}
			for ( var bondage of bondageList ) {
				passage += "* <<l" + "ink [[Equip " + getEquipDataById(bondage).name + "|Map]]>><<s" + "cript>>\n"
						 + "equipObjectOnWearer(" + bondage + "," + target + "," + gSettings().equipmentDuration + ");\n"
						 + "gC('chPlayerCharacter').changeInfamy(" + getEquipDataById(bondage).infamy + ");\n"
						 + "<</s" + "cript>><</l" + "ink>> - Infamy cost: " + getEquipDataById(bondage).infamy + "\n";
			}
			State.variables.compass.sceneResultsPassage = passage;
		}
		// Infamy
		gC(actor).changeInfamy(this.calculateInfamy(actor,target,battleWeight,infamyMultiplier));
		// Domination
		getRelation(actor,target).domination.stv += 50;
		getRelation(target,actor).submission.stv += 50;
		// Rivalry
		getRelation(target,actor).rivalry.stv += 25;
		return 1;
	}
	bDemand.resultMessage = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		var infamy = this.calculateInfamy(actor,target,battleWeight,infamyMultiplier);
		var days = 3;
		
		if ( actor != "chPlayerCharacter" ) {
		var msg = gC(actor).getFormattedName() + " will forcefully equip bondage on " + gC(target).getFormattedName() + " for " + gSettings().equipmentDuration + " days.\n"
				+ gC(target).getFormattedName() + "'s submission and rivalry towards " + gC(actor).getFormattedName() + " have slightly increased.\n";
		} else {
			var passage = gC(target).getFormattedName() + "'s submission and rivalry towards " + gC(actor).getFormattedName() + " have slightly increased.\n\n"
					    + "__Equip on " + gC(target).getFormattedName() + "__:\n\n";
						
			// Find valid bondage
			var bondageList = [];
			for ( var eq of gC(actor).ownedEquipment ) {
				var equip = getEquipById(eq);
				if ( equip.equippedOn == null && getEquipDataById(equip.id).slotType == "bodypart" ) {
					if ( mayEquipmentBePut(equip.id,target) ) {
						bondageList.push(eq);
					}
				}
			}
			for ( var bondage of bondageList ) {
				passage += "- <<l" + "ink [[Equip " + getEquipDataById(bondage).name + "|Map]]>><<s" + "cript>>\n"
						 + "equipObjectOnWearer(" + bondage + ",'" + target + "'," + gSettings().equipmentDuration + ");\n"
						 + "gC('chPlayerCharacter').changeInfamy(" + getEquipDataById(bondage).infamy + ");\n"
						 + "<</s" + "cript>><</l" + "ink>> - Infamy cost: " + getEquipDataById(bondage).infamy + "\n";
			}
			msg = passage;
		}
				
		return msg;
	}
	bDemand.getFormattedPlayerChoice = function(actor,target,stakes,infamyMultiplier,i) {
		var cText = "<<l" + "ink [[" + this.title + "|Scene Results]]>><<s" + "cript>>\n"
					   + "setup.battleDemandsDB[" + i + "].provokeEffect('chPlayerCharacter','" + target + "'," + stakes + "," + infamyMultiplier + ",'','');\n"
					   // Add format bondage choice option
					   + "formatGenericBattlePlayerChoice(setup.battleDemandsDB[" + i + "].resultMessage('chPlayerCharacter','" + target + "'," + stakes + "," + infamyMultiplier + ",'',''),setup.battleDemandsDB[" + i + "].getPassageLink());\n"
					   + "<</s" + "cript>><</l" + "ink>>" + this.subtitle + "\n";
		
		return cText;
	}
	
	bDemand.generateChoicesValuesForNpcs = function(actor,target,battleWeight,infamyMultiplier) {
		var extra1 = "";
		var extra2 = "";
		var infamyExcess = 3 + gC(actor).infamy - getCharsInfamyLimit(actor);
		if ( infamyExcess < 0 ) { infamyExcess = 0; }
		var relationFactor = rLvlAbt(actor,target,"enmity") * 3 + rLvlAbt(actor,target,"rivalry") * 2 + rLvlAbt(actor,target,"submission") - rLvlAbt(actor,target,"friendship") * 1 - rLvlAbt(actor,target,"romance") * 1;
		var drivesFactor = gC(actor).dDomination.level * 2;
		if ( getCharsDrivePercent(actor,"dCooperation") > 0.25 ) { drivesFactor = -gC(actor).dCooperation.level * 2; }
		var dangerFactor = (quantifyCharacterStrength(target) - quantifyCharacterStrength(actor)) / 10;
		var value = limitedRandomInt(3) + relationFactor - infamyExcess + drivesFactor + dangerFactor;
		if ( gC(actor).mission == "weakenEnemy" ) {	value = (value + 10) * 2; }
		if ( gC(actor).mission == "gainDomination" ) { value = (value + 3) * 1.3; }
		if ( gC(actor).socialAi.conquestTs.includes(target) ) { value *= 1.5; }
		if ( gC(actor).socialAi.rivalTs.includes(target) ) { value *= 1.8; }
		value *= (1 + gC(actor).tastes.bondage.r * 0.2 );
		return [getBattleDemandChoiceValueNpc(value,this,extra1,extra2)];
	}	
	
	return bDemand;
}

window.createBdemandUnequipBondage = function() {
	var bDemand = new battleDemand("Unequip bondage");
	var tooltip = "Forces your opponent to free someone from their bondage. May reduce infamy";
	bDemand.subtitle += '<span title="' + tooltip + '">(?)</span>';
	
	// extra1 = Character to be freed
	
	bDemand.isPossible = function(actor,target,battleWeight) {
		var isPossible = false;
		if ( battleWeight >= 1 ) {
			for ( var item of gC(target).ownedEquipment ) {
				if ( getEquipById(item).equippedOn != null && getEquipById(item).equippedOn != target && gC(target).subChars.includes(getEquipById(item).equippedOn) == false && equipmentIsBondage(getEquipDataById(item)) ) {
					isPossible = true;
				}
			}
		}
		return isPossible;
	}
	bDemand.calculateInfamy = function(actor,target,battleWeight,infamyMultiplier) {
		var infamy = 0;
		return infamy;
	}
	bDemand.generateDescription = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		return "noDescription";
	}
	bDemand.provokeEffect = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {
		var bondageList = [];
		// Get bondage list
		for ( var item of gC(target).ownedEquipment ) {
			if ( getEquipById(item).equippedOn == extra1 && equipmentIsBondage(getEquipDataById(item)) ) {
				bondageList.push(item);
			}
		}
		// Unequip bondage
		for ( var item of bondageList ) {
			unequipObject(item);
		}
		// Extra effects if actor != freed character
		if ( extra1 != actor ) {
			gC(actor).changeInfamy(-1);
			getRelation(extra1,actor).friendship.stv += 25;
		}
		return 1;
	}
	bDemand.resultMessage = function(actor,target,battleWeight,infamyMultiplier,extra1,extra2) {		
		var msg = gC(extra1).getFormattedName() + " will be freed from " + gC(target).getFormattedName() + "'s bondage items.\n";
		if ( extra1 != actor ) {
			msg += gC(actor).getFormattedName() + " has lost 1 infamy, and " + gC(actor).posPr + " friendship with " + gC(extra1).getFormattedName() + " has grown.";
		}
		
		return msg;
	}
	bDemand.getFormattedPlayerChoice = function(actor,target,stakes,infamyMultiplier,i) {
		var cText = "";
		var validChars = [];
		// Get valid chars
		for ( var item of gC(target).ownedEquipment ) {
			if ( getEquipById(item).equippedOn != null && getEquipById(item).equippedOn != target && gC(target).subChars.includes(getEquipById(item).equippedOn) == false && equipmentIsBondage(getEquipDataById(item)) ) {
				if ( validChars.includes(getEquipById(item).equippedOn) == false ) {
					validChars.push(getEquipById(item).equippedOn);
				}
			}
		}
		// Format choices
		for ( var charKey of validChars ) {
			cText += "<<l" + "ink [[" + this.title + " (" + gC(charKey).getName() + ")|Scene Results]]>><<s" + "cript>>\n"
				   + "setup.battleDemandsDB[" + i + "].provokeEffect('chPlayerCharacter','" + target + "'," + stakes + "," + infamyMultiplier + ",'" + charKey + "','');\n"
				   + "formatGenericBattlePlayerChoice(setup.battleDemandsDB[" + i + "].resultMessage('chPlayerCharacter','" + target + "'," + stakes + "," + infamyMultiplier + ",'" + charKey + "',''),setup.battleDemandsDB[" + i + "].getPassageLink());\n"
				   + "<</s" + "cript>><</l" + "ink>>" + this.subtitle + "\n";
		}
		
		return cText;
	}
	
	bDemand.generateChoicesValuesForNpcs = function(actor,target,battleWeight,infamyMultiplier) {
		var choicesList = [];
		var validChars = [];
		// Get valid chars
		for ( var item of gC(target).ownedEquipment ) {
			if ( getEquipById(item).equippedOn != null && getEquipById(item).equippedOn != target && gC(target).subChars.includes(getEquipById(item).equippedOn) == false && equipmentIsBondage(getEquipDataById(item)) ) {
				if ( validChars.includes(getEquipById(item).equippedOn) == false ) {
					validChars.push(getEquipById(item).equippedOn);
				}
			}
		}
		for ( var charKey of validChars ) {
			var extra1 = charKey;
			var extra2 = "";
			var relationFactor = 0;
			if ( charKey != actor ) {
				relationFactor = rLvlAbt(actor,charKey,"friendship") * 1 + rLvlAbt(actor,charKey,"romance") * 2 - rLvlAbt(actor,charKey,"rivalry") * 1 - rLvlAbt(actor,charKey,"enmity") * 2;
			} else {
				relationFactor = 50;
				if ( gC(actor).mission == "weakenEnemy" ) {	relationFactor *= 2; }
			}
			var drivesFactor = gC(actor).dCooperation.level * 2;
			var value = 1 + limitedRandomInt(3) + relationFactor + drivesFactor;
			if ( gC(actor).socialAi.loveTs.includes(charKey) ) { value *= 1.7; }
			if ( gC(actor).socialAi.allyTs.includes(charKey) ) { value *= 1.5; }
				
			if ( choicesList.length == 0 ) { choicesList = [getBattleDemandChoiceValueNpc(value,this,extra1,extra2)]; }
			else { choicesList = choicesList.concat([getBattleDemandChoiceValueNpc(value,this,extra1,extra2)]); }
		}
		
		return choicesList;
	}	
	
	return bDemand;
}

// State.variables.battleDemandsDB = [
setup.battleDemandsDB = [
	// Do nothing
	createBdemandDoNothing(),
	// Humilliate
	createBdemandHumillitation(),
	// Demand sex
	createBdemandForceSex(),
	// Force relationship
	createBdemandForceServitude(),
	// Force liberation
	createBdemandForceLiberation(),
	// Steal servitude
	createBdemandStealServant(),
	// Force bondage
	createBdemandForceBondage(),
	// Liberate from bondage
	createBdemandUnequipBondage()
];

window.formatBattleDemandButtons = function(target,stakes,infamyMultiplier) {
	var bText = "";
	var i = 0;
	for ( var bDemand of setup.battleDemandsDB ) {
		if ( bDemand.isPossible("chPlayerCharacter",target,stakes) ) {
			bText += setup.battleDemandsDB[i].getFormattedPlayerChoice("chPlayerCharacter",target,stakes,infamyMultiplier,i);
			//this.getFormattedPlayerChoice = function(actor,target,stakes,infamyMultiplier,i)
			/*
			bText += "<<l" + "ink [[" + bDemand.title + "|Scene Results]]>><<s" + "cript>>\n";
			bText += "setup.battleDemandsDB[" + i + "].provokeEffect('chPlayerCharacter','" + target + "'," + stakes + "," + infamyMultiplier + ");\n";
			bText += "formatGenericBattlePlayerChoice(setup.battleDemandsDB[" + i + "].resultMessage('chPlayerCharacter','" + target + "'," + stakes + "," + infamyMultiplier + ",extra1,extra2),setup.battleDemandsDB[" + i + "].getPassageLink());\n";
			bText += "<</s" + "cript>><</l" + "ink>>" + bDemand.subtitle + "\n";
			*/
		}
		i++;
	}
	return bText;
}


///// POST-SCENE LOGIC /////
window.processGenericSexSceneEffects = function() {
	var allChars = State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys);
	var resultsMessage = "";
	for ( var charKey of allChars ) {
		if ( gC(charKey).orgasmSceneCounter > 0 ) {
			gC(charKey).lust.restore();
		}
	}
	
	var	allCharsMsgs = [];
	
	// Relations & Drives changes
	for ( var charKey of allChars ) {
		gC(charKey).orgasmSceneCounter += gC(charKey).mindblowingOrgasmSC * 2;
		allChars[charKey] = [];
		var allOtherChars = arrayMinusA(allChars,charKey);
		var avrRomance = getAverageRelationStatBetweenCharAndGroup("romance",charKey,allOtherChars);
		var avrSexualTension = getAverageRelationStatBetweenCharAndGroup("sexualTension",charKey,allOtherChars);
		allCharsMsgs[charKey] = [];
		if ( gC(charKey).hasOwnProperty("daysWithoutSex") ) {
			allCharsMsgs[charKey].msg = "";
			var effectsMultiplier = getSexEffectsMultiplier(charKey);
			if ( State.variables.sc.enabledLead == "fixed" ) { // Fixed lead
				if ( gC(charKey).hasLead ) {					  // Char was top
						// Define values
					var gainedRomance = 20;
					var gainedSexualTension = 30;
					var gainedDomination = 30;
					var gainedDriveLove = 0;
					var gainedDrivePleasure = 0;
					var gainedDriveDomination = 0;
					if ( gC(charKey).orgasmSceneCounter > 0 ) {
						gainedSexualTension += 20;
						gainedDrivePleasure += 10;
						gainedDriveDomination += 20;
						if ( avrRomance > 1 && ( avrRomance * 0.8 >= avrSexualTension ) ) {
							gainedDriveLove = 10;
						} else if ( avrRomance > 1 && ( avrRomance * 1.3 >= avrSexualTension ) ) {
							gainedDriveLove = 5;
						}
					}
					gainedRomance *= effectsMultiplier * (1 + ((gC(charKey).mood.intimate - gC(charKey).mood.angry - gC(charKey).mood.bored) / 100));
					gainedSexualTension *= effectsMultiplier * (1 + ((gC(charKey).mood.aroused + gC(charKey).mood.flirty - gC(charKey).mood.bored) / 200));
					gainedDomination *= effectsMultiplier * (1 + ((gC(charKey).mood.dominant - gC(charKey).mood.submissive) / 100));
					gainedDriveLove *= effectsMultiplier * (1 + ((gC(charKey).mood.intimate * 2 - gC(charKey).mood.bored) / 200)) * (avrRomance/avrSexualTension);
					if ( allChars.length > 2 && ( (avrRomance / avrSexualTension) < 0.8 ) ) {
						gainedDriveLove *= ( 1 - allChars.length * 0.1 );
					}
					gainedDrivePleasure *= effectsMultiplier * (1 + ((gC(charKey).mood.aroused + gC(charKey).mood.flirty - gC(charKey).mood.bored) / 200)) * (avrSexualTension/avrRomance);
					if ( allChars.length == 2 && ( (avrRomance / avrSexualTension) > 1.2 ) ) {
						gainedDrivePleasure *= 0.8;
					}
					gainedDriveDomination *= effectsMultiplier * (1 + ((gC(charKey).mood.dominant - gC(charKey).mood.submissive) / 100));
					
						// Apply values
							// Relations
					for ( var charKey2 of allChars ) {
						if ( charKey2 != charKey ) {
							gC(charKey).relations[charKey2].romance.stv += gainedRomance;
							gC(charKey).relations[charKey2].sexualTension.stv += gainedSexualTension;
							gC(charKey).relations[charKey2].domination.stv += gainedDomination;
						}
					}
							// Drives
					addPointsToDrive(gC(charKey).dPleasure,gainedDrivePleasure);
					addPointsToDrive(gC(charKey).dDomination,gainedDriveDomination);
						// Text
					allCharsMsgs[charKey].msg += gC(charKey).getFormattedName() + " has gained " + gainedRomance.toFixed(1) + " romance, " + gainedSexualTension.toFixed(1)
										   + " sexual tension, and " + gainedDomination.toFixed(1) + " domination towards the other characters.\n";
					if ( gainedDrivePleasure > 0 ) {
						allCharsMsgs[charKey].msg += gC(charKey).getFormattedName() + " has gained " + gainedDrivePleasure.toFixed(1) + " pleasure drive points, " + gainedDriveLove.toFixed(1) + " love drive points and "
											   + gainedDriveDomination.toFixed(1) + " domination drive points.";
					}
				} else {										  // Char was bottom
						// Define values
					var gainedRomance = 25 + gC(charKey).orgasmSceneCounter * 5 - gC(charKey).ruinedOrgasmSceneCounter * 5;
					var gainedSexualTension = 35 + gC(charKey).orgasmSceneCounter * 10 + gC(charKey).ruinedOrgasmSceneCounter * 10;
					var gainedSubmission = 25 + gC(charKey).orgasmSceneCounter * 5 + gC(charKey).ruinedOrgasmSceneCounter * 15;
					var gainedEnmity = gC(charKey).ruinedOrgasmSceneCounter * 5;
					var gainedDrivePleasure = 8 + gC(charKey).orgasmSceneCounter * 2 + gC(charKey).ruinedOrgasmSceneCounter * 3;
					var gainedDriveLove = - gC(charKey).ruinedOrgasmSceneCounter * 2;
					if ( avrRomance > 1 && ( avrRomance * 1.3 >= avrSexualTension ) ) {
						gainedDriveLove += 5 + gC(charKey).orgasmSceneCounter * 2;
					}
					var gainedExtraSubmission = 25;
					var energyLostPer = gC(charKey).energy.accumulatedDamage / gC(charKey).energy.max;
					if ( energyLostPer > 1 ) { energyLostPer = 1; }
					var willpowerLostPer = gC(charKey).willpower.accumulatedDamage / gC(charKey).willpower.max;
					if ( willpowerLostPer > 1 ) { willpowerLostPer = 1; }
					gainedExtraSubmission *= ( ( energyLostPer + willpowerLostPer ) / 2 );
					if ( gC(charKey).orgasmSceneCounter == 0 && gC(charKey).ruinedOrgasmSceneCounter == 0 ) {
						gainedSexualTension = -20;
						gainedEnmity = 20;
						gainedRomance = 0;
						gainedSubmission = 20;
						gainedDrivePleasure = -10;
					} else if ( gC(charKey).orgasmSceneCounter == 0 ) {
						gainedSexualTension += 20;
						gainedEnmity += 20;
						gainedRomance += 0;
						gainedSubmission += 20;
						gainedDrivePleasure += 10;
					}
					gainedRomance *= effectsMultiplier * (1 + ((gC(charKey).mood.intimate - gC(charKey).mood.angry - gC(charKey).mood.bored) / 100));
					gainedSexualTension *= effectsMultiplier * (1 + ((gC(charKey).mood.aroused + gC(charKey).mood.flirty - gC(charKey).mood.bored) / 200));
					gainedSubmission += gainedExtraSubmission;
					gainedSubmission *= effectsMultiplier * (1 + ((- gC(charKey).mood.dominant + gC(charKey).mood.submissive) / 100));
					gainedEnmity *= effectsMultiplier * (1 + ((gC(charKey).mood.angry - gC(charKey).mood.submissive) / 100));
					gainedDriveLove *= effectsMultiplier * (1 + ((gC(charKey).mood.intimate + gC(charKey).mood.friendly - gC(charKey).mood.angry - gC(charKey).mood.bored) / 200)) * (avrRomance/avrSexualTension);
					if ( allChars.length > 2 && ( (avrRomance / avrSexualTension) < 0.8 ) ) {
						gainedDriveLove *= ( 1 - allChars.length * 0.1 );
					}
					gainedDrivePleasure *= effectsMultiplier * (1 + ((gC(charKey).mood.aroused + gC(charKey).mood.flirty - gC(charKey).mood.bored) / 200)) * (avrSexualTension/avrRomance);
					if ( allChars.length == 2 && ( (avrRomance / avrSexualTension) > 1.2 ) ) {
						gainedDrivePleasure *= 0.8;
					}
						// Apply values
							// Relations
					var leadingChar = charKey;
					for ( var charKey2 of allChars ) {
						if ( gC(charKey2).hasLead ) {
							leadingChar = charKey2;
							if ( charKey != charKey2 ) {
								gC(charKey).relations[charKey2].romance.stv += gainedRomance;
								gC(charKey).relations[charKey2].sexualTension.stv += gainedSexualTension;
								gC(charKey).relations[charKey2].submission.stv += gainedSubmission;
								gC(charKey).relations[charKey2].enmity.stv += gainedEnmity;
							}
						}
					}
							// Drives
					addPointsToDrive(gC(charKey).dPleasure,gainedDrivePleasure);
					addPointsToDrive(gC(charKey).dLove,gainedDriveLove);
						// Text
					if ( gC(charKey).orgasmSceneCounter == 0 && gC(charKey).ruinedOrgasmSceneCounter == 0 ) {
						allCharsMsgs[charKey].msg += gC(charKey).getFormattedName() + " has gained " + gainedEnmity.toFixed(1) + " enmity and " + gainedSubmission.toFixed(1) 
											   + " submission, and lost " + (-gainedSexualTension).toFixed(1) + " sexual tension with " + gC(leadingChar).getFormattedName() + ".\n"
											   + gC(charKey).getFormattedName() + " lost " + (-gainedDrivePleasure).toFixed(1) + " pleasure drive points."
					} else {
						allCharsMsgs[charKey].msg += gC(charKey).getFormattedName() + " has gained " + gainedRomance.toFixed(1) + " romance, " + gainedSexualTension.toFixed(1)
											   + " sexual tension and " + gainedSubmission.toFixed(1) + " submission towards " + gC(leadingChar).getFormattedName() + ".\n"
											   + gC(charKey).getFormattedName() + " gained " + gainedDrivePleasure.toFixed(1) + " pleasure drive points and " + gainedDriveLove.toFixed(1) + " love drive points.";
					}
				}
			} else {				// Dynamic lead
				var gainedRomance = 0;
				var gainedSexualTension = 0;
				var gainedEnmity = 0;
				var gainedLoveDrive = 0;
				var gainedPleasureDrive = 0;
				var gainedCooperationDrive = 0;
				var gainedDominationDrive = 0;
				var gainedSubmission = 0;
				
				var energyLostPer = gC(charKey).energy.accumulatedDamage / gC(charKey).energy.max;
				if ( energyLostPer > 1 ) { energyLostPer = 1; }
				var willpowerLostPer = gC(charKey).willpower.accumulatedDamage / gC(charKey).willpower.max;
				if ( willpowerLostPer > 1 ) { willpowerLostPer = 1; }
				var extraSubmissionMult =  ( ( energyLostPer + willpowerLostPer ) / 2 );
				
					// Decide changes
				if ( gC(charKey).orgasmSceneCounter == 0 ) { // Character didn't orgasm
					if ( gC(charKey).ruinedOrgasmSceneCounter == 0 ) {
						gainedSexualTension = -20;
						gainedRomance = -20;
						gainedEnmity = 20;
						gainedLoveDrive = -5;
						gainedPleasureDrive = -10;
						gainedCooperationDrive = -5;
						gainedDominationDrive = 10;
						if ( allChars.length == 2 ) {
							gainedSubmission = 10 * extraSubmissionMult;
						}
					} else {
						gainedSexualTension = 20;
						gainedRomance = -20;
						gainedEnmity = 20;
						gainedLoveDrive = -5;
						gainedPleasureDrive = 10;
						gainedCooperationDrive = -5;
						gainedDominationDrive = 5;
						if ( allChars.length == 2 ) {
							gainedSubmission = 10 * extraSubmissionMult;
						}
					}
				} else {									// Character did orgasm
					// Two characters in scene
					if ( allChars.length == 2 ) {
						gainedRomance = 25 + gC(charKey).orgasmSceneCounter * 5;
						gainedSexualTension = 35 + gC(charKey).orgasmSceneCounter * 10;
						gainedEnmity = -2 - gC(charKey).orgasmSceneCounter * 5;
						gainedLoveDrive = 8 + gC(charKey).orgasmSceneCounter * 2;
						gainedPleasureDrive = 8 + gC(charKey).orgasmSceneCounter * 2;
						gainedCooperationDrive = 4 + gC(charKey).orgasmSceneCounter;
						gainedSubmission = 20 * extraSubmissionMult;
					} else { // More than two characters in scene
						gainedRomance = 10 + gC(charKey).orgasmSceneCounter * 3;
						gainedSexualTension = 20 + gC(charKey).orgasmSceneCounter * 5;
						gainedEnmity = -1 - gC(charKey).orgasmSceneCounter * 2;
						gainedLoveDrive = 4 + gC(charKey).orgasmSceneCounter;
						gainedPleasureDrive = 8 + gC(charKey).orgasmSceneCounter * 2;
						gainedCooperationDrive = 4 + gC(charKey).orgasmSceneCounter;
						
					}
				}
				// Ruined orgasms
				gainedRomance -= gC(charKey).ruinedOrgasmSceneCounter * 2;
				gainedSexualTension += gC(charKey).ruinedOrgasmSceneCounter * 5;
				gainedEnmity += gC(charKey).ruinedOrgasmSceneCounter * 5;
				gainedLoveDrive -= gC(charKey).ruinedOrgasmSceneCounter * 2;
				gainedPleasureDrive += gC(charKey).ruinedOrgasmSceneCounter * 3;
				gainedCooperationDrive -= gC(charKey).ruinedOrgasmSceneCounter * 2;
				gainedDominationDrive += gC(charKey).ruinedOrgasmSceneCounter * 1;
				gainedSubmission += gC(charKey).ruinedOrgasmSceneCounter * 5;
				
				gainedRomance *= effectsMultiplier * (1 + ((gC(charKey).mood.intimate - gC(charKey).mood.angry - gC(charKey).mood.bored) / 100));
				gainedSexualTension *= effectsMultiplier * (1 + ((gC(charKey).mood.aroused + gC(charKey).mood.flirty - gC(charKey).mood.bored) / 200));
				gainedSubmission *= effectsMultiplier * (1 + ((- gC(charKey).mood.dominant + gC(charKey).mood.submissive) / 100));
				gainedEnmity *= effectsMultiplier * (1 + ((gC(charKey).mood.angry - gC(charKey).mood.submissive) / 100));
				gainedLoveDrive *= effectsMultiplier * (1 + ((gC(charKey).mood.intimate * 2 + gC(charKey).mood.friendly - gC(charKey).mood.angry * 2 - gC(charKey).mood.bored) / 300));
				if ( allChars.length > 2 && ( (avrRomance / avrSexualTension) < 0.8 ) ) {
					gainedLoveDrive *= ( 1 - allChars.length * 0.1 );
				}
				gainedPleasureDrive *= effectsMultiplier * (1 + ((gC(charKey).mood.aroused + gC(charKey).mood.flirty - gC(charKey).mood.bored) / 200)) * (avrSexualTension/avrRomance);
				if ( allChars.length == 2 && ( (avrRomance / avrSexualTension) > 1.2 ) ) {
					gainedPleasureDrive *= 0.8;
				}
				gainedCooperationDrive *= effectsMultiplier * (1 + ((gC(charKey).mood.intimate + gC(charKey).mood.friendly * 2 - gC(charKey).mood.angry * 2 - gC(charKey).mood.bored) / 300)) * (avrRomance/avrSexualTension);
				gainedDominationDrive *= effectsMultiplier * (1 + ((gC(charKey).mood.dominant - gC(charKey).mood.submissive) / 100));
					
				// Apply changes
					// Relations
				for ( var charKey2 of allChars ) {
					if ( charKey != charKey2 ) {
						gC(charKey).relations[charKey2].romance.stv += gainedRomance;
						gC(charKey).relations[charKey2].sexualTension.stv += gainedSexualTension;
						gC(charKey).relations[charKey2].submission.stv += gainedSubmission;
						gC(charKey).relations[charKey2].enmity.stv += gainedEnmity;
					}
				}
					// Drives
				addPointsToDrive(gC(charKey).dLove,gainedLoveDrive);
				addPointsToDrive(gC(charKey).dPleasure,gainedPleasureDrive);
				addPointsToDrive(gC(charKey).dCooperation,gainedCooperationDrive);
				addPointsToDrive(gC(charKey).dDomination,gainedDominationDrive);
				
				// Text
				if ( gC(charKey).orgasmSceneCounter == 0 ) { // Character didn't orgasm			
					allCharsMsgs[charKey].msg += gC(charKey).getFormattedName() + " lost " + (-gainedRomance).toFixed(1) + " romance and " + (-gainedSexualTension).toFixed(1)
										   + " sexual tension, and gained " + gainedEnmity.toFixed(1) + " enmity";
					if ( gainedSubmission > 0 ) { allCharsMsgs[charKey].msg += " and " + gainedSubmission.toFixed(1) + " submission."; }
					else { allCharsMsgs[charKey].msg += "."; }
					allCharsMsgs[charKey].msg += "\n" + gC(charKey).getFormattedName() + " gained " + gainedDominationDrive.toFixed(1) + " domination drive points, and lost " +
										   + (-gainedLoveDrive).toFixed(1) + " love, " + (-gainedPleasureDrive).toFixed(1) + " pleasure and " + (-gainedCooperationDrive).toFixed(1)
										   + " cooperation drive points.";
				} else {									// Character did orgasm
					// Two characters in scene
					if ( allChars.length == 2 ) {
						allCharsMsgs[charKey].msg += gC(charKey).getFormattedName() + " gained " + gainedRomance.toFixed(1) + " romance and " + gainedSexualTension.toFixed(1)
											   + " sexual tension, and lost " + (-gainedEnmity).toFixed(1) + " enmity.";
						if ( gainedSubmission > 0 ) { allCharsMsgs[charKey].msg += " " + gC(charKey).getFormattedName() + " also gained " + gainedSubmission.toFixed(1) + " submission."; }
						allCharsMsgs[charKey].msg += "\n" + gC(charKey).getFormattedName() + " gained " + gainedLoveDrive.toFixed(1) + " love, " + gainedPleasureDrive.toFixed(1) + " pleasure and "
											   + gainedCooperationDrive.toFixed(1) + " cooperation drive points.";
					} else { // More than two characters in scene
						allCharsMsgs[charKey].msg += gC(charKey).getFormattedName() + " gained " + gainedRomance.toFixed(1) + " romance and " + gainedSexualTension.toFixed(1)
											   + " sexual tension, and lost " + (-gainedEnmity).toFixed(1) + " enmity.\n"
											   + gC(charKey).getFormattedName() + " gained " + gainedLoveDrive.toFixed(1) + " love, " + gainedPleasureDrive.toFixed(1) + " pleasure and "
											   + gainedCooperationDrive.toFixed(1) + " cooperation drive points.";
					}
				}
			}
		}
		gC(charKey).orgasmSceneCounter -= gC(charKey).mindblowingOrgasmSC * 2;
	}		
	
	// Mood changes
	for ( var cK of allChars ) {
		if ( gC(cK).hasLead && State.variables.sc.enabledLead == "fixed" ) {
			gC(cK).mood.flirty *= 0.5;
			gC(cK).mood.aroused *= 0.5;
			gC(cK).mood.applyChange("friendly",10);
			gC(cK).mood.applyChange("intimate",10);
		} else {
			if ( gC(cK).orgasmSceneCounter > 0 ) { // Had normal orgasms
				gC(cK).mood.flirty *= 0.5;
				gC(cK).mood.aroused *= 0.5;
				gC(cK).mood.applyChange("friendly",10);
				gC(cK).mood.applyChange("intimate",10);
			} else if ( gC(cK).ruinedOrgasmSceneCounter > 0 ) { // Only had ruined orgasms
				gC(cK).mood.applyChange("angry",25);
				gC(cK).mood.applyChange("submissive",25);
				gC(cK).mood.applyChange("aroused",25);
				gC(cK).mood.flirty *= 0.5;
				gC(cK).mood.friendly *= 0.5;
				gC(cK).mood.intimate *= 0.5;
				gC(cK).mood.dominant *= 0.5;
			} else { // Had no orgasms
				gC(cK).mood.applyChange("angry",10);
				gC(cK).mood.applyChange("bored",25);
				gC(cK).mood.flirty *= 0.5;
				gC(cK).mood.friendly *= 0.5;
				gC(cK).mood.intimate *= 0.5;
			}
		}
	}
	
	for ( var cK of allChars ) {
		resultsMessage += allCharsMsgs[cK].msg + "\n";
	}
	if ( resultsMessage != "" ) { resultsMessage += "\n"; }
	resultsMessage += "[[Continue|Map]]";
	
	// Finish formatting
	State.variables.compass.sceneResultsPassage = resultsMessage;
}

window.processGenericMapBattleEffects = function() {
	// Find winners and losers
	var flagStaleMate = false;
	var winner = "";
	var loser = "";
	
	var flagIsWinnerAttacking = false;
	var infamyMult = 1;
	var stakes = State.variables.sc.stakes;
	
	var driveChangesMessage = "";
	var resultsMessage = "";
	
	var flagWinningTeamIsCooperating = false;
	
	var selectedBattleDemand = null;
	var potentialBattleDemands = [];
	
	switch (State.variables.sc.extraEndInfo) {
		case "stalemate":
			flagStaleMate = true;
			break;
		case "teamAwin":
			// Set winner
			if ( State.variables.sc.teamAcharKeys.includes(State.variables.sc.aggressor) ) {
				flagIsWinnerAttacking = true;
			}
			// Restore Team A
			for ( var charKey of State.variables.sc.teamAcharKeys ) {
				gC(charKey).lust.restore();
			}
			// Cooperation check and drive changes
			for ( var cK of State.variables.sc.teamAcharKeys ) {
				if ( cK != State.variables.sc.teamAcharKeys[0] ) {
					if ( gC(cK).subChars.includes(State.variables.sc.teamAcharKeys[0]) == false && gC(cK).domChar != State.variables.sc.teamAcharKeys[0] ) {
						flagWinningTeamIsCooperating = true;
					}
				}
			}
			if ( flagWinningTeamIsCooperating ) {
				for ( var cK of State.variables.sc.teamAcharKeys ) {
					addPointsToDrive(gC(cK).dCooperation,(15+10*(0.1 * getAverageRelationStatBetweenCharAndGroup("friendship",cK,arrayMinusA(State.variables.sc.teamAcharKeys,cK)))));
				}
				for ( var cK of State.variables.sc.teamBcharKeys ) {
					addPointsToDrive(gC(cK).dCooperation,(6+4*(0.1 * getAverageRelationStatBetweenCharAndGroup("friendship",cK,arrayMinusA(State.variables.sc.teamBcharKeys,cK)))));
				}
			}
			break;
		case "teamBwin":
			// Set winner
			if ( State.variables.sc.teamBcharKeys.includes(State.variables.sc.aggressor) ) {
				flagIsWinnerAttacking = true;
			}
			// Restore Team B
			for ( var charKey of State.variables.sc.teamBcharKeys ) {
				gC(charKey).lust.restore();
			}
			// Cooperation check and drive changes
			for ( var cK of State.variables.sc.teamBcharKeys ) {
				if ( cK != State.variables.sc.teamBcharKeys[0] ) {
					if ( gC(cK).subChars.includes(State.variables.sc.teamBcharKeys[0]) == false && gC(cK).domChar != State.variables.sc.teamBcharKeys[0] ) {
						flagWinningTeamIsCooperating = true;
					}
				}
			}
			if ( flagWinningTeamIsCooperating ) {
				for ( var cK of State.variables.sc.teamBcharKeys ) {
					addPointsToDrive(gC(cK).dCooperation,(15+10*(0.1 * getAverageRelationStatBetweenCharAndGroup("friendship",cK,arrayMinusA(State.variables.sc.teamBcharKeys,cK)))));
				}
				for ( var cK of State.variables.sc.teamAcharKeys ) {
					addPointsToDrive(gC(cK).dCooperation,(6+4*(0.1 * getAverageRelationStatBetweenCharAndGroup("friendship",cK,arrayMinusA(State.variables.sc.teamAcharKeys,cK)))));
				}
			}
			break;
	}
	if ( flagIsWinnerAttacking ) { // Attacker win
		winner = State.variables.sc.aggressor;
		loser = State.variables.sc.defender;
		// Drive changes
		  // Attacker
		  addPointsToDrive(gC(winner).dDomination,(15+5*(0.1 * (getAverageRelationStatBetweenCharAndGroup("rivalry",winner,getCharsEnemyTeam(winner)) + getAverageRelationStatBetweenCharAndGroup("enmity",winner,getCharsEnemyTeam(winner))))));
		  addPointsToDrive(gC(winner).dAmbition,(15+10*(0.1 * (getAverageRelationStatBetweenCharAndGroup("enmity",winner,getCharsEnemyTeam(winner))))));
		  driveChangesMessage += gC(winner).getFormattedName() + " gained domination and ambition drive points.\n";
		  // Defender
		  addPointsToDrive(gC(loser).dImprovement,15+5*(0.1 * (getAverageRelationStatBetweenCharAndGroup("rivalry",winner,getCharsEnemyTeam(winner)) + getAverageRelationStatBetweenCharAndGroup("enmity",winner,getCharsEnemyTeam(winner)))));
		  driveChangesMessage += gC(loser).getFormattedName() + " gained self-improvement drive points.\n";
		  // Cooperation extra
		  if ( flagWinningTeamIsCooperating ) {
			  driveChangesMessage += gC(winner).getFormattedName() + "'s team members also gained cooperation drive points.\n";
		  }
	} else if ( flagStaleMate == false ) { // Defender win
		winner = State.variables.sc.defender;
		loser = State.variables.sc.aggressor;
		infamyMult = 0.5;
		// Drive changes
		  // Attacker
		  addPointsToDrive(gC(loser).dImprovement,(15+5*(0.1 * (getAverageRelationStatBetweenCharAndGroup("rivalry",winner,getCharsEnemyTeam(winner)) + getAverageRelationStatBetweenCharAndGroup("enmity",winner,getCharsEnemyTeam(winner))))));
		  addPointsToDrive(gC(loser).dDomination,-10);
		  addPointsToDrive(gC(loser).dAmbition,-10);
		  driveChangesMessage += gC(loser).getFormattedName() + " gained self-improvement drive points and lost domination and ambition drive points.\n";
		  // Defender
		  addPointsToDrive(gC(winner).dDomination,(7+1.5*(0.1 * (getAverageRelationStatBetweenCharAndGroup("rivalry",winner,getCharsEnemyTeam(winner)) + getAverageRelationStatBetweenCharAndGroup("enmity",winner,getCharsEnemyTeam(winner))))));
		  addPointsToDrive(gC(winner).dAmbition,(7+5*(0.1 * (getAverageRelationStatBetweenCharAndGroup("enmity",winner,getCharsEnemyTeam(winner))))));
		  driveChangesMessage += gC(winner).getFormattedName() + " gained domination and ambition drive points.\n";
		  // Cooperation extra
		  if ( flagWinningTeamIsCooperating ) {
			  driveChangesMessage += gC(winner).getFormattedName() + "'s team members also gained cooperation drive points.\n";
		  }
	}
	
	// Execute logic
	if ( flagStaleMate == false ) {
		if ( winner != "chPlayerCharacter" ) { // NPC victory
			potentialBattleDemands = getAllPotentialBattleDemands(winner,loser,stakes,infamyMult);
			
			var battleDemandData = selectBattleDemandFromList(potentialBattleDemands);
			var extra1 = battleDemandData[2];
			var extra2 = battleDemandData[3];
			selectedBattleDemand = battleDemandData[1];
			selectedBattleDemand.provokeEffect(winner,loser,stakes,infamyMult,extra1,extra2);
			if ( driveChangesMessage != "" ) { resultsMessage += driveChangesMessage + "\n"; }
			resultsMessage += selectedBattleDemand.resultMessage(winner,loser,stakes,infamyMult,extra1,extra2);
			var returnPassage = selectedBattleDemand.getPassageLink(winner,loser);
			resultsMessage += "\n\n<<link[[Continue|" + returnPassage +"]]>><<s" + "cript>>State.variables.compass.pushAllTimeToAdvance();\nState.variables.compass.pushAllTimeToAdvance();<</s" + "cript>><</l" + "ink>>";
		} else { // Player victory
			resultsMessage = "You won! You may now demand something from " + gC(loser).name + ".\n\n"
						   + formatBattleDemandButtons(loser,stakes,infamyMult);
		}
	} else {
		resultsMessage = "Stalemate!\n\n[[Continue|Map]]";
	}
	
	// Finish formatting
	State.variables.compass.sceneResultsPassage = resultsMessage;
}
window.processLiberationChallengeEffects = function() {
	// Find winners and losers
	var flagStaleMate = false;
	var winner = "";
	var loser = "";
	
	var flagIsWinnerAttacking = false;
	var infamyMult = 1;
	var stakes = State.variables.sc.stakes;
	
	var resultsMessage = "";
	
	var selectedBattleDemand = null;
	
	switch (State.variables.sc.extraEndInfo) {
		case "stalemate":
			flagStaleMate = true;
			break;
		case "teamAwin":
			// Set winner
			if ( State.variables.sc.teamAcharKeys.includes(State.variables.sc.aggressor) ) {
				flagIsWinnerAttacking = true;
			}
			// Restore Team A
			for ( var charKey of State.variables.sc.teamAcharKeys ) {
				gC(charKey).lust.restore();
			}
			break;
		case "teamBwin":
			// Set winner
			if ( State.variables.sc.teamBcharKeys.includes(State.variables.sc.aggressor) ) {
				flagIsWinnerAttacking = true;
			}
			// Restore Team B
			for ( var charKey of State.variables.sc.teamBcharKeys ) {
				gC(charKey).lust.restore();
			}
			break;
	}
	if ( flagIsWinnerAttacking ) {
		winner = State.variables.sc.aggressor;
		loser = State.variables.sc.defender;
	} else if ( flagStaleMate == false ) {
		winner = State.variables.sc.defender;
		loser = State.variables.sc.aggressor;
		infamyMult = 0.5;
	}
	
	// Execute logic
	if ( flagStaleMate == false ) {
		if ( gC(winner).domChar == loser ) {
			// Drive changes
			addPointsToDrive(gC(loser).dAmbition,-10);
			addPointsToDrive(gC(loser).dDomination,-10);
			addPointsToDrive(gC(loser).dImprovement,20);
			// Relations effects
			resultsMessage = gC(winner).getFormattedName() + " won the challenge! " + gC(winner).getFormattedName() + " will no longer be submissive to " + gC(loser).getFormattedName() + "." + gC(loser).getFormattedName() + " lost 10 ambition and domination drive points, and gained 20 self-improvement drive points." + "\n\n[[Continue|Map]]";
			finishRelType(winner,loser);
		} else if ( gC(loser).domChar == winner ) {
			// Drive changes
			addPointsToDrive(gC(loser).dAmbition,-20);
			addPointsToDrive(gC(loser).dImprovement,20);
			// Relations effects
			resultsMessage = gC(winner).getFormattedName() + " won the challenge! " + gC(winner).getFormattedName() + " stole 3 merit from " + gC(loser).getFormattedName() + ", gained domination towards " + gC(loser).comPr + " and will extend their relationship for an extra day. " + gC(loser).getFormattedName() + " lost 20 ambition drive points and gained 20 self-improvement drive points." + "\n\n[[Continue|Map]]";
			gC(winner).relations[loser].domination.stv += 250;
			gC(winner).changeMerit(3);
			gC(loser).relations[winner].submission.stv += 250;
			gC(loser).changeMerit(-3);
			gRelTypeAb(winner,loser).days++;
			gRelTypeAb(loser,winner).days++;
		}
	} else {
		resultsMessage = "The battle was inconclusive!\n\n[[Continue|Map]]";
	}
	
	// Finish formatting
	State.variables.compass.sceneResultsPassage = resultsMessage;
}

window.formatGenericBattlePlayerChoice = function(message,nextPassage) {
	State.variables.compass.sceneResultsPassage = message + "\n\n<<link[[Continue|" + nextPassage +"]]>><<s" + "cript>>State.variables.compass.pushAllTimeToAdvance();\nState.variables.compass.pushAllTimeToAdvance();<</s" + "cript>><</l" + "ink>>";
}
window.getAllPotentialBattleDemands = function(actor,target,stakes,infamyMult) {
	var potentialDemands = [];
	for ( var bd of setup.battleDemandsDB ) {
		if ( bd.isPossible(actor,target,stakes) ) {
			potentialDemands = potentialDemands.concat(bd.generateChoicesValuesForNpcs(actor,target,stakes,infamyMult));
		}
	}
	return potentialDemands;
}
window.selectBattleDemandFromList = function(battleDemandList) {
	var bd = null;
	var highestValue = -1;
	var highestValueIterator = 0;
	var i = 0;
	for ( var bdi of battleDemandList ) {
		if ( bdi[0] > highestValue ) {
			highestValue = bdi[0];
			highestValueIterator = i;
		}
		i++;
	}
	bd = battleDemandList[highestValueIterator];
	return bd;
}
window.getNpcDemandOnWinningBattle = function(actor,target,stakes,infamyMult) {
	var infamy = gC(actor).infamy;
	var choices = [ "doNothing" , "humilliate" , "forceServitude" ];
	var decision = "doNothing";
	var result = null;
	var hostility = limitedRandomInt(20) - 10 + rLvlAbt(actor,target,"rivalry") * limitedRandomInt(30) + rLvlAbt(actor,target,"enmity") * limitedRandomInt(30) + rLvlAbt(actor,target,"sexualTension") * limitedRandomInt(20) - rLvlAbt(actor,target,"friendship") * limitedRandomInt(10) - rLvlAbt(actor,target,"romance") * limitedRandomInt(10) + gC(target).infamy;
	// TO DO: REMOVE THIS LATER
	if ( actor == "chClaw" ) {
		hostility += 15;
	} else if ( actor == "chVal" ) {
		hostility += 5;
	} else if ( actor == "chMir" ) {
		hostility -= 15;
	}
	if ( infamyMult < 1 ) {
		hostility += 10;
	}
	
	if ( infamy > 20 ) {
		decision = "doNothing";
	} else if ( infamy < 15 && hostility > 5 && stakes >= 3 && gSettings().servitudeRelationships == "enable"
			 && gC(target).domChar == null && gC(target).subChars.length == 0 && gC(actor).domChar == null ) {
		decision = "forceServitude";
	} else if ( hostility > 0 ) {
		decision = "humilliate";
	} else {
		decision = "doNothing";
	}
	
	switch ( decision ) {
		case "doNothing":
			result = createBdemandDoNothing();
			break;
		case "humilliate":
			result = createBdemandHumillitation();
			break;
		case "forceServitude":
			result = createBdemandForceServitude();
			break;
	}
	
	return result;
}


// Functions to keybind links //

State.variables.foundLinks = [];
State.variables.keysAssigned = [];

$(document).on(':passagedisplay', function (ev) {
	if ( tags().includes("sc") ) {
		State.variables.sc.markNextTurnLink();
	}
});

$(document).on("keyup",function(e) {
	if ( e.key != undefined ) {
		for ( var k of State.variables.keysAssigned ) {
			if ( e.key == k[0] ) {
				e.preventDefault();
				$("#" + k[1]).click();
				return false;
			}
		}
	}
});

////////// EQUIPMENT CLASS //////////
// Equipment database

// State.variables.equipmentList = []; // This goes at StoryInit

// Instance of an equipment object. May be weapons, armor, accesories or bondage

	// Constructor functions
window.Equipment = function(id,type,owner) {
	this.id = id; // Identifier of the object instance
	this.type = type; // Selected through an enum, links to the identifier of the object type
	this.days = -2; // Remaining days. -2 means it is not equipped, -1 means it may always be unlocked, >0 means the remaining days until it gets unlocked
	this.owner = owner; // Equipment's owner's charKey
	this.equippedOn = null; // Who's wearing the equipment
	// this.inUse = null; // Initially non-existing property to save up memory. While it doesn't exist, the weapon isn't in use
}
	// Use this to create equipment
window.createEquipment = function(type,owner) {
	var id = State.variables.equipmentList.length;
	State.variables.equipmentList.push(new Equipment(id,type,owner));
	gC(owner).ownedEquipment.push(id);
	return id;
}

	// Getters
window.getEquipById = function(id) {
	var equip = null;
	for ( var eq of State.variables.equipmentList ) {
		if ( eq.id == id ) {
			equip = eq;
			return equip;
		}
	}
	return equip;
}
window.getEquipDataById = function(id) {
	var data = null;
	var eq = getEquipById(id);
	if ( eq != null ) { data = setup.equipDataList[eq.type]; }
	return data;
}

window.getItemDescriptionById = function(id) {
	var tText = '<span title="' + getEquipDataById(id).description + '">^^(?)^^</span>';
	return tText;
}
window.getItemDescriptionBySetupId = function(id) {
	var tText = '<span title="' + setup.equipDataList[id].description + '">^^(?)^^</span>';
	return tText;
}

	// Basic functions
window.mayEquipmentBePut = function(id,wearer) {
	var flagEquippable = true;
	var equipment = getEquipById(id);
	var data = getEquipDataById(id);
	if ( equipment.equippedOn != null ) {
		flagEquippable = false;
	} else if ( data.slotType == "bodypart" ) {
		if ( gC(wearer).body.hasOwnProperty(data.slot) == false ) {
			flagEquippable = false;
		} else {
			if ( gC(wearer).body[data.slot].state != "free" || gC(wearer).body[data.slot].bondage != -1 ) {
				flagEquippable = false;
			}
		}
	} else if ( data.slotType == "tool" ) {
		if ( data.slot == "weapon" ) {
			if ( gC(wearer).weaponID != -1 ) {
				flagEquippable = false;
			}
		}
	}
	return flagEquippable;
}
window.equipObjectOnWearer = function(id,wearer,days) {
	var equipment = getEquipById(id);
	if ( equipment != null ) {
		equipment.equippedOn = wearer;
		equipment.days = days;
		var data = getEquipDataById(id);
		if ( data.slotType == "bodypart" ) { // Bondage
			gC(wearer).body[data.slot].bondage = id;
			gC(wearer).body[data.slot].state = "locked";
		} else if ( data.slotType == "tool" ) { // Tools
			if ( data.slot == "weapon" ) {
				gC(wearer).weaponID = id;
			}
		}
		data.putOnEffect(equipment.owner,wearer); // Main effects
		charactersLearnSceneActions([wearer],data.learntActions);
		
		// Bondage taste chance
		if ( equipment.owner != wearer ) {
			if ( limitedRandomInt(100) > 50 ) {
				gC(equipment.owner).tastes.bondage.w += limitedRandomInt(4);
			}
			if ( limitedRandomInt(100) > 50 ) {
				gC(wearer).tastes.bondage.w += limitedRandomInt(4);
			}
		}
	}
}
window.unequipObject = function(id) {
	var equipment = getEquipById(id);
	if ( equipment != null ) {
		if ( equipment.equippedOn != null ) {
			equipment.days = -2;
			var data = getEquipDataById(id);
			if ( data.slotType == "bodypart" ) {
				gC(equipment.equippedOn).body[data.slot].bondage = -1;
				gC(equipment.equippedOn).body[data.slot].state = "free";
			} else if ( data.slotType == "tool" ) {
				if ( data.slot == "weapon" ) {
					gC(equipment.equippedOn).weaponID = -1;
				}
			}
			data.putOutEffect(equipment.owner,equipment.equippedOn);
			charactersForgetSceneActions([equipment.equippedOn],data.learntActions);
			equipment.equippedOn = null;
		}
	}
}

window.charBuysItem = function(charKey,equipType) {
	var equipData = setup.equipDataList[equipType];
	gC(charKey).money -= equipData.price;
	var id = createEquipment(equipType,charKey);
	return id;
}
window.itemIsLost = function(id) {
	var owner = getEquipById(id).owner;
	gC(owner).ownedEquipment = arrayMinusA(gC(owner).ownedEquipment,id);
	getEquipById(id).owner = null;
}
window.removeItem = function(id) {
	unequipObject(id);
	itemIsLost(id);
	for ( var eId in State.variables.equipmentList ) {
		var intId = State.variables.equipmentList[parseInt(eId)].id;
		if ( intId >= id ) {
			lowerItemIdByOne(intId);
		}
	}
	removeLostItems();
	fixOwnedEquipmentLists();
}
window.lowerItemIdByOne = function(id) {
	var item = getEquipById(id);
	var itemData = getEquipDataById(id);
	item.id--;
	if ( item.equippedOn ) {
		if ( itemData.slotType == "bodypart" ) {
			gC(item.equippedOn).body[itemData.slot].bondage--;
		} else if ( itemData.slotType == "tool" ) {
			if ( itemData.slot == "weapon" ) {
				gC(item.equippedOn).weaponID--;
			}
		}
	}
}
window.removeLostItems = function() {
	var newItemsList = [];
	for ( var item of State.variables.equipmentList ) {
		if ( item.owner != null ) {
			newItemsList.push(item);
		}
	}
	State.variables.equipmentList = newItemsList;
}

	// Extra
window.isCharsWeaponInUse = function(charKey) {
	var flagInUse = false;
	var wId = getCharsWeaponId(charKey);
	if ( wId != -1 ) {
		if ( getEquipById(wId).hasOwnProperty("inUse") ) {
			flagInUse = true;
		}
	}
	return flagInUse;
}
window.setCharsWeaponInUse = function(charKey) {
	var wId = getCharsWeaponId(charKey);
	if ( wId != -1 ) {
		getEquipById(wId).inUse = true;
	}
}
window.setCharsWeaponUnused = function(charKey) {
	var wId = getCharsWeaponId(charKey);
	if ( wId != -1 ) {
		delete getEquipById(wId).inUse;
	}
}

	// Specific unequip
window.unequipToolTypeFromChar = function(type,charKey) {
	if ( gC(charKey)[type] != -1 ) {
		unequipObject(gC(charKey)[type]);
	}
}

	// Auxiliar
window.getCharsWeaponId = function(charKey) {
	return gC(charKey).weaponID;
}

	// Bug fixing
window.fixOwnedEquipmentLists = function() {
	for ( var cK of ["chDummy"].concat(getActiveSimulationCharactersArray()) ) {
		gC(cK).ownedEquipment = [];
	}
	for ( var eq of State.variables.equipmentList ) {
		gC(eq.owner).ownedEquipment.push(eq.id);
	}
}

// Constructors, serializers, etc.
Equipment.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
Equipment.prototype.clone = function () {
	return (new Equipment())._init(this);
};
Equipment.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Equipment())._init($ReviveData$)', ownData);
};

// EQUIPMENT DATA

window.equipmentData = function(name,slotType,slot,putOnEffect,putOutEffect,description,price,infamy,strategyTags,learntActions) {
	this.name = name;
	this.slotType = slotType;
	this.slot = slot;
	this.putOnEffect = putOnEffect;
	this.putOutEffect = putOutEffect;
	this.learntActions = [];
	this.description = description;
	this.price = price;
	this.infamy = infamy;
	this.strategyTags = strategyTags;
	this.learntActions = learntActions;
}

/*
Strategy tags - Bondage
["bondage","attackMagic","chastity"]
Strategy tags - Weapons
[["physique",1],["resilience",1]]
[FIRST VALUE = Type of tag, SECOND VALUE = Quality of tag]
*/

const equipmentType = {
	COLLAR: "b0",
	BLINDFOLD: "b1",
	MOUTHGAG: "b2",
	HANDCUFFS: "b3",
	FEETCUFFS: "b4",
	NIPPLESUCKERS: "b5",
	BUTTPLUG: "b6",
	CHASTITYBELT: "b7",
	CHASTITYCAGE: "b8",
	
	STAFFOFBATTLE: "w0",
	KNUCKLES: "w1",
	WAND: "w2",
	HANDFAN: "w3",
	HUNTINGBOW: "w4",
	DILDO: "w5"
}
/*const equipmentType = {
	COLLAR: 0,
	BLINDFOLD: 1,
	MOUTHGAG: 2,
	HANDCUFFS: 3,
	FEETCUFFS: 4,
	NIPPLESUCKERS: 5,
	BUTTPLUG: 6,
	CHASTITYBELT: 7,
	CHASTITYCAGE: 8,
	
	STAFFOFBATTLE: 100,
	KNUCKLES: 101,
	WAND: 102,
	HANDFAN: 103
}
*/

setup.equipDataList = [];
	// Bondage
setup.equipDataList[equipmentType.COLLAR] = new equipmentData("Collar","bodypart","neck",
	function(owner,wearer) { // Put on
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod += 3;
			getRelation(wearer,owner).sexualTension.levelMod += 1;
		}
		gC(wearer).will.sumModifier -= 2;
		gC(wearer).will.multModifier -= 0.1;
		gC(wearer).charisma.sumModifier -= 2;
		gC(wearer).charisma.multModifier -= 0.1;
	},
	function(owner,wearer) { // Put out
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod -= 3;
			getRelation(wearer,owner).sexualTension.levelMod -= 1;
		}
		gC(wearer).will.sumModifier += 2;
		gC(wearer).will.multModifier += 0.1;
		gC(wearer).charisma.sumModifier += 2;
		gC(wearer).charisma.multModifier += 0.1;
	}, "A leather collar. It gets locked in the neck to mark possession over the wearer."
		+ "\nIncreases submission and sexual tension, decreases will and charisma. Locks neck.\n1 infamy upon forced equipment.",
	750,1,["bondage","domination"],[]);
setup.equipDataList[equipmentType.BLINDFOLD] = new equipmentData("Blindfold","bodypart","eyes",
	function(owner,wearer) { // Put on
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod += 2;
			getRelation(wearer,owner).rivalry.levelMod += 1;
		}
		gC(wearer).perception.sumModifier -= 5;
		gC(wearer).perception.multModifier -= 0.4;
		gC(wearer).empathy.sumModifier -= 2;
		gC(wearer).empathy.multModifier -= 0.1;
	},
	function(owner,wearer) { // Put out
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod -= 2;
			getRelation(wearer,owner).rivalry.levelMod -= 1;
		}
		gC(wearer).perception.sumModifier += 5;
		gC(wearer).perception.multModifier += 0.4;
		gC(wearer).empathy.sumModifier += 2;
		gC(wearer).empathy.multModifier += 0.1;
	}, "A linen blindfold. It gets locked eyes of the wearer, difficulting vision."
		+ "\nIncreases submission, rivalry and enmity, decreases perception and empathy. Locks eyes.\n2 infamy upon forced equipment.",
	1500,2,["bondage"],[]);
setup.equipDataList[equipmentType.MOUTHGAG] = new equipmentData("Mouth gag","bodypart","mouth",
	function(owner,wearer) { // Put on
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod += 2;
			getRelation(wearer,owner).rivalry.levelMod += 1;
		}
		gC(wearer).charisma.sumModifier -= 5;
		gC(wearer).charisma.multModifier -= 0.4;
	},
	function(owner,wearer) { // Put out
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod -= 2;
			getRelation(wearer,owner).rivalry.levelMod -= 1;		
		}
		gC(wearer).charisma.sumModifier += 5;
		gC(wearer).charisma.multModifier += 0.4;
	}, "A leather mouth gag. It blocks the mouth of the wearer, difficulting communication."
		+ "\nIncreases submission, rivalry and enmity, decreases charisma. Locks mouth.\n2 infamy upon forced equipment.",
	1500,2,["bondage","attackSocial"],[]);
setup.equipDataList[equipmentType.HANDCUFFS] = new equipmentData("Handcuffs","bodypart","arms",
	function(owner,wearer) { // Put on
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod += 3;
			getRelation(wearer,owner).rivalry.levelMod += 1;
			getRelation(wearer,owner).enmity.levelMod += 1;
		}
		gC(wearer).agility.sumModifier -= 3;
		gC(wearer).agility.multModifier -= 0.3;
		gC(wearer).physique.sumModifier -= 3;
		gC(wearer).physique.multModifier -= 0.3;
	},
	function(owner,wearer) { // Put out
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod -= 3;
			getRelation(wearer,owner).rivalry.levelMod -= 1;
			getRelation(wearer,owner).enmity.levelMod -= 1;
		}
		gC(wearer).agility.sumModifier += 3;
		gC(wearer).agility.multModifier += 0.3;
		gC(wearer).physique.sumModifier += 3;
		gC(wearer).physique.multModifier += 0.3;
	}, "Leather handcuffs, which difficult the movement of the wearer's arms."
		+ "\nIncreases submission, rivalry and enmity, decreases agility and physique. Locks arms.\n3 infamy upon forced equipment.",
	2000,3,["bondage","attackPhysical"],[]);
setup.equipDataList[equipmentType.FEETCUFFS] = new equipmentData("Feetcuffs","bodypart","legs",
	function(owner,wearer) { // Put on
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod += 3;
			getRelation(wearer,owner).rivalry.levelMod += 1;
			getRelation(wearer,owner).enmity.levelMod += 1;
		}
		gC(wearer).agility.sumModifier -= 2;
		gC(wearer).agility.multModifier -= 0.2;
		gC(wearer).resilience.sumModifier -= 3;
		gC(wearer).resilience.multModifier -= 0.3;
	},
	function(owner,wearer) { // Put out
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod -= 3;
			getRelation(wearer,owner).rivalry.levelMod -= 1;
			getRelation(wearer,owner).enmity.levelMod -= 1;
		}
		gC(wearer).agility.sumModifier += 2;
		gC(wearer).agility.multModifier += 0.2;
		gC(wearer).resilience.sumModifier += 3;
		gC(wearer).resilience.multModifier += 0.3;
	}, "Leather feetcuffs, which difficult the movement of the wearer's legs."
		+ "\nIncreases submission, rivalry and enmity, decreases agility and resilience. Locks legs.\n3 infamy upon forced equipment.",
	2000,3,["bondage","attackPhysical"],[]);
setup.equipDataList[equipmentType.NIPPLESUCKERS] = new equipmentData("Nipple suckers","bodypart","breasts",
	function(owner,wearer) { // Put on
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod += 2;
			getRelation(wearer,owner).sexualTension.levelMod += 2;
			getRelation(wearer,owner).rivalry.levelMod += 1;
		}
		gC(wearer).lust.weakness += 10;
		gC(wearer).alteredStates.push(createASnipplesuckers());
	},
	function(owner,wearer) { // Put out
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod -= 2;
			getRelation(wearer,owner).sexualTension.levelMod -= 2;
			getRelation(wearer,owner).rivalry.levelMod -= 1;
		}
		removeAlteredStateByAcr(wearer,"Npsk");
		gC(wearer).lust.weakness -= 10;
	}, "A magical device that suctions the wearer's nipples."
		+ "\nIncreases submission, sexual tension and rivalry, as well as weakness to lust damage. Locks breasts.\n2 infamy upon forced equipment.",
	1500,2,["bondage","attackAll"],[]);
setup.equipDataList[equipmentType.BUTTPLUG] = new equipmentData("Buttplug","bodypart","anus",
	function(owner,wearer) { // Put on
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod += 2;
			getRelation(wearer,owner).sexualTension.levelMod += 2;
			getRelation(wearer,owner).rivalry.levelMod += 1;
		}
		gC(wearer).alteredStates.push(createASbuttplug());
		gC(wearer).lust.weakness += 10;
		gC(wearer).energy.tainted += 10;
	},
	function(owner,wearer) { // Put out
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod -= 2;
			getRelation(wearer,owner).sexualTension.levelMod -= 2;
			getRelation(wearer,owner).rivalry.levelMod -= 1;
		}
		removeAlteredStateByAcr(wearer,"Btpg");
		gC(wearer).lust.weakness -= 10;
		gC(wearer).energy.tainted -= 10;
	}, "A toy that gets locked in the ass."
		+ "\nIncreases submission, sexual tension and rivalry, as well as weakness to lust damage and tainting energy. Locks ass.\n2 infamy upon forced equipment.",
	2000,2,["bondage","attackAll"],[]);
setup.equipDataList[equipmentType.CHASTITYBELT] = new equipmentData("Chastity belt","bodypart","pussy",
	function(owner,wearer) { // Put on
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod += 4;
			getRelation(wearer,owner).sexualTension.levelMod += 4;
			getRelation(wearer,owner).rivalry.levelMod += 1;
			getRelation(wearer,owner).enmity.levelMod += 1;
		}
		gC(wearer).intelligence.sumModifier -= 2;
		gC(wearer).intelligence.multModifier -= 0.2;
		gC(wearer).will.sumModifier -= 2;
		gC(wearer).will.multModifier -= 0.2;
		gC(wearer).lust.weakness += 15;
		gC(wearer).willpower.weakness += 10;
		if ( limitedRandomInt(100) > 30 ) {
			gC(owner).tastes.denial.w += limitedRandomInt(5);
		}
		if ( limitedRandomInt(100) > 40 ) {
			gC(wearer).tastes.denial.w += limitedRandomInt(4);
		}
	},
	function(owner,wearer) { // Put out
		removeAlteredStateByAcrAndExtra(wearer,"UnBp","bodypart","pussy");
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod -= 4;
			getRelation(wearer,owner).sexualTension.levelMod -= 4;
			getRelation(wearer,owner).rivalry.levelMod -= 1;
			getRelation(wearer,owner).enmity.levelMod -= 1;
		}
		gC(wearer).intelligence.sumModifier += 2;
		gC(wearer).intelligence.multModifier += 0.2;
		gC(wearer).will.sumModifier += 2;
		gC(wearer).will.multModifier += 0.2;
		gC(wearer).lust.weakness -= 15;
		gC(wearer).willpower.weakness -= 10;		
	}, "A metal shield that locks the wearer's pussy. It may provoke sexual frustration."
		+ "\nIncreases submission, sexual tension, rivalry and enmity. Reduces intelligence and will, and increases weakness to lust and willpower damage. Locks pussy.\n3 infamy upon forced equipment.",
	2500,3,["bondage","attackMagic","chastity"],[]);
setup.equipDataList[equipmentType.CHASTITYCAGE] = new equipmentData("Chastity cage","bodypart","dick",
	function(owner,wearer) { // Put on
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod += 4;
			getRelation(wearer,owner).sexualTension.levelMod += 4;
			getRelation(wearer,owner).rivalry.levelMod += 1;
			getRelation(wearer,owner).enmity.levelMod += 1;
		}
		gC(wearer).intelligence.sumModifier -= 2;
		gC(wearer).intelligence.multModifier -= 0.2;
		gC(wearer).will.sumModifier -= 2;
		gC(wearer).will.multModifier -= 0.2;
		gC(wearer).lust.weakness += 15;
		gC(wearer).willpower.weakness += 10;
		if ( limitedRandomInt(100) > 30 ) {
			gC(owner).tastes.denial.w += limitedRandomInt(5);
		}
		if ( limitedRandomInt(100) > 40 ) {
			gC(wearer).tastes.denial.w += limitedRandomInt(4);
		}
	},
	function(owner,wearer) { // Put out
		removeAlteredStateByAcrAndExtra(wearer,"UnBp","bodypart","dick");
		if ( getRelation(wearer,owner) != undefined ) {
			getRelation(wearer,owner).submission.levelMod -= 4;
			getRelation(wearer,owner).sexualTension.levelMod -= 4;
			getRelation(wearer,owner).rivalry.levelMod -= 1;
			getRelation(wearer,owner).enmity.levelMod -= 1;
		}
		gC(wearer).intelligence.sumModifier += 2;
		gC(wearer).intelligence.multModifier += 0.2;
		gC(wearer).will.sumModifier += 2;
		gC(wearer).will.multModifier += 0.2;
		gC(wearer).lust.weakness -= 15;
		gC(wearer).willpower.weakness -= 10;	
	}, "A metal cage that locks the wearer's dick. It may provoke sexual frustration."
		+ "\nIncreases submission, sexual tension, rivalry and enmity. Reduces intelligence and will, and increases weakness to lust and willpower damage. Locks dick.\n3 infamy upon forced equipment.",
	2500,3,["bondage","attackMagic","chastity"],[]);
	
	// Weapons
setup.equipDataList[equipmentType.STAFFOFBATTLE] = new equipmentData("Staff of battle","tool","weapon",
	function(owner,wearer) { // Put on
		gC(wearer).physique.sumModifier += 2;
		gC(wearer).physique.multModifier += 0.1;
		gC(wearer).resilience.sumModifier += 2;
		gC(wearer).resilience.multModifier += 0.1;
	},
	function(owner,wearer) { // Put out
		gC(wearer).physique.sumModifier -= 2;
		gC(wearer).physique.multModifier -= 0.1;
		gC(wearer).resilience.sumModifier -= 2;
		gC(wearer).resilience.multModifier -= 0.1;
	}, "A wooden staff, great for physical offense and defense."
		+ "\nIncreases physique and resilience.",
	2000,0,
	[["physique",1],["resilience",1]],["staffSwipe"]);
setup.equipDataList[equipmentType.KNUCKLES] = new equipmentData("Knuckles","tool","weapon",
	function(owner,wearer) { // Put on
		gC(wearer).physique.sumModifier += 2;
		gC(wearer).physique.multModifier += 0.1;
		gC(wearer).agility.sumModifier += 2;
		gC(wearer).agility.multModifier += 0.1;
	},
	function(owner,wearer) { // Put out
		gC(wearer).physique.sumModifier -= 2;
		gC(wearer).physique.multModifier -= 0.1;
		gC(wearer).agility.sumModifier -= 2;
		gC(wearer).agility.multModifier -= 0.1;
	}, "Brass knuckles that will make the user pack a punch."
		+ "\nIncreases physique and agility.",
	2000,0,
	[["physique",1],["agility",1]],["boldJab"]);
setup.equipDataList[equipmentType.WAND] = new equipmentData("Wand","tool","weapon",
	function(owner,wearer) { // Put on
		gC(wearer).intelligence.sumModifier += 2;
		gC(wearer).intelligence.multModifier += 0.1;
		gC(wearer).will.sumModifier += 2;
		gC(wearer).will.multModifier += 0.1;
	},
	function(owner,wearer) { // Put out
		gC(wearer).intelligence.sumModifier -= 2;
		gC(wearer).intelligence.multModifier -= 0.1;
		gC(wearer).will.sumModifier -= 2;
		gC(wearer).will.multModifier -= 0.1;
	}, "A magical wand, most useful to control the flow of aether."
		+ "\nIncreases intelligence and will.",
	2000,0,
	[["intelligence",1],["will",1]],["channelAether"]);
setup.equipDataList[equipmentType.HANDFAN] = new equipmentData("Hand fan","tool","weapon",
	function(owner,wearer) { // Put on
		gC(wearer).perception.sumModifier += 2;
		gC(wearer).perception.multModifier += 0.1;
		gC(wearer).charisma.sumModifier += 2;
		gC(wearer).charisma.multModifier += 0.1;
	},
	function(owner,wearer) { // Put out
		gC(wearer).perception.sumModifier -= 2;
		gC(wearer).perception.multModifier -= 0.1;
		gC(wearer).charisma.sumModifier -= 2;
		gC(wearer).charisma.multModifier -= 0.1;
	}, "A magical fan, favored by illusionists."
		+ "\nIncreases perception and charisma.",
	2000,0,
	[["perception",1],["charisma",1]],["flaunt"]);
setup.equipDataList[equipmentType.HUNTINGBOW] = new equipmentData("Hunting bow","tool","weapon",
	function(owner,wearer) { // Put on
		gC(wearer).perception.sumModifier += 2;
		gC(wearer).perception.multModifier += 0.1;
		gC(wearer).agility.sumModifier += 2;
		gC(wearer).agility.multModifier += 0.1;
	},
	function(owner,wearer) { // Put out
		gC(wearer).perception.sumModifier -= 2;
		gC(wearer).perception.multModifier -= 0.1;
		gC(wearer).agility.sumModifier -= 2;
		gC(wearer).agility.multModifier -= 0.1;
	}, "A short bow, appropriate for hunting prey."
		+ "\nIncreases agility and perception.",
	2000,0,
	[["perception",1],["agility",1]],["disablingShot"]);

setup.equipDataList[equipmentType.DILDO] = new equipmentData("Dildo","tool","weapon",
	function(owner,wearer) { // Put on
		gC(wearer).physique.sumModifier += 1;
		gC(wearer).physique.multModifier += 0.1;
		gC(wearer).agility.sumModifier += 1;
		gC(wearer).agility.multModifier += 0.1;
		gC(wearer).combatAffinities.sex.strength += 10;
		gC(wearer).combatAffinities.sex.weakness += 10;
	},
	function(owner,wearer) { // Put out
		gC(wearer).physique.sumModifier -= 1;
		gC(wearer).physique.multModifier -= 0.1;
		gC(wearer).agility.sumModifier -= 1;
		gC(wearer).agility.multModifier -= 0.1;
		gC(wearer).combatAffinities.sex.strength -= 10;
		gC(wearer).combatAffinities.sex.weakness -= 10;
	}, "A ceramic dildo, able to penetrate others during intimacy and battle."
		+ "\nIncreases physique and agility, as well as sex strength and weakness. Provides with several actions in sex and combat scenes.",
	3000,0,
	[["physique",1],["agility",1]],["dildoTeaseGenitals","dildoPenetratePussy","dildoPenetrateAss","dildoPenetrateMouth","thrustDildo","doubleDildoPussyPenetration","baDildoPenetratePussy","baThrustDildo"]);

// AI

window.npcValuesBondage = function(charKey,bondageId) {
	var value = 100;
	var bondageData = setup.equipDataList[bondageId];
	var bondageType = bondageData.slot;
	for ( var equipment of gC(charKey).ownedEquipment ) {
		var equipData = getEquipDataById(equipment);
		if ( equipData.slotType == "bodypart" ) {
			if ( equipData.slot == bondageType ) {
				if ( getEquipById(equipment).equippedOn == null ) {
					value -= 40;
				} else {
					value -= 20;
				}
			}
		}
		if ( bondageId == getEquipById(equipment).id ) {
			value -= 40;
		}
	}
	return value;
}
window.npcValuesWeapon = function(charKey,weaponData) {
	var value = 0;
	for ( var tag of weaponData.strategyTags ) {
		switch (tag[0]) {
			case "physique":
				value += gC(charKey).physique.value * tag[1];
				break;
			case "agility":
				value += gC(charKey).agility.value * tag[1];
				break;
			case "resilience":
				value += gC(charKey).resilience.value * tag[1];
				break;
			case "intelligence":
				value += gC(charKey).intelligence.value * tag[1];
				break;
			case "will":
				value += gC(charKey).will.value * tag[1];
				break;
			case "perception":
				value += gC(charKey).perception.value * tag[1];
				break;
			case "charisma":
				value += gC(charKey).charisma.value * tag[1];
				break;
			case "empathy":
				value += gC(charKey).empathy.value * tag[1];
				break;
			case "luck":
				value += gC(charKey).luck.value * tag[1];
				break;
		}
	}
	
	return value;
}
window.equipmentIsBondage = function(equipData) {
	if ( equipData.slotType == "bodypart" ) {
		return true;
	} else {
		return false;
	}
}
window.equipmentIsWeapon = function(equipData) {
	if ( equipData.slotType == "tool" && equipData.slot == "weapon" ) {
		return true;
	} else {
		return false;
	}
}

window.getCharsUnusedBondage = function(charKey) {
	var itemList = [];
	for ( var item of gC(charKey).ownedEquipment ) {
		if ( equipmentIsBondage(getEquipDataById(item)) ) {
			if ( getEquipById(item).equippedOn == null ) {
				itemList.push(item);
			}
		}
	}
	return itemList;
}
window.getItemListEquippableOnChar = function(charKey,itemList) {
	var newItemList = [];
	for ( var item of itemList ) {
		if ( mayEquipmentBePut(item,charKey) ) {
			newItemList.push(item);
		}
	}
	return newItemList;
}
window.purgeChastityItemsFromItemList = function(itemList) {
	var newItemList = [];
	for ( var item of itemList ) {
		var type = getEquipById(item).type;
		if ( type == equipmentType.CHASTITYBELT || type == equipmentType.CHASTITYCAGE ) {
		} else {
			newItemList.push(item);
		}
	}
	return newItemList;
}
window.getActorsEquippableBondageOnTarget = function(actor,target) {
	var bondageList = [];
	
	for ( var item of gC(actor).ownedEquipment ) {
		if ( equipmentIsBondage(item) && mayEquipmentBePut(item,target) ) {
			bondageList.push(target);
		}
	}
	
	return bondageList;
}

window.chooseBestBondageForTargetByActor = function(bondageIDsList,target,actor) {
	var chosenID = bondageIDsList[0];
	var bondageScores = [];
	
	var physicalScore = gC(target).physique.value + gC(target).agility.value + gC(target).resilience.value;
	var magicalScore = gC(target).intelligence.value + gC(target).will.value + gC(target).perception.value;
	var socialScore = (gC(target).charisma.value + gC(target).empathy.value) * 1.5;
	var totalScore = physicalScore + magicalScore + socialScore;
	
	for ( var bondage of bondageIDsList ) {
		var tags = getEquipDataById(bondage).strategyTags;
		var score = 0;
		
		// Stats score
		if ( tags.includes("attackPhysical") ) {
			score += physicalScore;
		} else if ( tags.includes("attackMagic") ) {
			score += magicalScore;
		} else if ( tags.includes("attackSocial") ) {
			score += socialScore;
		} else {
			score += totalScore * 0.4;
		}
		
		// Preferences score
		if ( tags.includes("chastity") ) {
			score += ( gC(actor).tastes.denial.r * 20 );
			score *= ( 1 + gC(actor).tastes.denial.r * 0.1 );
		}
		
		bondageScores.push(score);
	}
	
	// Find best score
	var bestIndex = bondageIDsList[0];
	var i = 0;
	var highestScore = -1;
	var diceScore = 0;
	for ( var score of bondageScores ) {
		diceScore = limitedRandomInt(score*score);
		if ( diceScore > highestScore ) {
			bestIndex = i;
			highestScore = diceScore; 
		}
		i++;
	}
	chosenID = bondageIDsList[bestIndex];
	
	return chosenID;
}
window.isSubOverDomsPowerThreshold = function(subChar,domChar) {
	// Dom's power threshold
	var domTs = 0.5;
	if ( getCharsDrivePercent(domChar,"dDomination") > 0.15 ) {
		domTs -= 0.05;
		if ( ( getCharsDrivePercent(domChar,"dDomination") > 0.2 ) ) {
			domTs -= 0.05;
		}
	}
	if ( getCharsDrivePercent(domChar,"dCooperation") > 0.15 ) {
		domTs += 0.05;
		if ( ( getCharsDrivePercent(domChar,"dCooperation") > 0.2 ) ) {
			domTs += 0.05;
		}
	}
	// Relative power threshold
	var totalRelation = rLvlAbt(domChar,subChar,"friendship") + rLvlAbt(domChar,subChar,"romance") + rLvlAbt(domChar,subChar,"sexualTension") + rLvlAbt(domChar,subChar,"domination") + rLvlAbt(domChar,subChar,"submission") + rLvlAbt(domChar,subChar,"enmity") + rLvlAbt(domChar,subChar,"rivalry");
	var relationModifier = ( rLvlAbt(domChar,subChar,"friendship") + rLvlAbt(domChar,subChar,"romance") - rLvlAbt(domChar,subChar,"sexualTension") - rLvlAbt(domChar,subChar,"rivalry") - rLvlAbt(domChar,subChar,"enmity") * 2 - rLvlAbt(domChar,subChar,"submission") + rLvlAbt(domChar,subChar,"domination") ) / ( totalRelation + 5 ) * 0.3;
	var totalPercentage = domTs + relationModifier; // Max ~= 0.9 , Min ~= 0.1
	totalPercentage -= (0.1 * gC(domChar).tastes.bondage.r);
	// Relationship type
	if ( gRelTypeAb(subChar,domChar).type == "tutorship" ) {
		totalPercentage += 0.2;
	}
	// Check if sub goes over the threshold
	var flag = false;
	if ( ( quantifyCharacterStats(subChar) / quantifyCharacterStats(domChar) ) > totalPercentage ) {
		flag = true;
	}
	
	return flag;
}

window.findValidSoftBondageOnTargetFromActor = function(bondageIDsList,target,actor) {
	var chosenID = -1;
	for ( var id of bondageIDsList ) {
		if ( getEquipDataById(id).type == equipmentType.COLLAR ) {
			chosenID = id;
		}
	}
	return chosenID;
}

// Auxiliar

window.getActorsGenitalsLockedByTarget = function(actor,target) {
	var lockedGenitals = [];
	for ( var genital of ["pussy","dick"] ) {
		if ( gC(actor).body.hasOwnProperty(genital) ) {
			if ( gC(actor).body[genital].state == "locked" ) {
				if ( gC(actor).body[genital].bondage != -1 ) {
					if ( getEquipById(gC(actor).body[genital].bondage).owner == target ) {
						lockedGenitals.push(genital);
					}
				}
			}
		}
	}
	return lockedGenitals;
}
window.getActorsKeyholders = function(actor) {
	var keyholders = [];
	for ( var genital of ["pussy","dick"] ) {
		if ( gC(actor).body.hasOwnProperty(genital) ) {
			if ( gC(actor).body[genital].state == "locked" ) {
				if ( gC(actor).body[genital].bondage != -1 ) {
					keyholders.push(getEquipById(gC(actor).body[genital].bondage).owner);
				}
			}
		}
	}
	return keyholders;
}

////////// MERCHANTS CLASS //////////
// Merchants database

// State.variables.currentMerchants = []; // This goes at StoryInit
// State.variables.enabledMerchants = []; // This goes at StoryInit

// Instance of a merchant object.

	// Constructor functions
window.Merchant = function(id,name,chance,getDescription,getSoldItems) {
	this.id = id; // Identifier of the object instance
	this.name = name; // Merchant's name
	this.chance = chance; // Probability out of 100 of the merchant appearing, if enabled
	this.getDescription = getDescription; // Function that returns a description of the merchant
	this.getSoldItems = getSoldItems; // Function that returns a list of the sold items' types' IDs
}

// Constructors, serializers, etc.
Merchant.prototype._init = function (obj) {
	Object.keys(obj).forEach(function (pn) {
		this[pn] = clone(obj[pn]);
	}, this);
	
	return this;
};
Merchant.prototype.clone = function () {
	return (new Merchant())._init(this);
};
Merchant.prototype.toJSON = function() {
	var ownData = {};
	Object.keys(this).forEach(function (pn) {
		ownData[pn] = clone(this[pn]);
	}, this);
	return JSON.reviveWrapper('(new Merchant())._init($ReviveData$)', ownData);
};

// MERCHANT DATA

const merchantType = {
	WEAPONS: 0,
	
	BONDAGE: 30,
}

setup.merchantDataList = []; // Merchants' data. currentMerchants refers to the merchants located here.
	// Weapons
		// Abibdill
setup.merchantDataList[merchantType.WEAPONS] = new Merchant(merchantType.WEAPONS,"Abibdill, Weaponsmith",15,
	function() {
		var str = "An Ashwalker of relaxed, yet confident expressions. Upon noticing that you're considering buying his weapons, he'll slash the air with them as an exhibition.";
		return str;
	},
	function() {
		var itemsList = ["w0","w1","w2","w3"]; //[100,101,102,103];
		return itemsList;
	});
	// Bondage
		// Nimeresh
setup.merchantDataList[merchantType.BONDAGE] = new Merchant(merchantType.BONDAGE,"Nimeresh, Toy maker",25,
	function() {
		var str = "This Ashwalker clearly daydreams about her clients wearing her toys. She'll eagerly invite you to try them on.";
		return str;
	},
	function() {
		var itemsList = ["b0","b1","b2","b3","b4","b5","b6"]; //[0,1,2,3,4,5,6];
		if ( gSettings().chastity == "enable" ) {
			itemsList.push("b7");//(7);
			itemsList.push("b8");//(8);
		}
		return itemsList;
	});

window.getMerchantDataByID = function(id) {
	var data = setup.merchantDataList[id]
	return data;
}



// Finish setup
	// Pieces of code that must be compiled lastChild
	
setup.saList = new saList();

// PUNISHMENTS //

// Create punishments bondage
window.createStartingPunishmentBondage = function() {
	var validItems = [equipmentType.COLLAR,equipmentType.BLINDFOLD,equipmentType.MOUTHGAG,equipmentType.HANDCUFFS,equipmentType.FEETCUFFS,equipmentType.NIPPLESUCKERS,equipmentType.BUTTPLUG];
	if ( gSettings().chastity == "enable" ) {
		validItems.push(equipmentType.CHASTITYBELT);
		if ( gSettings().futa != "disableAll" ) {
			validItems.push(equipmentType.CHASTITYCAGE);
		}
	}
	var i = 18;
	while ( i > 0 ) {
		createEquipment(randomFromList(validItems),"chDummy");
		i--;
	}
}

// Determine punishments
window.countPunishmentBondageOnTarget = function(charKey) {
	var n = 0; // Amount of punishment bondage
	for ( var item of State.variables.equipmentList ) {
		if ( item.equippedOn == charKey && item.owner == "chDummy" ) {
			n++;
		}
	}
	return n;
}
window.countRequiredPunishmentsOnTarget = function(charKey) {
	var n = 0; // Required punishments
	if ( gC(charKey).infamy >= gSettings().infamyLimit ) { n++; }
	if ( gC(charKey).infamy >= gSettings().infamyLimit * setup.infamySecondThreshold ) { n++; }
	if ( gC(charKey).infamy >= gSettings().infamyLimit * setup.infamyThirdThreshold ) { n++; }
	return n;
}

// Apply punishments
window.applyPunishmentsToCandidates = function() {
	for ( var charKey of getRandomizedActiveSimulationCharactersArray() ) {
		var reqPunishments = countRequiredPunishmentsOnTarget(charKey);
		if ( reqPunishments > 0 ) {
			if ( reqPunishments > countPunishmentBondageOnTarget(charKey) ) {
				applyPunishmentBondageOnCharacter(charKey);
				//State.variables.logL1.push(charKey + " was punished on day " + State.variables.daycycle.day + ".");
			}
		}
	}
}
window.applyPunishmentBondageOnCharacter = function(charKey) {
	var validPunishments = getItemListEquippableOnChar(charKey,getCharsUnusedBondage("chDummy"));
	if ( gSettings().chastity == "disable" ) {
		validPunishments = purgeChastityItemsFromItemList(validPunishments);
	}
	if ( validPunishments.length > 0 ) {
		var selectedPunishment = randomFromList(validPunishments)
		equipObjectOnWearer(selectedPunishment,charKey,gSettings().equipmentDuration + 1);
		State.variables.personalRoom.prMessages += gC("chDummy").getFormattedName() + " has locked " + getEquipDataById(selectedPunishment).name + " on " + gC(charKey).getFormattedName() + " as a punishment for " + gC(charKey).posPr + " infamous deeds. This will last for " + gSettings().equipmentDuration + " days after tonight.\n";
	}
}

/*
setup.infamySecondThreshold = 1.25;
setup.infamyThirdThreshold = 1.5;

window.Settings = function() { 
	this.debugFunctions = false;
	
	this.infamyLimit = 25;
	
	this.equipmentDuration = 5;
	*/

///// DYNAMICALLY GENERATED CHARACTERS /////

window.findEarliestDynamicCharacterPosition = function() {
	var i = 0;
	var foundN = false;
	while ( foundN == false && i < 100 ) {
		if ( State.variables["ch" + i] == undefined ) {
			foundN = true;
		} else {
			i++;
		}
	}
	return i;
}
window.generateBaseHumanoid = function(name,baseStat) {
	var nKey = findEarliestDynamicCharacterPosition();
	var chKey = "ch" + nKey;
	
	var character = new Character(name, chKey);
	character.type = "candidate";
	
	var charColor = randomFromList(["darksalmon","darkred","deeppink","darkorange","lemonchiffon","darkkhaki","lavender","mediumpurple","slateblue","chartreuse","mediumspringgreen","seagreen","olive","mediumaquamarine","lightsteelblue","rosybrown","peru","lightslategray"]);
	character.setColors(charColor,charColor);
	
	// Moves
	character.saList.push("strokePussy","strokeBreasts","strokeDick","kissLips","frottage","frenchKiss","mountFaceToFace","penetratePussy","interlockLegs","lickGroin","mountDick");
	
	character.saList.push("baKissLips","baStrokeDick","baStrokePussy","pounceFrontalD2P","pounceFrontalP2P","pounceFrontalP2D","baThrust","baPushHipsBack","baScissor","baScissorBack","baRideDick","baPushDickBack","kick","coldGuts","taunt","baTease","embers","freezeFeet","sparkingRubbing");
	
	// Others
	character.names.push(name);
	character.likedTopics.push(randomFromList(["training","flora","fauna","dramas","music"]));
	
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/unknown-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/unknown-avatar.png]]";
	}
	character.icon = function() {
		return "[img[img/charIcons/npcIcon.png]]";
	}
	
	character.fullPortraitL = "img/portraits/unknown-full.png";
	character.avatarL = "img/portraits/unknown-avatar.png";
	character.iconL = "img/charIcons/npcIcon.png";
	
	// AI
	character.globalAi = createCandidateGlobalAi(chKey);
	
	// Tastes
	for ( var t in character.tastes ) {
		if ( character.tastes[t] instanceof weightedRankedElement ) {
			character.tastes[t].w = 80 + limitedRandomInt(40);
		}
	}
		
	// Drives
	setDriveValues(character.dImprovement,limitedRandomInt(1500),3);
	setDriveValues(character.dPleasure,limitedRandomInt(1500),3);
	setDriveValues(character.dLove,limitedRandomInt(1500),3);
	setDriveValues(character.dCooperation,limitedRandomInt(1500),3);
	setDriveValues(character.dDomination,limitedRandomInt(1500),3);
	setDriveValues(character.dAmbition,limitedRandomInt(1500),3);
	
	// Attributes
	character.setBaseAttributes((baseStat-2)+limitedRandomInt(4),(baseStat-2)+limitedRandomInt(4),(baseStat-2)+limitedRandomInt(4),(baseStat-2)+limitedRandomInt(4),(baseStat-2)+limitedRandomInt(4),(baseStat-2)+limitedRandomInt(4),(baseStat-2)+limitedRandomInt(4),(baseStat-2)+limitedRandomInt(4),(baseStat-2)+limitedRandomInt(4));
	character.setAffinities(((baseStat-2) + limitedRandomInt(4))*0.1,((baseStat-2) + limitedRandomInt(4))*0.1,((baseStat-2) + limitedRandomInt(4))*0.1,((baseStat-2) + limitedRandomInt(4))*0.1,((baseStat-2) + limitedRandomInt(4))*0.1,((baseStat-2) + limitedRandomInt(4))*0.1,((baseStat-2) + limitedRandomInt(4))*0.1,((baseStat-2) + limitedRandomInt(4))*0.1,((baseStat-2) + limitedRandomInt(4))*0.1);
	
	character.refugeRooms = [["mapTrainingGrounds","publicBaths"]];
	
	return character;
}
window.getRandomFemaleName = function() {
	var name = randomFromList(["Ai","Apolline","Leisl","Cathenna","Malia","Katoka","Bhavika","Radha","Elanie","Mariela","Chiyo","Zahra","Uchenna","Alisa","Adelina","Tuyet-Hanh"]);
	return name;
}
window.getRandomMaleName = function() {
	var name = randomFromList(["Tao","Rapier","Peppi","Hrisovalantis","Ahe","Arpad","Dev","Seamus","Moshe","Drago","Fumio","Driss","Ajulo","Coinneach","Lucero","Vinh"]);
	return name;
}
window.generateFemaleHumanoidTest = function() {
	var nKey = findEarliestDynamicCharacterPosition();
	var chKey = "ch" + nKey;
	var character = generateBaseHumanoid(getRandomFemaleName(),10);
	character.addFemaleParts();
	character.assignFemeninePronouns();
	State.variables[chKey] = character;
	return chKey;
}
window.generateMaleHumanoidTest = function() {
	var nKey = findEarliestDynamicCharacterPosition();
	var chKey = "ch" + nKey;
	var character = generateBaseHumanoid(getRandomMaleName(),10);
	character.addMaleParts();
	character.assignMasculinePronouns();
	State.variables[chKey] = character;
	return chKey;
}
window.generateFutaHumanoidTest = function() {
	var nKey = findEarliestDynamicCharacterPosition();
	var chKey = "ch" + nKey;
	var character = generateBaseHumanoid(getRandomFemaleName(),10);
	character.addFemaleParts();
	character.addBodypart("dick","dick");
	character.assignFemeninePronouns();
	State.variables[chKey] = character;
	return chKey;
}

window.generateFemaleAnonShapeshifter = function(usedNames) {
	var nKey = findEarliestDynamicCharacterPosition();
	var chKey = "ch" + nKey;
	var name = generateNonRepeatedNameWithFunction(usedNames,generateRandomFemaleShapeshifterName);
	var character = generateBaseHumanoid(name,10);
	character.addFemaleParts();
	character.assignFemeninePronouns();
	State.variables[chKey] = character;
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/RdFmSs-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/RdFmSs-avatar.png]]";
	}
	character.fullPortraitL = "img/portraits/RdFmSs-full.png";
	character.avatarL = "img/portraits/RdFmSs-avatar.png";
	character.saList = returnBaList().concat(returnFirstScrollGroupActionsList());
	var color = randomFromList(["salmon","hotpink","orchid","fuchsia","blueviolet","palegreen","mediumspringgreen"]);
	character.setColors(color,color);
	return chKey;
}
window.generateMaleAnonShapeshifter = function(usedNames) {
	var nKey = findEarliestDynamicCharacterPosition();
	var chKey = "ch" + nKey;
	var name = generateNonRepeatedNameWithFunction(usedNames,generateRandomMaleShapeshifterName);
	var character = generateBaseHumanoid(name,10);
	character.addMaleParts();
	character.assignMasculinePronouns();
	State.variables[chKey] = character;
	// Images
	character.fullPortrait = function() {
		return "[img[img/portraits/RdMlSs-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/RdMlSs-avatar.png]]";
	}
	character.fullPortraitL = "img/portraits/RdMlSs-full.png";
	character.avatarL = "img/portraits/RdMlSs-avatar.png";
	character.saList = returnBaList().concat(returnFirstScrollGroupActionsList());
	var color = randomFromList(["darksalmon","red","orchid","darkorchid","darkslateblue","greenyellow","springgreen"]);
	character.setColors(color,color);
	return chKey;
}

// Names
window.generateNonRepeatedNameWithFunction = function(usedNames,generatingFunction) {
	var name = "";
	while ( name == "" || usedNames.includes(name) ) {
		name = generatingFunction();
	}
	return name;
}
window.generateRandomFemaleShapeshifterName = function() {
	var name = randomFromList(["Tsellen","Maltya","Styria","Lisllin","Iliau","Versques","Faria","Esferia","Gaisyia","Lereimes","Feisien","Teseilla","Elvistir","Feness","Renesq"]);
	return name;
}
window.generateRandomMaleShapeshifterName = function() {
	var name = randomFromList(["Questian","Renesq","Maeso","Velsin","Parsque","Kullen","Guslen","Feness","Baste","Vursq","Fasian","Velos","Feisien","Tsellen"]);
	return name;
}

////////// MONSTERS //////////
// Each of these functions auto-generates a monster, assigns it a varName, and returns the varName

// Flying Lookout
window.createFlyingLookout = function(statVariance,statBuff,number) {
	// General Data
	var nameVar = getFirstFreedMonsterVar();
	var description = "A giant eye floats through the air like a fish would swim through the water. At its sides and behind it, scaled tentacles dance forming waves. It may not be a good idea to directly look at it for long.";
	var name = '<span title="' + description + '">Flying Lookout';
	if ( number >= 0 ) { name += " " + number; }
	name += '^^(?)^^</span>';
	var character = new Character(name, nameVar);
	var tName = "Flying Lookout";
	if ( number >= 0 ) { tName += " " + number; }
	character.names = [(tName)];
	character.type = "monster";
	character.race = "monster";
	character.setColors("PowderBlue","PowderBlue");
	
	// Images
	/*
	character.fullPortrait = function() {
		return "[img[img/portraits/unknown-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/unknown-avatar.png]]";
	}
	*/
	
	character.fullPortraitL = "img/portraits/unknown-full.png";
	character.avatarL = "img/portraits/unknown-avatar.png";
	
	// Body
	character.body = { 
		eyes : new Bodypart("eyes","eyes"),
		tentacles : new Bodypart("tentacles","tentacles")
	};
	
	// Attributes
	character.setBaseAttributes(12,17,13,20,14,17,8,17,0);
	character.adjustAttributes(statVariance,statBuff);
	character.luck.value = 0;
	
	// Affinities
	character.combatAffinities.holy.weakness += 200;
	character.combatAffinities.hypnosis.strength += 15;
	character.combatAffinities.hypnosis.weakness += 15;
	character.combatAffinities.useEyes.strength += 15;
	character.combatAffinities.useEyes.weakness += 15;
	
	// Moves
	character.saList = ["doNothing","struggle","baHypnoticGlance","baOrderKneeling","baOrderMasturbation","baCorrodeMind"];
	
	// Assign to State.variables and return varName
	State.variables[nameVar] = character;
	
	// Finish initialization
	assignMaxBarsMediumMonster(nameVar);
	
	return nameVar;
}

// Flying Lookout
window.createEssenceSucker = function(statVariance,statBuff,number) {
	// General Data
	var nameVar = getFirstFreedMonsterVar();
	var description = "Arm-sized petals grow out of the upper and lower extremes of this creature, hiding its body. At its top and bottom, foul circular mouths are crowned by diminutive teeth and long, slim tongues, which it uses to propel itself away from the ground.";
	var name = '<span title="' + description + '">Essence-Sucker';
	if ( number >= 0 ) { name += " " + number; }
	name += '^^(?)^^</span>';
	var character = new Character(name, nameVar);
	var tName = "Essence-Sucker";
	if ( number >= 0 ) { tName += " " + number; }
	character.names = [(tName)];
	character.type = "monster";
	character.race = "monster";
	character.setColors("PowderBlue","PowderBlue");
	
	// Images
	/*
	character.fullPortrait = function() {
		return "[img[img/portraits/unknown-full.png]]";
	}
	character.avatar = function() {
		return "[img[img/portraits/unknown-avatar.png]]";
	}
	*/
	
	character.fullPortraitL = "img/portraits/unknown-full.png";
	character.avatarL = "img/portraits/unknown-avatar.png";
	
	// Body
	character.body = { 
		mouth : new Bodypart("mouth","mouth"),
		legs : new Bodypart("legs","legs")
	};
	
	// Attributes
	character.setBaseAttributes(9,13,15,15,9,9,13,9,0);
	character.adjustAttributes(statVariance,statBuff);
	character.luck.value = 0;
	
	// Affinities
	character.combatAffinities.holy.weakness += 200;
	character.combatAffinities.fire.weakness += 50;
	character.combatAffinities.drain.strength += 15;
	character.combatAffinities.spore.strength += 15;
	character.combatAffinities.useMouth.strength += 25;
	character.combatAffinities.targetMouth.resistance += 25;
	
	// Moves
	character.saList = ["doNothing","struggle","baEnergyDrainingKiss","baDrainingKiss","pounceFrontal","tackle","baDrainingRoots"];
	
	// Assign to State.variables and return varName
	State.variables[nameVar] = character;
	
	// Finish initialization
	assignMaxBarsMediumMonster(nameVar);
	
	return nameVar;
}

// Aux Monster functions
window.getFirstFreedMonsterVar = function() {
	var i = 0;
	var foundVar = false;
	while ( foundVar == false ) {
		if ( gC("mon" + i) == undefined ) {
			foundVar = true;
		} else {
			i++;
		}
	}
	return ("mon" + i);
}

window.assignMaxBarsMediumMonster = function(character) {
	gC(character).lust.max = float2int(45 + (gC(character).physique.value * 1 + gC(character).agility.value * 1 + gC(character).resilience.value * 1
				  + gC(character).will.value * 1 + gC(character).intelligence.value * 1 + gC(character).perception.value * 1
				  + gC(character).empathy.value * 1 + gC(character).charisma.value * 1 + gC(character).luck.value * 1) / 3);
	gC(character).willpower.max = float2int(45 + gC(character).will.value * 1 + gC(character).intelligence.value * 1 + gC(character).perception.value * 1);
	gC(character).energy.max = float2int(45 + gC(character).physique.value * 1 + gC(character).agility.value * 1 + gC(character).resilience.value * 1);
	gC(character).socialdrive.max = float2int(45 + gC(character).empathy.value * 1 + gC(character).charisma.value * 1 + gC(character).luck.value * 1);
	for ( var sBar of ["lust","willpower","energy","socialdrive"] ) {
		gC(character)[sBar].current = gC(character)[sBar].max;
	}
}

window.deleteAllMonsters = function() {
	var i = 0;
	while ( i < 100 ) {
		var m = "mon" + i;
		if ( gC(m) != undefined ) {
			delete State.variables[m];
		}
		i++;
	}
}

// Wild Caverns Actions

	// Movement
window.createCreateSEtunnelMovement = function(roomKey,energy) {
	return ( function(minutes, characters) {
		var sEvent = new systemEvent(minutes,characters,"movement","Moving",function(cList) {
				State.variables.compass.moveCharsToRoom(cList,roomKey);
				
				var eventMsg = "You advance through the tunnel without further issues.";
				if ( energy > 0 ) {
					eventMsg = "You advance through the tunnel at the cost of " + textEnergyPoints(energy) + ". ";
					for ( var cK of characters ) {
						applyBarDamageWithoutOverflow(cK,"energy",-energy);
					}
				}
				State.variables.compass.setMapMessage(eventMsg);
				return eventMsg;
			}
		);
		sEvent.applyEffectIfForcedToEnd = false;
		sEvent.roomKey = roomKey;
		sEvent.priority = -1;
		return sEvent;
	} )
} 
/*
window.createSEtunnelMovement = function(minutes, characters, roomKey, energy) {
	var sEvent = new systemEvent(minutes,characters,"movement","Moving",function(cList) {
			State.variables.compass.moveCharsToRoom(cList,roomKey);
			
			var eventMsg = "Characters moved.";
			return eventMsg;
		}
	);
	sEvent.applyEffectIfForcedToEnd = false;
	sEvent.roomKey = roomKey;
	sEvent.priority = -1;
	return sEvent;
}
*/
window.createActionMovingWildTunnel = function(goalKey,goalName,energy,mins) {
	var actName = "Move to " + goalName + " (" + colorText(mins,"khaki") + ") ";
	if ( energy > 0 ) {
		actName += "(" + colorText(energy,"limegreen") + ") ";
	}
	var action = new mapAction("tunnelMovement",actName,createCreateSEtunnelMovement(goalKey,energy),false);
	action.description = "Attempt to move to " + goalName + ". ";
	action.tags.push();
	action.recMins = mins;
	action.flexibleTimes = false;
	action.getPassage = function() { return "Map" };
	return action;
}

	// Waiting
window.createSystemEventWait = function(minutes,characters) {
	var sEvent = new systemEvent(5,characters,"cavernWait","Wait for a few minutes",function(cList) {
			for ( var cK of characters ) {
				applyBarDamageWithoutOverflow(cK,"willpower",-5);
			}
			
			var eventMsg = "You wait quietly, hoping for the Caverns to move their limbs and allow you passage. The dismal scenery and the airless environment erode your will for " + textWillpowerPoints(5) + ". ";
			State.variables.compass.setMapMessage(eventMsg);
			return eventMsg;
		}
	);
	sEvent.priority = -1;
	return sEvent;
}
window.createWaitingActionCaverns = function() {
	var action = new mapAction("cavernWait","Wait for a few minutes",createSystemEventWait,false);
	action.description = "The characters will wait for a few minutes, expecting the Caverns to leave the way open for them.";
	action.recMins = 5;
	action.flexibleTimes = false;
	action.getPassage = function() { return "Map" };
	return action;
}
window.createSystemEventCheapNoWait = function(minutes,characters) {
	var sEvent = new systemEvent(0,characters,"cavernWait","Wait for a few minutes",function(cList) {
			
			var eventMsg = "";
			State.variables.compass.setMapMessage(eventMsg);
			return eventMsg;
		}
	);
	sEvent.priority = -1;
	return sEvent;
}
window.createSystemEventCheapWait = function(minutes,characters) {
	var sEvent = new systemEvent(5,characters,"cavernWait","Wait for a few minutes",function(cList) {
			
			var eventMsg = "You rest for a few minutes, your eyes focused on the the occasional, tiny waves taking form at the lake below...";
			State.variables.compass.setMapMessage(eventMsg);
			return eventMsg;
		}
	);
	sEvent.priority = -1;
	return sEvent;
}
window.createSystemEventCheapWaitNoDesc = function(minutes,characters) {
	var sEvent = new systemEvent(5,characters,"cavernWait","Wait for a few minutes",function(cList) {
			
			var eventMsg = "";
			State.variables.compass.setMapMessage(eventMsg);
			return eventMsg;
		}
	);
	sEvent.priority = -1;
	return sEvent;
}
window.createSystemEventMedWait = function(minutes,characters) {
	var sEvent = new systemEvent(20,characters,"cavernWait","Wait for a few minutes",function(cList) {
			
			var eventMsg = "You rest for a few minutes, your eyes focused on the the occasional, tiny waves taking form at the lake below.. ";
			State.variables.compass.setMapMessage(eventMsg);
			return eventMsg;
		}
	);
	sEvent.priority = -1;
	return sEvent;
}
window.createCheapWaitingActionCaverns = function() {
	var action = new mapAction("cavernWait","Wait for a few minutes",createSystemEventCheapWait,false);
	action.description = "The characters will wait for a few minutes staring at the lake below.";
	action.recMins = 5;
	action.flexibleTimes = false;
	action.getPassage = function() { return "Map" };
	return action;
}

	// Pond of illumination
window.createSystemEventSecludedMeditation = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"secludedMeditation","Secluded Meditation",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 3;
			var barCost = 20;
			var barType = "willpower";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				expRate = 3;
				if ( charHadEnoughBar == false ) { expRate = 1; } 
				var exp = charGetsExpRate(this.ongoingTime,character,"luck",expRate);
				var exp2 = charGetsExpRate(this.ongoingTime,character,"will",expRate);
				var exp3 = charGetsExpRate(this.ongoingTime,character,"intelligence",expRate);
				eventMsg += createCharGotExpMessage(character,"intelligence",exp) + "\n" + createCharGotExpMessage(character,"will",exp2) + "\n" + createCharGotExpMessage(character,"luck",exp3) + "\n";
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
			}
			eventMsg += tutorshipExtraExp(minutes,characters,"luck",expRate);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createTrainingActionSecludedMeditation = function() {
	var action = new mapAction("secludedMeditation","Secluded Meditation",createSystemEventSecludedMeditation,false);
	action.description = "There are few places in the Valley as providential as this little pond to get in touch with your inner self. Trains intelligence, will and luck. Costs 20 willpower per hour, with a penalty if the character runs out of willpower.";
	action.tags.push("training","trRank1","luck","intelligence","will");
	action.recMins = 60;
	action.flexibleTimes = true;
	return action;
}

// Shapeshifter tribe

	// Baths
window.createSeHeatedBath = function(minutes,characters) {
	var sEvent = new systemEvent(30,characters,"heatedBath","Take a heated bath",function(cList) {
			for ( var cK of characters ) {
				applyBarDamageWithoutOverflow(cK,"energy",-10);
				if ( doesCharHaveAlteredState(cK,"HeBa") == false ) {
					applyAlteredState([cK],createHeatedBath());
				}
			}
			
			var eventMsg = "You throughly enjoy your stay at the sauna, relaxing your muscles and rejuvenating your body. You feel stronger today. This costed you " + textEnergyPoints(10) + ". ";
			return eventMsg;
		}
	);
	sEvent.priority = 1;
	return sEvent;
}
window.createHeatedBathAction = function() {
	var action = new mapAction("heatedBath","Take a heated bath",createSeHeatedBath,false);
	action.description = "The characters will take a bath in the sauna, receiving buffs to their physique, agility and resilience.";
	action.recMins = 30;
	action.flexibleTimes = false;
	return action;
}
window.createSeFrozenBath = function(minutes,characters) {
	var sEvent = new systemEvent(30,characters,"frozenBath","Take a frozen bath",function(cList) {
			for ( var cK of characters ) {
				applyBarDamageWithoutOverflow(cK,"willpower",-10);
				if ( doesCharHaveAlteredState(cK,"FrBa") == false ) {
					applyAlteredState([cK],createFrozenBath());
				}
			}
			
			var eventMsg = "You endure your hellishly frozen stay at the water, fortifying your will. You feel focused today. This costed you " + textWillpowerPoints(10) + ". ";
			return eventMsg;
		}
	);
	sEvent.priority = 1;
	return sEvent;
}
window.createFrozenBathAction = function() {
	var action = new mapAction("frozenBath","Take a frozen bath",createSeFrozenBath,false);
	action.description = "The characters will take a bath in cold water, receiving buffs to their intelligence, will and perception.";
	action.recMins = 30;
	action.flexibleTimes = false;
	return action;
}
window.createSePublicBath = function(minutes,characters) {
	var sEvent = new systemEvent(30,characters,"publicBath","Take a public bath",function(cList) {
			for ( var cK of characters ) {
				applyBarDamageWithoutOverflow(cK,"socialdrive",-10);
				if ( doesCharHaveAlteredState(cK,"PuBa") == false ) {
					applyAlteredState([cK],createPublicBath());
				}
			}
			
			var eventMsg = "You gulp your initial shame, progressively becoming more comfortable showing your naked body in front of strangers. You feel confident today. This costed you " + textSocialdrivePoints(10) + ". ";
			return eventMsg;
		}
	);
	sEvent.priority = 1;
	return sEvent;
}
window.createPublicBathAction = function() {
	var action = new mapAction("publicBath","Take a public bath",createSePublicBath,false);
	action.description = "The characters will enjoy the waters of a public bath, receiving buffs to their charisma, empathy and luck.";
	action.recMins = 30;
	action.flexibleTimes = false;
	return action;
}

	// Theater
window.createSysEvTheaterImprovisation = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"dramaImprovisation","Drama Improvisation",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 1;
			var barCost = 20;
			var barType = "socialdrive";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				if ( charHadEnoughBar == false ) { expRate = 0.5; } 
				var exp1 = charGetsExpRate(this.ongoingTime,character,"charisma",expRate);
				var exp2 = charGetsExpRate(this.ongoingTime,character,"empathy",expRate);
				var impExp = (this.ongoingTime / 60) * gC(character).charisma.affinity * gC(character).charisma.affinity * gC(character).empathy.affinity;
				addCharsSpecialExperience(character,"impExp",impExp);
				eventMsg += createCharGotExpMessage(character,"charisma",exp1) + "\n";
				eventMsg += createCharGotExpMessage(character,"empathy",exp2) + "\n";
				eventMsg += describeCharsImprovExp(character) + "\n";
				var rspMsg = describeRespectGain(character,"impExp");
				eventMsg += rspMsg;
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
			}
			eventMsg += sharedTrainingRelationshipEvents(characters);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createTheaterImprovisationAction = function() {
	var action = new mapAction("dramaImprovisation","Drama Improvisation",createSysEvTheaterImprovisation,false);
	action.description = "The characters will train their improvisation skills with other acting Shapeshifters. Trains charisma, empathy and improvisation skill, consumes social drive.";
	action.tags.push("training","trRank1","charisma","empathy");
	action.recMins = 60;
	action.flexibleTimes = false;
	return action;
}
window.describeCharsImprovExp = function(cK) {
	var msg = "";
	var exp = getCharsSpecialExperience(cK,"impExp");
	if ( exp >= 40 ) {
		msg = gC(cK).getFormattedName() + " is able to take and leave any role at will, flowing through any plot like the water seeps through the cracks of any rock.";
	} else if ( exp >= 27 ) {
		msg = gC(cK).getFormattedName() + " is learning to plan the plot ahead, making " + gC(cK).comPr + " less likely to run into a dead end.";
	} else if ( exp >= 13 ) {
		msg = gC(cK).getFormattedName() + " is comfortable interpreting many roles.";
	} else {
		msg = gC(cK).getFormattedName() + " is still grasping the basics.";
	}
	return msg;
}

	// Workshops
window.createSysEvWorkshopCrafting = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"workshopCrafting","Workshop Crafting",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 1;
			var barCost = 20;
			var barType = "energy";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				if ( charHadEnoughBar == false ) { expRate = 0.5; } 
				var exp1 = charGetsExpRate(this.ongoingTime,character,"physique",expRate);
				var exp2 = charGetsExpRate(this.ongoingTime,character,"resilience",expRate);
				var crfExp = (this.ongoingTime / 60) * gC(character).physique.affinity * gC(character).physique.affinity * gC(character).resilience.affinity;
				addCharsSpecialExperience(character,"crfExp",crfExp);
				eventMsg += createCharGotExpMessage(character,"physique",exp1) + "\n";
				eventMsg += createCharGotExpMessage(character,"resilience",exp2) + "\n";
				eventMsg += describeCharsCraftExp(character) + "\n";
				var rspMsg = describeRespectGain(character,"crfExp");
				eventMsg += rspMsg;
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
			}
			// Dildo crafting map event
			if ( isStVarOn("dldCrf") == false && cList[0] == "chPlayerCharacter" ) { // Dildo crafting map scene
				// Base requirements
				var baseSkillRequirement = 50;
				var pcPhyPoints = (gCstat("chPlayerCharacter","physique") - 10) * 0.5; if ( pcPhyPoints < 0 ) { pcPhyPoints = 0; }
				var pcPerPoints = (gCstat("chPlayerCharacter","perception") - 10) * 0.5; if ( pcPerPoints < 0 ) { pcPerPoints = 0; }
				var pcIntPoints = (gCstat("chPlayerCharacter","intelligence") - 10) * 0.5; if ( pcIntPoints < 0 ) { pcIntPoints = 0; }
				var pcSkill = getCharsSpecialExperience("chPlayerCharacter","crfExp") * 10 + pcPhyPoints + pcPerPoints + pcIntPoints;
				if ( pcSkill >= 60 ) { // Passed initial check, continue
					eventMsg += colorText("Initial check PASSED","green") + ": Crafting Skill (" + getCharsSpecialExperience("chPlayerCharacter","crfExp").toFixed(1) * 10 + ") + Physique points (" + pcPhyPoints.toFixed(1) + ") + Perception points (" + pcPerPoints.toFixed(1) + ") + Intelligence Points (" + pcIntPoints.toFixed(1) + ") = " + pcSkill.toFixed(1) + " >= Difficulty (60)\n\n";
					var hornyPoints = (1 - getBarPercentage("chPlayerCharacter","lust")) * 20; // Missing lust % * 10
					var dice45 = limitedRandomInt(45);
					var difficulty = 40;
					var totalPoints = pcSkill * 0.1 + dice45 + hornyPoints;
					if ( totalPoints >= difficulty ) { // Passed second check, notify and offer option to create dildo
						eventMsg += colorText("Second check PASSED","green") + ": Skill points (" + (pcSkill * 0.1).toFixed(1) + ") + Horny points (" + hornyPoints.toFixed(1) + ")" + getTextWithTooltip("^^(?)^^","Receive lust damage to raise this value.") + " Dice 45 (" + dice45 + ") = " + totalPoints.toFixed(1) + " >= Difficulty (" + difficulty + ")\n\n";
						eventMsg += "<<l" + "ink [[...Craft a toy?|FASE Crafting a Dildo]]>><<s" + "cript>>\n"
			+ "initializeFaSeCraftingADildo();\n<</s" + "cript>><</l" + "ink>>\n\n";
					} else { // Didn't pass second check, notify
						eventMsg += colorText("Second check FAILED","red") + ": Skill points (" + (pcSkill * 0.1).toFixed(1) + ") + Horny points (" + hornyPoints.toFixed(1) + ")" + getTextWithTooltip("^^(?)^^","Receive lust damage to raise this value.") + " Dice 45 (" + dice45 + ") = " + totalPoints.toFixed(1) + " < Difficulty (" + difficulty + ")\n\n";
					}
				} else { // Didn't pass initial check, notify
					eventMsg += colorText("Initial check FAILED","red") + ": Crafting Skill (" + getCharsSpecialExperience("chPlayerCharacter","crfExp").toFixed(1) * 10 + ") + Physique points (" + pcPhyPoints.toFixed(1) + ") + Perception points (" + pcPerPoints.toFixed(1) + ") + Intelligence Points (" + pcIntPoints.toFixed(1) + ") = " + pcSkill.toFixed(1) + " < Difficulty (60)\n\n";
				}
			}
			eventMsg += sharedTrainingRelationshipEvents(characters);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createWorkshopCraftingAction = function() {
	var action = new mapAction("workshopCrafting","Workshop Crafting",createSysEvWorkshopCrafting,false);
	action.description = "The characters will train their crafting skills with the materials and tools in the workshops. Trains physique, resilience and crafting skill, consumes energy.";
	action.tags.push("training","trRank1","physique","resilience");
	action.recMins = 60;
	action.flexibleTimes = false;
	return action;
}
window.describeCharsCraftExp = function(cK) {
	var msg = "";
	var exp = getCharsSpecialExperience(cK,"crfExp");
	if ( exp >= 40 ) {
		msg = gC(cK).getFormattedName() + " only needs to visualize a form in " + gC(cK).posPr + " mind to know how to shape the materials in front of " + gC(cK).comPr + " into it.";
	} else if ( exp >= 27 ) {
		msg = gC(cK).getFormattedName() + " is growing bolder at trying new techniques.";
	} else if ( exp >= 13 ) {
		msg = gC(cK).getFormattedName() + " has a clear understanding on manipulating clay and glass.";
	} else {
		msg = gC(cK).getFormattedName() + " is still grasping the basics.";
	}
	return msg;
}
window.createSysEvWorkshopPainting = function(minutes,characters) {
	var sEvent = new systemEvent(minutes,characters,"workshopPainting","Workshop Painting",function(cList) {
			var eventMsg = "";
			var exp = 0;
			var expRate = 1;
			var barCost = 20;
			var barType = "willpower";
			for ( var character of cList ) {
				// The character attempts to consume barCost (ex.20) out of barType (ex.willpower), returns false if not possible
				var barConsumption = barCost*(this.ongoingTime/60);
				var charHadEnoughBar = charConsumesBarAmount(character,barType,barConsumption);
				if ( charHadEnoughBar == false ) { expRate = 0.5; } 
				var exp1 = charGetsExpRate(this.ongoingTime,character,"intelligence",expRate);
				var exp2 = charGetsExpRate(this.ongoingTime,character,"perception",expRate);
				var pntExp = (this.ongoingTime / 60) * gC(character).intelligence.affinity * gC(character).perception.affinity * gC(character).perception.affinity;
				addCharsSpecialExperience(character,"pntExp",pntExp);
				eventMsg += createCharGotExpMessage(character,"intelligence",exp1) + "\n";
				eventMsg += createCharGotExpMessage(character,"perception",exp2) + "\n";
				eventMsg += describeCharsPaintExp(character) + "\n";
				var rspMsg = describeRespectGain(character,"pntExp");
				eventMsg += rspMsg;
				eventMsg += createCharSpentBarMessage(character,barType,barConsumption) + "\n";
			}
			eventMsg += sharedTrainingRelationshipEvents(characters);
			return eventMsg;
		}
	);
	sEvent.priority = 3;
	return sEvent;
}
window.createWorkshopPaintingAction = function() {
	var action = new mapAction("workshopPainting","Workshop Painting",createSysEvWorkshopPainting,false);
	action.description = "The characters will paint ceramic tiles with the materials in the workshops. Trains intelligence, perception and painting skill, consumes willpower.";
	action.tags.push("training","trRank1","intelligence","perception");
	action.recMins = 60;
	action.flexibleTimes = false;
	return action;
}
window.describeCharsPaintExp = function(cK) {
	var msg = "";
	var exp = getCharsSpecialExperience(cK,"pntExp");
	if ( exp >= 40 ) {
		msg = gC(cK).getFormattedName() + " can now infuse the clay with the most elemental feelings and desires of " + gC(cK).posPr + " mind and heart.";
	} else if ( exp >= 27 ) {
		msg = gC(cK).getFormattedName() + " has developed some understanding of composition.";
	} else if ( exp >= 13 ) {
		msg = gC(cK).getFormattedName() + " is now more capable of portraying the forms that " + gC(cK).perPr + " wants.";
	} else {
		msg = gC(cK).getFormattedName() + " is still grasping the basics.";
	}
	return msg;
}

window.charGainsRespectFromTraining = function(character, skill) {
	var gainedRsp = 0;
	if ( gC(character).hasOwnProperty("ssRsp") ) {
		gainedRsp = 1 + gC(character)[skill] * 0.1 + limitedRandomInt(6) * 0.1 - 0.3;
		gC(character).ssRsp += gainedRsp;
	}
	return gainedRsp;
}
window.describeRespectGain = function(character, skill) {
	var txt = "";
	var gainedRsp = charGainsRespectFromTraining(character,skill);
	if ( gainedRsp > 0 ) {
		txt += gC(character).getFormattedName() + "'s effort and skill gains " + gC(character).comPr + " " + gainedRsp.toFixed(1) + " respect with the tribe.\n";
	}
	return txt;
}

// Union Lake

// Map Events
window.createGleamingCavernsVoyeurAction = function(firstCharFemale,secondCharFemale,egaScene,spectators) {
	var action = new mapAction("gCvoyeur","Spy at the lovers below",createGleamingCavernsVoyeurEvent,false);
	action.description = "You have spotted a couple of Shapeshifters down below seeking intimacy. You could become an uninvited observer...";
	action.recMins = 20;
	action.getPassage = function() { return "Scene"; };
	return action;
}
window.createGleamingCavernsVoyeurEvent = function(minutes,characters) {
	var firstCharFemale = State.variables.mapGleamingCaverns.femCharA;
	var secondCharFemale = State.variables.mapGleamingCaverns.femCharB;
	var egaScene = State.variables.mapGleamingCaverns.egaScene;
	var spectators = characters;
	var charA = 1;
	var charB = 2;
	if ( firstCharFemale ) { charA = generateFemaleAnonShapeshifter([]); }
					  else { charA = generateMaleAnonShapeshifter([]); }
	if ( secondCharFemale ) { charB = generateFemaleAnonShapeshifter([gC(charA).name]); }
					  else { charB = generateMaleAnonShapeshifter([gC(charA).name]); }
	destroyCharsVirginitiesNoFlavor(charA);
	destroyCharsVirginitiesNoFlavor(charB);
	var sceneType = "fixed";
	if ( egaScene ) {
		sceneType = "dynamic";
	}
	var allChars = [charA,charB].concat(characters);
	recalculateMaxBars(charA);
	recalculateMaxBars(charB);
	var sEvent = new systemEvent(20,allChars,"scene","Spying sex",function(cList) {
			var desc = getRoomInfoA(gC(this.characters[2]).currentRoom).description;
			State.variables.sc.startScene("ss",sceneType,[charA],[charB],desc,endConditionTurns,gSettings().stdSxScDur,"Scene Results"); // Start scene
			State.variables.sc.endSceneScript = processGleamingCavernsVoyeurEffects;
			// Set lead
			if ( sceneType == "fixed" ) {
				gC(charA).hasLead = true;
				gC(charB).hasLead = false;
			}
			// Set AIs
				gC(charA).aiAlgorythm = createAiWeightedMissionsByTaste();
				gC(charB).aiAlgorythm = createAiWeightedMissionsByTaste();
			if ( egaScene ) {
				gC(charA).aiAlgorythm.setRoleEqualFooting();
				gC(charB).aiAlgorythm.setRoleEqualFooting();
			} else {
				if ( limitedRandomInt(100) < 50 ) {
					gC(charA).aiAlgorythm.setRoleActive();
					gC(charB).aiAlgorythm.setRolePassive();
				} else {
					gC(charA).aiAlgorythm.setRoleDomination();
					gC(charB).aiAlgorythm.setRoleSubmission();
				}
 			}
			if ( this.characters.includes("chPlayerCharacter") == false ) {
				State.variables.sc.autoResolveScene();
			}
		}
	);
	sEvent.charactersTeamA = [charA];
	sEvent.charactersTeamB = [charB];
	State.variables.sc.spectators = spectators;
	State.variables.sc.genericCharacters = [charA,charB];
	sEvent.spectators = spectators;
	sEvent.flagMayBeInterrupted = false;
	sEvent.flagMayChangeGroups = false;
	sEvent.label = "voyeur";
	sEvent.priority = 5;
	sEvent.applyEffectIfForcedToEnd = false;
	return sEvent;
}
  // Voyeur post-scene script
 window.processGleamingCavernsVoyeurEffects = function() {
	var charA = State.variables.sc.teamAcharKeys[0];
	var charB = State.variables.sc.teamBcharKeys[0];
	var totalOrgasms = gC(charA).orgasmSceneCounter + gC(charA).ruinedOrgasmSceneCounter * 3 + gC(charA).mindblowingOrgasmSC * 5 + gC(charB).orgasmSceneCounter + gC(charB).ruinedOrgasmSceneCounter * 3 + gC(charB).mindblowingOrgasmSC * 5;
	var spectators = State.variables.sc.spectators;
	var effectPoints = 5 + limitedRandomInt(5) + totalOrgasms * 4;
	
	var resultsMessage = "";
	for ( var chKey of spectators ) {
		// Provoke lust damage to spectators up to limit
		var lustDamage = effectPoints / 2 + limitedRandomInt(textLustDamage/2);
		gC(chKey).lust.current -= lustDamage;
		if ( getBarPercentage(chKey,"lust") < 0.15 ) {
			gC(chKey).lust.current = gC(chKey).lust.max * 0.15;
		}
		resultsMessage += gC(chKey).getFormattedName() + " has received " + textLustDamage(lustDamage) + " from watching the scene.\n";
		// Spectators may receive various experiences
		for ( var st of getStatNamesArray() ) {
			if ( limitedRandomInt(100) > 65 ) {
				var expPoints = 1 + limitedRandomInt(effectPoints) / 5;
				gC(chKey)[st].addExperience(expPoints);
				resultsMessage += firstToCap(gC(chKey).posPr) + " insights also provided " + gC(chKey).comPr + " with " + expPoints.toFixed(1) + " " + st + " experience points.\n";
			}
		}
	}
	
	if ( isStVarOn("blmClaw") ) { // Special Event already happened, no need to check
		resultsMessage += "\n[[Continue|Map]]";
	} else {
		// Dice roll triggers: Claw's dominance, Claw's ambition, Claw's perception, Claw's luck
		var baseValue = getCharsDrive("chClaw","dDomination") * 10 + getCharsDrive("chClaw","dAmbition") * 10 + gCstat("chClaw","perception") * 2 + gCstat("chClaw","luck");
		var dice1000 = limitedRandomInt(1000);
		var requiredLimit = 500;
		resultsMessage += "\nEvent chance: Secret Values (" + baseValue + ") + dice 1000 (" + dice1000 + ") ";
		if ( dice1000 + baseValue >= requiredLimit ) {
			resultsMessage += ">= Target (" + requiredLimit + ")\n\n"
			+ `<span @style=$chClaw.colorStyleKey>//"I can see you're having fun."//</span>\n\n`
			+ "<<l" + "ink [[Continue|FASE BbC Start]]>><<s" + "cript>>\n"
			+ "initializeFaSeBlackMailedByClaw();\n<</s" + "cript>><</l" + "ink>>";
		} else {
			resultsMessage += "< Target (" + requiredLimit + ")\n\n[[Continue|Map]]";
		}
	}
	
	// Finish formatting
	State.variables.compass.sceneResultsPassage = resultsMessage;
}

window.createGleamingCavernsDildoPlayAction = function() {
	var action = new mapAction("dldPlay","Try out the dildo",createSystemEventMedWait,false);
	action.description = "Find a hidden spot to feel the touch of your new toy against your flesh.";
	action.recMins = 20;
	action.getPassage = function() { return "FASE Dildo Play 1"; };
	return action;
}

// Morph Artist Hut

// Map Events
window.createGleamingCavernsMorphHutInit = function() {
	var action = new mapAction("morphHutConv","Inquiry about transformations",createSystemEventCheapWaitNoDesc,false);
	action.description = "Ask Mesquelles and the Transformation Master about their art.";
	action.recMins = 5;
	action.getPassage = function() { return "FASE MorphHut Init"; };
	return action;
}

window.createGleamingCavernsMorphHutMedInit = function() {
	var action = new mapAction("morphHutConv","Inquiry about transformations",createSystemEventCheapNoWait,false);
	action.description = "Ask Mesquelles and the Transformation Master about their art.";
	action.recMins = 0;
	action.getPassage = function() { return "FASE MorphHut Main"; };
	return action;
}

//

////////// GLEAMING CAVERNS MAPS ////////// 

	// Actions

window.mayGetAction = function(condition,failedMessage,action) {
	
}
window.mayGetBinaryAction = function(condition,extraMessage) {
}

	// Swamp //

setup.mapGleamingCaverns = [];
setup.mapGleamingCaverns.marshLP5 = new RoomInfo(
	"marshLP5", // Key
	"Swamp ~ Western Path 5", // Title
	"GleCav/marsh-forest-r.png", // Med Icon
	"GleCav/marsh-forest-r-sm.png", // Icon
	"This path connects the inner forests of the Confined Valley with the swamp of the Gleaming Caverns.", // Description
	[ new RoomConnection('marshLP4',2) ,
		  new RoomConnection('marshLPpuddles',3) ], // Connections
	null, // getActions
	[36,12]
);
setup.mapGleamingCaverns.marshLPpuddles = new RoomInfo(
	"marshLPpuddles", // Key
	"Swamp ~ Western Path Puddles", // Title
	"GleCav/marsh-swamp.png", // Med Icon
	"GleCav/marsh-swamp-sm.png", // Icon
	"Small bushes decorate the surroundings of a few ponds of water. Upon inspecting closely, some of the bushes are decorated by spider webs.", // Description
	[ new RoomConnection('marshLP3',3) ,
	  new RoomConnection('marshLP4',3) ,
	  new RoomConnection('marshLP5',3) ], // Connections
	null, // getActions
	[10,32]
);
setup.mapGleamingCaverns.marshLP4 = new RoomInfo(
	"marshLP4", // Key
	"Swamp ~ Western Path 4", // Title
	"GleCav/marsh-forest.png", // Med Icon
	"GleCav/marsh-forest-sm.png", // Icon
	"The air becomes more humid as you advance towards the marsh.", // Description
	[ new RoomConnection('marshLP3',2) ,
	  new RoomConnection('marshLP5',2) ,
	  new RoomConnection('marshLPpuddles',3),
	  new RoomConnection('marshLPlake',5)	  ], // Connections
	null, // getActions
	[40,40]
);
setup.mapGleamingCaverns.marshLP3 = new RoomInfo(
	"marshLP3", // Key
	"Swamp ~ Western Path 3", // Title
	"GleCav/marsh-forest-r.png", // Med Icon
	"GleCav/marsh-forest-r-sm.png", // Icon
	"A large lake, connected to a river, stands to your east. At the north, you find small ponds of water.", // Description
	[ new RoomConnection('marshLP2',2),
	  new RoomConnection('marshLP4',2) ,
		  new RoomConnection('marshLPpuddles',3),
		  new RoomConnection('marshLPlake',5) ], // Connections
	null, // getActions
	[16,66]
);
setup.mapGleamingCaverns.marshLP2 = new RoomInfo(
	"marshLP2", // Key
	"Swamp ~ Western Path 2", // Title
	"GleCav/marsh-forest.png", // Med Icon
	"GleCav/marsh-forest-sm.png", // Icon
	"Looking into the distance, rivers, ponds and water become far more common.", // Description
	[ new RoomConnection('marshLP1',2),
	  new RoomConnection('marshLP3',2),
	  new RoomConnection('marshLPlake',5) ], // Connections
	null, // getActions
	[25,95]
);
setup.mapGleamingCaverns.marshLP1 = new RoomInfo(
	"marshLP1", // Key
	"Swamp ~ Western Path 1", // Title
	"GleCav/marsh-forest-r.png", // Med Icon
	"GleCav/marsh-forest-r-sm.png", // Icon
	"A section of the road finds its limit next to a bridge. The smell of wet flora floods your nose.", // Description
	[ new RoomConnection('marshLbridge',2),
	  new RoomConnection('marshLP2',2),
	  new RoomConnection('marshLPlake',5),
      new RoomConnection('marshLriver2',4) ], // Connections
	null, // getActions
	[55,102]
);
setup.mapGleamingCaverns.marshLPlake = new RoomInfo(
	"marshLPlake", // Key
	"Swamp ~ Western Path Lake", // Title
	"GleCav/marsh-lake-r.png", // Med Icon
	"GleCav/marsh-lake-r-sm.png", // Icon
	"Countless dragonflies roam the shores of the lake in their quest for food, and the flapping of their wings adds ambience music to the scenery.", // Description
	[ new RoomConnection('marshLP1',5) ,
	  new RoomConnection('marshLP2',5) ,
	  new RoomConnection('marshLP3',5) ,
	  new RoomConnection('marshLP4',5) ,
	  new RoomConnection('marshLriver2',5) ], // Connections
	null, // getActions
	[44,67]
);

// marshLbridge, marshMP2, marshMP1, marshMpuddles, marshNP4, marshLriver2
setup.mapGleamingCaverns.marshLbridge = new RoomInfo(
	"marshLbridge", // Key
	"Swamp ~ Western Bridge", // Title
	"GleCav/marsh-river-bridge.png", // Med Icon
	"GleCav/marsh-river-bridge-sm.png", // Icon
	"This bridge connects the western, central and northern paths of the swamps.", // Description
	[ new RoomConnection('marshLP1',2) ,
	  new RoomConnection('marshMP2',2) ,
	  new RoomConnection('marshNP4',2) ,
	  new RoomConnection('marshLriver2',4),
	  new RoomConnection('marshSriver',4),
	  new RoomConnection('marshSEpuddles',3) ], // Connections
	null, // getActions
	[84,108]
);
setup.mapGleamingCaverns.marshMP2 = new RoomInfo(
	"marshMP2", // Key
	"Swamp ~ Central Path 2", // Title
	"GleCav/marsh-forest.png", // Med Icon
	"GleCav/marsh-forest-sm.png", // Icon
	"An eerie silence fills your ears.", // Description
	[ new RoomConnection('marshMP1',2) ,
	  new RoomConnection('marshNP4',2) ,
	  new RoomConnection('marshLbridge',2) ,
	  new RoomConnection('marshMpuddles',3),
	  new RoomConnection('marshSEpuddles',3) ], // Connections
	null, // getActions
	[112,117]
);
setup.mapGleamingCaverns.marshMP1 = new RoomInfo(
	"marshMP1", // Key
	"Swamp ~ Central Path 1", // Title
	"GleCav/marsh-forest.png", // Med Icon
	"GleCav/marsh-forest-sm.png", // Icon
	"The bridge at your east leads to the Gleaming Caverns, while the opposite path leads to the limits of the swamp.", // Description
	[ new RoomConnection('marshSbridge',2),
	  new RoomConnection('marshMP2',2) ,
	  new RoomConnection('marshMpuddles',3) ], // Connections
	null, // getActions
	[138,123]
);
setup.mapGleamingCaverns.marshLriver2 = new RoomInfo(
	"marshLriver2", // Key
	"Swamp ~ Western River 2", // Title
	"GleCav/marsh-river.png", // Med Icon
	"GleCav/marsh-river-r-sm.png", // Icon
	"Close to the confines of the swamp, a surge of vegetation hinders movement along the shore of the river.", // Description
	[ new RoomConnection('marshLPlake',5) ,
	  new RoomConnection('marshLP1',4) ,
	  new RoomConnection('marshNP4',4) ,
	  new RoomConnection('marshLbridge',4),
	  new RoomConnection('marshLriver1',4) ], // Connections
	null, // getActions
	[77,75]
);
setup.mapGleamingCaverns.marshNP4 = new RoomInfo(
	"marshNP4", // Key
	"Swamp ~ Northern Path 4", // Title
	"GleCav/marsh-forest-r.png", // Med Icon
	"GleCav/marsh-forest-r-sm.png", // Icon
	"A faint, yet rapid hammering comes from the woods. Upon focusing your sight, you find a couple of squirrels at the higher branches of a tall tree, eyeing you carefully while they devour acorns.", // Description
	[ new RoomConnection('marshMP2',2) ,
	  new RoomConnection('marshNP3',2) ,
	  new RoomConnection('marshLbridge',2) ,
	  new RoomConnection('marshLriver2',4) ,
	  new RoomConnection('marshMpuddles',3) ], // Connections
	null, // getActions
	[106,80]
);
setup.mapGleamingCaverns.marshMpuddles = new RoomInfo(
	"marshMpuddles", // Key
	"Swamp ~ Middle Puddles", // Title
	"GleCav/marsh-swamp.png", // Med Icon
	"GleCav/marsh-swamp-sm.png", // Icon
	"One grand hill blocks the way to your east. You're unable to find a path that would allow you to pass it, but some trees did find the way to sprout at its top.", // Description
	[ new RoomConnection('marshMP1',3) ,
	  new RoomConnection('marshMP2',3) ,
	  new RoomConnection('marshNP3',3) ,
	  new RoomConnection('marshNP4',2)	  ], // Connections
	null, // getActions
	[137,86]
);

// marshSEpuddles, marshSWpuddles, marshSriver, marshSElake, marshSWlake
setup.mapGleamingCaverns.marshSEpuddles = new RoomInfo(
	"marshSEpuddles", // Key
	"Swamp ~ South East Puddles", // Title
	"GleCav/marsh-swamp.png", // Med Icon
	"GleCav/marsh-swamp-sm.png", // Icon
	"Some puddles of water are right next to the mountain walls, perhaps connected to its underground rivers.", // Description
	[ new RoomConnection('marshMP2',3) ,
	  new RoomConnection('marshLbridge',3) ,
	  new RoomConnection('marshSriver',4),
      new RoomConnection('marshSElake',5) ], // Connections
	null, // getActions
	[83,137]
);
setup.mapGleamingCaverns.marshSriver = new RoomInfo(
	"marshSriver", // Key
	"Swamp ~ South River", // Title
	"GleCav/marsh-river.png", // Med Icon
	"GleCav/marsh-river-sm.png", // Icon
	"The strength of this river gracefully diminishes until it becomes almost as still as the lake where it meets its end.", // Description
	[ new RoomConnection('marshLbridge',4) ,
	  new RoomConnection('marshSEpuddles',4) ,
	  new RoomConnection('marshSWpuddles',4),
      new RoomConnection('marshSElake',5) ], // Connections
	null, // getActions
	[57,127]
);
setup.mapGleamingCaverns.marshSWpuddles = new RoomInfo(
	"marshSWpuddles", // Key
	"Swamp ~ South West Puddles", // Title
	"GleCav/marsh-swamp.png", // Med Icon
	"GleCav/marsh-swamp-sm.png", // Icon
	"Bravely and fiercely, a battalion of ants try their best to transport food back to their nest, but they get frequently assaulted by frogs shooting their tongues at them.", // Description
	[ new RoomConnection('marshSriver',4) ,
	  new RoomConnection('marshSElake',5) ,
	  new RoomConnection('marshSWlake',5) ], // Connections
	null, // getActions
	[26,140]
);
setup.mapGleamingCaverns.marshSElake = new RoomInfo(
	"marshSElake", // Key
	"Swamp ~ South East Lake", // Title
	"GleCav/marsh-lake.png", // Med Icon
	"GleCav/marsh-lake-sm.png", // Icon
	"The image of the mountain rises up to the skies, and down into the waters.", // Description
	[ new RoomConnection('marshSEpuddles',5) ,
	  new RoomConnection('marshSriver',5) ,
	  new RoomConnection('marshSWpuddles',5),
	  new RoomConnection('marshSWlake',5) ], // Connections
	null, // getActions
	[52,155]
);
setup.mapGleamingCaverns.marshSWlake = new RoomInfo(
	"marshSWlake", // Key
	"Swamp ~ South West Lake", // Title
	"GleCav/marsh-lake-ext.png", // Med Icon
	"GleCav/marsh-lake-ext-sm.png", // Icon
	"The water keeps extending beyond the reach of your eyes.", // Description
	[ new RoomConnection('marshSElake',5) ,
	  new RoomConnection('marshSWpuddles',5) ], // Connections
	null, // getActions
	[22,167]
);

// marshLriver1, marshNP3, marshNP2, marshNWlake, marshNElake
setup.mapGleamingCaverns.marshLriver1 = new RoomInfo(
	"marshLriver1", // Key
	"Swamp ~ Western River 1", // Title
	"GleCav/marsh-river.png", // Med Icon
	"GleCav/marsh-river-sm.png", // Icon
	"Reeds become far more common in this area, and so does the muddy terrain. A careless misstep may leave you with your feet stuck on the ground.", // Description
	[ new RoomConnection('marshLriver2',5) ,
	  new RoomConnection('marshNP3',5),
	  new RoomConnection('marshNWlake',5) ], // Connections
	null, // getActions
	[94,37]
);
setup.mapGleamingCaverns.marshNP3 = new RoomInfo(
	"marshNP3", // Key
	"Swamp ~ Northern Path 3", // Title
	"GleCav/marsh-forest-r.png", // Med Icon
	"GleCav/marsh-forest-r-sm.png", // Icon
	"Lush vegetation at both sides of the road blocks your sight.", // Description
	[ new RoomConnection('marshNP2',2) ,
	  new RoomConnection('marshNP4',2),
	  new RoomConnection('marshNWlake',5),
      new RoomConnection('marshLriver1',5),
	  new RoomConnection('marshMpuddles',4) ], // Connections
	null, // getActions
	[130,54]
);
setup.mapGleamingCaverns.marshNP2 = new RoomInfo(
	"marshNP2", // Key
	"Swamp ~ Northern Path 2", // Title
	"GleCav/marsh-forest.png", // Med Icon
	"GleCav/marsh-forest-sm.png", // Icon
	"To your north, an ample lake opens its arms, welcoming you.", // Description
	[ new RoomConnection('marshNP1',2) , 
	  new RoomConnection('marshNP3',2) ,
	  new RoomConnection('marshNElake',5) ,
	  new RoomConnection('hiddenCamp',3) ], // Connections
	null, // getActions
	[163,51]
);
setup.mapGleamingCaverns.marshNWlake = new RoomInfo(
	"marshNWlake", // Key
	"Swamp ~ North Western Lake", // Title
	"GleCav/marsh-lake-ext.png", // Med Icon
	"GleCav/marsh-lake-ext-sm.png", // Icon
	"\"Straying so far away from the path may have been a mistake\", you think as you realize you're surrounded by quicksand.", // Description
	[ new RoomConnection('marshNP3',8) ,
	  new RoomConnection('marshNElake',8),
	  new RoomConnection('marshLriver1',8) ], // Connections
	null, // getActions
	[128,20]
);
setup.mapGleamingCaverns.marshNElake = new RoomInfo(
	"marshNElake", // Key
	"Swamp ~ North Eastern Lake", // Title
	"GleCav/marsh-lake-r.png", // Med Icon
	"GleCav/marsh-lake-r-sm.png", // Icon
	"This shore of the lake is rich in flowers and other colorful plants. The western side of the lake, however, looks far sourer.", // Description
	[ new RoomConnection('marshNP2',5) ,
	  new RoomConnection('marshNWlake',5) ], // Connections
	null, // getActions
	[160,20]
);

// marshSbridge, marshSP3, marshSP2, marshSP1, marshCentrance, marshELlake
setup.mapGleamingCaverns.marshSbridge = new RoomInfo(
	"marshSbridge", // Key
	"Swamp ~ Southern Bridge", // Title
	"GleCav/marsh-river-bridge-r.png", // Med Icon
	"GleCav/marsh-river-bridge-r-sm.png", // Icon
	"This bridge connects the entrance to the Gleaming Caverns with the central parts of the swamp.", // Description
	[ new RoomConnection('marshMP1',2),
	  new RoomConnection('marshSP3',2),
	  new RoomConnection('marshEUriver',4)	  ], // Connections
	null, // getActions
	[164,127]
);
setup.mapGleamingCaverns.marshSP3 = new RoomInfo(
	"marshSP3", // Key
	"Swamp ~ Southern Path 3", // Title
	"GleCav/marsh-forest.png", // Med Icon
	"GleCav/marsh-forest-sm.png", // Icon
	"A bridge at your west leads to the central parts of the swamp, while another bridge at your north stands broken and unrepaired.", // Description
	[ new RoomConnection('marshSP2',2) ,
	  new RoomConnection('marshSbridge',2) ,
	  new RoomConnection('marshELriver',4) ,
	  new RoomConnection('marshELlake',5) ], // Connections
	null, // getActions
	[192,135]
);
setup.mapGleamingCaverns.marshSP2 = new RoomInfo(
	"marshSP2", // Key
	"Swamp ~ Southern Path 2", // Title
	"GleCav/marsh-forest-r.png", // Med Icon
	"GleCav/marsh-forest-r-sm.png", // Icon
	"There's little vegetation between the path you're following and the mountain at your south. What appears to be a short wall of rock is soon followed by taller, far more towering ridges.", // Description
	[ new RoomConnection('marshSP1',2) ,
	  new RoomConnection('marshSP3',2) ,
	  new RoomConnection('marshELlake',5) ], // Connections
	null, // getActions
	[201,161]
);
setup.mapGleamingCaverns.marshSP1 = new RoomInfo(
	"marshSP1", // Key
	"Swamp ~ Southern Path 1", // Title
	"GleCav/marsh-forest.png", // Med Icon
	"GleCav/marsh-forest-sm.png", // Icon
	"A humid entrance into the depths of the mountain appears between the trees. Beyond it, lie the Gleaming Caverns, and further beyond, the Shapeshifter tribe.", // Description
	[ new RoomConnection('marshCentrance',2) ,
	  new RoomConnection('marshSP2',2) ,
	  new RoomConnection('marshELlake',5) ], // Connections
	null, // getActions
	[228,170]
);
setup.mapGleamingCaverns.marshELlake = new RoomInfo(
	"marshELlake", // Key
	"Swamp ~ Eastern Lower Lake", // Title
	"GleCav/marsh-lake-ext.png", // Med Icon
	"GleCav/marsh-lake-ext-sm.png", // Icon
	"A few humanoid figures have been crafted with clay close to the water, but they haven't been properly heated, and it won't take too long for them to completely lose their form.", // Description
	[ new RoomConnection('marshSP1',5) ,
	  new RoomConnection('marshSP2',5) ,
	  new RoomConnection('marshSP3',5) ,
	  new RoomConnection('marshELriver',5) , 
	  new RoomConnection('marshEUlake',5) ], // Connections
	null, // getActions
	[225,136]
);
setup.mapGleamingCaverns.marshCentrance = new RoomInfo(
	"marshCentrance", // Key
	"Swamp ~ Caverns Entrance", // Title
	"GleCav/cavern-entrance-rev.png", // Med Icon
	"GleCav/cavern-entrance-rev-sm.png", // Icon
	"An eerie, yet appealing cyan light comes out of the cavern.", // Description
	[ new RoomConnection('marshSP1',2),
		new RoomConnection('cavernMP3',2) ], // Connections 
	null, // getActions
	[34,11] // 34,11 , [228,170] , [256,174]
);

// marshNP1, marshEUriver, marshELriver, marshNEbridge, marshNEriver, marshEUlake, marshMpath, marshMentrance
setup.mapGleamingCaverns.marshNP1 = new RoomInfo(
	"marshNP1", // Key
	"Swamp ~ Northern Path 1", // Title
	"GleCav/marsh-forest.png", // Med Icon
	"GleCav/marsh-forest-sm.png", // Icon
	"Looking at your horizon to the east, you find it's easy to follow a path leading towards the mountains.", // Description
	[ new RoomConnection('marshNP2',2) ,
	  new RoomConnection('marshNEbridge',2) ,
	  new RoomConnection('marshNEriver',4) ,
	  new RoomConnection('marshEUriver',4) ], // Connections
	null, // getActions
	[193,59]
);
setup.mapGleamingCaverns.marshEUriver = new RoomInfo(
	"marshEUriver", // Key
	"Swamp ~ Eastern River 2", // Title
	"GleCav/marsh-river.png", // Med Icon
	"GleCav/marsh-river-sm.png", // Icon
	"The river diverges into two different directions, from the north to the south-west and to the south-east.", // Description
	[ new RoomConnection('marshNP1',4) ,
	  new RoomConnection('marshNEbridge',4),
	  new RoomConnection('marshELriver',4),
	  new RoomConnection('marshSbridge',4) ], // Connections
	null, // getActions
	[184,95]
);
setup.mapGleamingCaverns.marshELriver = new RoomInfo(
	"marshELriver", // Key
	"Swamp ~ Eastern River 1", // Title
	"GleCav/marsh-river-r.png", // Med Icon
	"GleCav/marsh-river-r-sm.png", // Icon
	"Several pieces of a throughly broken bridge have fallen into the water, and now do more to hinder movement than to facilitate it.", // Description
	[ new RoomConnection('marshSP3',5) ,
	  new RoomConnection('marshMpath',5) , 
	  new RoomConnection('marshEUriver',5),
	  new RoomConnection('marshEUlake',5),
	  new RoomConnection('marshELlake',5) ], // Connections
	null, // getActions
	[212,107]
);
setup.mapGleamingCaverns.marshNEbridge = new RoomInfo(
	"marshNEbridge", // Key
	"Swamp ~ Mountain Bridge", // Title
	"GleCav/marsh-river-bridge.png", // Med Icon
	"GleCav/marsh-river-bridge-sm.png", // Icon
	"One of the paths that connects this bridge leads to the mountains; the other leads to the center of the swamp.", // Description
	[ new RoomConnection('marshNP1',2),
	  new RoomConnection('marshMpath',2),
	  new RoomConnection('marshEUriver',4),
	  new RoomConnection('marshNEriver',4) ], // Connections
	null, // getActions
	[217,80]
);
setup.mapGleamingCaverns.marshNEriver = new RoomInfo(
	"marshNEriver", // Key
	"Swamp ~ North Eastern River", // Title
	"GleCav/marsh-river.png", // Med Icon
	"GleCav/marsh-river-sm.png", // Icon
	"Coming fresh from the mountain, this water stream strikes ferociously against the shores. Swimming against the current, if possible, would only lead to crashing against the rocks.", // Description
	[ new RoomConnection('marshMpath',6) ,
	  new RoomConnection('marshNP1',6),
	  new RoomConnection('marshNEbridge',5) ], // Connections
	null, // getActions
	[228,51]
);
setup.mapGleamingCaverns.marshEUlake = new RoomInfo(
	"marshEUlake", // Key
	"Swamp ~ Eastern Upper Lake", // Title
	"GleCav/marsh-lake-r.png", // Med Icon
	"GleCav/marsh-lake-r-sm.png", // Icon
	"In the middle of the lake, an isolated island serves as an unlikely haven of peace, far away from the Temple, the tribes, the monsters and their tribulations.", // Description
	[ new RoomConnection('marshMpath',5) ,
	  new RoomConnection('marshELlake',5) ,
	  new RoomConnection('marshELriver',5) ], // Connections
	null, // getActions
	[240,110]
);
setup.mapGleamingCaverns.marshMpath = new RoomInfo(
	"marshMpath", // Key
	"Swamp ~ Mountain Path", // Title
	"GleCav/marsh-forest-r.png", // Med Icon
	"GleCav/marsh-forest-r-sm.png", // Icon
	"While the flora still remains common and healthy, following the path upwards makes the terrain become more arid, while going down humidifies the air.", // Description
	[ new RoomConnection('marshNEbridge',2) ,
	  new RoomConnection('marshMentrance',2) ,
	  new RoomConnection('marshELriver',4) ,
	  new RoomConnection('marshEUlake',5) ,
	  new RoomConnection('marshNEriver',4) ], // Connections
	null, // getActions
	[245,85]
);
setup.mapGleamingCaverns.marshMentrance = new RoomInfo(
	"marshMentrance", // Key
	"Swamp ~ Mountains Entrance", // Title
	"GleCav/mountain-path-forested-r.png", // Med Icon
	"GleCav/mountain-path-forested-r-sm.png", // Icon
	"Gazing into the distance makes your eyes meet a goat. You envy the goat as soon as you realize that it makes climbing the mountain's walls look as easy as you would make walking look to a baby.", // Description
	[ new RoomConnection('marshMpath',2) ], // Connections
	null, // getActions
	[257,59]
);

setup.mapGleamingCaverns.hiddenCamp = new RoomInfo(
	"hiddenCamp", // Key
	"Swamp ~ Hidden Camp", // Title
	"GleCav/mountain-path-forested.png", // Med Icon
	"GleCav/mountain-path-forested-sm.png", // Icon
	"Hidden behind a small grove, a trail leads to the top of the hills in the middle of the swamp.", // Description
	[ new RoomConnection('marshNP2',3) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard() ];
		return actions;
	}, // getActions
	[160,84]
);

	// Caverns //

setup.mapGleamingCaverns.cavernMP3 = new RoomInfo(
	"cavernMP3", // Key
	"Caverns ~ Main Path 3", // Title
	"GleCav/caverns-pavemented-path.png", // Med Icon
	"GleCav/caverns-pavemented-path-sm.png", // Icon
	"Tiles crafted with clay garnish the walls, guiding the unwary traveller through the safe tunnels of the caverns.", // Description
	[ new RoomConnection('cavernMP2',2) ,
		  new RoomConnection('marshCentrance',2),
		  new RoomConnection('hiddenHut',2) ], // Connections
	null, // getActions
	[59,29]
);
setup.mapGleamingCaverns.hiddenHut = new RoomInfo(
	"hiddenHut", // Key
	"Caverns ~ Morph Artist Hut", // Title
	"GleCav/town-lonely-house.png", // Med Icon
	"GleCav/town-lonely-house-sm.png", // Icon
	"After passing through an inconspicuous passage, you find a secluded hut.", // Description
	[ new RoomConnection('cavernMP3',2) ], // Connections
	function(characters) {
		var actions = [ ] ;
		if ( isStVarOn("mphInit") == true ) {
			actions.push(createGleamingCavernsMorphHutMedInit());
		} else {
			actions.push(createGleamingCavernsMorphHutInit());
		}
	//	createGleamingCavernsMorphHutInit() ];
	//	if ( isStVarOn("dldCrf") == true && isStVarOn("dldPly") == false && characters[0] == "chPlayerCharacter" ) {
	//		actions.push(createGleamingCavernsDildoPlayAction());
	// createGleamingCavernsMorphHutMedInit
	//	}
		return actions;
	}, // getActions
	[66,4]
);
setup.mapGleamingCaverns.cavernMP2 = new RoomInfo(
	"cavernMP2", // Key
	"Caverns ~ Main Path 2", // Title
	"GleCav/caverns-pavemented-path.png", // Med Icon
	"GleCav/caverns-pavemented-path-sm.png", // Icon
	"A painting on the wall resembles a person surrounded by rocks and water, unable to find their way out. This is a warning for the over-confident explorers, telling them to stay away of the unmarked path.", // Description
	[ new RoomConnection('cavernMP1',2) ,
		  new RoomConnection('cavernMP3',2),
		  new RoomConnection('labyrinthEntrance',2) ], // Connections
	null, // getActions
	[69,54]
);
setup.mapGleamingCaverns.labyrinthEntrance = new RoomInfo(
	"labyrinthEntrance", // Key
	"Caverns ~ Deeper Tunnels Entrance", // Title
	"GleCav/cavern-wild-path-r.png", // Med Icon
	"GleCav/cavern-wild-path-r-sm.png", // Icon
	"The guidance of the ceramic art ends here, only gleaming crystals illuminating the way ahead. Beyond this point, the walls and waters of the Caverns may leave you trapped at their own whims.", // Description
	[ new RoomConnection('cavernMP2',2) ], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel1","Section 1",0,2),
						createActionMovingWildTunnel("wildTunnel2","Section 2",0,2) ];
		return actions;
	}, // getActions
	[93,48]
);
setup.mapGleamingCaverns.cavernMP1 = new RoomInfo(
	"cavernMP1", // Key
	"Caverns ~ Main Path 1", // Title
	"GleCav/caverns-pavemented-path.png", // Med Icon
	"GleCav/caverns-pavemented-path-sm.png", // Icon
	"The way forks here in three directions. You can reach the Shapeshifter tribe and the Lake of Union from here.", // Description
	[ new RoomConnection('cavernMP2',2) ,
		  new RoomConnection('unionLakeEast',2),
		  new RoomConnection('mainStreet1',2) ], // Connections
	null, // getActions
	[72,79]
);
setup.mapGleamingCaverns.unionLakeEast = new RoomInfo(
	"unionLakeEast", // Key
	"Caverns ~ Union Lake Entrance", // Title
	"GleCav/caverns-semi-flooded-path-r.png", // Med Icon
	"GleCav/caverns-semi-flooded-path-r-sm.png", // Icon
	"A tranquil, bottomless lake rests in front of you. The smallest of waves echo through the giant chamber.", // Description
	[ new RoomConnection('cavernMP1',2) ,
		  new RoomConnection('unionLakeWest',2),
		  new RoomConnection('unionLakeUpper',4) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard() ];
		return actions;
	}, // getActions
	[45,82]
);
setup.mapGleamingCaverns.unionLakeWest = new RoomInfo(
	"unionLakeWest", // Key
	"Caverns ~ Union Lake Interior", // Title
	"GleCav/caverns-semi-flooded-path.png", // Med Icon
	"GleCav/caverns-semi-flooded-path-sm.png", // Icon
	"A few earth mounds make the terrain fairly irregular here, both on ground and water. It is easy to find an intimate spot.", // Description
	[ new RoomConnection('unionLakeEast',2) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard() ];
		return actions;
	}, // getActions
	[21,87]
);
setup.mapGleamingCaverns.unionLakeUpper = new RoomInfo(
	"unionLakeUpper", // Key
	"Caverns ~ Union Lake Upper Platform", // Title
	"GleCav/cavern-wild-path-r.png", // Med Icon
	"GleCav/cavern-wild-path-r-sm.png", // Icon
	"After climbing a somewhat laborious path, you find yourself atop a high platform, giving you a great view of the lake.", // Description
	[ new RoomConnection('unionLakeEast',4) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard(),
						createCheapWaitingActionCaverns() ];
		
		// Voyeurism map scene
			// Dice
		var baseChance = gCstat(characters[0],"perception") * 2 + gCstat(characters[0],"luck");
		var dice200 = limitedRandomInt(200);
		var difficulty = 100;
			// Settings
		if ( State.variables.mapGleamingCaverns.voyeurRerollCounter == undefined || State.variables.mapGleamingCaverns.voyeurRerollCounter != State.variables.daycycle.minutes ) {
			State.variables.mapGleamingCaverns.voyeurRerollCounter = State.variables.daycycle.minutes;
			State.variables.mapGleamingCaverns.femCharA = true;
			State.variables.mapGleamingCaverns.femCharB = true;
			State.variables.mapGleamingCaverns.egaScene = true;
			if ( gSettings().lewdMales == "enable" ) {
				if ( limitedRandomInt(100) < 30 ) {
					State.variables.mapGleamingCaverns.femCharA = false;
				}
				if ( limitedRandomInt(100) < 30 ) {
					State.variables.mapGleamingCaverns.femCharB = false;
				}
			}
			if ( ( limitedRandomInt(100) < 35 ) ) {
				State.variables.mapGleamingCaverns.egaScene = false;
			}
		}
		var voyeurAction = createGleamingCavernsVoyeurAction(State.variables.mapGleamingCaverns.femCharA,State.variables.mapGleamingCaverns.femCharB,State.variables.mapGleamingCaverns.egaScene,characters);
		if ( (baseChance + dice200) >= difficulty ) {
			if ( characters[0] == "chPlayerCharacter" ) {
				var sceneDesc = "";
				if ( State.variables.mapGleamingCaverns.femCharA && State.variables.mapGleamingCaverns.femCharB && State.variables.mapGleamingCaverns.egaScene ) {
					sceneDesc = "Two women, caressing each other.";
				} else if ( State.variables.mapGleamingCaverns.egaScene && ( State.variables.mapGleamingCaverns.femCharA || State.variables.mapGleamingCaverns.femCharB ) ) {
					sceneDesc = "A man and a woman, meeting each other.";
				} else if ( State.variables.mapGleamingCaverns.femCharA && State.variables.mapGleamingCaverns.femCharB ) {
					sceneDesc = "Two women, one mounting the other.";
				} else if ( State.variables.mapGleamingCaverns.egaScene && State.variables.mapGleamingCaverns.femCharA == false && State.variables.mapGleamingCaverns.femCharB == false ) {
					sceneDesc = "Two men, seeking each other's touch.";
				} else if ( State.variables.mapGleamingCaverns.femCharA == false && State.variables.mapGleamingCaverns.femCharB == false ) {
					sceneDesc = "Two men, one above the other.";
				} else if ( State.variables.mapGleamingCaverns.egaScene == false && State.variables.mapGleamingCaverns.femCharA ) {
					sceneDesc = "A woman, mounting a man.";
				} else {
					sceneDesc = "A man, mounting a woman.";
				}
				State.variables.compass.setMapActionsMessage("You spot a couple of shapes down below... " + sceneDesc + " " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility * 2 + + Luck") + " + Dice 200 (" + dice200 + ") < Difficulty (" + difficulty + ")");
			}
		} else {
			voyeurAction.requirements = function(cG) { return false; }
			if ( characters[0] == "chPlayerCharacter" ) {
				State.variables.compass.setMapActionsMessage("The caverns look lonely... " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility * 2 + + Luck") + " + Dice 200 (" + dice200 + ") < Difficulty (" + difficulty + ")");
			}
		}
		actions.push(voyeurAction);
		
		
		return actions;
	}, // getActions
	[37,58]
);

	// Tribe
setup.mapGleamingCaverns.mainStreet1 = new RoomInfo(
	"mainStreet1", // Key
	"Shapeshifters ~ Western Main Street", // Title
	"GleCav/town-common-street-ext.png", // Med Icon
	"GleCav/town-common-street-ext-sm.png", // Icon
	"The Shapeshifter tribe appears before your eyes. You see clay huts in all directions, divided by a large main street that continues until the end of the village.", // Description
	[ new RoomConnection('mainStreet2',2),
		new RoomConnection('cavernMP1',2),
		new RoomConnection('workshop',2),
		new RoomConnection('frozenBaths',2) ], // Connections
	null, // getActions
	[95,126]
);
setup.mapGleamingCaverns.workshop = new RoomInfo(
	"workshop", // Key
	"Shapeshifters ~ Workshops", // Title
	"GleCav/town-workshop.png", // Med Icon
	"GleCav/town-workshop-sm.png", // Icon
	"There are several workshops in this area, well equipped with tools and furnaces to craft ceramics, glass and ornaments.", // Description
	[ new RoomConnection('mainStreet1',2),
		new RoomConnection('houses',1),
		new RoomConnection('mainStreet2',2) ], // Connections
	function(characters) {
		var actions = [ createWorkshopCraftingAction(),
						createWorkshopPaintingAction() ];
		if ( isStVarOn("dldCrf") == true && isStVarOn("dldPly") == false && characters[0] == "chPlayerCharacter" ) {
			actions.push(createGleamingCavernsDildoPlayAction());
		}
		return actions;
	}, // getActions
	[115,96]
);
setup.mapGleamingCaverns.houses = new RoomInfo(
	"houses", // Key
	"Shapeshifters ~ Houses", // Title
	"GleCav/town-lonely-house.png", // Med Icon
	"GleCav/town-lonely-house-sm.png", // Icon
	"A few lone houses have been erected in this corner of the village.", // Description
	[ new RoomConnection('workshop',1),
		new RoomConnection('thermalBaths',1),
		new RoomConnection('mainStreet2',2) ], // Connections
	null, // getActions
	[145,91]
);
setup.mapGleamingCaverns.thermalBaths = new RoomInfo(
	"thermalBaths", // Key
	"Shapeshifters ~ Thermal Baths", // Title
	"GleCav/town-bath.png", // Med Icon
	"GleCav/town-bath-sm.png", // Icon
	"Underground heat reaches the water of this bath, making it great to discharge the pressure of tense muscles.", // Description
	[ new RoomConnection('houses',1),
		new RoomConnection('mainStreet2',1),
		new RoomConnection('mainStreet3',1) ], // Connections
	function(characters) {
		var actions = [ createHeatedBathAction(),
						createRestingActionStandard() ];
		return actions;
	}, // getActions
	[181,91]
);

setup.mapGleamingCaverns.mainStreet2 = new RoomInfo(
	"mainStreet2", // Key
	"Shapeshifters ~ Central Main Street", // Title
	"GleCav/town-main-street.png", // Med Icon
	"GleCav/town-main-street-sm.png", // Icon
	"Beautiful tiles embellish the floor, their paintings illustrating various stories. One of them shows a giant Goddess embracing the Leirien, the Aiishen, and the Shapeshifters. A different one shows dozens of Shapeshifters entering the Caverns.", // Description
	[ new RoomConnection('mainStreet1',2),
		new RoomConnection('workshop',2),
		new RoomConnection('houses',2),
		new RoomConnection('thermalBaths',2),
		new RoomConnection('mainStreet3',2),
		new RoomConnection('frozenBaths',2),
		new RoomConnection('publicBaths',2),
		new RoomConnection('templeShrine',2) ], // Connections
	null, // getActions
	[149,130]
);
setup.mapGleamingCaverns.mainStreet3 = new RoomInfo(
	"mainStreet3", // Key
	"Shapeshifters ~ Eastern Main Street", // Title
	"GleCav/town-common-street-ext-r.png", // Med Icon
	"GleCav/town-common-street-ext-r-sm.png", // Icon
	"At the end of the main street, you find the entrance to the amphitheater.", // Description
	[ new RoomConnection('mainStreet2',2),
		new RoomConnection('thermalBaths',2),
		new RoomConnection('assembly',2),
		new RoomConnection('publicBaths',2) ], // Connections
	null, // getActions
	[201,132]
);
setup.mapGleamingCaverns.assembly = new RoomInfo(
	"assembly", // Key
	"Shapeshifters ~ Assembly", // Title
	"GleCav/town-assembly.png", // Med Icon
	"GleCav/town-assembly-sm.png", // Icon
	"Stone mounds with the very rough form of hyperrectangles serve as seats, forming increasingly elevated semi-circles around a large, circular platform.", // Description
	[ new RoomConnection('mainStreet3',2),
		new RoomConnection('dressingRoom',1) ], // Connections
	function(characters) {
		var actions = [ createTheaterImprovisationAction() ];
		return actions;
	}, // getActions
	[242,136]
);
setup.mapGleamingCaverns.dressingRoom = new RoomInfo(
	"dressingRoom", // Key
	"Shapeshifters ~ Assembly's Dressing Room", // Title
	"GleCav/town-room-interior.png", // Med Icon
	"GleCav/town-room-interior-sm.png", // Icon
	"Plenty of dresses, attires and ornaments are to be found here, to be used by performers on a daily basis.", // Description
	[ new RoomConnection('assembly',1) ], // Connections
	null, // getActions
	[257,105]
);

setup.mapGleamingCaverns.frozenBaths = new RoomInfo(
	"frozenBaths", // Key
	"Shapeshifters ~ Frozen Baths", // Title
	"GleCav/town-bath.png", // Med Icon
	"GleCav/town-bath-sm.png", // Icon
	"The water here seeps to the last nook of your bones. If you're resilient enough to survive it, you will have proven the strength of your willpower.", // Description
	[ new RoomConnection('mainStreet1',2),
		new RoomConnection('mainStreet2',2),
		new RoomConnection('templeStorage',2),
		new RoomConnection('templeShrine',2) ], // Connections
	function(characters) {
		var actions = [ createFrozenBathAction(),
						createRestingActionStandard() ];
		return actions;
	}, // getActions
	[101,155]
);
setup.mapGleamingCaverns.publicBaths = new RoomInfo(
	"publicBaths", // Key
	"Shapeshifters ~ Public Baths", // Title
	"GleCav/town-bath.png", // Med Icon
	"GleCav/town-bath-sm.png", // Icon
	"Enclosed by no walls or curtains, this bath is open to everyone's eyesight, and so are the bodies of those who enter it.", // Description
	[ new RoomConnection('mainStreet2',2),
		new RoomConnection('mainStreet3',2),
		new RoomConnection('templeShrine',2) ], // Connections
	function(characters) {
		var actions = [ createPublicBathAction(),
						createRestingActionStandard() ];
		return actions;
	}, // getActions
	[189,164]
);
setup.mapGleamingCaverns.templeStorage = new RoomInfo(
	"templeStorage", // Key
	"Shapeshifters ~ Temple Storage", // Title
	"GleCav/town-room-interior.png", // Med Icon
	"GleCav/town-room-interior-sm.png", // Icon
	"Among rooms dedicated to store salfis flowers and other supplies used by the Temple, some rooms have been prepared to accommodate the Candidates.", // Description
	[ new RoomConnection('frozenBaths',2),
		new RoomConnection('templeShrine',2) ], // Connections
	function(characters) {
		var actions = [ createRestingActionStandard() ];
		return actions;
	}, // getActions
	[107,199]
);
setup.mapGleamingCaverns.templeShrine = new RoomInfo(
	"templeShrine", // Key
	"Shapeshifters ~ Temple of Harmony", // Title
	"GleCav/town-harmony-temple.png", // Med Icon
	"GleCav/town-harmony-temple-sm.png", // Icon
	"A large dome houses a marble statue of the Goddess, surrounded by carved figures of the praying faithful.", // Description
	[ new RoomConnection('mainStreet2',2),
		new RoomConnection('frozenBaths',2),
		new RoomConnection('publicBaths',2),
		new RoomConnection('templeStorage',2)
//		,new RoomConnection('templeSanctum',1)
		], // Connections
	null, // getActions
	[147,196]
);

setup.mapGleamingCaverns.templeShrine.displayConnections = function() {
	var string = "";
	for ( var connection of this.connections ) {
		string += getLinkToRoom(connection.loc,"Go to " + getCurrentMap().rooms[connection.loc].title,connection.distance)
			    + " (" + colorText(connection.distance,"khaki") + ") ";
				if ( State.variables.chPlayerCharacter.hasFreeBodypart("eyes") ) {
					string += displayCharIconsInRoom(connection.loc);
				}
		string += "\n";
	}
		// Temple Sanctum
	if ( isStVarOn("alwSct") ) {
		string += getLinkToRoom("templeSanctum","Go to " + getCurrentMap().rooms["templeSanctum"].title,2)
			    + " (" + colorText(2,"khaki") + ") " + displayCharIconsInRoom("templeSanctum") + "\n";
	} else {
		string += colorText("Nersmias blocks the entrance to the Temple Sanctum.\n","red");
	}
	
	return string;
}
setup.mapGleamingCaverns.templeSanctum = new RoomInfo(
	"templeSanctum", // Key
	"Shapeshifters ~ Temple's Sanctum", // Title
	"GleCav/town-room-interior.png", // Med Icon
	"GleCav/town-room-interior-sm.png", // Icon
	"One large corridor separates columns of pews that look towards a small shrine. Behind it, you can find the doors to a few small rooms.", // Description
	[ new RoomConnection('templeShrine',1) ], // Connections
	null, // getActions
	[186,201]
);

	// Deeper Tunnels
setup.mapGleamingCaverns.wildTunnel1 = new RoomInfo(
	"wildTunnel1", // Key
	"Wild Tunnels ~ Tunnel 1", // Title
	"GleCav/caverns-wild-path.png", // Med Icon
	"GleCav/caverns-wild-path-sm.png", // Icon
	"", // Description
	[ new RoomConnection('labyrinthEntrance',2) ], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel3","Section 3",0,2),
						createActionMovingWildTunnel("wildTunnel4","Section 4",0,2) ];
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel2 = new RoomInfo(
	"wildTunnel2", // Key
	"Wild Tunnels ~ Tunnel 2", // Title
	"GleCav/caverns-wild-path.png", // Med Icon
	"GleCav/caverns-wild-path-sm.png", // Icon
	"", // Description
	[ new RoomConnection('labyrinthEntrance',2) ], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel4","Section 4",0,2),
						createActionMovingWildTunnel("wildTunnel5","Section 5",0,2)	]; // Provisional ToDo: Remove ,
// createActionMovingWildTunnel("wildTunnel22","Section 22",5,2)					
			// Path to Tunnel 6
			var baseChance = gCstat(characters[0],"perception") + gCstat(characters[0],"agility") + gCstat(characters[0],"resilience") + gCstat(characters[0],"will") + gCstat(characters[0],"luck");
			var dice200 = limitedRandomInt(200);
			var difficulty = 100;
			var act0 = createActionMovingWildTunnel("wildTunnel6","Section 6",0,2);
			if ( (baseChance + dice200) >= difficulty ) {
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 6: " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ") " + hoverText("(?)","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") => Difficulty (" + difficulty + ")");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 6: " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") < Difficulty (" + difficulty + ")");
				}
			}
			actions.push(act0);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel3 = new RoomInfo(
	"wildTunnel3", // Key
	"Wild Tunnels ~ Tunnel 3", // Title
	"GleCav/caverns-semi-flooded-path.png", // Med Icon
	"GleCav/caverns-semi-flooded-path-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel2","Section 2",0,2) ];
			// Path to Tunnel 9
			var baseChance = gCstat(characters[0],"perception") + gCstat(characters[0],"agility") + gCstat(characters[0],"resilience") + gCstat(characters[0],"will") + gCstat(characters[0],"luck");
			var dice200 = limitedRandomInt(200);
			var difficulty = 130;
			var act0 = createActionMovingWildTunnel("wildTunnel9","Section 9",0,2);
			if ( (baseChance + dice200) >= difficulty ) {
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 9: " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ") " + hoverText("(?)","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") => Difficulty (" + difficulty + ")");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 9: " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") < Difficulty (" + difficulty + ")");
				}
			}
			actions.push(act0);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel4 = new RoomInfo(
	"wildTunnel4", // Key
	"Wild Tunnels ~ Tunnel 4", // Title
	"GleCav/cavern-wild-path-r.png", // Med Icon
	"GleCav/cavern-wild-path-r-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel3","Section 3",5,2),
						createActionMovingWildTunnel("wildTunnel6","Section 6",0,2) ];
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel5 = new RoomInfo(
	"wildTunnel5", // Key
	"Wild Tunnels ~ Tunnel 5", // Title
	"GleCav/caverns-semi-flooded-path-r.png", // Med Icon
	"GleCav/caverns-semi-flooded-path-r-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel7","Section 7",5,2) ];
			// Path to Tunnel 9
			var baseChance = gCstat(characters[0],"perception") + gCstat(characters[0],"agility") + gCstat(characters[0],"resilience") + gCstat(characters[0],"will") + gCstat(characters[0],"luck");
			var dice200 = limitedRandomInt(200);
			var difficulty = 130;
			var act0 = createActionMovingWildTunnel("wildTunnel9","Section 9",0,2);
			if ( (baseChance + dice200) >= difficulty ) {
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 9: " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ") " + hoverText("(?)","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") => Difficulty (" + difficulty + ")");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 9: " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") < Difficulty (" + difficulty + ")");
				}
			}
			actions.push(act0);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel6 = new RoomInfo(
	"wildTunnel6", // Key
	"Wild Tunnels ~ Tunnel 6", // Title
	"GleCav/caverns-wild-path.png", // Med Icon
	"GleCav/caverns-wild-path-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel8","Section 8",0,2),
						createActionMovingWildTunnel("wildTunnel9","Section 9",10,2) ];
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel7 = new RoomInfo(
	"wildTunnel7", // Key
	"Wild Tunnels ~ Tunnel 7", // Title
	"GleCav/caverns-flooded-path.png", // Med Icon
	"GleCav/caverns-flooded-path-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel10","Section 10",0,2) ];
			// Path to Tunnel 11
			var baseChance = gCstat(characters[0],"perception") + gCstat(characters[0],"agility") + gCstat(characters[0],"resilience") + gCstat(characters[0],"will") + gCstat(characters[0],"luck");
			var dice200 = limitedRandomInt(200);
			var difficulty = 250;
			var act0 = createActionMovingWildTunnel("wildTunnel11","Section 11",10,2);
			if ( (baseChance + dice200) >= difficulty ) {
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 11: " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ") " + hoverText("(?)","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") => Difficulty (" + difficulty + ")");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 11: " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") < Difficulty (" + difficulty + ")");
				}
			}
			actions.push(act0);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel8 = new RoomInfo(
	"wildTunnel8", // Key
	"Wild Tunnels ~ Tunnel 8", // Title
	"GleCav/caverns-wild-path.png", // Med Icon
	"GleCav/caverns-wild-path-sm.png", // Icon
	"It's possible to climb a few ledges to reach a platform further above.", // Description
	[ ], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("mountainsExit","Exit to Mountains",10,2),
						createActionMovingWildTunnel("wildTunnel7","Section 7",0,2) ];
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel9 = new RoomInfo(
	"wildTunnel9", // Key
	"Wild Tunnels ~ Tunnel 9", // Title
	"GleCav/caverns-wild-path-r.png", // Med Icon
	"GleCav/caverns-wild-path-r-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel12","Section 12",5,2),
						createActionMovingWildTunnel("wildTunnel13","Section 13",0,2) ];
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel10 = new RoomInfo(
	"wildTunnel10", // Key
	"Wild Tunnels ~ Tunnel 10", // Title
	"GleCav/caverns-semi-flooded-path-r.png", // Med Icon
	"GleCav/caverns-semi-flooded-path-r-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel9","Section 9",5,2) ];
			// Path to Tunnel 11
			var baseChance = gCstat(characters[0],"perception") + gCstat(characters[0],"agility") + gCstat(characters[0],"resilience") + gCstat(characters[0],"will") + gCstat(characters[0],"luck");
			var dice200 = limitedRandomInt(200);
			var difficulty = 225;
			var act0 = createActionMovingWildTunnel("wildTunnel11","Section 11",0,2);
			if ( (baseChance + dice200) >= difficulty ) {
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 11: " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ") " + hoverText("(?)","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") => Difficulty (" + difficulty + ")");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 11: " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") < Difficulty (" + difficulty + ")");
				}
			}
			actions.push(act0);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel11 = new RoomInfo(
	"wildTunnel11", // Key
	"Wild Tunnels ~ Tunnel 11", // Title
	"GleCav/caverns-wild-path.png", // Med Icon
	"GleCav/caverns-wild-path-sm.png", // Icon
	"You spot a very tight tunnel at the bottom of the river. A well-trained, disciplined person would be able to fit through if they waited long enough for the natural transformations of the Caverns to widen the gap.", // Description
	[], // Connections
	function(characters) {
		var actions = [ createWaitingActionCaverns(),
						createActionMovingWildTunnel("wildTunnel1","Section 1",0,2) ];
			// Path to Pond of Illumination
			var baseChance = gCstat(characters[0],"perception") + gCstat(characters[0],"agility") + gCstat(characters[0],"resilience") + gCstat(characters[0],"will") + gCstat(characters[0],"luck");
			var dice200 = limitedRandomInt(200);
			var difficulty = 260;
			var act0 = createActionMovingWildTunnel("pondIllumination","Tight tunnel",0,2);
			if ( (baseChance + dice200) >= difficulty ) {
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to tight tunnel: " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ") " + hoverText("(?)","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") => Difficulty (" + difficulty + ")");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to tight tunnel: " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") < Difficulty (" + difficulty + ")");
				}
			}
			actions.push(act0);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel12 = new RoomInfo(
	"wildTunnel12", // Key
	"Wild Tunnels ~ Tunnel 12", // Title
	"GleCav/caverns-semi-flooded-path.png", // Med Icon
	"GleCav/caverns-semi-flooded-path-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel2","Section 2",0,2) ];
			// Path to Tunnel 17
			var baseChance = gCstat(characters[0],"perception") + gCstat(characters[0],"agility") + gCstat(characters[0],"resilience") + gCstat(characters[0],"will") + gCstat(characters[0],"luck");
			var dice200 = limitedRandomInt(200);
			var difficulty = 115;
			var act0 = createActionMovingWildTunnel("wildTunnel17","Section 17",0,2);
			if ( (baseChance + dice200) >= difficulty ) {
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 17: " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ") " + hoverText("(?)","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") => Difficulty (" + difficulty + ")");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 17: " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") < Difficulty (" + difficulty + ")");
				}
			}
			actions.push(act0);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel13 = new RoomInfo(
	"wildTunnel13", // Key
	"Wild Tunnels ~ Tunnel 13", // Title
	"GleCav/caverns-semi-flooded-path-r.png", // Med Icon
	"GleCav/caverns-semi-flooded-path-r-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [  ];
			var dice100 = limitedRandomInt(100);
			// Path to Tunnels 14 / 17
			var act0 = createActionMovingWildTunnel("wildTunnel14","Section 14",0,2);
			var act1 = createActionMovingWildTunnel("wildTunnel17","Section 17",0,2)
			if ( dice100 < 50 ) {
				act1.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("The river current allows access to Section 14: Dice 100 (" + dice100 + ") < 50, access to Section 17 is blocked.");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("The river current allows access to Section 17: Dice 100 (" + dice100 + ") >= 50, access to Section 14 is blocked.");
				}
			}
			actions.push(act0);
			actions.push(act1);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel14 = new RoomInfo(
	"wildTunnel14", // Key
	"Wild Tunnels ~ Tunnel 14", // Title
	"GleCav/caverns-wild-path.png", // Med Icon
	"GleCav/caverns-wild-path-sm.png", // Icon
	"Gentle stairs of naturally formed slabs give you access to wildly different directions through the Caverns.", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel11","Section 11",0,2),
						createActionMovingWildTunnel("wildTunnel15","Section 15",0,2),
						createActionMovingWildTunnel("wildTunnel18","Section 18",5,2) ];
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel15 = new RoomInfo(
	"wildTunnel15", // Key
	"Wild Tunnels ~ Tunnel 15", // Title
	"GleCav/caverns-semi-flooded-path.png", // Med Icon
	"GleCav/caverns-semi-flooded-path-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel16","Section 16",0,2),
						createActionMovingWildTunnel("wildTunnel19","Section 19",5,2) ];
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel16 = new RoomInfo(
	"wildTunnel16", // Key
	"Wild Tunnels ~ Tunnel 16", // Title
	"GleCav/caverns-semi-flooded-path-r.png", // Med Icon
	"GleCav/caverns-semi-flooded-path-r-sm.png", // Icon
	"Up above the river there's a tunnel fairly hard to reach. An agile enough person could make the climb if the river was high enough.", // Description
	[], // Connections
	function(characters) {
		var actions = [ createWaitingActionCaverns(),
						createActionMovingWildTunnel("wildTunnel4","Section 4",0,2),
						createActionMovingWildTunnel("wildTunnel23","Section 23",5,2) ];
			// Path to Pond of Illumination
			var baseChance = gCstat(characters[0],"perception") + gCstat(characters[0],"agility") + gCstat(characters[0],"resilience") + gCstat(characters[0],"will") + gCstat(characters[0],"luck");
			var dice200 = limitedRandomInt(200);
			var difficulty = 220;
			var act0 = createActionMovingWildTunnel("pondIllumination","Tight tunnel",0,2);
			if ( (baseChance + dice200) >= difficulty ) {
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to tight tunnel: " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ") " + hoverText("(?)","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") => Difficulty (" + difficulty + ")");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to tight tunnel: " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") < Difficulty (" + difficulty + ")");
				}
			}
			actions.push(act0);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel17 = new RoomInfo(
	"wildTunnel17", // Key
	"Wild Tunnels ~ Tunnel 17", // Title
	"GleCav/caverns-wild-path-r.png", // Med Icon
	"GleCav/caverns-wild-path-r-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel18","Section 18",0,2),
						createActionMovingWildTunnel("wildTunnel20","Section 20",0,2) ];
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel18 = new RoomInfo(
	"wildTunnel18", // Key
	"Wild Tunnels ~ Tunnel 18", // Title
	"GleCav/caverns-wild-path-r.png", // Med Icon
	"GleCav/caverns-wild-path-r-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel19","Section 19",0,2),
						createActionMovingWildTunnel("wildTunnel21","Section 21",0,2) ];
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel19 = new RoomInfo(
	"wildTunnel19", // Key
	"Wild Tunnels ~ Tunnel 19", // Title
	"GleCav/caverns-flooded-path.png", // Med Icon
	"GleCav/caverns-flooded-path-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel21","Section 21",0,2) ];
			// Path to Tunnels 22 / 23
			var dice100 = limitedRandomInt(100);
			var act0 = createActionMovingWildTunnel("wildTunnel22","Section 22",5,2);
			var act1 = createActionMovingWildTunnel("wildTunnel23","Section 23",5,2);
			if ( dice100 < 50 ) {
				act1.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("The river current allows access to Section 22: Dice 100 (" + dice100 + ") < 50, access to Section 23 is blocked.");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("The river current allows access to Section 23: Dice 100 (" + dice100 + ") >= 50, access to Section 22 is blocked.");
				}
			}
			actions.push(act0);
			actions.push(act1);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel20 = new RoomInfo(
	"wildTunnel20", // Key
	"Wild Tunnels ~ Tunnel 20", // Title
	"GleCav/caverns-semi-flooded-path-r.png", // Med Icon
	"GleCav/caverns-semi-flooded-path-r-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel1","Section 1",0,2) ];
			// Path to Tunnel 21
			var baseChance = gCstat(characters[0],"perception") + gCstat(characters[0],"agility") + gCstat(characters[0],"resilience") + gCstat(characters[0],"will") + gCstat(characters[0],"luck");
			var dice200 = limitedRandomInt(200);
			var difficulty = 135;
			var act0 = createActionMovingWildTunnel("wildTunnel21","Section 21",0,2);
			if ( (baseChance + dice200) >= difficulty ) {
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 21: " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ") " + hoverText("(?)","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") => Difficulty (" + difficulty + ")");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 21: " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") < Difficulty (" + difficulty + ")");
				}
			}
			actions.push(act0);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel21 = new RoomInfo(
	"wildTunnel21", // Key
	"Wild Tunnels ~ Tunnel 21", // Title
	"GleCav/caverns-semi-flooded-path.png", // Med Icon
	"GleCav/caverns-semi-flooded-path-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createWaitingActionCaverns(),
						createActionMovingWildTunnel("wildTunnel3","Section 3",0,2) ];
			// Path to Tunnel 22
			var baseChance = gCstat(characters[0],"perception") + gCstat(characters[0],"agility") + gCstat(characters[0],"resilience") + gCstat(characters[0],"will") + gCstat(characters[0],"luck");
			var dice200 = limitedRandomInt(200);
			var difficulty = 185;
			var act0 = createActionMovingWildTunnel("wildTunnel22","Section 22",0,2);
			if ( (baseChance + dice200) >= difficulty ) {
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 22: " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ") " + hoverText("(?)","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") => Difficulty (" + difficulty + ")");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Section 22: " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility + Resilience + Will + Perception + Luck") + " + Dice 200 (" + dice200 + ") < Difficulty (" + difficulty + ")");
				}
			}
			actions.push(act0);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel22 = new RoomInfo(
	"wildTunnel22", // Key
	"Wild Tunnels ~ Tunnel 22", // Title
	"GleCav/caverns-flooded-path-r.png", // Med Icon
	"GleCav/caverns-flooded-path-r-sm.png", // Icon
	"The water becomes denser, heavier, and unbearable. Reaching the deepest corners of the Caverns will require skill, discipline and patience.", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel1","Section 1",0,2),
						createActionMovingWildTunnel("wildTunnel23","Section 23",5,2) ];
			// Path to Tortuous End
			var baseChance = gCstat(characters[0],"perception") + gCstat(characters[0],"agility") + gCstat(characters[0],"resilience") + gCstat(characters[0],"will") + gCstat(characters[0],"luck");
			var dice1000 = limitedRandomInt(1000);
			var difficulty = 1060;
			var act0 = createActionMovingWildTunnel("tortuousEnd","Unreachable Tunnel",0,2);
			if ( (baseChance + dice1000) >= difficulty ) {
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Unreachable Tunnel: " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ") " + hoverText("(?)","Agility + Resilience + Will + Perception + Luck") + " + Dice 1000 (" + dice1000 + ") => Difficulty (" + difficulty + ")");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Unreachable Tunnel: " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility + Resilience + Will + Perception + Luck") + " + Dice 1000 (" + dice1000 + ") < Difficulty (" + difficulty + ")");
				}
			}
			actions.push(act0);
		return actions;
	}, // getActions
	[166,32]
);
setup.mapGleamingCaverns.wildTunnel23 = new RoomInfo(
	"wildTunnel23", // Key
	"Wild Tunnels ~ Tunnel 23", // Title
	"GleCav/caverns-flooded-path-ext.png", // Med Icon
	"GleCav/caverns-flooded-path-ext-sm.png", // Icon
	"The water becomes denser, heavier, and unbearable. Reaching the deepest corners of the Caverns will require skill, discipline and patience.", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel22","Section 22",5,2) ];
			// Path to Tortuous End
			var baseChance = gCstat(characters[0],"perception") + gCstat(characters[0],"agility") + gCstat(characters[0],"resilience") + gCstat(characters[0],"will") + gCstat(characters[0],"luck");
			var dice1000 = limitedRandomInt(1000);
			var difficulty = 1060;
			var act0 = createActionMovingWildTunnel("tortuousEnd","Unreachable Tunnel",0,2);
			if ( (baseChance + dice1000) >= difficulty ) {
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Unreachable Tunnel: " + colorText("Check PASSED","green") + ": Stats (" + baseChance + ") " + hoverText("(?)","Agility + Resilience + Will + Perception + Luck") + " + Dice 1000 (" + dice1000 + ") => Difficulty (" + difficulty + ")");
				}
			} else {
				act0.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("Access to Unreachable Tunnel: " + colorText("Check FAILED","red") + ": Stats (" + baseChance + ")" + hoverText("^^(?)^^","Agility + Resilience + Will + Perception + Luck") + " + Dice 1000 (" + dice1000 + ") < Difficulty (" + difficulty + ")");
				}
			}
			actions.push(act0);
			// Path to Tunnels 2 / 7
			var act1 = createActionMovingWildTunnel("wildTunnel2","Section 2",0,2);
			var act2 = createActionMovingWildTunnel("wildTunnel7","Section 7",0,2);
			var dice100 = limitedRandomInt(100);
			if ( dice100 < 50 ) {
				act2.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("The river current allows access to Section 2: Dice 100 (" + dice100 + ") < 50, access to Section 7 is blocked.");
				}
			} else {
				act1.requirements = function(cG) { return false; }
				if ( characters[0] == "chPlayerCharacter" ) {
					State.variables.compass.setMapActionsMessage("The river current allows access to Section 7: Dice 100 (" + dice100 + ") >= 50, access to Section 2 is blocked.");
				}
			}
			actions.push(act1,act2);
		return actions;
	}, // getActions
	[166,32]
);

setup.mapGleamingCaverns.pondIllumination = new RoomInfo(
	"pondIllumination", // Key
	"Wild Tunnels ~ Pond of Illumination", // Title
	"GleCav/caverns-semi-flooded-path.png", // Med Icon
	"GleCav/caverns-semi-flooded-path-sm.png", // Icon
	"A spheric room appears before you after you fall through the tunnel. A fine line of water falls from the exact center of the ceiling, emitting a constant stream of white noise as it crashes against a small pond that forms an almost perfect circle. Outside this small refuge, the rest of the world might as well no longer exist.", // Description
	[ new RoomConnection('labyrinthEntrance',10) ], // Connections
	function(characters) {
		var actions = [ createTrainingActionSecludedMeditation(),
						createRestingActionStandard() ];
		return actions;
	}, // getActions
	[170,53]
);
setup.mapGleamingCaverns.mountainsExit = new RoomInfo(
	"mountainsExit", // Key
	"Wild Tunnels ~ Exit to Mountains", // Title
	"GleCav/cavern-entrance-rev.png", // Med Icon
	"GleCav/cavern-entrance-rev-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel2","Section 2",0,10) ];
		return actions;
	}, // getActions
	[246,4]
);
setup.mapGleamingCaverns.tortuousEnd = new RoomInfo(
	"tortuousEnd", // Key
	"Wild Tunnels ~ Tortuous End", // Title
	"GleCav/caverns-flooded-path-r-ext.png", // Med Icon
	"GleCav/caverns-flooded-path-r-ext-sm.png", // Icon
	"", // Description
	[], // Connections
	function(characters) {
		var actions = [ createActionMovingWildTunnel("wildTunnel22","Section 22",0,2),
						createActionMovingWildTunnel("wildTunnel23","Section 23",0,2) ];
		return actions;
	}, // getActions
	[258,45]
);


// Functions

window.initMapGleamingCaverns = function() {
	State.variables.mapGleamingCaverns = new Chart("mapGleamingCaverns","Gleaming Caverns");
	State.variables.mapGleamingCaverns.diagramDimensions = [301,209];
	State.variables.mapGleamingCaverns.icon = "marsh-map.png";
	State.variables.mapGleamingCaverns.subarea = "marsh";

	State.variables.mapGleamingCaverns.autogenerateRooms("mapGleamingCaverns");
}
window.setSubareaMarsh = function() {
	State.variables.mapGleamingCaverns.diagramDimensions = [301,209];
	State.variables.mapGleamingCaverns.icon = "marsh-map.png";
	State.variables.mapGleamingCaverns.subarea = "marsh";
}
window.setSubareaCaverns = function() {
	State.variables.mapGleamingCaverns.diagramDimensions = [301,233];
	State.variables.mapGleamingCaverns.icon = "gleaming-caverns-map.png";
	State.variables.mapGleamingCaverns.subarea = "gleaming-caverns";
}
window.deinitMapGleamingCaverns = function() {
	delete State.variables.mapGleamingCaverns;
}

setup.mapGleamingCaverns.marshSP1.setSubarea = setSubareaMarsh;
setup.mapGleamingCaverns.marshCentrance.setSubarea = setSubareaCaverns;
// [228,170] , [256,174]
setup.mapGleamingCaverns.marshSP1.getSpecialAreaCoordinates = function() {
	var coords = "";
	if ( State.variables.mapGleamingCaverns.subarea == "gleaming-caverns" ) {
		coords = "6,7,26,27";
	} else {
		coords = "" + this.mapPos[0] + ',' + this.mapPos[1] + ',' + (this.mapPos[0]+20) + ',' + (this.mapPos[1]+20);
	}
	return coords;
}
setup.mapGleamingCaverns.marshCentrance.getSpecialAreaCoordinates = function() {
	var coords = "";
	if ( State.variables.mapGleamingCaverns.subarea == "gleaming-caverns" ) {
		coords = "" + this.mapPos[0] + ',' + this.mapPos[1] + ',' + (this.mapPos[0]+20) + ',' + (this.mapPos[1]+20);
	} else {
		coords = "256,174,276,194";
	}
	return coords;
}

///// Adventure scripts /////

	// Init First Adventure
window.initializeGleamingCavernsAdventure = function() {
	// Cleaning
	cleanFirstLoopLeftoverData();
	
	// Init config
	finishAllRelationships();
	takeOffAllBondage();
	
	State.variables.daycycle.day += 2;
	// Story state
	State.variables.storyState = storyState.firstAdventure;
	// Patch in holy affinity
	if ( gC("chPlayerCharacter").combatAffinities.holy != undefined ) {
		for ( var cK of getActiveSimulationCharactersArray() ) {
			gC(cK).combatAffinities.holy = new flavorAffinity("holy");
		}
	}
	// Initialize tribes & Shapeshifter tribe
	State.variables.tribes = new pseudoList();
		// Shapeshifters respect
	State.variables.tribes.ssRpt = -300;
	for ( var cK of getCandidatesKeysArray() ) {
		gC(cK).ssRsp = 0; // Individual respect
	}
	gC("chVal").ssRsp = -500; // Valtan respect
	// Holy blast
	charactersLearnSceneActions(getCandidatesKeysArray(),["holyBlast"]);
	// Initialize secondary characters
		// Artume
	State.variables.chArt = createArtume();
	var artWeaID = createEquipment(equipmentType.HUNTINGBOW,"chArt");
	equipObjectOnWearer(artWeaID,"chArt",-1);
		// Hope
	State.variables.chHope = createWarmestHope();
	var hopeWeaID = createEquipment(equipmentType.WAND,"chHope");
	equipObjectOnWearer(hopeWeaID,"chHope",-1);
		// Rock
	State.variables.chRock = createSturdiestRock();
	var rockWeaID = createEquipment(equipmentType.STAFFOFBATTLE,"chRock");
	equipObjectOnWearer(rockWeaID,"chRock",-1);
		// Sillan
	State.variables.chSil = createSillan();
	recalculateMaxBars("chSil");
	charactersLearnSceneActions(["chSil"],returnFirstScrollGroupActionsList());
		// Nersmias
	State.variables.chNer = createNersmias();
	var nerWeaID = createEquipment(equipmentType.WAND,"chNer");
	equipObjectOnWearer(nerWeaID,"chNer",-1);
	recalculateMaxBars("chNer");
	charactersLearnSceneActions(["chNer"],returnFirstScrollGroupActionsList());
		// Mesquelles
	State.variables.chMes = createMesquelles();
	var mesWeaID = createEquipment(equipmentType.HANDFAN,"chMes");
	equipObjectOnWearer(mesWeaID,"chMes",-1);
	recalculateMaxBars("chMes");
	charactersLearnSceneActions(["chMes"],returnFirstScrollGroupActionsList());
	
	State.variables.activeSimulationCharacters.push("chArt","chHope","chRock","chSil","chNer","chMes");
		// Adjust stats
	for ( var cK of ["chArt","chHope","chRock"] ) {
		for ( var st of getStatNamesArray() ) {
			gC(cK)[st].value += 3;
		}
	}
	recalculateMaxBars("chArt");
	recalculateMaxBars("chHope");
	recalculateMaxBars("chRock");
	recalculateMaxBars("chSil");
	recalculateMaxBars("chNer");
	recalculateMaxBars("chMes");
		// Actions
	charactersLearnSceneActions(["chArt","chHope","chRock","chSil","chNer","chMes"],returnFirstScrollGroupActionsList());
	
	// Relationships
	initRelationshipDataAmongAllActiveCharacters();
		// Gaanidans
	getRelation("chPlayerCharacter","chArt").friendship.ltv = 850;
	getRelation("chArt","chPlayerCharacter").friendship.ltv = 750;
	getRelation("chMir","chArt").friendship.ltv = 25;
	getRelation("chArt","chMir").friendship.ltv = 25;
		// Beastkins
	getRelation("chClaw","chHope").friendship.ltv = 650;
	getRelation("chClaw","chHope").enmity.ltv = 300;
	getRelation("chClaw","chHope").rivalry.ltv = 800;
	getRelation("chHope","chClaw").friendship.ltv = 550;
	getRelation("chHope","chClaw").enmity.ltv = 700;
	getRelation("chHope","chClaw").rivalry.ltv = 700;
	getRelation("chClaw","chRock").friendship.ltv = 500;
	getRelation("chClaw","chRock").enmity.ltv = 100;
	getRelation("chRock","chClaw").friendship.ltv = 650;
	getRelation("chRock","chClaw").enmity.ltv = 150;
	
	getRelation("chHope","chRock").friendship.stv = 600;
	getRelation("chHope","chRock").friendship.ltv = 900;
	getRelation("chHope","chRock").romance.stv = 300;
	getRelation("chHope","chRock").romance.ltv = 450;
	getRelation("chHope","chRock").sexualTension.stv = 200;
	getRelation("chHope","chRock").sexualTension.ltv = 150;
	getRelation("chHope","chRock").domination.stv = 300;
	getRelation("chHope","chRock").domination.ltv = 300;
	getRelation("chRock","chHope").friendship.stv = 600;
	getRelation("chRock","chHope").friendship.ltv = 900;
	getRelation("chRock","chHope").romance.stv = 400;
	getRelation("chRock","chHope").romance.ltv = 550;
	getRelation("chRock","chHope").sexualTension.stv = 250;
	getRelation("chRock","chHope").sexualTension.ltv = 200;
	getRelation("chRock","chHope").submission.stv = 400;
	getRelation("chRock","chHope").submission.ltv = 400;
	
	// Gleaming Caverns relationships
	initRelsValtanSillan();
	initRelsValtanNersmias();
	initRelsValtanMesquelles();
	initRelsSillanNersmias();
	initRelsSillanMesquelles();
	initRelsNersmiasMesquelles();
	
	// Maps
	deinitMapTrainingGrounds();
	initMapGleamingCaverns();
	
	// UI
	setPasChars([]);
	setRoomIntro("mapGleamingCaverns","marshLP5");
}

window.checkForGleamingCavernsUpdates = function() {
	State.variables.mapGleamingCaverns.autogenerateRooms("mapGleamingCaverns");
	
	if ( gC("chSil") == undefined ) {
		State.variables.chSil = createSillan();
		recalculateMaxBars("chSil");
		charactersLearnSceneActions(["chSil"],returnFirstScrollGroupActionsList());
		State.variables.activeSimulationCharacters.push("chSil");
	}
	if ( gC("chNer") == undefined ) {
		State.variables.chNer = createNersmias();
		var nerWeaID = createEquipment(equipmentType.WAND,"chNer");
		equipObjectOnWearer(nerWeaID,"chNer",-1);
		recalculateMaxBars("chNer");
		charactersLearnSceneActions(["chNer"],returnFirstScrollGroupActionsList());
		State.variables.activeSimulationCharacters.push("chNer");
	}
	if ( gC("chMes") == undefined ) {
		State.variables.chMes = createMesquelles();
		var mesWeaID = createEquipment(equipmentType.HANDFAN,"chMes");
		equipObjectOnWearer(mesWeaID,"chMes",-1);
		recalculateMaxBars("chMes");
		charactersLearnSceneActions(["chMes"],returnFirstScrollGroupActionsList());
		State.variables.activeSimulationCharacters.push("chMes");
	}
	initRelationshipDataAmongAllActiveCharacters();
	
	for ( var cK of ["chPlayerCharacter","chNash","chMir","chVal","chClaw","chAte","chArt","chHope","chRock","chSil","chNer","chMes"] ) {
		gC(cK).refugeRooms.push(["mapGleamingCaverns","unionLakeWest"]);
	}
	
	// Gleaming Caverns relationships
	initRelsValtanSillan();
	initRelsValtanNersmias();
	initRelsValtanMesquelles();
	initRelsSillanNersmias();
	initRelsSillanMesquelles();
	initRelsNersmiasMesquelles();
}

window.cleanFirstLoopLeftoverData = function() {
	if ( State.variables.StVars.temp != undefined ) {
		delete State.variables.StVars.temp;
	}
	if ( State.variables.StVars.temp2 != undefined ) {
		delete State.variables.StVars.temp2;
	}
	if ( State.variables.StVars.seMagicClassClawCheck != undefined ) {
		delete State.variables.StVars.seMagicClassClawCheck;
	}
	if ( State.variables.StVars.futaNash != undefined ) {
		delete State.variables.StVars.futaNash;
	}
	if ( State.variables.StVars.seshFlirty != undefined ) {
		delete State.variables.StVars.seshFlirty;
	}
	if ( State.variables.StVars.StretchingHelpResult != undefined ) {
		delete State.variables.StVars.StretchingHelpResult;
	}
	if ( State.variables.StVars.StretchingHelpGroped != undefined ) {
		delete State.variables.StVars.StretchingHelpGroped;
	}
	if ( State.variables.StVars.seHummingCopyCheck != undefined ) {
		delete State.variables.StVars.seHummingCopyCheck;
	}
	if ( State.variables.StVars.seHummingCopyCheck != undefined ) {
		delete State.variables.StVars.seHummingCopyCheck;
	}
	if ( State.variables.StVars.seHummingHarmonyCheck != undefined ) {
		delete State.variables.StVars.seHummingHarmonyCheck;
	}
	if ( State.variables.StVars.seHummingImproviseCheck != undefined ) {
		delete State.variables.StVars.seHummingImproviseCheck;
	}
	if ( State.variables.StVars.temp2 != undefined ) {
		delete State.variables.StVars.temp2;
	}
	if ( State.variables.StVars.seEthicsOfPowMUcheck != undefined ) { delete State.variables.StVars.seEthicsOfPowMUcheck; }
	if ( State.variables.StVars.SeFbahHowsSill != undefined ) { delete State.variables.StVars.SeFbahHowsSill; }
	if ( State.variables.StVars.SeFbahWhatsSill != undefined ) { delete State.variables.StVars.SeFbahWhatsSill; }
	if ( State.variables.StVars.SeFbahWhyTakePlaceSill != undefined ) { delete State.variables.StVars.SeFbahWhyTakePlaceSill; }
	if ( State.variables.StVars.SeFbahRegretSill != undefined ) { delete State.variables.StVars.SeFbahRegretSill; }
	if ( State.variables.StVars.SeFbahAnyQuestions != undefined ) { delete State.variables.StVars.SeFbahAnyQuestions; }
	if ( State.variables.StVars.seStHeIINashInvites != undefined ) { delete State.variables.StVars.seStHeIINashInvites; }
	if ( State.variables.StVars.seStHeIIMayRejectSex != undefined ) { delete State.variables.StVars.seStHeIIMayRejectSex; }
	if ( State.variables.StVars.seStHeIIwillpowerHit != undefined ) { delete State.variables.StVars.seStHeIIwillpowerHit; }
	if ( State.variables.StVars.flirtingAdviceChecks != undefined ) { delete State.variables.StVars.flirtingAdviceChecks; }
	if ( State.variables.StVars.DrishtyaTutorLifeAsCandidate != undefined ) { delete State.variables.StVars.DrishtyaTutorLifeAsCandidate; }
	if ( State.variables.StVars.DrishtyaTutorThoughtsOnPeers != undefined ) { delete State.variables.StVars.DrishtyaTutorThoughtsOnPeers; }
	if ( State.variables.StVars.DrishtyaTutorReachedQuestions != undefined ) { delete State.variables.StVars.DrishtyaTutorReachedQuestions; }
	if ( State.variables.StVars.DrishtyaTutorBehindTheRest != undefined ) { delete State.variables.StVars.DrishtyaTutorBehindTheRest; }
	if ( State.variables.StVars.DrishtyaTutorStrengthenBonds != undefined ) { delete State.variables.StVars.DrishtyaTutorStrengthenBonds; }
	if ( State.variables.StVars.DrishtyaTutorDominatingOthers != undefined ) { delete State.variables.StVars.DrishtyaTutorDominatingOthers; }
	if ( State.variables.StVars.DrishtyaTutorLeaveTheTemple != undefined ) { delete State.variables.StVars.DrishtyaTutorLeaveTheTemple; }
	if ( State.variables.StVars.DrishtyaTutorEmpathyCheck != undefined ) { delete State.variables.StVars.DrishtyaTutorEmpathyCheck; }
	if ( State.variables.StVars.VaryonteTutorHasDick != undefined ) { delete State.variables.StVars.VaryonteTutorHasDick; }
	if ( State.variables.StVars.check2 != undefined ) { delete State.variables.StVars.check2; }
	if ( State.variables.StVars.check3 != undefined ) { delete State.variables.StVars.check3; }
	if ( State.variables.StVars.check4 != undefined ) { delete State.variables.StVars.check4; }
	if ( State.variables.StVars.check10 != undefined ) { delete State.variables.StVars.check10; }
	if ( State.variables.StVars.check1 != undefined ) { delete State.variables.StVars.check1; }
	if ( State.variables.StVars.check5 != undefined ) { delete State.variables.StVars.check5; }
	if ( State.variables.StVars.check6 != undefined ) { delete State.variables.StVars.check6; }
	if ( State.variables.StVars.check7 != undefined ) { delete State.variables.StVars.check7; }
	if ( State.variables.StVars.check8 != undefined ) { delete State.variables.StVars.check8; }
	if ( State.variables.StVars.check9 != undefined ) { delete State.variables.StVars.check9; }
	if ( State.variables.StVars.playerJoinedBkifBattle != undefined ) { delete State.variables.StVars.playerJoinedBkifBattle; }
	if ( State.variables.StVars.drishtyaSawVaryonteMoves != undefined ) { delete State.variables.StVars.drishtyaSawVaryonteMoves; }
	if ( State.variables.StVars.BkifNashRelScore != undefined ) { delete State.variables.StVars.BkifNashRelScore; }
	if ( State.variables.StVars.BkifStakes != undefined ) { delete State.variables.StVars.BkifStakes; }
	if ( State.variables.StVars.clawLostBkif != undefined ) { delete State.variables.StVars.clawLostBkif; }
}

window.finishGleamingCavernsAdventure = function() {
	// Story state
	State.variables.storyState = storyState.secondLoop;
	State.variables.daycycle.day += 2;
	
	// Finish stat affinity specialization
	for ( var cK of getCandidatesKeysArray() ) {
		for ( var at of setup.baseStats ) {
			gC(cK)[at].affinity += 0.1;
		}
		gC(cK).charisma.affinity -= 0.50;
		gC(cK).empathy.affinity -= 0.40;
	}
	
	// Finish Hypnotic Resistance status effect
	gC("chPlayerCharacter").removeSpecificState("HyRe");
	
	// Chance for Nashillbyir to get a dildo - If the dildoPlay map story event took place.
	if ( isStVarOn("dldPly") ) {
		if ( getCharsSpecialExperience("chNash","crfExp") >= 5 ) {
			if ( (limitedRandomInt(100) + getCharsSpecialExperience("chNash","crfExp") * 10) >= 100 ) {
				createEquipment("w5","chNash");
			}
		}
	}
	
	// Maps
	deinitMapGleamingCaverns();
	initMapTrainingGrounds();
	
	State.variables.settings.followingAllowed = true;
	State.variables.settings.relationshipTypesAllowed = true;
	State.variables.settings.challengingAllowed = true;
	State.variables.settings.assaultingAllowed = true;
	State.variables.settings.talkingAllowed = true;
	
	// Remove FA-specific story variables
	removeFromStVarsList("blmClaw");
	removeFromStVarsList("dldCrf");
	removeFromStVarsList("dldPly");
	removeFromStVarsList("mphInit");
	removeFromStVarsList("hddHut");
	
	if ( State.variables.morphMerit != undefined ) {
		delete State.variables.morphMerit;
	}
	
	
	// Cleaning
	cleanFirstLoopLeftoverData();
}

	// Battle scenes
window.ccsFAplayerAteFightOneSucker = function() {
	var mon = createEssenceSucker(1,0,1);
	State.variables.sc.startScene(
	"bs","fixed",["chPlayerCharacter","chAte"],[mon],"__Swamp ~ Western Path Lake__\nCountless dragonflies roam the shores of the lake in their quest for food, and the flapping of their wings adds ambience music to the scenery.",createEndConditionStoryBattleWithDraw("FA BeatenSucker 1","FA SuckerVictory 1","FA BeatenSucker 1"),6,
	"FA BeatenSucker 1");
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).aiAlgorythm = createAiEarlyStrategic();
		}
	}
	State.variables.sc.formatScenePassage();
	setRefreshSomeLustBattleScript();
}

window.ccsFAplayerAteFightTwoSuckers = function() {
	var mon = createEssenceSucker(1,0,1);
	var mon2 = createEssenceSucker(1,0,2);
	State.variables.sc.startScene(
	"bs","fixed",["chPlayerCharacter","chAte"],[mon,mon2],"__Swamp ~ Western Path Lake__\nCountless dragonflies roam the shores of the lake in their quest for food, and the flapping of their wings adds ambience music to the scenery.",createEndConditionStoryBattleWithDraw("FA BeatenSucker 2","FA BeatenSucker 2","FA BeatenSucker 2"),6,
	"FA BeatenSucker 2");
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).aiAlgorythm = createAiEarlyStrategic();
		}
	}
	
	State.variables.sc.customScript = function(turns) {
		if ( State.variables.sc.currentTurn == 3 ) {
			State.variables.sc.endRoundEffects.push(function() {
					// Effects
					var damage1 = addLuckFactor(102,0.1,75);
					var damage2 = addLuckFactor(102,0.1,75);
					applyBarDamage("mon0","lust",-damage1);
					applyBarDamage("mon1","lust",-damage2);
					var dmgEffMsg = getWeaknessToAttackText(["holy"],"mon0");
				
					// Msg
				var msg = colorText("Drishtya","mediumvioletred") + " launched blasts of holy light against " + ktn("mon0") + " and " + ktn("mon1") + ", burning them in divine retribution. " + dmgEffMsg + ktn("mon0") + " received " + textLustDamage(damage1) + ", and " + ktn("mon1") + " received " + textLustDamage(damage2) + ".";
				return msg;
			});
		}
	}
	State.variables.sc.formatScenePassage();
	setRefreshSomeLustBattleScript();
}

window.ccsFAplayerFightsFlyingLookout = function() {
	var mon = createFlyingLookout(2,3,1);
	State.variables.sc.startScene(
	"bs","fixed",["chPlayerCharacter"],[mon],"__Swamp ~ Western River 2__\nClose to the confines of the swamp, a surge of vegetation hinders movement along the shore of the river.",endConditionTurns,5,
	"FA EntersArtume");
	for ( var charKey of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( charKey != "chPlayerCharacter" ) {
			gC(charKey).aiAlgorythm = createAiEarlyStrategic();
		}
	}
	
	State.variables.sc.customScript = function(turns) {
		if ( State.variables.sc.currentTurn == 5 ) {
			State.variables.sc.endRoundEffects.push(function() {
					// Effects
					var damage1 = addLuckFactor(15,0.1,15);
					applyBarDamage("mon0","lust",-damage1);
					var dmgEffMsg = getWeaknessToAttackText(["physical","weapon"],"mon0");
				
					// Msg
				var msg = "A wild arrow flies out of nowhere, hitting the " + ktn("mon0") + " right on its center. It shrieks in pain and moves away. " + dmgEffMsg + ktn("mon0") + " received " + textLustDamage(damage1) + ".";
				return msg;
			});
		}
	}
	gC("chPlayerCharacter").control = 2;
	State.variables.sc.formatScenePassage();
	setRefreshSomeLustBattleScript();
}

window.ccsFAhopeAttacksClaw = function() {
	State.variables.sc.startScene(
	"bs","fixed",["chClaw"],["chHope"],"__Swamp ~ Central Path 2__\nThe silenced is being disturbed.",endConditionTurns,3,
	"FA AnotherAmbush3");
		State.variables.chClaw.aiAlgorythm = createAiFixedAction();
		State.variables.chClaw.aiAlgorythm.fixedAction = "baScratch";
		State.variables.chClaw.aiAlgorythm.fixedTarget = "chHope";
		State.variables.chHope.aiAlgorythm = createAiFixedAction();
		State.variables.chHope.aiAlgorythm.fixedAction = "embers";
		State.variables.chHope.aiAlgorythm.fixedTarget = "chClaw";
		
	State.variables.sc.customScript = ccsFAhopeAttacksClawScript;
	
	State.variables.sc.formatScenePassage();
}
window.ccsFAhopeAttacksClawScript = function() {
	switch (State.variables.sc.currentTurn) {
		case 2:
			State.variables.chHope.aiAlgorythm.fixedAction = "flaringFeint";
			State.variables.chClaw.aiAlgorythm.fixedAction = "baScratch";
	State.variables.sc.headingDescription = `<span @style=$chHope.colorStyleKey>//"You are going to regret your treason! Start praying to the Goddess!"//</span>`;
			break;
		case 3:
			State.variables.chHope.aiAlgorythm.fixedAction = "flamingFan";
			State.variables.chClaw.aiAlgorythm.fixedAction = "baScratch";
			State.variables.sc.headingDescription = `<span @style=$chClaw.colorStyleKey>//"I don't know what your problem is, but I'm going to claw it out of you."//</span>`;
			break;
		case 4:
			State.variables.chHope.aiAlgorythm.fixedAction = "flamingFan";
			State.variables.chClaw.aiAlgorythm.fixedAction = "baScratch";
			State.variables.sc.headingDescription = `<span @style=$chHope.colorStyleKey>//"If you still don't know what's my problem, the more reason I have to do this."//</span>`;
			break;
	}
}

window.ccsFArockInYourWay = function() {
	State.variables.sc.startScene(
	"bs","fixed",["chPlayerCharacter","chNash"],["chRock"],"__Swamp ~ Central Path 2__\nYou can see flames flying further beyond.",endConditionTurns,4,
	"FA CeasedFire");
		State.variables.chNash.aiAlgorythm = createAiFixedAction();
		State.variables.chNash.aiAlgorythm.fixedAction = "coldGuts";
		State.variables.chNash.aiAlgorythm.fixedTarget = "chRock";
		State.variables.chRock.aiAlgorythm = createAiFixedAction();
		State.variables.chRock.aiAlgorythm.fixedAction = "quake";
		State.variables.chRock.aiAlgorythm.fixedTarget = "chNash";
		
	State.variables.sc.customScript = ccsFArockInYourWayScript;
	
	State.variables.sc.formatScenePassage();
}
window.ccsFArockInYourWayScript = function() {
	switch (State.variables.sc.currentTurn) {
		case 2:
			State.variables.chNash.aiAlgorythm.fixedAction = "kick";
			State.variables.chRock.aiAlgorythm.fixedAction = "earthWall";
	State.variables.sc.headingDescription = `<span @style=$chPlayerCharacter.colorStyleKey>//"Who are you, and why are you attacking us!?"//</span>`;
			break;
		case 3:
			State.variables.chNash.aiAlgorythm.fixedAction = "freezeFeet";
			State.variables.chRock.aiAlgorythm.fixedAction = "staffSwipe";
		State.variables.chRock.aiAlgorythm.fixedTarget = "chPlayerCharacter";
			State.variables.sc.headingDescription = `<span @style=$chNash.colorStyleKey>//"Damn you, that hurt!"//</span>\n<span @style=$chRock.colorStyleKey>//"We are the exilees of the Beastkin tribe, and that one over there is Warmest Hope, our true Candidate!"//</span>`;
			break;
		case 4:
			State.variables.chNash.aiAlgorythm.fixedAction = "kick";
			State.variables.chRock.aiAlgorythm.fixedAction = "quake";
			State.variables.sc.headingDescription = `<span @style=$chPlayerCharacter.colorStyleKey>//"The exilees? Your true Candidate? What do you mean?"//</span>`;
			break;
		case 5:
			State.variables.chNash.aiAlgorythm.fixedAction = "kick";
			State.variables.chRock.aiAlgorythm.fixedAction = "quake";
			State.variables.sc.headingDescription = `<span @style=$chRock.colorStyleKey>//"If you truly don't know, it'll be best for you to stop fighting."//</span>`;
			break;
	}
}

// Init relationships // Fr Ro Se Do Su Ri En
window.initRelsValtanSillan = function() {
	getRelation("chVal","chSil").friendship.ltv = 1800;
	getRelation("chVal","chSil").romance.ltv = 1600;
	getRelation("chVal","chSil").sexualTension.ltv = 800;
	getRelation("chVal","chSil").domination.ltv = 400;
	getRelation("chVal","chSil").submission.ltv = 100;
	getRelation("chSil","chVal").friendship.ltv = 1800;
	getRelation("chSil","chVal").romance.ltv = 1800;
	getRelation("chSil","chVal").sexualTension.ltv = 600;
	getRelation("chSil","chVal").domination.ltv = 0;
	getRelation("chSil","chVal").submission.ltv = 200;
	getRelation("chSil","chVal").enmity.stv = 3000;
}
window.initRelsValtanNersmias = function() {
	getRelation("chVal","chNer").friendship.ltv = 50;
	getRelation("chVal","chNer").enmity.ltv = 250;
	getRelation("chVal","chNer").enmity.stv = 2000;
	getRelation("chVal","chNer").rivalry.ltv = 200;
	getRelation("chVal","chNer").submission.ltv = 100;
	getRelation("chVal","chNer").submission.stv = 500;
	getRelation("chVal","chNer").domination.ltv = 100;
	getRelation("chNer","chVal").friendship.ltv = 0;
	getRelation("chNer","chVal").enmity.ltv = 400;
	getRelation("chNer","chVal").rivalry.ltv = 500;
	getRelation("chNer","chVal").submission.ltv = 0;
	getRelation("chNer","chVal").submission.stv = 500;
	getRelation("chNer","chVal").domination.ltv = 150;
}
window.initRelsValtanMesquelles = function() {
	getRelation("chVal","chMes").friendship.ltv = 300;
	getRelation("chVal","chMes").romance.ltv = 50;
	getRelation("chVal","chMes").sexualTension.ltv = 200;
	getRelation("chVal","chMes").domination.ltv = 25;
	getRelation("chMes","chVal").friendship.ltv = 400;
	getRelation("chMes","chVal").romance.ltv = 100;
	getRelation("chMes","chVal").sexualTension.ltv = 100;
	getRelation("chMes","chVal").domination.ltv = 25;
	getRelation("chMes","chVal").enmity.ltv = 50;
	getRelation("chMes","chVal").rivalry.ltv = 25;
	getRelation("chMes","chVal").enmity.stv = 300;
	getRelation("chMes","chVal").rivalry.stv = 0;
}
window.initRelsSillanNersmias = function() {
	getRelation("chSil","chNer").friendship.ltv = 400;
	getRelation("chSil","chNer").friendship.stv = 400;
	getRelation("chSil","chNer").submission.ltv = 150;
	getRelation("chSil","chNer").submission.stv = 750;
	getRelation("chNer","chSil").friendship.ltv = 500;
	getRelation("chNer","chSil").friendship.stv = 500;
	getRelation("chNer","chSil").romance.ltv = 350;
	getRelation("chNer","chSil").romance.stv = 100;
	getRelation("chNer","chSil").sexualTension.ltv = 100;
	getRelation("chNer","chSil").sexualTension.stv = 300;
	getRelation("chNer","chSil").domination.ltv = 150;
	getRelation("chNer","chSil").domination.stv = 750;
}
window.initRelsSillanMesquelles = function() {
	getRelation("chSil","chMes").friendship.ltv = 450;
	getRelation("chMes","chSil").friendship.ltv = 300;
}
window.initRelsNersmiasMesquelles = function() {
	getRelation("chNer","chMes").friendship.ltv = 300;
	getRelation("chNer","chMes").enmity.ltv = 300;
	getRelation("chMes","chNer").friendship.ltv = 250;
	getRelation("chMes","chNer").enmity.ltv = 200;
}




// First Adventure ~ Map Story Events

window.initializeFaSeBlackMailedByClaw = function() {
	// Global event variable
	addToStVarsList("blmClaw");
	// Set Claw in room
	State.variables.compass.characterEventEndsPrematurely("chClaw");
	State.variables.compass.moveCharsToRoom(["chClaw"],"unionLakeUpper");
	// Init Story UI
	setPasChars([getPresentCharByKey("chClaw")]);
	setRoomIntro("mapGleamingCaverns","unionLakeUpper");
	// Checks
	State.variables.StVars.check1 = gCstat("chPlayerCharacter","empathy") + gCstat("chPlayerCharacter","intelligence") + gCstat("chPlayerCharacter","will");
	State.variables.StVars.check2 = gCstat("chPlayerCharacter","physique") + gCstat("chPlayerCharacter","agility") + gCstat("chPlayerCharacter","perception") + gCstat("chPlayerCharacter","luck");
}

window.initializeFaSeCraftingADildo = function() {
	// Global event variable
	addToStVarsList("dldCrf");
	// Init Story UI
	setPasChars([]);
	setRoomIntro("mapGleamingCaverns","workshop");	
	// Create dildo for PC
	State.variables.StVars.check1 = createEquipment("w5","chPlayerCharacter");
}

window.initializeFaSeDildoPlay = function() {
	// Global event variable
	addToStVarsList("dldPly");
	// Init Story UI
	setPasChars([]);
	setRoomIntro("mapGleamingCaverns","workshop");
	State.variables.eventsCalendar.activeEvent = true;
	// Init variables
	var dldId = -1;	// Find player dildo's id
	for ( var it of State.variables.equipmentList ) {
		if ( it.type == "w5" && it.owner == "chPlayerCharacter" ) {
			dldId = it.id;
		}
	}
	State.variables.StVars.check1 = dldId;
	var companionType = "botNash"; // Companion type: "botNash", "topNash"
	var nashDomScore = rLvlAbt("chNash","chPlayerCharacter","sexualTension") * 1 - rLvlAbt("chNash","chPlayerCharacter","romance") * 1 + rLvlAbt("chNash","chPlayerCharacter","domination") * 1 - rLvlAbt("chNash","chPlayerCharacter","submission") + rLvlAbt("chNash","chPlayerCharacter","rivalry") + rLvlAbt("chNash","chPlayerCharacter","enmity") * 1 + getCharsDrive("chNash","dDomination") - getCharsDrive("chNash","dPleasure");
	var controlCost = rLvlAbt("chPlayerCharacter","chNash","sexualTension") * 2 + rLvlAbt("chPlayerCharacter","chNash","submission") - rLvlAbt("chPlayerCharacter","chNash","domination") * 2;
	if ( controlCost < 0 ) { controlCost = 0; }
	controlCost *= 10;
	if ( nashDomScore >= 0 ) {
		companionType = "topNash";
	}
	State.variables.StVars.check2 = companionType;
	State.variables.StVars.check3 = controlCost;
	State.variables.StVars.check4 = gC("chPlayerCharacter").lust.max * 0.2;
	gC("chPlayerCharacter").lust.changeValue(-State.variables.StVars.check4);
	if ( gC("chPlayerCharacter").lust.current <= State.variables.StVars.check4 / 2 ) { gC("chPlayerCharacter").lust.current = State.variables.StVars.check4 / 2; }
}
window.finishFaSeDildoPlay = function() {
	State.variables.eventsCalendar.activeEvent = false;
	// If Nash has equipped the player's dildo, unequip it
	if ( getEquipById(State.variables.StVars.check1).owner == "chPlayerCharacter" && getEquipById(State.variables.StVars.check1).equippedOn == "chNash" ) {
		unequipObject(State.variables.StVars.check1);
	}
}

////////// TRANSFORMATION SCENES //////////

// tfGoals explanation: tfGoals is a list of several keywords, defining the transformation goals on the tfTarget
// Each tfGoals has an associated points value, defining the amount of points required to make the associated transformation completed
// Transformations are applied by tfActors (list) characters on tfTarget using specific actions
// tfGoals -> "addDick","addPussy","removeDick","removePussy","addBreasts","removeBreasts","rebuildFace","rebuildFigure"
// tfGoalsPoints are the required points remaining until 0 to consider each tfGoal complete
scene.prototype.startTfScene = function(sceneType, enabledLead,	tAck, tBck, headingDescription,	checkEndConditions, endConditionsVars, endScenePassage,
										tfGoals, tfActors, tfTarget, tfPoints, tfPermanentFlag, tfDays, genderChange, newAvatarFileName, newPortraitFileName) {
	this.tfFlag = true;
	this.tfActors = tfActors;
	this.tfTarget = tfTarget;
	this.tfGoals = tfGoals;
	this.tfDays = tfDays;
	this.tfPoints = tfPoints;
	this.tfGoalsPoints = [];
	for ( var point of this.tfGoals ) {
		this.tfGoalsPoints.push(tfPoints);
	}
	this.tfPermanentFlag = tfPermanentFlag;
	this.genderChange = genderChange; // "femenize", "masculinize", "none"
	this.provideTfActorsWithActions();
	// Disable lead for non-transformation-actors
	for ( var cK of tAck.concat(tBck) ) {
		if ( tfActors.includes(cK) == false ) {
			addSceneTagToChar("noLead",cK);
		}
	}
	
	if ( tfGoals.includes("rebuildFace") ) {
		this.newAvatarFileName = newAvatarFileName;
		this.newPortraitFileName = newPortraitFileName;
	}
	
	this.startScene(sceneType, enabledLead,	tAck, tBck,	headingDescription, checkEndConditions, endConditionsVars, endScenePassage);
}

scene.prototype.cleanTfSceneData = function() {
	// this.applyTransformationSceneEffects(); // tfEffects are now applied during scene
	this.tfActorsForgetActions();
	delete this.tfFlag;
	delete this.tfDays;
	delete this.tfActors;
	delete this.tfTarget;
	delete this.tfGoals;
	delete this.tfPoints;
	delete this.tfGoalsPoints;
	delete this.tfPermanentFlag;
	delete this.genderChange;
	delete this.tfPassage;
	if ( this.hasOwnProperty("newAvatarFileName") ) { delete this.newAvatarFileName; }
}
scene.prototype.getTfGoalsFullData = function() {
	var tfGoalsFullData = this.tfGoals;
	var i = 0;
	while ( i < this.tfGoals.length ) {
		tfGoalsFullData[this.tfGoals[i]] = tfGoalsPoints[i];
		i++;
	}
}

	// TfGoalsActions Data

setup.addDickActions = ["formDick"];
setup.addPussyActions = ["formPussy"];
setup.removeDickActions = ["buryDick"];
setup.removePussyActions = ["foldPussy"];
setup.addBreastsActions = ["sculptChest"];
setup.removeBreastsActions = ["sculptChest"];
setup.rebuildFaceActions = ["sculptingKiss"];
setup.rebuildFigureActions = ["sculptBody"];

setup.tfOptions = ["addDick","removeDick","addPussy","removePussy","changeForm","masculinize","feminize"];

	// TfGoals
window.getTfGoalActions = function(goal) {
	var actions = [];
	var keyword = goal + "Actions";
	actions = setup[keyword];
}

window.getRequiredPointsForTfGoal = function(goal) {
	var points = -1;
	var goalPosition = -1;
	var i = 0;
	for ( var g of State.variables.sc.tfGoals ) {
		if ( goal == g ) { goalPosition = i; }
		i++;
	}
	if ( goalPosition != -1 ) { points = State.variables.sc.tfGoalsPoints[goalPosition]; }
	return points;
}

window.advanceTfGoalPoints = function(goal) {
	var target = State.variables.sc.tfTarget;
	var goalPosition = -1;
	var i = 0;
	for ( var g of State.variables.sc.tfGoals ) {
		if ( goal == g ) { goalPosition = i; }
		i++;
	}
	State.variables.sc.tfGoalsPoints[goalPosition] -= (1 + (getCharsSlimedIntensity(target) * 0.1)) * (1 + limitedRandomInt(20) * 0.01);
	if ( State.variables.sc.tfGoalsPoints[goalPosition] <= 0 ) {
		applyTfGoalPerStringToTfTarget(goal);
	}
}
window.advanceTfGoalsPoints = function(goals) {
	for ( var goal of goals ) {
		advanceTfGoalPoints(goal);
	}
}

	// TfActions
scene.prototype.provideTfActorsWithActions = function() {
	for ( var goal of this.tfGoals ) {
		var keyword = goal + "Actions";
		var newActions = setup[keyword];
		charactersLearnSceneActions(this.tfActors,newActions);
	}
}
scene.prototype.tfActorsForgetActions = function() {
	for ( var goal of this.tfGoals ) {
		var keyword = goal + "Actions";
		var oldActions = setup[keyword];
		charactersForgetSceneActions(this.tfActors,oldActions);
	}
}

	// Tf Scene General Logic
window.isTfSceneFinished = function() {
	var flagFinished = false;
	var allGoalsFinished = true;
	for ( var goalPoints of State.variables.sc.tfGoalsPoints ) {
		if ( goalPoints > 0 ) { allGoalsFinished = false; }
	}
	var allCharsSatisfied = true;
	for ( var cK of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( getBarPercentage(cK,"lust") <= 0.8 && gC(cK).getAllSceneOrgasms() < 1 ) {
			allCharsSatisfied = false;
		}
	}
	if ( allGoalsFinished == true && allCharsSatisfied == true ) { flagFinished = true; }
	return flagFinished;
}

window.tfStandardEndScript = function() {
	State.variables.logL1.push(1);
	var tfAs = createFinishedTransformationAs(State.variables.sc.tfDays,State.variables.sc.tfGoals);
	if ( tfAs.tfTypes.length > 0 ) {
		applyAlteredState([State.variables.sc.tfTarget],tfAs);
	}
	
	var allChars = State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys);
	for ( var cK of allChars ) {
		if ( gC(cK).orgasmSceneCounter > 0 || gC(cK).mindblowingOrgasmSC > 0 || State.variables.sc.sceneType == "bs" ) {
			gC(cK).lust.restore();
		}
	}
	
	// Results message
	State.variables.compass.sceneResultsPassage = "[[Continue|Map]]\n\n"
			 + "The transformations on " + gC(State.variables.sc.tfTarget).getFormattedName() + " have been completed.";
	State.variables.sc.cleanTfSceneData();
}
window.tfGleamingCavernsEndScript = function() {
	State.variables.logL1.push(2);
	tfStandardEndScript();
	if ( State.variables.morphMerit == undefined ) {
		State.variables.morphMerit = 10;
	} else {
		State.variables.morphMerit -= 1;
		if ( State.variables.morphMerit <= 5 ) { State.variables.morphMerit -= 2; }
	}
	gC("chPlayerCharacter").ssRsp += State.variables.morphMerit;
	// Finish transformations early
	var effectiveRemoval = gC("chPlayerCharacter").removeSpecificState("Tfmd");
	// Complete interlude message
	if ( effectiveRemoval ) {
		State.variables.compass.sceneResultsPassage += "\n\nThe magic was weak, and the effects soon dispel.";
	}
	State.variables.compass.sceneResultsPassage += "\n\nDue to the help provided to " + gC("chMes").getFormattedName() + ", " + gC("chPlayerCharacter").getFormattedName() + " gains " + State.variables.morphMerit + " respect in the Shapeshifter tribe.";
	
}

	// Others
scene.prototype.tfProgressDescription = function() {
	var desc = "__Transformation progress__:\n";
	var i = 0;
	for ( var goal of this.tfGoals ) {
		desc += getTfGoalName(goal) + ": ";
		if ( this.tfGoalsPoints[i] >= 0 ) {
			desc += (100 - (this.tfGoalsPoints[i] * 100 / this.tfPoints)).toFixed(0) + "%"
		} else {
			desc += "100% Complete";
		}
		desc += "\n";
		i++;
	}
	var frustratedChars = [];
	for ( var cK of State.variables.sc.teamAcharKeys.concat(State.variables.sc.teamBcharKeys) ) {
		if ( getBarPercentage(cK,"lust") <= 0.8 && gC(cK).getAllSceneOrgasms() < 1 ) {
			frustratedChars.push(cK);
		}
	}
	if ( frustratedChars.length > 1 ) {
		desc += "" + getCharNames(frustratedChars) + " are still " + randomFromList(["horny","aroused","excited"]) + " and need to reach orgasm.";
	} else if ( frustratedChars.length > 0 ) {
		desc += "" + getCharNames(frustratedChars) + " is still " + randomFromList(["horny","aroused","excited"]) + " and needs to reach orgasm.";		
	}
	return desc;
}
window.getTfGoalName = function(goalKey) {
	var name = "";
	switch(goalKey) {
		case "addDick":
			name = "Create dick";
			break;
		case "addPussy":
			name = "Create pussy";
			break;
		case "removeDick":
			name = "Bury dick";
			break;
		case "removePussy":
			name = "Enfold pussy";
			break;
		case "addBreasts":
			if ( State.variables.sc.genderChange == "feminize" ) { name = "Create breasts"; }
			else if ( gC(State.variables.sc.tfTarget).perPr == "she" ) { name = "Rebuild breasts"; }
			else { name = "Rebuild chest"; }
			break;
		case "removeBreasts":
			if ( State.variables.sc.genderChange == "masculinize" ) { name = "Flatten chest"; }
			else if ( gC(State.variables.sc.tfTarget).perPr == "she" ) { name = "Rebuild breasts"; }
			else { name = "Rebuild chest"; }
			break;
		case "rebuildFace":
			name = "Chisel face";
			break;
		case "rebuildFigure":
			name = "Rebuild figure";
			break;
	}
	return name;
}
	
window.debugTfSceneData = function() {
	State.variables.logL2.push("Turn: ",State.variables.sc.currentTurn," Data: ",State.variables.sc.tfActors,State.variables.sc.tfTarget,State.variables.sc.tfGoals,State.variables.sc.tfGoalsPoints);
}

	// TfGoalsEffects Data
scene.prototype.applyTransformationSceneEffects = function() {
	for ( var tfGoal of this.tfGoals ) {
		applyTfGoalPerStringToTfTarget(tfGoal);
	}
}
window.applyTfGoalPerStringToTfTarget = function(tfGoal) {
	switch ( tfGoal ) {
			case "addDick":
				tfAddDick(State.variables.sc.tfTarget);
				break;
			case "addPussy":
				tfAddPussy(State.variables.sc.tfTarget);
				break;
			case "removeDick":
				tfRemoveDick(State.variables.sc.tfTarget);
				break;
			case "removePussy":
				tfRemovePussy(State.variables.sc.tfTarget);
				break;
			case "addBreasts":
				tfAddBreasts(State.variables.sc.tfTarget);
				break;
			case "removeBreasts":
				tfRemoveBreasts(State.variables.sc.tfTarget);
				break;
			case "rebuildFace":
				tfRebuildFace(State.variables.sc.tfTarget);
				break;
			case "rebuildFigure":
				tfRebuildFigure(State.variables.sc.tfTarget);
				break;
		}
}

window.tfAddDick = function(target) {
	gC(target).addBodypart("dick","dick");
}
window.tfAddPussy = function(target) {
	gC(target).addBodypart("pussy","pussy");
}
window.tfRemoveDick = function(target) {
	// Asumes dick isn't locked
	gC(target).removeBodypart("dick");
}
window.tfRemovePussy = function(target) {
	// Assumes pussy isn't locked
	gC(target).removeBodypart("pussy");
}
window.tfAddBreasts = function(target) {
}
window.tfRemoveBreasts = function(target) {
}
window.tfRebuildFace = function(target) {
	// Gender
	if ( State.variables.sc.genderChange == "feminize" ) {
		gC(target).oldPronoun = gC(target).perPr;
		gC(target).assignFemeninePronouns();
	} else if ( State.variables.sc.genderChange == "masculinize" ) {
		gC(target).oldPronoun = gC(target).perPr;
		gC(target).assignMasculinePronouns();
	} else {
		
	}
	// Avatar
	if ( State.variables.sc.newAvatarFileName != undefined ) {
		if ( gC(target).avatar == null ) {
			gC(target).avatar = function() { return "[img[" + this.avatarL + "]]"; }
		}
		if ( gC(target).fullPortrait == null ) {
			gC(target).fullPortrait = function() { return "[img[" + this.fullPortraitL + "]]"; }
		}
		gC(target).originalPortrait = gC(target).fullPortraitL;
		gC(target).originalAvatar = gC(target).avatarL;
		gC(target).avatarL = State.variables.sc.newAvatarFileName;
		gC(target).fullPortraitL = State.variables.sc.newPortraitFileName;
		gC(target).avatar = function() { return "[img[" + this.avatarL + "]]"; }
		gC(target).fullPortrait = function() { return "[img[" + this.fullPortraitL + "]]"; }
	}
}
window.tfRebuildFigure = function(target) {
}

	// Finished transformation effects

	// "addDick","addPussy","removeDick","removePussy","addBreasts","removeBreasts","rebuildFace","rebuildFigure"
window.tfASendEffects = function(cK,as) { // This function is called by the "Transformed" altered state, and calls the appropriate tfFinish functions,
									   // depending on the data of the AS object
	for ( var tfType of as.tfTypes ) {
		switch (tfType) {
			case "addDick":
				tfFinishAddDick(cK);
				break;
			case "addPussy":
				tfFinishAddPussy(cK);
				break;
			case "removeDick":
				tfFinishRemoveDick(cK);
				break;
			case "removePussy":
				tfFinishRemovePussy(cK);
				break;
			case "rebuildFigure":
				tfFinishRebuildFigure(cK);
				break;
			case "changedGender":
				tfFinishChangedGender(cK);
				break;
		}
	}
}
window.tfFinishAddDick = function(cK) {
	if ( gC(cK).body.hasOwnProperty("dick") ) {
		if ( gC(cK).body.dick.state == "locked" ) {
			unequipObject(gC(cK).body.dick.bondage);
		}
		gC(cK).removeBodypart("dick");
	}
}
window.tfFinishAddPussy = function(cK) {
	if ( gC(cK).body.hasOwnProperty("pussy") ) {
		if ( gC(cK).body.pussy.state == "locked" ) {
			unequipObject(gC(cK).body.pussy.bondage);
		}
		gC(cK).removeBodypart("pussy");
	}
}
window.tfFinishRemoveDick = function(cK) {
	gC(cK).addBodypart("dick","dick");
}
window.tfFinishRemovePussy = function(cK) {
	gC(cK).addBodypart("pussy","pussy");
}
window.tfFinishRebuildFigure = function(cK) {
	gC(cK).avatarL = gC(cK).originalAvatar;
	gC(cK).fullPortraitL = gC(cK).originalPortrait;
	if ( gC(cK).avatarL == null ) {
		gC(cK).avatar = null;
	} else {
		gC(cK).avatar = function() { return "[img[" + gC(cK).avatarL + "]]"; }
	}
	if ( gC(cK).fullPortraitL == null ) {
		gC(cK).fullPortrait = null;
	} else {
		gC(cK).fullPortrait = function() { return "[img[" + gC(cK).fullPortraitL + "]]"; }
	}
	delete gC(cK).originalAvatar;
	delete gC(cK).originalPortrait;
}
window.tfFinishChangedGender = function(cK) {
	if ( gC(cK).oldPronoun == "she" ) {
		gC(cK).assignFemeninePronouns();
		delete gC(cK).oldPronoun;
	} else if ( gC(cK).oldPronoun == "he" ) {
		gC(cK).assignMasculinePronouns();
		delete gC(cK).oldPronoun;		
	}
}

// Menus

window.setupTfMenu = function(tfTarget,tfMainActor,menuPassage) {
	State.variables.tfGoals = [];
	State.variables.tfTemporary = true;
	State.variables.tfTarget = tfTarget;
	State.variables.tfMainActor = tfMainActor;
	State.variables.tfMenuString = "";
	State.variables.tfAvatar = "";
	State.variables.tfAvatarMenuString = "";
	State.variables.tfMenuPassage = menuPassage;
	updateSelectedTransformationsText(tfTarget,tfMainActor,menuPassage);
}
window.updateSelectedTransformationsText = function(tfTarget,tfMainActor,menuPassage) {
	var tfmString = "";
	// Selected Options
	if ( State.variables.tfGoals.length > 0 ) {
		tfmString = "__Selected options:__\n"
		for ( var tfG of State.variables.tfGoals ) {
			var tfgNd = getTfGoalNameDescription(tfG);
			tfmString += "- " + tfgNd[0] + hoverText("^^(?)^^",tfgNd[1]) + " " + getButtonRemoveTfGoal(tfG,menuPassage) + "\n"; // Goal, name, desc, cancel
		}
		tfmString += "\n";
	}
	var nonSelectedTfOptions = [];
	for ( var tfG of setup.tfOptions ) {
		if ( State.variables.tfGoals.includes(tfG) == false ) {
			nonSelectedTfOptions.push(tfG);
		}
	}
	if ( nonSelectedTfOptions.length > 0 ) {
		tfmString += "__Transformation choices__:\n";
		for ( var tfG of nonSelectedTfOptions ) {
			var tfGnd = getTfGoalNameDescription(tfG);
			if ( isTfGoalAllowedAndDesc(tfG,tfTarget)[0] == true ) { // Allowed
				tfmString += "- " + tfGnd[0] + hoverText("^^(?)^^",tfGnd[1]) + " " + getButtonSelectTfGoal(tfG,menuPassage) + "\n";
			} else { // Disallowed
				tfmString += colorText("- Locked: " + tfGnd[0] + hoverText("^^(?)^^",isTfGoalAllowedAndDesc(tfG,tfTarget)[1]),"red") + "\n";
			}
		}
		tfmString += "\n";
	}
	// Change temporary option
	tfmString += "Temporary: " + firstToCap("" + State.variables.tfTemporary) + hoverText("^^(?)^^","When set to false, some transformation effects will be permanent.") + " " + getButtonTemporaryTfChange(menuPassage) + "\n\n";
	
	// Init scene, cancel scene
	tfmString += getButtonAdvanceTfMenu();
	
	State.variables.tfMenuString = tfmString;
}
window.updateAvatarMenuString = function(menuPassage) {
	State.variables.tfAvatarMenuString = "[[Back to previous menu|" + State.variables.tfMenuPassage + "]]\n\n"
									   + "__Select the new avatar:__\n\n";
									   
	if ( State.variables.tfGoals.includes("masculinize") || ( State.variables.tfGoals.includes("changeForm") && gC(State.variables.tfTarget).perPr == "he" ) ) { // Masculine avatar
		State.variables.tfAvatarMenuString += '<label><<radiobutton "$StVars.check1" "custom-male-1" checked>> [img[img/portraits/custom-male-1-avatar.png]] </label>\n'
						+ '<label><<radiobutton "$StVars.check1" "custom-male-2">> [img[img/portraits/custom-male-2-avatar.png]] </label>\n'
						+ "\n";
	} else { // Femenine avatar
		State.variables.tfAvatarMenuString += '<label><<radiobutton "$StVars.check1" "mc1" checked>> [img[img/portraits/mc1-avatar.png]] </label>\n'
						+ '<label><<radiobutton "$StVars.check1" "mc2">> [img[img/portraits/mc2-avatar.png]] </label>\n'
						+ '<label><<radiobutton "$StVars.check1" "mc3">> [img[img/portraits/mc3-avatar.png]] </label>\n'
						+ '<label><<radiobutton "$StVars.check1" "custom">> [img[img/portraits/custom-avatar.png]] </label>\n'
						+ "\n";		
	}
	State.variables.tfAvatarMenuString += "<<l" + "ink [[Continue to transformation scene|Scene]]>><<s" + "cript>>createTfSceneWithSettings();<</s" + "cript>><</l" + "ink>>"; // Initiate transformation scene, set avatar target to check1
}

window.getButtonRemoveTfGoal = function(tfGoal,menuPassage) {
	var bText = "<<l" + "ink [[Cancel|" + menuPassage + "]]>><<s" + "cript>>" + "State.variables.tfGoals = arrayMinusA(State.variables.tfGoals,'" + tfGoal + "');<</s" + "cript>><</l" + "ink>>";
	return bText;
}
window.getButtonSelectTfGoal = function(tfGoal,menuPassage) {
	var bText = "<<l" + "ink [[Select|" + menuPassage + "]]>><<s" + "cript>>" + "State.variables.tfGoals.push('" + tfGoal + "');<</s" + "cript>><</l" + "ink>>";
	return bText;
}
window.getButtonTemporaryTfChange = function(menuPassage) {
	var bText = "<<l" + "ink [[Change|" + menuPassage + "]]>><<s" + "cript>>changeTemporaryTfFlag();<</s" + "cript>><</link>>";
	return bText;
}
window.cleanTfMenu = function() {
	delete State.variables.tfGoals;
	delete State.variables.tfTemporary;
	delete State.variables.tfTarget;
	delete State.variables.tfMainActor;
	delete State.variables.tfMenuString;
	delete State.variables.tfAvatar;
	delete State.variables.tfMenuPassage;
	delete State.variables.tfAvatarMenuString;
}

window.isTfGoalAllowedAndDesc = function(tfGoal,tfTarget) {
	var isAllowed = false;
	var desc = "";
	switch(tfGoal) {
		case "addDick":
			if ( gC(tfTarget).body.hasOwnProperty("dick") == false ) {
				isAllowed = true;
			} else {
				desc = "The character already has a dick.";
			}
			break;
		case "removeDick":
			if ( gC(tfTarget).body.hasOwnProperty("dick") == true ) {
				if ( gC(tfTarget).body.dick.state == "free" ) {
					isAllowed = true;
				}
			} else {
				desc = "The character does not have a free dick.";
			}
			break;
		case "addPussy":
			if ( gC(tfTarget).body.hasOwnProperty("pussy") == false ) {
				isAllowed = true;
			} else {
				desc = "The character already has a pussy.";
			}
			break;
		case "removePussy":
			if ( gC(tfTarget).body.hasOwnProperty("pussy") == true ) {
				if ( gC(tfTarget).body.pussy.state == "free" ) {
					isAllowed = true;
				} else {
					desc = "The character does not have a free pussy.";
				}
			}
			break;
		case "changeForm":
			if ( tfTarget == "chPlayerCharacter" && isAnyBodyChangeTransformationSelected() == false ) {
				isAllowed = true;
			} else {
				desc = "This option is only available for " + gC("chPlayerCharacter").name + " when no other body transformation is selected.";
			}
			break;
		case "masculinize":
			if ( tfTarget == "chPlayerCharacter" && gC("chPlayerCharacter").perPr != "he" && isAnyBodyChangeTransformationSelected() == false ) {
				isAllowed = true;
			} else {
				desc = "This option is only avaiable for " + gC("chPlayerCharacter").name + " when " + gC("chPlayerCharacter").posPr + " gender is not male and no other body transformation is selected.";
			}
			break;
		case "feminize":
			if ( tfTarget == "chPlayerCharacter" && gC("chPlayerCharacter").perPr != "she" && isAnyBodyChangeTransformationSelected() == false ) {
				isAllowed = true;
			} else {
				desc = "This option is only avaiable for " + gC("chPlayerCharacter").name + " when " + gC("chPlayerCharacter").posPr + " gender is not female and no other full body transformation is selected.";
			}
			break;
	}
	return [isAllowed,desc];
}
window.getTfGoalNameDescription = function(tfGoal) {
	var name = "tfGoalName";
	var desc = "tfGoalDesc";
	switch(tfGoal) {
		case "addDick":
			name = "Add dick";
			desc = "The character will gain a dick bodypart.";
			break;
		case "removeDick":
			name = "Remove dick";
			desc = "The character will lose their dick bodypart.";
			break;
		case "addPussy":
			name = "Add pussy";
			desc = "The character will gain a pussy bodypart.";
			break;
		case "removePussy":
			name = "Remove pussy";
			desc = "The character will lose their pussy bodypart.";
			break;
		case "changeForm":
			name = "Change form";
			desc = "The character will receive a new appearance.";
			break;
		case "masculinize":
			name = "Masculinize";
			desc = "The character will receive a male appearance, and will be treated as male.";
			break;
		case "feminize":
			name = "Feminize";
			desc = "The character will receive a feminine appearance, and will be treated as female.";
			break;
	}
	return [name,desc];
}
window.isAnyBodyChangeTransformationSelected = function() {
	if ( State.variables.tfGoals.includes("feminize") || State.variables.tfGoals.includes("masculinize") || State.variables.tfGoals.includes("changeForm") ) {
		return true;
	} else {
		return false;
	}
}
window.willTfTargetBeLeftWithGenitals = function() {
	var finalGenitals = [];
	if ( gC(State.variables.tfTarget).body.hasOwnProperty("dick") ) { finalGenitals.push("dick"); }
	if ( gC(State.variables.tfTarget).body.hasOwnProperty("pussy") ) { finalGenitals.push("pussy"); }
	if ( State.variables.tfGoals.includes("addDick") ) { finalGenitals.push("dick"); }
	if ( State.variables.tfGoals.includes("addPussy") ) { finalGenitals.push("pussy"); }
	if ( State.variables.tfGoals.includes("removeDick") ) { finalGenitals = arrayMinusA(finalGenitals,"dick"); }
	if ( State.variables.tfGoals.includes("removePussy") ) { finalGenitals = arrayMinusA(finalGenitals,"pussy"); }
	var flag = false;
	if ( finalGenitals.length > 0 ) { flag = true; }
	return flag;
}
window.changeTemporaryTfFlag = function() {
	if ( State.variables.tfTemporary ) {
		State.variables.tfTemporary = false;
	} else {
		State.variables.tfTemporary = true;
	}
}

window.getButtonAdvanceTfMenu = function(menuPassage) {
	if ( State.variables.tfGoals.length >= 1 ) {
		var flagSelectAvatar = false;
		if ( State.variables.tfTarget == "chPlayerCharacter" && State.variables.tfGoals.includes("changeForm") || State.variables.tfGoals.includes("masculinize") || State.variables.tfGoals.includes("feminize") ) {
			flagSelectAvatar = true;
		}
		if ( flagSelectAvatar ) { // Select avatar menu
			var bText = "<<l" + "ink [[Continue to select new form|TF Select Avatar]]>><<s" + "cript>>updateAvatarMenuString('" + menuPassage + "');<</s" + "cript>><</l" + "ink>>";
		} else { // Init Transformation scene
			var bText = "<<l" + "ink [[Continue to transformation scene|Scene]]>><<s" + "cript>>createTfSceneWithSettings();<</s" + "cript>><</l" + "ink>>";
		}
	} else {
		var bText = colorText("Locked: Cannot proceed without at least one transformation option.","red");
	}
	return bText;
}

window.createTfSceneWithSettings = function() {
	var teamAchars = [];
	var teamBchars = [];
	// Set team A and B
	if ( getCharGroup(State.variables.tfTarget).includes(State.variables.tfMainActor) ) {
		// Split group
		teamAchars = arrayMinusA(getCharGroup(State.variables.tfTarget),State.variables.tfMainActor);
		teamBchars = [State.variables.tfMainActor];
	} else {
		// Two groups
		teamAchars = getCharGroup(State.variables.tfTarget);
		teamBchars = getCharGroup(State.variables.tfMainActor);
	}
		// Fix groups if PC in team B
	if ( teamBchars.includes("chPlayerCharacter") ) {
		var tempTeam = teamAchars;
		teamAchars = teamBchars;
		teamBchars = tempTeam;
	}
	// End scene passage
	var endScenePassage = "";
	if ( State.variables.tfMenuPassage == "FASE MorphHut MorphMenu" ) {
		// Temporary
		endScenePassage = "Scene Results";
		State.variables.sc.endSceneScript = tfGleamingCavernsEndScript;
	} else {
		endScenePassage = "Scene Results";
		State.variables.sc.endSceneScript = tfStandardEndScript;
	}
	// Goals
	var tfGoals = getTfGoalsFromTfOptions();
	// tfActors
	var tfActors = [];
	for ( var cK of teamAchars.concat(teamBchars) ) {
		if ( getValidTfActors().includes(cK) ) {
			tfActors.push(cK);
		}
	}
	// Gender change
	var genderChange = "none";
	if ( State.variables.tfGoals.includes("masculinize") ) { genderChange = "masculinize"; }
	else if ( State.variables.tfGoals.includes("feminize") ) { genderChange = "feminize"; }
	// New avatar file names
	var avatarFileName = "";
	var portraitFileName = "";
	if ( State.variables.tfGoals.includes("masculinize") || State.variables.tfGoals.includes("feminize") || State.variables.tfGoals.includes("changeForm") ) {
		avatarFileName = "img/portraits/" + State.variables.StVars.check1 + "-avatar.png";
		portraitFileName = "img/portraits/" + State.variables.StVars.check1 + "-full.png";
	}
	// Description
	var description = "";
	// getCurrentRoomInfo().description
	/* //
	State.variables.compass.ongoingEvents.push(createSystemEventCheapWaitNoDesc(5,["chPlayerCharacter"]));
	State.variables.compass.sortOnGoingEventsByTime();
	State.variables.compass.pushAllTimeToAdvance();
	State.variables.sc.startTfScene("ss","dynamic",teamAchars,teamBchars,description,isTfSceneFinished,1,endScenePassage,
		tfGoals,tfActors,State.variables.tfTarget,4,!State.variables.tfTemporary,7,genderChange,avatarFileName,portraitFileName);
	if ( State.variables.tfMenuPassage == "FASE MorphHut MorphMenu" ) {
		State.variables.sc.endSceneScript = tfGleamingCavernsEndScript;
	} else {
		State.variables.sc.endSceneScript = tfStandardEndScript;
	}
	// AIs
	for ( var cK of teamAchars.concat(teamBchars) ) {
		if ( cK != "chPlayerCharacter" ) {
			gC(cK).aiAlgorythm = createAiWeightedMissionsByTaste();
		}
	}
	// Format scene screen
	State.variables.sc.formatScenePassage();
	*/
	//var tfMenuPassage = State.variables.tfMenuPassage;
	State.variables.compass.ongoingEvents.push(createSystemEventStandardTransformationScene(teamAchars,teamBchars,description,isTfSceneFinished,endScenePassage,
		tfGoals,tfActors,State.variables.tfTarget,!State.variables.tfTemporary,genderChange,avatarFileName,portraitFileName,State.variables.tfMenuPassage));
	State.variables.compass.sortOnGoingEventsByTime();
	State.variables.compass.pushAllTimeToAdvance();
	// Clean tf variables
	cleanTfMenu();
}
window.getTfGoalsFromTfOptions = function() {
	var tfGoals = [];
	for ( var tfOption of State.variables.tfGoals ) {
		if ( ["addDick","addPussy","removeDick","removePussy"].includes(tfOption) ) {
			tfGoals.push(tfOption);
		} else {
			switch(tfOption) {
				case "changeForm":
					tfGoals.push("rebuildFace","rebuildFigure");
					if ( gC(State.variables.tfTarget).perPr == "she" ) {
						tfGoals.push("addBreasts");
					}
					break;
				case "masculinize":
					tfGoals.push("rebuildFace","rebuildFigure","removeBreasts");
					break;
				case "feminize":
					tfGoals.push("rebuildFace","rebuildFigure","addBreasts");
					break;
			}
		}
	}
	return tfGoals;
}

window.getValidTfActors = function() {
	var transformators = ["chMes"];
	return transformators;
}

////////// ////////// ////////// //////////

</script><tw-passagedata pid="1" name="GoddessHerald 1" tags="" position="27,254" size="100,100">You slowly open your eyes, yet darkness doesn&#39;t turn into light, but into mist.

A dense, purple mist expands in all directions, to the point that you aren&#39;t able to see anything else. Not the sky, and not the ground either - you might as well be stepping on the mist itself, and your mostly asleep mind wouldn&#39;t mind.

You advance some steps until you hear a distant voice, a voice that gets clearer and clearer. A voice that is calling you.

&lt;span @style=&quot;$chGoddessHerald.colorStyleKey&quot;&gt;//&quot;ame... Tell me... Your name...&quot;//&lt;/span&gt;

What will you reply?

&lt;&lt;textbox &quot;$chPlayerCharacter.name&quot; &quot;&quot; &quot;GoddessHerald Avatar Selection&quot;&gt;&gt;
&lt;span style=&quot;color:Khaki&quot;&gt;Type in your (female) character&#39;s name and press Enter to continue.&lt;/span&gt;</tw-passagedata><tw-passagedata pid="2" name="StoryInit" tags="" position="138,18" size="100,100">&lt;&lt;set $imgList to new imgList()&gt;&gt;

&lt;&lt;script&gt;&gt;
//////////////////// CHARACTERS

///// PLAYER CHARACTER
State.variables.chPlayerCharacter = createPlayerCharacter();
State.variables.playerCustomMoods = [0,0,0,0,0,0,0,0];
///// NASHILLBYIR
State.variables.chNash = createNashillbyir();
///// PADMIRI
State.variables.chMir = createPadmiri();
///// CARINE
State.variables.chClaw = createCarine();
///// VALTAN
State.variables.chVal = createValtan();
///// MAATERASU
State.variables.chAte = createMaaterasu();

///// GODDESS HERALD 
State.variables.chGoddessHerald = createGoddessHerald();

/*
var requestedBytes = 1024*1024*10; // 10MB

navigator.webkitPersistentStorage.requestQuota (
    requestedBytes, function(grantedBytes) {
        window.requestFileSystem(TEMPORARY, grantedBytes, onInitFs, errorHandler);
		State.variables.logL1.push(grantedBytes);

    }, function(e) { console.log(&#39;Error&#39;, e); }
);

var i = 0;
State.variables.fakeCharacters = [];
while ( i &lt; 20 ) {
State.variables.fakeCharacters.push(createMaaterasu());
i++;
}
*/

setUpRelations();
&lt;&lt;/script&gt;&gt;

///// DUMMY
&lt;&lt;script&gt;&gt;State.variables.chDummy = createDrishtya();&lt;&lt;/script&gt;&gt;
//////////////////////////


///// STORY INTERRUPTORS
&lt;&lt;set $StVars to 0&gt;&gt;
&lt;&lt;script&gt;&gt;
State.variables.StVars = {};
State.variables.StVars.temp = &quot;red&quot;;
State.variables.StVarsList = [];
State.variables.selectedStats = [&quot;physique&quot;,&quot;physique&quot;,&quot;physique&quot;,&quot;physique&quot;,&quot;physique&quot;,&quot;physique&quot;];
&lt;&lt;/script&gt;&gt;

///// SCENE CLASS
&lt;&lt;set $sc to new scene()&gt;&gt;

///// SCENE ACTIONS

///// Engine
&lt;&lt;set $charScreenFocus to &quot;chPlayerCharacter&quot;&gt;&gt;
&lt;&lt;set $settings to new Settings()&gt;&gt;

&lt;&lt;script&gt;&gt;
	// Items
State.variables.equipmentList = [];
State.variables.currentMerchants = [];
State.variables.enabledMerchants = [];

	// Starting weapons
createEquipment(&quot;w0&quot;,&quot;chNash&quot;);
equipObjectOnWearer(0,&quot;chNash&quot;,-1);
&lt;&lt;/script&gt;&gt;


///// UI
&lt;&lt;set $leftUIbarText to &quot;&quot;&gt;&gt;
&lt;&lt;set $rightUIbarText to &quot;&quot;&gt;&gt;

///// Others
&lt;&lt;set $tempImg to &quot;&quot;&gt;&gt; 

</tw-passagedata><tw-passagedata pid="3" name="GoddessHerald 2" tags="" position="123,144" size="100,100">&lt;&lt;script&gt;&gt;
if ( State.variables.chPlayerCharacter.name == &quot;&quot; ) {
State.variables.chPlayerCharacter.name = &quot;Nameless&quot;;
}
State.variables.chPlayerCharacter.setColors(&quot;Red&quot;,&quot;Crimson&quot;);
State.variables.chPlayerCharacter.names = [ State.variables.chPlayerCharacter.name , State.variables.chPlayerCharacter.name , State.variables.chPlayerCharacter.name , &quot;the young human&quot; ];
&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Yes... I found you.&quot;//&lt;/span&gt;

Whoever is talking to you, you&#39;re able to hear them better by the moment.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I&#39;ve seen things about you, $chPlayerCharacter.name. You will play an important role for your people in the near future. Are you ready for it?&quot;//&lt;/span&gt;

What will you reply?
&lt;&lt;set $StVars.gh0 to 0&gt;&gt;
[[&#39;&quot;There is much I do not yet understand.&quot;&#39;|GoddessHerald 3][$StVars.gh0 to 1]]
[[&#39;&quot;I don&#39;t know everything I need to, but I will in time.&quot;&#39;|GoddessHerald 3][$StVars.gh0 to 2]]
[[&#39;&quot;Absolutely. My people won&#39;t regret choosing me.&quot;&#39;|GoddessHerald 3][$StVars.gh0 to 3]]</tw-passagedata><tw-passagedata pid="4" name="GoddessHerald 3" tags="" position="198,143" size="100,100">&lt;&lt;if $StVars.gh0 == 1&gt;&gt; \
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Do not worry, small one...&quot;//&lt;/span&gt;
//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower&lt;/span&gt;.//
&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.willpower.changeValue(-10);&lt;&lt;/script&gt;&gt; \
&lt;&lt;elseif $StVars.gh0 == 2&gt;&gt; \
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I&#39;m certain you will.&quot;//&lt;/span&gt;
&lt;&lt;elseif $StVars.gh0 == 3&gt;&gt; \
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;A confident one, aren&#39;t you?&quot;//&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \

A silhouette begins to form within the mist, the silhouette of a toned woman. Slightly taller than you, you catch the glimpse of a perverse smile. She walks slowly towards you, and her figure and features take clearer forms. \

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/varyonte-full.png]]
&lt;/div&gt; \

&lt;&lt;if $StVars.gh0 == 1&gt;&gt;
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I will guide you through your trials.&quot;//&lt;/span&gt;
//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower&lt;/span&gt;.//
&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.willpower.changeValue(-10);&lt;&lt;/script&gt;&gt; \
&lt;&lt;elseif $StVars.gh0 == 2&gt;&gt;
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;After all, I&#39;m here to guide you through it.&quot;//&lt;/span&gt;
//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.willpower.changeValue(-10);&lt;&lt;/script&gt;&gt; \
&lt;&lt;elseif $StVars.gh0 == 3&gt;&gt;
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;You should be able to show me how ready you are, then.&quot;//&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \

The purple leaves room to the crimson of her skin and the violet of her clothes. Above them, two horns. Behind her legs, a calm, dancing, three-pointed tail. Next to each of her arms, large bat wings stand open and powerful.

Her amber eyes strike directly at you, as if they were directly looking at your soul. Her lips and cheeks smile, as if they wanted to devour it.

&lt;&lt;link [[Her arms reach you|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startScene(
&quot;ss&quot;, &quot;fixed&quot;,
[&quot;chPlayerCharacter&quot;], [&quot;chGoddessHerald&quot;],
&#39;&lt;span style=&quot;color:Khaki&quot;&gt;Tutorial: You have entered your first scene. During scenes, each involved character uses an action each turn. Your current action is displayed at the box that says &quot;Do nothing&quot; - you should change it before you click on &quot;Commit action&quot;. If your selected action is allowed, that will let you advance to the next turn.&lt;/span&gt;\n\nThe mist extends in all directions...&#39;,
endConditionTurns, 5,
&quot;GoddessHerald 4&quot;);
State.variables.chGoddessHerald.hasLead = true;
State.variables.sc.enabledDialogues = false;
State.variables.chGoddessHerald.aiAlgorythm = createAiActionSequence();
State.variables.chGoddessHerald.aiAlgorythm.actionSequence = [&quot;hypnoticGlance&quot;,&quot;frenchKiss&quot;,&quot;hypnoticGlance&quot;,&quot;strokePussy&quot;,&quot;hypnoticGlance&quot;];
State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = &quot;chPlayerCharacter&quot;;
State.variables.sc.sceneConditions.push(&quot;cantCancelActions&quot;);
State.variables.sc.customScript = function() {
	switch(this.currentTurn) {
		case 2:
			this.headingDescription = &#39;&lt;span style=&quot;color:Khaki&quot;&gt;Tutorial: That\&#39;s how you do it! Remember that you can change your actions\&#39; targets by clicking on the circles next to their names.&lt;/span&gt;\n\n&#39;			
			+&#39;The mist extends in all directions...&#39;;
			break;
		case 3:
			this.headingDescription = &#39;&lt;span style=&quot;color:Khaki&quot;&gt;Tutorial: Each scene has its own mechanics: it may end if a character reaches orgasm or runs out of willpower, or simply because a certain amount of turns have passed. However you shouldn\&#39;t worry much about it for now, just choose what you\&#39;d like your character to do - and have fun!&lt;/span&gt;\n\n&#39;			
			+&#39;The mist extends in all directions...&#39;;
			break;
		case 4:
			this.headingDescription = &#39;The mist extends in all directions...&#39;;
			break;
	}
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="5" name="StoryCaption" tags="" position="247,18" size="100,100">$leftUIbarText</tw-passagedata><tw-passagedata pid="6" name="Quickstarts" tags="saveAllowed" position="487,24" size="100,100">This is a shortcuts screen only available for testing in some development builds. You may try some of the options here for fun, but remember that they&#39;re often unstable and not maintained. You can access the actual game by clicking on &quot;Start the game&quot;.

&lt;&lt;set $chPlayerCharacter.name to &quot;Rose&quot;&gt;&gt;
&lt;&lt;script&gt;&gt;
initRelationshipDataAmongAllActiveCharacters();
//State.variables.StVars.temp2 = &quot;option2&quot;;
//assignPcPortrait();
&lt;&lt;/script&gt;&gt; \
\
[[Start the game|Disclaimer]]
[[Supporter Quickstart Room]]
[[Cheat Menu Supporter Room]]

&lt;&lt;link [[Map Tests|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.StVarsList.push(&quot;go0&quot;);
//createRelTypeTutorshipSub(&quot;chVal&quot;,&quot;chPlayerCharacter&quot;,3);
//createRelTypeTutorshipDom(&quot;chPlayerCharacter&quot;,&quot;chVal&quot;,3);
State.variables.chPlayerCharacter.charisma.value = 30;
initTrainingPeriodPassionTemple();
for ( var character of getActiveSimulationCharactersArray() ) {
	gC(character).restoreMood();
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Map Tests Socialization|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
//createRelTypeTutorshipSub(&quot;chVal&quot;,&quot;chPlayerCharacter&quot;,3);
//createRelTypeTutorshipDom(&quot;chPlayerCharacter&quot;,&quot;chVal&quot;,3);
//State.variables.chPlayerCharacter.charisma.value = 30;
for ( var character of getActiveSimulationCharactersArray() ) {
	gC(character).restoreMood();
}
State.variables.settings.relationshipTypesAllowed = true;
State.variables.settings.followingAllowed = true;
State.variables.settings.challengingAllowed = true;
State.variables.settings.assaultingAllowed = true;
initSocializationPeriodPassionTemple();
/*
//createRelTypeServitudeDom(&quot;chPlayerCharacter&quot;,&quot;chVal&quot;,3);
//		createRelTypeServitudeSub(&quot;chVal&quot;,&quot;chPlayerCharacter&quot;,3);
*/
State.variables.chNash.lust.current = 1;
State.variables.chNash.socialdrive.current = 0;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Map Tests Specifics|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.settings.relationshipTypesAllowed = true;
State.variables.settings.followingAllowed = true;
State.variables.settings.challengingAllowed = true;
State.variables.settings.assaultingAllowed = true;  
initCommandTestsPeriodPassionTemple();
State.variables.chNash.lust.current = 100;
State.variables.chPlayerCharacter.lust.current = 100;
State.variables.chMir.lust.current = 100;
State.variables.chVal.lust.current = 100;
createRelTypeServitudeDom(&quot;chNash&quot;,&quot;chVal&quot;,3);
		createRelTypeServitudeSub(&quot;chVal&quot;,&quot;chNash&quot;,3);
//createRelTypeServitudeDom(&quot;chNash&quot;,&quot;chMir&quot;,3);
//		createRelTypeServitudeSub(&quot;chMir&quot;,&quot;chNash&quot;,3);
		State.variables.chPlayerCharacter.empathy.value = 40;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;



&lt;&lt;set _activeChars to State.variables.activeSimulationCharacters&gt;&gt; \
Active characters: $activeSimulationCharacters

&lt;&lt;link [[Add Artume|Quickstarts]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chArt&quot;) == false ) {
State.variables.chArt = createArtume();
State.variables.activeSimulationCharacters.push(&quot;chArt&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Hope|Quickstarts]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chHope&quot;) == false ) {
State.variables.chHope = createWarmestHope();
State.variables.activeSimulationCharacters.push(&quot;chHope&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Rock|Quickstarts]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chRock&quot;) == false ) {
State.variables.chRock = createSturdiestRock();
State.variables.activeSimulationCharacters.push(&quot;chRock&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Sillan|Quickstarts]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chSil&quot;) == false ) {
State.variables.chSil = createSillan();
State.variables.activeSimulationCharacters.push(&quot;chSil&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Nersmias|Quickstarts]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chNer&quot;) == false ) {
State.variables.chNer = createNersmias();
State.variables.activeSimulationCharacters.push(&quot;chNer&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Mesquelles|Quickstarts]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chMes&quot;) == false ) {
State.variables.chMes = createMesquelles();
State.variables.activeSimulationCharacters.push(&quot;chMes&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Random Female Char|Quickstarts]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.activeSimulationCharacters.push(generateFemaleHumanoidTest());
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Random Male Char|Quickstarts]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.activeSimulationCharacters.push(generateMaleHumanoidTest());
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Random Futa Char|Quickstarts]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.activeSimulationCharacters.push(generateFutaHumanoidTest());
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add All Six|Quickstarts]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chArt&quot;) == false ) {
State.variables.chArt = createArtume();
State.variables.activeSimulationCharacters.push(&quot;chArt&quot;);
}
if ( State.variables.activeSimulationCharacters.includes(&quot;chHope&quot;) == false ) {
State.variables.chHope = createWarmestHope();
State.variables.activeSimulationCharacters.push(&quot;chHope&quot;);
}
if ( State.variables.activeSimulationCharacters.includes(&quot;chRock&quot;) == false ) {
State.variables.chRock = createSturdiestRock();
State.variables.activeSimulationCharacters.push(&quot;chRock&quot;);
}
if ( State.variables.activeSimulationCharacters.includes(&quot;chSil&quot;) == false ) {
State.variables.chSil = createSillan();
State.variables.activeSimulationCharacters.push(&quot;chSil&quot;);
}
if ( State.variables.activeSimulationCharacters.includes(&quot;chNer&quot;) == false ) {
State.variables.chNer = createNersmias();
State.variables.activeSimulationCharacters.push(&quot;chNer&quot;);
}
if ( State.variables.activeSimulationCharacters.includes(&quot;chMes&quot;) == false ) {
State.variables.chMes = createMesquelles();
State.variables.activeSimulationCharacters.push(&quot;chMes&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Go to Settings|Settings]]&gt;&gt;&lt;&lt;script&gt;&gt;State.variables.settings.setExitPassage(&quot;Quickstarts&quot;);
State.variables.settings.formatAllChoices();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Test Gleaming Caverns|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
gC(&quot;chPlayerCharacter&quot;).agility.value = 40;
addToStVarsList(&quot;hddHut&quot;);
testGleamingCaverns();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Change init settings|Quickstarts]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chClaw.baseMood.angry = 0;
State.variables.chAte.baseMood.bored = 0;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Fake period tests|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.settings.relationshipTypesAllowed = true;
State.variables.settings.followingAllowed = true;
State.variables.settings.challengingAllowed = true;
State.variables.settings.assaultingAllowed = true;
initFakePeriodPassionTemple();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Fake period tests x20|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.settings.relationshipTypesAllowed = true;
State.variables.settings.followingAllowed = true;
State.variables.settings.challengingAllowed = true;
State.variables.settings.assaultingAllowed = true;
initFakePeriodPassionTempleXtimes(20);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Fake period tests x60|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.settings.relationshipTypesAllowed = true;
State.variables.settings.followingAllowed = true;
State.variables.settings.challengingAllowed = true;
State.variables.settings.assaultingAllowed = true;
initFakePeriodPassionTempleXtimes(60);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Fake period tests x200|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.settings.relationshipTypesAllowed = true;
State.variables.settings.followingAllowed = true;
State.variables.settings.challengingAllowed = true;
State.variables.settings.assaultingAllowed = true;
initFakePeriodPassionTempleXtimes(200);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Fake period tests x1000|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.settings.relationshipTypesAllowed = true;
State.variables.settings.followingAllowed = true;
State.variables.settings.challengingAllowed = true;
State.variables.settings.assaultingAllowed = true;
initFakePeriodPassionTempleXtimes(1000);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Job Tests|Jobs Screen]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.jobsAssigner.initJobsAssigner();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Personal Room Tests|Personal Room]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.settings.relationshipTypesAllowed = true;
State.variables.settings.followingAllowed = true;
State.variables.settings.challengingAllowed = true;
State.variables.settings.assaultingAllowed = true;  
createRelTypeServitudeDom(&quot;chPlayerCharacter&quot;,&quot;chNash&quot;,3);
createRelTypeServitudeSub(&quot;chNash&quot;,&quot;chPlayerCharacter&quot;,3);
//createRelTypeServitudeDom(&quot;chMir&quot;,&quot;chVal&quot;,3);
//createRelTypeServitudeSub(&quot;chVal&quot;,&quot;chMir&quot;,3);
createRelTypeCompanionship(&quot;chPlayerCharacter&quot;,&quot;chMir&quot;,3);
createRelTypeCompanionship(&quot;chMir&quot;,&quot;chPlayerCharacter&quot;,3);
gC(&quot;chNash&quot;).relations[&quot;chPlayerCharacter&quot;].sexualTension.level = 5;
gC(&quot;chClaw&quot;).relations[&quot;chPlayerCharacter&quot;].sexualTension.level = 5;
gC(&quot;chNash&quot;).relations[&quot;chPlayerCharacter&quot;].romance.level = 12;
gC(&quot;chAte&quot;).relations[&quot;chPlayerCharacter&quot;].enmity.level = 25;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Personal Room Tests Custom|Personal Room]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.settings.relationshipTypesAllowed = true;
State.variables.settings.followingAllowed = true;
State.variables.settings.challengingAllowed = true;
State.variables.settings.assaultingAllowed = true;
createRelTypeCompanionship(&quot;chPlayerCharacter&quot;,&quot;chMir&quot;,3);
createRelTypeCompanionship(&quot;chMir&quot;,&quot;chPlayerCharacter&quot;,3);  
createRelTypeServitudeDom(&quot;chPlayerCharacter&quot;,&quot;chNash&quot;,3);
createRelTypeServitudeSub(&quot;chNash&quot;,&quot;chPlayerCharacter&quot;,3);  
createRelTypeServitudeDom(&quot;chPlayerCharacter&quot;,&quot;chVal&quot;,3);
createRelTypeServitudeSub(&quot;chVal&quot;,&quot;chPlayerCharacter&quot;,3); 
createRelTypeCompanionship(&quot;chPlayerCharacter&quot;,&quot;chClaw&quot;,3);
createRelTypeCompanionship(&quot;chClaw&quot;,&quot;chPlayerCharacter&quot;,3); 
createRelTypeCompanionship(&quot;chPlayerCharacter&quot;,&quot;chAte&quot;,3);
createRelTypeCompanionship(&quot;chAte&quot;,&quot;chPlayerCharacter&quot;,3);  
testRelationScores();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Testing Scenes Room]]&gt;&gt;&lt;&lt;script&gt;&gt; 
	for ( var charKey of [&quot;chPlayerCharacter&quot;,&quot;chNash&quot;,&quot;chMir&quot;,&quot;chClaw&quot;,&quot;chVal&quot;,&quot;chAte&quot;] ) {
		State.variables[charKey].addBodypart(&quot;dick&quot;,&quot;dick&quot;);
	}
	setUpTestScenesRoom();
	State.variables.chVal.saList.push(&quot;denyOrgasm&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Battle Tests Room]]&gt;&gt;&lt;&lt;script&gt;&gt;
	for ( var charKey of [&quot;chPlayerCharacter&quot;,&quot;chNash&quot;,&quot;chMir&quot;,&quot;chClaw&quot;,&quot;chVal&quot;,&quot;chAte&quot;] ) {
		State.variables[charKey].addBodypart(&quot;dick&quot;,&quot;dick&quot;);
	}
	setUpBattleTestsRoom();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Multibattle Test|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
	setUpBattleTestsRoom();
setUpMultiBattleTest();
	State.variables.chNash.energy.current = 3;
	State.variables.chNash.willpower.current = 3;
	State.variables.chNash.control = 1;
State.variables.sc.formatScenePassage();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; Player has equipped dildo
&lt;&lt;link [[Multisex Test|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
	setUpMultiSexTest();
	State.variables.sc.formatScenePassage();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; 
&lt;&lt;link [[Multisex Test 2|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
	var dilID = createEquipment(&quot;w5&quot;,&quot;chPlayerCharacter&quot;);
	equipObjectOnWearer(dilID,&quot;chPlayerCharacter&quot;,-1);
	setUpMultiSexTestAlt();
	State.variables.sc.formatScenePassage();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; Player has equipped dildo

[[Item Tests]]

Story Events Tests

[[First Adventure Tests]]

&lt;&lt;link [[Reached the Swamp|FA ReachedTheSwamp Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
	initializeGleamingCavernsAdventure();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Enters Artume|FA EntersArtume]]&gt;&gt;&lt;&lt;script&gt;&gt;
	initializeGleamingCavernsAdventure();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Another Ambush|FA AnotherAmbush1]]&gt;&gt;&lt;&lt;script&gt;&gt;
	initializeGleamingCavernsAdventure();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Ceased Fire|FA CeasedFire]]&gt;&gt;&lt;&lt;script&gt;&gt;
	initializeGleamingCavernsAdventure();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Test Gleaming Workshops|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
gC(&quot;chPlayerCharacter&quot;).agility.value = 40;
gC(&quot;chPlayerCharacter&quot;).perception.value = 100;
addToStVarsList(&quot;hddHut&quot;);
initializeGleamingCavernsAdventure();
initAdventurePeriodGleamingCaverns();
State.variables.mapGleamingCaverns.placeCharacters([&quot;chPlayerCharacter&quot;],&quot;workshop&quot;);
State.variables.compass.currentRoom = &quot;workshop&quot;;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Test Gleaming Workshops|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
gC(&quot;chNash&quot;).relations.chPlayerCharacter.submission.level = 10;
gC(&quot;chPlayerCharacter&quot;).agility.value = 40;
gC(&quot;chPlayerCharacter&quot;).perception.value = 100;
addToStVarsList(&quot;hddHut&quot;);
initializeGleamingCavernsAdventure();
initAdventurePeriodGleamingCaverns();
State.variables.mapGleamingCaverns.placeCharacters([&quot;chPlayerCharacter&quot;],&quot;workshop&quot;);
State.variables.compass.currentRoom = &quot;workshop&quot;;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; High Nash&#39;s submission
&lt;&lt;link [[Test Gleaming Caverns|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
gC(&quot;chPlayerCharacter&quot;).agility.value = 40;
gC(&quot;chPlayerCharacter&quot;).perception.value = 100;
addToStVarsList(&quot;hddHut&quot;);
initializeGleamingCavernsAdventure();
initAdventurePeriodGleamingCaverns();
State.variables.mapGleamingCaverns.placeCharacters([&quot;chPlayerCharacter&quot;],&quot;cavernMP1&quot;);
State.variables.compass.currentRoom = &quot;cavernMP1&quot;;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; High agility, perception
&lt;&lt;link [[Test Gleaming Caverns|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
gC(&quot;chPlayerCharacter&quot;).agility.value = 10;
gC(&quot;chPlayerCharacter&quot;).empathy.value = 100;
gC(&quot;chPlayerCharacter&quot;).perception.value = 100;
addToStVarsList(&quot;hddHut&quot;);
initializeGleamingCavernsAdventure();
initAdventurePeriodGleamingCaverns();
State.variables.mapGleamingCaverns.placeCharacters([&quot;chPlayerCharacter&quot;],&quot;cavernMP1&quot;);
State.variables.compass.currentRoom = &quot;cavernMP1&quot;;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; High empathy, perception
&lt;&lt;link [[Test Gleaming Caverns|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
gC(&quot;chPlayerCharacter&quot;).agility.value = 10;
gC(&quot;chPlayerCharacter&quot;).empathy.value = 100;
gC(&quot;chPlayerCharacter&quot;).perception.value = 100;
gC(&quot;chPlayerCharacter&quot;).lust.current = 30;
addToStVarsList(&quot;hddHut&quot;);
initializeGleamingCavernsAdventure();
initAdventurePeriodGleamingCaverns();
State.variables.mapGleamingCaverns.placeCharacters([&quot;chPlayerCharacter&quot;],&quot;cavernMP1&quot;);
State.variables.compass.currentRoom = &quot;cavernMP1&quot;;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; High empathy, perception, weakened
&lt;&lt;link [[Test Gleaming Caverns|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
gC(&quot;chPlayerCharacter&quot;).agility.value = 10;
gC(&quot;chPlayerCharacter&quot;).empathy.value = 100;
gC(&quot;chPlayerCharacter&quot;).perception.value = 100;
gC(&quot;chClaw&quot;).lust.current = 10;
addToStVarsList(&quot;hddHut&quot;);
initializeGleamingCavernsAdventure();
initAdventurePeriodGleamingCaverns();
State.variables.mapGleamingCaverns.placeCharacters([&quot;chPlayerCharacter&quot;],&quot;cavernMP1&quot;);
State.variables.compass.currentRoom = &quot;cavernMP1&quot;;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; High empathy, perception, weakened Claw

&lt;&lt;script&gt;&gt;
/*
gC(&quot;chMir&quot;).addBodypart(&quot;dick&quot;,&quot;dick&quot;);
charactersLearnSceneActions([&quot;chPlayerCharacter&quot;,&quot;chMir&quot;,&quot;chNash&quot;,&quot;chClaw&quot;],[&quot;strokePussy&quot;,&quot;strokeBreasts&quot;,&quot;kissLips&quot;,&quot;frottage&quot;,&quot;frenchKiss&quot;,&quot;kneel&quot;,&quot;makeKneel&quot;,&quot;lickGroin&quot;,&quot;legHoldHead&quot;,&quot;mountFromBehind&quot;,&quot;penetratePussy&quot;,&quot;thrust&quot;,&quot;piston&quot;,&quot;finalPush&quot;,&quot;mountFaceToFace&quot;,&quot;getBlowjob&quot;,&quot;suckDick&quot;,&quot;lickPussy&quot;,&quot;interlockLegs&quot;,&quot;scissor&quot;,&quot;strokeAss&quot;,&quot;penetrateAss&quot;,&quot;analThrust&quot;,&quot;holdArms&quot;,&quot;vinesHoldArms&quot;,&quot;dickFootjob&quot;,&quot;pussyFootjob&quot;,&quot;lickLegs&quot;,&quot;rideDick&quot;,&quot;pushDickBack&quot;,&quot;extraMountFromBehind&quot;,&quot;getBlowjob&quot;,&quot;suckDick&quot;,&quot;lickPussy&quot;,&quot;interlockLegs&quot;,&quot;scissor&quot;,&quot;strokeAss&quot;,&quot;penetrateAss&quot;,&quot;analThrust&quot;,&quot;holdArms&quot;,&quot;vinesHoldArms&quot;,&quot;dickFootjob&quot;,&quot;pussyFootjob&quot;,&quot;lickLegs&quot;,&quot;rideDick&quot;,&quot;pushDickBack&quot;,&quot;extraMountFromBehind&quot;,&quot;extraKneel&quot;,&quot;extraMakeKneel&quot;,&quot;extraLegHoldHead&quot;,&quot;giveCunnilingus&quot;,&quot;giveBlowjob&quot;]);
*/
&lt;&lt;/script&gt;&gt;

Transformation Scenes Tests

&lt;&lt;link [[Tf Scene Test 1|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startTfScene(&quot;ss&quot;, &quot;dynamic&quot;,	[&quot;chPlayerCharacter&quot;], [&quot;chVal&quot;], &quot;Stuff&quot;,	isTfSceneFinished, 0, &quot;Quickstarts&quot;,
										[&quot;addDick&quot;,&quot;rebuildFigure&quot;], [&quot;chVal&quot;],&quot;chPlayerCharacter&quot;, 5,false,3,&quot;none&quot;);

State.variables.sc.customScript = debugTfSceneData;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; Val vs Player Character, [Add dick, Rebuild Figure], 3 points
&lt;&lt;link [[Tf Scene Test 2|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startTfScene(&quot;ss&quot;, &quot;dynamic&quot;,	[&quot;chPlayerCharacter&quot;], [&quot;chVal&quot;], &quot;Stuff&quot;,	isTfSceneFinished, 0, &quot;Quickstarts&quot;,
										[&quot;rebuildFace&quot;,&quot;removeBreasts&quot;,&quot;rebuildFigure&quot;,&quot;removeDick&quot;,&quot;addPussy&quot;,&quot;removePussy&quot;],[&quot;chPlayerCharacter&quot;], &quot;chVal&quot;, 5,false,3,&quot;none&quot;);
										gC(&quot;chPlayerCharacter&quot;).race = &quot;shapeshifter&quot;;
										charactersLearnSceneActions([&quot;chPlayerCharacter&quot;],[&quot;slimeHug&quot;]);
										gC(&quot;chVal&quot;).addBodypart(&quot;dick&quot;,&quot;dick&quot;);

State.variables.sc.customScript = debugTfSceneData;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; Player vs Val, [Rebuild Face,Rebuild Figure,Add Dick], 5 points
&lt;&lt;link [[Tf Scene Test 3|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startTfScene(&quot;ss&quot;, &quot;dynamic&quot;,	[&quot;chPlayerCharacter&quot;], [&quot;chVal&quot;], &quot;Stuff&quot;,	isTfSceneFinished, 0, &quot;Quickstarts&quot;,
										[&quot;rebuildFace&quot;,&quot;rebuildFigure&quot;,&quot;addDick&quot;],[&quot;chVal&quot;], &quot;chPlayerCharacter&quot;, 5,false,5,&quot;none&quot;);
										charactersLearnSceneActions([&quot;chVal&quot;],[&quot;slimeHug&quot;]);
gC(&quot;chVal&quot;).addBodypart(&quot;dick&quot;,&quot;dick&quot;);
gC(&quot;chVal&quot;).aiAlgorythm = createAiWeightedMissionsByTaste();
State.variables.sc.customScript = debugTfSceneData;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; Val vs Player Character, [Rebuild Face, Rebuild Figure, Add Dick], 5 points

- &lt;&lt;link [[Tf Scene Test 1 N|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startTfScene(&quot;ss&quot;, &quot;dynamic&quot;,	[&quot;chPlayerCharacter&quot;], [&quot;chNash&quot;], &quot;Stuff&quot;,	isTfSceneFinished, 0, &quot;Quickstarts&quot;,
										[&quot;rebuildFace&quot;,&quot;rebuildFigure&quot;,&quot;addDick&quot;,&quot;removePussy&quot;],[&quot;chPlayerCharacter&quot;], &quot;chNash&quot;, 1,false,2,&quot;masculinize&quot;);
										
gC(&quot;chNash&quot;).aiAlgorythm = createAiWeightedMissionsByTaste();
State.variables.sc.customScript = debugTfSceneData;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; Player applies gender bender on Nash Tests, [Add dick, remove pussy, rebuild face, rebuild figure] (Masculinize), 1 point
- &lt;&lt;link [[Tf Scene Test 2 N|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startTfScene(&quot;ss&quot;, &quot;dynamic&quot;,	[&quot;chPlayerCharacter&quot;], [&quot;chVal&quot;], &quot;Stuff&quot;,	isTfSceneFinished, 0, &quot;Quickstarts&quot;,
										[&quot;rebuildFace&quot;,&quot;rebuildFigure&quot;,&quot;addDick&quot;,&quot;removePussy&quot;],[&quot;chVal&quot;], &quot;chPlayerCharacter&quot;, 4,false,4,&quot;&quot;,&quot;img/portraits/mc2-avatar.png&quot;,&quot;img/portraits/mc2-full.png&quot;);
										
gC(&quot;chVal&quot;).aiAlgorythm = createAiWeightedMissionsByTaste();
State.variables.sc.customScript = debugTfSceneData;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; Valtan changes PC&#39;s appeareance, temporary futanari transformation (Temp: Remove pussy), [Rebuild Face, Rebuild Figure, Add Dick, Remove Pussy], 4 points

&lt;&lt;link [[Shortcut to Tf Menu Tests|FASE MorphHut MorphMenu]]&gt;&gt;&lt;&lt;script&gt;&gt;initializeGleamingCavernsAdventure();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; (Will eventually break)</tw-passagedata><tw-passagedata pid="7" name="Scene Tests Dialog Box" tags="" position="751,13" size="100,100">&lt;&lt;set $actionDescription to &quot;&quot;&gt;&gt; \
&lt;&lt;script&gt;&gt;State.variables.actionDescription = &quot;__&quot; + setup.saList[State.variables.sc.pcChosenAction].name + &quot;__\n&quot;;
State.variables.actionDescription += setup.saList[State.variables.sc.pcChosenAction].description&lt;&lt;/script&gt;&gt; \
$actionDescription</tw-passagedata><tw-passagedata pid="8" name="Scene IsActionUsable Box" tags="" position="872,11" size="100,100">$sc.isPcActionValid.explanation</tw-passagedata><tw-passagedata pid="9" name="Character Info Dialog Box" tags="" position="989,10" size="100,100">&lt;&lt;set $charInfoBoxText to &quot;a&quot;&gt;&gt; \
&lt;&lt;script&gt;&gt;
State.variables.charInfoBoxText = State.variables[State.variables.charScreenFocus].getCharacterScreenInfo();
&lt;&lt;/script&gt;&gt; \
$charInfoBoxText </tw-passagedata><tw-passagedata pid="10" name="GoddessHerald 4" tags="" position="318,142" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chGoddessHerald&quot;)]);
&lt;&lt;/script&gt;&gt; \
&lt;&lt;set $StVars.gh1 to 0&gt;&gt; \
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Ah, such sweet lips...&quot;//&lt;/span&gt;

The intriguing hunter&#39;s hands explore your back...

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I&#39;m just wondering...&quot;//&lt;/span&gt;

...your legs...

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;How much sweeter...&quot;//&lt;/span&gt;

...your thighs...

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Are your other lips?&quot;//&lt;/span&gt;

&lt;&lt;if $settings.futa == &quot;enableAll&quot;&gt;&gt; \
[[&#39;I love this... I want more&#39;|GoddessHerald 5][$StVars.gh1 to 1]]
&lt;&lt;elseif $settings.futa == &quot;disableMainStory&quot;&gt;&gt; \
[[&#39;I love this... I want more&#39;|GoddessHerald 5][$StVars.gh1 to 1]]
&lt;&lt;else&gt;&gt; \
[[&#39;I love this... I want more&#39;|GoddessHerald 5b][$StVars.gh1 to 1]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $chPlayerCharacter.willpower.current &gt; 55&gt;&gt; \
[[&#39;&quot;Wait... This is going too fast&quot;&#39;|GoddessHerald 5][$StVars.gh1 to 2]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You need more willpower to unlock this choice.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $chPlayerCharacter.willpower.current &gt; 65&gt;&gt; \
[[&#39;&quot;What am I doing!? Stop already!&quot;&#39;|GoddessHerald 5][$StVars.gh1 to 3]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You need more willpower to unlock this choice.
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="11" name="GoddessHerald 5" tags="" position="428,137" size="100,100">&lt;&lt;set $StVars.gh2 to 0&gt;&gt;&lt;&lt;if $StVars.gh1 == 1&gt;&gt; \
However, just as she&#39;s about to stick her fingers inside you, she stops. She stops and walks back, her tail playfully swinging around.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Yes, I can see you want me to take you.&quot;//&lt;/span&gt;

She makes a strange gesture with her arms, painting a grand circle with her hands around herself.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;And I will take you as properly as you deserve for your first time.&quot;//&lt;/span&gt;

Once her hands are at the top of her head, they start emitting a beautiful, clear light. She moves them to her groin, and something starts to grow...
Brief moments later, the light dispels, allowing you to see that she has grown a cock.
Her eyes, once again, strike at yours, glowing purple.
//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower&lt;/span&gt;.//&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.willpower.changeValue(-10);
State.variables.chGoddessHerald.addBodypart(&quot;dick&quot;,&quot;dick&quot;);&lt;&lt;/script&gt;&gt;

&lt;&lt;link [[&#39;Your legs are trembling. Your strength fails you. You surrender to her&#39;|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startScene(
&quot;ss&quot;, &quot;fixed&quot;,
[&quot;chPlayerCharacter&quot;], [&quot;chGoddessHerald&quot;],
&quot;The mist extends in all directions...&quot;,
ghFutaFuckEndCondition, 10,
&quot;GoddessHerald 6a&quot;);
State.variables.chGoddessHerald.hasLead = &quot;true&quot;;
State.variables.sc.sceneConditions.push(&quot;cantCancelActions&quot;);
State.variables.sc.sceneConditions.push(&quot;cantCancelPositions&quot;);
State.variables.chGoddessHerald.aiAlgorythm = createAiActionSequence();
State.variables.chGoddessHerald.aiAlgorythm.actionSequence = [&quot;frottage&quot;,&quot;mountFromBehind&quot;,&quot;penetratePussy&quot;,&quot;thrust&quot;,&quot;thrust&quot;,&quot;thrust&quot;,&quot;piston&quot;,&quot;piston&quot;];
State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = &quot;chPlayerCharacter&quot;;
State.variables.StVars.gh1 = 1;
State.variables.sc.enabledDialogues = false;
State.variables.sc.customScript = cssGhFutaFuck;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;if $chPlayerCharacter.willpower.current &gt; 55 &gt;&gt; \
[[&#39;&quot;Wait! I back down! I don&#39;t want this anymore!&quot;&#39;|GoddessHerald 6b][$StVars.gh1 to 2]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You need more willpower to unlock this choice.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.gh1 == 2&gt;&gt; \
You step back, putting your hands between you both. You feel a flash of resolve passing through your mind, and you attempt to regain some control.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wait, please... This is going too fast.&quot;//&lt;/span&gt;
//You gained &lt;span style=&quot;color:darkslateblue&quot;&gt;5 willpower&lt;/span&gt;.//&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.willpower.changeValue(5);&lt;&lt;/script&gt;&gt;

//What is this place again?//

The woman shows some light annoyance on her expression, but it quickly fades away. Her eyes don&#39;t stop looking at yours.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Yes, I know you&#39;re young and you lack experience. You probably don&#39;t even fully understand what&#39;s happening.&quot;//&lt;/span&gt;
//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower&lt;/span&gt;.//&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.willpower.changeValue(-10);&lt;&lt;/script&gt;&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;But that&#39;s fine... I&#39;m here to help you grow and become a woman. Let&#39;s take it slowly then. Do you want me to teach you how to pleasure someone, or do you want me to teach you what&#39;s pleasure?&quot;//&lt;/span&gt;

&lt;&lt;link [[&#39;&quot;I will pleasure you.&quot;&#39;|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startScene(
&quot;ss&quot;, &quot;fixed&quot;,
[&quot;chPlayerCharacter&quot;], [&quot;chGoddessHerald&quot;],
&quot;The mist extends in all directions...&quot;,
ghFutaFuckEndCondition, 10,
&quot;GoddessHerald 6d&quot;);
State.variables.sc.sceneConditions.push(&quot;cantCancelActions&quot;);
State.variables.sc.sceneConditions.push(&quot;cantCancelPositions&quot;);
State.variables.chGoddessHerald.aiAlgorythm = createAiActionSequence();
State.variables.chGoddessHerald.aiAlgorythm.actionSequence = [&quot;makeKneel&quot;,&quot;strokeBreasts&quot;,&quot;hypnoticGlance&quot;,&quot;strokePussy&quot;,&quot;strokeBreasts&quot;,&quot;legHoldHead&quot;];
State.variables.chGoddessHerald.hasLead = &quot;true&quot;;
State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = &quot;chPlayerCharacter&quot;;
State.variables.StVars.gh1 = 1;
State.variables.sc.enabledDialogues = false;
State.variables.sc.customScript = cssGhKneeling;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[&#39;&quot;I... want you to pleasure me.&quot;&#39;|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startScene(
&quot;ss&quot;, &quot;fixed&quot;,
[&quot;chPlayerCharacter&quot;], [&quot;chGoddessHerald&quot;],
&quot;The mist extends in all directions...&quot;,
playerOrgasmEndCondition, 10,
&quot;GoddessHerald 6c&quot;);
State.variables.chGoddessHerald.hasLead = &quot;true&quot;;
State.variables.sc.enabledDialogues = false;
State.variables.sc.sceneConditions.push(&quot;cantCancelActions&quot;);
State.variables.sc.sceneConditions.push(&quot;cantCancelPositions&quot;);
State.variables.chGoddessHerald.aiAlgorythm = createAiActionSequence();
State.variables.chGoddessHerald.aiAlgorythm.actionSequence = [&quot;kneel&quot;,&quot;lickGroin&quot;,&quot;lustfulGlance&quot;,&quot;lickGroin&quot;,&quot;lustfulGlance&quot;,&quot;lickGroin&quot;];
State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = &quot;chPlayerCharacter&quot;;
State.variables.sc.customScript = ccsGhStanding;
State.variables.StVars.gh1 = 2;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;if $chPlayerCharacter.willpower.current &gt; 60&gt;&gt; \
[[&#39;&quot;Nothing at all!&quot;&#39;|GoddessHerald 6e][$StVars.gh1 to 3]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You need more willpower to unlock this choice.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.gh1 == 3&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wait, wait. I wasn&#39;t thinking clearly. I don&#39;t want this.&quot;//&lt;/span&gt;

The crimson woman frowns. She strikes your eyes with hers, once again, trying to charm you,
//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;5 willpower&lt;/span&gt;.//&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.willpower.changeValue(-5);&lt;&lt;/script&gt;&gt;
but you avert her gaze and push her back.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Huh, you play that hard to get? Fine.&quot;//&lt;/span&gt;

She appears to have given up, and she turns her back and starts to leave. But she stops and turns her head towards you once more.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;That attitude of yours... Will serve you little where you&#39;re going. The sooner your swallow it, the less painful your fall.&quot;//&lt;/span&gt;
&lt;&lt;set $StVars.ghAnnoyed to true&gt;&gt; \

[[&#39;And then you open your eyes&#39;|FirstDay 0]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="12" name="GoddessHerald 6a" tags="" position="639,141" size="100,100">&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;That was wonderful, my dear.&quot;//&lt;/span&gt;

You&#39;re gasping exhausted. The only reason you don&#39;t fall to your feet is because she&#39;s holding you. You feel her slowly taking her member out of you.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Yes, you will fit just fine there. I&#39;ll make sure to see you making it to the end.&quot;//&lt;/span&gt;

//What are you talking about?//

The questions flow through your mind, but you don&#39;t have enough energy to actually get them through your lips.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;My time here is running short. Believe me If I say it&#39;s a pity, I was just getting started with you.&quot;//&lt;/span&gt;

A chill runs through your back. A chill charged with excitement, fear and your newfound lust.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I&#39;ll see you soon... Look forward to it.&quot;//&lt;/span&gt;
&lt;&lt;set $StVars.ghAnnoyed to false&gt;&gt; \

[[&#39;And then you open your eyes&#39;|FirstDay 0]]</tw-passagedata><tw-passagedata pid="13" name="Scene" tags="sc" position="1277,136" size="100,100">$sc.scenePassage</tw-passagedata><tw-passagedata pid="14" name="GoddessHerald 6b" tags="" position="742,145" size="100,100">&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Oh?&quot;//&lt;/span&gt;

Surprise engulfs her face.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Hahahaha!&quot;//&lt;/span&gt;

And she suddenly starts to laugh in disbelief.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;It wouldn&#39;t have surprised me that you were a scaredy cat. What I didn&#39;t expect was that you&#39;d become a scaredy cat just because you saw some dick!&quot;//&lt;/span&gt;

She contains a bit of her laughter when she finds you don&#39;t share her sense of humor, and then turns it into a mischieving grin.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;It&#39;s fine, it&#39;s fine. You&#39;re not yet ready for this, you&#39;re a late blossomer.&quot;//&lt;/span&gt;

She approaches you and caresses your face. She leans in, and kisses your lips.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I&#39;ll take the fruit when it&#39;s ripe then. Look forward to meet me again.&quot;//&lt;/span&gt;
&lt;&lt;set $StVars.ghAnnoyed to false&gt;&gt; \

[[&#39;And then you open your eyes&#39;|FirstDay 0]]</tw-passagedata><tw-passagedata pid="15" name="GoddessHerald 6e" tags="" position="1063,138" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wait, wait. I wasn&#39;t thinking clearly. I don&#39;t want this.&quot;//&lt;/span&gt;

The crimson woman frowns. She strikes your eyes with hers, once again, trying to charm you,
//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;5 willpower&lt;/span&gt;.//&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.willpower.changeValue(-5);&lt;&lt;/script&gt;&gt;
but you avert her gaze and push her back.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Huh, you play that hard to get? Fine.&quot;//&lt;/span&gt;

She appears to have given up, and she turns her back and starts to leave. But she stops and turns her head towards you once more.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;That attitude of yours... Will serve you little where you&#39;re going. The sooner your swallow it, the less painful your fall.&quot;//&lt;/span&gt;
&lt;&lt;set $StVars.ghAnnoyed to true&gt;&gt; \

[[&#39;And then you open your eyes&#39;|FirstDay 0]]</tw-passagedata><tw-passagedata pid="16" name="GoddessHerald 6c" tags="" position="846,140" size="100,100">Sparks vibrate all around your skin - your legs, your abdomen, your back, your chest and your throat. And then you feel numb. It&#39;s as If the world - or whatever there&#39;s left of it, had stopped all around and you were one with non-existance. Until you get called out of it.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I see you&#39;re enjoying your first orgasm.&quot;//&lt;/span&gt;

She says with a mischievous grin. She&#39;s now standing in front of you, her face relatively close to yours.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I have more, waiting for you...&quot;//&lt;/span&gt;

The woman closes in and licks your lips, then locks her own with yours for a moment, and retreats.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;But you&#39;ll have to be a good girl to earn them. My time is running short now, but I&#39;ll come back for you. Look forward to it.&quot;//&lt;/span&gt;
&lt;&lt;set $StVars.ghAnnoyed to false&gt;&gt; \

[[&#39;And then you open your eyes&#39;|FirstDay 0]]</tw-passagedata><tw-passagedata pid="17" name="GoddessHerald 6d" tags="" position="954,140" size="100,100">&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Hhnnn... Uaaah...&quot;//&lt;/span&gt; she moans.

She takes some seconds to recover, and then she releases your head, only to lock your sight in her eyes. There&#39;s something in her that compels you to remain quiet, to stay on your knees, to respect her gaze.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;That was wonderful. Am I not lucky to find a treasure such as you?&quot;//&lt;/span&gt;

The woman pats your head, satisfied.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I have to leave soon, my time is running short. But don&#39;t worry, my dear, be a good girl and you&#39;ll get a good taste of what this tastes like, when I come back... Look forward to it.&quot;//&lt;/span&gt;
&lt;&lt;set $StVars.ghAnnoyed to false&gt;&gt; \

[[&#39;And then you open your eyes&#39;|FirstDay 0]]</tw-passagedata><tw-passagedata pid="18" name="FirstDay 0" tags="saveAllowed" position="1041,811" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([]);
&lt;&lt;/script&gt;&gt; \
And you see leather. Leather above you, and leather to the sides of your room. Around yourself, wool surrounds you. You&#39;re in a wool sleeping bag, placed inside a camping tent.

And then it hits you - you aren&#39;t at home: you&#39;re travelling to the Passion Temple accompanied by your tribe&#39;s elder and some warriors. You&#39;ll reach it today, and your training as the High Priestess Candidate will begin. ...Not yours alone, but the training of every Candidate.

//Wait, what if they don&#39;t like me?//

Each of the six tribes will be sending their own Candidate, and only one of them will be chosen High Priestess. It&#39;s a great honor for a tribe to get their Candidate to win. It&#39;s a responsibility that comes with great trust and hopes.

//Wait, what If I don&#39;t win and my tribe doesn&#39;t like me anymore!?//

The training lasts for several months, perhaps for even longer than a year. During that time, each of the Candidates develops every aspect of their being: from physique and intellect to beauty and charms, and they may often challenge each other to test their progress in each of the Holy Arts: combat, magic and sex.

//WAIT, NO! I FORGOT ABOUT THE SEX! I CAN&#39;T DO THIS!//

Are you seriously telling me you forgot about the sex? Immediately after dreaming about having that much fun with that charming woman?

//Shut, shut up!//

[[In any case, it&#39;s about time for you to wake up and wash your face|FirstDay Save Tent]]
&lt;&lt;set $StVars.firstDayTuto to false&gt;&gt; \</tw-passagedata><tw-passagedata pid="19" name="StoryRightSidebar" tags="" position="354,17" size="100,100">&lt;&lt;script&gt;&gt;refreshUIbars()&lt;&lt;/script&gt;&gt; \
$rightUIbarText </tw-passagedata><tw-passagedata pid="20" name="Tests" tags="" position="1141,29" size="100,100">&lt;&lt;script&gt;&gt;
charFollowsChar(&quot;chMir&quot;,&quot;chPlayerCharacter&quot;);
charLosesFollowers(&quot;chPlayerCharacter&quot;);
charFollowsChar(&quot;chMir&quot;,&quot;chClaw&quot;);
charFollowsChar(&quot;chNash&quot;,&quot;chClaw&quot;);
charFollowsChar(&quot;chVal&quot;,&quot;chClaw&quot;);
charUnfollowsChar(&quot;chNash&quot;,&quot;chClaw&quot;);
&lt;&lt;/script&gt;&gt; \

&lt;div class=&quot;standardBox&quot;&gt;ManysCosasXEXEXEXE&lt;/div&gt;

&lt;html&gt;

&lt;button type=&quot;button&quot;
onclick=&quot;document.getElementById(&#39;DynamicText&#39;).innerHTML = &#39;Stuff&#39;&quot;&gt;
Click me to display Date and Time.&lt;/button&gt;

&lt;p id=&quot;DynamicText&quot;&gt;&lt;/p&gt;

&lt;/html&gt; 

&lt;&lt;listbox &quot;$lbanswer&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Towel&quot;&gt;&gt;
	&lt;&lt;option &quot;π&quot; 3.14159&gt;&gt;
	&lt;&lt;option 42&gt;&gt;
	&lt;&lt;option 69&gt;&gt;
	&lt;&lt;option &quot;∞&quot; Infinity&gt;&gt;
&lt;&lt;/listbox&gt;&gt;

&lt;input type=&quot;radio&quot; id=&quot;male&quot; name=&quot;gender&quot; value=&quot;male&quot;&gt;
  &lt;label for=&quot;male&quot;&gt;Male&lt;/label&gt;&lt;br&gt;
  &lt;input type=&quot;radio&quot; id=&quot;female&quot; name=&quot;gender&quot; value=&quot;female&quot;&gt;
  &lt;label for=&quot;female&quot;&gt;Female&lt;/label&gt;&lt;br&gt;
  &lt;input type=&quot;radio&quot; id=&quot;other&quot; name=&quot;gender&quot; value=&quot;other&quot;&gt;
  &lt;label for=&quot;other&quot;&gt;Other&lt;/label&gt;
  
&lt;html&gt;
&lt;input type=&quot;radio&quot; id=&quot;male&quot; name=&quot;gender&quot; value=&quot;male&quot;&gt;
  &lt;label for=&quot;male&quot;&gt;Male&lt;/label&gt;&lt;br&gt;
  &lt;input type=&quot;radio&quot; id=&quot;female&quot; name=&quot;gender&quot; value=&quot;female&quot;
  onclick=&quot;document.getElementById(&#39;DynamicText&#39;).innerHTML = &#39;Gorgeous Stuff&#39;&quot;&gt;
  &lt;label for=&quot;female&quot;&gt;Female&lt;/label&gt;&lt;br&gt;
  &lt;input type=&quot;radio&quot; id=&quot;other&quot; name=&quot;gender&quot; value=&quot;other&quot;&gt;
  &lt;label for=&quot;other&quot;&gt;Other&lt;/label&gt;
&lt;/html&gt;



&lt;&lt;link [[Mir To Val|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
stHyInitMirToVal();
State.variables.chVal.addBodypart(&quot;dick&quot;,&quot;dick&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Player To Val|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chVal.addBodypart(&quot;dick&quot;,&quot;dick&quot;);
teachBasicMovesToCharacters(&quot;chPlayerCharacter&quot;);
stHyInitPlToVal();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Val To Player|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt; 
State.variables.chVal.addBodypart(&quot;dick&quot;,&quot;dick&quot;);
State.variables.chPlayerCharacter.addBodypart(&quot;dick&quot;,&quot;dick&quot;);
teachBasicMovesToCharacters(&quot;chPlayerCharacter&quot;);
stHyInitValToPl();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Mir surrounded|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chVal.addBodypart(&quot;dick&quot;,&quot;dick&quot;);
State.variables.chMir.addBodypart(&quot;dick&quot;,&quot;dick&quot;);
State.variables.chPlayerCharacter.addBodypart(&quot;dick&quot;,&quot;dick&quot;);
teachBasicMovesToCharacters(&quot;chPlayerCharacter&quot;);
stHyInitSpitroast();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;


&lt;&lt;link [[Global AI Tests|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
initTrainingPeriodPassionTempleTests();
for ( var character of getActiveSimulationCharactersArray() ) {
	gC(character).restoreMood();
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

[[Pathfinder Tests]]

&lt;&lt;link [[Try Social Interactions|Social Interactions]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.compass.createNewSis([&quot;chPlayerCharacter&quot;,&quot;chVal&quot;,&quot;chNash&quot;]);
State.variables.chNash.body.arms.state = &quot;locked&quot;;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; ( Temporary test for Social Interactions System with more than 2 characters, &quot;Leave conversation&quot; option will not work)

[-[Tests-]]
[[Tests2]]</tw-passagedata><tw-passagedata pid="21" name="FirstDay 1" tags="" position="525,253" size="100,100">When you leave your tent, the last sun rays of dawn bathe your face. The Sun has almost finished waking up, and the distinctive colors of early morning won&#39;t be back until tomorrow.

Some warriors are gossiping about some family matters that matter little to you, so you quietly walk past them, expecting them not to notice you, until you reach the elder&#39;s tent. When you enter, he&#39;s... drinking.

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Ah, it&#39;s none other than $chPlayerCharacter.name! You didn&#39;t sleep in today!&quot;//&lt;/span&gt;

//Not the kindest of sights.//

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Come in, come in. I bet the jitters are finally eating you. Thank them you&#39;ll be fully awake when you reach the Temple! Hraa-haaa!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Greetings, elder.&quot;//&lt;/span&gt;

The old man isn&#39;t the tidiest person early in the morning. His overweight, the partial lack of clothes and the general effects of alcohol all play a part in building a grotesque view. It&#39;s hard to avoid being aware of it, but he probably just doesn&#39;t care.

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Yes, yes, I know, you&#39;ve come to inhale confidence straight from my wise words. Well, the truth is that you have nothing to worry about!&quot;//&lt;/span&gt;

//The elder is known as a great orator. Despite everything, this should be positive. In some way.//

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;After all, it&#39;s basically impossible for you to win, so why worry about it at all? We simple humans can&#39;t compete against those... AiiSHEEN in magic, or against beastkin in brute force. I know people back in the tribe cheered you tons, but we all know it&#39;s a long shot anywa*HIP*y.&quot;//&lt;/span&gt;

//Ugh.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Well, we have had High Priestesses from our tribe before, and the Ashwalker Candidate won two generations ago.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Oh, $chPlayerCharacter.name, they aren&#39;t exactly...&quot;//&lt;/span&gt;, he notices your angry expression, then corrects his own words, &lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;yes, they ARE human, but they aren&#39;t exactly like us. Those... people put their kids to fight each other since they&#39;re little kids! What could you... ANY Gaanidan possibly do against that?&quot;//&lt;/span&gt;

A tense silence follows.

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;In any case... Even if you don&#39;t win it doesn&#39;t mean this is going to be a bad experience. Just go there and have fun! Maybe you&#39;ll learn something useful too. But above all you should have fun!&quot;//&lt;/span&gt;

[[&quot;I have some questions.&quot;|FirstDay 2a]]
[[&quot;I think I should go.&quot;|FirstDay 2b]]
&lt;&lt;set $StVars.firstDayElderA to 0&gt;&gt; \
&lt;&lt;set $StVars.firstDayWashed to false&gt;&gt;</tw-passagedata><tw-passagedata pid="22" name="FirstDay Save Tent" tags="saveAllowed" position="179,252" size="100,100">&lt;&lt;if $StVars.firstDayTuto is false&gt;&gt; \
&lt;span style=&quot;color:springgreen&quot;&gt;You were completely healed.&lt;/span&gt;
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.restoreBars();
State.variables.chPlayerCharacter.virginities.pussy.clean();
&lt;&lt;/script&gt;&gt; \

&lt;span style=&quot;color:Khaki&quot;&gt;Tutorial: It isn&#39;t always possible to save the game. Whenever it is, you will be notified. Places where it&#39;s possible to sleep are likely to be places where you&#39;re allowed to save.

&lt;/span&gt;&lt;&lt;/if&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;You can save the game!&lt;/span&gt;

You&#39;re at your tent in a temporary campment. It won&#39;t be long before you have to leave to the Passion Temple. You should get dressed and talk to your tribe&#39;s elder before you leave.

&lt;&lt;if $StVars.firstDayTuto is false&gt;&gt; \
[[Get ready for the day|CharCust 0]]
&lt;&lt;set $StVars.firstDayTuto to true&gt;&gt; \
&lt;&lt;set $StVars.firstDayWashed to false&gt;&gt; \
&lt;&lt;set $StVars.firstDayTalkedToElder to false&gt;&gt; \
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.firstDayWashed is true&gt;&gt; \
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.lust.restore();
State.variables.chPlayerCharacter.willpower.restore();
&lt;&lt;/script&gt;&gt; \
You have refreshed yourself.

[[Go find the elder|FirstDay 1]] \
&lt;&lt;/if&gt;&gt; \
\
&lt;&lt;if $StVars.firstDayElderA gt -1&gt;&gt; \
[[Rest for the last time before leaving|FirstDay 5]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="23" name="CharCust 0" tags="" position="299,253" size="100,100">You dress yourself and get your personal belongings ready. You look at yourself in your small hand mirror for the last time, meditating about your life until now.

&lt;&lt;set $StVars.temp to &quot;red&quot;&gt;&gt; \
Choose your character&#39;s color. It will affect her displayed name and spoken lines.
&lt;label&gt;&lt;&lt;radiobutton &quot;$StVars.temp&quot; &quot;red&quot; checked&gt;&gt; &lt;span style=&quot;color:red&quot;&gt;Red&lt;/span&gt;&lt;/label&gt;
&lt;label&gt;&lt;&lt;radiobutton &quot;$StVars.temp&quot; &quot;pink&quot;&gt;&gt; &lt;span style=&quot;color:pink&quot;&gt;Pink&lt;/span&gt;&lt;/label&gt;
&lt;label&gt;&lt;&lt;radiobutton &quot;$StVars.temp&quot; &quot;yellow&quot;&gt;&gt; &lt;span style=&quot;color:yellow&quot;&gt;Yellow&lt;/span&gt;&lt;/label&gt;
&lt;label&gt;&lt;&lt;radiobutton &quot;$StVars.temp&quot; &quot;violet&quot;&gt;&gt; &lt;span style=&quot;color:violet&quot;&gt;Violet&lt;/span&gt;&lt;/label&gt;
&lt;label&gt;&lt;&lt;radiobutton &quot;$StVars.temp&quot; &quot;lime&quot;&gt;&gt; &lt;span style=&quot;color:lime&quot;&gt;Green&lt;/span&gt;&lt;/label&gt;
&lt;label&gt;&lt;&lt;radiobutton &quot;$StVars.temp&quot; &quot;aqua&quot;&gt;&gt; &lt;span style=&quot;color:aqua&quot;&gt;Blue&lt;/span&gt;&lt;/label&gt;
&lt;label&gt;&lt;&lt;radiobutton &quot;$StVars.temp&quot; &quot;mediumblue&quot;&gt;&gt; &lt;span style=&quot;color:mediumblue&quot;&gt;Dark Blue&lt;/span&gt;&lt;/label&gt;



&lt;&lt;link [[Move on|CharCust 1]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.setColors(State.variables.StVars.temp,State.variables.StVars.temp);
State.variables.StVars.pcMainBoon = 1;
State.variables.StVars.pcBoon = 2;
State.variables.StVars.pcMainDoom = 1;
State.variables.StVars.pcDoom = 2;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \</tw-passagedata><tw-passagedata pid="24" name="CharCust 1" tags="" position="410,253" size="100,100">&lt;&lt;script&gt;&gt;State.variables.StVars.temp = returnAssignTalentsScript();&lt;&lt;/script&gt;&gt; \
Looking back at your life, you can&#39;t help but wonder: //Is there anything I excel at? What are my weaknesses?// Knowing the answers to these questions may help you in the days to come.

&lt;span style=&quot;color:Khaki&quot;&gt;Tutorial: Assign your boon and weakness points to any skills you want to. These points do not only increase and decrease those skills, but the ratio at which they raise as well. These boons and weaknesses may stack or nullify each other.&lt;/span&gt;

Major boon: $selectStatListBoxes[0]
Minor boon: $selectStatListBoxes[1]
Minor boon: $selectStatListBoxes[2]
Major weakness: $selectStatListBoxes[3]
Minor weakness: $selectStatListBoxes[4]
Minor weakness: $selectStatListBoxes[5]

&lt;span style=&quot;color:Khaki&quot;&gt;Stats descriptions:&lt;/span&gt;
- __Physique__: The capacity of a character to exert physical strength. Used for many physical activities and taxing sexual actions. Raises lust and energy.
- __Agility__: The ability of a character to execute tasks that require precision. Used for many sexual actions, and often used to evade physical attacks. Raises lust and energy.
- __Resilience__: The capacity of a character to resist exhausting physical work and hits. Most commonly used to resist physical attacks and intense sexual pleasure. Raises lust and energy.
- __Will__: Indicates the mental resilience of a character. Often used to resist temptations and evade magical attacks, sometimes useful to cast magic. Raises lust and willpower.
- __Intelligence__: Refers to the strength of the mind. Most commonly used to cast complex, precise magic. Raises lust and willpower.
- __Perception__: The capacity of a character to detect movements and sounds that would otherwise be ignored. Often useful to evade attacks. Raises lust and willpower.
- __Empathy__: Indicates the ability of a character to understand the feelings and motivations of others. Most useful during socialization, also serves to resist social attacks. Raises lust and social drive.
- __Charisma__: Refers to the ability of a character to get the most out of their expressions. Most useful during socialization, and it also powers social attacks. Raises lust and social drive.
- __Luck__: In a world where everything is connected by aether, luck refers to the harmony of a character with all elements of the world. Improves in very small amounts your dealt sexual pleasure, damage, chances to land or evade attacks, and success during socialization.

&lt;span style=&quot;color:Khaki&quot;&gt;Tutorial: You may check these descriptions again by placing your cursor over a stat&#39;s name on any character&#39;s Status screen.&lt;/span&gt;

&lt;&lt;link [[Confirm selections and move on|FirstDay Save Tent]]&gt;&gt;&lt;&lt;script&gt;&gt;
applyPcStatBonusesWeaknesses();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;set $StVars.firstDayWashed to true&gt;&gt; \</tw-passagedata><tw-passagedata pid="25" name="FirstDay 2a" tags="" position="636,253" size="100,100">&lt;&lt;if $StVars.firstDayElderA is 0&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Anyway.&quot;//&lt;/span&gt;, you try to change the course of the conversation. There are some doubts you need to clear and the elder may help to solve them. //Maybe.// &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I wanted to ask about...&quot;//&lt;/span&gt;
&lt;&lt;else&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I was also wondering about...&quot;//&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \

[[Life in the Temple|FirstDay 3a]]
[[Goals as a Candidate|FirstDay 3b]]
[[The tribe&#39;s thoughts about the Priestesshood|FirstDay 3c]]
[[The tribe&#39;s history|FirstDay 3d]]
[[Move on|FirstDay 4a]]</tw-passagedata><tw-passagedata pid="26" name="FirstDay 2b" tags="" position="74,357" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think I should go.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;I know! You&#39;re confident and determined thanks to me now! Ah, my people is so lucky to have me.&quot;//&lt;/span&gt;

//He... He is not being ironic, is he?//

Making your best effort to hide how embarrassed you are about him in your face, you quickly turn back and leave his tent. While you&#39;re walking towards yours, a voice stops you.

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;Morning, $chPlayerCharacter.name.&quot;//&lt;/span&gt; It&#39;s one of the warriors: the elder&#39;s son. //Although no one believes that.// Unlike his father, Zeel is likable and empathetic, and looks after his own figure. He is also not very talkative, which is the last piece of earth burying the idea of them being related. &lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;I take it your conversation with my father didn&#39;t go well?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Did you listen to us?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;No, but your face told me.&quot;//&lt;/span&gt;

//I guess my best effort from earlier wasn&#39;t enough.// &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;He told me I shouldn&#39;t worry about losing, because it&#39;s absolutely certain I&#39;m going to lose anyway.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;Ah, sounds like an oaf. Just like him.&quot;//&lt;/span&gt; Zeel is clearly not surprised. &lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;Pay him no mind, he&#39;s an idiot who never takes anything seriously.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Do you think I can actually win?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;I... I don&#39;t know.&quot;//&lt;/span&gt;

//Ah, that definitely reassured me.//

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;What I mean is that you&#39;re going to have a tough competition. But you can never be certain about how good you&#39;ll be at something until you try, right?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I guess I can&#39;t.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;So you may as well discover you&#39;re talented enough to keep their pace during the training, and even if you don&#39;t start on the same level, you could catch up.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I prefer that way of looking at it.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;I hope it helps you. I... I&#39;ll be going back with the others.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Thanks for the talk, it helped.&quot;//&lt;/span&gt;

[[Go back to your tent|FirstDay Save Tent]]</tw-passagedata><tw-passagedata pid="27" name="FirstDay 3a" tags="" position="184,357" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What&#39;s life in the Temple like?&quot;//&lt;/span&gt;
&lt;&lt;set $StVars.firstDayElderA to 1&gt;&gt; \
&lt;&lt;set $StVars.firstDayElderAndAshwalkers to 0&gt;&gt; \

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;I haven&#39;t lived there myself. In fact, I have barely even been inside. But if it&#39;s in any way like I think it is, you all will be fucking each other all day and...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m certain there has to be more to it than that.&quot;//&lt;/span&gt; you interrupt him.

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Yes. I guess so. The priestesses are supposed to be in charge of keeping the Goddess&#39; energy flowing through the Valley. But then again the rituals mainly consist in bending down to each other and-&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;MORE TO IT THAN THAT!&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Hmm. I hear the Candidates have to train everyday to develop their skills. But I don&#39;t buy any of that, why would they If they could just-&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Thank you, I think I have more questions.&quot;//&lt;/span&gt;

[[Move on|FirstDay 2a]]</tw-passagedata><tw-passagedata pid="28" name="FirstDay 3b" tags="" position="296,360" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What are my goals as a Candidate?&quot;//&lt;/span&gt;
&lt;&lt;set $StVars.firstDayElderA to 1&gt;&gt; \

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Ah, you should DEFINITELY,&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I didn&#39;t ask what you think I should do, I asked what the people of the Temple expect me to do.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;You&#39;re no fun at all.&quot;//&lt;/span&gt; You look at each other in silence for a moment. &lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;The Candidates go to the Passion Temple to become the High Priestess, and the High Priestess is chosen by the Candidates themselves.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How does that even work?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Oh, you don&#39;t know?&quot;//&lt;/span&gt; He smiles. You frown. He slowly moves his hand to his mouth, and shakes his tongue around the space between his middle and ring fingers.

//What is he even doing...?// Ahem. He&#39;s pretending to be licking a pussy.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Oh, gross.&quot;//&lt;/span&gt;

He smiles immensely happy with himself.

//I think I should ask about this again in the Temple.//

[[Move on|FirstDay 2a]]</tw-passagedata><tw-passagedata pid="29" name="FirstDay 3c" tags="" position="407,361" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What does our tribe think about the Priestesshood?&quot;//&lt;/span&gt;
&lt;&lt;set $StVars.firstDayElderA to 1&gt;&gt; \

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Hrrmm. Hmmmmrr.&quot;//&lt;/span&gt; The elder cleans his throat, thinking. &lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Truth is, most Gaanidans are thankful.&quot;//&lt;/span&gt; He sentences. &lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Maybe because we&#39;re the last of the six tribes that made it to the Valley, and we remember life without the Goddess more than the rest.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Was life without the Goddess hard?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;That&#39;s what it looks like. You know how hard it is to leave the Valley, right? The only way out is the Tortuous Corridor.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;In the mountains...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;T&#39;s right. Hrrm. Unless you can fly, the Tortuous Corridor is the only way out of the Valley, and it&#39;s been ages since anyone&#39;s tried. The Corridor is outside the Goddess&#39; Domains, so you only have to go there to see what happens to you. No one likes cold, but cold without the Goddess&#39; magic will sap your life away, and it will eventually kill you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Just... Some cold? Killing people?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Yes, not the best outlook, is it? According to our stories, people used to die in all kinds of ways outside the Valley. Cold, cuts, bruises, heat... All of them are annoying, but without the Goddess they could be dangerous enough to end someone&#39;s life.&quot;//&lt;/span&gt;

[[Move on|FirstDay 2a]]</tw-passagedata><tw-passagedata pid="30" name="FirstDay 3d" tags="" position="519,358" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Could you refresh my memory of the Gaanidans&#39; history?&quot;//&lt;/span&gt;
&lt;&lt;set $StVars.firstDayElderA to 1&gt;&gt; \

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;There isn&#39;t much to tell. Not much that&#39;s important &#39;nyway.&quot;//&lt;/span&gt;

You look at him expectantly.

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Allright... You surely know this already. But we were the last of the six tribes to settle in the Valley. We got here through the Tortuous Corridor, apparently fleeing something terrible.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We came from that place? Isn&#39;t it really dangerous?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;It is. That should give you an idea of what kind of things awaited for us at the other side. When we finally reached the Valley, many of us had died, and many others were terribly sick, but those who hadn&#39;t left us yet started to heal.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Isn&#39;t it normal for sick people to heal?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Not out there, no. Then we had fights with the other tribes, but we negotiated peace and they invited us to stay here. They taught us about the Goddess and we have never thought about leaving since then.&quot;//&lt;/span&gt;

[[Move on|FirstDay 2a]]</tw-passagedata><tw-passagedata pid="31" name="FirstDay 4a" tags="" position="630,360" size="100,100">//I should ask him about the other tribes, since they&#39;ll be presenting their own Candidates, and I don&#39;t know much about them.//

[[Ashwalkers|FirstDay 4b]]
[[Shapeshifters|FirstDay 4c]]
[[Beastkin|FirstDay 4d]]
[[Leiriens|FirstDay 4e]]
[[Aiishen|FirstDay 4f]]
[[Back to the previous questions|FirstDay 2a]]
[[Finish the conversation|FirstDay 2c]]</tw-passagedata><tw-passagedata pid="32" name="FirstDay 4b" tags="" position="190,455" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Tell me about the Ashwalkers.&quot;//&lt;/span&gt;
&lt;&lt;set $StVars.firstDayElderAndAshwalkers to 1&gt;&gt; \

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Why?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Because I&#39;ll meet an Ashwalker Candidate in the Temple, of course. And I&#39;ll have to live with her for a long time.&quot;//&lt;/span&gt;

The old man frowns. Everyone knows he dislikes Ashwalkers. Most people tends to ignore it. You never learnt why.

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;They... Ahem. They are humans, like us, but it&#39;s like their skin was cooked.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think I shouldn&#39;t have asked.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;They also put their kids to fight each other since they&#39;re small. They&#39;re agitated and fra... frarg... flagrant. They don&#39;t know how to have a good time. You won&#39;t like them.&quot;//&lt;/span&gt;

//I feel like I haven&#39;t learned much.//

[[Move on|FirstDay 4a]]</tw-passagedata><tw-passagedata pid="33" name="FirstDay 4c" tags="" position="297,469" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Tell me about the Shapeshifters.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Have you seen slimes before?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, they&#39;re squishy little creatures, made of goo.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Right, so Shapeshifters are big, intelligent slimes.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Are you serious? How do they even talk then?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;They can talk because they can take any form they want. One day they&#39;re a woman, a man the next and a woman again the following day. Sometimes they even pretend they&#39;re not slimes.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How so? Can you not easily recognize the goo?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Not if they don&#39;t want to. I don&#39;t know how they do it, but they make it appear as if they had any kind of skin they want to.&quot;//&lt;/span&gt;

//That sounds interesting! I want to see it.//

[[Move on|FirstDay 4a]]</tw-passagedata><tw-passagedata pid="34" name="FirstDay 4d" tags="" position="411,471" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Tell me about the Beastkin.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;They&#39;re mostly humans, but not really. They have animal ears and tails. They even behave a bit like animals.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Do they, really?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;What, you don&#39;t trust me?&quot;//&lt;/span&gt;

//No.// &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Maybe not.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Hrrm. I haven&#39;t seen many of them myself. But the ones I&#39;ve seen were weird like that, licking their own hands and scratching their ears.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I scratch my ears too.&quot;//&lt;/span&gt;

[[Move on|FirstDay 4a]]</tw-passagedata><tw-passagedata pid="35" name="FirstDay 4e" tags="" position="521,470" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Tell me about the Leiriens.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Ah, I like them! I love them. They&#39;re so hot you wouldn&#39;t believe it, and-&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I was asking how they are.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;I&#39;m going there, allright? Impatient kid.&quot;//&lt;/span&gt; He sighs. &lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;They have green skin - maybe you shouldn&#39;t even call it skin, because it feels like... Like flower stalk. They&#39;re also covered in flowers and vines, and they smell so nice.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Do their men smell nice too?&quot;//&lt;/span&gt; //He&#39;s likely talking about Leirien women only.//

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Their... men? I guess... so? I didn&#39;t pay much attention to them.&quot;//&lt;/span&gt;

//He was talking about Leirien women only.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think I can picture them.&quot;//&lt;/span&gt;

[[Move on|FirstDay 4a]]</tw-passagedata><tw-passagedata pid="36" name="FirstDay 4f" tags="" position="636,472" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What should I know about the Aiishen?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Truth is... I don&#39;t know.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...You don&#39;t? Have you never met any?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;I think I have. I could also have not. I&#39;m not sure, really.&quot;//&lt;/span&gt; You&#39;re slightly puzzled, but his face reflects honesty. //He seemed to be drunk earlier, but not drunk enough to start babbling this much nonsense.// &lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;I think I saw a couple of them during a meeting with other tribes. It should have been them, but I&#39;m not even sure they were there. They seemed to be a mix of smoke and black water... But I couldn&#39;t even see them clearly. I didn&#39;t hear them talk either, they just appeared to exchange glances with others and make very small gestures...&quot;//&lt;/span&gt;

//I&#39;m not so sure that&#39;s the alcohol talking now.//

[[Move on|FirstDay 4a]]</tw-passagedata><tw-passagedata pid="37" name="FirstDay 2c" tags="" position="77,466" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ll be leaving now.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellowgreen&quot;&gt;//&quot;Yes, yes, I know you&#39;re far more confident now.&quot;//&lt;/span&gt; He smiles.

//Sigh.// And you leave his tent. While you&#39;re walking back to your own, a voice stops you.

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;Morning, $chPlayerCharacter.name.&quot;//&lt;/span&gt; It&#39;s one of the warriors: the elder&#39;s son. //Although no one believes that.// Unlike his father, Zeel is liable and empathetic, and looks after his own figure. He is also not very talkative, which is the last piece of earth burying the idea of them being related. &lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;I take it your conversation with my father didn&#39;t go well?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Did you listen to us?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;No, but your face told me.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.firstDayElderAndAshwalkers is 1&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What is it with your father and the Ashwalkers, anyway? Are they really that bad?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;Goddess, no, haha. He&#39;s just mad a lass left him for an Ashwalker when he was young.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And he still has a grudge over that? A grudge that big?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;He&#39;ll sooner condemn their whole tribe before admitting there was nothing wrong with her choosing someone else.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s... sad.&quot;//&lt;/span&gt;
&lt;&lt;else&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I didn&#39;t learn much from him. I thought the tribe&#39;s elder would be more knowledgeable.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;He&#39;s not the tribe&#39;s elder because he&#39;s wise. He&#39;s the tribe&#39;s elder because he&#39;s old.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t you think any of you will be able to tell me much about the Temple, or the other tribes...?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;I really don&#39;t think so. We don&#39;t have that much contact with the other tribes, much less the Temple.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I guess I&#39;ll have to let life surprise me then.&quot;//&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...And he also told me I shouldn&#39;t worry about losing, because it&#39;s absolutely certain I&#39;m going to lose anyway.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;Ah, sounds like an oaf. Just like him.&quot;//&lt;/span&gt; Zeel is clearly not surprised. &lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;Pay him no mind, he&#39;s an idiot who never takes anything seriously.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Do you think I can actually win?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;I... I don&#39;t know.&quot;//&lt;/span&gt;

//Ah, that definitely reassured me.//

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;What I mean is that you&#39;re going to have a tough competition. But you can never be certain about how good you&#39;ll be at something until you try, right?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I guess I can&#39;t.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;So you may as well discover you&#39;re talented enough to keep their pace during the training, and even if you don&#39;t start on the same level, you could catch up.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I prefer that way of looking at it.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:chartreuse&quot;&gt;//&quot;I hope it helps you. I... I&#39;ll be going back with the others.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Thanks for the talk, it helped.&quot;//&lt;/span&gt;

[[Go back to your tent|FirstDay Save Tent]]</tw-passagedata><tw-passagedata pid="38" name="FirstDay 5" tags="" position="747,251" size="100,100">Many hours went quiet and without unexpected events.

The warriors packed up the camp and all of you left to complete the rest of the route. You reached the confines of the forest, and the Passion Temple stood far in the distance.

A green prairie remained calm long and wide in front of you. Behind it, there was a considerable hill that turned into mountain as your sight reached its end, a mountain connected to the natural borders of the Confined Valley. Daylight stroke it with strength and majesty, reflecting a bright, distinctive gray back into everyone&#39;s eyes.

Slightly beyond the limits between mountain and hill, a fortress rose from the uneven ground, walls and towers higher than any you had ever seen. Its colors and forms made hard to guess if it had been built or carved directly into the rock.

It was the Passion Temple.

The succession rules are fairly strict, and they mandate the Candidates must not bring company, beyond what&#39;s necessary to make it safe. The elder suggested the view of the other Candidates may suppose a danger to your young eyes, but his son reprimanded him, and they left you alone to make the rest of the travel yourself.

It&#39;s now late afternoon, and you&#39;re close to the end of the hill. A badly maintained gravel path is continued by another one built with stone slabs. It leads directly to the Temple.

[[Climb the path|FirstDay 6]]</tw-passagedata><tw-passagedata pid="39" name="Testing Scenes Room" tags="saveAllowed" position="1263,25" size="100,100">&lt;&lt;set $tsr to new weightedList&gt;&gt; \
&lt;&lt;set $tsr.character to &quot;chNash&quot;&gt;&gt; \
&lt;&lt;set $tsr.sceneType to &quot;normalLead&quot;&gt;&gt; \
&lt;&lt;script&gt;&gt;
setUpTestsRoom();
State.variables.chPlayerCharacter.race = &quot;leirien&quot;;
&lt;&lt;/script&gt;&gt; \
\
&lt;span style=&quot;color:green&quot;&gt;You can save the game!&lt;/span&gt;

Tests room

Character
&lt;&lt;radiobutton &quot;$tsr.character&quot; &quot;chNash&quot; checked&gt;&gt; Nashillbyir
&lt;&lt;radiobutton &quot;$tsr.character&quot; &quot;chMir&quot;&gt;&gt; Padmiri
&lt;&lt;radiobutton &quot;$tsr.character&quot; &quot;chClaw&quot;&gt;&gt; Fiercest Claw
&lt;&lt;radiobutton &quot;$tsr.character&quot; &quot;chVal&quot;&gt;&gt; Valtan
&lt;&lt;radiobutton &quot;$tsr.character&quot; &quot;chAte&quot;&gt;&gt; Maaterasu

Scene type
&lt;&lt;radiobutton &quot;$tsr.sceneType&quot; &quot;normalLead&quot; checked&gt;&gt; Equal footing
&lt;&lt;radiobutton &quot;$tsr.sceneType&quot; &quot;passive&quot;&gt;&gt; Passive companion
&lt;&lt;radiobutton &quot;$tsr.sceneType&quot; &quot;active&quot;&gt;&gt; Leading companion
&lt;&lt;radiobutton &quot;$tsr.sceneType&quot; &quot;romantic&quot;&gt;&gt; Romantic companion
&lt;&lt;radiobutton &quot;$tsr.sceneType&quot; &quot;competition&quot;&gt;&gt; Competitive companion
&lt;&lt;radiobutton &quot;$tsr.sceneType&quot; &quot;submission&quot;&gt;&gt; Submissive companion
&lt;&lt;radiobutton &quot;$tsr.sceneType&quot; &quot;domination&quot;&gt;&gt; Dominating companion

&lt;&lt;link [[Go for it|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
configureTestsRoomScene();
State.variables.sc.formatScenePassage();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="40" name="FirstDay 6" tags="saveAllowed" position="856,254" size="100,100">&lt;script&gt;setPasChars([getPresentCharByKey(&quot;chMir&quot;)]);&lt;/script&gt; \
The sides of the roads are filled with oaks, bushes and flowers, as well as the occasional entrance to a side path.  It isn&#39;t long before you reach a grand square, leading to two considerable gates. There are many benches next to them, and someone&#39;s sitting at one. Someone pink and green. This person is waving at you.

//She wants me to go over there, right?//

You take a soft breath and start walking towards her, and you get a clearer look. She is covered by many flowers, some giant, some small. They&#39;re mostly pink, but you also notice red and yellow portions. Below them all, the woman&#39;s green skin.

//This must be a Leirien.//

She has a genuinely gentle smile, but her confident eyes don&#39;t cease to penetrate yours, and you feel uncomfortable in your stomach.

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/mir-full.png]]
&lt;/div&gt; \

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Welcome to the Temple. My name is Padmiri, but please feel free to call me Mir.&quot;//&lt;/span&gt;

[[&quot;I&#39;m glad to meet you.&quot;|FirstDay 6a]]
[[&quot;Are you the Leirien Candidate?&quot;|FirstDay 6b]]
[[&quot;I... Don&#39;t know if I was supposed to come here, could you help me?&quot;|FirstDay 6c]]
[[&quot;Can I touch your flower?&quot;|FirstDay 6d]]</tw-passagedata><tw-passagedata pid="41" name="FirstDay 6b" tags="" position="1065,254" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Are you the Leirien Candidate?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Oh, my. How forward.&quot;//&lt;/span&gt;

She gets up from her seat.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes, I&#39;m my tribe&#39;s Candidate. I suppose you the Gaanidan&#39;s one. Might I know your name?&quot;//&lt;/span&gt;

Despite complaining about your forwardness, her expression hasn&#39;t yet changed.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s right. My name is $chPlayerCharacter.name.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;m glad to meet you. I hope we can work together in the future.&quot;//&lt;/span&gt;

//Work together? Aren&#39;t we rivals?//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Work together? I thought we had to compete.&quot;//&lt;/span&gt;

She remains silent for a moment.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes, it&#39;s true we came here to compete and become High Priestess... But at the end of the day, we all will be working for the sake of the Valley.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s... A way of looking at it.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I hope you will end up seeing it my way.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has lightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 100;
&lt;&lt;/script&gt;&gt; \
[[Continue|FirstDay 7]]</tw-passagedata><tw-passagedata pid="42" name="FirstDay 6a" tags="" position="961,254" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;My name is $chPlayerCharacter.name, I&#39;m glad to meet you.&quot;//&lt;/span&gt;

Her smile widens by a bit, and she gets up to give you a proper greeting.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You must be the Gaanidan Candidate.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, that&#39;s correct.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;m the Leirien Candidate. I hope we can work together.&quot;//&lt;/span&gt;

//Work together? Aren&#39;t we rivals?//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Work together? I thought we had to compete.&quot;//&lt;/span&gt;

She remains silent for a moment.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes, it&#39;s true we came here to compete and become High Priestess... But at the end of the day, we all will be working for the sake of the Valley.&quot;//&lt;/span&gt;

Her expression, which had fallen low, regains her high spirit once again.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s... A way of looking at it.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I hope you will end up seeing it my way.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has lightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 100;
&lt;&lt;/script&gt;&gt; \
[[Continue|FirstDay 7]]</tw-passagedata><tw-passagedata pid="43" name="FirstDay 6c" tags="" position="1169,252" size="100,100">&lt;&lt;set $StVars.firstDayMirsCare to true&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I... Don&#39;t know if I was supposed to come here, could you help me?&quot;//&lt;/span&gt;

Her smile widens by a bit, and she gets up.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Of course, my dear. I think you&#39;re the Gaanidan Candidate, is this true?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I am... And my name is $chPlayerCharacter.name.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Then you&#39;ve come to the right place.&quot;//&lt;/span&gt;

She offers you her hand. You hesitate, but you take it nonetheless. It&#39;s soft when you push your fingers into it, yet it has a certain roughness when you slide them.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;ll be taking good care of you, if you allow me.&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;5 willpower.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 5;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 350;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 350;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 350;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 350;
&lt;&lt;/script&gt;&gt; \
[[Continue|FirstDay 7]]</tw-passagedata><tw-passagedata pid="44" name="FirstDay 6d" tags="" position="1272,251" size="100,100">&lt;&lt;set $StVars.firstDayMirsFlower to true&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Can I touch your flower?&quot;//&lt;/span&gt;

//Wait, did I just say that?//

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Excuse me?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I asked you if I can touch your flower.&quot;//&lt;/span&gt;

//Yes, I think I did.//

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Oh. Oh, hum...&quot;//&lt;/span&gt; She is clearly perplexed. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes, I guess you can.&quot;//&lt;/span&gt;

Whatever fears you have, they&#39;re sunk at the bottom of your stomach right now, and you decide to act fast, before they resurface.

Your hand goes straight to the huge, pink, closed flower she has above her head, and lands on it. You feel it, you rub it, you slide your hand through it. It&#39;s soft as silk when you go over it vertically, but it has a sour surface when your movement is horizontal. It&#39;s thinly malleable and greatly elastic. And then you notice a funny, sweet smell.

//Did it come out of the flower?//

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Um...&quot;//&lt;/span&gt;

You look back at Padmiri&#39;s face, the Leirien still on her seat. Her confident smile is no more. Instead, she looks at you expectantly.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That was all, thank you.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I think you didn&#39;t tell me your name.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m $chPlayerCharacter.name, Candidate of the Gaanidans.&quot;//&lt;/span&gt;

She gets up.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And I&#39;m Candidate of the Leirien. I... I hope we get along.&quot;//&lt;/span&gt; The smile comes back to her face, but it&#39;s more cheerful //and nervous// this time.

//Wait, wasn&#39;t I going to touch her //other// flower?//

//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;10 lust&lt;/span&gt;.
You lost &lt;span style=&quot;color:khaki&quot;&gt;20 social drive&lt;/span&gt;.
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.lust.current -= 10;
State.variables.chPlayerCharacter.socialdrive.current -= 20;
State.variables.chMir.lust.current -= 20;
State.variables.chMir.willpower.current -= 20;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 350;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 350;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 350;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 350;
&lt;&lt;/script&gt;&gt; \
[[Continue|FirstDay 7]]</tw-passagedata><tw-passagedata pid="45" name="FirstDay 7" tags="" position="744,362" size="100,100">&lt;script&gt;setNoPasChars()&lt;/script&gt; \
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...As for the Temple, they won&#39;t open the doors just yet.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What? Why?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I suppose it&#39;s part of the ceremonies. They&#39;re making us wait until a few minutes before dusk.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Are there others here yet?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;There are others, yes. The Shapeshifter, the Ashwalker and the... Beastkin Candidates are just around these gardens. I think you should meet them in the meantime.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What about the Aiishen?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;She is the last one. But at this rate, I&#39;m not even sure she&#39;s going to make it today.&quot;//&lt;/span&gt; Padmiri&#39;s face shows a hint of concern.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Let&#39;s hope she comes soon then. I&#39;ll be going to meet the others for now.&quot;//&lt;/span&gt;

[[Continue|FirstDay Garden Crossroads]]
&lt;&lt;set $StVars.metNash to false&gt;&gt; \
&lt;&lt;set $StVars.metClaw to false&gt;&gt; \
&lt;&lt;set $StVars.metVal to false&gt;&gt; \</tw-passagedata><tw-passagedata pid="46" name="FirstDay Garden Crossroads" tags="saveAllowed" position="745,473" size="100,100">You remember several paths across the path to the Temple.

[[Go back to Padmiri|FirstDay Padmiri]] [img[img/charIcons/mirIcon.png]]
&lt;&lt;if $StVars.metNash is false&gt;&gt; \
[[Take the windy, simple path|FirstDay MeetingNash]]
&lt;&lt;else&gt;&gt; \
[[Go back to Nash|FirstDay Nash]] [img[img/charIcons/nashIcon.png]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.metClaw is false&gt;&gt; \
[[Take the densely forested path|FirstDay MeetingClaw]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You&#39;re not going back there.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.metVal is false&gt;&gt; \
[[Take the humid path|FirstDay MeetingVal]]
&lt;&lt;else&gt;&gt; \
[[Go back to Sillan|FirstDay Val]] [img[img/charIcons/valIcon.png]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.metVal == true &amp;&amp; $StVars.metNash == true &amp;&amp; $StVars.metClaw == true&gt;&gt; \
&lt;&lt;set $StVars.FirstDayMetAllCandidates to true&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;&lt;set $StVars.FirstDayMetAllCandidates to false&gt;&gt; \
&lt;&lt;/if&gt;&gt;</tw-passagedata><tw-passagedata pid="47" name="FirstDay Padmiri" tags="" position="1284,368" size="100,100">&lt;&lt;if $StVars.FirstDayMetAllCandidates != true&gt;&gt; \
Padmiri is here. I could keep talking to her once I&#39;ve talked to the other Candidates.

[[Go back to the path|FirstDay Garden Crossroads]]
&lt;&lt;else&gt;&gt; \
Padmiri is here, and I have talked to the other Candidates already. Should I wait with her until the gates are opened?

&lt;&lt;link [[Talk to Padmiri|FirstDay Padmiri2]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[Go back to the path|FirstDay Garden Crossroads]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="48" name="FirstDay MeetingNash" tags="" position="848,475" size="100,100">&lt;&lt;set $StVars.metNash to true&gt;&gt; \
&#39;&#39;//Thump//&#39;&#39;

The sound of someone falling on the ground agitates you as you walk down the way. You advance trying to locate the source of the sound, and-

&#39;&#39;//Zrrssshh//&#39;&#39;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hyaaaaa!&quot;//&lt;/span&gt;

&#39;&#39;//Thump//&#39;&#39;

You hear more coming from the same place. You take a shortcut between the forage, and when you reach a clear, you see her.

Another human about as old as you swings a long, bland staff as she jumps around. You aren&#39;t sure if she&#39;s dancing or if she&#39;s fighting an invisible enemy, what you&#39;re certain about is that she&#39;s captivating. Sometimes the movements are short and fast, sometimes they&#39;re long and she moves long distances in a single jump. At all moments, she seems to be in control. Her eyes cross yours.

And she keeps dancing. She&#39;s definitely aware that you&#39;re here, but she&#39;s still immersed in her activities. Yet it isn&#39;t long until her patterns change: in a couple of seconds, she goes from giving your her back to jumping in your direction, moving the staff in a way that is certain to hit you. Fear overcomes your reflexes and your body won&#39;t move just yet, and-

[[Continue|FirstDay MeetingNash 2]]</tw-passagedata><tw-passagedata pid="49" name="FirstDay Nash" tags="" position="1070,474" size="100,100">&lt;&lt;if $StVars.FirstDayMetAllCandidates != true&gt;&gt; \
Nash is here. I could keep talking to her once I&#39;ve talked to the other Candidates.

[[Go back to the path|FirstDay Garden Crossroads]]
&lt;&lt;else&gt;&gt; \
&lt;&lt;if $StVars.FirstDayNashRival is true&gt;&gt; \
Nash is resting next to a tree. Apparently she&#39;s finished her exercises. When she sees you, she simply gives you a cold look.

//Perhaps I overreacted earlier?//

&lt;&lt;link [[Apologize|FirstDay Nash2b]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[Go back to the path|FirstDay Garden Crossroads]]
&lt;&lt;else&gt;&gt; \
Nash is here, and I have talked to the other Candidates already. Should I wait with her until the gates are opened?

&lt;&lt;link [[Talk to Nash|FirstDay Nash2]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[Go back to the path|FirstDay Garden Crossroads]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;/if&gt;&gt; \

&lt;&lt;set $StVars.FirstDayNashRival to true&gt;&gt; \</tw-passagedata><tw-passagedata pid="50" name="FirstDay MeetingClaw" tags="" position="743,582" size="100,100">&lt;&lt;set $StVars.metClaw to true&gt;&gt; \
The path you&#39;re following seems to be more and more broken the more you advance, and the vegetation gets more common.

//It&#39;s as if I was leaving a garden to enter a forest. It doesn&#39;t look like there&#39;s anyone around here anyway, perhaps I should...//

//&#39;&#39;Zzzrrrsss&#39;&#39;//

You turn around and you find some shaking bushes.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Is someone there? Or... Something...?&quot;//&lt;/span&gt;

Though uncertain, you take some small steps towards the bush, looking closely at it and its surroundings. When you&#39;re close enough, you notice a stone trapped between some small branches, but then they break and the stone falls, further shaking the bush.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Was it only this? No, wait, how did that stone-&quot;//&lt;/span&gt;

Something grabs your neck.

[[Continue|FirstDay MeetingClaw 2]]</tw-passagedata><tw-passagedata pid="51" name="FirstDay MeetingVal" tags="" position="742,687" size="100,100">&lt;&lt;set $StVars.metVal to true&gt;&gt; \
This section of the way is specially well maintained. There aren&#39;t barely any wild herbs, and many hedges, bushes and trees keep relatively regular distances from each other. If there&#39;s any part of the outer grounds that deserve the name of garden, it&#39;s these ones.

Not much further away, the path twists, and just as you go past the corner you find a mass of pristine water. A beautiful lake takes the most out of an ample glade, and the green reflection of the trees covers its surface. Or at least, the majority of it.

A feminine figure was resting on its surface, but it has seen you and it&#39;s swimming towards you. She offers you a welcoming, perhaps overconfident smile.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;We seem to have even more company. And one that nourishes the eyes.&quot;//&lt;/span&gt;

//Is she complimenting me?//

As she leaves the water, her image gets clearer. Her skin, if it could be called that way, is actually liquid, and it takes a more pronounced blue tone the further away it gets away from the lake. Her fair facial factions get diluted when they reach her hair, which has a different texture despite being likely made with the same material. A turquoise dress covers her private parts, and not much more.

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/val-full.png]]
&lt;/div&gt; \

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;My name is Sillan - or just Sill for you, and I&#39;m the Candidate of the Shapeshifters.&quot;//&lt;/span&gt;

She stops when she&#39;s less than a meter away, grinning at you with expectation.

&lt;script&gt;setPasChars([getPresentCharCustomName(&quot;chVal&quot;,&quot;Sill&quot;)]);&lt;/script&gt; \
[[Formally introduce yourself|FirstDay MeetingVal 2a]]
[[Flirt back|FirstDay MeetingVal 2b]]
[[Be forward and take the initiative|FirstDay MeetingVal 2c]]</tw-passagedata><tw-passagedata pid="52" name="FirstDay Val" tags="" position="1182,688" size="100,100">&lt;&lt;if $StVars.FirstDayMetAllCandidates != true&gt;&gt; \
Sillan is here. I could keep talking to her once I&#39;ve talked to the other Candidates.

[[Go back to the path|FirstDay Garden Crossroads]]
&lt;&lt;else&gt;&gt; \
Sillan is here, and I have talked to the other Candidates already. Should I wait with her until the gates are opened?

&lt;&lt;link [[Talk to Sillan|FirstDay Val2]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharCustomName(&quot;chVal&quot;,&quot;Sill&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[Go back to the path|FirstDay Garden Crossroads]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="53" name="FirstDay MeetingNash 2" tags="" position="958,469" size="100,100">&lt;&lt;set $StVars.NashRival to false&gt;&gt; \
The staff stops right in front of your eyes.

She moves it apart and you can clearly see her: dark skin, a white sleeveless tunic, hair split between red and black lines, and a smile. A huge, sympathetic smile that shows nothing but optimism.

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/nash-full.png]]
&lt;/div&gt; \

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hello! My name is Nash. Who are you?&quot;//&lt;/span&gt;

She offers you her free hand.

&lt;script&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);&lt;/script&gt; \
[[Formally introduce yourself|FirstDay MeetingNash 2a]]
[[Introduce yourself and be extra nice|FirstDay MeetingNash 2b]]
[[Ask her not to hit you|FirstDay MeetingNash 2c]]
[[Get mad at her|FirstDay MeetingNash 2d]]
</tw-passagedata><tw-passagedata pid="54" name="FirstDay MeetingNash 2a" tags="" position="852,366" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ahem.&quot;//&lt;/span&gt; You regain your composture. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m $chPlayerCharacter.name, Candidate of the Gaanidans.&quot;//&lt;/span&gt; You take her hand.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Um.&quot;//&lt;/span&gt; Some of her initial optimism shrinks. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Yes, I&#39;m a Candidate too! I&#39;m from the Ashwalker tribe.&quot;//&lt;/span&gt;

A small silence follows, then she takes the initiative.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Can you fight?&quot;//&lt;/span&gt; She spins her staff a couple of times moving her wrist and fingers.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Eh, not really. Or at least, not like that.&quot;//&lt;/span&gt;

For a moment, Nash seems to be a bit dissapointed, but she immediately changes her expression. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;That&#39;s fine! I could teach you! If you wanted me to.&quot;//&lt;/span&gt; After a couple of seconds, the girl lets your hand go, jumps back and swings her weapon once more.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You seem to be very skilled. I&#39;ll consider your offer.&quot;//&lt;/span&gt;

She dedicates you another ample smile, then resumes her training.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has lightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 100;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Garden Crossroads]]</tw-passagedata><tw-passagedata pid="55" name="FirstDay MeetingNash 2b" tags="" position="960,366" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m $chPlayerCharacter.name, but... That was so cool! Where did you learn to do that?&quot;//&lt;/span&gt;

Her face goes from confidence to happiness in a matter of moments. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hahaha! Thanks, I guess it really was. I&#39;ve been practicing to fight since I was small. Many among the Ashwalkers train to become martial artists from childhood.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Are there many who can fight like you?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;There are quite a few. And I still have much to learn from them. Would you like to learn too?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think I would!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I have a lot to teach you then! But I have to finish my exercises right now.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Fine, we&#39;ll talk later!&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:khaki&quot;&gt;10 social drive&lt;/span&gt;.
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.socialdrive.current -= 10;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 350;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 350;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Garden Crossroads]]</tw-passagedata><tw-passagedata pid="56" name="FirstDay MeetingNash 2c" tags="" position="1070,368" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Please don&#39;t hit me?&quot;//&lt;/span&gt;

Nash supresses a chuckle. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;I hadn&#39;t heard a name like that before.&quot;//&lt;/span&gt; She sticks out her tongue, then places her staff on your head.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Please do not do it.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Fine, I won&#39;t hit you, but you&#39;ll have to do something for me. It may be something you don&#39;t even want to do!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I&#39;ll do it.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You&#39;ll have to tell me a secret you&#39;ve been hiding from me...&quot;//&lt;/span&gt; You look at her expectantly. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;What&#39;s your name?&quot;//&lt;/span&gt;

The tension dissipates. You sigh, and she laughs.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;My name is $chPlayerCharacter.name, and I&#39;m the Candidate of the Gaanidans.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;m the Candidate of the Ashwalkers! I&#39;m sure we&#39;ll get along. I have to finish my exercises, but we can keep talking later.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Fine, see you.&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower&lt;/span&gt;.
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Nashillbyir has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 350;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 350;
State.variables.chPlayerCharacter.relations.chNash.submission.stv += 350;
State.variables.chNash.relations.chPlayerCharacter.domination.stv += 350;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Garden Crossroads]]</tw-passagedata><tw-passagedata pid="57" name="FirstDay MeetingNash 2d" tags="" position="1177,367" size="100,100">&lt;&lt;set $StVars.FirstDayNashRival to true&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Someone who will beat your ass!&quot;//&lt;/span&gt; You explode. She frowns. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s no way to greet anyone!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;m sorry, I didn&#39;t want to anger you...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s too bad, because I&#39;ve had it with you now! I&#39;ll make you pay for this.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

She looks at you in silence for some seconds.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Fine, we can be rivals then. Feel free to challenge me when you actually have a weapon. Right now, I have to finish my exercises.&quot;//&lt;/span&gt;

She goes back to her training, leaving you annoyed and frustrated.

//You lost &lt;span style=&quot;color:khaki&quot;&gt;20 social drive&lt;/span&gt;.
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Nashillbyir has grown.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Nashillbyir has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.socialdrive.current -= 20;
State.variables.chPlayerCharacter.relations.chNash.enmity.stv += 350;
State.variables.chNash.relations.chPlayerCharacter.enmity.stv += 350;
State.variables.chPlayerCharacter.relations.chNash.rivalry.stv += 350;
State.variables.chNash.relations.chPlayerCharacter.rivalry.stv += 350;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Garden Crossroads]]</tw-passagedata><tw-passagedata pid="58" name="FirstDay MeetingClaw 2" tags="" position="853,580" size="100,100">&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;If you shout, you lose your neck.&quot;//&lt;/span&gt;

Fear overwhelms you.
//I want to shout, but nothing will come out of my throat.//
You clearly feel humans fingers, but also some pointy surfaces, like small knives.
//My heart won&#39;t even move.//

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Good. You&#39;re clearly small fry, and you seem to know it.&quot;//&lt;/span&gt;

She lets you go.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Turn around.&quot;//&lt;/span&gt;

You meekly obey, and you find brown, deep eyes, looking directly at you and not moving an inch, accompanied by a serious, almost angry expression. She has yellow feline ears with black stripes, in the middle of a wild brown hair. //She&#39;s a Beastkin.// You look at her hands. Where there would normally be nails, there are claws.

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/claw-full.png]]
&lt;/div&gt; \

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;m going to win this competition. If you get in my way, you&#39;ll get hurt. Understood?&quot;//&lt;/span&gt;

&lt;script&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;)]);&lt;/script&gt; \
[[Nod|FirstDay MeetingClaw 2a]]
[[Maintain the eye contact and do not reply|FirstDay MeetingClaw 2b]]
[[Tell her there&#39;s plenty of competition ahead|FirstDay MeetingClaw 2c]]</tw-passagedata><tw-passagedata pid="59" name="FirstDay MeetingClaw 2a" tags="" position="961,579" size="100,100">For one reason or another, you think it&#39;s best to avoid trouble with her for now. Whether you actually follow your word and avoid competing with her at all will be a different matter.

Your reply is simply nodding your head.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf. You looked really dumb earlier, letting yourself get caught like that. But at least you can take the right decision when you have danger in front of your eyes. You better leave right now, and don&#39;t come back here.&quot;//&lt;/span&gt;

You take some smalls towards the Temple gates, and when you confirm she won&#39;t attack or chase you, you turn around and leave for good.

//She&#39;s the Beastkin Candidate, isn&#39;t she? This isn&#39;t good.//

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;20 willpower.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Claw has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 20;
State.variables.chPlayerCharacter.relations.chClaw.submission.stv += 350;
State.variables.chClaw.relations.chPlayerCharacter.domination.stv += 350;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Garden Crossroads]]</tw-passagedata><tw-passagedata pid="60" name="FirstDay MeetingClaw 2b" tags="" position="1071,578" size="100,100">Your eyes stick to her like eagle claws that won&#39;t let go of their prey. You&#39;re scared. She knows it. But you won&#39;t tell her what she wants to hear.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I know you&#39;re not mute, and I don&#39;t have the whole day. Speak up.&quot;//&lt;/span&gt;

And your reply is silence. You would swear you can hear her chewing the tension in the air. She&#39;s getting annoyed.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Ah, damnit. This stupid place.&quot;//&lt;/span&gt;

She turns back, looking nowhere, clenching her first.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Just leave. If you don&#39;t want to get it now, you&#39;ll get it later. Go.&quot;//&lt;/span&gt;

You stay put for a moment, still directly looking at her face. She&#39;s given up with you, and you take advantage and leave.

//She&#39;s the Beastkin Candidate, isn&#39;t she? This isn&#39;t good.//

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Claw has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv += 350;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 350;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Garden Crossroads]]</tw-passagedata><tw-passagedata pid="61" name="FirstDay MeetingClaw 2c" tags="" position="1180,579" size="100,100">You frown and make an angry expression. It&#39;s true you&#39;re scared, but you&#39;re not about to let her intimidate you into submission.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Just like that? You expect me to give up the Priestesshood because you grabbed my neck?&quot;//&lt;/span&gt;

Her face twitches.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Do you seriously think you can best me?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;No, I can&#39;t. But the High Priestess won&#39;t be chosen today, and I have plenty of time to catch up.&quot;//&lt;/span&gt;

She crosses her arms. She&#39;s actually getting annoyed.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You want to make me lose my time with you? Fine. I will. And you will pay for it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We&#39;ll see about that.&quot;//&lt;/span&gt;

And right after that, you turn around and leave.

//So this is the Beastkin Candidate. This isn&#39;t good.//

//You lost &lt;span style=&quot;color:khaki&quot;&gt;20 social drive.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Claw has grown a lot.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Claw has grown a lot.&lt;/span&gt;
You gained 250 will experience.
You gained 250 charisma experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.socialdrive.current -= 20;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv += 750;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 750;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 750;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 750;
State.variables.chPlayerCharacter.will.experience += 250;
State.variables.chPlayerCharacter.charisma.experience += 250;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Garden Crossroads]]</tw-passagedata><tw-passagedata pid="62" name="FirstDay MeetingVal 2a" tags="" position="854,689" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;My greetings, Sillan. I am $chPlayerCharacter.name, the Candidate of the Gaanidans.&quot;//&lt;/span&gt;

You offer your hand.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Oh, my dear.&quot;//&lt;/span&gt; She takes it and brings it closer to herself, &lt;span @style=$chVal.colorStyleKey&gt;//&quot;I&#39;m certain that meeting you will be...&quot;//&lt;/span&gt; grazing her breasts, &lt;span @style=$chVal.colorStyleKey&gt;//&quot;Delightful.&quot;//&lt;/span&gt; ...And placing it above them, next to where a human would have their heart.

Her skin feels soft and malleable. It&#39;s wet, but it doesn&#39;t wet your own hand. It&#39;s cold, likely because she was just having a bath. You, however, are having trouble not getting heated up.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;L-likewise. Um, ahem.&quot;//&lt;/span&gt; You try taking your hand away, and Sillan lets it go. She eyes you intensely.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ll... be taking my leave.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Of course. I&#39;ll resume my bath. Feel free to come back if you want to chat...&quot;//&lt;/span&gt; She winks, slowly, tilting her head.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Sillan has lightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.friendship.stv += 100;
State.variables.chVal.relations.chPlayerCharacter.friendship.stv += 100;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Garden Crossroads]] </tw-passagedata><tw-passagedata pid="63" name="FirstDay MeetingVal 2b" tags="" position="965,691" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And I&#39;m $chPlayerCharacter.name, the Candidate of the Gaanidans. Feel free to nourish yourself with me.&quot;//&lt;/span&gt; You attempt to imitate her expression, and smirk confidently.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What a wonderful offer.&quot;//&lt;/span&gt;

Without losing a moment, she approaches you, takes your head with her hands, and engulfs your lips with her own.

//Wait!//

You freeze, eyes open wide. Sill&#39;s remain closed most of the time, but she occasionally gets them ajar to check on you. Gelatine, soft gelatine. Her skin feels wet but it doesn&#39;t wet you. Her flexible, perhaps malleable lips stretch around yours, rubbing and exploring every inch.

And then she stares, and enters your mouth with her tongue. You can&#39;t keep her gaze, and decide it&#39;s your turn to close your eyes. The slime massages you, enfolds you and makes you move at its own pace, taking you as its passive partner for a dance. And then it stops.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You are divinely tasteful.&quot;//&lt;/span&gt;

The Shapeshifter takes a step back, aparting herself from you.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;But it&#39;s no time for sweets yet. I can take this meal later.&quot;//&lt;/span&gt; She licks herself.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That... Was-&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Ssshhh... We&#39;ll have plenty of time. Allow me to finish my bath, and we&#39;ll be able to talk more later.&quot;//&lt;/span&gt;

She leaves you with no choice but to leave.

//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;10 lust.&lt;/span&gt;
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;15 willpower.&lt;/span&gt;
You lost &lt;span style=&quot;color:khaki&quot;&gt;10 social drive.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Sillan has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Sillan has grown.&lt;/span&gt;
You gained 250 charisma experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.lust.current -= 10;
State.variables.chPlayerCharacter.willpower.current -= 15;
State.variables.chPlayerCharacter.socialdrive.current -= 10;
State.variables.chVal.lust.current -= 10;
State.variables.chVal.socialdrive.current -= 10;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 350;
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 350;
State.variables.chPlayerCharacter.charisma.experience += 250;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Garden Crossroads]] </tw-passagedata><tw-passagedata pid="64" name="FirstDay MeetingVal 2c" tags="" position="1075,688" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And you&#39;re a most welcome sight, too.&quot;//&lt;/span&gt; You smirk. She evaluates you. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m $chPlayerCharacter.name, the Candidate of the Gaanidans.&quot;//&lt;/span&gt;

You offer your hand, and when she takes it, you pull it, bringing you two closer. Sillan raises an eyebrow, the rest of her expression intact.

Her skin is soft, gelatinous. It&#39;s wet, but it doesn&#39;t wet your skin, and it appears to be really flexible, malleable, even, and...

//Wait, what&#39;s happening?//

...Despite having taken her hand, her arm is now taking yours. The Shapeshifter is showing you the very reason of their race&#39;s name, turning her arm into an amorphous body that enfolds your wrist, your elbow, reforming its hand yet again at the end and caressing your armpit.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You&#39;re so forward, $chPlayerCharacter.name.&quot;//&lt;/span&gt; She&#39;s savoring your shock. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;You surely wouldn&#39;t mind if I am, as well...&quot;//&lt;/span&gt; Her other arm is now rubbing your waist, and moving towards your lower parts.

Then, Sillan leans in and brings your lips together, giving you a soft kiss.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;But I&#39;m getting ahead of myself.&quot;//&lt;/span&gt; She stops her hand and begins to return her opposite arm to its original shape, letting yours to go free.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I still have to finish my bath, but I&#39;m certain we&#39;ll soon have more time to... Get to know each other.&quot;//&lt;/span&gt;

After ogling your body, she turns around and goes back to the water, leaving you no choice but to leave.

//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;20 lust.&lt;/span&gt;
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;20 willpower.&lt;/span&gt;
You lost &lt;span style=&quot;color:khaki&quot;&gt;20 social drive.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Sillan has grown a lot.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Sillan has grown.&lt;/span&gt;
You gained 250 charisma experience.//

&lt;&lt;script&gt;&gt;
State.variables.chVal.lust.current -= 15;
State.variables.chVal.socialdrive.current -= 25;
State.variables.chVal.energy.current -= 30;
State.variables.chPlayerCharacter.lust.current -= 20;
State.variables.chPlayerCharacter.willpower.current -= 20;
State.variables.chPlayerCharacter.socialdrive.current -= 20;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 750;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 750;
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 350;
State.variables.chPlayerCharacter.charisma.experience += 250;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Garden Crossroads]] 
</tw-passagedata><tw-passagedata pid="65" name="FirstDay Padmiri2" tags="" position="1286,479" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hello, Mir. Can I keep you company for the time being?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Of course, please take a seat.&quot;//&lt;/span&gt;

You sit next to her, your back facing the gates, and your eyes facing the path, the forests, the hill below, the horizon and the sinking Sun.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Have you seen much of the Valley, $chPlayerCharacter.name?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I haven&#39;t. Among the Gaanidans, only adults travel, and it&#39;s almost always to trade.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;The Leirien almost never leave our tribe&#39;s surroundings. Maybe it&#39;s in our nature to remain close to our roots... But that doesn&#39;t prevent me from wondering about all life within the Goddess&#39; domains.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It seems appropiate for a High Priestess to have ample knowledge about it.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And that&#39;s why travelling accross the Valley is part of the Candidates&#39; training.&quot;//&lt;/span&gt; She seems happy about it.
\
&lt;&lt;if $chPlayerCharacter.empathy.value &gt; 10&gt;&gt; \

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I take it you see this as a great opportunity for you?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Definitely. I don&#39;t think I would have even left my tribe in my whole life, hadn&#39;t it been for this.&quot;//&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \

The conversation flows calmly, discussing some differences in food, lifestyles and customs between your peoples. Yet shortly after, you hear the sound of the gates opening.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Padmiri has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 350;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 350;
State.variables.chPlayerCharacter.relations.chMir.romance.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.romance.stv += 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;set $StVars.FirstDayWaitedWith to &quot;Mir&quot;&gt;&gt;
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Wardens1]]</tw-passagedata><tw-passagedata pid="66" name="FirstDay Nash2" tags="" position="1177,475" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hi, Nash.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hello again!&quot;//&lt;/span&gt;

The Ashwalker seems to have finished her exercises, and she&#39;s resting next to a tree.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Did you want to keep talking with me?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Of course, let me take a seat.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;So...&quot;//&lt;/span&gt; She hesitates to put the conversation in motion. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;What do your people do?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What do you mean?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I mean... We Ashwalkers have many paths in life. Some train the martial arts, others dance, or work the metals... What do the Gaanidans dedicate their lives to?&quot;//&lt;/span&gt;

//I didn&#39;t expect that question. Do we even do that?// 

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m not sure we put that much effort into anything in particular. We celebrate feasts, we also dance and we drink wine... Well, there is people who put a lot of effort into becoming good story tellers.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Do you mean... That they train to become good gossipers?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;No, not at all! Story tellers narrate tales in front of a lot of people. They have to memorize them and learn how to give them emotion. They also change how the tale goes, or even create their own.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh, that sounds like fun.&quot;//&lt;/span&gt;

You keep talking about some differences between your tribes for a short while, until you hear the sound of the gates opening, in the distance. It&#39;s time to go back.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Nashillbyir has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 350;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 350;
State.variables.chPlayerCharacter.relations.chNash.romance.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.romance.stv += 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;set $StVars.FirstDayWaitedWith to &quot;Nash&quot;&gt;&gt;
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Wardens1]] </tw-passagedata><tw-passagedata pid="67" name="FirstDay Val2" tags="" position="1288,690" size="100,100">When you reach the glade, Sillan is laid back next to the lake&#39;s shore, not paying much attention to anything. When she hears your footsteps, she lazily rolls until she&#39;s able to see you.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;My fair friend is back. How nice.&quot;//&lt;/span&gt;

You maintain a cautious attitude, evaluating her intentions. Her expression makes a vague attempt to project kindness and openness, but you can&#39;t help but wonder if it isn&#39;t too different from that of a predator preventively tasting its prey. However, she doesn&#39;t even get up from the ground, so you take a seat close to her.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hello, Sill. Did you enjoy your bath?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Oh, definitely. Especially since you came to visit me.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Um.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Tell me, my dear. What can you tell me about yourself?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I don&#39;t think there&#39;s anything too significant...? I was a lone child to loving parents. I&#39;ve always enjoyed my tribe&#39;s storytellers&#39; performances. And... I don&#39;t really stand out on anything.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Oh, I&#39;m sure you do. Even if you haven&#39;t found it just yet.&quot;//&lt;/span&gt; She keeps smiling.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So, is there anything about you you want to share?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hmm.&quot;//&lt;/span&gt; She pauses for a moment. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;I was a quiet child, who always wanted to look after others but was too shy to do anything about it. I spent most of my childhood led around from one place to another by my friend, Valtan. ...She&#39;s always up to something, that girl.&quot;//&lt;/span&gt; Her face suddenly gets dreamy, and she looks into the distance.
&lt;&lt;set $StVars.FirstDayWaitedWith to &quot;Val&quot;&gt;&gt;
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Did you like her?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hmm?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Your friend.&quot;//&lt;/span&gt;

She opens her mouth to reply, but a sound coming from far away interrupts her. It&#39;s the gates. They&#39;re opening.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Looks like it&#39;s time for us to meet the Priestesses.&quot;//&lt;/span&gt; She completely avoids the question, instead. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;We don&#39;t want to keep them waiting.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Sillan has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Sillan has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.friendship.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.friendship.stv += 350;
State.variables.chPlayerCharacter.relations.chVal.romance.stv += 100;
State.variables.chVal.relations.chPlayerCharacter.romance.stv += 100;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Wardens1]] </tw-passagedata><tw-passagedata pid="68" name="FirstDay Wardens1" tags="" position="72,575" size="100,100">Short minutes later, you and the other four Candidates are reunited in front of the gates. When Padmiri greets the last one, she takes the initiative and leads everyone inside.

The Temple&#39;s hall is one great room, with long dimensions and a daring height. The floor and the walls are made with dark gray stone slobs crafted with precision in rectangular shapes, often decorated with columns and other works of art. At its center, a giant white statue of a beautiful woman, arms and hands slightly open towards you, like a mother welcoming its small children.

In front of her feet, there are three women waiting for you.

//What&#39;s... What&#39;s that?//

One of them immediately catches your attention. She doesn&amp;#39;t look like any living creature you have ever met. Instead of skin, it looks like her body is formed by darkness itself, with a halo of tenuous lights forming around it. Her eyes, mouth, nose and other facial features are also formed by a more tenous white light. She has a long sleeveless dress covering most of her body. If she had any other expression, her face may appear to be immature for a woman - she is, however, dead serious.

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/ate-full.png]]
&lt;/div&gt; \

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Welcome, Candidates.&quot;//&lt;/span&gt; It isn&#39;t the woman whose appeareance has entranced you who is talking, but the one at the center. Slightly shorter than the other two, she&#39;s a purple Shapeshifter. She has a most peculiar hair, as her slime has taken the form of solid ice shards that form an inverted cone from her jaw upwards.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;My name is Drishtya, and I&#39;m the Priestess Regent. I was chosen by the previous High Priestess to take over her functions once she died, and manage the Temple until the new High Priestess was chosen. This also means I will be in charge of your education.&quot;//&lt;/span&gt; She pauses for a moment.

&lt;script&gt;setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharCustomName(&quot;chVal&quot;,&quot;Sill&quot;)]);&lt;/script&gt; \
[[Continue|FirstDay Wardens2]]</tw-passagedata><tw-passagedata pid="69" name="FirstDay Nash2b" tags="" position="631,581" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Look,&quot;//&lt;/span&gt; you tell her, &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I clearly overreacted earlier. I wanted to apologize.&quot;//&lt;/span&gt;

She remains silent for a moment, evaluating the situation.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Where is your motivation to beat my ass?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Um. Nowhere. Not anymore.&quot;//&lt;/span&gt;

The Ashwalker sighs.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Fine. What are you willing to do to show me you really mean it?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh... As long as it isn&#39;t something excessive...&quot;//&lt;/span&gt;

She takes it as if you have agreed to her request. //Whatever it is.//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;The truth is that I&#39;m sore from my training.&quot;//&lt;/span&gt; She pulls her gi&#39;s shoulders away from her shoulders. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;I would appreciate it If you massaged me.&quot;//&lt;/span&gt;

//That... is actually nothing extreme.//
&lt;&lt;set $StVars.FirstDayWaitedWith to &quot;Nash&quot;&gt;&gt;
[[Continue|FirstDay Nash2b2]]</tw-passagedata><tw-passagedata pid="70" name="FirstDay Nash2b2" tags="" position="521,581" size="100,100">Her skin is only slightly rougher than your own, and it&#39;s still soft. When your restlessness starts to fade, you actually enjoy touching her. The smell of her hair and the sight of its exotic texture are also kind of nice.

//Perhaps I misjudged her? She could have abused my good will, but she only asked me for this.//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Nnnhh... Aaah...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m glad you like my hands.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;They came when I needed them the most.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So... Do all Ashwalkers train to become warriors?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;No, not all. Not even half of us practice martial arts regularly. There are many that prefer dancing, or forging tools and weapons...&quot;//&lt;/span&gt;

//If half the Gaanidans became warriors we&#39;d have A LOT of warriors.//

You keep chitchatting for a few minutes until you finish with her shoulders, and she gets up.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That was great! It would be great if you did this often. Perhaps every day... But I guess I no longer have a reason to beat your ass, I also wanted to do that.&quot;//&lt;/span&gt;

You are still kneeling in front of her, your head in front of her waist. Her comment makes you turn your eyes down.

[[Ask her if her legs are sore too, after today&#39;s travel|FirstDay Nash2b3]]
[[Tell her you can massage her everyday|FirstDay Nash2b3]]
[[Offer your ass for her to beat it|FirstDay Nash2b3]]
[[Remain silent|FirstDay Nash2b3]]
[[That wasn&#39;t kind of her, after what you&#39;ve done|FirstDay Nash2b3]]</tw-passagedata><tw-passagedata pid="71" name="FirstDay Nash2b3" tags="" position="410,580" size="100,100">You move your head, and-

The sound of the gates opening, in the distance.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That&#39;s our cue.&quot;//&lt;/span&gt;

Nash gets moving.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;We&#39;ll finally be received in the Temple, let&#39;s go.&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;10 lust&lt;/span&gt;.
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;20 willpower&lt;/span&gt;.
You lost &lt;span style=&quot;color:limegreen&quot;&gt;30 energy&lt;/span&gt;.
&lt;span style=&quot;color:khaki&quot;&gt;Your enmity with Nashillbyir has fallen.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your rivalry with Nashillbyir has fallen.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has slighty grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Nashillbyir has grown a lot.&lt;/span&gt;
You gained 100 physique experience.
You gained 100 resilience experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 20;
State.variables.chPlayerCharacter.lust.current -= 10;
State.variables.chPlayerCharacter.energy.current -= 30;
State.variables.chPlayerCharacter.relations.chNash.rivalry.stv = 0;
State.variables.chNash.relations.chPlayerCharacter.rivalry.stv = 0;
State.variables.chPlayerCharacter.relations.chNash.enmity.stv = 0;
State.variables.chNash.relations.chPlayerCharacter.enmity.stv = 0;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 350;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 350;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 100;
State.variables.chPlayerCharacter.relations.chNash.submission.stv += 750;
State.variables.chNash.relations.chPlayerCharacter.domination.stv += 750;
State.variables.chPlayerCharacter.physique.experience += 100;
State.variables.chPlayerCharacter.resilience.experience += 100;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Wardens1]]</tw-passagedata><tw-passagedata pid="72" name="FirstDay Wardens2" tags="" position="184,575" size="100,100">&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Now, each of you will step forward and introduce yourselves, and explain how your tribe chose you. Leirien Candidate, you may begin.&quot;//&lt;/span&gt;

Padmiri makes a small cough. She looks at the Priestess Regent in the eyes and speaks with great confidence.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;m Padmiri, Candidate of the Leirien tribe. I was chosen by my peers as the most apt to represent them.&quot;//&lt;/span&gt;

Drishtya nods, and asks Nash to proceed. She imitiates Mir&#39;s tone.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;m Nashillbyir, Candidate of the Ashwalkers. I was chosen by my tribe by defeating all other elegible women in martial combat.&quot;//&lt;/span&gt;

Drishtya asks you to continue.

//I should follow along, right?//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m $chPlayerCharacter.name, Candidate of the Gaanidans. I was chosen by lottery among all elegible women.&quot;//&lt;/span&gt;

Just explaining yourself makes you nervous. The reason why you were chosen plays a big role in why this whole situation makes you feel so intimidated. However Drishtya&#39;s expression doesn&#39;t change, which makes you feel a tiny bit of validation. You don&#39;t look at anyone else.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;The Beastkin Candidate.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;My name is Fiercest Claw. My father sent me to get the High Priestesshood, and that&#39;s what I&#39;m going to do.&quot;//&lt;/span&gt;

The Regent doesn&#39;t react to this declaration either. She now asks her fellow Shapeshifter to take her turn. Sill smiles before she starts.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;My name is Sillan, and I was unanimously chosen by my tribe to become the Shapeshifter Candidate.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;You are going to try again, and this time you will not lie to me. Who are you?&quot;//&lt;/span&gt;

Silence follows. Everyone looks at Sill, many faces astonished. Her smile shows a small crack.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I beg your pardon?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;You know perfectly well what I mean. Tell us who you are and why you&#39;re here, or you will be forcing the Priestesshood to punish you.&quot;//&lt;/span&gt;

Yet another silence. The blue Shapeshifter slowly accepts she&#39;s cornered.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Fine.&quot;//&lt;/span&gt; Her shattered smile subsudes, then she smirks. Mischievously. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;My name is Valtan. Or Val for friends.&quot;//&lt;/span&gt; She goes out of her way to wink to you. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;I took the appeareance of my friend Sillan, who was unanimously chosen by my tribe, in order to fool them and take her place as the Candidate.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That&#39;s better.&quot;//&lt;/span&gt; The Regent turns her face, ready to move on, but she&#39;s interrupted.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Wait.&quot;//&lt;/span&gt; Valtan says. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;I just said I&#39;m not the rightful Candidate. I fooled my whole tribe, your tribe, to supplant the real one. Is that all you&#39;re going to say? And how did you know about me, anyway?&quot;//&lt;/span&gt;

Drishtya looks at Valtan with a small hint of tiredness. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;How you were sent by your tribe is not important. If you have come in their name, the Goddess approves, and you&#39;re a rightful Candidate, as long as the Temple is concerned. Your tribe, however, may disagree. That&#39;s an issue you will have to solve in time. With them.&quot;//&lt;/span&gt;

Valtan is perplexed. Shortly after, she laughs for several seconds. And once she&#39;s stopped, the purple Shapeshifter proceeds.

&lt;script&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;)]);&lt;/script&gt; \
[[Continue|FirstDay Wardens3]]</tw-passagedata><tw-passagedata pid="73" name="FirstDay Wardens3" tags="" position="296,576" size="100,100">&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;And finally, the Aiishen Candidate.&quot;//&lt;/span&gt;

The girl made of pure darkness steps forward.

//What? She is the Aiishen, the missing Candidate? Why was she already in the Temple?//

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Greetings, everyone. My name is Maaterasu. I am the Candidate of the Aiishen tribe. The stars chose me.&quot;//&lt;/span&gt; Her expression doesn&#39;t change at any moment, always remaining serious.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;As you must be aware, the Candidates weren&#39;t supposed to enter the Temple until a few minutes ago. You will have to excuse her. As you may or may not know, the Aiishen are beings partially made of energy, and they&#39;re subjected to the whims of the Goddess&#39; energy waves. As such, she wouldn&#39;t be able to travel during these days, and she&#39;s been waiting here since last week.&quot;//&lt;/span&gt;

//I should find a chance to get to know her. Or anything about them, in general.//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;And finally, my friend at my left.&quot;//&lt;/span&gt; She points to the third person: an old Ashwalker woman wearing a dark grey robe.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Greetings, Candidates. Ny name is Shrezdill, and I&#39;m one of the Temple Wardens. I&#39;ll be glad to answer any doubts you have regarding your training.&quot;//&lt;/span&gt; 

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Speaking of which...&quot;//&lt;/span&gt;

&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Continue|FirstDay Wardens4]]</tw-passagedata><tw-passagedata pid="74" name="FirstDay Wardens4" tags="" position="78,678" size="100,100">&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It&#39;s mandatory for me to explain what you have come here for, even though I&#39;m certain all of you are aware.&quot;//&lt;/span&gt;

She closes her eyes and meditates for a couple of seconds, and continues talking.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;The Confined Valley is protected by the Goddess.&quot;//&lt;/span&gt; Drishtya points to the statue behind herself. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;The Goddess maintains her energy, her spirit herself, flowing through her domains. She takes a toll on her subjects, which we pay with each of our daily actions, honoring her. In turn, she protects us. Within the Valley, life is precious, a sacred gift which is to be appreciated and enjoyed, and one that is not easily lost. Outside the Valley, life is short and tragic, a small miracle that doesn&#39;t take long to die to sickness and pain.

Our duty in the Temple is to keep the Valley in harmony with her spirit.

To fulfill this goal, you must become dign agents of the Goddess, which requires you to understand all dimensions of life, as well as being well experienced in them. You will learn the arts of magic, combat and love.&quot;//&lt;/span&gt;

//She means sex, doesn&#39;t she?//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Once your training is finished, one of you will be chosen High Priestess, who will lead all the others, as well as the rest of the Temple, in the mission of maintaining peace, order and harmony in the Valley.&quot;//&lt;/span&gt;

She pauses and examines each of you, and you follow along. Padmiri seems calm and happy. Nash has crossed her arms. Valtan seems agitated. Maaterasu is as serious as ever. And Claw...

//She looks angry.//

Drishtya clears her throat and continues.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;To this respect, it&#39;s true that different philosophies have coexisted in the Valley for centuries. They guide their followers on how to traverse their road through life... In how they relate to others, to their tribe, and to their loved ones. In respect to the late High Priestess, I shall follow the Way of Nurtured Harmony to tutor you during your training, but conflict and evolution are natural parts of the Valley, and I shall respect your adherence to other Ways, and you will have increasing freedom to adopt them all: the Way of Celebrated Union, the Way of Exclusive Love... And yes, Claw, that includes that Way of Imposed Domination that you appear so adamant to follow.

Keeping the peace, after all, implies resolving conflicts, and sometimes these require change and growth.&quot;//&lt;/span&gt;

//...I think I lost her here. What are those Ways she&#39;s talking about?//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I&#39;m certain that, at the bottom of your heart, all of you desire the same thing: the well-being of the Valley&#39;s inhabitants. We will offer you all of our knowledge, all of our resources, our wisdom and our chambers. But as Priestesses to be, it is up to you to find out the answers - to find out how to express your love.

And I think this concludes the introductions. You will now be taken to your chambers, for I&#39;m certain this has been a long day for all of you. Tomorrow you will be shown the Temple, and most importantly, the ceremony of initiation will take place.&quot;//&lt;/span&gt;

[[Continue|FirstDay Wardens5]]</tw-passagedata><tw-passagedata pid="75" name="FirstDay Wardens5" tags="saveAllowed" position="183,679" size="100,100">After they exchange a gesture, Drishtya leaves, and Shrezdill asks the rest of you to follow her. You pass through a door on a side of the hall, and walk the Temple corridors and stairs.

No natural light enters them - small torches illuminate your path. Only your steps can be heard, and occasionally some short airstream.

One by one, Shrezdill assigns a room to each of the Candidates, and they leave the group. You get the last one. The Priestess leaves you alone to enter it, and when you do, you&#39;re left astonished.

The room itself is as big as the biggest Gaanidan house. It has a huge bed with red sheets, wardrobes and closets, a large mirror, some plants, a desk and even a decently sized pool. If there&#39;s any moment of your life you have known the meaning of material luxury, it&#39;s this one.

&lt;span style=&quot;color:green&quot;&gt;You can save the game!&lt;/span&gt;

&lt;&lt;if $StVars.FirstDayWaitedWith is &quot;Mir&quot;&gt;&gt; \
&lt;script&gt;setPasChars([getPresentCharByKey(&quot;chMir&quot;)]);&lt;/script&gt; \
[[Rest and finish the day|FirstDay RoomWithMir]]
&lt;&lt;elseif $StVars.FirstDayWaitedWith is &quot;Nash&quot;&gt;&gt; \
&lt;script&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);&lt;/script&gt; \
[[Rest and finish the day|FirstDay RoomWithNash]]
&lt;&lt;else&gt;&gt; \
&lt;script&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;)]);&lt;/script&gt; \
[[Rest and finish the day|FirstDay RoomWithVal]]
&lt;&lt;/if&gt;&gt;</tw-passagedata><tw-passagedata pid="76" name="FirstDay RoomWithMir" tags="" position="292,682" size="100,100">You sit next to the pool and observe the water.

//Perhaps I will like it here after all.//

The water isn&#39;t completely still, it flows in a clear direction. On a closer inspection, it looks like there&#39;s a couple of small holes in each extreme of the pool, each of them bringing the liquid in or taking it away.

//I&#39;ve had at least one bad experience... But there&#39;s nice people here too. Perhaps I should befriend some of the other girls. ...My family wouldn&#39;t like me being alone, right?//

Just as these words flow through your mind, someone knocks at your door. When you react, you get up and ask:

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Who is it?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Hello, $chPlayerCharacter.name, it&#39;s me.&quot;//&lt;/span&gt; //It&#39;s Mir.// &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Can I come in? I wanted to talk to you for the last time before the night.&quot;//&lt;/span&gt;

You open the door.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Welcome.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Hello again.&quot;//&lt;/span&gt; She enters your room and contemplates it for a moment. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Are you feeling homesick already?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;To tell the truth... I am.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That makes two of us.&quot;//&lt;/span&gt; She smiles melancholically. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;I thought that... Perhaps...&quot;//&lt;/span&gt; She moves a hand through the surface of her neck, the side of her torso, her waist. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;We could get to know each other better? In... Your bed. To not to feel as homesick.&quot;//&lt;/span&gt;

[[Accept|FirstDay RoomWithMirAccept]]
[[Not this time|FirstDay RoomWithMirReject]]</tw-passagedata><tw-passagedata pid="77" name="FirstDay RoomWithNash" tags="" position="76,787" size="100,100">You sit next to the pool and observe the water.

//Perhaps I will like it here after all.//

The water isn&#39;t completely still, it flows in a clear direction. On a closer inspection, it looks like there&#39;s a couple of small holes in each extreme of the pool, each of them bringing the liquid in or taking it away.

//I&#39;ve had at least one bad experience... But there&#39;s nice people here too. Perhaps I should befriend some of the other girls. ...My family wouldn&#39;t like me being alone, right?//

Just as these words flow through your mind, someone knocks at your door. When you react, you get up and ask:

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Who is it?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hi, I&#39;m Nash!&quot;//&lt;/span&gt;

You quickly get up, move to the door and let her inside.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hello, what brings you here?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hah, um, well.&quot;//&lt;/span&gt; She&#39;s nervous, but she doesn&#39;t look scared. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;You know how we&#39;re supposed to train in all aspects of life, right? And one of them is...&quot;//&lt;/span&gt; The Ashwalker looks aside, and she invites you to look in the same direction. //It&#39;s the bed.// &lt;span @style=$chNash.colorStyleKey&gt;//&quot;After today&#39;s workout, I really am in the mood, and I&#39;d like to give it a try. With you.&quot;//&lt;/span&gt;

[[Accept|FirstDay RoomWithNashAccept]]
[[Not this time|FirstDay RoomWithNashReject]]</tw-passagedata><tw-passagedata pid="78" name="FirstDay RoomWithVal" tags="" position="510,788" size="100,100">You sit next to the pool and observe the water.

//Perhaps I will like it here after all.//

The water isn&#39;t completely still, it flows in a clear direction. On a closer inspection, it looks like there&#39;s a couple of small holes in each extreme of the pool, each of them bringing the liquid in or taking it away.

//I&#39;ve had at least one bad experience... But there&#39;s nice people here too. Perhaps I should befriend some of the other girls. ...My family wouldn&#39;t like me being alone, right?//

Just as these words flow through your mind, someone knocks at your door. When you react, you get up and ask:

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Who is it?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I&#39;m love itself, knocking at your door.&quot;//&lt;/span&gt; //It&#39;s Sill. I mean, Valtan.//

You get up and let her in.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Isn&#39;t life full of surprises? Sometimes it enters your home without calling and it tells you which names you can take and which ones you can&#39;t.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I certainly never had the chance to pretend to be someone else.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;But did I?&quot;//&lt;/span&gt; The Shapeshifter smiles wildly and squints, looking at you. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;I may have used another name, another mask, but my self was true to you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So why have you come to my room?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I came for dessert.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But I have no food.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;And for dessert, I meant you.&quot;//&lt;/span&gt;

//Oh.//

[[Accept sex|FirstDay RoomWithValAccept]]
[[Not this time|FirstDay RoomWithValReject]]</tw-passagedata><tw-passagedata pid="79" name="FirstDay RoomWithMirAccept" tags="" position="401,684" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I... I want you too, Mir.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That&#39;s so nice to hear.&quot;//&lt;/span&gt; Her eyebrows rise and her eyes open up. Her face gets brighter.

You approach her slowly, and you take each other hands. You see yourself in her own pupils, and you feel her breath in your face. Getting closer.

You look at each other one last time, and...

Your lips meet. It&#39;s a soft encounter. Slow and kind.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Come, let&#39;s go to the bed.&quot;//&lt;/span&gt;

&lt;&lt;link &quot;Continue&quot; &quot;Scene&quot;&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startScene(
&quot;ss&quot;, &quot;dynamic&quot;,
[&quot;chPlayerCharacter&quot;], [&quot;chMir&quot;],
&quot;The water flows quietly.&quot;,
reachTurnLimitEndCondition, 30,
&quot;FirstDay RoomWithMirSceneEnding&quot;);

State.variables.chMir.aiAlgorythm = createAiWeightedMissionsByTaste();
State.variables.chMir.aiAlgorythm.fixedTarget = &quot;chPlayerCharacter&quot;;
State.variables.chMir.aiAlgorythm.setRoleRomantic();

State.variables.sc.customScript = function() {
	switch(this.currentTurn) {
		case 2:
			this.headingDescription = &#39;&lt;span style=&quot;color:Khaki&quot;&gt;Tutorial: During sex scenes, the &quot;leading&quot; character is allowed to change positions and begin continued actions.&lt;/span&gt;\n\n&#39;			
			+ &#39;The water flows quietly.&#39;;
			break;
		case 3:
			this.headingDescription = &#39;&lt;span style=&quot;color:Khaki&quot;&gt;Tutorial:  Some scenes have dynamic leaders: this means you can take the lead when your lead bar is full. In this case, select the &quot;Attempt to take Lead&quot; option, and you may get the lead at the end of the turn. This option does not end your turn and you will be able to perform an action afterwards.&lt;/span&gt;\n\n&#39;			
			+ &#39;The water flows quietly.&#39;;
			break;
		case 4:
			this.headingDescription = &#39;The water flows quietly.&#39;;
			break;
	}
};
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="80" name="FirstDay RoomWithMirReject" tags="" position="616,687" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m too tired after today. I&#39;m sorry, Padmiri.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Oh.&quot;//&lt;/span&gt;

Silence follows. She gets nervous. She doesn&#39;t know where to look at.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I hope you sleep well, though.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Of course, likewise!&quot;//&lt;/span&gt; She briefly strokes your arm. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;See you tomorrow.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Good night.&quot;//&lt;/span&gt;

&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Go to sleep|SecondDay Rise]]</tw-passagedata><tw-passagedata pid="81" name="FirstDay RoomWithMirSceneEnding" tags="" position="510,684" size="100,100">&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I loved that.&quot;//&lt;/span&gt;

You feel her breath on your skin, as well as yours bouncing to back from hers.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So did I.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I should be getting back to my room. We don&#39;t want the Priestesses to know we&#39;re this... Precocious, do we?&quot;//&lt;/span&gt; She says playfully.

You wish her good night and kiss her lips, and she leaves.

//&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Padmiri has grown a lot.
Your sexual tension with Padmiri has grown a lot.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.romance.stv += 750;
State.variables.chMir.relations.chPlayerCharacter.romance.stv += 750;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 750;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 750;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Go to sleep|SecondDay Rise]]</tw-passagedata><tw-passagedata pid="82" name="SecondDay Rise" tags="saveAllowed" position="291,893" size="100,100">In the morning, a strange sensation impregnates your body. Constant waves go through you, as if a huge sound was making your skin vibrate.

//This is weird, but pleasant.//

The waves are soon accompanied by music: a low-pitched wind instrument plays long notes... In your head. It is calm enough to avoid causing you stress when it wakes you up, but interesting enough to activate your mind and filling you with desire to leave the bed. You don&#39;t question it too much and get yourself dressed and ready to begin the day.

&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.restoreBars();
State.variables.chNash.restoreBars();
State.variables.chMir.restoreBars();
State.variables.chVal.restoreBars();
&lt;&lt;/script&gt;&gt; \
&lt;span style=&quot;color:springgreen&quot;&gt;You were completely healed.&lt;/span&gt;

&lt;span style=&quot;color:green&quot;&gt;You can save the game!&lt;/span&gt;

[[Go to the Temple&#39;s Hall|SecondDay StartProper]]</tw-passagedata><tw-passagedata pid="83" name="FirstDay RoomWithNashAccept" tags="" position="181,785" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Okay.&quot;//&lt;/span&gt;

You keep looking at her, and you advance slowly. She does the same, more decidedly, and places her hands on your arms.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Out of words?&quot;//&lt;/span&gt; She asks playfully. 

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I have something at the tip of my tongue, but it&#39;s something else. Want to see it?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Sure, show me.&quot;//&lt;/span&gt;

And you quickly attack her lips. Your strike is fast and precise, and you immediately retreat after stealing a kiss.

//I can feel my heart pounding.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What, you can&#39;t reply to a surprise attack?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh, you-&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Come, let&#39;s go to the bed.&quot;//&lt;/span&gt;

&lt;&lt;link &quot;Continue&quot; &quot;Scene&quot;&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startScene(
&quot;ss&quot;, &quot;dynamic&quot;,
[&quot;chPlayerCharacter&quot;], [&quot;chNash&quot;],
&quot;The water flows quietly.&quot;,
reachTurnLimitEndCondition, 30,
&quot;FirstDay RoomWithNashSceneEnding&quot;);

State.variables.chNash.aiAlgorythm = createAiWeightedMissionsByTaste();
State.variables.chNash.aiAlgorythm.fixedTarget = &quot;chPlayerCharacter&quot;;
State.variables.chNash.aiAlgorythm.setRoleEqualFooting();

State.variables.sc.customScript = function() {
	switch(this.currentTurn) {
		case 2:
			this.headingDescription = &#39;&lt;span style=&quot;color:Khaki&quot;&gt;Tutorial: During sex scenes, the &quot;leading&quot; character is allowed to change positions and begin continued actions.&lt;/span&gt;\n\n&#39;			
			+ &#39;The water flows quietly.&#39;;
			break;
		case 3:
			this.headingDescription = &#39;&lt;span style=&quot;color:Khaki&quot;&gt;Tutorial:  Some scenes have dynamic leaders: this means you can take the lead when your lead bar is full. In this case, select the &quot;Attempt to take Lead&quot; option, and you may get the lead at the end of the turn. This option does not end your turn and you will be able to perform an action afterwards.&lt;/span&gt;\n\n&#39;			
			+ &#39;The water flows quietly.&#39;;
			break;
		case 4:
			this.headingDescription = &#39;The water flows quietly.&#39;;
			break;
	}
};
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="84" name="FirstDay RoomWithNashReject" tags="" position="401,785" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m sorry Nash, but my body is asking me for rest.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh.&quot;//&lt;/span&gt; She looks dejected. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;That&#39;s... Fine. Have a good night then.&quot;//&lt;/span&gt;

She avoids looking at you in the eye.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sleep well you too.&quot;//&lt;/span&gt;

&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Go to sleep|SecondDay Rise]]</tw-passagedata><tw-passagedata pid="85" name="FirstDay RoomWithNashSceneEnding" tags="" position="290,787" size="100,100">&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That was a lot of fun, actually.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I was really nervous, to be honest, but I liked it too.&quot;//&lt;/span&gt;

Your mouths meet and gently grab each other&#39;s lips.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I think I&#39;ll leave soon.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I hope we do this again.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Of course! But watch out for me, perhaps it&#39;ll be you who gets attacked by surprise, the next time.&quot;//&lt;/span&gt;

You grin at her joke as she gets up and leaves.

//&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Nashillbyir has grown a lot.
Your sexual tension with Nashillbyir has grown a lot.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.romance.stv += 750;
State.variables.chNash.relations.chPlayerCharacter.romance.stv += 750;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 750;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 750;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Go to sleep|SecondDay Rise]]</tw-passagedata><tw-passagedata pid="86" name="FirstDay RoomWithValAccept" tags="" position="74,872" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think I&#39;m in the mood for some gelatine.&quot;//&lt;/span&gt; She smirks at your comment.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;And this gelatine is in the mood for you.&quot;//&lt;/span&gt;

Valtan walks towards you leaning her waist left and right. She leans her torso and head down, sticks her breasts out, looks at you and pretends to kiss you across the distance. It isn&#39;t long before she&#39;s envolping you with her arms in a hug, stroking your back and what&#39;s below it, too. Despite your insecurities, you follow along and begin to french kiss her.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Let&#39;s go to the bed.&quot;//&lt;/span&gt;

&lt;&lt;link &quot;Continue&quot; &quot;Scene&quot;&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startScene(
&quot;ss&quot;, &quot;dynamic&quot;,
[&quot;chPlayerCharacter&quot;], [&quot;chVal&quot;],
&quot;The water flows quietly.&quot;,
reachTurnLimitEndCondition, 30,
&quot;FirstDay RoomWithValSceneEnding&quot;);

State.variables.chVal.aiAlgorythm = createAiWeightedMissionsByTaste();
State.variables.chVal.aiAlgorythm.fixedTarget = &quot;chPlayerCharacter&quot;;
State.variables.chVal.aiAlgorythm.setRoleActive();

State.variables.sc.customScript = function() {
	switch(this.currentTurn) {
		case 2:
			this.headingDescription = &#39;&lt;span style=&quot;color:Khaki&quot;&gt;Tutorial: During sex scenes, the &quot;leading&quot; character is allowed to change positions and begin continued actions.&lt;/span&gt;\n\n&#39;			
			+ &#39;The water flows quietly.&#39;;
			break;
		case 3:
			this.headingDescription = &#39;&lt;span style=&quot;color:Khaki&quot;&gt;Tutorial:  Some scenes have dynamic leaders: this means you can take the lead when your lead bar is full. In this case, select the &quot;Attempt to take Lead&quot; option, and you may get the lead at the end of the turn. This option does not end your turn and you will be able to perform an action afterwards.&lt;/span&gt;\n\n&#39;			
			+ &#39;The water flows quietly.&#39;;
			break;
		case 4:
			this.headingDescription = &#39;The water flows quietly.&#39;;
			break;
	}
};
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="87" name="FirstDay RoomWithValReject" tags="" position="613,789" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m... The truth is, I&#39;m not in the mood. I&#39;m too tired, after the whole day.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hmm.&quot;//&lt;/span&gt; She looks at you, calculating. Trying to read you. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;Another time, then. I promise you will love my touch.&quot;//&lt;/span&gt; She winks.

You look down, then to the side.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;But for now, you need to sleep, don&#39;t you? I won&#39;t steal any more of your time.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Good night, Valtan.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Sweet dreams, $chPlayerCharacter.name. You&#39;ll meet me in them.&quot;//&lt;/span&gt;

&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Go to sleep|SecondDay Rise]]

</tw-passagedata><tw-passagedata pid="88" name="FirstDay RoomWithValSceneEnding" tags="" position="185,891" size="100,100">&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I wanted to do that since the moment I met you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That was great.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;And there&#39;s more waiting for you... Look forward to it.&quot;//&lt;/span&gt;

The Shapeshifter gets up from the bed and stretches her arms towards the sides.

//Wait, do they do that?//

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I think I should go back to my room.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, you have caught a lot of attention already. In just your first day.&quot;//&lt;/span&gt;

Her expression tells you she&#39;s taken it as a compliment.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I&#39;ll meet you in your dreams.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Good night.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Valtan has grown a lot.
Your sexual tension with Valtan has grown a lot.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.romance.stv += 750;
State.variables.chVal.relations.chPlayerCharacter.romance.stv += 750;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 750;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 750;
&lt;&lt;/script&gt;&gt; \
&lt;script&gt;setNoPasChars()&lt;/script&gt; \
[[Go to sleep|SecondDay Rise]]</tw-passagedata><tw-passagedata pid="89" name="SecondDay StartProper" tags="" position="399,893" size="100,100">When you reach the Temple&#39;s hall, you find Drishtya, Padmiri, Nashillbyir, Valtan and Maaterasu.

The Priestess Regent greets you.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Welcome, $chPlayerCharacter.name. I trust your bedroom is well adapted to your needs?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s... A way to put it. It&#39;s far better than my home back at the tribe.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Yes, that&#39;s often the case.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What was the music I was hearing a few minutes earlier?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That&#39;s our way to communicate to our residents that it&#39;s time to wake up. As you must have noticed, the Temple&#39;s corridors block light and sound, so we send music directly into everyone&#39;s minds.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, but how...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Welcome, Fiercest Claw.&quot;//&lt;/span&gt;

You turn around and notice the Beastkin, who&#39;s just arrived.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I trust your bedroom is suited to your needs?&quot;//&lt;/span&gt;

The Beastkin doesn&#39;t reply at first, but the Priestess&#39; penetrating eyes force her to answer.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;It&#39;s fine enough.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I&#39;m glad to hear that.&quot;//&lt;/span&gt;

&lt;script&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;/script&gt; \
[[Continue|SecondDay TrainingDiscussion]]</tw-passagedata><tw-passagedata pid="90" name="SecondDay TrainingDiscussion" tags="" position="506,893" size="100,100">&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Now that everyone&#39;s here, I&#39;ll tell you about the specifics of your life here.&quot;//&lt;/span&gt;

The Shapeshifter moves aside, away from the 6 of you and right next to the Goddess statue.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;During your training period, we will channel a considerable amount of the Goddess&#39; energy into the Temple, which will be used to strengthen your advances. This means you&#39;ll be able to improve yourselves far faster than ever in the rest of your lives, but it comes at the cost of depriving the peoples of the Valley of a portion of their protection. Therefore, I expect all of you to take your duties seriously, so that your training is finished as soon as possible. Understood?&quot;//&lt;/span&gt;

Drishtya waits for your affirmative responses, and then proceeds.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Your training will take place during the mornings, in the Training Halls, an area with several facilities and means to develop your skills. During afternoons, you will take care of different tasks required to maintain life in the Temple. Evenings are reserved to rest and socialization.

Any questions?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Can we challenge the other Candidates?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Of course. Competition is a part of training.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Can we force the others to give up something if they lose a challenge?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;...Yes. It was a custom during some generations, so it will be allowed. However, I will dictate the limits of what&#39;s an acceptable penalty. The limits will be thin at first, but I&#39;ll be willing to widen them as time progresses.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I had another question.&quot;//&lt;/span&gt; Val intervenes. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;When is it appropiate to indulge in... The arts of pleasure?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Whenever the context allows it. If it helps the training, it&#39;s allowed during mornings. If it helps during work, it&#39;s allowed during afternoons. It&#39;s always allowed during the evenings.

Anything else?&quot;//&lt;/span&gt;

Silence follows.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I&#39;ll proceed, then. If the conditions are appropiate, we will also organize expeditions to different parts of the Valley. At the very least, I&#39;d like us to visit the six tribes, but there are also some locations important for its wildlife. If you&#39;re to guide the peoples of the Valley through their lives, it&#39;s only logical that you get to know the Valley, its different peoples and its customs.&quot;//&lt;/span&gt;

You take a look at Val.

//She&#39;s a bit uneasy.//

&lt;script&gt;setPasChars([getPresentCharByKey(&quot;chMir&quot;)]);&lt;/script&gt; \
[[Continue|SecondDay RelationsDiscussion]]</tw-passagedata><tw-passagedata pid="91" name="SecondDay RelationsDiscussion" tags="" position="616,894" size="100,100">&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;During this period, it is only natural that you get to know each other. It is important that you learn to get along, since you will likely work together in many occasions for the rest of your lives. However, since you&#39;re competing for one of the biggest honors of the Valley, it is also natural that you will sometimes find yourselves pitted against each other. For this reason, many Candidates in the past have developed strong rivalries, or signed alliances against each other. I do not support Candidates doing it, but eventually you will also be allowed to join each other in exclusive relationships as dictated by the Way of Exclusive Love, or to lend yourselves to others in servitude as dictated by other Ways.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;In... Servitude? What does that mean?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It means that someone will become someone else&#39;s servant, for a specified time, be it as a result of a challenge or any kind of deal.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I... Do not like that.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Many share your concerns. If you voice them regarding someone&#39;s behavior, you may join efforts with other Candidates in order to punish their continued attitude.

But I must warn you: there were generations in which it was common for one or two Candidates to keep the others in their service for the vast majority of the time, up until they won the High Priestesshood. The same way you can warn the others against these practices, others may seduce you into accepting them.&quot;//&lt;/span&gt;

//Mir is really serious. I don&#39;t think I had seen that expression in her yet.//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;In relation to this matter, you must also know: The Priestesshood will often impose sanctions or privileges to selected Candidates. This is because you mustn&#39;t only show your capacities, but your capacity to grow - if any of you dominated the competition at any point, you may deprive the rest of the opportunity to catch up with you. We will take measures to ensure that Candidates with excessive lead face bigger obstacles, and Candidates with trouble to keep up are granted advantages.&quot;//&lt;/span&gt;

&lt;script&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;/script&gt; \
[[Continue|SecondDay VictoryDiscussion]]</tw-passagedata><tw-passagedata pid="92" name="SecondDay VictoryDiscussion" tags="" position="49,996" size="100,100">&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Excuse me, Priestess Regent.&quot;//&lt;/span&gt; Ate intervenes. The unexpected words of someone who has only talked when absolutely required call unavoidable attention. &lt;span @style=$chAte.colorStyleKey&gt;//&quot;How will the new High Priestess be chosen?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That&#39;s a great question, Maaterasu. The new High Priestess will be chosen by the Candidates themselves, that is: all of you.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;But all of us want to become High Priestess. How are we expected to support anyone but ourselves?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That&#39;s why it&#39;s a great question. The process itself is never easy. It&#39;s never immediate. During each generation there&#39;s always a few Candidates that come to believe in someone else&#39;s excellence to represent the Goddess, but that is usually not enough. When that happens, all Candidates agree on different trials that will test everyone&#39;s worth. If the election becomes excessively lengthy, the Priestess Regent is expected to arbitrate it.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What kind of trials were chosen other generations?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;There has been variety. The simplest ones consist in competitions of strength and magic. Trials to generate as much pleasure as possible to others were also common. There have also been public trials in which different witnesses testified about a Candidate&#39;s capacity to solve conflicts, to lead others, to keep the peace on the Valley.

In short words, if you want to become the next High Priestess, you must pay considerable attention to nurture your relationships with others, to develop yourselves as agents of the Goddess, well-versed in many skills and lore, and to prove your capacity to do good to the Temple and the Valley.&quot;//&lt;/span&gt;

&lt;script&gt;setPasChars([]);&lt;/script&gt; \
[[Continue|SecondDay RitualOfAvatars]]</tw-passagedata><tw-passagedata pid="93" name="SecondDay RitualOfAvatars" tags="" position="174,999" size="100,100">&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I think that sums up everything you need to know so far.&quot;//&lt;/span&gt;

Drishtya takes a moment to look at everyone, walking slowly between two points.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;We can begin the Ritual of Avatars.&quot;//&lt;/span&gt;

Everyone remains silent. Some Candidates seem to be as lost as you. The purple Shapeshifter catches on and explains:

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;As you already know, the Goddess protects and nurtures all life in the Valley. In consequence, it&#39;s fair to claim we&#39;re partly created by her: everything around us, including ourselves, grows and thrives under her, making it yet another one of her dimensions.&quot;//&lt;/span&gt; She pauses to let you reflect on her words. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;This means that everyone who aims to represent her must fill those dimensions as well. You, who were born women, are as incomplete as anyone who had been born a man. You, who show talent in magic or athletism, are as incomplete as anyone who shows the opposite. You, who love nature or the crafts, are as incomplete as anyone who appreciates the other dimensions of life. We assume it is impossible for us mortals to achieve the completeness of the Goddess, but as her Avatars, you must strive to achieve it.

The Ritual of Avatars will drive you much closer to that goal.

Are you ready to perform the Ritual and swear to grow closer to the Goddess, for the rest of your lives?&quot;//&lt;/span&gt;

//This... Looks like an important decision.//

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I am.&quot;//&lt;/span&gt;

//Perhaps the most important decision I have taken in my whole life.//

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I am.&quot;//&lt;/span&gt;

//What does this mean again?//

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I am.&quot;//&lt;/span&gt;

//She hasn&#39;t explained much about it.//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I am.&quot;//&lt;/span&gt;

//Everyone seems to be so... decided.//

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I am.&quot;//&lt;/span&gt;

//What if I regret it?//

Drishtya is looking at you.

//She&#39;s waiting for my response.//

//Everyone is looking at me, right?//

[[&quot;I am.&quot;|SecondDay RitualOfAvatars2]]</tw-passagedata><tw-passagedata pid="94" name="SecondDay RitualOfAvatars2" tags="" position="289,996" size="100,100">&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Very well. Undress.&quot;//&lt;/span&gt; The Priestess Regent orders. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Everyone.&quot;//&lt;/span&gt;

//What? Just like that?//

Nash seems to be as undecided as you. Maaterasu, however, obeys without thinking. Val obeys too, much happier.

//She&#39;s ogling everyone, right?//

Claw takes her clothes off in abrupt, decided movements, perhaps showing she has nothing to hide. Mir does it calmly, like it is the most natural thing in the world.

You and Nash exchange glances. She shrugs and begins undressing. You follow along. When you&#39;re finished, Val is looking at you. She winks. You send your eyes to the ground.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I will now channel the Goddess&#39; energy directly into each of you. Relax your muscles.&quot;//&lt;/span&gt;

The Priestess Regent waves her arms from the sides to her own head, then she puts her hands forward, and repeats the whole movement. Pink and golden mist starts to form around her.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Inhale air, and don&#39;t let it out...&quot;//&lt;/span&gt;

When she has enough mist, she starts directing it with her hands. By gently pushing the air, the mist follows whatever direction she wants to.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Exhale.&quot;//&lt;/span&gt;

Drishtya focuses in covering Maaterasu&#39;s nude body with the magic essence. You had avoided looking at anyone who had already undressed, but your curiosity beats your shame and you take a peek. A very long one.

//She is still calm, even in this situation. Does she even have emotions?//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Inhale air again... Focus on your feet. Check if they&#39;re under tension, and release it.&quot;//&lt;/span&gt;

When only the Aiishen&#39;s face is uncovered, Drishtya moves on to Padmiri. The Leirien closes her eyes. You perceive a small twitch, but otherwise her only moves are those of her lungs.

The Priestess Regent continues asking you to perform different relaxation exercises. Nash&#39;s turn comes next. You notice how she starts breathing harder and faster when the mist first touches her, but after some seconds she tames the pace and goes back to normal.

Val&#39;s reaction, however, is a parade of emotions. A huge grin invades her, which gives place to a sign of pain, and after a breath, she gradually recovers her smile - and a naughty one at that.

Drishtya looks at Claw and you before continuing, and she decides to proceed with the tiger.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hissssss!&quot;//&lt;/span&gt;

It&#39;s an uncontrolled reaction. Claw steps back, but then forces herself to stay in place. The Priestess Regent stops for a moment, only continuing when Claw is clearly quiet. She ends covered by the mist as well.

//It&#39;s my turn.//

The Priestess&#39; eyes are locked on you. You look back at her, but you decide to close them when the mist is about to reach you.

//Ah!//

Cold. It freezes your skin wherever it touches you, seeping into your very pores. And then it burns.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nngghh.&quot;//&lt;/span&gt;

But the heat inside and the cold outside decay slowly, up until both temperatures become one and the same. And you become one with the stillness. You can clearly feel your heart&#39;s throbing, your breath&#39;s movements, and your skin&#39;s quiet tingling. It all turns into pleasure - the sky itself is stroking your whole body at the same time.

//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;50 lust.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.lust.current -= 50;&lt;&lt;/script&gt;&gt;
&lt;&lt;if $settings.futa == &quot;enableAll&quot;&gt;&gt; \
[[Continue|SecondDay RitualOfAvatars3]]
&lt;&lt;elseif $settings.futa == &quot;playerFuta&quot;&gt;&gt; \
[[Continue|SecondDay RitualOfAvatars3c]]
&lt;&lt;elseif $settings.futa == &quot;futaPartners&quot;&gt;&gt; \
[[Continue|SecondDay RitualOfAvatars3d]]
&lt;&lt;else&gt;&gt; \
[[Continue|SecondDay RitualOfAvatars3b]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="95" name="SecondDay RitualOfAvatars3" tags="" position="396,996" size="100,100">Drishtya steps back, and takes a long look at everyone. She opens her arms, hands and palms long and wide, and pulls them, like a puppeteer controlling the very forces of nature.

The mist massages your skin, and your body vibrates. You feel waves running through your body, from your shoulders to your hands, from your waist to your neck, and from your neck to your groin. And it pulsates.

You feel a force right above your clitoris, pushing inside and out of your body. Your abdomen is weak, your legs tremble. Heat consumes you, and pleasure engulfs you.

//Nnn... Gghh... Aaaaa//aaa//aaahh....//

//&lt;span style=&quot;color:red&quot;&gt;You have reached orgasm!&lt;/span&gt;//
&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.lust.current = 100;&lt;&lt;/script&gt;&gt; \

Your breathing had accelerated, but after reaching orgasm, it slowly goes back to normal. You feel disoriented, and you lose half a minute to your dizziness. When you&#39;re fully back to normal, the mist is dissipating.

[[Continue|SecondDay RitualOfAvatars4]]</tw-passagedata><tw-passagedata pid="96" name="SecondDay RitualOfAvatars4" tags="" position="506,997" size="100,100">You&#39;re looking down.

//That... Is mine?//

Yes.

//What is it?//

A penis, obviously.

//But I don&#39;t have a penis.//

You do, now.

//Wait, what?//

You send a hand to your groin. Your pussy is still there, as is your clitoris, just below your new tool. You palpate the rest of your body, and it doesn&#39;t look like anything else has changed.

You look around. Padmiri is astounded, Claw frowns. Nash is stretching her legs in different directions as she looks down. Valtan looks amused. Maaterasu is...

//Showing interest.//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Congratulations, my dear ones. You&#39;ve taken the first step into becoming Avatars of the Goddess.

I trust no one has doubts about what&#39;s happened?&quot;//&lt;/span&gt;

The silence is an eloquent response.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Excellent. You will soon have to begin your training, but I must introduce you to the rest of the Temple&#39;s inhabitants first.&quot;//&lt;/span&gt;

&lt;&lt;script&gt;&gt;
	for ( var charKey of [&quot;chPlayerCharacter&quot;,&quot;chNash&quot;,&quot;chMir&quot;,&quot;chClaw&quot;,&quot;chVal&quot;,&quot;chAte&quot;] ) {
		State.variables[charKey].addBodypart(&quot;dick&quot;,&quot;dick&quot;);
	}	
&lt;&lt;/script&gt;&gt; \
[[Continue|SecondDay MeetTempleStaff]]</tw-passagedata><tw-passagedata pid="97" name="Credits" tags="" position="2116,17" size="100,100">[[Go back|Disclaimer]]

&#39;&#39;Unholy Arts&#39;&#39; is currently being developed by &#39;&#39;Deep Interactivity&#39;&#39;.
[[Support the game on Patreon and get access to the latest releases|https://patreon.com/deepinteractivity]]
[[Follow the game on Itch.io: get access to all new public releases and stay updated about the game&#39;s development|https://deepinteractivity.itch.io/unholy-arts]]


__Collaborations__:

&#39;&#39;Shirarin&#39;&#39; - Character portraits and new logo illustration

&#39;&#39;Florian &quot;Verdilak&quot; Gelbmann&#39;&#39; - Logo&#39;s background, title and old illustration
[[Verdilak&#39;s webpage|https://verdilaksbreeding.com/]]

&#39;&#39;2D!PIXX&#39;&#39; - Map Icons
[[2D!PIXX&#39;s webpage|https://www.2dpixx.de/]]

&#39;&#39;Ikumireii&#39;&#39; - Character portraits
[[Ikumireii&#39;s art gallery on Deviant Art|https://www.deviantart.com/ikumireii]]

&#39;&#39;Reneg30&#39;&#39; - Character portraits
[[Reneg30&#39;s art gallery on Deviant Art|https://www.deviantart.com/reneg30]]


__Supporters__:

__Passion Temple Clergy__
&lt;&lt;set _creditsTier3 to setup.creditsTier3&gt;&gt; \
_creditsTier3
__Passion Temple Preachers__
&lt;&lt;set _creditsTier2 to setup.creditsTier2&gt;&gt; \
_creditsTier2
__Goddess Enthusiasts__
&lt;&lt;set _creditsTier1 to setup.creditsTier1&gt;&gt; \
_creditsTier1

&gt; Missing yourself on this list?
Due to data privacy concerns, patrons who first supported the game before the release of version 0.2 must send Deep Interactivity a notification communicating their consent to being added to this list.
&gt; What if I don&#39;t want to appear here?
If you no longer wish your nickname to appear on the credits or you want to support the game without appearing here, make sure you notify Deep Interactivity via Patreon.


[[Go back|Disclaimer]]</tw-passagedata><tw-passagedata pid="98" name="Disclaimer" tags="" position="23,21" size="100,100">&lt;div align=&#39;center&#39;&gt;\
[img[img/logo.png]]
 
__Disclaimer__:
&lt;/div&gt; \

Unholy Arts is an erotic fiction game. If you do not have the required legal age in your country to consume this content, or have trouble to distinguish fiction from reality, please close this window.

The game may depict behaviors that aren&#39;t acceptable outside of fiction. Remember that all sexual activities in real life require explicit consent from every person involved.

Configure your settings before starting the game: &lt;&lt;link [[Settings|Settings]]&gt;&gt;&lt;&lt;script&gt;&gt;State.variables.settings.setExitPassage(&quot;Disclaimer&quot;);
State.variables.settings.formatAllChoices();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;center&gt;&lt;&lt;link [[Everything is in order, let&#39;s start the game|GoddessHerald 1]]&gt;&gt;
&lt;&lt;script&gt;&gt;applyDifficultyChanges();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;set _quickstartLinkText to setup.quickstartLinkText&gt;&gt; \
_quickstartLinkText
[[Take me to the credits|Credits]]&lt;/center&gt;

&lt;p style=&quot;text-align:left;&quot;&gt;[img[img/PatreonButton.png][&quot;https://www.patreon.com/bePatron?u=31941037&quot;]]
- Support the game
- Get the latest updates
- Access the Quickstart and Cheat Menus&lt;/p&gt;

&lt;p style=&quot;text-align:left;&quot;&gt;[img[img/DiscordButton.png][&quot;https://discord.gg/5qFUw9k&quot;]]
- Discuss the game
- Send suggestions
- Report bugs&lt;/p&gt;

&lt;&lt;set _versionName to setup.versionName&gt;&gt; \
Current version: _versionName</tw-passagedata><tw-passagedata pid="99" name="Map" tags="map" position="1610,20" size="100,100">&lt;&lt;script&gt;&gt;
State.variables.compass.refreshRoomPassage();
&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;
State.variables.compass.refreshRightUImap();
&lt;&lt;/script&gt;&gt; \
$compass.roomPassage
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \
&lt;&lt;script&gt;&gt;/*
//$(&quot;body #passages&quot;).removeEventListener(&quot;click&quot;, &quot;area[room-key]&quot;, clickRoomIconEvent);
var areas = $(&quot;body #passages&quot;).getElementsByClassName(&quot;roomAreaButton&quot;);
document.removeEventListener(&quot;click&quot;,clickRoomIconEvent);

for ( var area of areas ) {
area.removeEventListener(&quot;click&quot;,clickRoomIconEvent);
area.addEventListener(&quot;click&quot;,clickRoomIconEvent);
var old_element = area;
var new_element = old_element.cloneNode(true);
area.parentNode.replaceChild(new_element, old_element);


area.addEventListener(&quot;click&quot;, clickRoomIconEvent,true);
}

State.variables.logL1.push($(&quot;body #passages&quot;));
*/&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;
//$(&quot;body #passages&quot;).one(&quot;click&quot;, &quot;area[room-key]&quot;, clickRoomIconEvent);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="100" name="Interlude" tags="" position="1718,19" size="100,100">$compass.interludePassage</tw-passagedata><tw-passagedata pid="101" name="Pathfinder Tests" tags="" position="1476,19" size="100,100">&lt;&lt;script&gt;&gt;
State.variables.tPathfinder = new Pathfinder(&quot;mapTrainingGrounds&quot;,[&quot;chPlayerCharacter&quot;],&quot;westLibrary&quot;,function(nodeKey) {
if ( nodeKey.length &gt; 11 ) { return true; }
else { return false; }
});
State.variables.pfTest = State.variables.tPathfinder.getAllValidRoutes();
State.variables.chPlayerCharacter.currentRoom = &quot;westLibrary&quot;;
State.variables.log = getRouteToClosestAltTaggedActivity(&quot;mapTrainingGrounds&quot;,[&quot;chPlayerCharacter&quot;],[&quot;physique&quot;,&quot;will&quot;]);
cMissionRandomMovement(&quot;mapTrainingGrounds&quot;,[&quot;chPlayerCharacter&quot;]);
cMissionRandomMovement(&quot;mapTrainingGrounds&quot;,[&quot;chPlayerCharacter&quot;]);
cMissionRandomMovement(&quot;mapTrainingGrounds&quot;,[&quot;chPlayerCharacter&quot;]);
&lt;&lt;/script&gt;&gt; \
\
$tPathfinder.debugInfo</tw-passagedata><tw-passagedata pid="102" name="Jobs Screen" tags="jobsScreen" position="1596,135" size="100,100">$jobsAssigner.passageText</tw-passagedata><tw-passagedata pid="103" name="Social Interactions" tags="SIS" position="1841,18" size="100,100">&lt;&lt;script&gt;&gt;
if ( State.variables.compass.pcSis != -1 ) {
	State.variables.compass.sisList[State.variables.compass.pcSis].feedCharInteractionsOptionsList();
	State.variables.compass.sisList[State.variables.compass.pcSis].formatPassageText();
	State.variables.compass.sisPassage = 	State.variables.compass.sisList[State.variables.compass.pcSis].passageText;
}
if ( State.variables.compass.pcSis != -1 ) {
if ( State.variables.compass.sisList[State.variables.compass.pcSis].roundsCount == 0 ) { State.variables.compass.sisList[State.variables.compass.pcSis].roundsCount++; }
}
&lt;&lt;/script&gt;&gt; \ 
$compass.sisPassage</tw-passagedata><tw-passagedata pid="104" name="Personal Room" tags="saveAllowed" position="1960,17" size="100,100">&lt;&lt;script&gt;&gt;
State.variables.personalRoom.formatRoomText();
attemptAutosave();
&lt;&lt;/script&gt;&gt; \
&lt;&lt;addclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \
/* &lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \ */ \
$personalRoom.roomText
&lt;&lt;script&gt;&gt;
fixOwnedEquipmentLists();
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="105" name="Supporter Quickstart Room" tags="" position="2255,17" size="100,100">&lt;&lt;script&gt;&gt;
State.variables.supToolsData.formatQuickstartRoom();
&lt;&lt;/script&gt;&gt; \
$supToolsData.quickstartRoomPassage</tw-passagedata><tw-passagedata pid="106" name="Cheat Menu Supporter Room" tags="" position="2381,17" size="100,100">&lt;&lt;script&gt;&gt;
State.variables.supToolsData.formatCheatMenuRoom();
&lt;&lt;/script&gt;&gt; \
$supToolsData.cheatMenuRoomPassage</tw-passagedata><tw-passagedata pid="107" name="SE Stretching Help Start" tags="" position="2525,227" size="100,100">$customRoomIntro
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \
After waking up early, you decide to take a stroll before the training period. It&#39;s a relatively warm morning, given how early it is.

You realize Nashillbyir isn&#39;t too far away, doing stretches.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hello, $chPlayerCharacter.name! You&#39;re up early today.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hello, Nash. Do you always get up this early?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I do most of the time, yes. Now that you&#39;re here, would you mind lending me a hand in my exercises?&quot;//&lt;/span&gt;

[[Accept|SE Stretching Help Accept]]
[[Decline|SE Stretching Help EndDecline]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \
&lt;&lt;script&gt;&gt;State.variables.StVars.StretchingHelpResult = &quot;unfinished&quot;; 

State.variables.StVars.StretchingHelpGroped = &quot;false&quot;;&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="108" name="SE Stretching Help EndDecline" tags="" position="2881,222" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m sorry, but I&#39;m still sleepy. I just wanted the air to hit my face.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh, well, that&#39;s fine. Take care!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Likewise.&quot;//&lt;/span&gt;

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;State.variables.StVars.StretchingHelpResult = &quot;declined&quot;;&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="109" name="SE Stretching Help Accept" tags="" position="2645,225" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;All right, what do you need me to do?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Move next to my side, for starters. Ah, it&#39;s been so many days since I had someone to help me with this!&quot;//&lt;/span&gt;

The Ashwalker lies on her back, and you kneel next to her after she asks you to do so.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I want to stretch my legs&#39; muscles - you just have to keep hold of my knees at certain positions.&quot;//&lt;/span&gt;

[[Do as told|SE Stretching Help Phase 1]]</tw-passagedata><tw-passagedata pid="110" name="SE Stretching Help Phase 1" tags="" position="2753,225" size="100,100">$customRoomIntro
Following Nash&#39;s directions, you pull and keep your grip on her knees at different points. You&#39;re certain that it would hurt you if you were in her position, but she doesn&#39;t lose her cool.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Well done, let&#39;s move on.&quot;//&lt;/span&gt;

Without moving her back from the ground, she moves her right leg to the left, describing a right angle with her spine.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;As you can see, my leg isn&#39;t straight. Hold me so that it gets as close as possible.&quot;//&lt;/span&gt;

[[Hold her outer thigh|SE Stretching Help Hold Thigh]]
[[Hold her knee and gluteus|SE Stretching Help Hold Gluteus]]
[[Ask her how to do it|SE Stretching Help Ask How to Hold]]</tw-passagedata><tw-passagedata pid="111" name="SE Stretching Help Hold Thigh" tags="" position="2521,340" size="100,100">$customRoomIntro
Moving carefully, you place your hands along her thigh. You can feel the tendons in tension, ocasionally shaking.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You&#39;re doing great, hold for a little longer.&quot;//&lt;/span&gt;

After some seconds, she exhales and points you to stop. It&#39;s the other leg&#39;s turn next.

[[Continue|SE Stretching Help Phase 2]]</tw-passagedata><tw-passagedata pid="112" name="SE Stretching Help Hold Gluteus" tags="" position="2630,340" size="100,100">$customRoomIntro
Relatively uncertain about how to proceed, you end up putting your hands right below her knee and her butt.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hmpf.&quot;//&lt;/span&gt;

You steal a look at her. She&#39;s looking at you, smirking.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s fine if you want to grab me there, but don&#39;t forget to push my leg down.&quot;//&lt;/span&gt;

//Oops.//

You correct the strength you&#39;re exerting.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That&#39;s better.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has grown a bit.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 100;
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Stretching Help Phase 2]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.StretchingHelpGroped = &quot;true&quot;;&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="113" name="SE Stretching Help Ask How to Hold" tags="" position="2744,338" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, uhm...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What is it?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Where am I supposed to grab you?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;At the extremes of the thigh will be fine.&quot;//&lt;/span&gt;

She points at the specific places with her index fingers, and your hands follow.

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Nashillbyir has grown a a bit.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.submission.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.domination.stv += 100;
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Stretching Help Phase 2]]</tw-passagedata><tw-passagedata pid="114" name="SE Stretching Help Phase 2" tags="" position="2865,332" size="100,100">$customRoomIntro
Once she&#39;s done, you pull back.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;This will be our last exercise. My knees have to get as close to my shoulders as possible, just make sure they remain there.&quot;//&lt;/span&gt;

The young Ashwalker, her back still on the ground, plants her feet on the grass, only to abruptly pull them along with her legs to her own chest. She awaits you.

//How should I do it, though?//

[[Stand up next to her|SE Stretching Help Standing]]
&lt;&lt;if $chPlayerCharacter.resilience.value &gt;= 11&gt;&gt;[[Kneel in front of her|SE Stretching Help Kneeling Passed Check]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $chPlayerCharacter.resilience.value &lt; 11&gt;&gt;[[Kneel in front of her|SE Stretching Help Kneeling Failed Check]]
&lt;&lt;/if&gt;&gt; \
[[Mount her|SE Stretching Help Mount]]</tw-passagedata><tw-passagedata pid="115" name="SE Stretching Help Standing" tags="" position="2523,450" size="100,100">$customRoomIntro
You get up and move next to her side, and bend your back in order to reach her knees with your hands. It doesn&#39;t take long for this position to hurt you.

//...This probably wasn&#39;t the best choice.//

Nash gives a hint to be in tension this time, but it isn&#39;t too noticeable. She&#39;s keeping tight control of her breath, slow as a feather&#39;s fall.

At some point, she looks at you. You immediately turn your gaze away, but force yourself to look back.

She&#39;s smiling calmly.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That will be all.&quot;//&lt;/span&gt;

You let her knees go and take a much more natural posture. Your back still aching, now it&#39;s you who needs to stretch.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Your help was great, thanks a lot.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m glad I could help!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s about time we reunite with the others, but one of these days it&#39;ll be my turn to help you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nice, I&#39;ll look forward to it.&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;20 energy.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Nashillbyir has grown a bit.&lt;/span&gt;
You gained 100 resilience experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 20;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 100;
State.variables.chPlayerCharacter.relations.chNash.romance.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.romance.stv += 100;
State.variables.chPlayerCharacter.resilience.experience += 100;
State.variables.chNash.agility.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="116" name="SE Stretching Help Mount" tags="" position="2633,450" size="100,100">$customRoomIntro
You put place yourself in front of her rear, and lower yourself down. You are less and less sure about this as you move forwards, but you get in top of her nonetheless, safely locking her knees.

Nash&#39;s expression doesn&#39;t change much, but...

//Her pupils are... so big.//

You salivate.

[[Keep still|SE Stretching Help Mount Nothing]]
[[Lean in for a kiss|SE Stretching Help Mount Kiss]]
&lt;&lt;if $StVars.futaNash == true&gt;&gt;[[Lower your groin|SE Stretching Help Mount Rub Dick]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.futaNash == false&gt;&gt;[[Lower your groin|SE Stretching Help Mount Rub Pussy]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="117" name="SE Stretching Help Mount Nothing" tags="" position="2516,569" size="100,100">$customRoomIntro
Despite everything, you choose not to take advantage of the situation. And yet the both of you share a smile.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That will be all.&quot;//&lt;/span&gt;

You move back and stand up, and she follows.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Your help was great, thanks a lot.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m glad I could help!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s about time we reunite with the others, but one of these days it&#39;ll be my turn to help you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nice, I&#39;ll look forward to it.&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;10 energy.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown a bit.&lt;/span&gt;
You gained 100 resilience experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 10;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 100;
State.variables.chPlayerCharacter.resilience.experience += 100;
State.variables.chNash.agility.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;State.variables.StVars.StretchingHelpResult = &quot;friendly&quot;;&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="118" name="SE Stretching Help Mount Kiss" tags="" position="2630,567" size="100,100">$customRoomIntro
Her lips, open and humid, have the perfect appeareance for a morning delicacy. You feel her breath in your face, closer, and closer...

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Mmm...&quot;//&lt;/span&gt;

And your mouths meet. It&#39;s a gentle union, the lips rubbing slowly up and down. Your eyes open and find hers, warm, intimate. It takes you a few more seconds to notice your arms are giving up.

You suddenly remember what you were doing and pull back.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Lips stretches weren&#39;t on the routine, but they may be next time.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;If you want to keep yourself flexible, your routine should be as well.&quot;//&lt;/span&gt;

Nash rolls her eyes.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Your help was great, thanks a lot.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m glad I could help!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s about time we reunite with the others, but one of these days it&#39;ll be my turn to help you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nice, I&#39;ll look forward to it.&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;10 lust.&lt;/span&gt;
You lost &lt;span style=&quot;color:limegreen&quot;&gt;10 energy.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Nashillbyir has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your dominance towards Nashillbyir has grown a bit.&lt;/span&gt;
You gained 100 resilience experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.lust.current -= 10;
State.variables.chPlayerCharacter.energy.current -= 10;
State.variables.chNash.lust.current -= 10;
State.variables.chPlayerCharacter.relations.chNash.romance.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.romance.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 100;
State.variables.chPlayerCharacter.relations.chNash.domination.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.submission.stv += 100;
State.variables.chPlayerCharacter.resilience.experience += 100;
State.variables.chNash.agility.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;State.variables.StVars.StretchingHelpResult = &quot;sexual&quot;;
State.variables.StVars.StretchingHelpGroped = &quot;true&quot;;&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="119" name="SE Stretching Help Mount Rub Dick" tags="" position="2745,569" size="100,100">$customRoomIntro
While both of your are pacing your respiration, you do it for different reasons. Desire finally gets the best of you, and you decide you want to feel her, now. Your arms stick to her legs, your own legs wrap around her. Your waist falls slowly, and you feel hers. Your dick touches the lower part of her pussy, through the clothes.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Ah.&quot;//&lt;/span&gt;

Her breath gets faster and her pupils expand. Your arms are still holding her down, but she now faces the extra challenge of containing the heat rising through her body. You don&#39;t stop frotting her, and neither does she.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s... getting late. The others will find us.&quot;//&lt;/span&gt;

//She&#39;s right.//

You pull back and stand up. As the realization of what you&#39;ve done hits you, you become a tomato-colored human.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Your... Your help was great, thanks a lot.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m glad I could help.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s about time we reunite with the others, but one of these days it&#39;ll be my turn to... Help you.&quot;//&lt;/span&gt;

//Ha... Haha...//

//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;20 lust.&lt;/span&gt;
You lost &lt;span style=&quot;color:limegreen&quot;&gt;20 energy.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your dominance towards Nashillbyir has grown.&lt;/span&gt;
You gained 100 resilience experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.lust.current -= 20;
State.variables.chPlayerCharacter.energy.current -= 20;
State.variables.chNash.lust.current -= 20;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.domination.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.submission.stv += 250;
State.variables.chPlayerCharacter.resilience.experience += 100;
State.variables.chNash.agility.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;State.variables.StVars.StretchingHelpResult = &quot;sexual&quot;;
State.variables.StVars.StretchingHelpGroped = &quot;true&quot;;&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="120" name="SE Stretching Help Mount Rub Pussy" tags="" position="2855,569" size="100,100">$customRoomIntro
While both of your are pacing your respiration, you do it for different reasons. Desire finally gets the best of you, and you decide you want to feel her, now. Your arms stick to her legs, your own legs wrap around her. Your waist falls slowly, and you feel hers. Your groins touch each other, through your clothes.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Ah.&quot;//&lt;/span&gt;

Her breath gets faster and her pupils expand. Your arms are still holding her down, but she now faces the extra challenge of containing the heat rising through her body. You don&#39;t stop frotting her, and neither does she.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s... getting late. The others will find us.&quot;//&lt;/span&gt;

//She&#39;s right.//

You pull back and stand up. As the realization of what you&#39;ve done hits you, you become a tomato-colored human.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Your... Your help was great, thanks a lot.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m glad I could help.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s about time we reunite with the others, but one of these days it&#39;ll be my turn to... Help you.&quot;//&lt;/span&gt;

//Ha... Haha...//

//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;20 lust.&lt;/span&gt;
You lost &lt;span style=&quot;color:limegreen&quot;&gt;20 energy.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your dominance towards Nashillbyir has grown.&lt;/span&gt;
You gained 100 resilience experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.lust.current -= 20;
State.variables.chPlayerCharacter.energy.current -= 20;
State.variables.chNash.lust.current -= 20;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.domination.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.submission.stv += 250;
State.variables.chPlayerCharacter.resilience.experience += 100;
State.variables.chNash.agility.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;State.variables.StVars.StretchingHelpResult = &quot;sexual&quot;;
State.variables.StVars.StretchingHelpGroped = &quot;true&quot;;&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="121" name="SE Stretching Help Kneeling Failed Check" tags="" position="2515,685" size="100,100">$customRoomIntro
You decide that kneeling before her is a good compromise between being close enough to the job and not being too pushy. You put yourself in front of her waist, push yourself forward to reach her knees, and...

&lt;span style=&quot;color:red&quot;&gt;Resilience check: failed.&lt;/span&gt;

You soon realize this was a mistake. You&#39;ve reached her legs and you&#39;re holding them down, but your back&#39;s positioning is terrible and you won&#39;t be able to maintain it for long. Without barely any time to reflect on your mistakes...

&lt;&lt;if $StVars.futaNash == true&gt;&gt;[[You fall down|SE Stretching Help Failed Check Dick]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.futaNash == false&gt;&gt;[[You fall down|SE Stretching Help Failed Check Pussy]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="122" name="SE Stretching Help Kneeling Passed Check" tags="" position="2851,684" size="100,100">$customRoomIntro
You decide that kneeling before her is a good compromise between being close enough to the job and not being too pushy. You put yourself in front of her waist, push yourself forward to reach her knees, and...

&lt;span style=&quot;color:green&quot;&gt;Resilience check: passed.&lt;/span&gt;

You soon realize this posture was a mistake. Your back&#39;s position is fairly taxing, but nonetheless you manage to hold on.

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;15 energy.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 15;
&lt;&lt;/script&gt;&gt; \

You keep holding her knees down, and you feel small shakes in her legs, proof that her tendons are working. She remains calm, her eyes closed, her breathing controlling her thoughts and emotions. From your position, you can see her entirely. Her face, her chest, her legs, her... groin.

//Keep it cool.//

And your eyes turn back to her face. She opens hers, and smiles.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;This should be enough.&quot;//&lt;/span&gt;

Half a minute later, both of you are standing up.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Your help was great, thanks a lot.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m glad I could help!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s about time we reunite with the others, but one of these days it&#39;ll be my turn to help you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nice, I&#39;ll look forward to it.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown a a bit.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has grown a bit.&lt;/span&gt;
You gained 100 resilience experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 100;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 100;
State.variables.chPlayerCharacter.resilience.experience += 100;
State.variables.chNash.agility.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;State.variables.StVars.StretchingHelpResult = &quot;sexual&quot;;
State.variables.StVars.StretchingHelpGroped = &quot;false&quot;;&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="123" name="SE Stretching Help Failed Check Pussy" tags="" position="2625,687" size="100,100">$customRoomIntro
Once your back and your arms give up, your head falls like a dead weight - right into Nashillbyir&#39;s groin.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Eek!&quot;//&lt;/span&gt;

Despite the sudden scream, the Askwalker&#39;s body doesn&#39;t move much.

//This can&#39;t be happening.//

Your panicking hands, in the meantime, look desperately for a surface on which to push you back, but it isn&#39;t exactly easy since your can&#39;t take your mind out of the fact that your nose&#39;s tip is entering a fold in her pants. A couple of seconds later, you feel Nash&#39;s feet on your shoulders, pushing you, until your head is about to fall again, but to the ground.

Half a minute later, both of you are standing up. You&#39;re no longer anxious, but shame is eating you whole.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;J-Just so you know, I&#39;m not completely against happy endings, but I prefer to finish the exercise first.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m so sorry! I didn&#39;t mean to!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s fine! It&#39;s fine! It could have happened to anyone.&quot;//&lt;/span&gt;

She taps you on the back.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Come on, the rest will be up and ready in any moment. We should go back.&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;20 lust.&lt;/span&gt;
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;20 willpower.&lt;/span&gt;
You lost &lt;span style=&quot;color:limegreen&quot;&gt;20 energy.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your sexual tension with Nashillbyir has grown.&lt;/span&gt;
You gained 100 resilience experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.lust.current -= 20;
State.variables.chPlayerCharacter.willpower.current -= 20;
State.variables.chPlayerCharacter.energy.current -= 20;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.resilience.experience += 100;
State.variables.chNash.agility.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;State.variables.StVars.StretchingHelpResult = &quot;sexual&quot;;
State.variables.StVars.StretchingHelpGroped = &quot;true&quot;;&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="124" name="SE Stretching Help Failed Check Dick" tags="" position="2735,690" size="100,100">$customRoomIntro
Once your back and your arms give up, your head falls like a dead weight - right into Nashillbyir&#39;s groin.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Eek!&quot;//&lt;/span&gt;

Despite the sudden scream, the Askwalker&#39;s body doesn&#39;t move much.

//This can&#39;t be happening.//

Your panicking hands, in the meantime, look desperately for a surface on which to push you back, but it isn&#39;t exactly easy since your can&#39;t take your mind out of the fact that your mouth fell open and it&#39;s now unintentionally kissing something in her pants. A couple of seconds later, you feel Nash&#39;s feet on your shoulders, pushing you, until your head is about to fall again, but to the ground.

Half a minute later, both of you are standing up. You&#39;re no longer anxious, but shame is eating you whole.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;J-Just so you know, I&#39;m not completely against happy endings, but I prefer to finish the exercise first.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m so sorry! I didn&#39;t mean to!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s fine! It&#39;s fine! It could have happened to anyone.&quot;//&lt;/span&gt;

She taps you on the back.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Come on, the rest will be up and ready in any moment. We should go back.&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;20 lust.&lt;/span&gt;
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;20 willpower.&lt;/span&gt;
You lost &lt;span style=&quot;color:limegreen&quot;&gt;20 energy.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has grown.&lt;/span&gt;
You gained 100 resilience experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.lust.current -= 20;
State.variables.chPlayerCharacter.willpower.current -= 20;
State.variables.chPlayerCharacter.energy.current -= 20;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.resilience.experience += 100;
State.variables.chNash.agility.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;State.variables.StVars.StretchingHelpResult = &quot;sexual&quot;;
State.variables.StVars.StretchingHelpGroped = &quot;true&quot;;&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="125" name="SE Humming Start" tags="" position="3025,222" size="100,100">$customRoomIntro
While getting closer to the amphitheater, you notice a shape in the distance that you identify as Maaterasu. You&#39;re surprised when you notice that the ever quiet and polite girl is actually humming a tune.

It isn&#39;t overly complicated: it mainly consists on two main phrases that are repeated over and over, adding minor variations at the end. The main phrases themselves are profoundly melancholic, while the variations add different emotions, from sadness to acceptance, to joy. The contrast is beautiful to your ears.

Suddenly, the Aiishen stops. She has noticed you.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;What do you think?&quot;//&lt;/span&gt;

//She must be asking about the tune, or her interpretation.//

[[Compliment|SE Humming Compliment]]
[[Criticize|SE Humming Criticize]]
[[Ask about the tune&#39;s origin|SE Humming Ask About Song]]
[[I want to keep listening to it|SE Humming Listen in silence]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="126" name="SE Humming Compliment" tags="" position="3025,339" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It&#39;s beautiful. I loved hearing your music.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;That makes me glad.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown a bit.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 100;
&lt;&lt;/script&gt;&gt; \
A small silence follows. Looks like she isn&#39;t going to lead the conversation.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We don&#39;t play a lot of music in the Gaanidan Tribe, and when we do, it&#39;s mainly to accompany the storytellers.&quot;//&lt;/span&gt;

Maaterasu thinks for a moment, then asks you:

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Would you like to hum with me?&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.seHummingCopyCheck == true&gt;&gt;[[Yes, copy the melody|SE Humming Copy Melody Pass]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingCopyCheck == false&gt;&gt;[[Yes, copy the melody|SE Humming Copy Melody Fail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingHarmonyCheck == true&gt;&gt;[[Yes, add some harmony|SE Humming Harmonic Accompaniment Pass]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingHarmonyCheck == false&gt;&gt;[[Yes, add some harmony|SE Humming Harmonic Accompaniment Fail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingImproviseCheck == true&gt;&gt;[[Yes, improvise variations|SE Humming Improvise Pass]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingImproviseCheck == false&gt;&gt;[[Yes, improvise variations|SE Humming Improvise Fail]]
&lt;&lt;/if&gt;&gt; \
[[Yes, but hum something completely different|SE Humming Different Humming]]
[[No, you prefer to listen|SE Humming Prefer To Listen]]</tw-passagedata><tw-passagedata pid="127" name="SE Humming Criticize" tags="" position="3025,455" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It wasn&#39;t the greatest melody. It&#39;s... very repetitive.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Yes, this song is repetitive.&quot;//&lt;/span&gt;

A small silence follows. Whether the comment actually annoyed her or not, it doesn&#39;t look like she&#39;s going to lead the conversation. Or do anything else, in general.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You don&#39;t mind me criticizing your song?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Songs are how they are, if you don&#39;t like one I can&#39;t do anything about it.&quot;//&lt;/span&gt;

Another tense silence. Her indifference may actually start to annoy you.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Would you like to hum with me?&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.seHummingCopyCheck == true&gt;&gt;[[Yes, copy the melody|SE Humming Copy Melody Pass]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingCopyCheck == false&gt;&gt;[[Yes, copy the melody|SE Humming Copy Melody Fail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingHarmonyCheck == true&gt;&gt;[[Yes, add some harmony|SE Humming Harmonic Accompaniment Pass]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingHarmonyCheck == false&gt;&gt;[[Yes, add some harmony|SE Humming Harmonic Accompaniment Fail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingImproviseCheck == true&gt;&gt;[[Yes, improvise variations|SE Humming Improvise Pass]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingImproviseCheck == false&gt;&gt;[[Yes, improvise variations|SE Humming Improvise Fail]]
&lt;&lt;/if&gt;&gt; \
[[Yes, but hum something completely different|SE Humming Different Humming]]
[[No, you prefer to listen|SE Humming Prefer To Listen]]</tw-passagedata><tw-passagedata pid="128" name="SE Humming Ask About Song" tags="" position="3025,569" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It interests me. Where does it come from?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;It&#39;s a song from the Aiishen Tribe.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Does it have lyrics?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Yes.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...So... What are they? Can you sing them?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I can&#39;t. I forgot them.&quot;//&lt;/span&gt;

//That&#39;s dissapointing. And this isn&#39;t the easiest conversation either, it&#39;s like I&#39;m tearing answers out of a wall.//

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Would you like to hum with me?&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.seHummingCopyCheck == true&gt;&gt;[[Yes, copy the melody|SE Humming Copy Melody Pass]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingCopyCheck == false&gt;&gt;[[Yes, copy the melody|SE Humming Copy Melody Fail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingHarmonyCheck == true&gt;&gt;[[Yes, add some harmony|SE Humming Harmonic Accompaniment Pass]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingHarmonyCheck == false&gt;&gt;[[Yes, add some harmony|SE Humming Harmonic Accompaniment Fail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingImproviseCheck == true&gt;&gt;[[Yes, improvise variations|SE Humming Improvise Pass]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingImproviseCheck == false&gt;&gt;[[Yes, improvise variations|SE Humming Improvise Fail]]
&lt;&lt;/if&gt;&gt; \
[[Yes, but hum something completely different|SE Humming Different Humming]]
[[No, you prefer to listen|SE Humming Prefer To Listen]]</tw-passagedata><tw-passagedata pid="129" name="SE Humming Listen in silence" tags="" position="3023,685" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I... Don&#39;t know. I&#39;d like to keep listening.&quot;//&lt;/span&gt;

Maaterasu nods, and the music comes back to her lips. It wasn&#39;t common for the Gaanidans to play music without accompanying a storyteller, but you soon reach the conclusion that it&#39;s quite the enjoyable experience.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Would you like to hum with me?&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.seHummingCopyCheck == true&gt;&gt;[[Yes, copy the melody|SE Humming Copy Melody Pass]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingCopyCheck == false&gt;&gt;[[Yes, copy the melody|SE Humming Copy Melody Fail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingHarmonyCheck == true&gt;&gt;[[Yes, add some harmony|SE Humming Harmonic Accompaniment Pass]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingHarmonyCheck == false&gt;&gt;[[Yes, add some harmony|SE Humming Harmonic Accompaniment Fail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingImproviseCheck == true&gt;&gt;[[Yes, improvise variations|SE Humming Improvise Pass]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seHummingImproviseCheck == false&gt;&gt;[[Yes, improvise variations|SE Humming Improvise Fail]]
&lt;&lt;/if&gt;&gt; \
[[Yes, but hum something completely different|SE Humming Different Humming]]
[[No, you prefer to listen|SE Humming Prefer To Listen]]</tw-passagedata><tw-passagedata pid="130" name="SE Humming Copy Melody Pass" tags="" position="3145,219" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, let me give it a try.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:green&quot;&gt;Percepcion OR empathy OR charisma OR luck check: passed.&lt;/span&gt;

She suddenly starts humming again, and you follow along. The repetitions of the main phrases make it easy to memorize it, and even if the variations sometimes get out of your grasp, you&#39;re fast to catch up. It turns out to be fun.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Was that it?&quot;//&lt;/span&gt;, you ask after she stops, about a minute later.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;That&#39;s the whole song, yes. Thank you for accompanying me.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;No need to thank me! I enjoyed it too. The training period will start soon, let&#39;s come back to the Temple.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown a a bit.&lt;/span&gt;
You gained 100 perception experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 100;
State.variables.chPlayerCharacter.perception.experience += 100;
State.variables.chAte.empathy.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="131" name="SE Humming Harmonic Accompaniment Pass" tags="" position="3141,337" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, let me give it a try.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:green&quot;&gt;Percepcion OR empathy OR charisma OR luck check: passed.&lt;/span&gt;

She suddenly starts humming again, and you follow along. Instead of merely repeating the melody, you keep humming the tone of each dominant beat. It&#39;s a simple technique, but it&#39;s effective enough in providing some sense of harmony.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I liked that. Thank you for accompanying me.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It was nothing, thank you for giving me the chance.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I may invite you again.&quot;//&lt;/span&gt;

//Even though her words express interest, her tone is as monotonous as ever. Except when she&#39;s singing.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;The training period will start soon. We should go back.&quot;//&lt;/span&gt;

She nods.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown a bit.&lt;/span&gt;
You gained 100 perception experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 120;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 120;
State.variables.chPlayerCharacter.perception.experience += 100;
State.variables.chAte.empathy.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="132" name="SE Humming Improvise Pass" tags="" position="3138,452" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, let me give it a try.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:green&quot;&gt;Percepcion OR intelligence OR charisma OR luck check: passed.&lt;/span&gt;

She suddenly starts humming again, and you follow along, but you sometimes get ahead of her and make small variations, such as adding very brief notes before the end of the beat. They work well overall and add some freshness to the music.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I... liked that. Thank you for accompanying me.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Thank you for giving me the chance! I liked it too.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I may invite you again.&quot;//&lt;/span&gt;

//Even though her words express interest, her tone is as monotonous as ever. Except when she&#39;s singing.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;The training period will start soon. We should go back.&quot;//&lt;/span&gt;

She nods.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Maaterasu has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Maaterasu has grown a bit.&lt;/span&gt;
You gained 100 perception experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 100;
State.variables.chPlayerCharacter.relations.chAte.sexualTension.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.sexualTension.stv += 100;
State.variables.chPlayerCharacter.relations.chAte.rivalry.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.rivalry.stv += 100;
State.variables.chPlayerCharacter.perception.experience += 100;
State.variables.chAte.empathy.experience += 100;
State.variables.chAte.charisma.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="133" name="SE Humming Different Humming" tags="" position="3138,565" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, let me give it a try.&quot;//&lt;/span&gt;

She suddenly starts humming again, and you follow along, but your melody and Maaterasu&#39;s are nothing alike. As it isn&#39;t the tempo, the tonality, the intention or the emotion. The overall result is a disaster.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I don&#39;t understand. I thought you wanted to join me in humming the same melody.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m not sure what I expected to happen. I&#39;m sorry.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

Her silent gaze penetrates you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We should go back to the Temple. The training period will begin briefly.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:red&quot;&gt;Your enmity with Maaterasu has grown a bit.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.enmity.stv += 150;
State.variables.chAte.relations.chPlayerCharacter.enmity.stv += 150;
State.variables.chAte.empathy.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="134" name="SE Humming Prefer To Listen" tags="" position="3133,680" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;No, no, I&#39;d just like to keep listening to you. If you don&#39;t mind.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I understand.&quot;//&lt;/span&gt;

And the music resumes once again. The Aiishen keeps her eyes closed while she hums, perhaps causing the rest of the world to disappear.

She finishes the whole melody after a while, and you reunite with the rest to begin the training period.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown a a bit.&lt;/span&gt;
You gained 100 perception experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 100;
State.variables.chPlayerCharacter.perception.experience += 100;
State.variables.chAte.empathy.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="135" name="SE Humming Copy Melody Fail" tags="" position="3256,219" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, let me give it a try.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:red&quot;&gt;Percepcion OR empathy OR charisma OR luck check: failed.&lt;/span&gt;

She suddenly starts humming again, and you follow along. The repetitions of the main phrases make it easy to memorize it, but your lack of musical practice screeches, and it doesn&#39;t sound good. While you know what you&#39;re supposed to sound like, you constantly miss the correct notes.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;That wasn&#39;t nice.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I know. I&#39;m new to this. I&#39;m sorry.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

You avoid her silent gaze.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We should go back to the Temple. The training period will begin briefly.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:red&quot;&gt;Your enmity with Maaterasu has grown a bit.&lt;/span&gt;
You gained 100 perception experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.enmity.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.enmity.stv += 100;
State.variables.chPlayerCharacter.perception.experience += 100;
State.variables.chAte.empathy.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="136" name="SE Humming Harmonic Accompaniment Fail" tags="" position="3255,339" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, let me give it a try.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:red&quot;&gt;Percepcion OR empathy OR charisma OR luck check: failed.&lt;/span&gt;

She suddenly starts humming again, and you follow along. Instead of merely repeating the melody, you keep humming the tone of each dominant beat... Or you attempt to do so, only to find that you&#39;re unable to maintain it. At some point, your sound always goes off, breaking the harmony and provoking an uncomfortable overlap with Maaterasu&#39;s melody.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;That wasn&#39;t nice.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I know. I expected it to turn out better. I&#39;m sorry.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

You avoid her silent gaze.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We should go back to the Temple. The training period will begin briefly.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:red&quot;&gt;Your enmity with Maaterasu has grown a bit.&lt;/span&gt;
You gained 100 perception experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.enmity.stv += 80;
State.variables.chAte.relations.chPlayerCharacter.enmity.stv += 80;
State.variables.chPlayerCharacter.perception.experience += 100;
State.variables.chAte.empathy.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="137" name="SE Humming Improvise Fail" tags="" position="3255,452" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, let me give it a try.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:red&quot;&gt;Percepcion OR intelligence OR charisma OR luck check: failed.&lt;/span&gt;

She suddenly starts humming again, and you follow along. You try making small variations at different points, like adding brief notes before a beat, but they mostly come out wrong and do little more than disrupt the result.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I don&#39;t understand why you did that.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I know. I expected it to turn out better. I&#39;m sorry.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

You avoid her silent gaze.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We should go back to the Temple. The training period will begin briefly.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:red&quot;&gt;Your enmity with Maaterasu has grown a bit.&lt;/span&gt;
You gained 100 perception experience.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.enmity.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.enmity.stv += 100;
State.variables.chPlayerCharacter.perception.experience += 100;
State.variables.chAte.empathy.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="138" name="SE EthicsOfPow Start" tags="" position="3515,224" size="100,100">$customRoomIntro
As you get closer to the Grand Hall, you hear some murmuring. At its very entrance, you manage to hear the conversation clearly, and identify the participants as Padmiri and Claw.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;But, why? Why do you have to be so hostile to us?&quot;//&lt;/span&gt; 

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Have I not made myself clear? We, or at least I, am here to become High Priestess, whatever the cost. That makes us rivals, not friends.&quot;//&lt;/span&gt;

The Leirien girl&#39;s face shows a strange blend of indignation and sadness.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That doesn&#39;t mean you have to treat us like a murder is about to take place.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Yes, it does. You may need the comfort of thinking that we will all get along, beyond the pain and frustration of the losers. But I&#39;m strong enough to do this on my own, and that means I won&#39;t need to think twice when I have to stomp you.&quot;//&lt;/span&gt;

[[Keep listening|SE EthicsOfPow ClawExplains]]
[[I don&#39;t want to see where this is going|SE EthicsOfPow Leave]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="139" name="SE EthicsOfPow Leave" tags="" position="3398,222" size="100,100">$customRoomIntro
There are many reasons to avoid this. Perhaps you think Claw is hopeless, that there&#39;s no point in discussing with her. Perhaps you think she&#39;s right, but in that case you should lay low. Perhaps you simply think you aren&#39;t capable of gaining anything out of this. Whatever your thoughts are, you stay away of the Grand Hall for a while.

&lt;&lt;script&gt;&gt;
State.variables.chMir.relations.chClaw.enmity.stv += 500;
State.variables.chClaw.relations.chMir.enmity.stv += 500;
State.variables.chMir.relations.chClaw.rivalry.stv += 500;
State.variables.chClaw.relations.chMir.rivalry.stv += 500;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="140" name="SE EthicsOfPow ClawExplains" tags="" position="3403,337" size="100,100">$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And what&#39;s the point of living such a life? You may become the strongest, you may stomp everyone in your way, and you may become High Priestess, but in the end, you will still be alone.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;The point,&quot;//&lt;/span&gt; the Tiger-girl replies, &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;is that power decides everything. If you think that playing nice and looking out for the others will determine whether you are alone or not, you are a naive fool.//&lt;/span&gt;

Claw&#39;s expression gets darker.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;But don&#39;t worry, life is ruthless and, sooner or later, it will teach you that lesson. The powerful are the ones who take the decisions in this world, they decide who deserves respect, who is ostracized, and even who is alone or not.&quot;//&lt;/span&gt;

[[Continue|SE EthicsOfPow MirExplains]]</tw-passagedata><tw-passagedata pid="141" name="SE EthicsOfPow MirExplains" tags="" position="3520,339" size="100,100">$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You call me a fool, despite thinking that way...?&quot;//&lt;/span&gt;

Mir frowns looking down for a few seconds. But just before Claw decides to leave, she starts arguing back.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;But don&#39;t you understand the limits of that kind of existence?&quot;//&lt;/span&gt; she begins, &lt;span @style=$chMir.colorStyleKey&gt;//&quot;You claim that the powerful decide who is alone, but power alone will never gain love. You may be strong enough to keep someone by your side, to tear someone away from others, but someone who would behave that way would never get to understand what&#39;s love, what is it to care for others, to have others to care for you. To have another person&#39;s warmth melt your worries away... That kind of person may be able to inflict pain on others, but they will never be able to have anything more than a pitiful, limited existence.&quot;//&lt;/span&gt;

Padmiri now holds her head high, looking at the Beastkin directly into her eyes.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;The powerful,&quot;//&lt;/span&gt; she continues, &lt;span @style=$chMir.colorStyleKey&gt;//&quot;should look over others, protect them and guide them. Instead of a tool to impose its own will on the world, power should be a lever that propels everyone into making the most out of their own freedom and choices. That&#39;s what would bring happiness.&quot;//&lt;/span&gt;

[[Continue|SE EthicsOfPow PlayerAsked]]</tw-passagedata><tw-passagedata pid="142" name="SE EthicsOfPow PlayerAsked" tags="" position="3640,335" size="100,100">$customRoomIntro
Claw and Padmiri look at each other in silence, the discussion having reached a stalemate.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Perhaps our friend here may want to help us reach a conclusion.&quot;//&lt;/span&gt;

And the two of them look at you.

//Oh, crap, they knew I was here!//

[[Side with Claw|SE EthicsOfPow SideWithClaw]]
[[Find a middle ground|SE EthicsOfPow MiddleGround]]
[[Side with Padmiri|SE EthicsOfPow SideWithMir]]
[[You&#39;re above taking a position|SE EthicsOfPow RefuseSides]]
[[You need to think it over|SE EthicsOfPow NeedsToThink]]
&lt;&lt;if $StVars.seEthicsOfPowMUcheck == true&gt;&gt;&lt;span style=&quot;color:green&quot;&gt;Intelligence AND empathy check: passed -&lt;/span&gt; [[Look for a mutual understanding|SE EthicsOfPow MutualUnderstanding]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seEthicsOfPowMUcheck == false&gt;&gt;&lt;span style=&quot;color:red&quot;&gt;Intelligence AND empathy check: failed&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="143" name="SE EthicsOfPow SideWithClaw" tags="" position="3406,449" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Padmiri, what you&#39;re saying sounds great, but... What would you do against someone stronger than you that wouldn&#39;t share your vision?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You understand that not everyone will be swayed by your words. And some of those people will be stronger than you, and their will may cause you pain. Wouldn&#39;t that prove Claw&#39;s point?&quot;//&lt;/span&gt;

Padmiri looks away, looking sad. After some seconds, she just leaves. Claw gives you a serious look - but not an angry one, and proceeds to the training grounds.

//&lt;span style=&quot;color:red&quot;&gt;Your enmity with Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Claw has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your enmity with Claw has decreased.&lt;/span&gt;
Padmiri&#39;s views have grown more favorable to self-improvement, domination, and ambition, and less favorable to cooperation.
Claw&#39;s views have grown more favorable to domination and ambition.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.enmity.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.enmity.stv += 250;
State.variables.chClaw.relations.chMir.enmity.stv += 250;
State.variables.chMir.relations.chClaw.enmity.stv += 250;
State.variables.chPlayerCharacter.relations.chClaw.friendship.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.friendship.stv += 250;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 100;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 100;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv -= 250;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv -= 250;
addPointsToDrive(gC(&quot;chMir&quot;).dImprovement,250);
addPointsToDrive(gC(&quot;chMir&quot;).dDomination,100);
addPointsToDrive(gC(&quot;chMir&quot;).dAmbition,250);
addPointsToDrive(gC(&quot;chMir&quot;).dCooperation,-100);
addPointsToDrive(gC(&quot;chClaw&quot;).dDomination,100);
addPointsToDrive(gC(&quot;chClaw&quot;).dAmbition,100);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="144" name="SE EthicsOfPow SideWithMir" tags="" position="3638,450" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Claw, how do you expect to find happiness that way?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You surely understand that keeping others by your side by force... Will only cause them pain. And that will not satisfy you. You-&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Shut up!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Excuse me?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You- You understand nothing! Just shut up and get out of my sight!&quot;//&lt;/span&gt;

She storms off. Once she&#39;s gone, Padmiri and you look at each other in silence, worry showing in your faces.

//&lt;span style=&quot;color:red&quot;&gt;Your enmity with Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has grown.&lt;/span&gt;
Claw&#39;s views have grown less favorable to domination.
Padmiri&#39;s views have grown more favorable to love and cooperation.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 250;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 250;
addPointsToDrive(gC(&quot;chMir&quot;).dLove,100);
addPointsToDrive(gC(&quot;chMir&quot;).dCooperation,100);
addPointsToDrive(gC(&quot;chClaw&quot;).dDomination,-100);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="145" name="SE EthicsOfPow MiddleGround" tags="" position="3521,449" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, well. We should clearly have some balance between respecting the strong and helping everyone find happiness. Padmiri&#39;s vision is clearly great to make sure everyone is happy, and Claw&#39;s-&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Do you really think things will work out that way? Do you think that simply saying nice things about our positions will appease us?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Um, if you&#39;d let me,&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;If you really think so you&#39;re probably even a bigger fool, and life will crush you too. I&#39;m done here.&quot;//&lt;/span&gt;

And Claw leaves.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;m sorry, but she&#39;s right there. Looking for a hollow compromise will solve nothing.&quot;//&lt;/span&gt;

And Padmiri leaves as well.

//That didn&#39;t go exactly like I expected.//

//&lt;span style=&quot;color:red&quot;&gt;Your enmity with Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity with Padmiri has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has decreased a bit.&lt;/span&gt;
Claw&#39;s views have grown more favorable to domination and ambition.
Padmiri&#39;s views have grown more favorable to cooperation and ambition.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 250;
State.variables.chPlayerCharacter.relations.chMir.enmity.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.enmity.stv += 100;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 100;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 100;
addPointsToDrive(gC(&quot;chMir&quot;).dAmbition,100);
addPointsToDrive(gC(&quot;chMir&quot;).dCooperation,100);
addPointsToDrive(gC(&quot;chClaw&quot;).dDomination,100);
addPointsToDrive(gC(&quot;chClaw&quot;).dAmbition,100);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="146" name="SE EthicsOfPow NeedsToThink" tags="" position="3516,560" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I... don&#39;t know. You both make compelling arguments. I think I need to think it over.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;That&#39;s fine to me. Keep thinking about it. I already know what I have to do anyway.&quot;//&lt;/span&gt;

Claw leaves without a second thought.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Don&#39;t worry, dear. I&#39;ll end up solving this, somehow.&quot;//&lt;/span&gt;

Padmiri looks at you in a patronizing way.

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.submission.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.domination.stv += 250;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 250;
State.variables.chMir.relations.chClaw.enmity.stv += 250;
State.variables.chClaw.relations.chMir.enmity.stv += 250;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="147" name="SE EthicsOfPow RefuseSides" tags="" position="3403,560" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;re clearly overthinking this. It&#39;s just best to act as you think as opportunities appear before you.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;So you aren&#39;t even going to think about this?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;What a fool. One of these days the wolf will declare its intent to devour you, you&#39;ll disregard it as something you don&#39;t need to think about, and sooner than later you will end up in its belly.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I agree. $chPlayerCharacter.name&#39;s position is, without a doubt, the worst.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;There&#39;s not a worse place to be than nowhere.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Hey, it&#39;s just what I think, okay?&quot;//&lt;/span&gt;

They both sigh and leave.

//&lt;span style=&quot;color:red&quot;&gt;Your enmity with Claw has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity with Padmiri has grown a bit.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv += 100;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 100;
State.variables.chPlayerCharacter.relations.chMir.enmity.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.enmity.stv += 100;
State.variables.chClaw.relations.chMir.friendship.stv += 100;
State.variables.chMir.relations.chClaw.friendship.stv += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="148" name="SE EthicsOfPow MutualUnderstanding" tags="" position="3633,564" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I can see why someone would end up thinking the way Claw does. There&#39;s people that you can&#39;t simply reason with, people who don&#39;t stop at anything until they get what they want, no matter how much suffering and pain they cause.&quot;//&lt;/span&gt;

Claw is serious. Padmiri looks sad. They both look at you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And you can&#39;t deny that the world will bend to them if there&#39;s no one to stop them. One simply needs to be strong in order to not to... get stomped by life. But that, on its own, doesn&#39;t mean that we should accept that the world will always play by their rules. Life is just what we make it out to be, and I&#39;m sure it has enough room for all of us to be happy if we put work and strength into making it possible.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You...&quot;//&lt;/span&gt; You think you&#39;ve noticed a small tremor in Claw&#39;s lips. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You are just too naive. Too hopeless.&quot;//&lt;/span&gt; She looks away. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;m done with this conversation. Goodbye.&quot;//&lt;/span&gt;

And she quickly turns her face and leaves.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I think you may have a point.&quot;//&lt;/span&gt; Padmiri admits. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Thank you for sharing your thoughts.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Claw has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Claw has grown a bit.&lt;/span&gt;
Padmiri&#39;s views have grown more favorable to cooperation and domination.
Claw&#39;s views have grown more favorable to cooperation.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.friendship.stv += 100;
State.variables.chClaw.relations.chPlayerCharacter.friendship.stv += 100;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 250;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 100;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 100;
addPointsToDrive(gC(&quot;chMir&quot;).dDomination,250);
addPointsToDrive(gC(&quot;chMir&quot;).dCooperation,100);
addPointsToDrive(gC(&quot;chClaw&quot;).dCooperation,250);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="149" name="SecondDay MeetTempleStaff" tags="" position="615,997" size="100,100">She walks to the back of the Grand Hall, where a sizable double door stands. Drishtya knocks on it, and it gets opened by Shrezdill, who was on the other side. The Ashwalker, along with four other persons, enters the Grand Hall, and they walk behind the Priestess Regent up to your position.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I trust you remember Shrezdill, from yesterday. She and I are the last Candidates from the previous generation who remain alive. The rest are people from the tribes who were offered to help with the Temple&#39;s preservation.&quot;//&lt;/span&gt;

She nods at one of them, a human woman of mature age and light skin, who walks forward.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Hello, Candidates. I&#39;m Vesia, and I look after the Temple&#39;s library, you&#39;ll often find me between scrolls, and above them, and before them - but please don&#39;t mind me, I can always help you find what you&#39;re looking for.&quot;//&lt;/span&gt;

Her gestures are exaggerated, and her tone, theatrical. She wears a very large white robe, silver bracelets, and a collar that reflects a dim, dark, blue light.

A Leirien man and woman advance next. They have ample, warm smiles, and they glance at each other from time to time. Like Padmiri, they have different assortments of vines and flowers through their bodies, but they also wear (or have) slim roots.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Welcome, beautiful ones,&quot;//&lt;/span&gt; she begins. &lt;span style=&quot;color:gray&quot;&gt;//&quot;I&#39;m Fastya, the Temple&#39;s resident gardener.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;And I&#39;m Dutzelt, the Temple&#39;s resident chef.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;I harvest the gifts the earth provides to us,&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;And I get them ready for your plates.&quot;//&lt;/span&gt;

And they finish in unison: &lt;span style=&quot;color:gray&quot;&gt;//&quot;You have nothing to worry about while in our care.&quot;//&lt;/span&gt;

Drishtya makes a small gesture that you interpret as a mute sigh.

The last person is another Aiishen. Unlike Maaterasu, this is a tall man. Like her, he maintains a serious expression, but it&#39;s one that transmits maturity, rather than lack of emotion.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Greetings, Candidates. My name is Taototh, and I was selected by the previous High Priestess as the Temple&#39;s official researcher.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;He is too modest to tell you about it, but he also operates some of the Temple&#39;s infrastructure, which is fundamental for some of our rituals.&quot;//&lt;/span&gt;

She coughs.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;...Now, we should get your first training session ready. Follow me into the library.&quot;//&lt;/span&gt;

[[Continue|SecondDay StartTraining]]</tw-passagedata><tw-passagedata pid="150" name="SecondDay StartTraining" tags="" position="74,1103" size="100,100">At one side of the Grand Hall, some doors are the entrance to the Temple&#39;s library, or at least, its biggest section. There is a fair empty space at its entrance, but lines of shelves extend in all directions from there, full of scrolls. Drishtya turns around at the center of this lobby and resumes the explanations.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Most of your days as Candidates will follow the same schedule: training during mornings, work from noon to afternoon, and freedom to spend the rest of the time as you choose.

As I explained yesterday, we&#39;ll be channeling the Valley&#39;s energy to empower your training, but in order to do it as efficiently as possible, we will limit it to the mornings. You can also train it during the rest of the day, but you will get inferior results. Training makes your body and mind tired - and that will not be a problem for now, but there may come a time in which danger lurks around the corner. If it comes to that, you must avoid getting so tired that you can&#39;t defend yourselves.

Work is fundamental to keep the Temple running, and everyone who inhabits it is expected to contribute. You will receive money in compensation, but you will only be able to spend it when travelling merchants pass through here.

I advise you to use evenings to build your relationships with your peers.

Past this hall there are the West and East wings of the library, and the rest of the training grounds are beyond them. You will find it easiest to develop different parts of yourselves at different areas, so make sure to have a proper look at all of them.

I trust you&#39;ll do your best.&quot;//&lt;/span&gt;

&lt;&lt;link [[Start training period|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
initTrainingPeriodPassionTemple();
for ( var character of getActiveSimulationCharactersArray() ) {
	gC(character).restoreMood();
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="151" name="Scene B" tags="" position="1383,135" size="100,100">$sc.scenePassage</tw-passagedata><tw-passagedata pid="152" name="SE Staying Hydrated Start" tags="" position="2514,819" size="100,100">$customRoomIntro
All Candidates are having breakfast together in the Dining Hall. Today&#39;s plate is an assortment of fried mushrooms accompanied by smaller pieces of fruits from the forest.

Nashillbyir, Valtan, Padmiri and you share a casual conversation about your new lives. Maaterasu pays attention, but doesn&#39;t intervene. Claw doesn&#39;t look at any of you - she simply finishes her plate fast and leaves as soon as possible.

Maaterasu finishes soon too, due to avoiding opening her mouth for anything other than eating, and so does Nash, who does everything with haste during the morning. When you&#39;re done with your plate, you notice that Val was already done as well, but she stayed to keep talking anyway. You shrug it off and leave to the Training Grounds.

[[Continue|SE Staying Hydrated MirIsLagging]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="153" name="SE Staying Hydrated MirIsLagging" tags="" position="2626,815" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
However, once you go past the door, you notice a change in the tone of the conversation.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Oh, dear, is that a little sap in your mouth?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes, but please don&#39;t mind me...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I don&#39;t mind you at all...&quot;//&lt;/span&gt;

By now, you&#39;re already peeking back into the dining room, and you can clearly see Valtan leaning over to Padmiri and licking her mouth.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Mmm. It&#39;s just as I thought. You&#39;re thirsty, aren&#39;t you?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Um, em, but it&#39;s no problem really, I&#39;ll go right now to...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;But there&#39;s no need for that. What kind of friend would I be if I had a thirsty friend... And didn&#39;t offer her to drink from me?&quot;//&lt;/span&gt;

Padmiri&#39;s face finishes its transition into shock.

//Is she asking her to...?//

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You only need to get on your knees.&quot;//&lt;/span&gt;

[[But you are thirsty too!|SE Staying Hydrated ValHydratesPlayer]]
[[No, no, Val can&#39;t lose fluids, you have to give her some yourself|SE Staying Hydrated PlayerHydratesVal]]
[[Take advantage and take Mir&#39;s &quot;back&quot;. For maximum hydration|SE Staying Hydrated MirSurrounded]]
[[Help Padmiri to escape|SE Staying Hydrated MirEscortedToExit]]
[[Tell Val you already keep Padmiri well hydrated|SE Staying Hydrated MirIsHydrated]]
[[Remain hidden. Send a hand down your pants|SE Staying Hydrated Voyeur]]
[[Let them have their fun, you can&#39;t miss training|SE Staying Hydrated LeftScene]]</tw-passagedata><tw-passagedata pid="154" name="SE Staying Hydrated ValHydratesPlayer" tags="" position="2787,813" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hey, you could have also offered me...&quot;//&lt;/span&gt;

They both immediately turn their heads to you. Valtan&#39;s surprise soon turns into interest. Padmiri recovers herself and takes the initiative.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I don&#39;t want to be greedy then! Please take care of $chPlayerCharacter.name.&quot;//&lt;/span&gt; Just as she says so, she starts walking towards you, hurrying to leave the room.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Aren&#39;t you glad you have such a generous friend? Thanks to Padmiri you&#39;ll have access to fresh liquid, directly from the source.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And also thanks to you.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Quite the lucky one, surrounded by such remarkable people! Now, open wide... And kneel for me.&quot;//&lt;/span&gt;

&lt;&lt;link [[Kneel|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
teachBasicMovesToCharacters(&quot;chPlayerCharacter&quot;);
stHyInitPlToVal();
if ( gC(&quot;chVal&quot;).socialAi.conquestTs.includes(&quot;chPlayerCharacter&quot;) == false ) {
	gC(&quot;chVal&quot;).socialAi.conquestTs.push(&quot;chPlayerCharacter&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="155" name="SE Staying Hydrated PlayerHydratesVal" tags="" position="2901,815" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But Val, if there&#39;s someone who needs to stay hydrated at all times, that&#39;s you.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Ah?&quot;//&lt;/span&gt; &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Uh?&quot;//&lt;/span&gt;

Both of them are equally surprised to see you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Aren&#39;t you made of liquid? If you go around giving it away, without control...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You&#39;re definitely right.&quot;//&lt;/span&gt; Padmiri intervenes. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;You have to listen to your &#39;dear&#39; friends when they&#39;re worried about you, Val. $chPlayerCharacter.name, I think you were offering to help, right?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sure! Um, I want Val to stay healthy, after all.&quot;//&lt;/span&gt;

Val, who had grown increasingly astonished as the discussion advanced, now shows complete amusement.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I... can&#39;t refuse this much generosity.&quot;//&lt;/span&gt; She shrugs, closing her eyes, defeated.

You&#39;re now next to them.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Go on, you can&#39;t keep her waiting the whole day. Kneel.&quot;//&lt;/span&gt;

&lt;&lt;link [[Val kneels before you|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
teachBasicMovesToCharacters(&quot;chPlayerCharacter&quot;);
stHyInitValToPl();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="156" name="SE Staying Hydrated MirSurrounded" tags="" position="3008,817" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She&#39;s right, Padmiri.&quot;//&lt;/span&gt;

Both girls jump in surprise as soon as they hear you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Just as you want the best for us, we just want the best for you...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Wise words from our friend $chPlayerCharacter.name.&quot;//&lt;/span&gt;

You&#39;re now next to them and taking Padmiri&#39;s arm, inviting her to stand up.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We care so much, that we will both be... Hydrating you.&quot;//&lt;/span&gt;, and you whisper in the Leirien&#39;s ear: &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ve got your back.&quot;//&lt;/span&gt;

Surrounded and unable to stand the social pressure, Padmiri gives in and gives you a meek: &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Ok.&quot;//&lt;/span&gt;

&lt;&lt;link [[Padmiri gets on all fours|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
teachBasicMovesToCharacters(&quot;chPlayerCharacter&quot;);
stHyInitSpitroast();
State.variables.sc.formatScenePassage();
gC(&quot;chMir&quot;).socialAi.rivalTs.push(&quot;chPlayerCharacter&quot;);
gC(&quot;chMir&quot;).socialAi.rivalTs.push(&quot;chVal&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="157" name="SE Staying Hydrated MirEscortedToExit" tags="" position="2788,927" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I forgot about something, Padmiri!&quot;//&lt;/span&gt; You walk into the dining hall like an elephant into a glass workshop, shouting loudly and breaking Valtan&#39;s plot. Both Padmiri and Valtan jump in surprise.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes! What was it!?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Remember that thing you were telling me about yesterday?&quot;//&lt;/span&gt; She looks a bit lost. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...That thing I was so eager to know about, but you didn&#39;t have enough time to finish?&quot;//&lt;/span&gt; She stays quiet for a moment.

//Please, figure it out!//

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Oh, that thing! I&#39;m sorry Val, but $chPlayerCharacter.name was dying to hear about it! See you!&quot;//&lt;/span&gt;

//Good, she figured out the thing doesn&#39;t exist.//

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;So... What is it?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We&#39;ll tell you later!&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Padmiri has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity with Valtan has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 350;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 350;
State.variables.chPlayerCharacter.relations.chMir.romance.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.romance.stv += 100;
State.variables.chPlayerCharacter.relations.chVal.rivalry.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.rivalry.stv += 350;
State.variables.chPlayerCharacter.relations.chVal.enmity.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.enmity.stv += 350;
gC(&quot;chVal&quot;).socialAi.rivalTs.push(&quot;chPlayerCharacter&quot;);
gC(&quot;chMir&quot;).socialAi.allyTs.push(&quot;chPlayerCharacter&quot;);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="158" name="SE Staying Hydrated MirIsHydrated" tags="" position="2904,929" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;re worrying over nothing, Val!&quot;//&lt;/span&gt; You walk into the dining hall like an elephant into a glass workshop, shouting loudly and breaking Valtan&#39;s plot. Both Padmiri and Valtan jump in surprise.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I already keep Padmiri well hydrated.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;...Oh, do you?&quot;//&lt;/span&gt; She looks at Padmiri is disbelief.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Well...&quot;//&lt;/span&gt;

You&#39;re already next to them, and you place your hand over Padmiri&#39;s shoulder.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes! Yes, she does.&quot;//&lt;/span&gt;

Valtan is reading Padmiri like if she was an open book. She looks at you with contempt. She didn&#39;t like that.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I guess I WAS worrying over nothing then.&quot;//&lt;/span&gt;

Both Valtan and Mir get up, and you lower your hand to the Leirien&#39;s butt. She looks at you and nods.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity with Valtan has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 100;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 100;
State.variables.chPlayerCharacter.relations.chVal.rivalry.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.rivalry.stv += 350;
State.variables.chPlayerCharacter.relations.chVal.enmity.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.enmity.stv += 350;
gC(&quot;chVal&quot;).socialAi.rivalTs.push(&quot;chPlayerCharacter&quot;);
gC(&quot;chMir&quot;).socialAi.loveTs.push(&quot;chPlayerCharacter&quot;);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="159" name="SE Staying Hydrated Voyeur" tags="" position="3011,927" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
You slightly retreat your head from the door, remaining hidden in the corridor and keeping your ears open.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I... Ok.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;That&#39;s a good girl, now. You don&#39;t want to refuse... Acts of generosity.&quot;//&lt;/span&gt;

Your hand is already working your groin.

&lt;&lt;link [[Masturbate|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
stHyInitMirToVal();
gC(&quot;chVal&quot;).socialAi.covetTs.push(&quot;chMir&quot;);
gC(&quot;chMir&quot;).socialAi.rivalTs.push(&quot;chVal&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="160" name="SE Staying Hydrated LeftScene" tags="" position="2534,929" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
//This... Doesn&#39;t concern me, really. So what if Padmiri buries her head in Valtan&#39;s thighs and... Nope, nope, I have to focus on training. Focus! Let&#39;s leave already.//

&lt;&lt;script&gt;&gt;
State.variables.chVal.relations.chMir.sexualTension.stv += 350;
State.variables.chMir.relations.chVal.sexualTension.stv += 350;
State.variables.chVal.relations.chMir.domination.stv += 750;
State.variables.chMir.relations.chVal.submission.stv += 750;
State.variables.chVal.relations.chMir.rivalry.stv -= 350;
State.variables.chMir.relations.chVal.rivalry.stv -= 350;
gC(&quot;chVal&quot;).socialAi.covetTs.push(&quot;chMir&quot;);
gC(&quot;chMir&quot;).socialAi.rivalTs.push(&quot;chVal&quot;);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="161" name="SE Staying Hydrated ValHydratesPlayer End" tags="" position="2511,1040" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Aaaaah... Ah. Ah...&quot;//&lt;/span&gt; Val recovers her breath, one hand on her breast, another one on your head.

//My whole face is wet. ...And sticky.//

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;That was fantastic. But now, what should you say after you&#39;re served something to eat?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I guess... Thanks for the meal?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Precisely. Good girl.&quot;//&lt;/span&gt;

She offers you a hand to help you get up from your knees.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;And now that your belly is full, you&#39;re set and ready to have a productive day.&quot;//&lt;/span&gt; She says as she fondles your butt. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;...You may have to get cleaned before that, though.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Valtan has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 100;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 350;
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 350;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="162" name="SE Staying Hydrated PlayerHydratesVal End" tags="" position="2618,1042" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Mmmnnn... Ah, ah, ah...&quot;//&lt;/span&gt; You slowly recover you breath, both of your hands over Val&#39;s head.

//Her tongue is sooo good...//

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Looks like you enjoyed it.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Now, now, Val. $chPlayerCharacter.name was all worried about you, don&#39;t you have anything to tell her?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Of course... Thanks, $chPlayerCharacter.name. You are delicious.&quot;//&lt;/span&gt; She looks at you with lustful eyes and a calculated smile.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That&#39;s much better.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Valtan has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 350;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 350;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 350;
State.variables.chPlayerCharacter.relations.chVal.rivalry.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.rivalry.stv += 350;
State.variables.chPlayerCharacter.relations.chVal.domination.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.submission.stv += 350;
State.variables.chMir.relations.chVal.domination.stv += 350;
State.variables.chVal.relations.chMir.submission.stv += 350;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="163" name="SE Staying Hydrated Voyeur End" tags="" position="2836,1041" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;50 lust&lt;/span&gt;.//

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Nnggyaa! Gya, hah, ha...&quot;//&lt;/span&gt; Val&#39;s gasping slowly calms down.

//They&#39;re done already? But I haven&#39;t finished!//

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Oh, my dear. I should let you breathe. There. Are you fine now?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Aaah-... Ah. Yes, I am.&quot;//&lt;/span&gt; 

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Now, what should you say to those who share their generosity with you?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Are you really...?&quot;//&lt;/span&gt; 

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Yes.&quot;//&lt;/span&gt;

A moment of silence. You&#39;re a bit too tired to risk taking another look at what&#39;s happening.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Thanks... For the meal.&quot;//&lt;/span&gt; 

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Of course, you have good manners, of all people. Good girl.&quot;//&lt;/span&gt; Another pause. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;It&#39;s about time we left... But you should clean your face first.&quot;//&lt;/span&gt;

//I should run away, right now!//;

&lt;&lt;script&gt;&gt;
State.variables.chVal.relations.chMir.sexualTension.stv += 350;
State.variables.chMir.relations.chVal.sexualTension.stv += 350;
State.variables.chVal.relations.chMir.domination.stv += 750;
State.variables.chMir.relations.chVal.submission.stv += 750;
State.variables.chVal.relations.chMir.rivalry.stv -= 350;
State.variables.chMir.relations.chVal.rivalry.stv -= 350;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="164" name="SE Staying Hydrated MirSurrounded End" tags="" position="2726,1042" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
The three of you are panting, exhausted. Padmiri is barely able to keep herself from falling to the ground. Valtan is drowned in pleasure.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;See, Mir? You truly have wonderful friends. Isn&#39;t there something you should tell us?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I... Ah... I...&quot;//&lt;/span&gt;

Your hands are on the back of the Leirien&#39;s waist. Its movements show her breathing going up and down, her heat hints how she&#39;s felt between her legs.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Something you&#39;d tell people who have just fed you?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes. Thank you for the meal.&quot;//&lt;/span&gt;

She barely manages to turn her face to look at you. Anyone would be able to tell she&#39;s exhausted.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We&#39;ll gladly keep you well fed. You only have to ask us.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;And sometimes you don&#39;t even have to ask.&quot;//&lt;/span&gt;

Val winks at you.

//&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity with Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Valtan has grown.&lt;/span&gt;
Padmiri&#39;s views have grown more favorable to domination and less favorable to cooperation.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 350;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 350;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 350;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 350;
State.variables.chMir.relations.chPlayerCharacter.rivalry.stv += 350;
State.variables.chMir.relations.chPlayerCharacter.enmity.stv += 350;
State.variables.chPlayerCharacter.relations.chVal.friendship.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.friendship.stv += 350;
State.variables.chPlayerCharacter.relations.chVal.rivalry.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.rivalry.stv += 350;
State.variables.chVal.relations.chMir.sexualTension.stv += 350;
State.variables.chMir.relations.chVal.sexualTension.stv += 350;
State.variables.chVal.relations.chMir.domination.stv += 350;
State.variables.chMir.relations.chVal.submission.stv += 350;
State.variables.chMir.relations.chVal.enmity.stv += 350;
State.variables.chMir.relations.chVal.rivalry.stv += 350;
addPointsToDrive(gC(&quot;chMir&quot;).dCooperation,-100);
addPointsToDrive(gC(&quot;chMir&quot;).dDomination,100);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="165" name="SE Friend Back At Home Start" tags="" position="3283,703" size="100,100">$customRoomIntro
It&#39;s early in the morning, early enough for the sky to be golden and melancholic. You&#39;re taking a stroll to see the lake imbued with the particular colors of dawn.

You find someone on their knees next to the shore, their torso inclined forwards to see something in the water. It was strange at first because the blue hair was collected on their shoulder, but the white tunic leaves no room for anyone else, and you recognize her, her face still out of your sight.

//It&#39;s Val.//

Once you&#39;re just a couple of meters next to her, you greet her: &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hello, Val, how&#39;s the water?&quot;//&lt;/span&gt;

[[Continue|SE Friend Back At Home Shes Not Valtan]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="166" name="SE Friend Back At Home ShesValtan" tags="" position="3281,814" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
The sweet-faced girl gets up, closes her eyes, and her facial features transform in a couple of seconds. The angel has turned into a well-known succubus.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You were right, I&#39;m Val. I wasn&#39;t expecting you to come here.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What... What was that? &quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I guess you have never seen any of us do it, right? Any of us Shapeshifters.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Oh. So it was true you can... Change shapes.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Aha.&quot;//&lt;/span&gt;

Valtan&#39;s expression isn&#39;t usual in her. Instead of her cockiness and enthusiasm, she&#39;s calm and serious.

//...Wait, something still doesn&#39;t add up.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So what were you doing, exactly?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;...Mm. I guess there won&#39;t be harm in telling you.&quot;//&lt;/span&gt; She closes her eyes for a moment and sighs. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;That was Sillan, the... Actual woman the Shapeshifters chose.&quot;//&lt;/span&gt;

//Yes, I&#39;ve heard about this already.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Were you looking at the reflection of her face? Why?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;...I... Just wanted to do that. I wanted to look at her face.&quot;//&lt;/span&gt;

[[Continue|SE Friend Back At Home Questions]]</tw-passagedata><tw-passagedata pid="167" name="SE Friend Back At Home Questions" tags="" position="3398,815" size="100,100">&lt;&lt;script&gt;&gt;SeFriendBackAtHomeCheck()&lt;&lt;/script&gt;&gt; \
$customRoomIntro
//What do I want to ask her?//

[[What kind of person is Sillan?|SE Friend Back At Home HowsSill]]
[[What&#39;s Sillan to Valtan?|SE Friend Back At Home WhatsSill]]
[[Why did Valtan take Sillan&#39;s place?|SE Friend Back At Home WhyTakePlace]]
&lt;&lt;if $StVars.SeFbahWhyTakePlaceSill is true&gt;&gt;[[Does Valtan regret taking Sillan&#39;s place?|SE Friend Back At Home Regret]]
&lt;&lt;/if&gt;&gt; \

&lt;&lt;if $StVars.SeFbahAnyQuestions is &quot;none&quot;&gt;&gt;[[I have no more questions|SE Friend Back At Home End]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.SeFbahAnyQuestions is &quot;some&quot;&gt;&gt;[[I have no more questions|SE Friend Back At Home End2]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.SeFbahAnyQuestions is &quot;all&quot;&gt;&gt;[[I have no more questions|SE Friend Back At Home End3]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="168" name="SE Friend Back At Home WhatsSill" tags="" position="3280,927" size="100,100">$customRoomIntro
&lt;&lt;set $StVars.SeFbahWhatsSill = true&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What is... Sillan to you?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What is... she to me?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I mean... Was she... your sister?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;We... Don&#39;t have that kind of concepts in my tribe. We don&#39;t have parents or siblings, we&#39;re just part of the tribe.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Did you want to marry her then?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;We don&#39;t marry either.&quot;//&lt;/span&gt;

//Ugh. How can I ask this?//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Do you love her?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Val?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Next question.&quot;//&lt;/span&gt;

//Are her eyes shining?//

[[Continue|SE Friend Back At Home Questions]]</tw-passagedata><tw-passagedata pid="169" name="SE Friend Back At Home HowsSill" tags="" position="3163,927" size="100,100">$customRoomIntro
&lt;&lt;set $StVars.SeFbahHowsSill = true&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What kind of person is Sillan?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;She&#39;s... Like a snowflake. Pure. Beautiful. Innocent. Frail like pristine water against some corrupted, perverted mind...&quot;//&lt;/span&gt;

She sets her eyes on the sky, not looking at anything in particular.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;She was never the kind of person to take matters into her own hands. Someone who didn&#39;t think highly of her said that her soul couldn&#39;t deal with the weight of life, once... But I was always there to protect her.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...And now you aren&#39;t.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;No. Not anymore.&quot;//&lt;/span&gt;

[[Continue|SE Friend Back At Home Questions]]</tw-passagedata><tw-passagedata pid="170" name="SE Friend Back At Home WhyTakePlace" tags="" position="3398,927" size="100,100">$customRoomIntro
&lt;&lt;set $StVars.SeFbahWhyTakePlaceSill = true&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Why did you take Sillan&#39;s place?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;She wouldn&#39;t have been able to handle it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What of it?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Everything. She... Never had the initiative to do anything. It was always me who was taking her places, getting her involved with the other kids... She got scared with ease. And she always got really nervous about sex. She wouldn&#39;t have been able to succeed here.&quot;//&lt;/span&gt;

//...Wait.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wait, if there&#39;s any sex-crazed fiend around here that&#39;s you.&quot;//&lt;/span&gt;

Valtan shrugs and rolls her eyes.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Still.&quot;//&lt;/span&gt;

//Is this all, or is there something more?//

[[Continue|SE Friend Back At Home Questions]]</tw-passagedata><tw-passagedata pid="171" name="SE Friend Back At Home Regret" tags="" position="3511,927" size="100,100">$customRoomIntro
&lt;&lt;set $StVars.SeFbahRegretSill = true&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Do you regret it?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Coming here.&quot;//&lt;/span&gt;

Valtan turns her face away from you for a while. She looks back at you with determination.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;No. I did what I had to do. I... There was no other choice.&quot;//&lt;/span&gt;

[[Continue|SE Friend Back At Home Questions]]</tw-passagedata><tw-passagedata pid="172" name="SE Friend Back At Home End" tags="" position="3545,812" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I won&#39;t question you. I think that&#39;s part of your privacy.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hm. If you say so.&quot;//&lt;/span&gt;

She looks away.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ll... Leave you alone, ok? I think you need some time.&quot;//&lt;/span&gt;

She doesn&#39;t reply.

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="173" name="SE Friend Back At Home End2" tags="" position="3656,813" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That will be all. I think there are some things best left to your discretion.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hm.&quot;//&lt;/span&gt;

Valtan looks away.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Perhaps... You need some more time alone?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Perhaps.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ll take my leave, then...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;$chPlayerCharacter.name?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Thanks for listening.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Valtan has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.friendship.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.friendship.stv += 350;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="174" name="SE Friend Back At Home End3" tags="" position="3656,925" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think that&#39;s all I wanted to ask you.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hm.&quot;//&lt;/span&gt;

Valtan looks away. 

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Perhaps... You need some more time alone?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Perhaps.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ll take my leave, then...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;$chPlayerCharacter.name?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Thanks for listening.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Valtan has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.friendship.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.friendship.stv += 350;
gC(&quot;chVal&quot;).socialAi.allyTs.push(&quot;chPlayerCharacter&quot;);
gC(&quot;chVal&quot;).socialAi.rivalTs = [];
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="175" name="Social Interactions Specifics" tags="SIS" position="1841,130" size="100,100">&lt;&lt;script&gt;&gt;
State.variables.sisSpecifics.formatPassageText();
&lt;&lt;/script&gt;&gt; \ 
$sisSpecifics.passageText</tw-passagedata><tw-passagedata pid="176" name="Settings" tags="" position="1466,272" size="100,100">Select your preferences. Beware that changing some of these after the start of the game may cause problems.

$settings.allChoices</tw-passagedata><tw-passagedata pid="177" name="SecondDay RitualOfAvatars3b" tags="" position="393,1110" size="100,100">Drishtya steps back, and takes a long look at everyone. She opens her arms, hands and palms long and wide, and pulls them, like a puppeteer controlling the very forces of nature.

The mist massages your skin, and your body vibrates. You feel waves running through your body, from your shoulders to your hands, from your waist to your neck, and from your neck to your groin. And it pulsates.

You feel a force wrapping your legs, your waist, your behinds. And then it enters you. Your abdomen is weak, your legs tremble. Heat consumes you, and pleasure engulfs you.

//Nnn... Gghh... Aaaaa//aaa//aaahh....//

//&lt;span style=&quot;color:red&quot;&gt;You have reached orgasm!&lt;/span&gt;//
&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.lust.current = 100;&lt;&lt;/script&gt;&gt; \

Your breathing had accelerated, but after reaching orgasm, it slowly goes back to normal. You feel disoriented, and you lose half a minute to your dizziness. When you&#39;re fully back to normal, the mist is dissipating.

[[Continue|SecondDay RitualOfAvatars4b]]</tw-passagedata><tw-passagedata pid="178" name="SecondDay RitualOfAvatars4b" tags="" position="497,1105" size="100,100">Your legs and arms feel weak and numb, your mind is quiet, your whole body rests relaxed, and behind it all, you feel invigorated, as if the mere act of wishing it would allow you to fly.

Everyone around you seems to share your tranquility. Even Claw, who usually looks like she&#39;s about to jump at someone&#39;s throat, is now as peaceful as a tired, tamed kitty.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Congratulations, my dear ones. You&#39;ve taken the first step into becoming Avatars of the Goddess.

You will soon have to begin your training, but I must introduce you to the rest of the Temple&#39;s inhabitants first.&quot;//&lt;/span&gt;

[[Continue|SecondDay MeetTempleStaff]]</tw-passagedata><tw-passagedata pid="179" name="GoddessHerald 5b" tags="" position="536,141" size="100,100">&lt;&lt;set $StVars.gh2 to 0&gt;&gt; \
However, just as she&#39;s about to stick her fingers inside you, she stops. She stops and walks back, her tail playfully swinging around.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Yes, I can see you want me to take you.&quot;//&lt;/span&gt;

She makes a strange gesture with her arms, painting a grand circle with her hands around herself.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;And I will take you as properly as you deserve for your first time.&quot;//&lt;/span&gt;

Once her hands are at the top of her head, they start emitting a beautiful, clear light. Her hands swing wildly and point at you, and the light engulfs you. You suddenly feel your crotch burning.

Her eyes, once again, strike at yours, glowing purple. 
//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;10 lust&lt;/span&gt;.//
//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower&lt;/span&gt;.//&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.lust.changeValue(-10);
State.variables.chPlayerCharacter.willpower.changeValue(-10);
State.variables.chGoddessHerald.addBodypart(&quot;dick&quot;,&quot;dick&quot;);&lt;&lt;/script&gt;&gt;

&lt;&lt;link [[&#39;Your legs are trembling. Your strength fails you. You surrender to her.&#39;|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.sc.startScene(
&quot;ss&quot;, &quot;fixed&quot;,
[&quot;chPlayerCharacter&quot;], [&quot;chGoddessHerald&quot;],
&quot;The mist extends in all directions...&quot;,
ghScissorEndCondition, 10,
&quot;GoddessHerald 6a&quot;);
State.variables.chGoddessHerald.hasLead = &quot;true&quot;;
State.variables.sc.sceneConditions.push(&quot;cantCancelActions&quot;);
State.variables.sc.sceneConditions.push(&quot;cantCancelPositions&quot;);
State.variables.chGoddessHerald.aiAlgorythm = createAiActionSequence();
State.variables.chGoddessHerald.aiAlgorythm.actionSequence = [&quot;frottage&quot;,&quot;mountFaceToFace&quot;,&quot;interlockLegs&quot;,&quot;scissor&quot;,&quot;frenchKiss&quot;,&quot;scissor&quot;,&quot;strokeBreasts&quot;,&quot;scissor&quot;];
State.variables.chGoddessHerald.aiAlgorythm.fixedTarget = &quot;chPlayerCharacter&quot;;
State.variables.StVars.gh1 = 1;
State.variables.sc.customScript = cssGhScissor;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;if $chPlayerCharacter.willpower.current &gt; 55 &gt;&gt; \
[[&#39;&quot;Wait! I back down! I don&#39;t want this anymore!&quot;&#39;|GoddessHerald 6b][$StVars.gh1 to 2]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You need more willpower to unlock this choice.
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="180" name="Tests2" tags="" position="1700,282" size="100,100">&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;
&lt;&lt;script&gt;&gt;createSystemEventSearchForScrolls(10,[&quot;chPlayerCharacter&quot;]).effect();

State.variables.logL1.push(gC(&quot;chPlayerCharacter&quot;).foundScrolls);
gC(&quot;chPlayerCharacter&quot;).foundScrolls = [];
&lt;&lt;/script&gt;&gt;


[[Quickstarts]]</tw-passagedata><tw-passagedata pid="181" name="Battle Tests Room" tags="" position="1370,22" size="100,100">&lt;&lt;set $tsr to new weightedList&gt;&gt; \
&lt;&lt;set $tsr.character to &quot;chNash&quot;&gt;&gt; \
&lt;&lt;set $tsr.sceneType to &quot;&quot;&gt;&gt; \
&lt;&lt;script&gt;&gt;
setUpBattleTestsRoom(); 
//State.variables.chNash.control = 0;
//State.variables.chPlayerCharacter.control = 0;
//createBposDP2frontalPounce(&quot;chNash&quot;,[&quot;chPlayerCharacter&quot;]);
//createBposDP2frontalPounce(&quot;chPlayerCharacter&quot;,[&quot;chNash&quot;]);
&lt;&lt;/script&gt;&gt; \
\
&lt;span style=&quot;color:green&quot;&gt;You can save the game!&lt;/span&gt;

Tests room

__Opponent__
&lt;&lt;radiobutton &quot;$tsr.character&quot; &quot;chNash&quot; checked&gt;&gt; Nashillbyir
&lt;&lt;radiobutton &quot;$tsr.character&quot; &quot;chMir&quot;&gt;&gt; Padmiri
&lt;&lt;radiobutton &quot;$tsr.character&quot; &quot;chClaw&quot;&gt;&gt; Fiercest Claw
&lt;&lt;radiobutton &quot;$tsr.character&quot; &quot;chVal&quot;&gt;&gt; Valtan
&lt;&lt;radiobutton &quot;$tsr.character&quot; &quot;chAte&quot;&gt;&gt; Maaterasu

&lt;&lt;link [[Go for it.|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
configureBattleTestsRoomScene();
State.variables.sc.formatScenePassage();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; </tw-passagedata><tw-passagedata pid="182" name="SE Magic Class Start" tags="" position="3833,220" size="100,100">$customRoomIntro
It&#39;s so early in the morning that the sky itself has barely woken up, yet every Candidate is already reunited in the training grounds, summoned by Drishtya.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Greetings, Candidates. I hope you&#39;re awake and perceptive, despite the time.&quot;//&lt;/span&gt;

Fortunately, you&#39;re awake. Frustrated and tired due to waking up this early, but awake.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I have called you here because some of you aren&#39;t familiar enough with magic, which isn&#39;t exactly a balanced situation. This is something that should be corrected as early in your training as possible. And by this I mean we will correct it now.&quot;//&lt;/span&gt;

//Saying I&#39;m not familiar with magic is quite the understatement.//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;As you must know, every living being is sustained by aether, which is present in all things. When you do actions as basic as walking and talking, you are instinctively using aether to move your body.&quot;//&lt;/span&gt;

Her left arm moves in circular motion until it is in front of her.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Magic is a conscious effort to manipulate the aether that is not connected to your own body.&quot;//&lt;/span&gt;

She closes her hand, and some small wind blows around her, carrying a couple of leaves.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;In order to do this, you must feel the nature around you as part of your very being, and move it as if it was your own selves.&quot;//&lt;/span&gt;

The wind gets stronger and stronger, and you feel it pulling you towards Drishtya. It suddenly stops - when the Priestess Regent opens her hand, you notice a small ball built from countless moving white and gray threads. She agitates it, and it immediately collapses, turning into a gust of wind that explodes into all directions.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Achieving mastery of magic takes considerable dedication, and often proper guidance.&quot;//&lt;/span&gt;

[[Continue|SE Magic Class Getting Started]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="183" name="SE Magic Class Getting Started" tags="" position="3943,220" size="100,100">$customRoomIntro
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Nashillbyir, Claw and $chPlayerCharacter.name, step forward.&quot;//&lt;/span&gt;

You do as she commands and you look at the other two. Nash returns the look, apparently knowing as little as you.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I assume you have never used magic.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I haven&#39;t.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Neither have I.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I haven&#39;t either.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Very well. Extend your hands forwards, and focus on them. Take note of everything they feel, and try extending your consciousness to the elements that are behind those feelings. The Sun, the wind, your own muscles...&quot;//&lt;/span&gt;

//My... Consciousness? Extending it? What does she...?//

You understand soon enough. After focusing on it for a few seconds, you read the thoughts of the wind, and you read the thoughts of the sunlight. They&#39;re basic and primal, and they could be translated as //I exist// or //I flow//.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Drishtya?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Yes?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;We can practice magic as well, right? We didn&#39;t come here just to watch.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Of course, you&#39;re free to practice and ask me anything. These three will appreciate the demonstration as well.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;That&#39;s nice to hear.&quot;//&lt;/span&gt;

You turn around to satisfy your curiosity. Val walks confidently towards Mir, who observes her at first but soon turns shy, and avoids her face for moments. When Val is in front of the Leirien, she takes the green girl&#39;s shoulders.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;A-A-Ah, what-what are you-&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Relax, Mir, you have to feel the elements.&quot;//&lt;/span&gt;

Valtan moves forward and completely hugs her.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;ts coooold! Why! Why do you!?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I just wanted you to warm me up...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Valtan is projecting cold to Padmiri on touch. That may require some hard work for you - but for Shapeshifters it&#39;s relatively natural to learn projecting magic with our own bodies, since we use similar skills during shapeshifting.&quot;//&lt;/span&gt;

[[Continue|SE Magic Class Catching Up]]</tw-passagedata><tw-passagedata pid="184" name="SE Magic Class Catching Up" tags="" position="4053,220" size="100,100">$customRoomIntro
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;For now, I recommend you try casting manifestations of the elements themselves. Fire, cold and thunder fit the best for new magicians, since they don&#39;t require considerably high precision to be used effectively. Focus on the elements around your hand and try moving them as if they were your own limbs, giving them the form and the essence you want.&quot;//&lt;/span&gt;

You try doing as she asks. You manage to agitate the wind, to move it around, to make it stay quiet. Or at least, you think it is //your// doing, and not the natural movement of the wind... But it doesn&#39;t look like it&#39;s turning into anything else.

You take a quick look at Claw, who frowns as she looks at her own shaking hand. You glance at Nash too, who is in a similar position... But a very small flash appears out of nowhere and she steps back, scared.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Good job, Nashillbyir, you&#39;re on the right track.&quot;//&lt;/span&gt;

After a long breath, you go back to &quot;action&quot;. After a couple of minutes, you notice a small, persistent, cyan glow above your fingers. You contain your breath, trying not to lose focus, and it finally turns into a snowflake, which breaks into nothingness, but not before another one is formed at its corner... And then another one, and another, and another - but you notice you need to breathe, and they all shatter and disappear.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Congratulations. It looks like you&#39;ve got the basics. Continue building from them and you&#39;ll achieve great things.&quot;//&lt;/span&gt;

//What? Me?//

Drishtya is indeed looking at you.

//Oh, no! She means me! I need to hide!//

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Gaagnnggh!&quot;//&lt;/span&gt;

You immediately turn around and notice Maaterasu is bracing herself. The culprit is, as it was to be expected, Valtan, who has had enough of bullying Padmiri and is now freezing Maaterasu from afar. The Aiishen girl was caught by surprise for paying attention to your practice.

//Wait, everyone is looking at Ate and Val, I could catch someone by surprise now... Should I?//

&lt;&lt;link [[Keep practicing on your own|SE Magic Class Observe]]&gt;&gt;&lt;&lt;script&gt;&gt;setPasChars([]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Tease Nash|SE Magic Class Tease Nash]]&gt;&gt;&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; [img[img/charIcons/nashIcon.png]]
&lt;&lt;link [[Tease Claw|SE Magic Class Tease Claw]]&gt;&gt;&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; [img[img/charIcons/clawIcon.png]]
&lt;&lt;link [[Tease Mir|SE Magic Class Tease Mir]]&gt;&gt;&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; [img[img/charIcons/mirIcon.png]]
&lt;&lt;link [[Tease Ate as well|SE Magic Class Tease Ate]]&gt;&gt;&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chVal&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; [img[img/charIcons/ateIcon.png]]
&lt;&lt;link [[Make Val taste her own medicine|SE Magic Class Tease Val]]&gt;&gt;&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; [img[img/charIcons/valIcon.png]]</tw-passagedata><tw-passagedata pid="185" name="SE Magic Class Observe" tags="" position="3815,334" size="100,100">$customRoomIntro
You decide against imitating Valtan&#39;s foul behavior. You pay no mind to the others and focus instead on perfecting your own casting, before you try it in a real confrontation.

You cast snowflakes again, but this time you move your hands backwards, leaving a trail of cold dust behind them. Next time, you push the snowflakes forwards, but they don&#39;t fly too far. After a couple of tries, you paint in your mind the image of the freezing air advancing ahead of you... And you manage to recreate it in reality, though it lacks the intensity you desired.

Briefly later, something else draws your attention...

&lt;&lt;link [[Continue|SE Magic Class Ate Punishes Val]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="186" name="SE Magic Class Tease Nash" tags="" position="3926,334" size="100,100">$customRoomIntro
You step to the side, positioning yourself behind the Ashwalker, and focus on your hands, pointing them at her. You recall your earlier feelings and gestures... And soon you&#39;re casting cold in front of yourself. But you want to imitate Valtan, and so you visualize ice blending itself with the air, shot out off your hands and directly flying towards...

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Yeep!&quot;//&lt;/span&gt;

Nashillbyir&#39;s neck.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Have you seriously...?&quot;//&lt;/span&gt; She asks, turning around, only to find out you&#39;re shooting ice to her again.

She tries covering herself with her arms, moving her head to the sides and away from the cold. Eventually, she stops, looks at your own eyes, and extends her hands forwards...

And a explosion fires up. A very small, short-lived, and not very bright explosion, that barely reaches the distance of half an open hand, but an explosion nonetheless. You both step back, surprised by the event.

[[Attack her again|SE Magic Class Tease Nash Plus]]
[[Congratulate her|SE Magic Class Tease Nash Stop]]</tw-passagedata><tw-passagedata pid="187" name="SE Magic Class Tease Nash Plus" tags="" position="4038,334" size="100,100">$customRoomIntro
But you immediately grow out of your astonishment and attack her again. Nash goes back to covering herself, then stops and tries repeating her previous magic casting... Except this time she fails miserably.

Shortly after, you&#39;re chasing her through the fields practicing your ice-shooting. You had never pictured yourself doing something like this, but experience is completely exhilarating.

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Nashillbyir has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Nashillbyir has grown a bit.&lt;/span&gt;
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower&lt;/span&gt;.
//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
State.variables.chNash.willpower.current -= 5;
State.variables.chNash.lust.current -= 10;
State.variables.chNash.energy.current -= 10;
State.variables.chPlayerCharacter.relations.chNash.domination.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.submission.stv += 100;
State.variables.chPlayerCharacter.relations.chNash.rivalry.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.rivalry.stv += 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|SE Magic Class Ate Punishes Val]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="188" name="SE Magic Class Tease Nash Stop" tags="" position="4151,334" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That... Was pretty cool!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Was it?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Absolutely!&quot;//&lt;/span&gt;

The Ashwalker&#39;s face briefly brims with satisfaction.

//Let&#39;s hope that satisfies her and she won&#39;t turn on me.//

You decide you don&#39;t want to see what happens if she&#39;s actually able to defend herself.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown a bit.&lt;/span&gt;
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;5 willpower&lt;/span&gt;.
//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 5;
State.variables.chNash.willpower.current -= 5;
State.variables.chNash.lust.current -= 5;
State.variables.chNash.energy.current -= 5;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|SE Magic Class Ate Punishes Val]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="189" name="SE Magic Class Tease Claw" tags="" position="3816,449" size="100,100">$customRoomIntro
You step to the side and walk behind the Beastkin. You focus the same way you did when snowflakes took form in your fingertips, and point your hands at her...

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hiss!&quot;//&lt;/span&gt; She jumps and turns back as soon as she feels the freezing attack, but you chase her with your hands just as fast, and your aggression continues.

Claw tries covering herself, but gives up. She then moves her open hands to the front, as if she wanted to stop the ice stream with them... But she keeps taking the hit anyway. Finally, she curves her back, and prepares to jump on you...

&lt;&lt;if $StVars.seMagicClassClawCheck  == true&gt;&gt;[[Continue|SE Magic Class Tease Claw Success]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.seMagicClassClawCheck == false&gt;&gt;[[Continue|SE Magic Class Tease Claw Part Success]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="190" name="SE Magic Class Tease Claw Success" tags="" position="3926,453" size="100,100">$customRoomIntro
Claw pounces on you, and...

&lt;span style=&quot;color:green&quot;&gt;Agility AND perception check: passed.&lt;/span&gt;

You move to the side in time, and she falls headlong to the ground. The sight is so painful that you consider stopping your casting, but she looks at you like she wants to tear you apart with her bare hands and you soon discard the idea.

She has trouble to even get up, and her expression starts giving a hint of pain, but in her sturbbornness she won&#39;t even attempt to ask you to stop.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Do you promise not attacking me back, if I stop this?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I... I...&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Claw has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Claw has grown a bit.&lt;/span&gt;
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower&lt;/span&gt;.
//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
State.variables.chClaw.willpower.current -= 10;
State.variables.chClaw.lust.current -= 10;
State.variables.chClaw.energy.current -= 15;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 100;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 100;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 100;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|SE Magic Class Ate Punishes Val]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="191" name="SE Magic Class Tease Claw Part Success" tags="" position="4035,445" size="100,100">$customRoomIntro
Claw pounces on you, and...

&lt;span style=&quot;color:red&quot;&gt;Agility AND perception check: failed.&lt;/span&gt;

You step to the side, but not fast enough and you fall along with her. After a brief flail, you regain your aim and continue attacking her, without leaving the ground.

The Tiger-girl, however, is right next to you, and with some effort, manages to grab one of your hands. Her nails thrust against your skin and you find a disgusting new form of pain.

...But her other arm won&#39;t move, probably because it&#39;s being directly hit by your other hand&#39;s icestream.

//This... Will only leave us both exhausted.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We should call it a draw...&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Claw has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity with Claw has grown a bit.&lt;/span&gt;
You lost &lt;span style=&quot;color:lightcoral&quot;&gt;10 lust&lt;/span&gt;.
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower&lt;/span&gt;.
//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
State.variables.chPlayerCharacter.lust.current -= 10;
State.variables.chClaw.lust.current -= 10;
State.variables.chClaw.energy.current -= 15;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 100;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 100;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv += 100;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 100;
&lt;&lt;/script&gt;&gt; \
But something else gets your attention before she can reply.

&lt;&lt;link [[Continue|SE Magic Class Ate Punishes Val]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="192" name="SE Magic Class Tease Val" tags="" position="3823,675" size="100,100">$customRoomIntro
You move past Claw, and further to the side, until you&#39;re flanking Valtan. You imitate her pose and gestures, and focus on reigniting the sensations you felt when you casted the snowflakes. You move your arms forward, and...

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hya!&quot;//&lt;/span&gt; the Shapeshifter shouts, just as soon as your magic hits her.

She turns to you and smiles mischievously, and despite being annoyed by your incessant attack, she embraces the ice stream... And it starts deviating right before it hits her. Despite your best efforts, it just won&#39;t hit her.

She moves closer...

[[Continue|SE Magic Class Tease Val Continue]]</tw-passagedata><tw-passagedata pid="193" name="SE Magic Class Tease Val Continue" tags="" position="3936,675" size="100,100">$customRoomIntro
But she stops dry, and an instant later, she falls to the ground. Behind her, Maaterasu is pointing at her - and small electric threads fly from her fingers straight to Valtan.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;No, no! I&#39;m -ggghg- sorghrry!&quot;//&lt;/span&gt;

She is now fallen on the grass in a fairly miserable position, suffering from sporadic spams.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That will be it for now. You can stop, Maaterasu.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;She started it.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I know, and she has learned her lesson already.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown a bit.&lt;/span&gt;
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;5 willpower&lt;/span&gt;.

Maaterasu&#39;s views have grown more favorable to cooperation.
//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 5;
State.variables.chMir.lust.current -= 5;
State.variables.chMir.energy.current -= 5;
State.variables.chVal.willpower.current -= 5;
State.variables.chVal.lust.current -= 15;
State.variables.chVal.energy.current -= 15;
State.variables.chAte.willpower.current -= 10;
State.variables.chAte.lust.current -= 10;
State.variables.chAte.energy.current -= 10;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 100;
State.variables.chVal.relations.chAte.submission.stv += 100;
State.variables.chAte.relations.chVal.enmity.stv += 150;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|SE Magic Class Aiishen Explanation]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
addPointsToDrive(gC(&quot;chAte&quot;).dCooperation,100);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="194" name="SE Magic Class Tease Mir" tags="" position="3813,559" size="100,100">$customRoomIntro
You step to the side, behind Nash and beyond, until you&#39;re close to Padmiri and out of anyone&#39;s sight. You keep in your mind the sight of Val casting ice from afar, and the cold feeling of snowflakes taking form in your fingertips. You focus your gaze on Padmiri, extend your hands towards her, and...

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Ayee!&quot;//&lt;/span&gt; She&#39;s startled. The Leirien turns back and finds you. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;You too!? Seriously!&quot;//&lt;/span&gt;

Padmiri puts her hands in front of her, and tears the ice stream apart with them. You have trouble to understand what&#39;s just happened, but your confusion doesn&#39;t make her reaction any slower.

[[Continue|SE Magic Class Tease Mir Continue]]</tw-passagedata><tw-passagedata pid="195" name="SE Magic Class Tease Mir Continue" tags="" position="3931,565" size="100,100">$customRoomIntro
With astounding ease, the Leirien has broken your attack and is now casting cold against you. While she moves closer and closer, you try to imitate what she did earlier - to no avail. Your own hands are now freezing cold and you can simply not focus your mind on anything else.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I don&#39;t want to do this, but...&quot;//&lt;/span&gt;

//She&#39;s right in front of me!//

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;If you leave me no choice...&quot;//&lt;/span&gt;

She takes one of her own vines and starts tying your hands and fingers.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I trust you&#39;ll be good for the rest of the lesson.&quot;//&lt;/span&gt; She gives you a clearly forced smile, which does nothing to appease your blood rushing upon feeling helpless.

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has grown a bit.&lt;/span&gt;
You lost &lt;span style=&quot;color:lightcoral&quot;&gt;10 lust&lt;/span&gt;.
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower&lt;/span&gt;.
You lost &lt;span style=&quot;color:limegreen&quot;&gt;10 energy&lt;/span&gt;.
//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
State.variables.chPlayerCharacter.lust.current -= 10;
State.variables.chPlayerCharacter.energy.current -= 10;
State.variables.chMir.willpower.current -= 5;
State.variables.chMir.lust.current -= 5;
State.variables.chMir.energy.current -= 5;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|SE Magic Class Ate Punishes Val]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="196" name="SE Magic Class Tease Ate" tags="" position="4036,565" size="100,100">$customRoomIntro
On a foul whim, you have the insensitive idea of joining Val in her aggression.

You set your eyes on the covering Maaterasu, move your hands forwards, and start reliving the sensations you felt when you casted the snowflakes. You take a look at Valtan one last time, picture yourself doing the same, and feel the energy flowing through your arms.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Nnh! Brr...&quot;//&lt;/span&gt; Maaterasu, attacked by both sides, takes far to long to think about her next move. She finally decides herself, and extends each of her arms towards the Shapeshifter and you. A few strange lightning effects take place around her, and your attack vanishes.

A bit incredulous, you look at your own hands, and you confirm that you&#39;re no longer casting magic. When you position yourself to attack again, you find Valtan&#39;s cold stream flowing directly against you.

[[Continue|SE Magic Class Tease Ate Continue]]</tw-passagedata><tw-passagedata pid="197" name="SE Magic Class Ate Punishes Val" tags="" position="4151,565" size="100,100">$customRoomIntro
&lt;span @style=$chVal.colorStyleKey&gt;//&quot;No, no! I&#39;m -ggghg- sorghrry!&quot;//&lt;/span&gt;

Heads from all directions are turned around towards Valtan. She is on the grass in a fairly miserable position, suffering from sporadic spams. In front of her, Maaterasu has one hand extended forwards. Looking closely, you notice that she&#39;s shooting small electric threads to the Shapeshifter.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That will be it for now. You can stop, Maaterasu.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;She started it.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I know, and she has learned her lesson already.&quot;//&lt;/span&gt;

//Maaterasu&#39;s views have grown more favorable to domination.//

&lt;&lt;script&gt;&gt;
State.variables.chMir.lust.current -= 5;
State.variables.chMir.energy.current -= 5;
State.variables.chVal.willpower.current -= 5;
State.variables.chVal.lust.current -= 10;
State.variables.chVal.energy.current -= 10;
State.variables.chAte.willpower.current -= 10;
State.variables.chAte.lust.current -= 10;
State.variables.chAte.energy.current -= 10;
State.variables.chVal.relations.chAte.submission.stv += 100;
State.variables.chAte.relations.chVal.enmity.stv += 150;
				addPointsToDrive(gC(&quot;chAte&quot;).dDomination,100);
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Magic Class Aiishen Explanation]]</tw-passagedata><tw-passagedata pid="198" name="SE Magic Class Aiishen Explanation" tags="" position="4151,675" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;
State.variables.StVars.temp = charactersLearnSceneActions([&quot;chPlayerCharacter&quot;],[&quot;embers&quot;,&quot;freezeFeet&quot;,&quot;sparkingRubbing&quot;]); /*
charactersLearnSceneActions(getCandidatesKeysArray(),[&quot;embers&quot;,&quot;freezeFeet&quot;,&quot;sparkingRubbing&quot;]); */
&lt;&lt;/script&gt;&gt; \
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Perhaps you didn&#39;t know this yet, but the Aiishen are beings particularly connected to aether. It could even said that they&#39;re only partially in the physical world.&quot;//&lt;/span&gt;

Maaterasu stands serious, looking at Valtan without paying attention to the purple Shapeshifter.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Among other things, this means that physical interactions that involve them will be weaker: they aren&#39;t fit for physical labor and they barely suffer physical damage, but on the other hand, everything related to aether will be significantly stronger. Just as she suffered Valtan&#39;s offense far more than anyone else would have, her magic had a stronger effect on Valtan.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I...&quot;//&lt;/span&gt; she gasps, recovering her breath. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;I can attest to that.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Is that related to why she had to come to the Temple before the rest of us?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Precisely, that was perceptive of you. The Aiishen predicted the sky&#39;s whims would agitate the flow of aether during the last few days, so they had to bring her earlier. Think of it as if they were avoiding a storm.&quot;//&lt;/span&gt;

Drishtya pauses for a second.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;But I don&#39;t want to interrupt you. Continue practicing for a while, it&#39;s almost time for you to start your daily routine.&quot;//&lt;/span&gt;

//You gained 100 intelligence experience.//
$StVars.temp
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.intelligence.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="199" name="SE Magic Class Tease Ate Continue" tags="" position="4039,671" size="100,100">$customRoomIntro
And it falls upon your face like a bucket full of river water during the winter. Your lungs tighten in pain and your muscles start trembling, the only thing in your mind is the frozen air envolving you whole.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;No, no! I&#39;m -ggghg- sorghrry!&quot;//&lt;/span&gt; Valtan falls to the ground. She is on the grass in a fairly miserable position, suffering from sporadic spams. In front of her, Maaterasu has one hand extended forwards. Making an effort to understand what&#39;s happening, you notice that she&#39;s shooting small electric threads to the Shapeshifter.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That will be it for now. You can stop, Maaterasu.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;They started it.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I know, and they have learned their lesson already.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Maaterasu has grown a bit.&lt;/span&gt;
You lost &lt;span style=&quot;color:lightcoral&quot;&gt;10 lust&lt;/span&gt;.
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;5 willpower&lt;/span&gt;.
You lost &lt;span style=&quot;color:limegreen&quot;&gt;10 energy&lt;/span&gt;.

Maaterasu&#39;s views have grown more favorable to domination.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.lust.current -= 10;
State.variables.chPlayerCharacter.willpower.current -= 5;
State.variables.chPlayerCharacter.energy.current -= 10;
State.variables.chMir.lust.current -= 5;
State.variables.chMir.energy.current -= 5;
State.variables.chVal.willpower.current -= 5;
State.variables.chVal.lust.current -= 10;
State.variables.chVal.energy.current -= 10;
State.variables.chAte.willpower.current -= 10;
State.variables.chAte.lust.current -= 10;
State.variables.chAte.energy.current -= 10;
State.variables.chPlayerCharacter.relations.chAte.submission.stv += 100;
State.variables.chVal.relations.chAte.submission.stv += 100;
State.variables.chAte.relations.chVal.enmity.stv += 150;
State.variables.chAte.relations.chPlayerCharacter.enmity.stv += 100;
				addPointsToDrive(gC(&quot;chAte&quot;).dDomination,150);
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|SE Magic Class Aiishen Explanation]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="200" name="SE Stretching Help II Nash Meets Claw" tags="" position="4296,225" size="100,100">$customRoomIntro
A fresh breeze bathes your face as soon as your leave the Temple, and you make sure to savor the moment - but it is interrupted by a distant voice.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Good morning! Would you like to...&quot;//&lt;/span&gt;

It is Nash, talking to Claw.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I told you no the other day, and I&#39;m telling you no today as well. Save me the trouble to spell my answer the next time.&quot;//&lt;/span&gt;

And just like that, the Beastkin leaves.

&lt;&lt;if $StVars.seStHeIINashInvites is false&gt;&gt;[[Continue|SE SH II NodeA Nash Enemy]]
&lt;&lt;elseif $StVars.StretchingHelpResult is &quot;unfinished&quot;&gt;&gt;[[Continue|SE SH II NodeB Didnt Stretch]]
&lt;&lt;else&gt;&gt;[[Continue|SE SH II Did Stretch]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="201" name="SE SH II NodeA Nash Enemy" tags="" position="4408,223" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hello, Nashillbyir. What happened?&quot;//&lt;/span&gt;

The Ashwalker&#39;s face showed disapointment, but it turns into anger as soon as she meets you.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Well, wouldn&#39;t YOU like to know?&quot;//&lt;/span&gt;, she exhales annoyed, moments before she leaving. Her abrupt response shocks you.

//I guess it&#39;s something she doesn&#39;t want to discuss with me?//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="202" name="SE SH II NodeB Didnt Stretch" tags="" position="4518,222" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hello, Nash. What happened?&quot;//&lt;/span&gt;

The Ashwalker&#39;s face turns from disappointment into a faint hint of sadness when she sees you.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hello, $chPlayerCharacter.name. It&#39;s nothing...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Come on, you can&#39;t greet Claw so happily and expect me to believe nothing&#39;s wrong with you.&quot;//&lt;/span&gt; She suppresses a chuckle, but looks at you like if you had said something a bit too mean.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I just wanted to train with her, that&#39;s all.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hmm.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Would you like to stretch with me this time?&quot;//&lt;/span&gt;

[[Accept the offer|SE SH II Accept New Stretch]]
[[Reject the offer|SE SH II Reject Stretch]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="203" name="SE SH II Did Stretch" tags="" position="4630,223" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hello, Nash. What happened?&quot;//&lt;/span&gt;

The Ashwalker&#39;s face turns from disappointment into a faint hint of sadness when she sees you.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hello, $chPlayerCharacter.name. It&#39;s nothing...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Come on, you can&#39;t greet Claw so happily and expect me to believe nothing&#39;s wrong with you.&quot;//&lt;/span&gt; She suppresses a chuckle, but looks at you like if you had said something a bit too mean.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Well, besides me, she&#39;s the only Candidate who seems to have had rigorous physical training, so... I wanted to train with her today, perhaps learn something new.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hmm. That&#39;s going to be hard, given her attitude.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You tell me... Say, would you like to stretch with me again?&quot;//&lt;/span&gt;

[[Accept the offer|SE SH II Accept New Stretch]]
[[Reject the offer|SE SH II Reject Stretch]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="204" name="SE SH II Reject Stretch" tags="" position="4300,340" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Thanks for the offer, but I want to take it easy today.&quot;//&lt;/span&gt;

Nash raises an eyebrow. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Um. Okay. Take care.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Take care you too.&quot;//&lt;/span&gt;

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="205" name="SE SH II Accept New Stretch" tags="" position="4408,340" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sure! What will we be doing today?&quot;//&lt;/span&gt;

Nash&#39;s face recovers some color. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let&#39;s sit down.&quot;//&lt;/span&gt;

Following her instructions, you sit on the ground facing each other.

[[Continue|SE SH II Stage 1]]</tw-passagedata><tw-passagedata pid="206" name="SE SH II Stage 1" tags="" position="4520,342" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Next we&#39;ll open our legs and get our soles in touch.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Mine in contact with yours...?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Precisely.&quot;//&lt;/span&gt;

Having your whole body exposed in front of her makes you fairly self conscious, even if she has the same posture. She adjusts her position and you feel your muscles get tense to keep in touch with her.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Now give me your hands.&quot;//&lt;/span&gt;

You reach out to her, which makes you heavily lean forwards.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Good, now I&#39;ll pull back and you&#39;ll feel your back, arms and legs making an effort. Do not slip out!&quot;//&lt;/span&gt;

//She&#39;s going to... Ah?//

Perhaps too true to her words, you feel as if your muscles were fighting to disassemble your body.

//Do not let her know you&#39;re in pain! You can do this, you can...!//

Despite your best efforts, your face is telling enough.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Am I overdoing it? Wait, I&#39;ll ease it for you...&quot;//&lt;/span&gt;

You breathe in relief when you feel her pull gets less intense.

&lt;&lt;if $StVars.StretchingHelpGroped is &quot;false&quot;&gt;&gt;[[Continue|SE SH II Stage 2 NodeA Friendly]]
&lt;&lt;else&gt;&gt;[[Continue|SE SH II Stage 2 NodeB Flirty]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="207" name="SE SH II Stage 2 NodeA Friendly" tags="" position="4300,457" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let&#39;s try something easier...&quot;//&lt;/span&gt; she says once you&#39;re done.

//Yes, something easier next.//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Lie on your back.&quot;//&lt;/span&gt;

Once you&#39;re on the ground, she kneels by your side.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;ll be moving your legs to different positions. It may feel uncomfortable, but tell me if it hurts you.&quot;//&lt;/span&gt;

She places both hands on your left knee, and forces it in different directions. This exercise is gentler, and you notice the sunlight reflected on her face, and the morning sun bathing your cold away.

&lt;&lt;if $StVars.StretchingHelpResult is &quot;sexual&quot;&gt;&gt;[[Continue|SE SH II Stage 3 NodeB Sexual]]
&lt;&lt;else&gt;&gt;[[Continue|SE SH II Stage 3 NodeA Friendly]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="208" name="SE SH II Stage 2 NodeB Flirty" tags="" position="4515,453" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let&#39;s try something easier...&quot;//&lt;/span&gt; she says once you&#39;re done.

//Yes, something easier next.//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Lie on your back.&quot;//&lt;/span&gt;

Once you&#39;re on the ground, she kneels by your side.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;ll be moving your legs to different positions.&quot;//&lt;/span&gt;

She places a hand on your left knee, and another one next to your waist. The Ashwalker forces your leg to move in different directions, and when she wants to push it a little harder... &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Is that really necessary?&quot;//&lt;/span&gt; She takes hold of your ass and presses it forward.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;No.&quot;//&lt;/span&gt; She smiles at you brightly, making no effort to amend her behavior.

//&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has slightly grown.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 100;&lt;&lt;/script&gt;&gt;
&lt;&lt;if $StVars.StretchingHelpResult is &quot;sexual&quot;&gt;&gt;[[Continue|SE SH II Stage 3 NodeB Sexual]]
&lt;&lt;else&gt;&gt;[[Continue|SE SH II Stage 3 NodeA Friendly]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="209" name="SE SH II Stage 3 NodeA Friendly" tags="" position="4406,457" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And now, for our last exercise...&quot;//&lt;/span&gt; she moves her head around, looking for something. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let&#39;s move to the big guy.&quot;//&lt;/span&gt;

By &quot;the big guy&quot; she means a dummy particularly corpulent, big enough to hide a person, or a few, behind it.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Extend your arms and press your hands against him.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;When did it tell you it is a he?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh, just on my second day here. He&#39;s a big talker, once you melt his shyness away.&quot;//&lt;/span&gt;

You don&#39;t discuss it any further and put yourself against the dummy.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;m going to move your leg as high I can, right above your head if possible.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Be gentle, will you?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;When have I not been gentle?&quot;//&lt;/span&gt;

[[Continue|SE SH II End NodeA Friendly]]</tw-passagedata><tw-passagedata pid="210" name="SE SH II End NodeA Friendly" tags="" position="4305,673" size="100,100">$customRoomIntro
In the end, your foot didn&#39;t touch your head.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m happy enough to be able to walk after that.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Don&#39;t be so dramatic! If you knew the things people do in my tribe...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m happy I wasn&#39;t born there too!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh, jeez. At least tell me you don&#39;t regret doing this.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Fine, I don&#39;t regret it.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Great! Then we agree to train together again.&quot;//&lt;/span&gt;

And right before you can reply, she runs away.

//...Time to start the day, then.//

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;10 energy&lt;/span&gt;.
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown a bit.&lt;/span&gt;
You gained 100 agility experience.
//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 10;
State.variables.chNash.energy.current -= 10;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 100;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 100;
State.variables.chPlayerCharacter.agility.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="211" name="SE SH II Stage 3 NodeB Sexual" tags="" position="4455,565" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And now, for our last exercise...&quot;//&lt;/span&gt; she moves her head around, looking for something. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let&#39;s move to the big guy.&quot;//&lt;/span&gt;

By &quot;the big guy&quot; she means a dummy particularly corpulent, big enough to hide a person, or a few, behind it.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Extend your arms and press your hands against him.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;When did it tell you it is a he?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh, just on my second day here. He&#39;s a big talker, once you melt his shyness away.&quot;//&lt;/span&gt;

You don&#39;t discuss it any further and put yourself against the dummy.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;m going to move your leg as high I can, right above your head if possible.&quot;//&lt;/span&gt; She takes your upper leg and your waist in her hands, and pulls your leg upwards.

You focus on your breathing and contain the pain, which feels tame when compared with the first exercise, and let Nash do the work.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Say...&quot;//&lt;/span&gt;

//Is there something off with her voice?//

[[Continue|SE SH II Stage 3 NodeB Proposed Sex]]</tw-passagedata><tw-passagedata pid="212" name="SE SH II End NodeB Rejected Sex" tags="" position="4420,673" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Perhaps some other time.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Not in the mood? Let&#39;s finish the exercise then.&quot;//&lt;/span&gt;

Nash takes well your rejection and continues helping you with the stretching for a couple of minutes.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You know, I&#39;m glad you&#39;ve taken an interest in proper physical training.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I just hope you don&#39;t break me before I see some results.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...What tells you I wasn&#39;t planning on breaking you anyway?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Huh.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hahaha! At least now you&#39;ll be able to watch your back.&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;10 energy&lt;/span&gt;.
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown.&lt;/span&gt;
You gained 100 agility experience.
//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 10;
State.variables.chNash.energy.current -= 10;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 200;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 200;
State.variables.chPlayerCharacter.agility.experience += 100;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="213" name="SE SH II End NodeC Had Sex" tags="" position="4531,673" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Here... A goodbye kiss.&quot;//&lt;/span&gt;

Before she lets you go, Nash looks for your lips and meets them with hers.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Perhaps someone saw us, after all.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And... isn&#39;t that a bonus?&quot;//&lt;/span&gt; She smiles mischievously. You roll your eyes.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You know, I&#39;m glad you&#39;ve taken an interest in proper physical training.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I just hope you don&#39;t break me before I see some results.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...What tells you I wasn&#39;t planning on breaking you anyway?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Huh.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Haha! At least now you&#39;ll be able to watch your back.&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;10 energy&lt;/span&gt;.
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Nashillbyir has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has grown.&lt;/span&gt;
You gained 100 agility experience.
//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 10;
State.variables.chNash.energy.current -= 10;
State.variables.chPlayerCharacter.relations.chNash.romance.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.romance.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.agility.experience += 100;
gC(&quot;chNash&quot;).socialAi.covetTs.push(&quot;chPlayerCharacter&quot;);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="214" name="SE SH II Stage 3 NodeB Proposed Sex" tags="" position="4561,567" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;We have plenty of time...&quot;//&lt;/span&gt;

Her hand on your waist massages you.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I have great &#39;access&#39; to you.&quot;//&lt;/span&gt;

It moves down. 

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And no one would see us here if we&#39;re fast. Probably. What do you say?&quot;//&lt;/span&gt;

&lt;&lt;link [[Accept sex|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
// Initialize Scene settings
stHpIIinit();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;if $StVars.seStHeIIMayRejectSex is true&gt;&gt;[[Reject her|SE SH II End NodeB Rejected Sex]] (Costs &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.seStHeIIwillpowerHit willpower&lt;/span&gt;)
&lt;&lt;else&gt;&gt; &lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You need &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.seStHeIIwillpowerHit willpower&lt;/span&gt;.
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="215" name="GoddessHerald Avatar Selection" tags="" position="3,142" size="100,100">&lt;&lt;script&gt;&gt;
if ( State.variables.chPlayerCharacter.name == &quot;&quot; ) {
State.variables.chPlayerCharacter.name = &quot;Nameless&quot;;
}
State.variables.chPlayerCharacter.setColors(&quot;Red&quot;,&quot;Crimson&quot;);
State.variables.chPlayerCharacter.names = [ State.variables.chPlayerCharacter.name , State.variables.chPlayerCharacter.name , State.variables.chPlayerCharacter.name , &quot;the young human&quot; ];
&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Now... Remember your face. Focus on it.&quot;//&lt;/span&gt;

&lt;&lt;set $StVars.temp2 to 0&gt;&gt; \
&lt;label&gt;&lt;&lt;radiobutton &quot;$StVars.temp2&quot; &quot;option1&quot; checked&gt;&gt; [img[img/portraits/mc1-full.png]] &lt;/label&gt;
&lt;label&gt;&lt;&lt;radiobutton &quot;$StVars.temp2&quot; &quot;option2&quot;&gt;&gt; [img[img/portraits/mc2-full.png]] &lt;/label&gt;
&lt;label&gt;&lt;&lt;radiobutton &quot;$StVars.temp2&quot; &quot;option3&quot;&gt;&gt; [img[img/portraits/mc3-full.png]] &lt;/label&gt;
&lt;label&gt;&lt;&lt;radiobutton &quot;$StVars.temp2&quot; &quot;optionCustom&quot;&gt;&gt; [img[img/portraits/custom-full.png]] &lt;/label&gt;

&lt;&lt;link [[Continue|GoddessHerald 2]]&gt;&gt;&lt;&lt;script&gt;&gt;
assignPcPortrait();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="216" name="SE Flirting Advice Start" tags="" position="3813,812" size="100,100">$customRoomIntro
It&#39;s a quiet day in the dining hall. Breakfast came a little later than usual, and everyone started eating straight away. The silence is broken with an unlikely question.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;How do you make someone have sex with you?&quot;//&lt;/span&gt;

The food gets stuck in your throat for a moment. To your relief, you aren&#39;t the only one surprised.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Where did that question come from?&quot;//&lt;/span&gt; Padmiri says after coughing.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Developing sexual skills is one of my duties, and I have noticed you have been having sex, but I haven&#39;t.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And you... want our advice?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Yes.&quot;//&lt;/span&gt; Maaterasu sticks her eyes on Nashillbyir. Nothing is going to save her from answering.

[[Continue|SE Flirting Advice Nash Advice]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="217" name="SE Flirting Advice Nash Advice" tags="" position="3921,812" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Well...&quot;//&lt;/span&gt; She asks others for help, clearly on a loss. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;It sort of... Happens naturally?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;If it just happened naturally, I would have no need to ask.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That makes sense. I... I don&#39;t know, Ate. I&#39;m sorry, but I just woke up and my head isn&#39;t cleared enough for this.&quot;//&lt;/span&gt;

Maaterasu moves her gaze towards Padmiri, the next victim of her inquisitiveness.

[[Continue|SE Flirting Advice Mir Advice]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="218" name="SE Flirting Advice Mir Advice" tags="" position="4030,812" size="100,100">$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You want me to answer?&quot;//&lt;/span&gt; Ate nods. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Oh, my.&quot;//&lt;/span&gt;

The Leirien lowers her gaze, frowning. After a few seconds, she appears to have found her answer and looks back at the Aiishen.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Something important is that the person you want to be intimate with feels comfortable with you.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Comfortable?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes. What I mean is... When you have sex, you&#39;re offering an intimate side of yourself to your partner, and that... Makes you vulnerable, in a way. So you wouldn&#39;t want to feel vulnerable with someone you don&#39;t trust, right? Or with someone you aren&#39;t at ease with.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I think that makes sense.&quot;//&lt;/span&gt;

[[Continue|SE Flirting Advice Val Advice]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="219" name="SE Flirting Advice Val Advice" tags="" position="4136,812" size="100,100">$customRoomIntro
&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Ate, my dear,&quot;//&lt;/span&gt; Valtan intervenes. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;Your partner feeling comfortable is good, of course, but that won&#39;t take you far enough.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;What do you mean?&quot;//&lt;/span&gt; The white haired girl turns her attention.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What you truly need, is your partner to desire you.&quot;//&lt;/span&gt; Her expression turns into that of someone offering a poisoned pie. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;You have to show them the pleasure, put it in front of their eyes, promise it to them... And then take it away.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Why?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Because if there&#39;s something people wants more than pleasure, it&#39;s the pleasure they can&#39;t have. When it&#39;s been in front of their eyes and they didn&#39;t take it, they&#39;ll keep thinking about it. After a while, they will be weak and needy... And that is when you strike.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...I&#39;m not sure I understand everything...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Don&#39;t worry, you will soon enough.&quot;//&lt;/span&gt;

[[Continue|SE Flirting Advice Claw Bs]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="220" name="SE Flirting Advice Claw Bs" tags="" position="4243,814" size="100,100">$customRoomIntro
Claw barely ever makes any gestures that indicate she is paying attention to the conversation, but when Maaterasu is about to ask her, she talks first.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;When I want someone to be my partner, I&#39;ll make it happen.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;How?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You don&#39;t want to do what Claw does. Please don&#39;t worry about it.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

[[Continue|SE Flirting Advice Player Asked]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="221" name="SE Flirting Advice Player Asked" tags="" position="3816,924" size="100,100">$customRoomIntro
&lt;span @style=$chAte.colorStyleKey&gt;//&quot;$chPlayerCharacter.name?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Do you have any advice?&quot;//&lt;/span&gt;

[[Not really|SE Flirting Advice Player Is Lost]]
[[Ate should socialize more|SE Flirting Advice Just Talk More]]
[[She only has to ask you|SE Flirting Advice Just Have To Ask Me]]
&lt;&lt;if $StVars.flirtingAdviceChecks[0] == true&gt;&gt;&lt;span style=&quot;color:green&quot;&gt;Physique AND agility check: passed.&lt;/span&gt; [[Being attractive comes first|SE Flirting Advice Sexy Body]]
&lt;&lt;else&gt;&gt;&lt;span style=&quot;color:red&quot;&gt;Physique AND agility check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.flirtingAdviceChecks[1] == true&gt;&gt;&lt;span style=&quot;color:green&quot;&gt;Empathy check: passed.&lt;/span&gt; [[Each partner is different|SE Flirting Advice Understanding]]
&lt;&lt;else&gt;&gt;&lt;span style=&quot;color:red&quot;&gt;Empathy check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.flirtingAdviceChecks[2] == true&gt;&gt;&lt;span style=&quot;color:green&quot;&gt;Charisma check: passed.&lt;/span&gt; [[Make them fall with sweet words|SE Flirting Advice Sweet Words]]
&lt;&lt;else&gt;&gt;&lt;span style=&quot;color:red&quot;&gt;Charisma check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.flirtingAdviceChecks[3] == true&gt;&gt;&lt;span style=&quot;color:green&quot;&gt;Charisma AND intelligence check: passed.&lt;/span&gt; [[Make sure you&#39;re interesting|SE Flirting Advice Interesting]]
&lt;&lt;else&gt;&gt;&lt;span style=&quot;color:red&quot;&gt;Charisma AND intelligence check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="222" name="SE Flirting Advice Player Is Lost" tags="" position="3925,924" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;To be totally honest, I think I&#39;m as lost as you are.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;But... Have you not gone to bed with anyone?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Well.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What is clear&quot;//&lt;/span&gt;, Padmiri intervenes, saving you, &lt;span @style=$chMir.colorStyleKey&gt;//&quot;is that you should spend more time with the rest of us. You won&#39;t ever have to chance to have intimacy if you avoid contact with people.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes. Precisely. Padmiri just turned my thoughts into words.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...I should work on that then...&quot;//&lt;/span&gt; Maaterasu mumbles.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown a bit.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has grown a bit.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 100;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 100;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE Flirting Advice End]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="223" name="SE Flirting Advice Just Have To Ask Me" tags="" position="4136,922" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You see, Ate,&quot;//&lt;/span&gt; you begin, &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;if you want to have sex with me, you only need to ask.&quot;//&lt;/span&gt;

//Did I just say that?//

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Is it that simple?&quot;//&lt;/span&gt;

//I did, and everyone is looking at me.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It is a special offer of mine, just for you.&quot;//&lt;/span&gt; Somehow, you manage to maintain your smile instead of hiding under the table.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Look at $chPlayerCharacter.name, she&#39;s just as bold as she wants to be.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;m speechless, really.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;That sounds easy. Thank you.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Maaterasu has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Maaterasu has grown.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.sexualTension.stv += 250;
State.variables.chAte.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.relations.chAte.romance.stv += 250;
State.variables.chAte.relations.chPlayerCharacter.romance.stv += 250;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE Flirting Advice End]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="224" name="SE Flirting Advice Sexy Body" tags="" position="3820,1035" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;If you want people to have sex with you, they must find you attractive, and looking after your own figure is fundamental in that terrain.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Expand on that.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We find people who seem to be healthy attractive, so if you want to be attractive, you should have a healthy lifestyle. Make a lot of exercise and don&#39;t be a glutton when you eat.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I can give you further advice there!&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Hmm.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;My tribe&#39;s current elder symbolizes everything you shouldn&#39;t do: he sits the whole day drinking wine and ordering others around, then he gossips about others&#39; sex life because his doesn&#39;t exist.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 250;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 250;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE Flirting Advice End]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="225" name="SE Flirting Advice Understanding" tags="" position="3926,1037" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;ve had some good answers, but the first thing you need to understand is that different people want different things in a sex partner.&quot;//&lt;/span&gt;

Ate looks at you with full attention.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;For instance, you have to be very careful to make some people feel safe with you, like Padmiri said, but there are others who feel very confident and you have to focus on catching their interest, instead. There&#39;s also people who simply don&#39;t want sex, and people who have their own reasons to not to have sex with any person in particular, and that&#39;s something you have to accept and move on.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;How can I know what a given person wants?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That depends on the person. You have to figure them out. Experience will help you a lot.&quot;//&lt;/span&gt;

She seems to meditate on your words.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 250;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 250;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE Flirting Advice End]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="226" name="SE Flirting Advice Sweet Words" tags="" position="4031,1035" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;If you want to take someone to bed with you, you should start by making them feel desired. Compliment them on things you like about them, specially if you think they&#39;ll like you liking them.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Let me try. $chPlayerCharacter.name, you are being helpful right now.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...No, not like that.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Ate clearly needs an example here. Look at me, little rose.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You smell specially good today, so good... That if you aren&#39;t careful, I may want to plant you in my own garden.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What did I do to get dragged into this?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You have to... Make it feel special, memorable.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Hmm.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 250;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 250;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE Flirting Advice End]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="227" name="SE Flirting Advice Just Talk More" tags="" position="4031,922" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Tell me, Ate. Do you spend much time with us?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I do. We eat together, and we train together.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;When we eat you barely ever talk, and we can&#39;t really say we train together. We just share the same space.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;But that is sp...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What I mean is that you may be around, but you don&#39;t interact much with us. You may as well be part of the scenery. You need to start by engaging us in conversation, or sex just won&#39;t happen.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...I understand.&quot;//&lt;/span&gt;

She seems to meditate on your words.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 250;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 250;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE Flirting Advice End]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="228" name="SE Flirting Advice Interesting" tags="" position="4138,1034" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You need to show people you are interesting, that will help you make them attracted to you.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;How do I do that?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;For example... Find something that you and the person you&#39;re talking to both like, or something that you&#39;re talented at or know a lot about, and bring it up. That will make the other person think you have something to offer them, and they will want your company.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Something I enjoy... such as music?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That could work. People like me who have almost never seen magic could also be interested in learning how it works.&quot;//&lt;/span&gt;

She seems to meditate on your words.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 250;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 250;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE Flirting Advice End]]
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="229" name="SE Flirting Advice End" tags="" position="4246,978" size="100,100">$customRoomIntro
The conversation continues for a short while, Maaterasu being exhaustive and making sure she asks about everything she doesn&#39;t fully grasp, which seems to be a lot. In the end, she thanks you all for your effort.

//You gained 50 charisma experience.//
//You gained 50 empathy experience.//

//Maaterasu seems to be more open to socializing now.
Maaterasu&#39;s views have grown more favorable to pleasure, love and cooperation.//
&lt;&lt;script&gt;&gt;
State.variables.chMir.relations.chAte.friendship.stv += 250;
State.variables.chAte.relations.chMir.friendship.stv += 250;
State.variables.chVal.relations.chAte.friendship.stv += 250;
State.variables.chAte.relations.chVal.friendship.stv += 250;
for ( var charKey of getCandidatesKeysArray() ) {
gC(charKey).empathy.experience += 50;
gC(charKey).charisma.experience += 50;
}
gC(&quot;chAte&quot;).empathy.experience += 50;
gC(&quot;chAte&quot;).charisma.experience += 50;
gC(&quot;chAte&quot;).baseMood.bored = 0;
gC(&quot;chAte&quot;).mood.bored = 0;
addPointsToDrive(gC(&quot;chAte&quot;).dPleasure,100);
addPointsToDrive(gC(&quot;chAte&quot;).dLove,100);
addPointsToDrive(gC(&quot;chAte&quot;).dCooperation,100);
&lt;&lt;/script&gt;&gt; \

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="230" name="SE Drishtya Tutorship I Start" tags="" position="4791,227" size="100,100">$customRoomIntro
Nashillbyir, Maaterasu, Valtan and Padmiri sit next to you in the rugged ground of the mountain. Another day of training has finished, and you&#39;re sharing a few minutes together before you retire to your chambers.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I love how the night looks in the Temple. In the forest, you can&#39;t get such a clear view of the stars.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;In my tribe you don&#39;t even have a view. Our sky is the caverns themselves.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;How can you even see if the sunlight doesn&#39;t reach the caverns?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;My tribe&#39;s cavern is full of shining crystals. More precisely, they emit back the light they save for long periods, so we have to...&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Look.&quot;//&lt;/span&gt; Ate interrupts the conversation, pointing upwards. A small red light has appeared in the sky, moving slowly but decidedly.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What is that?&quot;//&lt;/span&gt; Mir asks, astonished.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s a shooting star. They fly the sky until they decide it&#39;s time to settle down.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Perhaps this one decides to settle down here.&quot;//&lt;/span&gt;

As if it had heard your words, the shooting star slowly changes its trajectory.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;How did you do that?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What? I... I didn&#39;t-&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;It&#39;s falling into the mountain.&quot;//&lt;/span&gt;

You turn your eyes back to the falling star and discover Maaterasu is right - it&#39;s actually fallen in the same mountain range the Temple is built in. It must be about two days of travel away from here.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Good evening.&quot;//&lt;/span&gt; Drishtya intervenes, suddenly appearing out of nowhere.

[[Continue|SE Drishtya Tutorship I Follow Her]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="231" name="SE Drishtya Tutorship I Follow Her" tags="" position="4900,225" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Is this about the star?&quot;//&lt;/span&gt; Nash inquires.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;The one that just fell? No. I&#39;m talking to each of you one by one to make sure everything is in order. I just talked to Claw, and now it&#39;s $chPlayerCharacter.name&#39;s turn.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Oh, she&#39;s definitely questioning her about the star, then.&quot;//&lt;/span&gt; Valtan interrupts with a playful expression.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Please accompany me.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Oh, yes.&quot;//&lt;/span&gt; You quickly get up and follow Drishtya down the mountain stairs, back into the Temple.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;...What were they talking about?&quot;//&lt;/span&gt; You&#39;re surprised when you notice Drishtya is arching an eyebrow, genuinely confused.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I suggested earlier that the shooting star we saw could fall around here, and right after that it changed its course and fell into the mountains.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I see. It makes sense it surprised you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;re very... Calm about it.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It&#39;s not uncommon for shooting stars to change their course when they&#39;re close to the Temple.&quot;//&lt;/span&gt; The Priestess Regent closes her eyes, and you believe you&#39;ve seen a smile beginning to form in her lips. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Of course, they don&#39;t need to know just yet, if you want them to believe that stars listen to you.&quot;//&lt;/span&gt;

//...Who&#39;s this person and what did she do with Drishtya?//

[[Continue|SE Drishtya Tutorship I Life As Candidate]]
&lt;&lt;script&gt;&gt;
setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;starsTower&quot;);
&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="232" name="SE Drishtya Tutorship I Life As Candidate" tags="" position="5006,224" size="100,100">$customRoomIntro
The purple Shapeshifter takes you to the Stars Tower. While it&#39;s often used by Taototh in his work, right now it&#39;s empty.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;How are you feeling?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Exhausted, to be honest.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;And how have you been feeling since you came to the Temple?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It&#39;s... It&#39;s been a lot of changes in my life...&quot;//&lt;/span&gt;

[[I don&#39;t think I can handle it|SE Drishtya Tutorship I Cannot Handle It]]
[[I&#39;m having fun|SE Drishtya Tutorship I Having Fun]]
[[I&#39;m learning a lot|SE Drishtya Tutorship I Learning Lots]]
[[I think I&#39;ll enjoy becoming a Priestess|SE Drishtya Tutorship I Liking Priestesshood]]
&lt;&lt;script&gt;&gt;
setPasChars([]);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="233" name="SE Drishtya Tutorship I Cannot Handle It" tags="" position="4746,334" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And I don&#39;t think I can handle it.&quot;//&lt;/span&gt;

You hide your face from Drishtya. After this painful confession, looking at someone else&#39;s eyes only serves to rub salt in your wounds.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I understand. I understand better than you&#39;d believe.&quot;//&lt;/span&gt;

You feel the Priestess&#39; hand rest in your shoulder.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;This life isn&#39;t easy, and it was chosen for you, not by you. This isn&#39;t spoken about outside of the Temple, but many Candidates often face existential doubts, especially shortly after they start their new lives.

You must find strength in the idea of your people cheering for you, and solace in thinking that the Goddess will be watching over you, regardless of your merits and your shortcomings.&quot;//&lt;/span&gt;

A single tear sticks out of your eye, but you clean it immediately.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I... I&#39;m sorry. I&#39;m feeling better now.&quot;//&lt;/span&gt;

When you look at her again, you immediately realize that she won&#39;t believe your lie. When you look at yourself reflected in her eyes, you realize you won&#39;t believe it either.

[[Continue|SE Drishtya Tutorship I Opinion On Peers]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.DrishtyaTutorLifeAsCandidate = &quot;CannotHandleIt&quot;;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="234" name="SE Drishtya Tutorship I Having Fun" tags="" position="4853,334" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And I&#39;m enjoying it, to be honest. I was full of doubts earlier, but as the days go by, I feel my doubts melting and away and realizing that I&#39;m... Having fun.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Having fun?&quot;//&lt;/span&gt;

You analyze her expression quietly.

//Have I said anything wrong?//

And she shows a brief smile, right before speaking again.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That&#39;s unexpected, but not unwelcome, as long as you don&#39;t leave your duties unattended.&quot;//&lt;/span&gt;

[[Continue|SE Drishtya Tutorship I Opinion On Peers]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.DrishtyaTutorLifeAsCandidate = &quot;HavingFun&quot;;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="235" name="SE Drishtya Tutorship I Learning Lots" tags="" position="4958,335" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And I&#39;m learning a lot. I feel as if I had spent my whole life trapped in my tribe, and I finally got to know the world as it is.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;And you have yet far more to learn about. I commend your enthusiasm. Let&#39;s hope it lives for long.&quot;//&lt;/span&gt;

[[Continue|SE Drishtya Tutorship I Opinion On Peers]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.DrishtyaTutorLifeAsCandidate = &quot;LearningLots&quot;;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="236" name="SE Drishtya Tutorship I Liking Priestesshood" tags="" position="5063,334" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And I&#39;m growing to like the Temple. I had my doubts earlier, but I think I&#39;m beginning to see myself as a Priestess and enjoying the role.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I commend your enthusiasm, and I hope it lives for long, but do not think this is what life as a Priestess is like. Priestesshood is, before anything else, a service for the tribes.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I understand.&quot;//&lt;/span&gt;

[[Continue|SE Drishtya Tutorship I Opinion On Peers]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.DrishtyaTutorLifeAsCandidate = &quot;LikePriestesshood&quot;;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="237" name="SE Drishtya Tutorship I Opinion On Peers" tags="" position="4715,442" size="100,100">$customRoomIntro
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;As for the other Candidates, what do you think about them?&quot;//&lt;/span&gt;

[[I like them all|SE Drishtya Tutorship I Like Them All]]
[[I think they&#39;re all good-hearted|SE Drishtya Tutorship I Theyre Good Hearted]]
[[I&#39;m afraid of them|SE Drishtya Tutorship I Theyre Dangerous]]
[[They have some growing up to do|SE Drishtya Tutorship I They Need GrowingUp]]</tw-passagedata><tw-passagedata pid="238" name="SE Drishtya Tutorship I Like Them All" tags="" position="4821,444" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think I like them, in their diversity.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Can you elaborate?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Perhaps I feel more affinity towards one or some of them, but the diversity of perspectives and opinions is a value on its own. I think it will help us all to grow.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That&#39;s a great answer.&quot;//&lt;/span&gt; Drishtya doesn&#39;t hide her satisfaction. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;The tribes and its peoples... Are considerably different from one another, in several fronts. Given that the Goddess has wished it we all share the Valley, it&#39;s for the best that we aim to cooperate and learn from one another. This has almost always been the position of the Temple, as it&#39;s the most useful one to fulfill our duty of maintaining peace and order. I&#39;m glad to see you understand that this early.&quot;//&lt;/span&gt;

[[Continue|SE Drishtya Tutorship I Any Other Questions]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.DrishtyaTutorThoughtsOnPeers = &quot;LikedInDiversity&quot;;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="239" name="SE Drishtya Tutorship I Theyre Good Hearted" tags="" position="4926,442" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I believe they&#39;re good people. I&#39;m glad they&#39;re my peers.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;You think so? Why?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Padmiri is an obvious one, she&#39;s been trying her best for us to get along right from the start. Nashillbyir is happy and optimistic, and it looks like she has no trouble sharing what she knows.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;What about Valtan?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She may be obnoxious at times. Perhaps even malicious. But even if she&#39;s somewhat selfish, she&#39;s also capable of making generous decisions.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Maaterasu?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I don&#39;t understand what&#39;s going on her head at times... But she hasn&#39;t caused trouble so far.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;And Claw?&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.DrishtyaTutorEmpathyCheck == true&gt;&gt; \
//This is a tough one.//

&lt;span style=&quot;color:green&quot;&gt;Empathy check: passed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Perhaps I&#39;m wrong with her,&quot;//&lt;/span&gt; you start, &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;but no one becomes that aggressive and mean for no reason. My guess is that something in her life made her angry and resentful, and she&#39;s taken a very wary attitude to protect herself.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That would still not make her a good person, on its own.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s true. &quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;And?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Nothing. That&#39;s it. That&#39;s my read on her, right now.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I see.&quot;//&lt;/span&gt;
&lt;&lt;else&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I... I don&#39;t know. Perhaps she&#39;s the exception?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Hmm.&quot;//&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \

[[Continue|SE Drishtya Tutorship I Any Other Questions]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.DrishtyaTutorThoughtsOnPeers = &quot;TheyreAllGood&quot;;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="240" name="SE Drishtya Tutorship I Theyre Dangerous" tags="" position="5033,442" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I don&#39;t feel completely safe with them.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Is that so? Why?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Claw and Valtan are the obvious ones. They have no boundaries and don&#39;t seem to stop anywhere to get what they want.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;What about the others?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;The rest don&#39;t seem to be as aggressive... But it isn&#39;t lost on me that they may also see me as an obstacle to become High Priestess, and they&#39;re stronger than me.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That&#39;s a fair position.&quot;//&lt;/span&gt; She stops for a moment. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;If you can&#39;t defend yourself, you should be thinking about getting allies.&quot;//&lt;/span&gt;

[[Continue|SE Drishtya Tutorship I Any Other Questions]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.DrishtyaTutorThoughtsOnPeers = &quot;TheyreDangerous&quot;;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="241" name="SE Drishtya Tutorship I They Need GrowingUp" tags="" position="5143,440" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think they have some growing up to do.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;How blunt.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But fair.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Everyone has some growing up to do, $chPlayerCharacter.name. Life takes us to ever-changing scenarios and events, and whatever we learned in the past runs the risk of turning obsolete and useless. The only thing that separates the wise woman from the ignorant one is a change of scenery. You, more than anyone, should have noticed that.&quot;//&lt;/span&gt;

//...That hurt.//

[[Continue|SE Drishtya Tutorship I Any Other Questions]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.DrishtyaTutorThoughtsOnPeers = &quot;TheyNeedGrowingUp&quot;;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="242" name="SE Drishtya Tutorship I Any Other Questions" tags="" position="4815,547" size="100,100">$customRoomIntro
&lt;&lt;if $StVars.DrishtyaTutorReachedQuestions == false&gt;&gt; \
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That&#39;s what I wanted to ask you, for now. Perhaps you have some questions? Remember I&#39;m here to offer guidance.&quot;//&lt;/span&gt;
&lt;&lt;else&gt;&gt; \
//Do I have anything else I want to ask?//
&lt;&lt;/if&gt;&gt; \

[[I think I&#39;m behind the rest. Can I catch them up?|SE Drishtya Tutorship I Behind The Rest]]
[[How can I strenghten bonds?|SE Drishtya Tutorship I How Can I Into Friendship]]
[[How can I dominate others?|SE Drishtya Tutorship I How Can I Into Domination]]
[[Can I leave the Temple and go back to my old life?|SE Drishtya Tutorship I How Can I Leave]]

[[That&#39;s all|SE Drishtya Tutorship I Closing Up]]</tw-passagedata><tw-passagedata pid="243" name="SE Drishtya Tutorship I Behind The Rest" tags="" position="4728,655" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think I&#39;m behind the rest.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Yes, I think so too.&quot;//&lt;/span&gt;

//...Well, thanks.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How can I catch up?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That may be difficult, but not impossible.&quot;//&lt;/span&gt; She meditates for a while. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;You need a strategy. You must devise a way in which you can face the rest on equal grounds, and focus your energies in getting there. Perhaps that means specializing in a given area, or becoming a jack of all trades. Another option is focusing on the weaknesses of some of your peers and avoiding confrontations with the rest. You should also consider asking another Candidate to tutor you for a while. That would put you in a subordinate position, but you may learn enough to turn the tables in the future.&quot;//&lt;/span&gt;

[[Continue|SE Drishtya Tutorship I Any Other Questions]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.DrishtyaTutorBehindTheRest = true;
State.variables.StVars.DrishtyaTutorReachedQuestions = true;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="244" name="SE Drishtya Tutorship I How Can I Into Friendship" tags="" position="4836,654" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How can I... Strengthen my bonds with others?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Start by spending time with them. Constant socialization is a fundamental pillar.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And beyond that?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Of course, you may also want to share intimacy with someone you want to get close to, and finding yourselves together during success and failure will also leave a mark in their minds.

You must also make an effort to understand their goals, motivations and values. If these allign together with yours, or at least don&#39;t clash, you&#39;ll have an easier way ahead of you.&quot;//&lt;/span&gt;

[[Continue|SE Drishtya Tutorship I Any Other Questions]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.DrishtyaTutorStrengthenBonds = true;
State.variables.StVars.DrishtyaTutorReachedQuestions = true;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="245" name="SE Drishtya Tutorship I How Can I Into Domination" tags="" position="4940,655" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How can I dominate others?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;A daring question.&quot;//&lt;/span&gt; She looks at you intensely. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;If you wish to dominate others, you must make sure you maintain your own initiative. Be active. Take them to your own ground, on your own rules. And best them.&quot;//&lt;/span&gt;

//That sounds vague.//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Of course, they will have initiative of their own. They may strike back, outpace you and end up winning the battle. You must have a strong willpower if you don&#39;t want to end on the losing side.&quot;//&lt;/span&gt;

[[Continue|SE Drishtya Tutorship I Any Other Questions]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.DrishtyaTutorDominatingOthers = true;
State.variables.StVars.DrishtyaTutorReachedQuestions = true;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="246" name="SE Drishtya Tutorship I How Can I Leave" tags="" position="5043,655" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How can I leave the Temple and go back to my old life?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;...&quot;//&lt;/span&gt;

//Oh, joy, she didn&#39;t like that?//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That&#39;s one of the most complicated questions you could ask. I trust you know that.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Leaving the Temple is straightforward. If you leave the gates and never come back, no one will stop you. Coming back to your old life is an entirely different matter. After you have been sent to the Temple to represent your tribe, renouncing your position will be seen as an humiliation. I can&#39;t recall any Candidate that renounced her position without consequences.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So it&#39;s out of the question.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;At least give this a try. Your training has barely got started, and there may be a million reasons that make you accept this path.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Fine...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;$chPlayerCharacter.name?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Keep your spirits up. Whatever&#39;s troubling you, I&#39;m certain it will get better.&quot;//&lt;/span&gt;

[[Continue|SE Drishtya Tutorship I Any Other Questions]]
&lt;&lt;script&gt;&gt;
State.variables.StVars.DrishtyaTutorLeaveTheTemple = true;
State.variables.StVars.DrishtyaTutorReachedQuestions = true;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="247" name="SE Drishtya Tutorship I Closing Up" tags="" position="4981,549" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think that&#39;s all.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Very well. Rest to your heart&#39;s content, you deserve it.&quot;//&lt;/span&gt;

[[Go to sleep|SE Varyonte Tutorship I Start]]</tw-passagedata><tw-passagedata pid="248" name="SE Varyonte Tutorship I Start" tags="" position="4411,794" size="100,100">When you wake up, you&#39;re quick to leave the bed and advance towards the rooms corridor, despite not being completely ready. As you push the door, you take your hand to your mouth to yawn, and you close yours eyes. When they open, the corridor isn&#39;t there, and neither is the door, or your room.

There&#39;s only darkness and mist.

You turn around in panic, several times, looking for the world that has just vanished. A voice finds its way to you.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Welcome back, my girl.&quot;//&lt;/span&gt;

You turn around once more, and where there was no one, a familiar face appears.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You! The woman from the other dream.&quot;//&lt;/span&gt;

[[Confront her|SE Varyonte Tutorship I Confront Her]]
[[Run away|SE Varyonte Tutorship I Run Away]]
[[Attack her|SE Varyonte Tutorship I Attack]]</tw-passagedata><tw-passagedata pid="249" name="SE Varyonte Tutorship I Attack" tags="" position="4413,904" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chGoddessHerald&quot;)]);
&lt;&lt;/script&gt;&gt; \
You form a moderate angle with your legs, putting the right one forwards, and pointing your hands towards the red-skinned woman. It isn&#39;t long until you&#39;re shooting flames against her.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;You wound my feelings. Is that a way to greet a friend?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;re no friend of mine! Bring me back to the Temple!&quot;//&lt;/span&gt;

When you stop casting fire, your opponent is no longer there.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;So soon? But you haven&#39;t even greeted me yet.&quot;//&lt;/span&gt;

//That&#39;s coming from behind me!//

You quickly turn around, only to find the woman ready to grab your arms. You step back and struggle to get free - and she lets you go, but your hands are now tied by shining, cyan handcuffs.

She smiles confidently, and after a movement of her hands, you stumble and almost lose your balance. Your ankles are now cuffed, too.

//Your arms are now locked.
Your legs are now locked.
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;
You lost &lt;span style=&quot;color:limegreen&quot;&gt;10 energy.&lt;/span&gt;//

[[Continue|SE Varyonte Tutorship I Trapped Player]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.body.arms.state = &quot;locked&quot;;
State.variables.chPlayerCharacter.body.legs.state = &quot;locked&quot;;
State.variables.chPlayerCharacter.willpower.current -= 10;
State.variables.chPlayerCharacter.energy.current -= 10;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="250" name="SE Varyonte Tutorship I Run Away" tags="" position="4410,1009" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chGoddessHerald&quot;)]);
&lt;&lt;/script&gt;&gt; \
You lose not a single moment, and run back immediately. Nothing but more mist appears in your way, and you start wondering if you&#39;re actually moving at all - when something hits you and you fall straight to the ground.

You start pushing yourself away from the ground with your hands, but they get grabbed and your face falls back yet again.

//I can&#39;t see it, but she&#39;s pulling my hands back!//

You struggle and struggle, and you manage to turn around, but not to move your hands away from your back. The red-skinned woman has grabbed your ankles and she&#39;s casting something.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;There. Now these are locked too.&quot;//&lt;/span&gt;

When she lets them go, shining cyan cuffs are keeping them together.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I would complain about your struggling... But I can&#39;t lie, I&#39;m happy you gave me an excuse to see you in bonds. Now get up.&quot;//&lt;/span&gt;

//Your arms are now locked.
Your legs are now locked.
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;
You lost &lt;span style=&quot;color:limegreen&quot;&gt;10 energy.&lt;/span&gt;//

[[Continue|SE Varyonte Tutorship I Trapped Player]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.body.arms.state = &quot;locked&quot;;
State.variables.chPlayerCharacter.body.legs.state = &quot;locked&quot;;
State.variables.chPlayerCharacter.willpower.current -= 10;
State.variables.chPlayerCharacter.energy.current -= 10;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="251" name="SE Varyonte Tutorship I Confront Her" tags="" position="4410,1117" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chGoddessHerald&quot;)]);
&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Bring me back to the Temple.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;You don&#39;t look so nice when you&#39;re angry. Why don&#39;t you calm down for me?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t make me repeat myself!&quot;//&lt;/span&gt;

She begins moving her arms, and you set yourself in position to fight back - but she disappears - and then appears again, right in front of you. The sudden events startle you, and you don&#39;t manage to react in time when she&#39;s grabbing your wrists and casting around them.

When you manage to struggle away, your hands are locked by shining, cyan handcuffs.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Your skin is so soft...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What are you...!&quot;//&lt;/span&gt;

But she makes a gesture, and you stumble despite being still, which interrupts you. Your ankles are now cuffed, too.

//Your arms are now locked.
Your legs are now locked.
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;
You lost &lt;span style=&quot;color:limegreen&quot;&gt;10 energy.&lt;/span&gt;//

[[Continue|SE Varyonte Tutorship I Trapped Player]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.body.arms.state = &quot;locked&quot;;
State.variables.chPlayerCharacter.body.legs.state = &quot;locked&quot;;
State.variables.chPlayerCharacter.willpower.current -= 10;
State.variables.chPlayerCharacter.energy.current -= 10;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="252" name="SE Varyonte Tutorship I Trapped Player" tags="" position="4523,795" size="100,100">&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I trust you will remain quiet now... It isn&#39;t like you have much of a choice.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You-&quot;//&lt;/span&gt;

But she interrupts you with a kiss. An aggressive, pushy kiss, that plays with your lips, mouth and tongue as if they were her toys. She grabs your skin with her lips, she kisses, and she inhales... And you feel your energy slipping away.

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;10 energy.&lt;/span&gt;
You lost &lt;span style=&quot;color:lightcoral&quot;&gt;10 lust.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 10;
State.variables.chPlayerCharacter.lust.current -= 10;
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What... What are you, anyway?&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;What am I?&quot;//&lt;/span&gt; She laughs. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;What do you think I am?&quot;//&lt;/span&gt;

[[A foul monster|SE Varyonte Tutorship I Foul Monster]]
[[A figment of my imagination|SE Varyonte Tutorship I Imagination]]
[[The Goddess Herself|SE Varyonte Tutorship I Goddess]]</tw-passagedata><tw-passagedata pid="253" name="SE Varyonte Tutorship I Foul Monster" tags="" position="4520,902" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You... You&#39;re a foul monster.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Am I? Have you seen many monsters yourself?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You don&#39;t belong to any tribe, you appear out of nowhere, and you drag me to this... No-place. What else could you be?&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;So you fell into the hands of this red, foul monster...&quot;//&lt;/span&gt; She licks her lips, her face just a palm away from yours. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;And now she wants your aether. Isn&#39;t that troublesome?&quot;//&lt;/span&gt;

You refuse to look away, challenging her with nothing but your eyes.

She strikes back with hers.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Fortunately for me, you&#39;re a good girl, and you will now behave...&quot;//&lt;/span&gt;

You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;

//My... My head...//

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;From now on, call me Varyonte.&quot;//&lt;/span&gt;

[[Continue|SE Varyonte Tutorship I Offered Powers]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="254" name="SE Varyonte Tutorship I Imagination" tags="" position="4518,1009" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You...? Nothing. You must be nothing. Nothing but a figment of my imagination.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I exist only within your head?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes. I didn&#39;t really wake up, I&#39;m just having another bad dream.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Poor girl... Tormented by nightmares, when her elders expect her to act all grown-up already...&quot;//&lt;/span&gt;

You refuse to look away, challenging her with nothing but your eyes.

She strikes back with hers.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Fortunately for me, you&#39;re a good girl, and you will now behave...&quot;//&lt;/span&gt;

You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;

//My... My head...//

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;From now on, call me Varyonte.&quot;//&lt;/span&gt;

[[Continue|SE Varyonte Tutorship I Offered Powers]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="255" name="SE Varyonte Tutorship I Goddess" tags="" position="4518,1117" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Are you... The Goddess?&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Am I? And shouldn&#39;t you know, better than anyone?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t mind me. It was a dumb idea.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Hahaha!&quot;//&lt;/span&gt; She makes no effort to hide her amusement. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Then it&#39;s about time you play your role, Priestess. Or are you going to defy your own Goddess? Kneel and worship me.&quot;//&lt;/span&gt;

You refuse to look away, challenging her with nothing but your eyes.

She strikes back with hers.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Fortunately for me, you&#39;re a good girl, and you will now behave...&quot;//&lt;/span&gt;

You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;

//My... My head...//

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;From now on, call me Varyonte.&quot;//&lt;/span&gt;

[[Continue|SE Varyonte Tutorship I Offered Powers]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="256" name="SE Varyonte Tutorship I Offered Powers" tags="" position="4631,795" size="100,100">&lt;&lt;if $StVars.DrishtyaTutorDominatingOthers == true&gt;&gt; \
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I&#39;ve heard what you were saying earlier.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What do you mean?&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I heard you asking the old slime how you could... Bring your new, little girlfriends to her knees. She wasn&#39;t very helpful, was she?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Don&#39;t worry, my dear...&quot;//&lt;/span&gt; She whispers right into your ear. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;You have me.&quot;//&lt;/span&gt;
&lt;&lt;elseif $StVars.DrishtyaTutorThoughtsOnPeers == &quot;TheyreDangerous&quot;&gt;&gt; \
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I&#39;ve heard what you were saying earlier.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What do you mean?&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;You don&#39;t feel at ease around your new, little girlfriends, do you? You feel weak and small next to them... Like a small kitty in front of a... Tiger. But fortunately...&quot;//&lt;/span&gt; She whispers right into your ear. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;You have me.&quot;//&lt;/span&gt;
&lt;&lt;else&gt;&gt; \
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I know you&#39;re in somewhat of a bind these days.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How funny.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I&#39;ve heard what you were saying earlier.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Aren&#39;t your fellow tribesmen mean? Sending you alone, without help, to face martial artists, hunters, magicians of pure talent... Luckily for you...&quot;//&lt;/span&gt; She whispers right into your ear. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;You have me.&quot;//&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I&#39;m offering you one out of three boons. It will give you the edge you need to close the gap that exists between you and your friends. Choose wisely.&quot;//&lt;/span&gt;

[[Boon of suggestion|SE Varyonte Tutorship I Hypnosis]]
Melt your foes&#39; minds. Make them submit to your will.&lt;span title=&quot;Grants hypnosis actions for conversation, sex and combat, which use charisma and will.&quot;&gt;^^(?)^^&lt;/span&gt;
[[Boon of draining|SE Varyonte Tutorship I Drain]]
Make the strength of your enemies yours. Rise to the top on their backs.&lt;span title=&quot;Grants draining actions for sex and combat, which use agility and empathy.&quot;&gt;^^(?)^^&lt;/span&gt;
[[Boon of binding|SE Varyonte Tutorship I Bondage]]
Take the freedom of your rivals away. They won&#39;t get up from their knees.&lt;span title=&quot;Grants a bondage action for combat, which uses intelligence and will.&quot;&gt;^^(?)^^&lt;/span&gt;
[[Refuse|SE Varyonte Tutorship I Rejected Powers]]</tw-passagedata><tw-passagedata pid="257" name="SE Varyonte Tutorship I Rejected Powers" tags="" position="4628,904" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I... I refuse! I want nothing from you.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;You refuse?&quot;//&lt;/span&gt; She crosses her arms and steps back, analyzing you. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;How troublesome.&quot;//&lt;/span&gt; ...But a smile comes back to her face. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;You think you have a choice...&quot;//&lt;/span&gt; Her eyes turn into dark pits that seem to be swallowing the whole world - you included.

//No! My head again!//

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;30 willpower.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 30;
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;And now, stop insulting my generosity.&quot;//&lt;/span&gt;

And everything goes back to normal again.

[[Boon of suggestion|SE Varyonte Tutorship I Hypnosis]]
Melt your foes&#39; minds. Make them submit to your will.&lt;span title=&quot;Grants hypnosis actions for conversation, sex and combat, which use charisma and will.&quot;&gt;^^(?)^^&lt;/span&gt;
[[Boon of draining|SE Varyonte Tutorship I Drain]]
Make the strength of your enemies yours. Rise to the top on their backs.&lt;span title=&quot;Grants draining actions for sex and combat, which use agility and empathy.&quot;&gt;^^(?)^^&lt;/span&gt;
[[Boon of binding|SE Varyonte Tutorship I Bondage]]
Take the freedom of your rivals away. They won&#39;t get up from their knees.&lt;span title=&quot;Grants a bondage action for combat, which uses intelligence and will.&quot;&gt;^^(?)^^&lt;/span&gt;</tw-passagedata><tw-passagedata pid="258" name="SE Varyonte Tutorship I Hypnosis" tags="" position="4741,795" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I choose... The boon of suggestion.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Suggestion.&quot;//&lt;/span&gt; Varyonte repeats. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Mischievous choice. Use it properly...&quot;//&lt;/span&gt; Your head starts spinning. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;...And your victims will not even be aware of your schemes.&quot;//&lt;/span&gt; The red woman&#39;s image slowly turns into two, into three - you&#39;re surrounded by copies of her.

She snaps her fingers, and they all disappear.

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Playing with your target&#39;s minds, like they&#39;re disposable toys, yours to bend, twist and break...&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;It&#39;s deliciously intoxicating.&quot;//&lt;/span&gt;

You suddenly notice you&#39;re out of air, and you hurry fill your lungs.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Try not to get addicted to it.&quot;//&lt;/span&gt;

//You learned Hypnotic Glance (Socialization, Sex, Battle)//
&lt;&lt;script&gt;&gt;
charactersLearnSceneActions([&quot;chPlayerCharacter&quot;],[&quot;realHypnoticGlance&quot;,&quot;baHypnoticGlance&quot;]);
State.variables.chPlayerCharacter.extraSocIntList.push(&quot;hypnoticGlance&quot;);
&lt;&lt;/script&gt;&gt; \

[[Continue|SE Varyonte Tutorship I Goodbye]]</tw-passagedata><tw-passagedata pid="259" name="SE Varyonte Tutorship I Drain" tags="" position="4756,904" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I choose... The boon of draining.&quot;//&lt;/span&gt;

Varyonte extends a hand to your face. Bound by arms and legs, you&#39;re unable to push her apart. Without uttering a word, she moves forward and kisses you again, exploring your lips, your face and your tongue. You feel her other hand taking your breast, and her tail tapping your back, close to your rear.

When you feel the pleasure running through your body, you also feel your energy leaving you.

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;15 energy.&lt;/span&gt;
You lost &lt;span style=&quot;color:lightcoral&quot;&gt;15 lust.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 15;
State.variables.chPlayerCharacter.lust.current -= 15;
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;The boon of draining,&quot;//&lt;/span&gt; Varyonte says, as she leaves your lips, &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;turns your victims&#39; pleasure into aether, which you take for yourself.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Take care you don&#39;t turn them into hollow husks. Unless that&#39;s what you&#39;re trying to do...&quot;//&lt;/span&gt;

//You learned Energy Draining Kiss (Sex, Battle) and Draining Kiss (Battle)//
&lt;&lt;script&gt;&gt;
charactersLearnSceneActions([&quot;chPlayerCharacter&quot;],[&quot;energyDrainingKiss&quot;,&quot;baDrainingKiss&quot;,&quot;baEnergyDrainingKiss&quot;]);
&lt;&lt;/script&gt;&gt; \

[[Continue|SE Varyonte Tutorship I Goodbye]]</tw-passagedata><tw-passagedata pid="260" name="SE Varyonte Tutorship I Bondage" tags="" position="4756,1010" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I choose... The boon of binding.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Exquisite taste.&quot;//&lt;/span&gt; She moves a hand to your face, &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Tell me...&quot;//&lt;/span&gt; Then she moves it around your mouth, casting magic. She&#39;s casted an aetherial gag. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Is this how you want to see others?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Mmpph!&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Oh, really? Tell me more, I&#39;m all ears.&quot;//&lt;/span&gt; Without waiting for a response you can&#39;t provide, she moves her hands down, and you feel the cold magic of materialized aether taking form around your nethers.

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;//
//You lost &lt;span style=&quot;color:limegreen&quot;&gt;10 energy.&lt;/span&gt;//
//Your mouth is now locked.
Your pussy is now locked.//
&lt;&lt;if $StVars.VaryonteTutorHasDick == true&gt;&gt;//Your dick is now locked.//
&lt;&lt;/if&gt;&gt; \
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
State.variables.chPlayerCharacter.energy.current -= 10;
State.variables.chPlayerCharacter.lockBodypart(&quot;mouth&quot;);
State.variables.chPlayerCharacter.lockBodypart(&quot;pussy&quot;);
State.variables.chPlayerCharacter.lockBodypart(&quot;dick&quot;);
State.variables.chPlayerCharacter.lockBodypart(&quot;anus&quot;);
&lt;&lt;/script&gt;&gt; \
//Your anus is now locked.//

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;With this power, you will turn your enemies helpless and desperate. Be patient, savor their hopelessness, and they will offer their minds and bodies themselves, on silver cutlery.&quot;//&lt;/span&gt;

//You learned learned Ethereal Chains (Sex, Battle)//
&lt;&lt;script&gt;&gt;
charactersLearnSceneActions([&quot;chPlayerCharacter&quot;],[&quot;etherealChains&quot;,&quot;baEtherealChains&quot;]);
&lt;&lt;/script&gt;&gt; \

[[Continue|SE Varyonte Tutorship I Goodbye]]</tw-passagedata><tw-passagedata pid="261" name="SE Varyonte Tutorship I Goodbye" tags="" position="4760,1117" size="100,100">&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I hope you had fun tonight.&quot;//&lt;/span&gt; She snaps her fingers, and your binds turn into dust, and the dust turns into mist. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I wish I had more time, but I&#39;m just so busy these days...&quot;//&lt;/span&gt;
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.freeBodypart(&quot;mouth&quot;);
State.variables.chPlayerCharacter.freeBodypart(&quot;pussy&quot;);
State.variables.chPlayerCharacter.freeBodypart(&quot;dick&quot;);
State.variables.chPlayerCharacter.freeBodypart(&quot;anus&quot;);
State.variables.chPlayerCharacter.freeBodypart(&quot;arms&quot;);
State.variables.chPlayerCharacter.freeBodypart(&quot;legs&quot;);
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

Varyonte pets your head, patronizing. You push her away.

&lt;&lt;if $StVars.DrishtyaTutorLeaveTheTemple == true&gt;&gt; \
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;And don&#39;t you dare thinking again about leaving the Temple.&quot;//&lt;/span&gt; She gives you a menacing look. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;If you do, your tribe shunning you will be the smallest of your worries.&quot;//&lt;/span&gt;

And just as she finishes talking, you wake up in your bed.
&lt;&lt;else&gt;&gt; \
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I&#39;ll be looking forwards to play with you again.&quot;//&lt;/span&gt;

And just as she finishes talking, you wake up in your bed.
&lt;&lt;/if&gt;&gt; \

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
setPasChars([]);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="262" name="SE Beating Kitty Into Friendship Start" tags="" position="5210,220" size="100,100">$customRoomIntro
Summoned by Drishtya, all Candidates are gathering in the training grounds. You&#39;re met by the sight of Claw, first one of them to arrive. Nash, who is coming right besides you, salutes her.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hello. First one to arrive, hmm?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

Claw, who was looking at the horizon, turns back and fixates her eyes on Nashillbyir, staring threateningly. After that, she goes back to contemplate the nothingness.

//At least she acknowledged her existence.// You think with bitter irony.

Maaterasu, Valtan and Padmiri arrive next.

[[Continue|SE Beating Kitty Into Friendship New Rules]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="263" name="Other Quickstart Options" tags="" position="612,15" size="100,100">&lt;&lt;link [[Magic Class|SE Magic Class Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.agility.value = 15;
initializeSeMagicClass();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Stretching help|SE Stretching Help Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);
setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;dummies&quot;);
State.variables.eventsCalendar.setFinishEventButton(&quot;Continue&quot;,&quot;setNoPasChars()&quot;);
State.variables.StVars.futaNash = false;
if ( State.variables.chNash.body.hasOwnProperty(&quot;dick&quot;) ) {
State.variables.StVars.futaNash = true;
}
State.variables.StVars.seshFlirty = false;
if ( State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv &gt; 100 ) {
State.variables.StVars.seshFlirty = true;
}
State.variables.chPlayerCharacter.resilience.value = 11;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Humming|SE Humming Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.luck.value = 13; 
initializeSeHumming(); 
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; 
&lt;&lt;link [[Ethics of Powers|SE EthicsOfPow Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.intelligence.value = 16;
initializeSeEthicsOfPower();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Staying Hydrated|SE Staying Hydrated Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
initializeSeStayingHydrated(); 
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; 
&lt;&lt;link [[Friend Back At Home|SE Friend Back At Home Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
initializeSeFriendBackAtHome(); 
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; 

&lt;&lt;link [[StretchingHelpII Enemies|SE Stretching Help II Nash Meets Claw]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chNash.relations.chPlayerCharacter.rivalry.level = 12;
State.variables.StVars.StretchingHelpResult = &quot;unfinished&quot;;
initializeSeStretchingHelpII(); 
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; 
&lt;&lt;link [[StretchingHelpII DidntStretch|SE Stretching Help II Nash Meets Claw]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.StVars.StretchingHelpResult = &quot;unfinished&quot;;
initializeSeStretchingHelpII();  
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; 
&lt;&lt;link [[StretchingHelpII Friendly Minus Grope|SE Stretching Help II Nash Meets Claw]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.StVars.StretchingHelpResult = &quot;friendly&quot;;
State.variables.StVars.StretchingHelpGroped = &quot;false&quot;;
initializeSeStretchingHelpII(); 
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; 
&lt;&lt;link [[StretchingHelpII Friendly Plus Grope|SE Stretching Help II Nash Meets Claw]]&gt;&gt;&lt;&lt;script&gt;&gt; 
State.variables.StVars.StretchingHelpResult = &quot;friendly&quot;;
State.variables.StVars.StretchingHelpGroped = &quot;true&quot;;
initializeSeStretchingHelpII();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[StretchingHelpII Sexual|SE Stretching Help II Nash Meets Claw]]&gt;&gt;&lt;&lt;script&gt;&gt; 
State.variables.chPlayerCharacter.willpower.current = 40;
State.variables.chPlayerCharacter.willpower.max = 40;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.level = 3;
State.variables.StVars.StretchingHelpResult = &quot;sexual&quot;;
State.variables.StVars.StretchingHelpGroped = &quot;true&quot;;
initializeSeStretchingHelpII(); 
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; 

&lt;&lt;link [[SE Flirting Advice|SE Flirting Advice Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
for ( var st of getStatNamesArray() ) {
	gC(&quot;chPlayerCharacter&quot;)[st].value = 20;
}
State.variables.chPlayerCharacter.agility.value = 15;
initializeSeFlirtingAdvice();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[SE Drishtya Tutorship I|SE Drishtya Tutorship I Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.empathy.value = 15;
initializeSeDrishtyaTutorShip();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[SE Beating Kitty Into Friendship|SE Beating Kitty Into Friendship Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
initializeSeBeatingKittyIntoFriendship();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="264" name="Scene Results" tags="" position="1710,130" size="100,100">$compass.sceneResultsPassage</tw-passagedata><tw-passagedata pid="265" name="SE Beating Kitty Into Friendship New Rules" tags="" position="5323,222" size="100,100">$customRoomIntro
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Greetings, Candidates.&quot;//&lt;/span&gt; The Priestess Regent announces her arrival, Shrezdill standing by her side.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I believe you have had enough time to start getting used to your life at the Temple. Therefore, it is time to allow you to start competing.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;From now on, you will be allowed to challenge your peers in battle, during training and socialization periods.&quot;//&lt;/span&gt; 

//Map options to challenge, assault and form groups have been enabled.//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;The success of winning in battle does not come empty-handed. Candidates who consistently best the others will be noticed and they will gain merit to become the next High Priestess. This, however, is still a long time away.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;What is not so distant&quot;//&lt;/span&gt; Shrezdill intervenes, &lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;is being able to challenge the others in exchange for something. This is sometimes used to solve disputes.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It might be possible that some Candidates want to attack you without properly challenging you first. This is dishonourable, but allowed. If you fear the possibility of being assaulted by someone else, consider teaming up.&quot;//&lt;/span&gt;

[[Continue|SE Beating Kitty Into Friendship Tuto fight]]</tw-passagedata><tw-passagedata pid="266" name="SE Beating Kitty Into Friendship Tuto fight" tags="" position="5429,222" size="100,100">$customRoomIntro
&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Now... It would be best to learn with some practical example, don&#39;t you think?&quot;//&lt;/span&gt; 

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I&#39;m sure we&#39;ll have volunteers.&quot;//&lt;/span&gt;

//Hmm. Should I participate?//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;...Such as Padmiri and Maaterasu.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Huh? Us?&quot;//&lt;/span&gt; Padmiri says, surprised.

//...What a strange way to ask for volunteers.//

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Of course. I&#39;ll participate.&quot;//&lt;/span&gt; Ate replies.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Please don&#39;t mind Drishtya. She probably just trusts you the most to obey her instructions, for a most instructive exercise.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;If that&#39;s the case...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...Wait, what does that say about the rest of us?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;We get no trust from the elders, Nashy.&quot;//&lt;/span&gt; Valtan says with mockery.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I understand why they don&#39;t trust you, but what did I do?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That was unnecessary, Shrezdill. Look at what you did.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Hehe. Don&#39;t take me too seriously. Let&#39;s begin the match.&quot;//&lt;/span&gt; 

&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
btifFirstBattleInit();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="267" name="SE Beating Kitty Into Friendship Further Trouble" tags="" position="5551,220" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);
State.variables.chMir.lust.current = State.variables.chMir.lust.max;
State.variables.chMir.energy.current = State.variables.chMir.energy.max;
State.variables.chMir.willpower.current = State.variables.chMir.willpower.max;
State.variables.chMir.socialdrive.current = State.variables.chMir.socialdrive.max;
State.variables.chAte.lust.current = State.variables.chAte.lust.max;
State.variables.chAte.energy.current = State.variables.chAte.energy.max;
State.variables.chAte.willpower.current = State.variables.chAte.willpower.max;
State.variables.chAte.socialdrive.current = State.variables.chAte.socialdrive.max;
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s one thing that you&#39;re flaunting your hysterical ideas about how we should behave with one another whenever you have the chance, but why do you have to try so hard at being an asshole!?&quot;//&lt;/span&gt; Nashillbyir erupts in anger. Claw is the target of her rebuke.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;What&#39;s going on here?&quot;//&lt;/span&gt; Shrezdill looks at you, looking for an explanation. You can&#39;t help but shrug.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I was just paying attention to the fight...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Do you seriously think you can call me hysterical, with that face you&#39;re making?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Let&#39;s calm down for a moment. What&#39;s the issue here?&quot;//&lt;/span&gt;

[[Continue|SE Beating Kitty Into Friendship Challenge]]</tw-passagedata><tw-passagedata pid="268" name="SE Beating Kitty Into Friendship Challenge" tags="" position="5319,334" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I can&#39;t stand Claw&#39;s attitude.&quot;//&lt;/span&gt; Nash states. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;No one in here did anything to her, but she&#39;s constantly treating us like the dust she walks on. I&#39;ve been containing myself for a while already.&quot;//&lt;/span&gt;

Drishtya and Shrezdill look at each other, perhaps communicating with gestures that no one but themselves would be able to understand.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Tell me, what would solve your conflict?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I just want her to treat us with some respect!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It&#39;s clear Claw isn&#39;t going to change her attitude on her own. What can YOU do about it?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt; The Ashwalker stands silent, looking at Drishtya, then at Claw. Then, at the ground. She closes her eyes for one whole second, and opens them to face the Beastkin with determination. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;I challenge you to a duel.&quot;//&lt;/span&gt;

[[Continue|SE Beating Kitty Into Friendship Challenge Accepted]]</tw-passagedata><tw-passagedata pid="269" name="SE Beating Kitty Into Friendship Challenge Accepted" tags="" position="5434,334" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;m going to put you on the ground, and when I do... You&#39;ll agree to talk to the rest of us, daily. Like fellow sentient beings. That&#39;s all I want. If it comes to that and you decide you want to keep being miserable, I&#39;ll accept it.&quot;//&lt;/span&gt;

Drishtya remains silent for a moment, looking at Nash and Claw. Then, she speaks: &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Claw, is this acceptable?&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.BkifStakes is &quot;servitude&quot;&gt;&gt; \
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;It is. As for my terms... When I put you in your place, you&#39;re going to kiss my feet, you&#39;re going to swear fealty to me, and you&#39;ll be at my beck and call whenever I desire, be it to carry my things or to get on your knees.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What!?&quot;//&lt;/span&gt; Padmiri gasps in the distance, disturbed.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;You must change your terms. We will only allow temporary servitude relationships between the Candidates, for a maximum of three days.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Three days? Tsch. Fine.&quot;//&lt;/span&gt; 

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Nashillbyir?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I accept.&quot;//&lt;/span&gt;
&lt;&lt;elseif $StVars.BkifStakes is &quot;sex&quot;&gt;&gt; \
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;It is. As for my terms... I&#39;m going to put you in your place, which is in all fours, and satisfying my every demand.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Oh, no.&quot;//&lt;/span&gt; Padmiri muses, in the distance.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;These terms are acceptable. Nashillbyir?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I accept.&quot;//&lt;/span&gt;
&lt;&lt;else&gt;&gt; \
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;It is. As for my terms... I&#39;m going to drag you in rags, you&#39;ll get in your knees, and you&#39;ll apologize for being such a little pest and beg me for mercy.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;These terms are acceptable. Nashillbyir?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I accept.&quot;//&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \

[[Continue|SE Beating Kitty Into Friendship Player Choices]]</tw-passagedata><tw-passagedata pid="270" name="SE Beating Kitty Into Friendship Player Choices" tags="" position="5546,332" size="100,100">$customRoomIntro
//Am I fine with things going as they are...? Should I do something?//

[[Let things continue|SE Beating Kitty Into Friendship Stay Quiet]]
[[Ask Nashillbyir to back down|SE Beating Kitty Into Friendship Get Nash To Retire]]
[[Fight along with Nashillbyir|SE Beating Kitty Into Friendship Fight Along Nash]]
[[Ask Nashillbyir to fight in her place|SE Beating Kitty Into Friendship Fight Instead Nash]]</tw-passagedata><tw-passagedata pid="271" name="SE Beating Kitty Into Friendship Stay Quiet" tags="" position="5286,445" size="100,100">$customRoomIntro
Drishtya asks Padmiri and Maaterasu to retire, while Shrezdill leads Nash and Claw to take their places. They&#39;re soon facing one another, with the older Ashwalker between them.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;The first challenge of this generation of Candidates is about to begin! Nashillbyir will battle Claw in order to force her to socialize more with everyone else. Is everyone ready?&quot;//&lt;/span&gt;

Both warriors nod silently. Their backs are curved. Nash is placing her body&#39;s weight on her left leg, and her arms are extended forwards. Claw is heavily leaning against her opponent, like a giant feline about to leap on its prey.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Let the challenge begin!&quot;//&lt;/span&gt;

[[Continue|Scene]]
&lt;&lt;script&gt;&gt;
ccsBtifNashVsClawBattleInit();
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="272" name="SE Beating Kitty Into Friendship Get Nash To Retire" tags="" position="5403,446" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nash?&quot;//&lt;/span&gt; You call the Ashwalker&#39;s attention.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Yes?&quot;//&lt;/span&gt; She takes a moment to look at you. Her face is serious, determined.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Can you reconsider this? I&#39;m not sure this is a great idea...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Listen to $chPlayerCharacter.name for a moment. Are you sure what you&#39;re doing is worth the risk?&quot;//&lt;/span&gt; The Leirien intervenes.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;m sorry, but I can&#39;t back down on this. Not anymore.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Nashillbyir has fallen a bit.&lt;/span&gt;//
//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has grown a bit.&lt;/span&gt;//

[[Continue|SE Beating Kitty Into Friendship Stay Quiet]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 100;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv -= 100;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 100;
State.variables.chMir.relations.chNash.friendship.stv -= 100;
State.variables.chNash.relations.chMir.friendship.stv -= 100;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv -= 100;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="273" name="SE Beating Kitty Into Friendship Fight Along Nash" tags="" position="5508,446" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nash?&quot;//&lt;/span&gt; You call the Ashwalker&#39;s attention.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Yes?&quot;//&lt;/span&gt; She takes a moment to look at you. Her face is serious, determined.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m going to fight with you.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.BkifNashRelScore &gt;= 3&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Relation check: passed.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;She doesn&#39;t think you can win on your own.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;A challenge of two Candidates against one is out of the table.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Oh, that has a most simple solution.&quot;//&lt;/span&gt; Valtan declares, stepping forwards. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;I&#39;ll fight in Claw&#39;s team, that will make the challenge fair.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What are you doing, Val!?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Relax, honeypot. Let your friends have their fun.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Well... That would solve it... I guess.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Whatever. Just don&#39;t get in my way.&quot;//&lt;/span&gt;

[[Continue|SE BKIF Nash Accepts Teamfight]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Relation check: failed.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Huh? No way. I&#39;m going to do this by myself.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But-&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;It doesn&#39;t look like she thinks you can win.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Well, her mouth is going to shut real fast.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Nashillbyir has fallen a bit.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv -= 100;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv -= 100;
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Beating Kitty Into Friendship Stay Quiet]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="274" name="SE Beating Kitty Into Friendship Fight Instead Nash" tags="" position="5621,443" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nash?&quot;//&lt;/span&gt; You call the Ashwalker&#39;s attention.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Yes?&quot;//&lt;/span&gt; She takes a moment to look at you. Her face is serious, determined.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Let me fight in your place.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.BkifNashRelScore &gt;= 8&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Relation check: passed.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Can you just trust me on this one? It&#39;s important to me.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt; Nashillbyir stays quiet, thinking. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;That&#39;s... Ok. Do your best. Please don&#39;t make me regret this.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I won&#39;t!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Are you serious?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What, are you not happy to face me instead?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...It will be my pleasure.&quot;//&lt;/span&gt;

[[Continue|SE BKIF Nash Accepts Player Swap]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Relation check: failed.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Huh? No way. This is my fight.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But-&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;It doesn&#39;t look like she thinks you can win.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Well, her mouth is going to shut real fast.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Nashillbyir has fallen.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv -= 250;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv -= 250;
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Beating Kitty Into Friendship Stay Quiet]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="275" name="SE BKIF Nash Victory" tags="" position="5288,552" size="100,100">$customRoomIntro
Silence follows. Claw remains in the ground, defeated. In front of her, Nash stands tall.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Nashillbyir is the victor!&quot;//&lt;/span&gt;

Padmiri sighs relieved. Valtan has a faint smile, her thoughts hard to decipher. The young Ashwalker offers a hand to the Beastkin. Claw, in turn, grits her teeth, angry, perhaps feeling humilliated. After a tense pause, she gives in and takes her rival&#39;s hand, who helps her to get up. 

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;A promise is a promise.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I... I know. You don&#39;t need to remind me.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Congratulations, Nash!&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;That was quite the... Interesting fight.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Haha... Thanks!&quot;//&lt;/span&gt;

//Nashillbyir has gained 5 merit.//
//Claw seems more open to socializing now.//

&lt;&lt;script&gt;&gt;
State.variables.chNash.relations.chClaw.friendship.stv += 250;
State.variables.chClaw.relations.chNash.friendship.stv += 250;
gC(&quot;chNash&quot;).changeMerit(5);
gC(&quot;chClaw&quot;).baseMood.angry = 0;
gC(&quot;chClaw&quot;).mood.angry = 0;
finishSeBtif();
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="276" name="SE BKIF Claw Victory Humilliation" tags="" position="5286,659" size="100,100">$customRoomIntro
Silence follows. Nash remains in the ground, defeated. In front of her, Claw stands tall.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Fiercest Claw is the victor!&quot;//&lt;/span&gt;

Padmiri has a worried look. Valtan, strangely, seems to be serious.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Get on your knees.&quot;//&lt;/span&gt;

When the defeated Ashwalker gets her face off the ground, you can see her mouth trembling, and her eyes frowning. She feels frustrated enough as it is, and the fear of whatever Claw may have in store for her is creeping in.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Now beg me for forgiveness.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I... I&#39;m sorry.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;That&#39;s far from enough. Try better.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;m sorry for having annoyed you...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Do better.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;m sorry for having been such a little pest...&quot;//&lt;/span&gt;

Claw puts her foot in front of Nash&#39;s face.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Kiss it.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;m sorry for troubling you! I won&#39;t bother you again!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I said kiss it.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

It&#39;s hard to tell from the distance, but you&#39;d swear a small tear is falling from the kneeling girl&#39;s eye. She moves her head forwards, and places a kiss on top of Claw&#39;s foot.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf.&quot;//&lt;/span&gt;

And with that, Claw pushes Nash&#39;s face back, and walks away.

//Claw&#39;s infamy has grown by 2.
Claw has gained 5 merit.//

&lt;&lt;script&gt;&gt;
State.variables.chNash.relations.chClaw.submission.stv += 750;
State.variables.chClaw.relations.chNash.domination.stv += 750;
State.variables.chMir.relations.chClaw.enmity.stv += 500;
State.variables.chMir.relations.chClaw.rivalry.stv += 250;
gC(&quot;chClaw&quot;).changeMerit(5);
gC(&quot;chClaw&quot;).changeInfamy(2);
finishSeBtif();
gC(&quot;chClaw&quot;).socialAi.rivalTs = [&quot;chNash&quot;];
gC(&quot;chNash&quot;).socialAi.rivalTs = [&quot;chClaw&quot;];
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="277" name="SE BKIF Claw Victory Sex" tags="" position="5285,764" size="100,100">$customRoomIntro
Silence follows. Nash remains in the ground, defeated. In front of her, Claw stands tall.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Fiercest Claw is the victor!&quot;//&lt;/span&gt;

Padmiri has a worried look. Valtan, strangely, seems to be serious.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Had enough?&quot;//&lt;/span&gt;

When the defeated Ashwalker gets her face off the ground, you can see her mouth trembling, and her eyes frowning. She feels frustrated enough as it is, and the fear of whatever Claw may have in store for her is creeping in.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Now get up. We&#39;ll continue this in my room.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Y-Yes.&quot;//&lt;/span&gt; Nashillbyir replies with a meek voice. Her lips are shrunken, pressed against each other.

//She&#39;s trying too hard to contain her emotions.//

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Nash...&quot;//&lt;/span&gt;

//Claw&#39;s infamy has grown by 3.
Claw has gained 5 merit.//

&lt;&lt;script&gt;&gt;
State.variables.chNash.relations.chClaw.submission.stv += 750;
State.variables.chClaw.relations.chNash.domination.stv += 750;
State.variables.chNash.relations.chClaw.sexualTension.stv += 250;
State.variables.chClaw.relations.chNash.sexualTension.stv += 250;
State.variables.chMir.relations.chClaw.enmity.stv += 500;
State.variables.chMir.relations.chClaw.rivalry.stv += 250;
gC(&quot;chClaw&quot;).changeMerit(5);
gC(&quot;chClaw&quot;).changeInfamy(3);
finishSeBtif();
State.variables.sc.startScene(
	&quot;ss&quot;,&quot;fixed&quot;,[&quot;chClaw&quot;],[&quot;chNash&quot;],&quot;The big guy remains imperturbable.&quot;,endConditionTurns,40,
	&quot;SE SH II End NodeC Had Sex&quot;);
	State.variables.sc.endSceneScript = processGenericSexSceneEffects;
	State.variables.chClaw.hasLead = true;
	State.variables.chNash.hasLead = false;
	// Assign choices
	State.variables.chClaw.hasLead = true;
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.fixedTarget = &quot;chNash&quot;;
	State.variables.chClaw.aiAlgorythm.setRoleDomination();
State.variables.sc.autoResolveScene();

gC(&quot;chClaw&quot;).socialAi.rivalTs = [&quot;chNash&quot;];
gC(&quot;chNash&quot;).socialAi.rivalTs = [&quot;chClaw&quot;];
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="278" name="SE BKIF Claw Victory Servitude" tags="" position="5285,869" size="100,100">$customRoomIntro
Silence follows. Nash remains in the ground, defeated. In front of her, Claw stands tall.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Fiercest Claw is the victor!&quot;//&lt;/span&gt;

Padmiri has a worried look. Valtan, strangely, seems to be serious.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You sure talked a whole lot for such a small show.&quot;//&lt;/span&gt;

When the defeated Ashwalker gets her face off the ground, you can see her mouth trembling, and her eyes frowning. She feels frustrated enough as it is, and the fear of whatever Claw may have in store for her is creeping in.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You know what comes next, right?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Y-Yes...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Get on your knees.&quot;//&lt;/span&gt;

With some effort, Nash pushes her torso off the ground, and sits on her own feet. Her face looks down.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Swear fealty to me.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I... Swear loyalty to Claw... And I swear to obey her for as long as the challenge forces me to...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf. That will do for now. I will show you better manners later.&quot;//&lt;/span&gt;

//Claw&#39;s infamy has grown by 5.
Claw has gained 5 merit.
Nashillbyir will become Claw&#39;s servant for the next 3 days.//

&lt;&lt;script&gt;&gt;
State.variables.chNash.relations.chClaw.submission.stv += 750;
State.variables.chClaw.relations.chNash.domination.stv += 750;
State.variables.chMir.relations.chClaw.enmity.stv += 500;
State.variables.chMir.relations.chClaw.rivalry.stv += 250;
gC(&quot;chClaw&quot;).changeMerit(5);
gC(&quot;chClaw&quot;).changeInfamy(5);
finishSeBtif();
createRelTypeServitudeDom(&quot;chClaw&quot;,&quot;chNash&quot;,3);
createRelTypeServitudeSub(&quot;chNash&quot;,&quot;chClaw&quot;,3);
gC(&quot;chClaw&quot;).socialAi.covetTs.push(&quot;chNash&quot;);
gC(&quot;chNash&quot;).socialAi.rivalTs = [];
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="279" name="SE BKIF Nash Accepts Teamfight" tags="" position="5505,557" size="100,100">$customRoomIntro
Drishtya asks Padmiri and Maaterasu to retire, while Shrezdill leads the four of you to take their places. You&#39;re soon facing each other, with the older Ashwalker between you.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;The first challenge of this generation of Candidates is about to begin! Nashillbyir and $chPlayerCharacter.name will battle Claw and Valtan in order to force the Beastkin Candidate to socialize more with everyone else. Is everyone ready?&quot;//&lt;/span&gt;

All of you nod silently. Nashillbyir is placing her body&#39;s weight on her left leg, the right one pointing forwards, along with her arms and open palms. Valtan stands firm but comfortable, one of her hands posed on her waist. Claw&#39;s back is curved, her head and torso heavily leaning towards you, like a giant feline about to leap on its prey.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Ah, this goes without saying, but if we win, my prize is $chPlayerCharacter.name.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh!?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Let the challenge begin!&quot;//&lt;/span&gt;

[[Continue|Scene]]
&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chVal&quot;)]);
ccsBtifTeamfightBattleInit();
State.variables.StVars.playerJoinedBkifBattle = true;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="280" name="SE BKIF Player Team Victory" tags="" position="5405,709" size="100,100">$customRoomIntro
Silence follows. Claw and Val lay on the ground, defeated. The rush of the fight still has your blood pumping, and you&#39;re just barely beginning to calm down.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Nashilllbyir and $chPlayerCharacter.name are the victors!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;We did it!&quot;//&lt;/span&gt; Nash shouts as she takes you in a hug. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;You did great! Thank you!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ah- Yes! We formed a great team.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Ah, as for Claw...&quot;//&lt;/span&gt;

When she was mentioned, the Beastkin was just getting up. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I know.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I want to see you talking with us daily from now on.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You don&#39;t need to mention it. I... lost. And I will keep my word.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Valtan, where are you going?&quot;//&lt;/span&gt; Padmiri says, out of nowhere.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Me? I was merely going to leave to allow them to celebrate...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Say, if you wanted a prize for winning the challenge, shouldn&#39;t $chPlayerCharacter.name have one now that she won?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Haha... What an interesting idea.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That sounds fair to me!&quot;//&lt;/span&gt;

//Nashillbyir has gained 5 merit.
You have gained 5 merit.//
//Claw seems more open to socializing now.//
//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Nashillbyir has grown.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has grown slightly.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
gC(&quot;chNash&quot;).changeMerit(5);
gC(&quot;chPlayerCharacter&quot;).changeMerit(5);
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 500;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 500;
State.variables.chPlayerCharacter.relations.chNash.romance.stv += 500;
State.variables.chNash.relations.chPlayerCharacter.romance.stv += 500;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 250;
gC(&quot;chClaw&quot;).baseMood.angry = 0;
gC(&quot;chClaw&quot;).mood.angry = 0;
&lt;&lt;/script&gt;&gt; \

[[Demand nothing|SE BKIF Player No Prize]]
[[Demand Claw humilliation|SE BKIF Player Prize Humilliate Claw]]
[[Demand Val humilliation|SE BKIF Player Prize Humilliate Val]]
&lt;&lt;if $settings.battleDefeatSex == &quot;enable&quot;&gt;&gt; \
[[Demand sex with Claw|SE BKIF Player Prize Sex Claw]]
[[Demand sex with Val|SE BKIF Player Prize Sex Val]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Your settings don&#39;t allow you to demand sex for battles.
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Your settings don&#39;t allow you to demand sex for battles.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $settings.servitudeRelationships == &quot;enable&quot;&gt;&gt; \
[[Demand servitude from Claw|SE BKIF Player Prize Servant Claw]]
[[Demand servitude from Val|SE BKIF Player Prize Servant Val]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Your settings don&#39;t allow you to demand servitude relationships.
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Your settings don&#39;t allow you to demand servitude relationships.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="281" name="SE BKIF Player Team Defeat" tags="" position="5511,709" size="100,100">$customRoomIntro
Silence follows. You are in the ground, defeated, and so is Nashillbyir, next to you. You manage to get a glimpse of her, and you notice a single tear falling through her face.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Fiercest Claw and Valtan are the victors!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Get on your knees.&quot;//&lt;/span&gt; Claw says to Nash.

You put your hands on the ground, ready to get up and intervene, but someone grabs your shoulder.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Quiet, my dear. You don&#39;t need to watch that. And you&#39;re going to have to deal with me...&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.BkifStakes == &quot;servitude&quot;&gt;&gt; \
[[Continue|SE BKIF Val Defeats Player Servitude]]
&lt;&lt;elseif $StVars.BkifStakes == &quot;sex&quot;&gt;&gt; \
[[Continue|SE BKIF Val Defeats Player Sex]]
&lt;&lt;else&gt;&gt; \
[[Continue|SE BKIF Val Defeats Player Humilliation]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="282" name="SE BKIF Player Prize Humilliate Claw" tags="" position="5400,820" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Claw.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...What?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You are going to kneel, as part of my prize.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Screw- ...Hissss.&quot;//&lt;/span&gt; After a small mental battle within her own mind, the Beastkin gives in to your demand, and kneels.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Now apologize to Nash, for treating her so badly.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;$chPlayerCharacter.name, this isn&#39;t necessary...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s up to me to decide. Hurry up, kitty, we don&#39;t have the whole day.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;m sorry.&quot;//&lt;/span&gt; Claw says bluntly, merely moments before dedicating you a harsh look.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Now apologize for your attitude with me when I first met you.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;m sorry.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I&#39;m not sure I feel satisfied with this.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;If you expected her to break up in tears, I&#39;m afraid you&#39;ve wasted your victory.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Sigh.&quot;//&lt;/span&gt;

//You have gained 1 merit.
You have gained 1 infamy.
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity with Claw has grown slightly.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 500;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 250;
gC(&quot;chPlayerCharacter&quot;).changeMerit(1);
gC(&quot;chPlayerCharacter&quot;).changeInfamy(1);
finishSeBtif();
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="283" name="SE BKIF Player Prize Humilliate Val" tags="" position="5511,817" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Valtan.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Yes?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You are going to kneel, as part of my prize.&quot;//&lt;/span&gt;

Valtan opens her arms wide and shrugs, sighing at the sky. Then she advances towards you and kneels... Smiling like a mischievous child far too satisfied with her most recent prank.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Are you going to punish this bad girl?&quot;//&lt;/span&gt; She asks looking straight to your eyes.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Um, of course.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Oooh, pleaseee, I&#39;ll behave better next time!&quot;//&lt;/span&gt; Her tone has clearly shifted to that of mockery.

//Ugh, what should I do?//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Stop that. Lean and... Kiss my feet.&quot;//&lt;/span&gt;

She stops complaining and, without losing her smile, places a single kiss in each of your feet.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Is that to your satisfaction, mistress? Wouldn&#39;t you prefer me to kiss... Somewhere closer to here?&quot;//&lt;/span&gt; She says as she gets her head close to your nethers.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Why are you enjoying this so much!?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;No, no! That... Won&#39;t be necessary. That was your punishment.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;That was it? But then I&#39;ll have to misbehave again...&quot;//&lt;/span&gt;

//Why do I feel like I was the one being humilliated!?//

//You have gained 1 merit.
You have gained 1 infamy.
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Valtan has grown slightly.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Valtan has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.domination.stv += 250;
State.variables.chVal.relations.chPlayerCharacter.submission.stv += 250;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 500;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 500;
gC(&quot;chPlayerCharacter&quot;).changeMerit(1);
gC(&quot;chPlayerCharacter&quot;).changeInfamy(1);
finishSeBtif();
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="284" name="SE BKIF Player Prize Sex Claw" tags="" position="5400,925" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Claw.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...What?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;My prize will be... Your body.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Huh!? But that-&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You were the one who set the stakes this high. You have no right to complain.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt; The Beastkin looks away, thinking for a moment. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Fine.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Let&#39;s go to my room.&quot;//&lt;/span&gt;

//You have gained 3 infamy.
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Claw has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 500;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 500;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 500;
gC(&quot;chPlayerCharacter&quot;).changeInfamy(3);
finishSeBtif();
State.variables.sc.startScene(
	&quot;ss&quot;,&quot;fixed&quot;,[&quot;chPlayerCharacter&quot;],[&quot;chClaw&quot;],&quot;The water flows quietly.&quot;,endConditionTurns,30,
	&quot;Map&quot;);
	State.variables.sc.endSceneScript = processGenericSexSceneEffects;
	State.variables.chPlayerCharacter.hasLead = true;
	State.variables.chClaw.hasLead = false;
	// Assign choices
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.fixedTarget = &quot;chPlayerCharacter&quot;;
	State.variables.chClaw.aiAlgorythm.setRoleSubmission();
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.eventsCalendar.activeEvent = false;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \</tw-passagedata><tw-passagedata pid="285" name="SE BKIF Player Prize Sex Val" tags="" position="5510,924" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Valtan.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Yes?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;My prize will be... Your body.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Will it?&quot;//&lt;/span&gt; Without much delay, she moves towards you and kisses you. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;Am I not fortunate? I lose the battle and I get rewarded.&quot;//&lt;/span&gt; Not happy enough with that, she takes your hand and pulls you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;W-Wait! We&#39;ll continue this in my room.&quot;//&lt;/span&gt;

//Why does it look like she&#39;s the one who won!?//

//You have gained 3 infamy.
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Valtan has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.domination.stv += 500;
State.variables.chVal.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 500;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 500;
gC(&quot;chPlayerCharacter&quot;).changeInfamy(3);
finishSeBtif();
State.variables.sc.startScene(
	&quot;ss&quot;,&quot;fixed&quot;,[&quot;chPlayerCharacter&quot;],[&quot;chVal&quot;],&quot;The water flows quietly.&quot;,endConditionTurns,30,
	&quot;Map&quot;);
	State.variables.sc.endSceneScript = processGenericSexSceneEffects;
	State.variables.chPlayerCharacter.hasLead = true;
	State.variables.chVal.hasLead = false;
	// Assign choices
	State.variables.chVal.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chVal.aiAlgorythm.fixedTarget = &quot;chPlayerCharacter&quot;;
	State.variables.chVal.aiAlgorythm.setRoleSubmission();
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.eventsCalendar.activeEvent = false;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \</tw-passagedata><tw-passagedata pid="286" name="SE BKIF Player Prize Servant Claw" tags="" position="5400,1030" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Claw.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...What?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You are going to be my prize.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Screw- ...Hissss.&quot;//&lt;/span&gt; After a small mental battle within her own mind, the Beastkin gives in to your demand, and faces you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You have no right to complain, you&#39;re the one who set the stakes this high. Now, kneel.&quot;//&lt;/span&gt;

She crosses her arms, but obeys you shortly after.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Swear fealty to me.&quot;//&lt;/span&gt;

Claw sets her gaze straight in your eyes, defying you without words.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;$chPlayerCharacter.name, are you sure you aren&#39;t overdoing it...?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Oh, no. She brought this on herself. Claw, I don&#39;t have the whole day.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...I will obey you, for the time being.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I guess that&#39;s good enough.&quot;//&lt;/span&gt;

//You have gained 5 infamy.
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity with Claw has grown slightly.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has slightly fallen.&lt;/span&gt;
Claw will become your servant for the next 3 days.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 500;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 250;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 250;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 250;
gC(&quot;chPlayerCharacter&quot;).changeInfamy(5);
finishSeBtif();
createRelTypeServitudeDom(&quot;chPlayerCharacter&quot;,&quot;chClaw&quot;,3);
createRelTypeServitudeSub(&quot;chClaw&quot;,&quot;chPlayerCharacter&quot;,3);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="287" name="SE BKIF Player Prize Servant Val" tags="" position="5506,1032" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Valtan.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Yes?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You will be my prize?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Oh? Am I going to become a trophy? Do you want me to pose in your room for you?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m serious. And it&#39;s only fair, it&#39;s want you wanted to demand from me.&quot;//&lt;/span&gt;

Valtan extends her arms to the sides, shrugging and sighing at the sky. Then she moves towards you, and kneels.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Will you take good care of me, Mistress?&quot;//&lt;/span&gt; Her tone has shifted to that of a small child, presumably in mockery.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;H-Hey, stop that.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I promise I will be a good girl.&quot;//&lt;/span&gt; She says as she takes her ring finger to her lips.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Am I going to have to deal with this from now on? Was this a mistake?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;May the Goddess bless you with patience.&quot;//&lt;/span&gt;

//You have gained 5 infamy.
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Valtan has grown slightly.&lt;/span&gt;
Valtan will become your servant for the next 3 days.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.domination.stv += 500;
State.variables.chVal.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 250;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 250;
gC(&quot;chPlayerCharacter&quot;).changeInfamy(5);
finishSeBtif();
createRelTypeServitudeDom(&quot;chPlayerCharacter&quot;,&quot;chVal&quot;,3);
createRelTypeServitudeSub(&quot;chVal&quot;,&quot;chPlayerCharacter&quot;,3);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="288" name="SE BKIF Val Defeats Player Humilliation" tags="" position="5618,800" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Valtan, please don&#39;t...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;This is my prize for winning, remember? Besides, watching Nash getting punished will do you no good.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I undertand.&quot;//&lt;/span&gt;

And so, you allow Valtan to take you far away from the rest.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Come down here.&quot;//&lt;/span&gt; She says as she sits next to a tree. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;Massage my ankles, my dear.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Fine.&quot;//&lt;/span&gt;

You kneel in front of the Shapeshifter and take one of her feet in your hands. Her skin is highly malleable, and you can push it to unreasonable shapes if you apply enough strength. She seems to like it, however.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Why did you have to side with Claw?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;If no one did, you would have been asking for a challenge of two versus one. That wasn&#39;t acceptable and you would have been left ridiculed. And also...&quot;//&lt;/span&gt;

You look at Val&#39;s face, intrigued.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I didn&#39;t tell you to stop your hands.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh, sorry.&quot;//&lt;/span&gt; You continue caressing and working her lower legs, rising an inch from time to time. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What was your other reason?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;How do you think it looked on Claw&#39;s view?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I don&#39;t follow you.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Nashillbyir lashes out against her, getting so angry that she demands her to change her attitude, which seems to be something deeply ingrained within her. Then someone else intervenes, and it&#39;s to side with Nash. There&#39;s also Padmiri, who you can always count to be against Claw&#39;s positions... See where I&#39;m going now?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You think she would feel cornered by us?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Precisely. And continue with my thighs.&quot;//&lt;/span&gt; The goo-girl opens her legs wide open, inviting you to position yourself between them, and you comply.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What I did is not a perfect solution, but as long as she sees all of us being hostile or indifferent towards her, she will feel vindicated in her position.&quot;//&lt;/span&gt; You feel her legs closing around your back.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I guess... That makes some sense... But wouldn&#39;t you have prefered if Claw had lost?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You&#39;re making a difficult case for it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh?&quot;//&lt;/span&gt;

The goo on your back expands, and you feel a gelatinous wall locking you in place. In front of you, Valtan advances and takes your lips between hers. Trapped between her legs and arms, you have no defense against the tongue penetrating your mouth.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;And I won&#39;t deny that I also wanted this.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Oh, damn y-&quot;//&lt;/span&gt; Your complaint gets interrupted when the Shapeshifter resumes her kiss.

//Claw&#39;s infamy has grown by 2.
Valtan&#39;s infamy has grown by 1.
Claw has gained 5 merit.
Valtan has gained 5 merit.
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Valtan has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chNash.relations.chClaw.submission.stv += 750;
State.variables.chClaw.relations.chNash.domination.stv += 750;
State.variables.chMir.relations.chClaw.enmity.stv += 500;
State.variables.chMir.relations.chClaw.rivalry.stv += 250;
State.variables.chMir.relations.chVal.enmity.stv += 100;
State.variables.chMir.relations.chVal.rivalry.stv += 100;
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 500;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 500;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 500;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 250;
gC(&quot;chClaw&quot;).changeMerit(5);
gC(&quot;chClaw&quot;).changeInfamy(2);
gC(&quot;chVal&quot;).changeMerit(5);
gC(&quot;chVal&quot;).changeInfamy(1);
finishSeBtif();
gC(&quot;chNash&quot;).socialAi.rivalTs = [&quot;chClaw&quot;];
gC(&quot;chClaw&quot;).socialAi.rivalTs = [&quot;chNash&quot;];
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="289" name="SE BKIF Val Defeats Player Sex" tags="" position="5618,902" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Valtan, please don&#39;t...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;This is my prize for winning, remember? Besides, watching Nash getting punished will do you no good.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I undertand.&quot;//&lt;/span&gt;

And so, you allow Valtan to take you far away from the rest.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Come down here.&quot;//&lt;/span&gt; She says as she sits next to a tree. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;Massage my ankles, my dear.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Fine.&quot;//&lt;/span&gt;

You kneel in front of the Shapeshifter and take one of her feet in your hands. Her skin is highly malleable, and you can push it to unreasonable shapes if you apply enough strength. She seems to like it, however.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Why did you have to side with Claw?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;If no one did, you would have been asking for a challenge of two versus one. That wasn&#39;t acceptable and you would have been left ridiculed. And also...&quot;//&lt;/span&gt;

You look at Val&#39;s face, intrigued.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I didn&#39;t tell you to stop your hands.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh, sorry.&quot;//&lt;/span&gt; You continue caressing and working her lower legs, rising an inch from time to time. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What was your other reason?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;How do you think it looked on Claw&#39;s view?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I don&#39;t follow you.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Nashillbyir lashes out against her, getting so angry that she demands her to change her attitude, which seems to be something deeply ingrained within her. Then someone else intervenes, and it&#39;s to side with Nash. There&#39;s also Padmiri, who you can always count to be against Claw&#39;s positions... See where I&#39;m going now?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You think she would feel cornered by us?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Precisely. And continue with my thighs.&quot;//&lt;/span&gt; The goo-girl opens her legs wide open, inviting you to position yourself between them, and you comply.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What I did is not a perfect solution, but as long as she sees all of us being hostile or indifferent towards her, she will feel vindicated in her position.&quot;//&lt;/span&gt; You feel her legs closing around your back.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I guess... That makes some sense... But wouldn&#39;t you have prefered if Claw had lost?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You&#39;re making a difficult case for it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh?&quot;//&lt;/span&gt;

The goo on your back expands, and you feel a gelatinous wall locking you in place. In front of you, Valtan advances and takes your lips between hers. Trapped between her legs and arms, you have no defense against the tongue penetrating your mouth.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;And I won&#39;t deny that I also wanted this.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Oh, damn y-&quot;//&lt;/span&gt; Your complaint gets interrupted when the Shapeshifter resumes her kiss.

//Claw&#39;s infamy has grown by 3.
Valtan&#39;s infamy has grown by 1.
Claw has gained 5 merit.
Valtan has gained 5 merit.
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Valtan has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chNash.relations.chClaw.submission.stv += 750;
State.variables.chClaw.relations.chNash.domination.stv += 750;
State.variables.chNash.relations.chClaw.sexualTension.stv += 250;
State.variables.chClaw.relations.chNash.sexualTension.stv += 250;
State.variables.chMir.relations.chClaw.enmity.stv += 500;
State.variables.chMir.relations.chClaw.rivalry.stv += 250;
State.variables.chMir.relations.chVal.enmity.stv += 100;
State.variables.chMir.relations.chVal.rivalry.stv += 100;
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 500;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 500;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 500;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 250;
gC(&quot;chClaw&quot;).changeMerit(5);
gC(&quot;chClaw&quot;).changeInfamy(3);
gC(&quot;chVal&quot;).changeMerit(5);
gC(&quot;chVal&quot;).changeInfamy(1);
finishSeBtif();
State.variables.sc.startScene(
	&quot;ss&quot;,&quot;fixed&quot;,[&quot;chClaw&quot;],[&quot;chNash&quot;],&quot;The big guy remains imperturbable.&quot;,endConditionTurns,40,
	&quot;SE SH II End NodeC Had Sex&quot;);
	State.variables.chClaw.hasLead = true;
	State.variables.chNash.hasLead = false;
	State.variables.sc.endSceneScript = processGenericSexSceneEffects;
	// Assign choices
	State.variables.chClaw.hasLead = true;
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.fixedTarget = &quot;chNash&quot;;
	State.variables.chClaw.aiAlgorythm.setRoleDomination();
State.variables.sc.autoResolveScene();
gC(&quot;chNash&quot;).socialAi.rivalTs = [&quot;chClaw&quot;];
gC(&quot;chClaw&quot;).socialAi.rivalTs = [&quot;chNash&quot;];
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="290" name="SE BKIF Val Defeats Player Servitude" tags="" position="5620,1007" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Valtan, please don&#39;t...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;This is my prize for winning, remember? Besides, watching Nash getting punished will do you no good.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I undertand.&quot;//&lt;/span&gt;

And so, you allow Valtan to take you far away from the rest.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Come down here.&quot;//&lt;/span&gt; She says as she sits next to a tree. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;Massage my ankles, my dear.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Fine.&quot;//&lt;/span&gt;

You kneel in front of the Shapeshifter and take one of her feet in your hands. Her skin is highly malleable, and you can push it to unreasonable shapes if you apply enough strength. She seems to like it, however.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Why did you have to side with Claw?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;If no one did, you would have been asking for a challenge of two versus one. That wasn&#39;t acceptable and you would have been left ridiculed. And also...&quot;//&lt;/span&gt;

You look at Val&#39;s face, intrigued.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I didn&#39;t tell you to stop your hands.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh, sorry.&quot;//&lt;/span&gt; You continue caressing and working her lower legs, rising an inch from time to time. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What was your other reason?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;How do you think it looked on Claw&#39;s view?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I don&#39;t follow you.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Nashillbyir lashes out against her, getting so angry that she demands her to change her attitude, which seems to be something deeply ingrained within her. Then someone else intervenes, and it&#39;s to side with Nash. There&#39;s also Padmiri, who you can always count to be against Claw&#39;s positions... See where I&#39;m going now?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You think she would feel cornered by us?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Precisely. And continue with my thighs.&quot;//&lt;/span&gt; The goo-girl opens her legs wide open, inviting you to position yourself between them, and you comply.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What I did is not a perfect solution, but as long as she sees all of us being hostile or indifferent towards her, she will feel vindicated in her position.&quot;//&lt;/span&gt; You feel her legs closing around your back.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I guess... That makes some sense... But wouldn&#39;t you have prefered if Claw had lost?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You&#39;re making a difficult case for it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh?&quot;//&lt;/span&gt;

The goo on your back expands, and you feel a gelatinous wall locking you in place. In front of you, Valtan advances and takes your lips between hers. Trapped between her legs and arms, you have no defense against the tongue penetrating your mouth.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;And I won&#39;t deny that I also wanted this.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Oh, damn y-&quot;//&lt;/span&gt; Your complaint gets interrupted when the Shapeshifter resumes her kiss.

A couple of minutes later, she speaks again: &lt;span @style=$chVal.colorStyleKey&gt;//&quot;Of course, you&#39;ll understand that I take my prize in full...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What do you mean?&quot;//&lt;/span&gt; 

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Claw did set the stakes up for a servitude relationship, didn&#39;t she?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Oh, no.&quot;//&lt;/span&gt; 

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Yes, my dear. You&#39;re going to be chasing my behind for a few days.&quot;//&lt;/span&gt;

//Claw&#39;s infamy has grown by 5.
Valtan&#39;s infamy has grown by 5.
Claw has gained 5 merit.
Valtan has gained 5 merit.
Nashillbyir will become Claw&#39;s servant for the next 3 days.
You will become Valtan&#39;s servant for the next 3 days.
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Valtan has grown a lot.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Valtan has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chNash.relations.chClaw.submission.stv += 750;
State.variables.chClaw.relations.chNash.domination.stv += 750;
State.variables.chMir.relations.chClaw.enmity.stv += 500;
State.variables.chMir.relations.chClaw.rivalry.stv += 250;
State.variables.chMir.relations.chVal.enmity.stv += 100;
State.variables.chMir.relations.chVal.rivalry.stv += 100;
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 750;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 750;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 500;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 250;
gC(&quot;chClaw&quot;).changeMerit(5);
gC(&quot;chClaw&quot;).changeInfamy(5);
gC(&quot;chVal&quot;).changeMerit(5);
gC(&quot;chVal&quot;).changeInfamy(5);
finishSeBtif();
createRelTypeServitudeDom(&quot;chClaw&quot;,&quot;chNash&quot;,3);
createRelTypeServitudeSub(&quot;chNash&quot;,&quot;chClaw&quot;,3);
createRelTypeServitudeDom(&quot;chVal&quot;,&quot;chPlayerCharacter&quot;,3);
createRelTypeServitudeSub(&quot;chPlayerCharacter&quot;,&quot;chVal&quot;,3);
gC(&quot;chClaw&quot;).socialAi.covetTs.push(&quot;chNash&quot;);
gC(&quot;chClaw&quot;).socialAi.rivalTs = [];
gC(&quot;chVal&quot;).socialAi.covetTs.push(&quot;chPlayerCharacter&quot;);
gC(&quot;chVal&quot;).socialAi.rivalTs = [];
gC(&quot;chNash&quot;).socialAi.rivalTs = [];
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="291" name="SE BKIF Claw Defeats Player Humilliation" tags="" position="5735,445" size="100,100">$customRoomIntro
Silence follows. You are in the ground, defeated. In front of you, you can see Claw&#39;s feet.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Fiercest Claw is the victor!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Get on your knees.&quot;//&lt;/span&gt;

You obey with some delay, understanding that no one is going to save you from this.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Don&#39;t avoid me. Look at my eyes.&quot;//&lt;/span&gt; With some effort, you comply. Claw looks down at you, smugly, and decides to grab your hair. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;And now, look at your friend.&quot;//&lt;/span&gt; And she forces you to look at Nashillbyir. The Ashwalker avoids your gaze. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Ask her to forgive you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m... Sorry. I wanted to help you and I&#39;ve disappointed you.&quot;//&lt;/span&gt; Even if you wanted to look somewhere else, Claw&#39;s hand won&#39;t allow you.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I hope you&#39;re happy, Ashwalker, letting someone else taking your fights for you. This is what happens when you avoid your responsibility.&quot;//&lt;/span&gt; When she&#39;s done talking, she pushes you head forward, almost causing you to fall to the ground. Luckily for you, she&#39;s satisfied with that.

//Claw&#39;s infamy has grown by 2.
Claw has gained 5 merit.
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Claw has grown a lot.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Nashillbyir has fallen.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your romance with Nashillbyir has fallen.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.submission.stv += 750;
State.variables.chClaw.relations.chPlayerCharacter.domination.stv += 750;
State.variables.chMir.relations.chClaw.enmity.stv += 500;
State.variables.chMir.relations.chClaw.rivalry.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv -= 250;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv -= 250;
State.variables.chPlayerCharacter.relations.chNash.romance.stv -= 250;
State.variables.chNash.relations.chPlayerCharacter.romance.stv -= 250;
gC(&quot;chClaw&quot;).changeMerit(5);
gC(&quot;chClaw&quot;).changeInfamy(2);
finishSeBtif();
gC(&quot;chClaw&quot;).socialAi.rivalTs = [&quot;chNash&quot;];
gC(&quot;chNash&quot;).socialAi.rivalTs = [&quot;chClaw&quot;];
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="292" name="SE BKIF Claw Defeats Player Sex" tags="" position="5733,557" size="100,100">$customRoomIntro
Silence follows. You are in the ground, defeated. In front of you, you can see Claw&#39;s feet.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Fiercest Claw is the victor!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Get on your knees.&quot;//&lt;/span&gt;

You obey with some delay, understanding that no one is going to save you from this.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Unlike someone else,&quot;//&lt;/span&gt; she makes a long pause. When you look up, she&#39;s looking at Nashillbyir. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You took responsability for this fight. That means you will also suffer its consequences.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I understand.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Then get up. We&#39;ll continue this in my room.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;$chPlayerCharacter.name, I&#39;m so sorry...&quot;//&lt;/span&gt; Nashillbyir says, coming close.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I lost, it&#39;s my own fault...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;But I shouldn&#39;t-&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Enough. $chPlayerCharacter.name is going to be busy for the time being. Let&#39;s get going.&quot;//&lt;/span&gt;

//Claw&#39;s infamy has grown by 3.
Claw has gained 5 merit.
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Claw has grown a lot.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Claw has grown slightly.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.submission.stv += 750;
State.variables.chClaw.relations.chPlayerCharacter.domination.stv += 750;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chMir.relations.chClaw.enmity.stv += 500;
State.variables.chMir.relations.chClaw.rivalry.stv += 250;
gC(&quot;chClaw&quot;).changeMerit(5);
gC(&quot;chClaw&quot;).changeInfamy(3);
finishSeBtif();
State.variables.sc.startScene(
	&quot;ss&quot;,&quot;fixed&quot;,[&quot;chPlayerCharacter&quot;],[&quot;chClaw&quot;],&quot;A lone dummy stands at the center of the room, severely injured. Someone&#39;s been scratching it.&quot;,endConditionTurns,30,
	&quot;Map&quot;);
	State.variables.chClaw.hasLead = true;
	State.variables.chPlayerCharacter.hasLead = false;
	State.variables.sc.endSceneScript = processGenericSexSceneEffects;
	// Assign choices
	State.variables.chClaw.aiAlgorythm = createAiWeightedMissionsByTaste();
	State.variables.chClaw.aiAlgorythm.fixedTarget = &quot;chPlayerCharacter&quot;;
	State.variables.chClaw.aiAlgorythm.setRoleDomination();
gC(&quot;chClaw&quot;).socialAi.rivalTs = [&quot;chNash&quot;];
gC(&quot;chNash&quot;).socialAi.rivalTs = [&quot;chClaw&quot;];
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.eventsCalendar.activeEvent = false;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="293" name="SE BKIF Claw Defeats Player Servitude" tags="" position="5733,665" size="100,100">$customRoomIntro
Silence follows. You are in the ground, defeated. In front of you, you can see Claw&#39;s feet.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Fiercest Claw is the victor!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Get on your knees.&quot;//&lt;/span&gt;

You obey with some delay, understanding that no one is going to save you from this.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Unlike someone else,&quot;//&lt;/span&gt; she makes a long pause. When you look up, she&#39;s looking at Nashillbyir. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You took responsability for this fight. That means you will also suffer its consequences.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I understand.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Swear fealty to me.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I...&quot;//&lt;/span&gt; You keep silent for a couple of seconds, waiting for a turn of events that is nowhere to be seen. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I swear loyalty to you, and I will obey you. For three days.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I hope you&#39;re happy with this.&quot;//&lt;/span&gt; When the Beastkin says this, she isn&#39;t looking at you.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;$chPlayerCharacter.name, I&#39;m so sorry...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I lost, it&#39;s my own fault...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;But I shouldn&#39;t-&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Enough. $chPlayerCharacter.name is going to be busy for the time being. Let&#39;s get going.&quot;//&lt;/span&gt;

//Claw&#39;s infamy has grown by 5.
Claw has gained 5 merit.
You will become Claw&#39;s servant for the next 3 days.
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Claw has grown a lot.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.submission.stv += 750;
State.variables.chClaw.relations.chPlayerCharacter.domination.stv += 750;
State.variables.chMir.relations.chClaw.enmity.stv += 500;
State.variables.chMir.relations.chClaw.rivalry.stv += 250;
gC(&quot;chClaw&quot;).changeMerit(5);
gC(&quot;chClaw&quot;).changeInfamy(5);
finishSeBtif();
createRelTypeServitudeDom(&quot;chClaw&quot;,&quot;chPlayerCharacter&quot;,3);
createRelTypeServitudeSub(&quot;chPlayerCharacter&quot;,&quot;chClaw&quot;,3);
gC(&quot;chClaw&quot;).socialAi.covetTs.push(&quot;chPlayerCharacter&quot;);
gC(&quot;chClaw&quot;).socialAi.rivalTs = [&quot;chNash&quot;];
gC(&quot;chNash&quot;).socialAi.rivalTs = [&quot;chClaw&quot;];
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="294" name="SE BKIF Nash Accepts Player Swap" tags="" position="5618,558" size="100,100">$customRoomIntro
Drishtya asks Padmiri and Maaterasu to retire, while Shrezdill leads you and Claw to take their places. You&#39;re soon facing one another, with the older Ashwalker between you.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;The first challenge of this generation of Candidates is about to begin! $chPlayerCharacter.name will battle Claw in order to force her to socialize more with everyone else. Is everyone ready?&quot;//&lt;/span&gt;

Claw nods silently, and so do you. Claw&#39;s back is curved, her head and torso heavily leaning towards you, like a giant feline about to leap on its prey.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Let the challenge begin!&quot;//&lt;/span&gt;

[[Continue|Scene]]
&lt;&lt;script&gt;&gt;
ccsBtifPlayerVsClawBattleInit();
State.variables.StVars.playerJoinedBkifBattle = true;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="295" name="SE BKIF Player Victory" tags="" position="5620,667" size="100,100">$customRoomIntro
Silence follows. Claw remains in the ground, defeated. It&#39;s still hard to believe that you could have brought her to such a vulnerable position, and yet she&#39;s right in front of your feet.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;$chPlayerCharacter.name is the victor!&quot;//&lt;/span&gt;

Padmiri sighs relieved. Valtan has a faint smile, her thoughts hard to decipher. Nashillbyir, when you spot her, is jumping straight to you.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You did it!&quot;//&lt;/span&gt; She says as she tackles you, taking you in a hug.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t be too rough! I&#39;m exhausted...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Haha!&quot;//&lt;/span&gt;

In the meantime, Claw has gotten up. Before she gets a chance to leave, you manage to get Nashillbyir off of you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wait.&quot;//&lt;/span&gt; You interrupt the Tiger-girl.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I know. I lost and I intend to keep my word.&quot;//&lt;/span&gt; Right after she finishes speaking, you notice her teeth gritting slightly.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, I hope you will. I think you&#39;ll find it&#39;s not so terrible. And also... Good fight.&quot;//&lt;/span&gt;

Claw looks to the side, unamused. She attempts to turn back, but stops immediately and faces you once more. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...Good fight.&quot;//&lt;/span&gt; And this time, she leaves for good.

//You have gained 5 merit.//
//Claw seems more open to socializing now.//
//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown slightly.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Nashillbyir has grown slightly.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Claw has grown slightly.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Claw has grown slightly.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.romance.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.romance.stv += 250;
State.variables.chPlayerCharacter.relations.chClaw.friendship.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.friendship.stv += 250;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 250;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 250;
gC(&quot;chPlayerCharacter&quot;).changeMerit(5);
gC(&quot;chClaw&quot;).baseMood.angry = 0;
gC(&quot;chClaw&quot;).mood.angry = 0;
finishSeBtif();
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="296" name="SE BKIF Player No Prize" tags="" position="5283,980" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...But I won&#39;t take a prize anyway.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You won&#39;t?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I only wanted to help Nash on this. I achieved it, and that&#39;s good enough to me.&quot;//&lt;/span&gt;

You look at the Ashwalker, and you both smile at each other.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Ah, what a wonderful day for the good-hearted!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;With that tone, anyone would think &#39;the good-hearted&#39; includes you.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;And it doesn&#39;t? You wound me.&quot;//&lt;/span&gt; Valtan feigns pain.

Claw has already started leaving. Maaterasu has stayed quiet during the whole incident, and, ever since the fight started, Drishtya and Shrezdill have limited themselves to observe, not wanting to interfere. Nashillbyir looks happy.

//&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Nashillbyir has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.romance.stv += 500;
State.variables.chNash.relations.chPlayerCharacter.romance.stv += 500;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 250;
finishSeBtif();
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="297" name="SE BKIF Outcome Start" tags="" position="5893,222" size="100,100">&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \
$customRoomIntro
&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Nashillbyir.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh, it&#39;s you. Yes, what is it?&quot;//&lt;/span&gt;

While you&#39;re on your way to the dining hall to start the day, you meet Maaterasu and Nashillbyir. They haven&#39;t noticed you just yet.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I do not understand your behavior from yesterday.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;My behavior...?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;You are usually a gregarious person. I had never seen you start a confrontation. Did anything change?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That...&quot;//&lt;/span&gt; The Ashwalker looks the other way for a moment. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;I was in a sour mood. That&#39;s all. Please don&#39;t worry about it.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

The Aiishen maintains the eye contact, but remains silent for a while.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;If you say so.&quot;//&lt;/span&gt; With that, Maaterasu turns around and greets you formally, but leaves to the dining hall without delay.

//Should I stop Nash and talk to her in private?//

&lt;&lt;link [[Do not disturb her|SE BKIF Outcome Valtan To Ambition]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;grandHall&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[Ask her about yesterday|SE BKIF Outcome Questioning Nash]]</tw-passagedata><tw-passagedata pid="298" name="Game End Past" tags="" position="5909,70" size="100,100">Thank you for playing the game! This is the end of all currently available story events, but you can keep playing if you want to keep enjoying the new mechanics.

If you&#39;re interested in knowing about the future features of Unholy Arts, you can check the last devlog post [[on itch.io|https://deepinteractivity.itch.io/unholy-arts/devlog/188744/new-features-after-v02]], and if you aren&#39;t doing it already, you can also support the development [[on Patreon|https://www.patreon.com/bePatron?u=31941037]]! Supporting the game will give you access to the latest Supporter builds, which include the Quickstart and Cheat Menus.

Have a good day and enjoy!

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="299" name="SE BKIF Outcome Questioning Nash" tags="" position="6001,220" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hey, Nash.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh, good morning, $chPlayerCharacter.name.&quot;//&lt;/span&gt;

[[&quot;I&#39;m curious about yesterday too&quot;|SE BKIF Outcome Questioning Nash Failed]]
[[&quot;Would you tell about yesterday to a friend?&quot;|SE BKIF Outcome Questioning Nash Friend Check]]
&lt;&lt;if $StVars.playerJoinedBkifBattle == true&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Story choices check: passed.&lt;/span&gt; [[&quot;I have the right to know about yesterday&quot;|SE BKIF Outcome Questioning Nash Right To Know]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Story choices check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="300" name="SE BKIF Outcome Questioning Nash Failed" tags="" position="6110,222" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I would like to know about yesterday too.&quot;//&lt;/span&gt;

She sighs.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;m sorry, but I would prefer not to talk about it.&quot;//&lt;/span&gt;

&lt;&lt;link [[Drop the matter|SE BKIF Outcome Valtan To Ambition]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;grandHall&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[&quot;Would you tell about yesterday to a friend?&quot;|SE BKIF Outcome Questioning Nash Friend Check]]
&lt;&lt;if $StVars.playerJoinedBkifBattle == true&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Story choices check: passed.&lt;/span&gt; [[&quot;I have the right to know about yesterday&quot;|SE BKIF Outcome Questioning Nash Right To Know]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Story choices check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="301" name="SE BKIF Outcome Questioning Nash Friend Check" tags="" position="5891,327" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wouldn&#39;t you even tell... me?&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.BkifNashRelScore &gt;= 5&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Relation check: passed.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;$chPlayerCharacter.name, I... &quot;//&lt;/span&gt; but she stops herself, and takes some air. She closes her eyes for a moment, then looks at you with decision. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Fine. I do want to let it out, and I think you&#39;re someone I can trust.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue|SE BKIF Outcome Nash Explanation]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;publicBaths&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Relation check: failed.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;$chPlayerCharacter.name, I... I&#39;m sorry. But this is something I&#39;d like to keep to myself.&quot;//&lt;/span&gt; Her expression conveys sorrow, but she&#39;s looking at you with decision. You probably can&#39;t change her mind.

&lt;&lt;link [[Continue|SE BKIF Outcome Valtan To Ambition]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;grandHall&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="302" name="SE BKIF Outcome Questioning Nash Right To Know" tags="" position="6000,327" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I have a right to know about why you challenged Claw. I took a risk for your sake, after all.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...That&#39;s true, but-&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nash. Please.&quot;//&lt;/span&gt; You cut her plainly.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...Fine. If I&#39;m honest, I want to let it out, after all.&quot;//&lt;/span&gt; And she gives up.

&lt;&lt;link [[Continue|SE BKIF Outcome Nash Explanation]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;publicBaths&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="303" name="SE BKIF Outcome Nash Explanation" tags="" position="6104,328" size="100,100">$customRoomIntro
Your peer wants some privacy before she explains herself, so you agree to move to the baths, which should be empty.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Since I was a small kid, I always admired my tribe&#39;s warriors. I was fascinated by their speed and strength, by the respect they caused. That much isn&#39;t uncommon for Ashwalker children, and even though many follow their steps, that enthusiasm always falls when they understand the discipline it takes to become strong. ...Except for me.&quot;//&lt;/span&gt;

She pauses. She seems to be calculating her next words.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I got to love it. Training every day to become ever faster, constantly sparring to understand my weak spots, to learn how to respond to every strike, to catch every feint. It became a passion that guided my life, and I was certain that it was the path I wanted to follow through my whole life. And yet...&quot;//&lt;/span&gt;

Her face twitches. The truth that wants to leave her mouth brings her pain.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I felt... Alone.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Alone? Like no one understood you?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That... Could be a way to put it. I have difficulty to explain this. I&#39;ve told no one yet.&quot;//&lt;/span&gt;

[[Continue|SE BKIF Outcome Nash Explanation 2]]
&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;publicBaths&quot;);&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="304" name="SE BKIF Outcome Nash Explanation 2" tags="" position="6216,278" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Perhaps I felt that no one really got me, perhaps it was because it looked like I was alone in my path. In any case, I wanted to meet someone that could make me feel like I was... Not so annoyingly unique. It wasn&#39;t like I was treated badly by the other kids, but I felt that there was an unbeatable distance between them and me... And the way to become a Candidate in my tribe was to beat the other women, so I thought the Candidates from the other tribes would have to do something similar, right? They would have to be people with determination. People with drive. People who would like to fight too.&quot;//&lt;/span&gt;

//I feel like I&#39;m being called out.//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And when I came here... Padmiri was a good person, but her main concern is looking after the Valley. Valtan only wants to get into everyone&#39;s pants, Maaterasu is a closed, impenetrable book, you... You&#39;re fine, but you don&#39;t share my motivations either. And Claw...&quot;//&lt;/span&gt; Her fist is trembling. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Claw could have been that person! She only wants to be stronger than anyone else, to the point that she won&#39;t even bother to talk to anyone, and she&#39;s capable of living up to that goal. But... But I HATE her! I...&quot;//&lt;/span&gt; A couple of tears have formed in her eyes.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nash! It&#39;s fine, calm down...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I hate it... I hate this...&quot;//&lt;/span&gt;

You hold Nash&#39;s shoulder, and treat her with patience. It takes a while, but she&#39;s slowly crying her sadness away.

[[Console Nash|SE BKIF Outcome Sorry With Nash]]
&lt;&lt;if $StVars.check1 == true&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Physique affinity OR agility affinity OR resilience affinity check: passed.&lt;/span&gt; [[She shouldn&#39;t underestimate you|SE BKIF Outcome Dont Underestimate Me]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Physique affinity OR agility affinity OR resilience affinity check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check2 == true&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Will check: passed.&lt;/span&gt; [[There&#39;s no better company than oneself|SE BKIF Outcome Company Of Oneself]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Will check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check3 == true&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Intelligence OR empathy OR luck check: passed.&lt;/span&gt; [[It&#39;s wise to temper your expectations|SE BKIF Outcome Cold Expectatives]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Intelligence OR empathy OR luck check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check5 == true&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Physique OR agility OR empathy check: passed.&lt;/span&gt; [[Perhaps Nash was unfair to others in her tribe|SE BKIF Outcome Unfair To Tribesmen]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Physique OR agility OR resilience check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check4 == true&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Special relationship check: passed.&lt;/span&gt; [[Ask her to train you|SE BKIF Outcome Ask Her To Train You]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Special relationship check: failed. You need to be free of dominant and submissive relationships, and Nash needs not to be in any submissive relationship.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="305" name="SE BKIF Outcome Sorry With Nash" tags="" position="6321,222" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How are you feeling now?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I think I&#39;m relaxed now. Perhaps I needed this... So thank you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It was nothing.&quot;//&lt;/span&gt;

Despite your words, you feel incredibly uncomfortable. You&#39;re not certain you&#39;re even being that helpful. You wish you knew the magic words that would immediately make her feel better, and the silence only makes your frustration grow.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Maybe I&#39;ve just given far too much thought to all of this, don&#39;t you think? If I was so determined to meet my goal... Perhaps I should just embrace the pain it brings me.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nash...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And becoming a Candidate was a good step in that direction. If anything, I should feel some shame that I had such bad reasons in mind.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You don&#39;t need to be so harsh with yourself. If that was what you had in mind when you took your decision, then it surely was something important to you at the time. And that&#39;s all that matters.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I hope you&#39;re right.&quot;//&lt;/span&gt; The Ashwalker takes some water from the bath to clean her face. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;You won&#39;t tell anyone about this, right?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Of course not!&quot;//&lt;/span&gt;

She exhales some air, feeling relieved. After that, you finally go to take your breakfast.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown slightly.&lt;/span&gt;

Nashillbyir&#39;s views have grown more favorable to self-improvement and ambition, and less favorable to love.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 250;
addPointsToDrive(gC(&quot;chNash&quot;).dImprovement,250);
addPointsToDrive(gC(&quot;chNash&quot;).dAmbition,350);
addPointsToDrive(gC(&quot;chNash&quot;).dLove,-350);
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|SE BKIF Outcome Valtan To Ambition]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;grandHall&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="306" name="SE BKIF Outcome Dont Underestimate Me" tags="" position="6426,220" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t you think you&#39;re underestimating me though?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What do you mean?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I mean that I&#39;m not you or Claw, but I can handle myself in a sparring too.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Um.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And I wasn&#39;t raised at a tribe where people train to become warriors since they&#39;re children! Who knows if I wouldn&#39;t be cleaning the floor with your ass if I had been born an Ashwalker?&quot;//&lt;/span&gt;

Nashillbyir doesn&#39;t respond, but she&#39;s smiling. You aren&#39;t sure if she&#39;s happy or amused.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m serious, you know!?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hahaha!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What&#39;s so funny!?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Your serious face is funny.&quot;//&lt;/span&gt; She gets up, not waiting for your response. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Who knows? Perhaps you&#39;re right. What if I was having a tantrum over the person Claw isn&#39;t, when the person I was looking for could be someone else?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s right, you better watch your step while I&#39;m around, because I&#39;m going to make sure you&#39;re not &#39;annoyingly unique&#39;.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You better remember your words!&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown a lot.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Nashillbyir has grown a lot.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Nashillbyir has grown a lot.&lt;/span&gt;

Nashillbyir&#39;s views have grown more favorable to love and ambition.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 750;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 750;
State.variables.chPlayerCharacter.relations.chNash.romance.stv += 750;
State.variables.chNash.relations.chPlayerCharacter.romance.stv += 750;
State.variables.chPlayerCharacter.relations.chNash.rivalry.stv += 750;
State.variables.chNash.relations.chPlayerCharacter.rivalry.stv += 750;
addPointsToDrive(gC(&quot;chNash&quot;).dAmbition,300);
addPointsToDrive(gC(&quot;chNash&quot;).dLove,300);
gC(&quot;chNash&quot;).socialAi.conquestTs.push(&quot;chPlayerCharacter&quot;);
gC(&quot;chNash&quot;).socialAi.loveTs.push(&quot;chPlayerCharacter&quot;);
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|SE BKIF Outcome Valtan To Ambition]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;grandHall&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="307" name="SE BKIF Outcome Company Of Oneself" tags="" position="6530,220" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nash... If you aren&#39;t able to feel accompanied by others, perhaps you should first learn to enjoy your own company.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;My own company?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Stay quiet. Don&#39;t you feel your heart beating? The air running through your chest, through your throat?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I do.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s a human being, and one that will be with accompany you through your whole life. And that&#39;s probably the person who will always understand you the most.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Isn&#39;t that... Sad?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Perhaps it is. But something even sadder than that is not being able to appreciate yourself. Not being able to tell yourself that there&#39;s at least one person that will always care about you. That doesn&#39;t mean you shouldn&#39;t seek the company of others, but if you learn to be at ease with yourself, you&#39;ll be stronger against loneliness.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...Maybe you&#39;re right.&quot;//&lt;/span&gt;

Nash&#39;s face is cold, perhaps meditative. After she cleans her face, you finally go to take breakfast.

//Nashillbyir&#39;s views have grown less favorable to love and cooperation.//

&lt;&lt;link [[Continue|SE BKIF Outcome Valtan To Ambition]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;grandHall&quot;);
addPointsToDrive(gC(&quot;chNash&quot;).dLove,-350);
addPointsToDrive(gC(&quot;chNash&quot;).dCooperation,-350);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="308" name="SE BKIF Outcome Cold Expectatives" tags="" position="6323,329" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I can see why that would be painful.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How long have you been feeling like this? Months? Years?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Perhaps... About three years.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So you&#39;ve been feeling alone for years, placed all your expectatives in meeting an ideal person when you came here, and not even this worked.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Yeah...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And don&#39;t you think you were demanding far too much from life? Sometimes it&#39;s risky to trust your well-being to another person, but to trust your well-being to people you know nothing about...?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I felt like I had to hold onto something. ...But I see what you mean.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It must have been tough. But tempering your expectations would have probably saved you pain.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

Nash keeps her eyes closed, meditating.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You&#39;re right. It was... Not very mature of me.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t be harsh on yourself. The good part of this is that you&#39;ll wake up tomorrow being a bit wiser.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Thanks for your words. And your time.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown.&lt;/span&gt;

Nashillbyir&#39;s views have grown more favorable to cooperation.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 500;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 500;
addPointsToDrive(gC(&quot;chNash&quot;).dCooperation,300);
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|SE BKIF Outcome Valtan To Ambition]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;grandHall&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="309" name="SE BKIF Outcome Unfair To Tribesmen" tags="" position="6426,327" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hey, Nash... I&#39;m sorry about this, but I feel like I have to question you on something.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Huh?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m definitely not you, or Claw, but I&#39;m not that weak either. Perhaps I don&#39;t share your motivation, but I&#39;m not someone who lazes around without trying to improve myself. And if I&#39;m not good enough... Perhaps you aren&#39;t being fair.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt; Nash remains silent, perhaps considering if you&#39;re right, perhaps without strength to voice her disagreement.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Many Ashwalkers end up becoming warriors, don&#39;t they? And they don&#39;t exactly go out to fight monsters without knowing how to swing a blade. I don&#39;t doubt they&#39;re not as driven and determined as you are, but that doesn&#39;t mean none of them have those qualities, to some degree. I think your problem is not truly not meeting anyone that meets your expectations, but underestimating the people you do know. And if I&#39;m right, you will always have that problem, as long as you don&#39;t change.&quot;//&lt;/span&gt;

She still does not reply, but her expression has worsened. 

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How are you feeling?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Not good.&quot;//&lt;/span&gt; A short but tense silence follows. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;But I will think about your words. Perhaps the problem is something with me, after all...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nash, I understand this hurts you... But I think it was something you had to hear.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And I value your honesty.&quot;//&lt;/span&gt;

//She&#39;s definitely not happy.//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I think I&#39;m feeling better now. Should we go to have breakfast?&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown slightly.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 250;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|SE BKIF Outcome Valtan To Ambition]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;grandHall&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="310" name="SE BKIF Outcome Ask Her To Train You" tags="" position="6531,327" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hey, if it&#39;s so important for you to have someone who shares your path... How about you train me?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Train you?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Perhaps this is something strange to ask to another Candidate, but wouldn&#39;t you like it if I managed to understand your passion? And I&#39;m sure I have a lot to learn from you.&quot;//&lt;/span&gt;

Nashillbyir remains silent, serious, considering the idea, then she replies: &lt;span @style=$chNash.colorStyleKey&gt;//&quot;I like the idea.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You do?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Absolutely! But I won&#39;t be letting you back down now.&quot;//&lt;/span&gt; Nash gets up and brushes the tears off her face. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;No, I&#39;ll make sure you give everything you&#39;ve got! Come, let&#39;s go get breakfast, you&#39;re going to need to be full if you want to survive me!&quot;//&lt;/span&gt;

//Ah, there she goes... Was this really a good idea? At least she looks happy.//

//Nashillbyir will be your tutor for three days.
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has grown a lot.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Nashillbyir has grown a lot.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Nashillbyir has grown a lot.&lt;/span&gt;

Nashillbyir&#39;s views have grown more favorable to love, cooperation, domination and ambition.//

&lt;&lt;script&gt;&gt;
createRelTypeTutorshipDom(&quot;chNash&quot;,&quot;chPlayerCharacter&quot;,3);
createRelTypeTutorshipSub(&quot;chPlayerCharacter&quot;,&quot;chNash&quot;,3);
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 750;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 750;
State.variables.chPlayerCharacter.relations.chNash.romance.stv += 750;
State.variables.chNash.relations.chPlayerCharacter.romance.stv += 750;
State.variables.chPlayerCharacter.relations.chNash.submission.stv += 750;
State.variables.chNash.relations.chPlayerCharacter.domination.stv += 750;
addPointsToDrive(gC(&quot;chNash&quot;).dAmbition,150);
addPointsToDrive(gC(&quot;chNash&quot;).dAmbition,100);
addPointsToDrive(gC(&quot;chNash&quot;).dCooperation,150);
addPointsToDrive(gC(&quot;chNash&quot;).dLove,200);
gC(&quot;chNash&quot;).socialAi.covetTs.push(&quot;chPlayerCharacter&quot;);
gC(&quot;chNash&quot;).socialAi.loveTs.push(&quot;chPlayerCharacter&quot;);
&lt;&lt;/script&gt;&gt; \
&lt;&lt;link [[Continue|SE BKIF Outcome Valtan To Ambition]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;grandHall&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="311" name="SE BKIF Outcome Valtan To Ambition" tags="" position="5889,440" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;)]);
setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;grandHall&quot;);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
Save for Nashillbyir, who seems to be lost in her thoughts, you&#39;re the last one to finish your food. You decide not to lose any more time and head out, but you spot Valtan entering the Ambition Corridor while you&#39;re on your way.

//Where is she going?//

&lt;&lt;if $StVars.drishtyaSawVaryonteMoves == true&gt;&gt; \
&lt;&lt;link [[Dismiss it and start your training|SE BKIF Outcome Drishtya Interrogation]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;mainLibrary&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;else&gt;&gt; \
&lt;&lt;link [[Dismiss it and start your training|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.eventsCalendar.activeEvent = false;
setNoPasChars();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.clawLostBkif == true&gt;&gt; \
&lt;&lt;link [[Spy on Valtan|SE BKIF Outcome Valtan and Claw after Defeat]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;ambitionCorridor&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;else&gt;&gt; \
&lt;&lt;link [[Spy on Valtan|SE BKIF Outcome Valtan and Claw after Victory]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;ambitionCorridor&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="312" name="SE BKIF Outcome Valtan and Claw after Victory" tags="" position="5998,442" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);
setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;grandHall&quot;);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
You take a look at the Ambition Corridor and find Valtan walking towards Claw, but you walk back before you&#39;re seen. Waiting at the stairs leading to the corridor may allow you to hear them out.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;There you are. What did you want to discuss?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I wanted to congratulate you, of course. You just got the lead in this competition, it&#39;s only natural that I want to be in your good graces.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Very funny. What do you really want?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You think I have further intentions? Oh, Claw, you&#39;re not only strong, but also sharp. How unfortunate of me if you ever got to trust me.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Do you really want to try my patience?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Goddess, no. I merely wanted to offer you... Some friendly advice.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Speak, then.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Even though you won yesterday, I think you should give in to Nashillbyir&#39;s demand.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;If everyone had your attitude, you would definitely be in the best position to win. In a fair competition where everyone fights everyone, it&#39;s natural for the strongest one to beat the others. But those aren&#39;t the rules of this game. What happened if a few of the other Candidates decided to ally against you?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;If all of you fought me at once, I would lose.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Precisely. And as things are right now, you&#39;re pushing the others towards that decision.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;And wasting time in talking to you...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;...Would do wonders in improving your image, reducing the animosity you&#39;ve been gathering. I&#39;m not questioning your goals or your values, but I think you can easily understand that you&#39;re on the way to create needless obstacles for yourself.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You&#39;re right.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I knew you&#39;d be reasonable. Shall we leave?&quot;//&lt;/span&gt;

//I have to leave now if I don&#39;t want them to find me.//

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmm...&quot;//&lt;/span&gt;

//Claw seems more open to socializing now.//

&lt;&lt;script&gt;&gt;
State.variables.chVal.relations.chClaw.friendship.stv += 250;
State.variables.chClaw.relations.chVal.friendship.stv += 250;
State.variables.chVal.relations.chClaw.sexualTension.stv += 100;
State.variables.chClaw.relations.chVal.sexualTension.stv += 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;if $StVars.drishtyaSawVaryonteMoves == true&gt;&gt; \
&lt;&lt;link [[Leave|SE BKIF Outcome Drishtya Interrogation]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;mainLibrary&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;else&gt;&gt; \
&lt;&lt;link [[Leave|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.eventsCalendar.activeEvent = false;
setNoPasChars();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="313" name="SE BKIF Outcome Valtan and Claw after Defeat" tags="" position="6106,440" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);
setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;grandHall&quot;);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
You take a look at the Ambition Corridor and find Valtan walking towards Claw, but you walk back before you&#39;re seen. Waiting at the stairs leading to the corridor may allow you to hear them out.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;There you are. What did you want to discuss?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You actually came. I&#39;m glad to see you&#39;re taking so seriously your new... Obligations.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;If you&#39;ve called me here to mock me...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Me, mocking someone? You must be mistaking me for my twin sister.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;That&#39;s it, you...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Wait, wait. What I really wanted to tell you is that you should take advantage of this opportunity.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Explain yourself.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;The competition for the High Priestesshood isn&#39;t something you should expect to win on your own. Let&#39;s say you&#39;re the strongest of us all, let&#39;s say you won yesterday&#39;s challenge, where would that put you?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;At the lead.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;That&#39;s where you&#39;re wrong. Having the lead without allies is a mistake: since everyone&#39;s goal is coming out on top, being perceived as the strongest of the six is likely to make you the target of everyone else, even more so if your attitude has made you antagonize everyone.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Are you saying my defeat yesterday benefits me? That makes no sense.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I&#39;m saying,&quot;//&lt;/span&gt; Valtan replies, &lt;span @style=$chVal.colorStyleKey&gt;//&quot;that you should be looking at it as an opportunity. Now that you&#39;ll be spending more time with us, try to repair your image so that the others don&#39;t perceive you as a sworn enemy.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...And what do you win from this, again? Don&#39;t expect me to believe that you&#39;re doing this out of sheer generosity.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Who knows? Fufufu. That&#39;s all I had to say. I trust you&#39;ll find my advice useful.&quot;//&lt;/span&gt;

//I have to leave now or they will spot me.//

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You won&#39;t answer me? Scheming witch...&quot;//&lt;/span&gt;

&lt;&lt;script&gt;&gt;
State.variables.chVal.relations.chClaw.friendship.stv += 250;
State.variables.chClaw.relations.chVal.friendship.stv += 250;
State.variables.chVal.relations.chClaw.sexualTension.stv += 100;
State.variables.chClaw.relations.chVal.sexualTension.stv += 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;if $StVars.drishtyaSawVaryonteMoves == true&gt;&gt; \
&lt;&lt;link [[Leave|SE BKIF Outcome Drishtya Interrogation]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;mainLibrary&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;else&gt;&gt; \
&lt;&lt;link [[Leave|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.eventsCalendar.activeEvent = false;
setNoPasChars();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="314" name="SE BKIF Outcome Drishtya Interrogation" tags="" position="5888,550" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
But a voice stops you on your way to the Temple&#39;s outdoors.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Wait a moment, $chPlayerCharacter.name. I wish to speak with you.&quot;//&lt;/span&gt;

//It&#39;s Drishtya.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Greetings, Priestess Regent.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Greetings. Let&#39;s move to a corner.&quot;//&lt;/span&gt;

And so you follow her to a remote spot of the library, without any explanations. She continues talking in a much lower volume.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Regarding yesterday&#39;s fight... You used a strange technique. Where did you learn about it? As far as I&#39;m aware, you didn&#39;t learn any magic before you came to the Temple. Am I correct?&quot;//&lt;/span&gt;

//Does she mean... The moves I learned from Varyonte?//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;No, I didn&#39;t learn magic before I came to the Temple. The technique from yesterday... I&#39;m not sure? Perhaps it was a dream?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That&#39;s an extremely strange response.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Why?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;...Nevermind. I have some matters I need to check. I&#39;m sorry I troubled you, carry on with your day.&quot;//&lt;/span&gt;

//...That was worrying... Should I have told her the whole truth?//

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="315" name="SE Aspiring TC Start" tags="" position="5886,669" size="100,100">&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \
$customRoomIntro
A soft wind agitates the trees&#39; branches, filling your ears with a gentle wheeze.

While you move your eyes through the tall flora, your vision meets with an unexpected shape: Claw is crouching at the top of a branch, looking at a tree in front of her.

The wind and its floral percussion get invigorated, and the elusive shadow turns into a flying shape that jumps from tree to tree. Now that you&#39;ve turned your attention to it, your ears recognize the noise of the foilage shaken by her moves.

The beastkin offers you a look, acknowledging your presence, but shortly later returns her attention to her exercises.

[[Ask her what she&#39;s doing|SE Aspiring TC Checking on Claw]]
&lt;&lt;link [[Leave her alone|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.eventsCalendar.activeEvent = false;
setNoPasChars();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="316" name="SE Aspiring TC Checking on Claw" tags="" position="5996,667" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Lost anything up there?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...Yes, my breakfast fell off my hands up to the trees.&quot;//&lt;/span&gt; She replies after a short pause.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What are you doing, exactly?&quot;//&lt;/span&gt; You ask again, after you decide to ignore her bitter sarcasm.

Claw remains quiet for a few short, tense seconds, then sighs and replies: &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;m practicing how to move through rough terrain.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Just like you did when we met in the forests outside the Temple.&quot;//&lt;/span&gt; You point out.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Precisely.&quot;//&lt;/span&gt;

[[Give it a try as well|SE Aspiring TC Try Climbing]]
[[Stay and watch|SE Aspiring TC Stay and Observe]]
[[Leave|SE Aspiring TC Leave Early]]</tw-passagedata><tw-passagedata pid="317" name="SE Aspiring TC Leave Early" tags="" position="6105,670" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Good luck with that.&quot;//&lt;/span&gt; You say dryly.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmm.&quot;//&lt;/span&gt;

For one reason or another, you&#39;re not that interested in her endeavors, so you leave Claw alone in her training.

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="318" name="SE Aspiring TC Stay and Observe" tags="" position="6216,670" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Then I&#39;ll stay and watch. If it&#39;s something you can use against me, I want to learn about it.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

//Perhaps I shouldn&#39;t have expressed it so plainly?//

If the idea that she shouldn&#39;t allow you to learn about her methods passed through her mind, Claw dismissed it.

Moments later, she was crouching again, putting her eyes in the next branch. This time she didn&#39;t wait for the wind to gain intensity. She placed her hands against the wood, and coordinated both arms and legs to push herself forward, making a powerful jump. Her landing was graceful and precise, save for her tail, which moved wildly for half a second, and the beastkin immediately moved closer to the trunk.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Were you trying to mask the sound of your jump with the wind earlier?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You noticed?&quot;//&lt;/span&gt;

You nod.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;m not doing this just for sport. Moving through impossible paths is a great tool when you&#39;re hunting. Or when you&#39;re being hunted. In those situations, not being heard is just as important as not being seen.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Have you hunted a lot?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Yes. I&#39;ve been hunting since I was thirteen.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Since you were that young? That sounds dangerous.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;It was. The forests where my tribe lives is rich in game, but so it is in monsters.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And they allowed you to run that risk?&quot;//&lt;/span&gt;

Claw meditates for a while, then replies. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...It builds character. Some saw it like you, not too many. But most of my people finds it courageous, and a mark of your worth.&quot;//&lt;/span&gt;

//That sounds too ruthless for such a small girl...// You think, without the words ever leaving your mouth.

//You have gained 250 perception experience.
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Claw has grown slightly.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;gC(&quot;chPlayerCharacter&quot;).perception.addExperience(1000);State.variables.chPlayerCharacter.relations.chClaw.friendship.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.friendship.stv += 150;&lt;&lt;/script&gt;&gt; \

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="319" name="SE Aspiring TC Try Climbing" tags="" position="5885,779" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m going to do that too.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;What, you?&quot;//&lt;/span&gt; She asks, stunned.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Got any problem with that?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;No, not at all. You&#39;ll fall and break a few bones, but that doesn&#39;t trouble me.&quot;//&lt;/span&gt; She jumps off the tree, without much thought, and lands gracefully. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;In fact, I want to watch you try.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hmpf.&quot;//&lt;/span&gt;

//I&#39;m going to make you eat your words.// You think to yourself, while you walk towards the tree she&#39;s just descended from.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;No, try... this one, instead.&quot;//&lt;/span&gt; She says, pointing to a different tree.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Why?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Its trunk has a rougher surface, it&#39;ll be easier for you to hold onto it as you climb.&quot;//&lt;/span&gt;

The advice is unexpected, but you don&#39;t refuse it. You take a good look at the branch you&#39;re aiming for, which is merely about two and a half meters above the ground. You grab the wood, and start climbing.

&lt;&lt;if $StVars.check2 == false&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Physique AND resilience AND agility check: failed.&lt;/span&gt;

Just as your feet leave the ground, you start to realize the actual difficulty of your task. It&#39;s hard enough to grab segments of wood that allow you to get a good grip - but it&#39;s even harder to correctly position your feet, since you can&#39;t get a good look at where you&#39;re placing them. A wrongly placed hand or foot might provoke you to fall shortly later.

And that&#39;s exactly what happens when you&#39;re about to reach the branch with your hand. The fall is ugly and the taste of pain comes spiced with defeat, but fortunately you didn&#39;t suffer severe damage.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Huh. I expected you to manage to climb the tree, at least. Whatever.&quot;//&lt;/span&gt;

And the tiger-girl leaves you alone in the ground.

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;30 energy&lt;/span&gt;.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 30;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Physique AND resilience AND agility check: passed.&lt;/span&gt;

Just as your feet leave the ground, you start to realize the actual difficulty of your task. It&#39;s hard enough to grab segments of wood that allow you to get a good grip - but it&#39;s even harder to correctly position your feet, since you can&#39;t get a good look at where you&#39;re placing them. A wrongly placed hand or foot might provoke you to fall shortly later.

But you manage to grab the branch. Your next movements require a lot of effort, but you successfully manage to climb the tree.

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;15 energy&lt;/span&gt;.//

[[Continue|SE Aspiring TC Above the tree]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 15;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="320" name="SE Aspiring TC Above the tree" tags="" position="5993,779" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ha, I made it!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Yes, you made the first half.&quot;//&lt;/span&gt;

//You gained 250 resilience experience.//

You look around you. A sea of leaves and branches surrounds you. You also take a look below you, and the reality that falling from this height will not come without pain starts to sink in.

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;5 willpower&lt;/span&gt;.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 5;
gC(&quot;chPlayerCharacter&quot;).resilience.addExperience(250);
&lt;&lt;/script&gt;&gt; \

Claw is looking at you, her arms crossed. You take your eyes back to your height, and you find a branch that is actually pretty close. The jump, however, will not come without risks.

[[Jump to the next branch|SE Aspiring TC Jump to Next Tree]]
[[Jump on Claw|SE Aspiring TC Jump on Claw]]
[[You&#39;ve done enough, call it a day|SE Aspiring TC Chicken out]]</tw-passagedata><tw-passagedata pid="321" name="SE Aspiring TC Chicken out" tags="" position="6105,780" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...And I&#39;ll get the second part done too, just not today!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Are you chickening out? After you made it this far?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I am!&quot;//&lt;/span&gt; By the time you say this, you&#39;re already hugging the tree you&#39;ve just climbed, and looking for a route down.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I should have expected it.&quot;//&lt;/span&gt; She sighs. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Try not to waste my time next time.&quot;//&lt;/span&gt;

When you&#39;re back to the safe feeling of having ground under your feet, Claw has already left.

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="322" name="SE Aspiring TC Jump to Next Tree" tags="" position="6215,777" size="100,100">$customRoomIntro
You set your sight on your next goal: a branch less than two meters away, but the longest two meters that you&#39;ve ever seen. Your hands tremble.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Breath calmly. Focus on your legs.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I-I&#39;m calm.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Sure, you are. Ah, it&#39;s logical that you&#39;re afraid. You humans don&#39;t even have a tail. What a waste.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Why would I need a tail?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;To maintain your balance, of course.&quot;//&lt;/span&gt;

You mumble some curses to yourself.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Stand up, and do your best not to lose your balance. When you feel secure, make the jump.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Didn&#39;t you push yourself with your arms too?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I know how to do it. You don&#39;t, so you better stick to jumping like a human.&quot;//&lt;/span&gt;

//I&#39;m so going to strangle you...//

&lt;&lt;if $StVars.check3 == false&gt;&gt; \
[[Make the jump|SE Aspiring TC Failed Jump]]
&lt;&lt;else&gt;&gt; \
[[Make the jump|SE Aspiring TC Successful Jump]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="323" name="SE Aspiring TC Jump on Claw" tags="" position="5890,937" size="100,100">$customRoomIntro
//What is learning to climb trees good for if I can&#39;t use it against someone else?//

With these thoughts in your mind, you crouch towards the end of your branch, closer to a nearby tree, but closer to Claw as well.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You should pick a different one, such as...&quot;//&lt;/span&gt;

//She can&#39;t even imagine my intentions, I won&#39;t get such a great chance again!//

And so, you let youself fall upon the tiger-girl.

Time stops, and it only advances in frozen images. The smallish aspect of Claw, getting bigger and bigger as you fall. She is looking and pointing at a tree, then she is turning her head, then she notices you, then her mouth falls wide open, in surprise.

&lt;&lt;if $StVars.check4 == false&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Physique AND agility AND perception AND luck check: failed.&lt;/span&gt;

Your arms and legs surround the beastkin, the whole weight of your torso about to fall upon her, but she grabs your arms and revolves around. Movements run fast before your eyes - so fast that you aren&#39;t entirely certain what was the order of events that ended with you pinned in the ground, below her.

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;30 energy&lt;/span&gt;.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 30;
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Aspiring TC Claws Revenge]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Physique AND agility AND perception AND luck check: passed.&lt;/span&gt;

Your arms and legs surround the beastkin, the whole weight of your torso about to fall upon her, and just as she&#39;s about to grab you, you grab her arms first, locking her in place and preventing her from evading the hit.

She cushions your fall, and ends up pinned in the ground below you, ready to react.

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;15 energy&lt;/span&gt;.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 15;
State.variables.chClaw.energy.current -= 15;
&lt;&lt;/script&gt;&gt; \

[[Hold her arms|SE Aspiring TC Hold Claw Down]]
&lt;&lt;if $StVars.check1 == &quot;hypnosis&quot;&gt;&gt; \
[[Hypnotize her|SE Aspiring TC Hypnotize Claw]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Locked:&lt;/span&gt; Unable to hypnotize.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check1 == &quot;draining&quot;&gt;&gt; \
[[Drain her|SE Aspiring TC Drain Claw]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Locked:&lt;/span&gt; Unable to drain.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check1 == &quot;bondage&quot;&gt;&gt; \
[[Bind her|SE Aspiring TC Bind Claw]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Locked:&lt;/span&gt; Unable to bind.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check9 == true&gt;&gt; \
[[Order her to stay quiet|SE Aspiring TC Order Claw]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Locked:&lt;/span&gt; Claw isn&#39;t submissive to you.
&lt;&lt;/if&gt;&gt; \
[[Back down|SE Aspiring TC Back Down]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="324" name="SE Aspiring TC Claws Revenge" tags="" position="5900,1112" size="100,100">$customRoomIntro
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;What the hell? Did you want to get us both injured?&quot;//&lt;/span&gt; She replies, her legs still keeping you pinned under her.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I... Was practicing hunting!&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check9 == false&gt;&gt; \
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hunting...? Tsch.&quot;//&lt;/span&gt;

She grabs your arms and pushes them against the ground.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Then I&#39;ll be giving you a lesson on what happens when you hunt so recklessly.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
aspiringTCdommedByClaw();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hunting...? Tsch.&quot;//&lt;/span&gt;

She gets up, leaving you free.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You&#39;re lucky I have to obey you today. Otherwise I&#39;d give you a real good lesson on what happens when you hunt so recklessly.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your domination towards Claw has fallen somewhat.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv -= 250;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv -= 250;
&lt;&lt;/script&gt;&gt; \

$eventsCalendar.finishEventButton
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="325" name="SE Aspiring TC Hold Claw Down" tags="" position="5998,894" size="100,100">$customRoomIntro
Anticipating her movements, you rush to hold Claw&#39;s arms and pin them. Of course, she trashes around, trying to throw you off, and...

&lt;&lt;if $StVars.check5 == false&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Physique AND resilience check: failed.&lt;/span&gt;

She&#39;s successful. So successful, in fact, that you&#39;re soon the one pinned down, her legs holding your waist and her hands grabbing your arms.

[[Continue|SE Aspiring TC Claws Revenge]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Physique AND resilience check: passed.&lt;/span&gt;

She fails. Perhaps due to her previous training, the hit of your fall, or because you&#39;re truly starting to catch up in strength, she&#39;s unable to push you away.

&lt;&lt;link [[She will be your prize|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
aspiringTCdommingClaw();
State.variables.sc.continuedActions.push(createCaHoldArms(&quot;chPlayerCharacter&quot;,[&quot;chClaw&quot;]));
State.variables.sc.formatScenePassage();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[Let her go|SE Aspiring TC Not Domming Claw]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="326" name="SE Aspiring TC Hypnotize Claw" tags="" position="6106,894" size="100,100">$customRoomIntro
Before she&#39;s able to react, you let your torso fall towards her own, bringing your faces closer, and cast an hypnotic stream from your eyes.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Let yourself go, give yourself to me.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check6 == false&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Will AND charisma check: failed.&lt;/span&gt;

But she avoids your gaze and shouts, breaking free of the trance. Claw revolves, and you&#39;re soon the one pinned down, her legs holding your waist and her hands grabbing your arms.

[[Continue|SE Aspiring TC Claws Revenge]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Will AND charisma check: passed.&lt;/span&gt;

And her eyes go blank, then turn back to normal - but she doesn&#39;t have the will to defy you anymore.

&lt;&lt;link [[She will be your prize|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chClaw.willpower.current -= 10;
aspiringTCdommingClaw();
applyAlteredState([&quot;chClaw&quot;],createAShypnosisStroke(2));
State.variables.sc.formatScenePassage();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[Let her go|SE Aspiring TC Not Domming Claw]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="327" name="SE Aspiring TC Bind Claw" tags="" position="6216,894" size="100,100">$customRoomIntro
You move your hands above your head, channeling magic, while your whole body weights against her own, and your gaze weights on her eyes. She gets ready to push you off her, and...

&lt;&lt;if $StVars.check7 == false&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Intelligence AND will check: failed.&lt;/span&gt;

She&#39;s successful. You take too long to cast the spell, and once she starts revolving around, you lose your concentration and the upper hand. You&#39;re soon the one pinned down, her legs holding your waist and her hands grabbing your arms.

[[Continue|SE Aspiring TC Claws Revenge]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Intelligence AND will check: passed.&lt;/span&gt;

You rush to grab her arms and take them to the ground. When you let them go and she tries moving them again, the surprise to learn that they&#39;re now chained to the earth hits her hard. She&#39;s now in your hands.

&lt;&lt;link [[She will be your prize|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chClaw.energy.current -= 5;
aspiringTCdommingClaw();
applyAlteredState([&quot;chClaw&quot;],createASaetherialChainsArms(2));
State.variables.sc.formatScenePassage();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[Let her go|SE Aspiring TC Not Domming Claw]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="328" name="SE Aspiring TC Drain Claw" tags="" position="5998,997" size="100,100">$customRoomIntro
You rush to meet her lips and kiss them. She doesn&#39;t return the kiss and tries to move away from you, to no avail, and you start draining...

&lt;&lt;if $StVars.check8 == false&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Agility AND charisma check: failed.&lt;/span&gt;

But you botch the suction, and she takes advantage of your failure to grab you and trash around. You&#39;re soon the one below her, with her legs pinning your waist.

[[Continue|SE Aspiring TC Claws Revenge]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Agility AND charisma check: passed.&lt;/span&gt;

Until she&#39;s out of strength, unable to oppose you, or your invading tongue.

//You recovered &lt;span style=&quot;color:limegreen&quot;&gt;10 energy&lt;/span&gt;.//

&lt;&lt;link [[She will be your prize|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chClaw.energy.current -= 10;
State.variables.chPlayerCharacter.energy.current += 10;
aspiringTCdommingClaw();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[Let her go|SE Aspiring TC Not Domming Claw]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="329" name="SE Aspiring TC Order Claw" tags="" position="6105,999" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Stay quiet, now.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You, how dare you-&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;No arguing back. You&#39;re mine for today.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hissss&quot;//&lt;/span&gt;, she keeps complaining for a few seconds, until she finally gives in.

//Now, should I keep pushing this?//

&lt;&lt;link [[She will be your prize|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
aspiringTCdommingClaw();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[Let her go|SE Aspiring TC Not Domming Claw]]</tw-passagedata><tw-passagedata pid="330" name="SE Aspiring TC Post Domming Claw" tags="" position="6331,890" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What do you think? I bet you&#39;ll start having wet dreams where I assault you, after this.&quot;//&lt;/span&gt; You say as you let her go.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hehe.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check10 == false&gt;&gt; \
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Don&#39;t grow so confident, you just caught me with my guard off.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And that&#39;s why you  were prey today.&quot;//&lt;/span&gt;

Claw is fully aware that&#39;s she&#39;s getting increasingly annoyed - which is probably why she decides to leave without exchanging any further words.
&lt;&lt;else&gt;&gt; \
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;m so going to punish you later...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt; You decide it&#39;s best not to keep pushing your luck, and let her leave.
&lt;&lt;/if&gt;&gt; \

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Claw has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your rivalry with Claw has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 500;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 150;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="331" name="SE Aspiring TC Post Subbing Claw" tags="" position="6029,1107" size="100,100">$customRoomIntro
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Ah... Ah... Learnt your lesson now...?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I... Guess.&quot;//&lt;/span&gt; You gasp.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf. If I have to punish you again...&quot;//&lt;/span&gt;

Claw looks down at you with a expression hard to read, not quite an angry one, and definitely not a kind one either. Perhaps it&#39;s just the face she makes when she&#39;s finished enjoying a hunting prize that gave her trouble.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Go away and let me rest.&quot;//&lt;/span&gt;

You make sure she doesn&#39;t have to ask you twice.

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Claw has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your enmity with Claw has slightly disminished.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.submission.stv += 500;
State.variables.chClaw.relations.chPlayerCharacter.domination.stv += 500;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv -= 150;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv -= 150;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 150;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="332" name="SE Aspiring TC Failed Jump" tags="" position="6340,670" size="100,100">$customRoomIntro
You manage to get up, and gain some confidence when you feel the wood staying stable under your feet. You move one foot forwards and backwards, just to make sure that such small moves won&#39;t make you fall, and position yourself near the edge. You visualize yourself flexing your legs, curbing your back and jumping forwards... And you jump.

Your breathing stops, and so does the whole world. Only you are moving, pushing the air out of your way. You are going to make it. You are going to reach it. You feel yourself falling. You aren&#39;t going to reach it. Your hand grazes the branch - your other hand grabs it. You

&lt;span style=&quot;color:red&quot;&gt;Physique AND agility check: failed.&lt;/span&gt;

can&#39;t hold onto it, and you fall. Your eyes still set on your goal, which moves further and further away, forever out of reach. The floor awaits you-

//THUMP//

You land somewhere - but your fall doesn&#39;t stop just yet. You keep falling a bit more.

//PUMP//

Pain overwhelms you. And you find Claw next to you, her arms surrounding you.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Aaah! Curse this! My arms!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Did you stop my fall?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I did, still don&#39;t know why! What a waste, what a waste!&quot;//&lt;/span&gt;

Claw certainly cushioned your fall, but the pain is eating you nonetheless.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It hurts so much... But I have to thank you...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You better! Gah, damn you!&quot;//&lt;/span&gt;

A few minutes later, both of you go back to the Temple to receive some treatment. Fortunately, the contusions aren&#39;t too serious, and you&#39;re soon healed back to good shape.

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Claw has grown a lot.&lt;/span&gt;//
//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Claw has grown slightly.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Claw has grown slightly.&lt;/span&gt;

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;50 energy&lt;/span&gt;.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 50;
State.variables.chClaw.energy.current -= 25;
State.variables.chPlayerCharacter.relations.chClaw.submission.stv += 500;
State.variables.chClaw.relations.chPlayerCharacter.domination.stv += 500;
State.variables.chPlayerCharacter.relations.chClaw.friendship.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.romance.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.romance.stv += 150;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="333" name="SE Aspiring TC Successful Jump" tags="" position="6341,775" size="100,100">$customRoomIntro
You manage to get up, and gain some confidence when you feel the wood staying stable under your feet. You move one foot forwards and backwards, just to make sure that such small moves won&#39;t make you fall, and position yourself near the edge. You visualize yourself flexing your legs, curbing your back and jumping forwards... And you jump.

Your breathing stops, and so does the whole world. Only you are moving, pushing the air out of your way. You are going to make it. You are going to reach it. You feel yourself falling. You aren&#39;t going to reach it. Your hand grazes the branch - your other hand grabs it. You

&lt;span style=&quot;color:green&quot;&gt;Physique AND agility check: passed.&lt;/span&gt;

tense muscles that you didn&#39;t know that existed, and manage to hold onto it for a moment, and your other hand lands on the tree as well. Your position is much safer now, and it doesn&#39;t take you long to raise your torso first, and your legs later, on top of the branch.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You actually made it. I&#39;m impressed.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m impressed too... I mean, damn right I did it.&quot;//&lt;/span&gt;

You take a long time to recover your breath, contemplating the ground, several meters below.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Well... Congratulations. I&#39;ll be leaving now, you can come down when you feel like it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh, wait! Can you lend me a hand to get down?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hum, sure, I&#39;ll lend you a hand. A metaphorical hand. You have my whole support.&quot;//&lt;/span&gt; She says smugly, right before waving you goodbye and leaving.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You can&#39;t be serious...&quot;//&lt;/span&gt;

//You have gained 250 physique experience.//

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Claw has grown slightly.&lt;/span&gt;//
//&lt;span style=&quot;color:gray&quot;&gt;Your enmity with Claw has fallen slightly.&lt;/span&gt;//

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;25 energy&lt;/span&gt;.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 25;
State.variables.chPlayerCharacter.relations.chClaw.friendship.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv -= 150;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv -= 150;
gC(&quot;chPlayerCharacter&quot;).physique.addExperience(250);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="334" name="SE Aspiring TC Back Down" tags="" position="6215,1002" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Aren&#39;t I great?&quot;//&lt;/span&gt; You spout with ample satisfaction, as you let her go and start getting up.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Where do you think you&#39;re going?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh?&quot;//&lt;/span&gt;

And you soon realize the mistake of giving your back to the beastkin: she immediately gets on her feet and jumps on you, throwing you to the ground and pinning you below her.

[[Continue|SE Aspiring TC Claws Revenge]]</tw-passagedata><tw-passagedata pid="335" name="SE Aspiring TC Not Domming Claw" tags="" position="6325,999" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;An amazing first time, wouldn&#39;t you say?&quot;//&lt;/span&gt; You say as you let her go and get back on your feet.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You caught me with my guard off.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I did. But I doubt that complaining about that will get you out of a pinch in the wilds.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Tsch.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Keep an eye open from now on... You never know who could fall upon you.&quot;//&lt;/span&gt;

And you leave the scene with a smug smile, absurdly satisfied with yourself.

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your enmity with Claw has slightly disminished.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 500;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv -= 150;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv -= 150;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="336" name="Luring Masquerade Start" tags="" position="6393,494" size="100,100">&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \
$customRoomIntro
The water of the lake rests in ease, unaware of anyone&#39;s troubles, or misfortunes. You&#39;re sitting facing the lake, letting it share its sweet unconsciousness with you, as you&#39;ll listen much better to its silence than the lake will listen to your worries.

//Wouldn&#39;t it be nice if I could just dissolve myself in water sometimes? Just to rest for a while...//

The trail of your thoughts gets cut in half by two intruding hands, which have just grabbed your breasts.

[[Continue|Luring Masquerade Start 2]]</tw-passagedata><tw-passagedata pid="337" name="Luring Masquerade Early End" tags="" position="6613,494" size="100,100">$customRoomIntro
//Ugh, screw that.// You say to yourself. //Whatever that was about, it&#39;s not worth the trouble.//

And so, you let your thoughts dissolve in water.

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension towards Padmiri has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 150;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 150;
setPasChars([]);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="338" name="Luring Masquerade Chase Padmiri" tags="" position="6505,609" size="100,100">$customRoomIntro
You&#39;re not just about to let this slide, and you chase your aggresor to her hideout.

//Does this deserve retribution? Ugh, perhaps that&#39;s what she wants-//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;There you are!&quot;//&lt;/span&gt; You shout as soon as you find her, among the trees.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Hmm?&quot;//&lt;/span&gt; She turns around to face you. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Is something troubling you?&quot;//&lt;/span&gt; Padmiri asks with an inquisitive expression.

[[Attack Padmiri|Luring Masquerade Attack Padmiri]]
[[Demand an apology|Luring Masquerade Reprimand Padmiri]]
[[Let it be|Luring Masquerade Let It Be]]
&lt;&lt;if $StVars.check1 == false&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Empathy OR perception OR intelligence check: failed.&lt;/span&gt;
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Empathy OR perception OR intelligence check: passed.&lt;/span&gt;
[[Consider the situation|Luring Masquerade Analyze Situation]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="339" name="Luring Masquerade Let It Be" tags="" position="6613,607" size="100,100">$customRoomIntro
//...What&#39;s this? She looks oblivious. Am I missing something?//

You stand in front of her, unsure of your next move.

//...Is she taunting me? Or am I overreacting?//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ugh.&quot;//&lt;/span&gt; You give up. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I give up. Just... Don&#39;t do that again.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Huh?&quot;//&lt;/span&gt;

And so you leave, confused and unsatisfied.

//&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has slightly disminished..&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension towards Padmiri has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 150;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 150;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 150;
setPasChars([]);
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="340" name="Luring Masquerade Attack Padmiri" tags="" position="6720,607" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t play dumb! I&#39;m here to teach you a lesson, to you and those hands of yours.&quot;//&lt;/span&gt; 

You lean forwards, ready to attack.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Just so you know, I&#39;m not just about to sit and take it.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Aah, we&#39;re fighting so early in the morning?&quot;//&lt;/span&gt; Valtan says, appearing out of nowhere. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;If this girl is looking for a fight, she should have double the trouble.&quot;//&lt;/span&gt; The Shapeshifter positions besides Padmiri, facing you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Stay out of this!&quot;//&lt;/span&gt; 

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...I&#39;m not sure what&#39;s going on, but I&#39;m not going to reject help against such an unereasonable attack.&quot;//&lt;/span&gt;

&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;)]);
ccsLuMaPlayerVsTwoBattleInit();
&lt;&lt;/script&gt;&gt; \
[[Continue|Scene]]</tw-passagedata><tw-passagedata pid="341" name="Luring Masquerade Reprimand Padmiri" tags="" position="6830,605" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You know what&#39;s troubling me! I want you to apologize?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What are you talking about? I&#39;ve done nothing wrong.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Uugh. If that&#39;s the case...&quot;//&lt;/span&gt; You lean forwards, ready to fight. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Maybe I should beat the apology out of you.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Fine, that&#39;s a game we both can play. And perhaps you&#39;ll be in the mood to explain youself after I win.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Aah, we&#39;re fighting so early in the morning?&quot;//&lt;/span&gt; Valtan says, appearing out of nowhere. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;If this girl is looking for a fight, she should have double the trouble.&quot;//&lt;/span&gt; The Shapeshifter positions besides Padmiri, facing you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Stay out of this! And you-&quot;//&lt;/span&gt; 

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...I&#39;m not sure what&#39;s going on, but I&#39;m not going to reject help against such an unereasonable attack.&quot;//&lt;/span&gt;

&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;)]);
ccsLuMaPlayerVsTwoBattleInit();
&lt;&lt;/script&gt;&gt; \
[[Continue|Scene]]</tw-passagedata><tw-passagedata pid="342" name="Luring Masquerade Analyze Situation" tags="" position="6503,822" size="100,100">$customRoomIntro
//She... Does not really look like she understand the situation, right? To be fair, that did not look like something Padmiri would do, at all.//

You look around, looking for someone.

//However, it was something a certain someone would do. Someone able to take take other people&#39;s shapes. Can she really turn into a different race, though?//

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;$chPlayerCharacter.name, are you feeling alright? You&#39;re worrying me.&quot;//&lt;/span&gt;

//Is the person I have in front of me Padmiri?//

[[Explain the situation|Luring Masquerade Explanations To Mir]]
[[Ask where Valtan is|Luring Masquerade Attack Valtan]]
[[Drop the issue, carry on with your day|Luring Masquerade Let Valtan Be]]</tw-passagedata><tw-passagedata pid="343" name="Luring Masquerade Miracle Victory" tags="" position="6608,715" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ah... Ah...&quot;//&lt;/span&gt;

Padmiri and Valtan await defeated in the ground, impressed.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;How is this possible? For her to win against two of us...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;This makes no sense... What did just happen here?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I hope you&#39;ve learned your lesson now!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I still-&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;She has! She definitely has. Right, Mir?&quot;//&lt;/span&gt; Valtan penetrates Padmiri with her gaze.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Of course. I will be respectful towards you. As always.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s what I wanted to hear. Aaah...&quot;//&lt;/span&gt; You sigh, recovering from your exhaustion. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;All in all, this was a good way to start the day.&quot;//&lt;/span&gt;

//You have gained 5 merit.
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Valtan has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.merit += 5;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 350;
State.variables.chVal.relations.chPlayerCharacter.submission.stv += 350;
State.variables.chPlayerCharacter.relations.chVal.domination.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.submission.stv += 150;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="344" name="Luring Masquerade Defeated By Two" tags="" position="6718,715" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;As if... I could have won that fight...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I hope this will teach you about starting fights for no reason.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Just in case she hasn&#39;t learned enough,&quot;//&lt;/span&gt; Valtan intervenes, &lt;span @style=$chVal.colorStyleKey&gt;//&quot;I&#39;m going to take her away to expand on the lesson.&quot;//&lt;/span&gt;

The Shapeshifter walks towards you, licking her lips.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Wait.&quot;//&lt;/span&gt;

Valtan gets down, just about to carry you on her arms.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;How is it that you were just right around the corner when the fight was about to happen? Did you have anything to do with this?&quot;//&lt;/span&gt;

//...Huh?//

Just when Valtan is about to reach you, some vines grab her waist, and pull her away.

[[Continue|Luring Masquerade From Chaos To Safety]]</tw-passagedata><tw-passagedata pid="345" name="Luring Masquerade From Chaos To Safety" tags="" position="6831,714" size="100,100">$customRoomIntro
&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What is this, Padmiri? This is no way to thank a friend.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;But it&#39;s the proper way to thank a scheming bastard that steals my face.&quot;//&lt;/span&gt;

//...Oh. I see.//

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Bastard is such a strange insult to hurl at me, you know Shapeshifters don&#39;t marry.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Surrender now and I will be gentle when I punish you both.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wait, you want to punish me? Even though you&#39;re saying that she tricked me?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You deserve it for falling for such a cheap trick, and now stay quiet!&quot;//&lt;/span&gt;

Mere seconds later, Padmiri and Valtan are fighting each other.

//Don&#39;t mind me if I don&#39;t stay for my punishment to come.//

You crawl out of the scene.

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Valtan has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 250;
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 250;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 250;
State.variables.chMir.relations.chVal.enmity.stv += 250;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="346" name="Luring Masquerade Let Valtan Be" tags="" position="6611,823" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, I... Ugh, it&#39;s a strange day, that&#39;s all. Sorry about that.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You don&#39;t need to excuse yourself, you did nothing wrong... But it almost looked like you were going to kill me with your eyes.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Haha... Ha...&quot;//&lt;/span&gt;

You decide to let things be, but a small hint of paranoia accompanies you for the rest of the day.

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;5 willpower&lt;/span&gt;.//
//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Valtan has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 5;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 150;
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 150;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="347" name="Luring Masquerade Explanations To Mir" tags="" position="6501,932" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I am. I think I am. Have you seen Valtan?&quot;//&lt;/span&gt; You ask, lowering your voice.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes, she was around here just a moment ago.&quot;//&lt;/span&gt; She lowers her voice as well.

//I knew it.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She groped me, a couple of minutes ago. With your face.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;She what?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Play along with me, now. And you won&#39;t apologize to me!?&quot;//&lt;/span&gt; You shout, suddenly.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...But wait!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m going to teach you a lesson!&quot;//&lt;/span&gt;

[[Continue|Luring Masquerade Explanations To Mir 2]]</tw-passagedata><tw-passagedata pid="348" name="Luring Masquerade Attack Valtan" tags="" position="6503,1042" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I am. I think I am. Have you seen Valtan?&quot;//&lt;/span&gt; You ask, lowering your voice.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes, she was around here just a moment ago.&quot;//&lt;/span&gt; She lowers her voice as well.

You look around, cautiously.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;In fact, she&#39;s right behind you.&quot;//&lt;/span&gt;

//Either Valtan is behind me, or in front of me... Guess I&#39;ll find out right now.//

Just as you turn around, you catch a glance of Valtan hiding behind a tree, and you get ready to attack her.

&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;)]);
ccsLuMaPlayerVsValBattleInit();
&lt;&lt;/script&gt;&gt; \
[[Continue|Scene]]</tw-passagedata><tw-passagedata pid="349" name="Luring Masquerade Victory Of Two" tags="" position="6718,930" size="100,100">$customRoomIntro
&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You saw right through it, aren&#39;t you quite the sharp one?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ugh.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Don&#39;t you have something to say to me?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I&#39;m sorry, Padmiri... I only wanted a bit of fun to start the day. And I didn&#39;t have any face more beautiful than yours to choose...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Sigh.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ahem.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;...And you were the sexiest gal around. To lay my hands on.&quot;//&lt;/span&gt; She tells you with puppy eyes.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;quot;I don&#39;t think I&#39;m satisfied yet.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Just let it be... This went on for long enough.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I won&#39;t do it again?&quot;//&lt;/span&gt; She //lies//, with the face of an innocent child.

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chVal.domination.stv += 250;
State.variables.chVal.relations.chPlayerCharacter.submission.stv += 250;
State.variables.chMir.relations.chVal.domination.stv += 250;
State.variables.chVal.relations.chMir.submission.stv += 250;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="350" name="Luring Masquerade Humilliated By One" tags="" position="6830,927" size="100,100">$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I can&#39;t believe it... What is going on?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She&#39;s still on her feet.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;But not for long... Just let me catch my breath.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;It&#39;s been fun playing with you girls!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t you dare!&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Dare? Is that a challenge? Don&#39;t mind me if I accept it!&quot;//&lt;/span&gt;

And she just runs away, probably estimating that you can still beat her if the fight continues.

//Valtan has gained 5 merit.
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chVal.merit += 5;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 250;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 250;
State.variables.chMir.relations.chVal.submission.stv += 250;
State.variables.chVal.relations.chMir.domination.stv += 250;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="351" name="Luring Masquerade Sweet Revenge" tags="" position="6611,1042" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Learnt your lesson yet?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Oh, I did, I did... I must admit I didn&#39;t expect you to see so fast through me. Good job.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Can I know what is this about?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sure. Valtan groped me while she was wearing your face.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Did she now.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Haha... A mere small play, just to start the morning with some fun.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Why didn&#39;t you tell me earlier, $chPlayerCharacter.name? Now I have to teach Valtan my own lesson...&quot;//&lt;/span&gt; She says with a smiling, yet scary face.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Wait, my dear. I&#39;m exhausted. Mir, please... $chPlayerCharacter.name, you won&#39;t let this happen, right?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Goodbye, Val. Enjoy your small play.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Ugh.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Valtan has grown.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chVal.domination.stv += 250;
State.variables.chVal.relations.chPlayerCharacter.submission.stv += 250;
State.variables.chMir.relations.chVal.domination.stv += 250;
State.variables.chVal.relations.chMir.submission.stv += 250;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="352" name="Luring Masquerade Saved By Mir" tags="" position="6718,1042" size="100,100">$customRoomIntro
&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Now, now... What was that? Attacking people out of nowhere?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What do you mean out of nowhere! Stop playing around!&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What should I do with you...?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Lend me a hand, Mir!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Me?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Do you know why I attacked Val? She groped me while she was wearing your face!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Oh. That changes things. Why didn&#39;t you tell me earlier?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Are you going to believe such a bold-faced lie?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Why not? It&#39;s her word against yours, and yours isn&#39;t very valuable.&quot;//&lt;/span&gt;

After some seconds of silence, Valtan breaks the tension - by running away.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Oh, no, you won&#39;t!&quot;//&lt;/span&gt;

And Padmiri runs behind her.

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Valtan has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 250;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 250;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 250;
State.variables.chMir.relations.chVal.enmity.stv += 150;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="353" name="Luring Masquerade Start 2" tags="" position="6505,492" size="100,100">$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Ah, they&#39;re firm and healthy.&quot;//&lt;/span&gt; says Padmiri&#39;s voice.

The green hands in your chest continue for yet another instant, just as your astonishment starts to give birth to an impulse of self defense.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;It&#39;s good to see you in good shape.&quot;//&lt;/span&gt; She says, as she retires her hands. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;ll be seeing you.&quot;//&lt;/span&gt;

You turn around, still on the ground, and you see Padmiri walk towards the forest, almost fast enough to be considered running.

//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;5 lust&lt;/span&gt;.//

&lt;&lt;link [[Chase her to the forest|Luring Masquerade Chase Padmiri]]&gt;&gt;&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;forest&quot;);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[Let her go|Luring Masquerade Early End]]
&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chMir&quot;)]);
State.variables.chPlayerCharacter.lust.current -= 5;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="354" name="Luring Masquerade Explanations To Mir 2" tags="" position="6611,933" size="100,100">$customRoomIntro
&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Aah, we&#39;re fighting so early in the morning?&quot;//&lt;/span&gt; Valtan says, appearing out of nowhere. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;If this girl is looking for a fight, she-&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;re one to talk!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...I see now.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Huh?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You will think twice about using my face after this.&quot;//&lt;/span&gt; Padmiri gets ready to whip Valtan with a vine.

&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;)]);
ccsLuMaTwoVsValBattleInit();
&lt;&lt;/script&gt;&gt; \
[[Continue|Scene]]</tw-passagedata><tw-passagedata pid="355" name="SE Gifts For Nature Start" tags="" position="6663,221" size="100,100">&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \
You&#39;re the last one to pick a job today, and Lady Luck leaves you with no other choice than leaving to gather salfis flowers with Padmiri.

This is done in the outskirts of the Temple, walking through wild, yet calm vegetation. The flowers are strangely elusive, and you may find none after searching for hours, or you may suddenly find clearings full of them. Sometimes you&#39;ll find the little ones in places that, according to your memory, had already be found to be empty.

You were starting to wonder if there was something wrong with you - or if the flowers had a will of their own.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hey, Padmiri. Is it strange if I think that the flowers are hiding from me?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Hiding from you...? No, you&#39;re definitely not the only one to have that opinion.&quot;//&lt;/span&gt; She smiles as if something had amused her.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I must have said something funny.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Do you know why these flowers are so important?&quot;//&lt;/span&gt;

[[Reply|SE Gifts For Nature How Safi Flowers Work]]</tw-passagedata><tw-passagedata pid="356" name="SE Gifts For Nature How Safi Flowers Work" tags="" position="6783,221" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I have been told that they&#39;re good to store magic energy.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Precisely. Salfis flowers absorb aether from their surroundings, and it&#39;s easy to squeeze it out of them, so they&#39;re usually used during magical rituals. I&#39;ve also heard of people who use them to brew potions.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So how does this relate to the flowers hiding from people?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That&#39;s where I&#39;m going. If you want to find salfis flowers, you have to think like a salfis flower.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I guess I&#39;ll dig a hole and throw myself in it.&quot;//&lt;/span&gt; Your joke does not amuse her.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;If you want to find salfis flowers, you have to follow the aether, like if you were getting ready to cast magic. Or, like... if you were having sex, and you were trying to feel everything going through your body.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...The flowers are horny sorcerers!?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Ah, you found out. But don&#39;t tell anyone, or they&#39;ll kick me out of our secret meetings.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;If you reply so naturally, I may think you&#39;re not kidding.&quot;//&lt;/span&gt; She returns your look, smiling smugly, not just about to deny that there&#39;s a secret horny sorcerer flowers underground.

[[Continue|SE Gifts For Nature Ecology Explanation]]</tw-passagedata><tw-passagedata pid="357" name="SE Gifts For Nature Ecology Explanation" tags="" position="6889,219" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So there should be a few around...&quot;//&lt;/span&gt; You move some bushes apart with your hands, following the trail of aether. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Here. Hey, that worked!&quot;//&lt;/span&gt; You say enthusiastically, as you crouch to pick the flowers that have just appeared before you.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You&#39;re welcome. ...Hey, don&#39;t pick them all.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Why? If we need them in the Temple, we should get as many as possible.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes, but you should always leave a few behind to let them repopulate. Otherwise we&#39;ll deplete them in this area.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Oh.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That is a fundamental part of keeping a garden... If you consume your whole garden, you&#39;ll have nothing left the next day.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You know, it&#39;s really odd to hear you speaking about... Gardening. Plants tend to be on the... Receiving part of that.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Really...? Oh, ooh, I think I understand. For us Leirien, being a gardener or being the ones being gardened, it&#39;s just a matter of perspective.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I need you to expand on that...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Sure. Humans have mothers and fathers, right? And they look over their children.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s right.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And some day, those children will have their own children, and they&#39;ll look after them as well.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So you&#39;re saying that parents garden their children...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And the children become gardeners later. In my tribe, there&#39;s not only parents, but also heads of family, who look over everyone in their family, whether they&#39;re adults or not, so parents are also on the side of the gardened. You don&#39;t get all the answers to life when you become an adult, so the heads of family keep providing you with some guidance.&quot;//&lt;/span&gt;

[[Continue|SE Gifts For Nature Theology]]</tw-passagedata><tw-passagedata pid="358" name="SE Gifts For Nature Theology" tags="" position="6674,335" size="100,100">&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...And things don&#39;t stop there. Even the children look over the smaller forms of life around them. And above all of us, the Goddess guides us as well.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And don&#39;t gardeners always expect to get something out of their gardens?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Sure. Keeping your children happy brings you happiness in the long run.&quot;//&lt;/span&gt;

[[How would a gardener guide me?|SE Gifts For Nature Gardeners Guidance]]
[[But a gardener could be exceptionally selfish|SE Gifts For Nature Gardeners May Be Selfish]]
[[A gardener may see someone as a weed|SE Gifts For Nature Gardeners May Be Mean]]
[[How was the head of Padmiri&#39;s family?|SE Gifts For Nature Who Gardened Padmiri]]
[[I could have used a gardener in my life|SE Gifts For Nature Would Want A Gardener]]
[[I would like to garden Padmiri|SE Gifts For Nature Garden Padmiri]]
[[I would be a selfish gardener|SE Gifts For Nature Player Would Be Selfish Gardener]]

[[I have no other questions|SE Gifts For Nature Continue Gathering]]</tw-passagedata><tw-passagedata pid="359" name="SE Gifts For Nature Further Questions" tags="" position="6783,337" size="100,100">Do I have more questions?

&lt;&lt;if $StVars.check2 is false&gt;&gt;[[How would a gardener guide me?|SE Gifts For Nature Gardeners Guidance]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check3 is false&gt;&gt;[[But a gardener could be exceptionally selfish|SE Gifts For Nature Gardeners May Be Selfish]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check4 is false&gt;&gt;[[A gardener may see someone as a weed|SE Gifts For Nature Gardeners May Be Mean]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check7 is false&gt;&gt;[[How was the head of Padmiri&#39;s family?|SE Gifts For Nature Who Gardened Padmiri]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check5 is false &amp;&amp; $StVars.check6 is false&gt;&gt;[[I could have used a gardener in my life|SE Gifts For Nature Would Want A Gardener]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check5 is false &amp;&amp; $StVars.check6 is false&gt;&gt;[[I would like to garden Padmiri|SE Gifts For Nature Garden Padmiri]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check8 is false&gt;&gt;[[I would be a selfish gardener|SE Gifts For Nature Player Would Be Selfish Gardener]]
&lt;&lt;/if&gt;&gt; \

[[I have no other questions|SE Gifts For Nature Continue Gathering]]</tw-passagedata><tw-passagedata pid="360" name="SE Gifts For Nature Gardeners May Be Selfish" tags="" position="7036,219" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What if one of those gardeners doesn&#39;t have such a selfless attitude, though?&quot;//&lt;/span&gt; You ask. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You could end up with a gardener that wants to eat the fruit before it&#39;s ripe, maybe even demand something that their protegees do not wish to give.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Then their garden would wither away, and they would be a gardener no more. Take more than it&#39;s due to you and you will lose more than you expected to consume.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That sounds great for someone seeking some sort of cosmic justice,&quot;//&lt;/span&gt; you reply, &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;but what happens to those who form part of that garden when it starts to decay?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That...&quot;//&lt;/span&gt; She medidates. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;I guess they&#39;d have to leave the garden to avoid harm. That&#39;s also part of the garden withering away.&quot;//&lt;/span&gt;

&lt;&lt;script&gt;&gt;
State.variables.StVars.check3 = true;
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Gifts For Nature Further Questions]]</tw-passagedata><tw-passagedata pid="361" name="SE Gifts For Nature Gardeners May Be Mean" tags="" position="7149,217" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What happens if your gardener considers you a bad weed?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Excuse me?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You could end up with a protegee that you consider harmful, or your gardener may consider you harmful to others under their care. What would happen then?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That&#39;s up to the gardener to solve. If different parts of your garden are fighting each other, you have to discover how to establish harmony.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And... What about someone you&#39;d consider a lost cause? You may decide that someone is irredeemable.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;No one is truly irredeemable. Someone who harms others must still grow and learn, but that&#39;s not impossible for anyone.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Imagine that you have such a person, and you&#39;re absolutely unable to set them on the right path.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Then... Perhaps I would require them to find another garden. But that&#39;s an extreme case. You&#39;re giving me quite the difficult conversation.&quot;//&lt;/span&gt;

&lt;&lt;script&gt;&gt;
State.variables.StVars.check4 = true;
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Gifts For Nature Further Questions]]</tw-passagedata><tw-passagedata pid="362" name="SE Gifts For Nature Would Want A Gardener" tags="" position="7038,329" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You know, after giving it a good thought, I could have liked having a gardener.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;It&#39;s never too late.&quot;//&lt;/span&gt; She smiles provocatively. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;You should make sure it&#39;s someone who knows the ropes... Someone that would take... Good care of you.&quot;//&lt;/span&gt;

//She means herself.//

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 150;
State.variables.StVars.check5 = true;
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Gifts For Nature Further Questions]]</tw-passagedata><tw-passagedata pid="363" name="SE Gifts For Nature Garden Padmiri" tags="" position="7149,327" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I guess I would enjoy being a gardener.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check8 is false&gt;&gt; \
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That&#39;s wonderful to hear. It&#39;s always positive to hear that there are others willing to look out for the rest, and help them grow.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And I would particularly enjoy it if you were part of my garden.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And also, as priestesses-to-be... Ah?&quot;//&lt;/span&gt;

You approach her slowly, maintaining the eye contact, and gently stroke her face with one of your fingers.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...And I bet you would enjoy it too.&quot;//&lt;/span&gt; You briefly lick your lips.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;As... As I was saying... Um... Other questions?&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has slightly grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 150;
State.variables.StVars.check6 = true;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
Padmiri sighs. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;After what you said earlier, I don&#39;t think you understand what it means, at all.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:red&quot;&gt;Your enmity with Padmiri has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.enmity.stv += 300;
State.variables.chMir.relations.chPlayerCharacter.enmity.stv += 300;
State.variables.StVars.check6 = true;
State.variables.StVars.check9 = true;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;/if&gt;&gt; \
[[Continue|SE Gifts For Nature Further Questions]]</tw-passagedata><tw-passagedata pid="364" name="SE Gifts For Nature Who Gardened Padmiri" tags="" position="7038,440" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m curious, how was the head of your family?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;He was a very gentle, patient old man. Slightly shorter than me, due to his age.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;He was... Growing back to his roots.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Don&#39;t be mean to him!&quot;//&lt;/span&gt; Padmiri protests, looking sad. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;He was a person so nice that his heart could barely fit in his chest. Metaphorically speaking. If anyone had troubles looming over them, he would stay awake until the end of the night, listening to their worries.&quot;//&lt;/span&gt;

&lt;&lt;script&gt;&gt;
State.variables.StVars.check7 = true;
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Gifts For Nature Further Questions]]</tw-passagedata><tw-passagedata pid="365" name="SE Gifts For Nature Player Would Be Selfish Gardener" tags="" position="7149,439" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I must admit, I would probably be quite the selfish gardener.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...How so?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That kind of authority... Would allow you to raise others to be who you&#39;d like them to be, rather than what would help them the most.&quot;//&lt;/span&gt;

She gives you a worried look.

&lt;&lt;if $StVars.check6 is false&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It&#39;s hard for me to believe that I&#39;m the only one who finds it tempting.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your romance with Padmiri has slightly decreased.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 150;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 150;
State.variables.chPlayerCharacter.relations.chMir.romance.stv -= 150;
State.variables.chMir.relations.chPlayerCharacter.romance.stv -= 150;
State.variables.StVars.check8 = true;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Wait, didn&#39;t you just say you&#39;d like me to be under your care?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I did.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And you boldly declare that you would use me as you desired... I think I must keep an eye on you.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your dominance towards Padmiri has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity with Padmiri has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv -= 150;
State.variables.chMir.relations.chPlayerCharacter.submission.stv -= 150;
State.variables.chPlayerCharacter.relations.chMir.enmity.stv += 300;
State.variables.chMir.relations.chPlayerCharacter.enmity.stv += 300;
State.variables.StVars.check8 = true;
State.variables.StVars.check9 = true;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;/if&gt;&gt; \
[[Continue|SE Gifts For Nature Further Questions]]</tw-passagedata><tw-passagedata pid="366" name="SE Gifts For Nature Continue Gathering" tags="" position="7283,215" size="100,100">After the conversation, you keep gathering flowers in the area. The search feels much less hopeless, now that you have a clearer understanding of the activity.

You end up at a relatively hidden clearing with dozens and dozens of salfis flowers in plain sight, and each of you approach a different group of them.

Upon taking a couple, you discover another one with ample petals of orange color, instead of the typical yellow, partially buried in the soil.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Look at this flower... It&#39;s orange.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check9 is false&gt;&gt; \
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Orange, you say...? Don&#39;t get close to it! Back out!&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check1 is false&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Will OR perception OR agility check: failed.&lt;/span&gt;

But her warning comes too late for you, and the flower&#39;s scent invades your nose...

[[Continue|SE Gifts For Nature Got trapped]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Will OR perception OR agility check: passed.&lt;/span&gt;

You feel the flower&#39;s scent invading your nose...

[[Take a better smell|SE Gifts For Nature Diving In]]
[[Retreat immediately|SE Gifts For Nature Got Away]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Orange, you say...?&quot;//&lt;/span&gt;

You feel the flower&#39;s scent invading your nose...

[[Continue|SE Gifts For Nature Got trapped]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="367" name="SE Gifts For Nature Got Away" tags="" position="7400,330" size="100,100">You get up and walk back, one step after another, and only then you notice that your legs are failing you. When you&#39;re just about to lose balance and fall, Padmiri holds your back.

Your mind is dizzy and your vision, foggy, but they slowly go back to normal.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Are you alright?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m... I&#39;ll be fine in a moment. I think.&quot;//&lt;/span&gt; She sighs, relieved. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What was that?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That&#39;s a parasalfis flower. They release scents that turn their victims horny and deprive them of their will.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...And why is such a thing here?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Because there are salfis flowers around. The victims of the parasalfis end up releasing aether, usually as the result of masturbating, which feeds the salfis flowers, and the parasalfis parasites them.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That sounds dangerous.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;It&#39;s not that terrible. And they feed the salfis flowers, which is good for us. But we should leave this place.&quot;//&lt;/span&gt;

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="368" name="SE Gifts For Nature Got trapped" tags="" position="7283,320" size="100,100">You fall to dizziness at lightning speed, your head getting clouded, and your very sense of self gets washed away. The world becomes a drama play that takes place before your eyes, out of your reach, out of your control. The heat that is warming your skin and setting your groin on fire is just part of the scenery, your hand seeking to satisfy your body, just a natural event.

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;50 willpower&lt;/span&gt;.//
//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;35 lust&lt;/span&gt;.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 50;
State.variables.chPlayerCharacter.lust.current -= 35;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;if $StVars.check9 is false&gt;&gt; \
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Ah, look at what you did.&quot;//&lt;/span&gt; Padmiri says to the selfless puppet that is your body. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;That isn&#39;t going to do at all... I shouldn&#39;t get closer, either. Can you hear me? Come over here.&quot;//&lt;/span&gt;

But your body doesn&#39;t react.

Some seconds later, you feel vines grabbing your legs, and pulling them towards Padmiri.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Nngh... Come here, please...&quot;//&lt;/span&gt;

And your legs finally obey, taking you to the Leirien.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Her mind went completely blank so fast... Just look at you, touching yourself like if you weren&#39;t in front of me.&quot;//&lt;/span&gt; She sighs. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Just let me take care of you.&quot;//&lt;/span&gt;

&lt;&lt;link [[She takes you in her arms|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
giftsForNatureInPadmirisCare();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Ah, look at what you did.&quot;//&lt;/span&gt; Padmiri says to the selfless puppet that is your body. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;That isn&#39;t going to do at all... I shouldn&#39;t get closer, either. Can you hear me? Come over here.&quot;//&lt;/span&gt;

But your body doesn&#39;t react.

Some seconds later, you feel vines grabbing your legs, and pulling them towards Padmiri.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Nngh... Come here, please...&quot;//&lt;/span&gt;

And your legs finally obey, taking you to the Leirien.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Her mind went completely blank so fast... Just look at you, touching yourself like if you weren&#39;t in front of me.&quot;//&lt;/span&gt; She sighs. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Luckily for you, I&#39;m responsible enough not to abuse the situation... And I&#39;m going to limit myself to take care of you.&quot;//&lt;/span&gt;

&lt;&lt;link [[She takes you in her arms|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
giftsForNatureInPadmirisCare();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="369" name="SE Gifts For Nature Parasafi Explanation" tags="" position="7403,217" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What... What was that?&quot;//&lt;/span&gt; You ask, shocked after you&#39;ve turned into a lifeless puppet - even if it only was for a short while.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That was a parasalfis flower.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m still scared, I think I could throw up...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You&#39;re healthy now, please don&#39;t worry. Parasalfis flowers release scents that turn their victims horny, and annul their senses of self. The victims release aether while they&#39;re masturbating, and this feeds the salfis flowers, which the parasalfis flower parasites.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Let&#39;s set it on fire.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Calm yourself. If you start a fire, you&#39;ll put the whole forest in danger. And parasalfis help salfis flowers to feed, which is good for us.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You&#39;re safe now, aren&#39;t you?&quot;//&lt;/span&gt;

You remain silent, unable to deny it.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You&#39;ll feel better about this when you&#39;ve rested. Let&#39;s leave.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has grown.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 300;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 300;
State.variables.chPlayerCharacter.lust.current = State.variables.chPlayerCharacter.lust.max;
State.variables.chMir.lust.current = State.variables.chMir.lust.max;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="370" name="SE Gifts For Nature Diving In" tags="" position="7285,427" size="100,100">But the smell intrigues you, and you want to feel it for yet another second. And another one... And another one...

You fall to dizziness at lightning speed, your head getting clouded, and your very sense of self gets washed away. The world becomes a drama play that takes place before your eyes, out of your reach, out of your control. The heat that is warming your skin and setting your groin on fire is just part of the scenery, your hand seeking to satisfy your body, just a natural event.

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;50 willpower&lt;/span&gt;.//
//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;35 lust&lt;/span&gt;.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 50;
State.variables.chPlayerCharacter.lust.current -= 35;
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Ah, look at what you did.&quot;//&lt;/span&gt; Padmiri says to the selfless puppet that is your body. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;That isn&#39;t going to do at all... I shouldn&#39;t get closer, either. Can you hear me? Come over here.&quot;//&lt;/span&gt;

But your body doesn&#39;t react.

Some seconds later, you feel vines grabbing your legs, and pulling them towards Padmiri.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Nngh... Come here, please...&quot;//&lt;/span&gt;

And your legs finally obey, taking you to the Leirien.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Her mind went completely blank so fast... Just look at you, touching yourself like if you weren&#39;t in front of me.&quot;//&lt;/span&gt; She sighs. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Just let me take care of you.&quot;//&lt;/span&gt;

&lt;&lt;link [[She takes you in her arms|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
giftsForNatureInPadmirisCare();
gC(&quot;chMir&quot;).socialAi.covetTs.push(&quot;chPlayerCharacter&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \</tw-passagedata><tw-passagedata pid="371" name="SE Gifts For Nature Gardeners Guidance" tags="" position="6931,332" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m wondering, what would a gardener do for me, exactly?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Basically the same Drishtya does for us.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Drishtya is our gardener?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I see it that way. She guides us in our way to solve our troubles, and helps us learn and grow strong. Hasn&#39;t she asked you about your more... Personal issues?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Um, kind of.&quot;//&lt;/span&gt;

&lt;&lt;script&gt;&gt;
State.variables.StVars.check2 = true;
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Gifts For Nature Further Questions]]</tw-passagedata><tw-passagedata pid="372" name="SE Discovering The Others Start" tags="" position="6971,567" size="100,100">&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \
$customRoomIntro
The corridors of the library are always silent and peaceful, and it&#39;s rare to hear anything other than quiet steps or the movement of paper as it splits the air. It is for this reason that something as simple as hearing someone calling your name quickly puts you on alert.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;$chPlayerCharacter.name.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Uh, what?&quot;//&lt;/span&gt;

It&#39;s just Maaterasu, as quiet as your own shadow.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I find this play difficult to understand. I would like to hear your opinion.&quot;//&lt;/span&gt;

//Should you help Maaterasu?//

[[Agree to help her|SE Discovering The Others Check Ate]]
[[You&#39;re busy|SE Discovering The Others Leave Early]]</tw-passagedata><tw-passagedata pid="373" name="SE Discovering The Others Leave Early" tags="" position="7086,567" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I have a lot of things to do today. Some other time, perhaps?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...Fine.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;See you!&quot;//&lt;/span&gt;

&lt;&lt;script&gt;&gt;effectsSeDiscoveringTheOthersEarlyEnd();&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="374" name="SE Discovering The Others Check Ate" tags="" position="6973,677" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I could give it a look. Is it long?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;It&#39;s very short. It has three scenes and three characters.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Let&#39;s see...&quot;//&lt;/span&gt;

[[Read the play|SE Discovering The Others Love Weaving Maiden]]</tw-passagedata><tw-passagedata pid="375" name="SE Discovering The Others Love Weaving Maiden" tags="" position="7083,677" size="100,100">__Love weaving maiden, love unweaving maiden:__

- Scene 1

Sherellez: Surrounded by unending dunes, confined in the limits of a sea of sands, dust and heat, lies my palace. Nothing could I ever miss, they say, as I have wine, and almonds, and oils, and perfumes: they&#39;re the best a princess could ever desire, they say. My mother, and father, my subjects and servants all seem to agree, no one has a better existence than mine. Do you agree, my dear friend?
Mizzin: As much as it may weigh in your heart, my dear princess, I must confess I agree as well.
Sherellez: And so my dearest friend, safekeeper of all secrets mine, fails too to understand my heart. Locked in my tower, I watch over my kingdom of red horizons, home to adventures, secrets and stories, that will never be mine to tell. I&#39;m the fair reigning rose of the desert, that&#39;s bound to be forever chained, inside a crystal urn.

- Scene 2

Mashtracan: Warrior among warriors and chief among chiefs, the deserts all I have made mine, and theirs are the skulls of my buried foes. Behind my horde, I leave a trail of corpses and peace. Before my feet, large roads of honor and glory are built. Yet one last bastion remains to be subjugated, free of my yoke, and fearing of my might: they&#39;ve tried to appease me with gifts and honors. The latest of them, their dearest servant. But as fair as she is, won&#39;t the wonders that this shrinking kingdom is trying to protect, be far more grandiose? Answer my question, maid.
Mizzin: Your words may speak true, my Lord, yet my mind knows not of the wonders you&#39;ve met in this and past lives. Thus, who am I to tell if my kingdom&#39;s wonders will satisfy you?
Mashtracan: Many feats are sung about my sword and vassals, brave and fierce. Am I to risk them all in one last campaign, when this weakly girl shows so little desire to return to her home? Bitter fate would I suffer, if the last of my tales was one that turned pale, in front of my legend.

- Scene 3

Mizzin: She who received the highest trust and the warmest love, has now burned it all. In a past life, I swore to serve my princess. In this one, I receive her word in secret, and cast it to the flames. For what am I to do, if she confesses her love for a warlord she&#39;s never met? Grand souls guide everyone&#39;s fates, and inspire devotion and awe, mine among them. They seek wonders, and comfort and pleasure unknown to them, and in their unquestioned desire, they risk and plunder the happiness of others. The happiness of their servants, of their friends, and mine.

[[Continue|SE Discovering The Others Explain The Play]]</tw-passagedata><tw-passagedata pid="376" name="SE Discovering The Others Explain The Play" tags="" position="7193,677" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hmm. The first character, the princess, feels trapped at her home, and wishes to leave and see the world.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;She also feels no one can understand her.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Precisely. Then there&#39;s the warlord, who isn&#39;t certain about invading the city of the princess, because he thinks it would be his last battle.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;The maid&#39;s indecision makes him think the city may not be as wealthy as he thought.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And finally, there&#39;s the maid, who used to serve the princess, but was given in tribute to the warlord. She &#39;casts the secret word of the princess into the flames&#39;. This surely means that she burns a letter she&#39;s received from the princess.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I think the princess isn&#39;t really in love with the warlord, but she wishes to see the world like him.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That could be true. What is it that you don&#39;t understand?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Why does the maid burn the princess&#39; letter?&quot;//&lt;/span&gt;

[[The maid loves the princess|SE Discovering The Others She Loves the Princess]]
[[The maid loves the warlord|SE Discovering The Others She Loves the Warlord]]
[[The maid hates them both|SE Discovering The Others She Hates Both]]
&lt;&lt;if $StVars.check3 == true&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Empathy check: passed.&lt;/span&gt; [[It&#39;s intentionally vague|SE Discovering The Others Intentionally Vague]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Empathy check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check2 == true&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Charisma check: passed.&lt;/span&gt; [[It&#39;s intentionally open|SE Discovering The Others Intentionally Open]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Charisma check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check1 == true&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Intelligence OR perception check: passed.&lt;/span&gt; [[The maid wants to protect her people|SE Discovering The Others She Fears For the City]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Intelligence OR perception check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;script&gt;&gt;
gC(&quot;chAte&quot;).socialAi.rivalTs = [];
gC(&quot;chAte&quot;).socialAi.allyTs.push(&quot;chPlayerCharacter&quot;);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="377" name="SE Discovering The Others She Loves the Princess" tags="" position="6971,787" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She clearly loves the princess.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;The maid loves the princess?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Absolutely. That&#39;s why she&#39;s protecting her from the warlord. By burning the letter, she&#39;s closing her door to the possibility of running away. That&#39;s also why she doesn&#39;t tell the warlord that the city is rich in luxuries: so that he doesn&#39;t invade it.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;But the princess wants to leave the city...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And the maid thinks that will make her have a worse life.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;That makes sense.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has slightly grown.&lt;/span&gt;

Maaterasu&#39;s views have grown more favorable to love and domination.//

//You lost &lt;span style=&quot;color:khaki&quot;&gt;25 social drive&lt;/span&gt;.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.socialdrive.current -= 25;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 100;
addPointsToDrive(gC(&quot;chAte&quot;).dLove,50);
addPointsToDrive(gC(&quot;chAte&quot;).dDomination,50);
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Discovering The Others Enters Taototh]]</tw-passagedata><tw-passagedata pid="378" name="SE Discovering The Others She Loves the Warlord" tags="" position="7081,785" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She clearly loves the warlord.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;The maid loves the warlord?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Absolutely. That&#39;s why she burns the letter. The princess is more beautiful than the maid, and by making sure they can&#39;t meet each other, she&#39;s preventing the warlord from choosing the princess over her. That&#39;s also why she convinces the warlord that the city isn&#39;t worth attacking.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;That makes sense.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has slightly grown.&lt;/span&gt;

Maaterasu&#39;s views have grown more favorable to pleasure and domination.//

//You lost &lt;span style=&quot;color:khaki&quot;&gt;25 social drive&lt;/span&gt;.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.socialdrive.current -= 25;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 100;
addPointsToDrive(gC(&quot;chAte&quot;).dPleasure,50);
addPointsToDrive(gC(&quot;chAte&quot;).dDomination,50);
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Discovering The Others Enters Taototh]]</tw-passagedata><tw-passagedata pid="379" name="SE Discovering The Others She Hates Both" tags="" position="7193,787" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She hates both of them.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;She hates them?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Of course. She is a maid. A life of serving others was chosen for her, and they had no trouble in gifting her to a violent warlord when it was convenient. The princess and the warlord have far better lives than she will ever have, and they clearly have no issue with endangering others to satisfy their own selfish desires. And yet she is forced to obey them? It&#39;s only natural that she doesn&#39;t help the princess to flee, and convinces the warlord that the city isn&#39;t worth attacking.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...I see.&quot;//&lt;/span&gt; Maaterasu meditates for a long while.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has slightly grown.&lt;/span&gt;

Maaterasu&#39;s views have grown less favorable to domination.//

//You lost &lt;span style=&quot;color:khaki&quot;&gt;25 social drive&lt;/span&gt;.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.socialdrive.current -= 25;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 100;
addPointsToDrive(gC(&quot;chAte&quot;).dDomination,-100);
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Discovering The Others Enters Taototh]]</tw-passagedata><tw-passagedata pid="380" name="SE Discovering The Others She Fears For the City" tags="" position="6970,894" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;The maid wants to protect the people of her city.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;How so?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;The warlord has conquered the deserts with violence, and he&#39;s considering finishing his campaign with the city where the princess lives - but the maid convinces him not to do so. The princess wants to flee and meet the warlord, but she&#39;s supposed to rule the city one day. If the warlord gets her, he will conquer the city without moving a finger, and the maid thinks this will be horrible for her people. This is why she laments that the warlord and the princess don&#39;t care about the happiness of others.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...I see.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has slightly grown.&lt;/span&gt;

Maaterasu&#39;s views have grown more favorable to cooperation and ambition.//

//You lost &lt;span style=&quot;color:khaki&quot;&gt;25 social drive&lt;/span&gt;.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.socialdrive.current -= 25;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 100;
addPointsToDrive(gC(&quot;chAte&quot;).dCooperation,100);
addPointsToDrive(gC(&quot;chAte&quot;).dAmbition,100);
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Discovering The Others Enters Taototh]]</tw-passagedata><tw-passagedata pid="381" name="SE Discovering The Others Intentionally Vague" tags="" position="7193,899" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;The author of the play&quot;//&lt;/span&gt;, you claim, &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;didn&#39;t want the maid&#39;s reasons to be clear.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Why do you think so?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You could interpret it in many different ways. Perhaps she loves the princess, and wants to protect her from the warlord. Perhaps she wants to be with the warlord, and she would be less likely to have it her way if she had to compete with the princess. Or perhaps she thinks both of them are selfish, and doesn&#39;t want any of them to fulfill their goals.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;And why would the author write it this way?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I don&#39;t know. But perhaps that is the point?&quot;//&lt;/span&gt; You reply as the thoughts get formed in your brain. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You can&#39;t always understand what&#39;s moving other people. Just like you can&#39;t say for sure what&#39;s moving the maid, you can&#39;t say for sure what was the author&#39;s reason. Perhaps this was what the author had in mind.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...I see.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has slightly grown.&lt;/span&gt;

Maaterasu&#39;s views have grown more favorable to cooperation.//

//You lost &lt;span style=&quot;color:khaki&quot;&gt;25 social drive&lt;/span&gt;.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.socialdrive.current -= 25;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 100;
addPointsToDrive(gC(&quot;chAte&quot;).dCooperation,100);
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Discovering The Others Enters Taototh]]</tw-passagedata><tw-passagedata pid="382" name="SE Discovering The Others Intentionally Open" tags="" position="7075,899" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;The author of the play&quot;//&lt;/span&gt;, you claim, &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;wanted the reader to interpret the maid in their own way.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I don&#39;t understand.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;There are many reasons why the maid could have burned the letter. Perhaps she loves the princess, and wants to protect her from the warlord. Perhaps she wants to be with the warlord, and she would be less likely to have it her way if she had to compete with the princess. Or perhaps she thinks both of them are selfish, and doesn&#39;t want any of them to fulfill their goals.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;And which one of those is correct?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Whichever the reader wants it to be. It is intentionally open so that everyone interprets the maid in a different way.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...I think that makes sense.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has slightly grown.&lt;/span&gt;

Maaterasu&#39;s views have grown more favorable to cooperation.//

//You lost &lt;span style=&quot;color:khaki&quot;&gt;25 social drive&lt;/span&gt;.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.socialdrive.current -= 25;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 100;
addPointsToDrive(gC(&quot;chAte&quot;).dCooperation,100);
&lt;&lt;/script&gt;&gt; \
[[Continue|SE Discovering The Others Enters Taototh]]</tw-passagedata><tw-passagedata pid="383" name="SE Discovering The Others Enters Taototh" tags="" position="7311,570" size="100,100">$customRoomIntro
&lt;span style=&quot;color:gray&quot;&gt;//&quot;Good morning, Candidates.&quot;//&lt;/span&gt; Says a serious male voice. As you turn around, you find Taototh, the Temple&#39;s Aiishen researcher. &lt;span style=&quot;color:gray&quot;&gt;//&quot;Maaterasu, $chPlayerCharacter.name.&quot;//&lt;/span&gt; He remarks.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Good morning, Taototh.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hello.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;I hope I&#39;m not interrupting you...&quot;//&lt;/span&gt;

You glance at Maaterasu. &lt;span @style=$chAte.colorStyleKey&gt;//&quot;$chPlayerCharacter.name was helping me in my studies, but we had finished.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Good, good. I have the artifact I mentioned the other day.&quot;//&lt;/span&gt; He hands a strange, golden, yet rusty cube to your peer, decorated by aquamarine hemispheres that bulge out of each of its sides. Maaterasu contemplates it for a moment, then takes it in her hands.

[[Continue|SE Discovering The Others Gift For Ate]]</tw-passagedata><tw-passagedata pid="384" name="SE Discovering The Others Gift For Ate" tags="" position="7420,570" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What is that? If I may ask.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;That is a casting artifact. Gifts from the Goddess to the tribes that serve to cast some forms of magic, at greater ease.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...And isn&#39;t that going to make Maaterasu even more dangerous in combat?&quot;//&lt;/span&gt;

He looks back at the Aiishen Candidate, as if expecting her to answer your question.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;This artifact will only help me to understand others.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;The form of magic that this artifact promotes,&quot;//&lt;/span&gt; Taototh intervenes, &lt;span style=&quot;color:gray&quot;&gt;//&quot;creates emotional connections between different persons. Perhaps you&#39;d like to help your fellow Candidate to give it a first try?&quot;//&lt;/span&gt;

[[Accept|SE Discovering The Others Feeling Ease]]
[[Refuse|SE Discovering The Others Refuse to Feel]]</tw-passagedata><tw-passagedata pid="385" name="SE Discovering The Others Feeling Ease" tags="" position="7310,684" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I must confess I&#39;m intrigued. I accept.&quot;//&lt;/span&gt;

Taototh shows a very faint smile.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;It would be best for you to hold each other&#39;s hands for this exercise.&quot;//&lt;/span&gt;

Maaterasu takes your hand without much contemplation, and your eyes meet soon later.

In them, you find a black lake, devouring of all lights, that engulf all illumination and warmth. It&#39;s only when everything has been devoured by them that you find the image of the Moon, white and whole... Which turns into an Aiishen. An Aiishen that has Maaterasu&#39;s face, and hands, and voice, but an expression completely alien to her. An expression of longing, of sad hope, that looks at you and beyond you as it offers you her hand. You&#39;re about to take it and-

Everything vanishes. You&#39;re back at the library, at the Temple, holding the real Maaterasu&#39;s hand and the real Maaterasu&#39;s eyes are placed on you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...What was that?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Breath at ease.&quot;//&lt;/span&gt; Taototh gives you a moment to realize that your breathing is, in fact, agitated, then continues. &lt;span style=&quot;color:gray&quot;&gt;//&quot;No one knows with certainty what each of you saw, but this spell should transform each involved person&#39;s honest feelings into forms best understood by those who receive them.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Does that mean... That I saw Maaterasu&#39;s feelings?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Your own interpretation of what she&#39;s truly feeling, assuming that everything went right.&quot;//&lt;/span&gt;

You look back at your Aiishen companion, whose eyes are closed - but it isn&#39;t long until she opens them.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Are you both feeling well?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I am.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I... I guess I am, too.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has grown a lot.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 500;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 500;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;if $StVars.check4 &gt; 2&gt;&gt; \
[[Continue|SE Discovering The Others Taototh Explanation]]
&lt;&lt;else&gt;&gt; \
[[Continue|SE Discovering The Others Leave Them]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="386" name="SE Discovering The Others Refuse to Feel" tags="" position="7419,682" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m sorry, but I... Feel tired.&quot;//&lt;/span&gt; Whether it is truly tiredness, fear or the rejection of potential intimancy what made you say that, is only known by you. But the disappointment in Taototh&#39;s face is obvious to anyone capable of reading expressions.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;I understand.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Thank you for your help, Taototh.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;It was nothing.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think I&#39;ll be taking my leave. It&#39;s about time to start the daily routine.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Yes, yes. I won&#39;t steal any more of your time. Farewell.&quot;//&lt;/span&gt;

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="387" name="SE Discovering The Others Leave Them" tags="" position="7315,895" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Then... I guess I&#39;ll be taking my leave. It&#39;s about time to start the day.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Yes, yes. I won&#39;t rob you of any more time. Farewell.&quot;//&lt;/span&gt;

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="388" name="SE Discovering The Others Taototh Explanation" tags="" position="7426,892" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Then... I guess I&#39;ll be taking my leave. It&#39;s about time to start the day.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Yes, yes. Farewell.&quot;//&lt;/span&gt;

All of you leave towards your destinations, but a short while later Taototh interrupts you yet again.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Excuse me. I couldn&#39;t help but notice that you&#39;ve invested some time in getting to know Maaterasu.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Yes, I have.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;And you also seem to be keen to trouble yourself for her sake. This is why I think I may trust you with something about her.&quot;//&lt;/span&gt;

His expression is serene, but you can&#39;t help but suspect that he isn&#39;t entirely certain that he should be having this conversation.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;That girl... That woman, I should say, hasn&#39;t had an easy childhood. Our tribe&#39;s leadership determined that she was fated to be someone of high importance for the Valley when she was born.&quot;//&lt;/span&gt;

You suddenly remember Maaterasu&#39;s words when you first met her.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Is that what she meant by having been chosen by the stars?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;That is exactly what she meant. What our tribe&#39;s tradition dictates. As the tradition dictates, she was forced to seclusion for long periods of her life.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...What!? Why?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Because our tradition dictates that those who are chosen by the stars must not grow overly attached to others.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Are you telling me to stay away from her?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;No. I&#39;m telling you to stay by her side, because she&#39;s ignorant in vital matters and needs your help. For the sake of the Temple.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

Taototh sighs. &lt;span style=&quot;color:gray&quot;&gt;//&quot;I hope I was right to trust you. Only time will tell. I won&#39;t rob you any more time, you probably have things to think about.&quot;//&lt;/span&gt; And he leaves.

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="389" name="Item Tests" tags="" position="1532,445" size="100,100">&lt;&lt;script&gt;&gt;

createEquipment(&quot;b7&quot;,&quot;chNash&quot;);
createEquipment(&quot;b7&quot;,&quot;chPlayerCharacter&quot;);
createEquipment(&quot;b0&quot;,&quot;chPlayerCharacter&quot;);
createEquipment(&quot;b1&quot;,&quot;chPlayerCharacter&quot;);
createEquipment(&quot;b2&quot;,&quot;chPlayerCharacter&quot;);
createEquipment(&quot;w0&quot;,&quot;chPlayerCharacter&quot;);
createEquipment(&quot;w1&quot;,&quot;chPlayerCharacter&quot;);
createEquipment(&quot;w2&quot;,&quot;chPlayerCharacter&quot;);
createEquipment(&quot;w3&quot;,&quot;chPlayerCharacter&quot;);
createEquipment(&quot;b0&quot;,&quot;chNash&quot;);
createEquipment(&quot;b1&quot;,&quot;chNash&quot;);
createEquipment(&quot;b0&quot;,&quot;chNash&quot;);
createEquipment(&quot;b2&quot;,&quot;chNash&quot;);
createEquipment(&quot;b3&quot;,&quot;chNash&quot;);
createEquipment(&quot;b4&quot;,&quot;chNash&quot;);
createEquipment(&quot;b5&quot;,&quot;chNash&quot;);
createEquipment(&quot;b7&quot;,&quot;chNash&quot;);
createEquipment(&quot;b7&quot;,&quot;chClaw&quot;);
createEquipment(&quot;b5&quot;,&quot;chDummy&quot;);
createEquipment(&quot;b7&quot;,&quot;chDummy&quot;);
createEquipment(&quot;b7&quot;,&quot;chDummy&quot;); 
createEquipment(&quot;b0&quot;,&quot;chAte&quot;);
createEquipment(&quot;b0&quot;,&quot;chVal&quot;);
createEquipment(&quot;b0&quot;,&quot;chMir&quot;);
equipObjectOnWearer(9,&quot;chClaw&quot;,3);
equipObjectOnWearer(10,&quot;chVal&quot;,3);
equipObjectOnWearer(11,&quot;chPlayerCharacter&quot;,3);
State.variables.chNash.lust.current = 1;
equipObjectOnWearer(1,&quot;chPlayerCharacter&quot;,2);
equipObjectOnWearer(2,&quot;chNash&quot;,3);
//unequipObject(0);
//createRelTypeServitudeDom(&quot;chNash&quot;,&quot;chPlayerCharacter&quot;,3);
//createRelTypeServitudeSub(&quot;chPlayerCharacter&quot;,&quot;chNash&quot;,3);
//createRelTypeServitudeDom(&quot;chNash&quot;,&quot;chMir&quot;,3);
//createRelTypeServitudeSub(&quot;chMir&quot;,&quot;chNash&quot;,3);

State.variables.StVars.check1 = &quot;physique&quot;;
State.variables.StVars.check2 = &quot;resilience&quot;;
State.variables.StVars.check3 = &quot;physique&quot;;
State.variables.StVars.check4 = &quot;agility&quot;;
State.variables.StVars.check5 = &quot;empathy&quot;;
State.variables.StVars.check6 = &quot;physique&quot;;
State.variables.chPlayerCharacter.physique.value = 4;
State.variables.chPlayerCharacter.resilience.value = 12;
reassignPlayerStats();
State.variables.logL1.push(getFinalPreferenceWeight(&quot;chNash&quot;,&quot;usePain&quot;));State.variables.logL1.push(getFinalPreferenceWeight(&quot;chNash&quot;,&quot;denial&quot;));
State.variables.chNash.tastes.useDick.w = 1000;
State.variables.chVal.tastes.usePussy.w = 1000;

State.variables.enabledMerchants = [0,30];
&lt;&lt;/script&gt;&gt; \
[[Quickstarts]]</tw-passagedata><tw-passagedata pid="390" name="SE The Merchants Start" tags="" position="7563,205" size="100,100">$customRoomIntro
An unfamiliar sight welcomes you at the Grand Hall. Many Candidates are gathered around a dancing Ashwalker man, who finishes some of his moves by punching the air, much like Nashillbyir practices her sparring. Nash herself appears by your side, and greets another Ashwalker woman who has also arrived today.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Nimeresh! You&#39;re here!&quot;//&lt;/span&gt; Nash shouts enthusiastically, hugging her.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Hello, little cousin. My, aren&#39;t you happy to see me?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;And Abibdill has come too.&quot;//&lt;/span&gt; Says Shrezdill, who has just appeared, looking at the man.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Ah, Shrezdill, it&#39;s been a long time. Hello you too, Nash.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Have you explained them what are you doing here?&quot;//&lt;/span&gt; 

&lt;span style=&quot;color:gray&quot;&gt;//&quot;No, we were waiting for all of them to come.&quot;//&lt;/span&gt; He replies, soon to be interrupted by her partner.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Or at least, he was. I was busy preparing the goods.&quot;//&lt;/span&gt;

Your eyes move to a couple of tables that the pair seems to have brought. One of them displays several weapons, but you can&#39;t quite identify the objects at the other one.

[[Continue|SE The Merchants Explanation]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="391" name="SE The Merchants Explanation" tags="" position="7673,205" size="100,100">$customRoomIntro
&lt;span style=&quot;color:gray&quot;&gt;//&quot;Ahaha. Let me introduce properly. I&#39;m Abibdill, and my friend here is Nimeresh. We&#39;re artisans from the Ashwalker tribe. We periodically supply the Passion Temple with some of our wares, and we hope that you find them useful during your training.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;For a price, you forget to mention.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;For a price, of course. Abibdill here crafts weapons, as you could imagine. As for myself,&quot;//&lt;/span&gt; Nimeresh explains, now pointing to one of the tables, &lt;span style=&quot;color:gray&quot;&gt;//&quot;I craft toys.&quot;//&lt;/span&gt;

You take another look at the objects you couldn&#39;t identify earlier. There are couples of leather cylinders bound by chains, black clothes the size of a palm with thick threads, small clamps, and more.

//Toys? How do you play with those?//

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I don&#39;t remember ever seeing that kind of toys. What are they?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;They&#39;re bondage.&quot;//&lt;/span&gt; Nimeresh hurries to answer, unable to hide an ample smile. &lt;span style=&quot;color:gray&quot;&gt;//&quot;They serve to incapacitate a friend, or a lover... Or a foe.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;m not sure &#39;toys&#39; is the best word to describe them...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Oh, don&#39;t worry, you&#39;ll have plenty of time to change your mind... Perhaps you&#39;d like to give them a try?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Me? Uh-&quot;//&lt;/span&gt;

[[Continue|SE The Merchants Bound Shapeshifter]]</tw-passagedata><tw-passagedata pid="392" name="SE The Merchants Bound Shapeshifter" tags="" position="7781,205" size="100,100">$customRoomIntro
&lt;span @style=$chVal.colorStyleKey&gt;//&quot;I&#39;d like to.&quot;//&lt;/span&gt; Valtan interrupts Padmiri, smiling confidently.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;The Shapeshifter will try them? Fine, fine...&quot;//&lt;/span&gt; Nimeresh leads Valtan to her table, and holds one of her toys for everyone to see. &lt;span style=&quot;color:gray&quot;&gt;//&quot;These are called handcuffs,&quot;//&lt;/span&gt; she explains, &lt;span style=&quot;color:gray&quot;&gt;//&quot;And they are placed around the wrists... And locked, like this.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Aha.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;If you have these on, it&#39;ll be considerably difficult for you to manipulate any object with your hands, and...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Wait, I can&#39;t move!&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;...You may be in for a hard time.&quot;//&lt;/span&gt; She says looking at Valtan&#39;s panicked face, enjoying herself.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That is kind of the point, Val...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;No, you don&#39;t get it, I can&#39;t... I can&#39;t shapeshift my arms out of this thing!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;That was your plan all along?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Of course, my toys would be quite useless if the wearer could simply wiggle their way out of them, which is why they&#39;re magically enchanted to prevent shapeshifting.&quot;//&lt;/span&gt; 

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;They&#39;re what!?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;m never forgetting that face of yours.&quot;//&lt;/span&gt; Mir says, chuckling.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;You should still be able to transform your appearance, but if someone traps you in these, you&#39;re still in for as much trouble as they want to give you.&quot;//&lt;/span&gt; Nimeresh winks at the Shapeshifter.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Of course, it could be possible to build an extreme advantage against the other Candidates with these things, which is why we&#39;ll be imposing some rules of use. If you find yourself in a position in which you can force bondage on someone, it may only be one item at a time, and it will have to come off in a few days.&quot;//&lt;/span&gt;

[[Continue|SE The Merchants Choose Wares]]</tw-passagedata><tw-passagedata pid="393" name="SE The Merchants Choose Wares" tags="" position="7564,312" size="100,100">$customRoomIntro
&lt;span style=&quot;color:gray&quot;&gt;//&quot;You&#39;re all free to take a closer look...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Check my weapons as well! You just ask and I&#39;ll demonstrate how you use each of them.&quot;//&lt;/span&gt; The man intervenes.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Wait, wait, get me out of these.&quot;//&lt;/span&gt; Valtan protests, visibly uncomfortable.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Oh, but you look so cute with them...&quot;//&lt;/span&gt;

[[Check weapons|SE The Merchants Check Weapons]]
[[Check bondage|SE The Merchants Check Bondage]]</tw-passagedata><tw-passagedata pid="394" name="SE The Merchants Check Weapons" tags="" position="7677,313" size="100,100">$customRoomIntro
Your interest for weaponry is larger today, and so you approach the weapons stand. Abibdill doesn&#39;t lose a second to catch your attention, and starts swinging a wooden staff around. Despite his efforts, he isn&#39;t really showing any technique you haven&#39;t seen in the last few days.

There are four types of objects on the table: there are staves, knuckles, as well as fans for some reason, and short sticks made of wood or minerals of diverse colors.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What are these?&quot;//&lt;/span&gt; You ask.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Yes, those are-&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Wands. They&#39;re filled with materials that conduct aether, and they&#39;re used to channel magic with ease.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Ahem.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And why are you selling fans?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;They&#39;re not the easiest weapon to use,&quot;//&lt;/span&gt; Abibdill answers, &lt;span style=&quot;color:gray&quot;&gt;//&quot;but they go well with certain techniques.&quot;//&lt;/span&gt; He takes one, opens it, and places it in front on his face, right below his eyes, as he gazes you intensely. &lt;span style=&quot;color:gray&quot;&gt;//&quot;When someone is hiding their expression, it&#39;s only natural to be curious about what their eyes are saying. And when you&#39;ve captured someone&#39;s eyes, your words will reach them deeper.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;But not as deep as a good punch in the guts.&quot;//&lt;/span&gt; Opines Claw, who is checking the looks of the knuckles she&#39;s now wearing.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;The knuckles are great if you&#39;re capable of maintaining the offensive. The staff, on the other hand, is a much safer weapon.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check1 eq &quot;nash&quot;&gt;&gt; \
[[Continue|SE The Merchants Nash Offensive]]
&lt;&lt;elseif $StVars.check1 eq &quot;mir&quot;&gt;&gt; \
[[Continue|SE The Merchants Mir Offensive]]
&lt;&lt;else&gt;&gt; \
[[Continue|SE The Merchants Val Offensive]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="395" name="SE The Merchants Check Bondage" tags="" position="7882,316" size="100,100">$customRoomIntro
You decide to approach the table of the bondage items, not as well known for you. Nimeresh gives in to Valtan&#39;s cries and frees her arms, which allows her to dedicate her soon-to-be clients her full attention.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What is this loin of cloth?&quot;//&lt;/span&gt; You ask.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;That is a blindfold. You place it on your partner&#39;s eyes, put the thread behind their head, tie it, and close it with a lock. Put the cloth in front of your eyes.&quot;//&lt;/span&gt;

Perhaps too innocently, you do as she says.

//This doesn&#39;t completely block my vision, but everything&#39;s turned into very vague shapes of black.//

Fortunately, no one&#39;s taking advantage of your position to close the blindfold&#39;s lock.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;That piece of cloth is... Magical, in its own way.&quot;//&lt;/span&gt; As you hear her words, getting closer and closer, you feel a finger running through your face, and something viscous caress your ear. &lt;span style=&quot;color:gray&quot;&gt;//&quot;When you aren&#39;t certain about what&#39;s happening, even the most mundane things may turn into fantasy.&quot;//&lt;/span&gt; This time, the words are whispered into your ear, and you feel the finger falling to your neck.

You decide to take the blindfold off, and you find Nimeresh&#39;s face right next to yours, as she licks her lips.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I&#39;ve noticed that the blindfold doesn&#39;t completely block my vision.&quot;//&lt;/span&gt; You mention.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Then it&#39;s working as intended. The pieces I&#39;ll be selling here are for long-term use, so it would be problematic if they turned someone completely uncapable.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hey, Nim. I&#39;m wondering about this thing...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Yes, tell me.&quot;//&lt;/span&gt;

Nimeresh leaves your side to solve the doubts of the other Candidates. In front of you, a collar lies open...

&lt;&lt;if $StVars.check5 eq &quot;true&quot;&gt;&gt; \
[[Lock it on Nashillbyir|SE The Merchants Locked Nash]]
&lt;&lt;else&gt;&gt; \
[[Lock it on Nashillbyir|SE The Merchants Free Nash]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check6 eq &quot;true&quot;&gt;&gt; \
[[Lock it on Padmiri|SE The Merchants Locked Mir]]
&lt;&lt;else&gt;&gt; \
[[Lock it on Padmiri|SE The Merchants Free Mir]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check7 eq &quot;true&quot;&gt;&gt; \
[[Lock it on Valtan|SE The Merchants Locked Val]]
&lt;&lt;else&gt;&gt; \
[[Lock it on Valtan|SE The Merchants Free Val]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check8 eq &quot;true&quot;&gt;&gt; \
[[Lock it on Maaterasu|SE The Merchants Locked Ate]]
&lt;&lt;else&gt;&gt; \
[[Lock it on Maaterasu|SE The Merchants Free Ate]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check9 eq &quot;true&quot;&gt;&gt; \
[[Lock it on Claw|SE The Merchants Locked Claw]]
&lt;&lt;else&gt;&gt; \
[[Lock it on Claw|SE The Merchants Free Claw]]
&lt;&lt;/if&gt;&gt; \
[[Dismiss the idea|SE The Merchants Choosing Weapons]]</tw-passagedata><tw-passagedata pid="396" name="SE The Merchants Nash Offensive" tags="" position="7565,432" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hey, $chPlayerCharacter.name, turn around.&quot;//&lt;/span&gt;

You turn towards Nashillbyir, who&#39;s calling you from behind. When you see her, she&#39;s holding an open collar... And she&#39;s about to put it on you.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let me try this on you!&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check10 is true&gt;&gt;&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You need &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check3 willpower&lt;/span&gt;.&lt;&lt;else&gt;&gt;[[Stop her|SE The Merchants Nash Fails]] (Costs &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check3 willpower&lt;/span&gt;)&lt;&lt;/if&gt;&gt;
[[Surrender your neck|SE The Merchants Nash Locks You]]</tw-passagedata><tw-passagedata pid="397" name="SE The Merchants Mir Offensive" tags="" position="7681,435" size="100,100">$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;$chPlayerCharacter.name, would you mind facing me?&quot;//&lt;/span&gt;

You turn around upon hearing Padmiri&#39;s voice, who was right behind you... With an open collar right in front of your neck.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I want to see how this looks on you.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check10 is true&gt;&gt;&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You need &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check2 willpower&lt;/span&gt;.&lt;&lt;else&gt;&gt;[[Stop her|SE The Merchants Mir Fails]] (Costs &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check2 willpower&lt;/span&gt;)&lt;&lt;/if&gt;&gt;
[[Surrender your neck|SE The Merchants Mir Locks You]]</tw-passagedata><tw-passagedata pid="398" name="SE The Merchants Val Offensive" tags="" position="7795,435" size="100,100">$customRoomIntro
&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hey, $chPlayerCharacter.name, I have something for you.&quot;//&lt;/span&gt;

Your turn back to see Valtan, who has just called you. What she&#39;s holding for you, is an open collar, getting dangerously closer to you.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You&#39;re going to look lovely with this.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check10 is true&gt;&gt;&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You need &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check4 willpower&lt;/span&gt;.&lt;&lt;else&gt;&gt;[[Stop her|SE The Merchants Val Fails]] (Costs &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check4 willpower&lt;/span&gt;)&lt;&lt;/if&gt;&gt;
[[Surrender your neck|SE The Merchants Val Locks You]]</tw-passagedata><tw-passagedata pid="399" name="SE The Merchants Nash Locks You" tags="" position="7565,540" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I-I-&quot;//&lt;/span&gt; You mumble as the bondage piece gets locked.

//Your neck is now locked.//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It looks great! How are you feeling?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;A bit... Weak in my knees? It feels like someone is grabbing my heart...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Are you trying my toys already? Nash, Nash, if you close a lock, you have to pay for the key.&quot;//&lt;/span&gt; Nimeresh says. &lt;span style=&quot;color:gray&quot;&gt;//&quot;But I must say that you have good taste.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;How much will it be?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;For just a collar, 750 veerens.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Right, here you go.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh, excuse me... Shouldn&#39;t I have the key?&quot;//&lt;/span&gt;

Both Ashwalkers look at you with a confused expression.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Honey, bondage is locked by its owner. That collar stays on for as long as Nash wants.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Or until it&#39;s been enough days, according to our rules.&quot;//&lt;/span&gt; Shrezdill adds.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Right.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let&#39;s just leave it on for a bit longer, alright?&quot;//&lt;/span&gt;

//What&#39;s happening to me? I want to refuse, but my throat feels heavy...//

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Nashillbyir has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Nashillbyir has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chNash.money -= 750;
createEquipment(&quot;b0&quot;,&quot;chNash&quot;);
equipObjectOnWearer(1,&quot;chPlayerCharacter&quot;,gSettings().equipmentDuration);
State.variables.chPlayerCharacter.relations.chNash.submission.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.domination.stv += 150;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chNash.rivalry.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.rivalry.stv += 150;

gC(&quot;chNash&quot;).socialAi.covetTs.push(&quot;chPlayerCharacter&quot;);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="400" name="SE The Merchants Nash Fails" tags="" position="7565,647" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Stop that!&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check3 willpower&lt;/span&gt;.//

You rush to grab the collar, stopping it before it closes in.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I only want to see how it looks on you...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;If you close the lock, you&#39;ll have to buy the key from me.&quot;//&lt;/span&gt; Nimeresh says. &lt;span style=&quot;color:gray&quot;&gt;//&quot;But I&#39;m sure you have the money.&quot;//&lt;/span&gt; She adds, smiling.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How about we try it on you, then?&quot;//&lt;/span&gt; You answer to Nash.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Nngh, fine, nevermind...&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your submission towards Nashillbyir has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your sexual tension with Nashillbyir has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Nashillbyir has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= State.variables.StVars.check3;
State.variables.chPlayerCharacter.relations.chNash.submission.stv -= 150;
State.variables.chNash.relations.chPlayerCharacter.domination.stv -= 150;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv -= 150;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv -= 150;
State.variables.chPlayerCharacter.relations.chNash.enmity.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.enmity.stv += 150;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="401" name="SE The Merchants Mir Locks You" tags="" position="7678,540" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;W-Wait-&quot;//&lt;/span&gt; You mumble as the bondage piece gets locked.

//Your neck is now locked.//

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Aah, you look so cute. How does it feel?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It&#39;s cold... But it also feels like it&#39;s hugging me, it&#39;s trapping me in a hug and it won&#39;t let me go.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Are you trying my toys already? If you close a lock, you have to pay for the key.&quot;//&lt;/span&gt; Nimeresh says. &lt;span style=&quot;color:gray&quot;&gt;//&quot;But I must say that you have good taste.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Sure. How much do I owe you?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;For just a collar, 750 veerens.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Let&#39;s see... Here, have this.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Um, excuse me... Shouldn&#39;t I have the key?&quot;//&lt;/span&gt;

Both Padmiri and Nimeresh look at you with a confused expression.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Honey, bondage is locked by its owner. That collar stays on for as long as the Leirien wants.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Or until it&#39;s been enough days, according to our rules.&quot;//&lt;/span&gt; Shrezdill adds.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Right.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Oh, then let&#39;s leave it on for a few days.&quot;//&lt;/span&gt;

//What&#39;s happening to me? I want to refuse, but my throat feels heavy...//

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Padmiri has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chMir.money -= 750;
createEquipment(&quot;b0&quot;,&quot;chMir&quot;);
equipObjectOnWearer(1,&quot;chPlayerCharacter&quot;,gSettings().equipmentDuration);
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 150;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chMir.rivalry.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.rivalry.stv += 150;
gC(&quot;chMir&quot;).socialAi.covetTs.push(&quot;chPlayerCharacter&quot;);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="402" name="SE The Merchants Mir Fails" tags="" position="7678,645" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And I don&#39;t want to see how it looks on me.&quot;//&lt;/span&gt; You say immediately after pushing the collar aside.

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check2 willpower&lt;/span&gt;.//

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Is that so?&quot;//&lt;/span&gt; She says, slightly dissapointed.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;If you close the lock, you&#39;ll have to buy the key from me.&quot;//&lt;/span&gt; Nimeresh says. &lt;span style=&quot;color:gray&quot;&gt;//&quot;But I&#39;m sure you have the money.&quot;//&lt;/span&gt; She adds, smiling.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Hmm. Perhaps another day, then.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your submission towards Padmiri has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your sexual tension with Padmiri has slightly decreased.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= State.variables.StVars.check2;
State.variables.chPlayerCharacter.relations.chMir.submission.stv -= 150;
State.variables.chMir.relations.chPlayerCharacter.domination.stv -= 150;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv -= 150;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv -= 150;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 150;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 150;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="403" name="SE The Merchants Val Locks You" tags="" position="7796,539" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t...&quot;//&lt;/span&gt; But your words are barely leaving your mouth when the collar closes in.

//Your neck is now locked.//

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;It looks gorgeous. You&#39;ll agree when you see it for yourself.&quot;//&lt;/span&gt;

//What&#39;s this? I&#39;m feeling dizzy...//

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Are you trying my toys already? If you close a lock, you have to pay for the key.&quot;//&lt;/span&gt; Nimeresh says. &lt;span style=&quot;color:gray&quot;&gt;//&quot;But I must say that you have good taste.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Of course. How much is it?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;For just a collar, 750 veerens.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hmm... Here, this should be enough.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wait... Shouldn&#39;t I have the key?&quot;//&lt;/span&gt;

Both Valtan and Nimeresh look at you with a confused expression.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Honey, bondage is locked by its owner. That collar stays on for as long as the Shapeshifter wants.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Or until it&#39;s been enough days, according to our rules.&quot;//&lt;/span&gt; Shrezdill adds.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Right.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Let&#39;s leave it on for as long as the rules allow, then.&quot;//&lt;/span&gt;

//What? Wait, what&#39;s happening to me? I want to protest, but my throat feels heavy...//

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Valtan has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Valtan has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Valtan has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chVal.money -= 750;
createEquipment(&quot;b0&quot;,&quot;chVal&quot;);
equipObjectOnWearer(1,&quot;chPlayerCharacter&quot;,gSettings().equipmentDuration);
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 150;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chVal.rivalry.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.rivalry.stv += 150;
gC(&quot;chVal&quot;).socialAi.covetTs.push(&quot;chPlayerCharacter&quot;);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="404" name="SE The Merchants Val Fails" tags="" position="7796,645" size="100,100">$customRoomIntro
But you stop the collar in its tracks, right before it gets closed around you. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m not going to look anything, because you aren&#39;t putting it on me.&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check4 willpower&lt;/span&gt;.//

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Oh? But I&#39;ll take it off real soon.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;If you close the lock, you&#39;ll have to buy the key from me.&quot;//&lt;/span&gt; Nimeresh says. &lt;span style=&quot;color:gray&quot;&gt;//&quot;But I&#39;m sure you have the money.&quot;//&lt;/span&gt; She adds, smiling.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How about you desist right now, instead?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hmpf. Fine.&quot;//&lt;/span&gt; She surrenders.

//&lt;span style=&quot;color:gray&quot;&gt;Your submission towards Valtan has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your sexual tension with Valtan has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Valtan has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= State.variables.StVars.check4;
State.variables.chPlayerCharacter.relations.chVal.submission.stv -= 150;
State.variables.chVal.relations.chPlayerCharacter.domination.stv -= 150;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv -= 150;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv -= 150;
State.variables.chPlayerCharacter.relations.chVal.enmity.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.enmity.stv += 150;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="405" name="SE The Merchants Locked Nash" tags="" position="7918,450" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And there is really no way to take them off? It would be really troublesome if I couldn&#39;t move freely...&quot;//&lt;/span&gt; Nash asks to Nimeresh, unaware of your intentions.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;You know the affection I have for you, but do you really think I&#39;d tell you, or anyone, if my crafts were flawed?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;So what happens if someone loses a key?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nash, look at me for a moment.&quot;//&lt;/span&gt; You call her.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hum?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:green&quot;&gt;Charisma AND will AND submission AND sexual tension check: passed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Keep quiet and smile for me.&quot;//&lt;/span&gt; You order as you lock the collar on her neck, without waiting for her reaction.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What are you...?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;There.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Woah! This girl has guts.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Have you just...?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sure I have! It looks great on you. Will you pose for me?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Sorry to interrupt you, but if you lock any of my items, you have to buy the key. It will be 750 veerens.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;750? Let me see... Here you go.&quot;//&lt;/span&gt;

Nash contemplates with a palid face how you take the key to her collar, but remains frozen in place.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nash? I asked you to smile. Are you well?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Ah? S-Sure. I&#39;m f-fine.&quot;//&lt;/span&gt; She replies, and she fakes a smile for you.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;You got played there, Nashy! Enjoy yourself, and don&#39;t fight your guts too much.&quot;//&lt;/span&gt;

//You have bought a collar.//
//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Nashillbyir has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Nashillbyir has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.money -= 750;
createEquipment(&quot;b0&quot;,&quot;chPlayerCharacter&quot;);
equipObjectOnWearer(1,&quot;chNash&quot;,gSettings().equipmentDuration);
State.variables.chPlayerCharacter.relations.chNash.domination.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.submission.stv += 150;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chNash.rivalry.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.rivalry.stv += 150;
gC(&quot;chNash&quot;).socialAi.rivalTs = [];
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="406" name="SE The Merchants Locked Mir" tags="" position="8038,447" size="100,100">$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You have to admit that was really funny. You were absolutely certain that you were going to have a laugh at the expense of that woman, and you ran straight into a trap with your name on it.&quot;//&lt;/span&gt; Padmiri mocks Val.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Shut up. I got really scared for a moment.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You, scared? Aren&#39;t you the one who always acts like the world is a toy in her hands? I thought that you would have enjoyed even that.&quot;//&lt;/span&gt;

Valtan sighs, tired of hearing Padmiri&#39;s thoughts.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Mind facing me for a moment, Padmiri?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Sure, what is it...?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:green&quot;&gt;Charisma AND will AND submission AND sexual tension check: passed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Give me a bright smile.&quot;//&lt;/span&gt; You don&#39;t wait to hear her opinion on the matter - as soon as she&#39;s looking at you, you place the collar around her neck, and click the lock.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Huh? Huh!?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Ha! Haha!&quot;//&lt;/span&gt; Valtan laughs satisfied.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Are you playing with my collars? If you&#39;ve locked that you&#39;ll have to pay for the key.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Oh, sure. How much will it be?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;For just a collar, 750 veerens.&quot;//&lt;/span&gt;

You pay her the money and receive the key, in front of Padmiri&#39;s astonished face.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Well? $chPlayerCharacter.name asked you to smile for her.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Um... Yes...&quot;//&lt;/span&gt; Padmiri fakes a smile, trying to comply with your earlier demand. The smile, however, isn&#39;t natural at all.

//You have bought a collar.//
//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Padmiri has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Valtan has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.money -= 750;
createEquipment(&quot;b0&quot;,&quot;chPlayerCharacter&quot;);
equipObjectOnWearer(1,&quot;chMir&quot;,gSettings().equipmentDuration);
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 150;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chMir.rivalry.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.rivalry.stv += 150;
State.variables.chPlayerCharacter.relations.chVal.friendship.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.friendship.stv += 150;
gC(&quot;chMir&quot;).socialAi.rivalTs = [];
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="407" name="SE The Merchants Locked Val" tags="" position="8143,449" size="100,100">$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You have to admit that was really funny. You were absolutely certain that you were going to have a laugh at the expense of that woman, and you ran straight into a trap with your name on it.&quot;//&lt;/span&gt; Padmiri mocks Val.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Shut up. I got really scared for a moment.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You, scared? Aren&#39;t you the one who always acts like the world is a toy in her hands? I thought that you would have enjoyed even that.&quot;//&lt;/span&gt;

Valtan sighs, tired of hearing Padmiri&#39;s thoughts.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Mind facing me for a moment, Valtan?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What is it now?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:green&quot;&gt;Agility AND will AND submission AND sexual tension check: passed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Be good and smile for me.&quot;//&lt;/span&gt; You say as you push the collar towards her neck, waiting for no answer.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What? Why!?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I thought you&#39;d look cute. I wasn&#39;t wrong!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Looks like you weren&#39;t done for today.&quot;//&lt;/span&gt; Padmiri comments, containing her laughter.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Are you playing with my collars? If you&#39;ve locked that you&#39;ll have to pay for the key.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Oh, sure. How much will it be?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;For just a collar, 750 veerens.&quot;//&lt;/span&gt;

You pay her the money and receive the key, in front of Valtan&#39;s indignated face.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;But... I didn&#39;t...&quot;//&lt;/span&gt; She mumbles, defeated.

//You have bought a collar.//
//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Valtan has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Valtan has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Valtan has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.money -= 750;
createEquipment(&quot;b0&quot;,&quot;chPlayerCharacter&quot;);
equipObjectOnWearer(1,&quot;chVal&quot;,gSettings().equipmentDuration);
State.variables.chPlayerCharacter.relations.chVal.domination.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.submission.stv += 150;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chVal.rivalry.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.rivalry.stv += 150;
gC(&quot;chVal&quot;).socialAi.rivalTs = [];
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="408" name="SE The Merchants Locked Ate" tags="" position="8020,319" size="100,100">$customRoomIntro
&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I still don&#39;t understand. Why would you waste your time insulting your opponent?&quot;//&lt;/span&gt; Maaterasu asks Abibdill, who is holding a fan, next to his face.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;To cloud their judgement, of course! An angry adversary is an adversary who will let their guard down.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;In short words: you don&#39;t trust your own strength and you need your enemy to commit mistakes.&quot;//&lt;/span&gt; Claw says.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;That&#39;s not exactly how I&#39;d put it...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ate, would you mind turning to me?&quot;//&lt;/span&gt; You ask her, and she complies.

&lt;span style=&quot;color:green&quot;&gt;Luck AND will AND submission AND sexual tension check: passed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Stay still for a moment, ok?&quot;//&lt;/span&gt; You say as you move the collar towards her.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I don&#39;t...&quot;//&lt;/span&gt; But her fate is sealed - or rather, her neck is, and the words die in her throat.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;That was... Certainly something.&quot;//&lt;/span&gt; Abibdill says.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Tsch. Pitiful.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Can you smile for me? I&#39;ve been wanting to see you smile for a while.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Have you locked one of my collars?&quot;//&lt;/span&gt; Nimeresh asks. &lt;span style=&quot;color:gray&quot;&gt;//&quot;You&#39;ll have to buy the key, then. It&#39;s 750 veerens.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sure, have this.&quot;//&lt;/span&gt;

Maaterasu tries to object as you take the key, but the words just won&#39;t leave her mouth. Given that she&#39;s not having an easy time, you decide to let her off the hook, for now.

//You have bought a collar.//
//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Maaterasu has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Maaterasu has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Maaterasu has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Claw has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.money -= 750;
createEquipment(&quot;b0&quot;,&quot;chPlayerCharacter&quot;);
equipObjectOnWearer(1,&quot;chAte&quot;,gSettings().equipmentDuration);
State.variables.chPlayerCharacter.relations.chAte.domination.stv += 150;
State.variables.chAte.relations.chPlayerCharacter.submission.stv += 150;
State.variables.chPlayerCharacter.relations.chAte.sexualTension.stv += 150;
State.variables.chAte.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chAte.rivalry.stv += 150;
State.variables.chAte.relations.chPlayerCharacter.rivalry.stv += 150;
gC(&quot;chAte&quot;).socialAi.rivalTs = [];
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="409" name="SE The Merchants Locked Claw" tags="" position="8021,215" size="100,100">$customRoomIntro
&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I still don&#39;t understand. Why would you waste your time insulting your opponent?&quot;//&lt;/span&gt; Maaterasu asks Abibdill, who is holding a fan, next to his face.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;To cloud their judgement, of course! An angry adversary is an adversary who will let their guard down.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;In short words: you don&#39;t trust your own strength and you need your enemy to commit mistakes.&quot;//&lt;/span&gt; Claw says.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;That&#39;s not exactly how I&#39;d put it...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hey, Claw!&quot;//&lt;/span&gt; You call the Beastkin.

&lt;span style=&quot;color:green&quot;&gt;Agility AND will AND submission AND sexual tension check: passed.&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;What?&quot;//&lt;/span&gt; She says while she turns back to face you, only to feel the collar closing around her neck. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;What have you just...!?&quot;//&lt;/span&gt; Her expression turns ugly, as ugly as the murder she&#39;s already planning.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;That was... Certainly something.&quot;//&lt;/span&gt; Abibdill says.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I wanted to see how it looked on you. It looks great!&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;That is a collar of submission. The constant pressure it provokes on the neck, as well as the enchantments that they usually carry, are designed to force the will of the wearer to submit.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I know that, you little...!&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Have you locked one of my collars?&quot;//&lt;/span&gt; Nimeresh asks. &lt;span style=&quot;color:gray&quot;&gt;//&quot;You&#39;ll have to buy the key, then. It&#39;s 750 veerens.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sure, have this.&quot;//&lt;/span&gt;

Claw looks horrified as you take the key off Nimeresh&#39;s hands, but is unable to protest. You savor the feel of victory.

//You have bought a collar.//
//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Claw has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Claw has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Claw has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.money -= 750;
createEquipment(&quot;b0&quot;,&quot;chPlayerCharacter&quot;);
equipObjectOnWearer(1,&quot;chClaw&quot;,gSettings().equipmentDuration);
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 150;
gC(&quot;chClaw&quot;).socialAi.rivalTs = [];
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="410" name="SE The Merchants Free Nash" tags="" position="7931,557" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And there is really no way to take them off? It would be really troublesome if I couldn&#39;t move freely...&quot;//&lt;/span&gt; Nash asks to Nimeresh, unaware of your intentions.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;You know the affection I have for you, but do you really think I&#39;d tell you, or anyone, if my crafts were flawed?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;So what happens if someone loses a key?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nash, look at me for a moment.&quot;//&lt;/span&gt; You call her.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hum?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:red&quot;&gt;Charisma AND will AND submission AND sexual tension check: failed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Just wait for a moment.&quot;//&lt;/span&gt; Your order as you try to lock the collar in her neck, but she reacts in the last second and stops your arm.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What are you doing?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Trying the collar on you.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And have you thought that perhaps I didn&#39;t want that?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Sheesh, Nash, what a way to spoil the fun.&quot;//&lt;/span&gt;

Nashillbyir looks at Nimeresh with a face that could pierce her from side to side, and so does to you a second later.

//That didn&#39;t go well.//

//&lt;span style=&quot;color:gray&quot;&gt;Your domination towards Nashillbyir has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your sexual tension with Nashillbyir has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Nashillbyir has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.domination.stv -= 150;
State.variables.chNash.relations.chPlayerCharacter.submission.stv -= 150;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv -= 150;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv -= 150;
State.variables.chPlayerCharacter.relations.chNash.enmity.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.enmity.stv += 150;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="411" name="SE The Merchants Free Mir" tags="" position="8038,560" size="100,100">$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You have to admit that was really funny. You were absolutely certain that you were going to have a laugh at the expense of that woman, and you ran straight into a trap with your name on it.&quot;//&lt;/span&gt; Padmiri mocks Val.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Shut up. I got really scared for a moment.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You, scared? Aren&#39;t you the one who always acts like the world is a toy in her hands? I thought that you would have enjoyed even that.&quot;//&lt;/span&gt;

Valtan sighs, tired of hearing Padmiri&#39;s thoughts.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Mind facing me for a moment, Padmiri?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Sure, what is it...?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:red&quot;&gt;Charisma AND will AND submission AND sexual tension check: failed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Just keep quiet for a moment.&quot;//&lt;/span&gt; You order as you calmly bring the collar to her neck.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Wait! What are you doing!?&quot;//&lt;/span&gt; She shouts, having stopped you just before you were successful.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Just... Checking how it looks on you?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And who gave you the right to...? Wait, no, hahaha! Hahahaha!&quot;//&lt;/span&gt;

Much to your surprise, Valtan has started tickling Padmiri&#39;s armpits, which appear to be a weak spot. The Shapeshifter gives you a short look. You understand her intentions, and take advantage of the situation to finish what you started.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;How dare...! ...You...&quot;//&lt;/span&gt; Padmiri&#39;s voice dies off.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Are you playing with my collars? If you closed a lock, you&#39;ll have to pay for the key.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sure. How much is it?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Just 750 veerens.&quot;//&lt;/span&gt;

You pay her the money and receive the key, in front of Padmiri&#39;s defeated face.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What&#39;s the problem, Mir? I thought you were in the mood for some laughs today.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Just... Shut up.&quot;//&lt;/span&gt; 

//You have bought a collar.//
//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Valtan has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.money -= 750;
createEquipment(&quot;b0&quot;,&quot;chPlayerCharacter&quot;);
equipObjectOnWearer(1,&quot;chMir&quot;,gSettings().equipmentDuration);
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 150;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chMir.enmity.stv += 300;
State.variables.chMir.relations.chPlayerCharacter.enmity.stv += 300;
State.variables.chPlayerCharacter.relations.chVal.friendship.stv += 150;
State.variables.chVal.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chVal.relations.chMir.rivalry.stv += 300;
State.variables.chMir.relations.chVal.rivalry.stv += 300;
State.variables.chVal.relations.chMir.submission.stv -= 150;
State.variables.chMir.relations.chVal.domination.stv -= 150;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="412" name="SE The Merchants Free Val" tags="" position="8143,555" size="100,100">$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You have to admit that was really funny. You were absolutely certain that you were going to have a laugh at the expense of that woman, and you ran straight into a trap with your name on it.&quot;//&lt;/span&gt; Padmiri mocks Val.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Shut up. I got really scared for a moment.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You, scared? Aren&#39;t you the one who always acts like the world is a toy in her hands? I thought that you would have enjoyed even that.&quot;//&lt;/span&gt;

Valtan sighs, tired of hearing Padmiri&#39;s thoughts.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Mind facing me for a moment, Valtan?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What is it now?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:red&quot;&gt;Agility AND will AND submission AND sexual tension check: failed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Stay quiet for a moment, ok?&quot;//&lt;/span&gt; You say as you prepare to lock the collar on her neck.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;No!&quot;//&lt;/span&gt; She shouts, grabbing your arm. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;What&#39;s your problem!?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I thought...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Calm down, Val.&quot;//&lt;/span&gt; Padmiri comments.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Why would you...! Ngh.&quot;//&lt;/span&gt; She protests, right before pushing you aside and walking away.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Looks like she&#39;s really annoyed, after all...&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your domination towards Valtan has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your sexual tension with Valtan has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Valtan has grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.domination.stv -= 150;
State.variables.chVal.relations.chPlayerCharacter.submission.stv -= 150;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv -= 150;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv -= 150;
State.variables.chPlayerCharacter.relations.chVal.enmity.stv += 300;
State.variables.chVal.relations.chPlayerCharacter.enmity.stv += 300;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="413" name="SE The Merchants Free Ate" tags="" position="8126,314" size="100,100">$customRoomIntro
&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I still don&#39;t understand. Why would you waste your time insulting your opponent?&quot;//&lt;/span&gt; Maaterasu asks Abibdill, who is holding a fan, next to his face.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;To cloud their judgement, of course! An angry adversary is an adversary who will let their guard down.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;In short words: you don&#39;t trust your own strength and you need your enemy to commit mistakes.&quot;//&lt;/span&gt; Claw says.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;That&#39;s not exactly how I&#39;d put it...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ate, would you mind turning to me?&quot;//&lt;/span&gt; You ask her, and she complies.

&lt;span style=&quot;color:red&quot;&gt;Luck AND will AND submission AND sexual tension check: failed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Stay still for me, just for a second.&quot;//&lt;/span&gt; You say as you move the collar towards her.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Wait.&quot;//&lt;/span&gt; She says, stopping your hand in place. &lt;span @style=$chAte.colorStyleKey&gt;//&quot;I&#39;ve heard of the effects of these collars. I don&#39;t want to wear that.&quot;//&lt;/span&gt; She states, almost expressionless.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf. What a sad try.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But... How do you know you won&#39;t like it until you try?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...I just know.&quot;//&lt;/span&gt;

Her eyes pierce your face, commanding you to stop struggling, until you give up and let her go.

//&lt;span style=&quot;color:gray&quot;&gt;Your domination towards Maaterasu has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your sexual tension with Maaterasu has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Maaterasu has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chAte.domination.stv -= 150;
State.variables.chAte.relations.chPlayerCharacter.submission.stv -= 150;
State.variables.chPlayerCharacter.relations.chAte.sexualTension.stv -= 150;
State.variables.chAte.relations.chPlayerCharacter.sexualTension.stv -= 150;
State.variables.chPlayerCharacter.relations.chAte.rivalry.stv += 150;
State.variables.chAte.relations.chPlayerCharacter.rivalry.stv += 150;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="414" name="SE The Merchants Free Claw" tags="" position="8130,209" size="100,100">$customRoomIntro
&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I still don&#39;t understand. Why would you waste your time insulting your opponent?&quot;//&lt;/span&gt; Maaterasu asks Abibdill, who is holding a fan, next to his face.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;To cloud their judgement, of course! An angry adversary is an adversary who will let their guard down.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;In short words: you don&#39;t trust your own strength and you need your enemy to commit mistakes.&quot;//&lt;/span&gt; Claw says.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;That&#39;s not exactly how I&#39;d put it...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hey, Claw!&quot;//&lt;/span&gt; You call the Beastkin.

&lt;span style=&quot;color:red&quot;&gt;Agility AND will AND submission AND sexual tension check: failed.&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;What?&quot;//&lt;/span&gt; She asks, turning to you. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Wait, what the blazes!?&quot;//&lt;/span&gt; She has spotted the collar and grabbed your arm.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I... Wanted to see how it looked on you?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;That is a collar of submission. The constant pressure it provokes on the neck, as well as the enchantments that they usually carry, are designed to force the will of the wearer to submit.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Thank you Ate, but... Ah!&quot;//&lt;/span&gt;

Claw has just scratched your face, and you instinctively take your hands to the wound. You notice too late: Claw has taken the collar off your hands and she&#39;s locking it around //your// neck.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Serves you right.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Have you locked one of my collars?&quot;//&lt;/span&gt; Nimeresh asks. &lt;span style=&quot;color:gray&quot;&gt;//&quot;You&#39;ll have to buy the key, then. It&#39;s 750 veerens.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Ssshhh... Fine.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Claw has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Claw has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Claw has slightly grown.&lt;/span&gt;//

[[Continue|SE The Merchants Choosing Weapons]]
&lt;&lt;script&gt;&gt;
State.variables.chClaw.money -= 750;
createEquipment(&quot;b0&quot;,&quot;chClaw&quot;);
equipObjectOnWearer(1,&quot;chPlayerCharacter&quot;,gSettings().equipmentDuration);
State.variables.chPlayerCharacter.relations.chClaw.submission.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.domination.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 150;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="415" name="SE The Merchants Choosing Weapons" tags="" position="7640,775" size="100,100">$customRoomIntro
&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Listen to me, everyone.&quot;//&lt;/span&gt; Shrezdill calls with an authoritative tone. &lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Whenever merchants come to the Temple, you will always have the opportunity to browse their wares and buy at the end of the day. This time, however, the Temple will put in the money for every Candidate who doesn&#39;t have a weapon yet, in order to level the field. If you still haven&#39;t, take a moment to look at the weapons and choose one.&quot;//&lt;/span&gt;

&#39;&#39;Staff of battle&#39;&#39;
A wooden staff, great for physical offense and defense. Increases physique and resilience.
[[Choose the staff of battle|SE The Merchants Staff End]]

&#39;&#39;Knuckles&#39;&#39;
Brass knuckles that will make the user pack a punch. Increases physique and agility.
[[Choose the knuckles|SE The Merchants Knuckles End]]

&#39;&#39;Wand&#39;&#39;
A magical wand, most useful to control the flow of aether. Increases intelligence and will.
[[Choose the wand|SE The Merchants Wand End]]

&#39;&#39;Hand fan&#39;&#39;
A magical fan, favored by illusionists. Increases perception and charisma.
[[Choose the hand fan|SE The Merchants Fan End]]</tw-passagedata><tw-passagedata pid="416" name="SE The Merchants Staff End" tags="" position="7748,774" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ll take the staff.&quot;//&lt;/span&gt; You decide, taking one in your hands, and getting used to its weight and form.

Some of your peers have already made their minds, and the rest don&#39;t take much longer. Padmiri and Maaterasu choose wands, Valtan takes a fan, and Claw gets the knuckles.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Perfect. Now go and practice with them for a while, while I handle the payment. Come with me too, Nimeresh, the Temple needs some of your wares as well.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Remember to come back later to buy some toys!&quot;//&lt;/span&gt; Nimeresh adds.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;All of you made great choices! I hope you&#39;ll make good use of my weapons.&quot;//&lt;/span&gt;

[[Continue|SE The Merchants Taototh Interruption]]
&lt;&lt;script&gt;&gt;
createEquipment(&quot;w0&quot;,&quot;chPlayerCharacter&quot;);
effectsSeTheMerchantsEnd();
&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="417" name="SE The Merchants Knuckles End" tags="" position="7856,774" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ll take the knuckles.&quot;//&lt;/span&gt; You decide, putting them on, and trying their weight.

Some of your peers have already made their minds, and the rest don&#39;t take much longer. Padmiri and Maaterasu choose wands, Valtan takes a fan, and Claw gets the knuckles.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Perfect. Now go and practice with them for a while, while I handle the payment. Come with me too, Nimeresh, the Temple needs some of your wares as well.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Remember to come back later to buy some toys!&quot;//&lt;/span&gt; Nimeresh adds.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;All of you made great choices! I hope you&#39;ll make good use of my weapons.&quot;//&lt;/span&gt;

[[Continue|SE The Merchants Taototh Interruption]]
&lt;&lt;script&gt;&gt;
createEquipment(&quot;w1&quot;,&quot;chPlayerCharacter&quot;);
effectsSeTheMerchantsEnd();
&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="418" name="SE The Merchants Wand End" tags="" position="7963,772" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ll take the wand.&quot;//&lt;/span&gt; You decide, taking one and trying to channel some aether with it.

Some of your peers have already made their minds, and the rest don&#39;t take much longer. Padmiri and Maaterasu choose wands, Valtan takes a fan, and Claw gets the knuckles.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Perfect. Now go and practice with them for a while, while I handle the payment. Come with me too, Nimeresh, the Temple needs some of your wares as well.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Remember to come back later to buy some toys!&quot;//&lt;/span&gt; Nimeresh adds.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;All of you made great choices! I hope you&#39;ll make good use of my weapons.&quot;//&lt;/span&gt;

[[Continue|SE The Merchants Taototh Interruption]]
&lt;&lt;script&gt;&gt;
createEquipment(&quot;w2&quot;,&quot;chPlayerCharacter&quot;);
effectsSeTheMerchantsEnd();
&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="419" name="SE The Merchants Fan End" tags="" position="8070,772" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ll take the fan.&quot;//&lt;/span&gt; You decide, taking one and practicing some moves with it.

Some of your peers have already made their minds, and the rest don&#39;t take much longer. Padmiri and Maaterasu choose wands, Valtan takes a fan, and Claw gets the knuckles.

&lt;span style=&quot;color:saddlebrown&quot;&gt;//&quot;Perfect. Now go and practice with them for a while, while I handle the payment. Come with me too, Nimeresh, the Temple needs some of your wares as well.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Remember to come back later to buy some toys!&quot;//&lt;/span&gt; Nimeresh adds.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;All of you made great choices! I hope you&#39;ll make good use of my weapons.&quot;//&lt;/span&gt;

[[Continue|SE The Merchants Taototh Interruption]]
&lt;&lt;script&gt;&gt;
createEquipment(&quot;w3&quot;,&quot;chPlayerCharacter&quot;);
effectsSeTheMerchantsEnd();
&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="420" name="SE The Merchants Taototh Interruption" tags="" position="7978,667" size="100,100">&lt;span style=&quot;color:gray&quot;&gt;//&quot;$chPlayerCharacter.name, a moment of your time.&quot;//&lt;/span&gt; A serious, masculine voice invokes your attention from behind. It&#39;s Taototh, the Aiishen in charge of the Stars Tower.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, what is it?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Drishtya has asked me to present a gift to you, in order to help you close the gap with your peers.&quot;//&lt;/span&gt; He shows you an orb that shines in dark green lights. &lt;span style=&quot;color:gray&quot;&gt;//&quot;You must have noticed that the other Candidates are well versed in specific arts. Fiercest Claw is a master hunter, while Maaterasu&#39;s talent at manipulating aether has few rivals. Do you have such a talent?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Me?&quot;//&lt;/span&gt; You feel an invisible finger pointing at you, drawing attention over your faults and shortcomings. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;W-Why do you ask?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;You don&#39;t need to answer me if you don&#39;t want to. But, if you have ever felt your life would be any easier with different aptitudes, this artifact might be most useful to you, for it might be used to swap someone&#39;s strengths and weaknesses. However...&quot;//&lt;/span&gt; He hides the orb inside a pocket in his tunic. &lt;span style=&quot;color:gray&quot;&gt;//&quot;It will only work on someone whose potential has not yet been well defined, and it&#39;s likely to break on its first use.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That sounds like a lot of responsability. If the orb was used on me and I couldn&#39;t take advantage of it...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;You seem to have a good grasp of the situation.&quot;//&lt;/span&gt; He smiles faintly. &lt;span style=&quot;color:gray&quot;&gt;//&quot;That&#39;s why my advice is to consider it carefully for a few days. If you decide to accept this gift, come find me at the Stars Tower.&quot;//&lt;/span&gt; And so he leaves, without waiting for your answer.

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
setPasChars([]);
State.variables.StVarsList.push(&quot;go0&quot;);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="421" name="Player Sex Preferences Customization Menu" tags="" position="1571,272" size="100,100">You can customize your character&#39;s sex preferences on this menu.

When your character is affected by sex actions that match their preferences, their received damage will increase.
Your character&#39;s preferences are often modified as the result of sex, and will vary over time, but you have a one-time chance to boost some of them.
If you use the &quot;Cancel&quot; button, you will exit this menu and will be able to customize your character&#39;s preferences later.
Duplicated selections will be ignored.

Highly preferred: &lt;&lt;listbox &quot;$chosenRankTwoTastes[0]&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Foreplay&quot; &quot;foreplay&quot;&gt;&gt;
	&lt;&lt;option &quot;Oral&quot; &quot;oral&quot;&gt;&gt;
	&lt;&lt;option &quot;Full sex&quot; &quot;fullsex&quot;&gt;&gt;
	&lt;&lt;option &quot;Banter&quot; &quot;talk&quot;&gt;&gt;
	&lt;&lt;option &quot;Use dick&quot; &quot;useDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pussy&quot; &quot;usePussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Use ass&quot; &quot;useAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Use mouth&quot; &quot;useMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Use eyes&quot; &quot;useEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Use hands&quot; &quot;useHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Use legs&quot; &quot;useLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Use tail&quot; &quot;useTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Target dick&quot; &quot;targetDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Target pussy&quot; &quot;targetPussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Target ass&quot; &quot;targetAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Target breasts&quot; &quot;targetBreasts&quot;&gt;&gt;
	&lt;&lt;option &quot;Target mouth&quot; &quot;targetMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Target eyes&quot; &quot;targetEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Target hands&quot; &quot;targetHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Target legs&quot; &quot;targetLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Target tail&quot; &quot;targetTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Top&quot; &quot;top&quot;&gt;&gt;
	&lt;&lt;option &quot;Bottom&quot; &quot;bottom&quot;&gt;&gt;
	&lt;&lt;option &quot;Domination&quot; &quot;domination&quot;&gt;&gt;
	&lt;&lt;option &quot;Submission&quot; &quot;submission&quot;&gt;&gt;
	&lt;&lt;option &quot;Bondage&quot; &quot;bondage&quot;&gt;&gt;
	&lt;&lt;option &quot;Teasing&quot; &quot;teasing&quot;&gt;&gt;
	&lt;&lt;option &quot;Hypnosis&quot; &quot;hypnosis&quot;&gt;&gt;
	&lt;&lt;option &quot;Draining&quot; &quot;draining&quot;&gt;&gt;
	&lt;&lt;option &quot;Charm&quot; &quot;charm&quot;&gt;&gt;
	&lt;&lt;option &quot;Romantic&quot; &quot;romantic&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pain&quot; &quot;usePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Receive pain&quot; &quot;receivePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Denial&quot; &quot;denial&quot;&gt;&gt;
&lt;&lt;/listbox&gt;&gt;
Highly preferred: &lt;&lt;listbox &quot;$chosenRankTwoTastes[1]&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Foreplay&quot; &quot;foreplay&quot;&gt;&gt;
	&lt;&lt;option &quot;Oral&quot; &quot;oral&quot;&gt;&gt;
	&lt;&lt;option &quot;Full sex&quot; &quot;fullsex&quot;&gt;&gt;
	&lt;&lt;option &quot;Banter&quot; &quot;talk&quot;&gt;&gt;
	&lt;&lt;option &quot;Use dick&quot; &quot;useDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pussy&quot; &quot;usePussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Use ass&quot; &quot;useAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Use mouth&quot; &quot;useMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Use eyes&quot; &quot;useEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Use hands&quot; &quot;useHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Use legs&quot; &quot;useLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Use tail&quot; &quot;useTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Target dick&quot; &quot;targetDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Target pussy&quot; &quot;targetPussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Target ass&quot; &quot;targetAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Target breasts&quot; &quot;targetBreasts&quot;&gt;&gt;
	&lt;&lt;option &quot;Target mouth&quot; &quot;targetMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Target eyes&quot; &quot;targetEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Target hands&quot; &quot;targetHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Target legs&quot; &quot;targetLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Target tail&quot; &quot;targetTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Top&quot; &quot;top&quot;&gt;&gt;
	&lt;&lt;option &quot;Bottom&quot; &quot;bottom&quot;&gt;&gt;
	&lt;&lt;option &quot;Domination&quot; &quot;domination&quot;&gt;&gt;
	&lt;&lt;option &quot;Submission&quot; &quot;submission&quot;&gt;&gt;
	&lt;&lt;option &quot;Bondage&quot; &quot;bondage&quot;&gt;&gt;
	&lt;&lt;option &quot;Teasing&quot; &quot;teasing&quot;&gt;&gt;
	&lt;&lt;option &quot;Hypnosis&quot; &quot;hypnosis&quot;&gt;&gt;
	&lt;&lt;option &quot;Draining&quot; &quot;draining&quot;&gt;&gt;
	&lt;&lt;option &quot;Charm&quot; &quot;charm&quot;&gt;&gt;
	&lt;&lt;option &quot;Romantic&quot; &quot;romantic&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pain&quot; &quot;usePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Receive pain&quot; &quot;receivePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Denial&quot; &quot;denial&quot;&gt;&gt;
&lt;&lt;/listbox&gt;&gt;
Highly preferred: &lt;&lt;listbox &quot;$chosenRankTwoTastes[2]&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Foreplay&quot; &quot;foreplay&quot;&gt;&gt;
	&lt;&lt;option &quot;Oral&quot; &quot;oral&quot;&gt;&gt;
	&lt;&lt;option &quot;Full sex&quot; &quot;fullsex&quot;&gt;&gt;
	&lt;&lt;option &quot;Banter&quot; &quot;talk&quot;&gt;&gt;
	&lt;&lt;option &quot;Use dick&quot; &quot;useDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pussy&quot; &quot;usePussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Use ass&quot; &quot;useAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Use mouth&quot; &quot;useMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Use eyes&quot; &quot;useEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Use hands&quot; &quot;useHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Use legs&quot; &quot;useLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Use tail&quot; &quot;useTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Target dick&quot; &quot;targetDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Target pussy&quot; &quot;targetPussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Target ass&quot; &quot;targetAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Target breasts&quot; &quot;targetBreasts&quot;&gt;&gt;
	&lt;&lt;option &quot;Target mouth&quot; &quot;targetMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Target eyes&quot; &quot;targetEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Target hands&quot; &quot;targetHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Target legs&quot; &quot;targetLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Target tail&quot; &quot;targetTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Top&quot; &quot;top&quot;&gt;&gt;
	&lt;&lt;option &quot;Bottom&quot; &quot;bottom&quot;&gt;&gt;
	&lt;&lt;option &quot;Domination&quot; &quot;domination&quot;&gt;&gt;
	&lt;&lt;option &quot;Submission&quot; &quot;submission&quot;&gt;&gt;
	&lt;&lt;option &quot;Bondage&quot; &quot;bondage&quot;&gt;&gt;
	&lt;&lt;option &quot;Teasing&quot; &quot;teasing&quot;&gt;&gt;
	&lt;&lt;option &quot;Hypnosis&quot; &quot;hypnosis&quot;&gt;&gt;
	&lt;&lt;option &quot;Draining&quot; &quot;draining&quot;&gt;&gt;
	&lt;&lt;option &quot;Charm&quot; &quot;charm&quot;&gt;&gt;
	&lt;&lt;option &quot;Romantic&quot; &quot;romantic&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pain&quot; &quot;usePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Receive pain&quot; &quot;receivePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Denial&quot; &quot;denial&quot;&gt;&gt;
&lt;&lt;/listbox&gt;&gt;
Highly preferred: &lt;&lt;listbox &quot;$chosenRankTwoTastes[3]&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Foreplay&quot; &quot;foreplay&quot;&gt;&gt;
	&lt;&lt;option &quot;Oral&quot; &quot;oral&quot;&gt;&gt;
	&lt;&lt;option &quot;Full sex&quot; &quot;fullsex&quot;&gt;&gt;
	&lt;&lt;option &quot;Banter&quot; &quot;talk&quot;&gt;&gt;
	&lt;&lt;option &quot;Use dick&quot; &quot;useDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pussy&quot; &quot;usePussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Use ass&quot; &quot;useAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Use mouth&quot; &quot;useMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Use eyes&quot; &quot;useEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Use hands&quot; &quot;useHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Use legs&quot; &quot;useLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Use tail&quot; &quot;useTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Target dick&quot; &quot;targetDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Target pussy&quot; &quot;targetPussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Target ass&quot; &quot;targetAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Target breasts&quot; &quot;targetBreasts&quot;&gt;&gt;
	&lt;&lt;option &quot;Target mouth&quot; &quot;targetMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Target eyes&quot; &quot;targetEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Target hands&quot; &quot;targetHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Target legs&quot; &quot;targetLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Target tail&quot; &quot;targetTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Top&quot; &quot;top&quot;&gt;&gt;
	&lt;&lt;option &quot;Bottom&quot; &quot;bottom&quot;&gt;&gt;
	&lt;&lt;option &quot;Domination&quot; &quot;domination&quot;&gt;&gt;
	&lt;&lt;option &quot;Submission&quot; &quot;submission&quot;&gt;&gt;
	&lt;&lt;option &quot;Bondage&quot; &quot;bondage&quot;&gt;&gt;
	&lt;&lt;option &quot;Teasing&quot; &quot;teasing&quot;&gt;&gt;
	&lt;&lt;option &quot;Hypnosis&quot; &quot;hypnosis&quot;&gt;&gt;
	&lt;&lt;option &quot;Draining&quot; &quot;draining&quot;&gt;&gt;
	&lt;&lt;option &quot;Charm&quot; &quot;charm&quot;&gt;&gt;
	&lt;&lt;option &quot;Romantic&quot; &quot;romantic&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pain&quot; &quot;usePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Receive pain&quot; &quot;receivePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Denial&quot; &quot;denial&quot;&gt;&gt;
&lt;&lt;/listbox&gt;&gt;

Preferred: &lt;&lt;listbox &quot;$chosenRankOneTastes[0]&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Foreplay&quot; &quot;foreplay&quot;&gt;&gt;
	&lt;&lt;option &quot;Oral&quot; &quot;oral&quot;&gt;&gt;
	&lt;&lt;option &quot;Full sex&quot; &quot;fullsex&quot;&gt;&gt;
	&lt;&lt;option &quot;Banter&quot; &quot;talk&quot;&gt;&gt;
	&lt;&lt;option &quot;Use dick&quot; &quot;useDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pussy&quot; &quot;usePussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Use ass&quot; &quot;useAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Use mouth&quot; &quot;useMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Use eyes&quot; &quot;useEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Use hands&quot; &quot;useHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Use legs&quot; &quot;useLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Use tail&quot; &quot;useTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Target dick&quot; &quot;targetDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Target pussy&quot; &quot;targetPussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Target ass&quot; &quot;targetAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Target breasts&quot; &quot;targetBreasts&quot;&gt;&gt;
	&lt;&lt;option &quot;Target mouth&quot; &quot;targetMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Target eyes&quot; &quot;targetEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Target hands&quot; &quot;targetHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Target legs&quot; &quot;targetLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Target tail&quot; &quot;targetTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Top&quot; &quot;top&quot;&gt;&gt;
	&lt;&lt;option &quot;Bottom&quot; &quot;bottom&quot;&gt;&gt;
	&lt;&lt;option &quot;Domination&quot; &quot;domination&quot;&gt;&gt;
	&lt;&lt;option &quot;Submission&quot; &quot;submission&quot;&gt;&gt;
	&lt;&lt;option &quot;Bondage&quot; &quot;bondage&quot;&gt;&gt;
	&lt;&lt;option &quot;Teasing&quot; &quot;teasing&quot;&gt;&gt;
	&lt;&lt;option &quot;Hypnosis&quot; &quot;hypnosis&quot;&gt;&gt;
	&lt;&lt;option &quot;Draining&quot; &quot;draining&quot;&gt;&gt;
	&lt;&lt;option &quot;Charm&quot; &quot;charm&quot;&gt;&gt;
	&lt;&lt;option &quot;Romantic&quot; &quot;romantic&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pain&quot; &quot;usePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Receive pain&quot; &quot;receivePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Denial&quot; &quot;denial&quot;&gt;&gt;
&lt;&lt;/listbox&gt;&gt;
Preferred: &lt;&lt;listbox &quot;$chosenRankOneTastes[1]&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Foreplay&quot; &quot;foreplay&quot;&gt;&gt;
	&lt;&lt;option &quot;Oral&quot; &quot;oral&quot;&gt;&gt;
	&lt;&lt;option &quot;Full sex&quot; &quot;fullsex&quot;&gt;&gt;
	&lt;&lt;option &quot;Banter&quot; &quot;talk&quot;&gt;&gt;
	&lt;&lt;option &quot;Use dick&quot; &quot;useDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pussy&quot; &quot;usePussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Use ass&quot; &quot;useAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Use mouth&quot; &quot;useMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Use eyes&quot; &quot;useEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Use hands&quot; &quot;useHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Use legs&quot; &quot;useLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Use tail&quot; &quot;useTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Target dick&quot; &quot;targetDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Target pussy&quot; &quot;targetPussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Target ass&quot; &quot;targetAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Target breasts&quot; &quot;targetBreasts&quot;&gt;&gt;
	&lt;&lt;option &quot;Target mouth&quot; &quot;targetMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Target eyes&quot; &quot;targetEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Target hands&quot; &quot;targetHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Target legs&quot; &quot;targetLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Target tail&quot; &quot;targetTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Top&quot; &quot;top&quot;&gt;&gt;
	&lt;&lt;option &quot;Bottom&quot; &quot;bottom&quot;&gt;&gt;
	&lt;&lt;option &quot;Domination&quot; &quot;domination&quot;&gt;&gt;
	&lt;&lt;option &quot;Submission&quot; &quot;submission&quot;&gt;&gt;
	&lt;&lt;option &quot;Bondage&quot; &quot;bondage&quot;&gt;&gt;
	&lt;&lt;option &quot;Teasing&quot; &quot;teasing&quot;&gt;&gt;
	&lt;&lt;option &quot;Hypnosis&quot; &quot;hypnosis&quot;&gt;&gt;
	&lt;&lt;option &quot;Draining&quot; &quot;draining&quot;&gt;&gt;
	&lt;&lt;option &quot;Charm&quot; &quot;charm&quot;&gt;&gt;
	&lt;&lt;option &quot;Romantic&quot; &quot;romantic&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pain&quot; &quot;usePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Receive pain&quot; &quot;receivePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Denial&quot; &quot;denial&quot;&gt;&gt;
&lt;&lt;/listbox&gt;&gt;
Preferred: &lt;&lt;listbox &quot;$chosenRankOneTastes[2]&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Foreplay&quot; &quot;foreplay&quot;&gt;&gt;
	&lt;&lt;option &quot;Oral&quot; &quot;oral&quot;&gt;&gt;
	&lt;&lt;option &quot;Full sex&quot; &quot;fullsex&quot;&gt;&gt;
	&lt;&lt;option &quot;Banter&quot; &quot;talk&quot;&gt;&gt;
	&lt;&lt;option &quot;Use dick&quot; &quot;useDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pussy&quot; &quot;usePussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Use ass&quot; &quot;useAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Use mouth&quot; &quot;useMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Use eyes&quot; &quot;useEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Use hands&quot; &quot;useHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Use legs&quot; &quot;useLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Use tail&quot; &quot;useTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Target dick&quot; &quot;targetDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Target pussy&quot; &quot;targetPussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Target ass&quot; &quot;targetAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Target breasts&quot; &quot;targetBreasts&quot;&gt;&gt;
	&lt;&lt;option &quot;Target mouth&quot; &quot;targetMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Target eyes&quot; &quot;targetEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Target hands&quot; &quot;targetHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Target legs&quot; &quot;targetLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Target tail&quot; &quot;targetTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Top&quot; &quot;top&quot;&gt;&gt;
	&lt;&lt;option &quot;Bottom&quot; &quot;bottom&quot;&gt;&gt;
	&lt;&lt;option &quot;Domination&quot; &quot;domination&quot;&gt;&gt;
	&lt;&lt;option &quot;Submission&quot; &quot;submission&quot;&gt;&gt;
	&lt;&lt;option &quot;Bondage&quot; &quot;bondage&quot;&gt;&gt;
	&lt;&lt;option &quot;Teasing&quot; &quot;teasing&quot;&gt;&gt;
	&lt;&lt;option &quot;Hypnosis&quot; &quot;hypnosis&quot;&gt;&gt;
	&lt;&lt;option &quot;Draining&quot; &quot;draining&quot;&gt;&gt;
	&lt;&lt;option &quot;Charm&quot; &quot;charm&quot;&gt;&gt;
	&lt;&lt;option &quot;Romantic&quot; &quot;romantic&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pain&quot; &quot;usePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Receive pain&quot; &quot;receivePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Denial&quot; &quot;denial&quot;&gt;&gt;
&lt;&lt;/listbox&gt;&gt;
Preferred: &lt;&lt;listbox &quot;$chosenRankOneTastes[3]&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Foreplay&quot; &quot;foreplay&quot;&gt;&gt;
	&lt;&lt;option &quot;Oral&quot; &quot;oral&quot;&gt;&gt;
	&lt;&lt;option &quot;Full sex&quot; &quot;fullsex&quot;&gt;&gt;
	&lt;&lt;option &quot;Banter&quot; &quot;talk&quot;&gt;&gt;
	&lt;&lt;option &quot;Use dick&quot; &quot;useDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pussy&quot; &quot;usePussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Use ass&quot; &quot;useAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Use mouth&quot; &quot;useMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Use eyes&quot; &quot;useEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Use hands&quot; &quot;useHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Use legs&quot; &quot;useLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Use tail&quot; &quot;useTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Target dick&quot; &quot;targetDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Target pussy&quot; &quot;targetPussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Target ass&quot; &quot;targetAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Target breasts&quot; &quot;targetBreasts&quot;&gt;&gt;
	&lt;&lt;option &quot;Target mouth&quot; &quot;targetMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Target eyes&quot; &quot;targetEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Target hands&quot; &quot;targetHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Target legs&quot; &quot;targetLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Target tail&quot; &quot;targetTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Top&quot; &quot;top&quot;&gt;&gt;
	&lt;&lt;option &quot;Bottom&quot; &quot;bottom&quot;&gt;&gt;
	&lt;&lt;option &quot;Domination&quot; &quot;domination&quot;&gt;&gt;
	&lt;&lt;option &quot;Submission&quot; &quot;submission&quot;&gt;&gt;
	&lt;&lt;option &quot;Bondage&quot; &quot;bondage&quot;&gt;&gt;
	&lt;&lt;option &quot;Teasing&quot; &quot;teasing&quot;&gt;&gt;
	&lt;&lt;option &quot;Hypnosis&quot; &quot;hypnosis&quot;&gt;&gt;
	&lt;&lt;option &quot;Draining&quot; &quot;draining&quot;&gt;&gt;
	&lt;&lt;option &quot;Charm&quot; &quot;charm&quot;&gt;&gt;
	&lt;&lt;option &quot;Romantic&quot; &quot;romantic&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pain&quot; &quot;usePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Receive pain&quot; &quot;receivePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Denial&quot; &quot;denial&quot;&gt;&gt;
&lt;&lt;/listbox&gt;&gt;
Preferred: &lt;&lt;listbox &quot;$chosenRankOneTastes[4]&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Foreplay&quot; &quot;foreplay&quot;&gt;&gt;
	&lt;&lt;option &quot;Oral&quot; &quot;oral&quot;&gt;&gt;
	&lt;&lt;option &quot;Full sex&quot; &quot;fullsex&quot;&gt;&gt;
	&lt;&lt;option &quot;Banter&quot; &quot;talk&quot;&gt;&gt;
	&lt;&lt;option &quot;Use dick&quot; &quot;useDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pussy&quot; &quot;usePussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Use ass&quot; &quot;useAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Use mouth&quot; &quot;useMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Use eyes&quot; &quot;useEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Use hands&quot; &quot;useHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Use legs&quot; &quot;useLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Use tail&quot; &quot;useTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Target dick&quot; &quot;targetDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Target pussy&quot; &quot;targetPussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Target ass&quot; &quot;targetAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Target breasts&quot; &quot;targetBreasts&quot;&gt;&gt;
	&lt;&lt;option &quot;Target mouth&quot; &quot;targetMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Target eyes&quot; &quot;targetEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Target hands&quot; &quot;targetHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Target legs&quot; &quot;targetLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Target tail&quot; &quot;targetTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Top&quot; &quot;top&quot;&gt;&gt;
	&lt;&lt;option &quot;Bottom&quot; &quot;bottom&quot;&gt;&gt;
	&lt;&lt;option &quot;Domination&quot; &quot;domination&quot;&gt;&gt;
	&lt;&lt;option &quot;Submission&quot; &quot;submission&quot;&gt;&gt;
	&lt;&lt;option &quot;Bondage&quot; &quot;bondage&quot;&gt;&gt;
	&lt;&lt;option &quot;Teasing&quot; &quot;teasing&quot;&gt;&gt;
	&lt;&lt;option &quot;Hypnosis&quot; &quot;hypnosis&quot;&gt;&gt;
	&lt;&lt;option &quot;Draining&quot; &quot;draining&quot;&gt;&gt;
	&lt;&lt;option &quot;Charm&quot; &quot;charm&quot;&gt;&gt;
	&lt;&lt;option &quot;Romantic&quot; &quot;romantic&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pain&quot; &quot;usePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Receive pain&quot; &quot;receivePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Denial&quot; &quot;denial&quot;&gt;&gt;
&lt;&lt;/listbox&gt;&gt;
Preferred: &lt;&lt;listbox &quot;$chosenRankOneTastes[5]&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Foreplay&quot; &quot;foreplay&quot;&gt;&gt;
	&lt;&lt;option &quot;Oral&quot; &quot;oral&quot;&gt;&gt;
	&lt;&lt;option &quot;Full sex&quot; &quot;fullsex&quot;&gt;&gt;
	&lt;&lt;option &quot;Banter&quot; &quot;talk&quot;&gt;&gt;
	&lt;&lt;option &quot;Use dick&quot; &quot;useDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pussy&quot; &quot;usePussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Use ass&quot; &quot;useAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Use mouth&quot; &quot;useMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Use eyes&quot; &quot;useEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Use hands&quot; &quot;useHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Use legs&quot; &quot;useLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Use tail&quot; &quot;useTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Target dick&quot; &quot;targetDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Target pussy&quot; &quot;targetPussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Target ass&quot; &quot;targetAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Target breasts&quot; &quot;targetBreasts&quot;&gt;&gt;
	&lt;&lt;option &quot;Target mouth&quot; &quot;targetMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Target eyes&quot; &quot;targetEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Target hands&quot; &quot;targetHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Target legs&quot; &quot;targetLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Target tail&quot; &quot;targetTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Top&quot; &quot;top&quot;&gt;&gt;
	&lt;&lt;option &quot;Bottom&quot; &quot;bottom&quot;&gt;&gt;
	&lt;&lt;option &quot;Domination&quot; &quot;domination&quot;&gt;&gt;
	&lt;&lt;option &quot;Submission&quot; &quot;submission&quot;&gt;&gt;
	&lt;&lt;option &quot;Bondage&quot; &quot;bondage&quot;&gt;&gt;
	&lt;&lt;option &quot;Teasing&quot; &quot;teasing&quot;&gt;&gt;
	&lt;&lt;option &quot;Hypnosis&quot; &quot;hypnosis&quot;&gt;&gt;
	&lt;&lt;option &quot;Draining&quot; &quot;draining&quot;&gt;&gt;
	&lt;&lt;option &quot;Charm&quot; &quot;charm&quot;&gt;&gt;
	&lt;&lt;option &quot;Romantic&quot; &quot;romantic&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pain&quot; &quot;usePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Receive pain&quot; &quot;receivePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Denial&quot; &quot;denial&quot;&gt;&gt;
&lt;&lt;/listbox&gt;&gt;
Preferred: &lt;&lt;listbox &quot;$chosenRankOneTastes[6]&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Foreplay&quot; &quot;foreplay&quot;&gt;&gt;
	&lt;&lt;option &quot;Oral&quot; &quot;oral&quot;&gt;&gt;
	&lt;&lt;option &quot;Full sex&quot; &quot;fullsex&quot;&gt;&gt;
	&lt;&lt;option &quot;Banter&quot; &quot;talk&quot;&gt;&gt;
	&lt;&lt;option &quot;Use dick&quot; &quot;useDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pussy&quot; &quot;usePussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Use ass&quot; &quot;useAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Use mouth&quot; &quot;useMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Use eyes&quot; &quot;useEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Use hands&quot; &quot;useHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Use legs&quot; &quot;useLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Use tail&quot; &quot;useTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Target dick&quot; &quot;targetDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Target pussy&quot; &quot;targetPussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Target ass&quot; &quot;targetAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Target breasts&quot; &quot;targetBreasts&quot;&gt;&gt;
	&lt;&lt;option &quot;Target mouth&quot; &quot;targetMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Target eyes&quot; &quot;targetEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Target hands&quot; &quot;targetHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Target legs&quot; &quot;targetLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Target tail&quot; &quot;targetTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Top&quot; &quot;top&quot;&gt;&gt;
	&lt;&lt;option &quot;Bottom&quot; &quot;bottom&quot;&gt;&gt;
	&lt;&lt;option &quot;Domination&quot; &quot;domination&quot;&gt;&gt;
	&lt;&lt;option &quot;Submission&quot; &quot;submission&quot;&gt;&gt;
	&lt;&lt;option &quot;Bondage&quot; &quot;bondage&quot;&gt;&gt;
	&lt;&lt;option &quot;Teasing&quot; &quot;teasing&quot;&gt;&gt;
	&lt;&lt;option &quot;Hypnosis&quot; &quot;hypnosis&quot;&gt;&gt;
	&lt;&lt;option &quot;Draining&quot; &quot;draining&quot;&gt;&gt;
	&lt;&lt;option &quot;Charm&quot; &quot;charm&quot;&gt;&gt;
	&lt;&lt;option &quot;Romantic&quot; &quot;romantic&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pain&quot; &quot;usePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Receive pain&quot; &quot;receivePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Denial&quot; &quot;denial&quot;&gt;&gt;
&lt;&lt;/listbox&gt;&gt;
Preferred: &lt;&lt;listbox &quot;$chosenRankOneTastes[7]&quot; autoselect&gt;&gt;
	&lt;&lt;option &quot;Foreplay&quot; &quot;foreplay&quot;&gt;&gt;
	&lt;&lt;option &quot;Oral&quot; &quot;oral&quot;&gt;&gt;
	&lt;&lt;option &quot;Full sex&quot; &quot;fullsex&quot;&gt;&gt;
	&lt;&lt;option &quot;Banter&quot; &quot;talk&quot;&gt;&gt;
	&lt;&lt;option &quot;Use dick&quot; &quot;useDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pussy&quot; &quot;usePussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Use ass&quot; &quot;useAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Use mouth&quot; &quot;useMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Use eyes&quot; &quot;useEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Use hands&quot; &quot;useHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Use legs&quot; &quot;useLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Use tail&quot; &quot;useTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Target dick&quot; &quot;targetDick&quot;&gt;&gt;
	&lt;&lt;option &quot;Target pussy&quot; &quot;targetPussy&quot;&gt;&gt;
	&lt;&lt;option &quot;Target ass&quot; &quot;targetAnus&quot;&gt;&gt;
	&lt;&lt;option &quot;Target breasts&quot; &quot;targetBreasts&quot;&gt;&gt;
	&lt;&lt;option &quot;Target mouth&quot; &quot;targetMouth&quot;&gt;&gt;
	&lt;&lt;option &quot;Target eyes&quot; &quot;targetEyes&quot;&gt;&gt;
	&lt;&lt;option &quot;Target hands&quot; &quot;targetHands&quot;&gt;&gt;
	&lt;&lt;option &quot;Target legs&quot; &quot;targetLegs&quot;&gt;&gt;
	&lt;&lt;option &quot;Target tail&quot; &quot;targetTail&quot;&gt;&gt;
	&lt;&lt;option &quot;Top&quot; &quot;top&quot;&gt;&gt;
	&lt;&lt;option &quot;Bottom&quot; &quot;bottom&quot;&gt;&gt;
	&lt;&lt;option &quot;Domination&quot; &quot;domination&quot;&gt;&gt;
	&lt;&lt;option &quot;Submission&quot; &quot;submission&quot;&gt;&gt;
	&lt;&lt;option &quot;Bondage&quot; &quot;bondage&quot;&gt;&gt;
	&lt;&lt;option &quot;Teasing&quot; &quot;teasing&quot;&gt;&gt;
	&lt;&lt;option &quot;Hypnosis&quot; &quot;hypnosis&quot;&gt;&gt;
	&lt;&lt;option &quot;Draining&quot; &quot;draining&quot;&gt;&gt;
	&lt;&lt;option &quot;Charm&quot; &quot;charm&quot;&gt;&gt;
	&lt;&lt;option &quot;Romantic&quot; &quot;romantic&quot;&gt;&gt;
	&lt;&lt;option &quot;Use pain&quot; &quot;usePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Receive pain&quot; &quot;receivePain&quot;&gt;&gt;
	&lt;&lt;option &quot;Denial&quot; &quot;denial&quot;&gt;&gt;
&lt;&lt;/listbox&gt;&gt;

&lt;&lt;link [[Confirm selections and leave|Personal Room]]&gt;&gt;&lt;&lt;script&gt;&gt; processSexPreferencesMenu();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
[[Cancel|Personal Room]]

__Extra explanations__
&quot;Use [bodypart]&quot; tastes refer to all actions involving your character&#39;s bodypart, while &quot;Target [bodypart]&quot; refers to all actions involving your partner&#39;s bodyparts. If you use an action with the tag &quot;Target pussy&quot;, it will be more effective on you if you have a highly ranked &quot;Target pussy&quot;, but it will be more effective on your partner if they have a highly ranked &quot;Use pussy&quot; taste, and viceversa.</tw-passagedata><tw-passagedata pid="422" name="SE TGoL Start" tags="" position="8275,208" size="100,100">$customRoomIntro
&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hey, these are pretty sweet!&quot;//&lt;/span&gt; Valtan exclaims, shortly after tasting her second grape.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I told you, and even Claw agreed.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I didn&#39;t...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You didn&#39;t say it out loud, but you didn&#39;t have your usual grumpy expression while you were eating.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;That&#39;s true, Claw. She caught you with your paws on the cake.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf.&quot;//&lt;/span&gt;

Valtan, Claw and you have been sent to look for Maaterasu, before you even had time to have breakfast in the dining hall. Apparently, Vesia reported watching her leaving towards the training grounds early in dawn. You were given some grapes to eat on the way, and you&#39;re carrying an extra cluster for Maaterasu.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Back in my tribe, we do not only eat grapes, we also ferment them into wine.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Wine? What&#39;s that?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh, it&#39;s a dark beverage, somewhat sweet, somewhat sour, that makes your mind fuzzy and lets you go of your inhibitions...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;It&#39;s an alcoholic drink. Poison, basically.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What!? It&#39;s not poison!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Many plants and creatures in the forests expel odors that alter your mind, sometimes turning you groggy or immobile, or blind with lust. Are those not poisons?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;It gets rid of inhibitions, blind with lust...?&quot;//&lt;/span&gt; Valtan mutters to herself.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Those are completely different.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;How so?&quot;//&lt;/span&gt;

[[Continue|SE TGoL Found Ate]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="423" name="SE TGoL Found Ate" tags="" position="8383,205" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);
setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;lake&quot;);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Well, for starters, wine only affects you if you choose to drink it, and-&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Found Ate. She didn&#39;t go very far.&quot;//&lt;/span&gt; Valtan says, in the middle of her chewing.

As soon as you take your eyes off Claw, it&#39;s easy to spot her. Near the shore of the lake, the water moves in an unnatural, wild manner, forming small whirlpools and reverse waterfalls. In front of the spectacle, Maaterasu is weaving the strings of aether, practicing her magical casting.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Let&#39;s sit around here and see how long she takes to notice us.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...I&#39;m giving it a minute. ...Just to see how unaware she is.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;She always gets that focused when she&#39;s training, right? It should be easy to attack her by surprise...&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Hmm?&quot;//&lt;/span&gt; Ate suddenly stops.

[[Continue|SE TGoL Val&#39;s Offer]]</tw-passagedata><tw-passagedata pid="424" name="SE TGoL Val&#39;s Offer" tags="" position="8493,205" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);
setRoomIntro(&quot;mapTrainingGrounds&quot;,&quot;lake&quot;);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...I forgot to eat, didn&#39;t I?&quot;//&lt;/span&gt; Maaterasu proclaims, not having noticed your presence yet.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Sigh.&quot;//&lt;/span&gt;

Valtan smiles, amused.

Short seconds later, the Aiishen turns around and finds you.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Oh, you&#39;re there.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hey, Ate, Drishtya gave me this for...&quot;//&lt;/span&gt; Just as you&#39;re finishing the sentence, you realize you no longer have the cluster of grapes.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Are you hungry? Look at what I have here, just for you.&quot;//&lt;/span&gt; Valtan stands up. It takes you a bit to realize that she&#39;s flaunting the grapes that were previously in your possession. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;You won&#39;t believe how sweet these berries are, just...&quot;//&lt;/span&gt; The Shapeshifter, who was born with no shame at all, tears each grape apart, and pushes them into her pussy one by one, slowly making space for them all. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;...you&#39;ll have to slurp them out of me. It&#39;s the least you could do for me, after I came all the way to bring breakfast to poor, hungry Ate...&quot;//&lt;/span&gt;

[[Continue|SE TGoL Claw Leaves]]</tw-passagedata><tw-passagedata pid="425" name="SE TGoL Claw Leaves" tags="" position="8603,205" size="100,100">$customRoomIntro
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf. I&#39;ve wasted enough time already. I&#39;m leaving.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What!? I can&#39;t believe this.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;If I eat you out, I can eat the berries?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Sure, they&#39;ll be fresh and wet, just ready for you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ate, we all brought you the grapes, not just Valtan.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I know, but it&#39;s her who has them right now.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Uuugghh.&quot;//&lt;/span&gt;

[[Just leave|SE TGoL Player Leaves]]
[[Protest about Valtan&#39;s attitude|SE TGoL Player Protests]]
[[Attack Valtan for the berries|SE TGoL Defy Valtan]]
[[Offer to help Maaterasu to suck the grapes out|SE TGoL Join Ate]]
[[Appeal to Maaterasu&#39;s pride|SE TGoL Ate&#39;s Pride]]</tw-passagedata><tw-passagedata pid="426" name="SE TGoL Player Leaves" tags="" position="8275,316" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Fine, whatever!&quot;//&lt;/span&gt; You shout, frustrated. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I shouldn&#39;t even have bothered.&quot;//&lt;/span&gt;

You head towards the bridge without looking back, looking to start your training and leave the beginning of the day behind as soon as possible.

&lt;span style=&quot;color:gray&quot;&gt;Your friendship, sexual tension and romance with Valtan have slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Valtan has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your opinion of Maaterasu has slightly decreased.&lt;/span&gt;
//Valtan&#39;s preferences for oral, use pussy and target mouth have increased.//
//Maaterasu&#39;s preferences for oral, target pussy and use mouth have increased.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.friendship.stv -= 100;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv -= 100;
State.variables.chPlayerCharacter.relations.chVal.romance.stv -= 100;
State.variables.chPlayerCharacter.relations.chVal.enmity.stv += 100;
State.variables.chVal.relations.chPlayerCharacter.friendship.stv -= 100;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv -= 100;
State.variables.chVal.relations.chPlayerCharacter.romance.stv -= 100;
State.variables.chVal.relations.chPlayerCharacter.enmity.stv += 100;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv -= 50;
State.variables.chPlayerCharacter.relations.chAte.sexualTension.stv -= 50;
State.variables.chPlayerCharacter.relations.chAte.romance.stv -= 50;
State.variables.chVal.relations.chAte.sexualTension.stv += 250;
State.variables.chVal.relations.chAte.domination.stv += 400;
State.variables.chAte.relations.chVal.sexualTension.stv += 250;
State.variables.chAte.relations.chVal.submission.stv += 250;
State.variables.chVal.tastes.oral.w += 10;
State.variables.chVal.tastes.usePussy.w += 10;
State.variables.chVal.tastes.targetMouth.w += 20;
State.variables.chAte.tastes.oral.w += 10;
State.variables.chAte.tastes.targetPussy.w += 10;
State.variables.chAte.tastes.useMouth.w += 20;
addPointsToDrive(gC(&quot;chAte&quot;).dPleasure,100);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="427" name="SE TGoL Player Protests" tags="" position="8496,318" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But... This isn&#39;t fair, you just took the grapes off my hand, and...&quot;//&lt;/span&gt;

Ignoring your words, Valtan stands in front of you, high and mighty, looking to the docile Aiishen.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Good girl, they are going to taste just great...&quot;//&lt;/span&gt;

Maaterasu, on her part, simply gets on her knees and moves her head towards the Shapeshifter&#39;s nethers.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...They both are ignoring me, aren&#39;t they?&quot;//&lt;/span&gt;

[[Just leave|SE TGoL Player Leaves]]
&lt;&lt;link [[Watch scene|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
cssTgolValxAte();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \</tw-passagedata><tw-passagedata pid="428" name="SE TGoL Player Protests End" tags="" position="8601,316" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
Maaterasu swallows the last grape, and licks her lips reservedly.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Thank you for the meal.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What!?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You&#39;re welcome, sweetie. I wish our friend $chPlayerCharacter.name here was as open-minded as you, I&#39;m sure $chPlayerCharacter.perPr would have loved it as well.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I-I can&#39;t even-&quot;//&lt;/span&gt;

The Shapeshifter turns her eyes towards you, &lt;span @style=$chVal.colorStyleKey&gt;//&quot;You can tell she actually wanted it because... She stayed to watch.&quot;//&lt;/span&gt;, throwing her words like darts towards you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;re so annoying. I&#39;m leaving.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Come back when you come to terms with your desires... And I&#39;ll let you have a taste, as well.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Valtan has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Valtan has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Valtan has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Maaterasu has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Maaterasu has slightly increased.&lt;/span&gt;
//Valtan&#39;s preferences for oral, use pussy and target mouth have increased.//
//Maaterasu&#39;s preferences for oral, target pussy and use mouth have increased.//
//Your preference for oral has slightly increased.//
//Maaterasu&#39;s views have grown more favorable to pleasure.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.friendship.stv -= 100;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 100;
State.variables.chPlayerCharacter.relations.chVal.enmity.stv += 100;
State.variables.chVal.relations.chPlayerCharacter.friendship.stv -= 100;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 100;
State.variables.chVal.relations.chPlayerCharacter.enmity.stv += 100;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv -= 100;
State.variables.chPlayerCharacter.relations.chAte.sexualTension.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv -= 100;
State.variables.chAte.relations.chPlayerCharacter.sexualTension.stv += 100;
State.variables.chVal.relations.chAte.sexualTension.stv += 250;
State.variables.chVal.relations.chAte.domination.stv += 400;
State.variables.chAte.relations.chVal.sexualTension.stv += 250;
State.variables.chAte.relations.chVal.submission.stv += 250;
State.variables.chVal.tastes.oral.w += 10;
State.variables.chVal.tastes.usePussy.w += 10;
State.variables.chVal.tastes.targetMouth.w += 20;
State.variables.chAte.tastes.oral.w += 10;
State.variables.chAte.tastes.targetPussy.w += 10;
State.variables.chAte.tastes.useMouth.w += 20;
State.variables.chPlayerCharacter.tastes.oral.w += 10;
addPointsToDrive(gC(&quot;chAte&quot;).dPleasure,100);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="429" name="SE TGoL Defy Valtan" tags="" position="8278,428" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Look, I&#39;m not letting this happen.&quot;//&lt;/span&gt; You adopt a battle stance, looking straight at Valtan. She rolls her eyes.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You&#39;re such a bore, did you know that?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Maybe I am, but you need someone to put you in your place. From time to time, at the very least.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Even if poor Ate can&#39;t eat after this? The grapes aren&#39;t going to survive our fight.&quot;//&lt;/span&gt;

Maaterasu stays silent, observing the events unfold.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t push your responsability about this on me! It wasn&#39;t me who pushed a cluster of grapes inside her pussy.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Uugh! Fine, let&#39;s have it your way.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Will you give her the...?&quot;//&lt;/span&gt; Valtan replies to your question by casting a flameball aimed at you, which you barely avoid. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Uh, I guess not.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue to battle|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
cssTgolValVsPlayer();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \</tw-passagedata><tw-passagedata pid="430" name="SE TGoL Defy Valtan Player Victory" tags="" position="8385,426" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chVal&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
The grapes have all fallen through the ground. Some frozen, some burned, others splashed against the dirt. Next to them, Valtan lies defeated.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I hope you&#39;re happy with this. It&#39;s your fault.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Way to ruin a girl&#39;s morning happy hour.&quot;//&lt;/span&gt; She replies, annoyed.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Where is Ate...?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;She left soon after our fight started. I guess she wasn&#39;t in the mood to eat the grapes out of the ground.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Can&#39;t blame her, really.&quot;//&lt;/span&gt;

A short while later, Maaterasu gets a different meal in the dining hall. Word of this reaches Drishtya, and blames both Valtan, Claw and you for not being able to deliver the Aiishen&#39;s breakfast.

&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Valtan has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Valtan has increased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Valtan has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Claw has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Maaterasu has slightly decreased.&lt;/span&gt;
//Claw, Valtan and you have lost 1 merit.//
//Valtan&#39;s views have grown less favorable to pleasure, and more favorable to self-improvement.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.friendship.stv -= 100;
State.variables.chPlayerCharacter.relations.chVal.domination.stv += 400;
State.variables.chPlayerCharacter.relations.chVal.rivalry.stv += 100;
State.variables.chVal.relations.chPlayerCharacter.friendship.stv -= 100;
State.variables.chVal.relations.chPlayerCharacter.submission.stv += 400;
State.variables.chVal.relations.chPlayerCharacter.rivalry.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv -= 150;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv -= 100;
State.variables.chClaw.relations.chVal.enmity.stv += 100;
State.variables.chPlayerCharacter.changeMerit(-1);
State.variables.chVal.changeMerit(-1);
State.variables.chClaw.changeMerit(-1);
addPointsToDrive(gC(&quot;chVal&quot;).dPleasure,-100);
addPointsToDrive(gC(&quot;chVal&quot;).dImprovement,100);
State.variables.chPlayerCharacter.lust.current = State.variables.chPlayerCharacter.lust.max;
State.variables.chVal.lust.current = State.variables.chVal.lust.max;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="431" name="SE TGoL Join Ate" tags="" position="8498,424" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sigh. I&#39;ll just help Ate, I guess.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hmm? Will you?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That will be the easiest way for her to get the grapes, right? So let&#39;s just be done with it.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Oooh? You&#39;re so timid it&#39;s cute. You don&#39;t need to find such excuses if you want to taste me, you know?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Just shut up! You aren&#39;t making this any easier.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue to scene|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
cssTgolValxAtePlayer();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \</tw-passagedata><tw-passagedata pid="432" name="SE TGoL Join Ate End" tags="" position="8606,429" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
You slowly lick your lips, savoring the the strange mixture of grape juice and slime. From time to time, sweetness and saltiness blend together in a very particular way, and it tastes heavenly.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Looks like someone couldn&#39;t get enough of me. We can still continue for a while.&quot;//&lt;/span&gt; Valtan winks at you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Huh? No, no, I did what I wanted to. You&#39;re finished, right, Ate?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I am. Thank you for the meal.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Why are you thanking her, exactly?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Because she has manners. You should learn from her. Thanks, Ate, you&#39;re so sweet.&quot;//&lt;/span&gt; Ate&#39;s face remains undisturbed, as usual.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Let&#39;s... Let&#39;s just leave.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;So timid, and so cute.&quot;//&lt;/span&gt; Valtan mocks you.

&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Valtan has increased.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Valtan has increased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Valtan has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has increased.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Maaterasu has increased.&lt;/span&gt;
//Valtan&#39;s preferences for oral, use pussy and target mouth have increased.//
//Maaterasu&#39;s preferences for oral, target pussy and use mouth have increased.//
//Your preferences for oral, target pussy and use mouth have increased.//
//Maaterasu&#39;s views have grown more favorable to pleasure.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 250;
State.variables.chPlayerCharacter.relations.chVal.sexualTension.stv += 250;
State.variables.chPlayerCharacter.relations.chVal.enmity.stv += 100;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 250;
State.variables.chVal.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 250;
State.variables.chPlayerCharacter.relations.chAte.sexualTension.stv += 250;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 250;
State.variables.chAte.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chVal.relations.chAte.sexualTension.stv += 250;
State.variables.chVal.relations.chAte.domination.stv += 400;
State.variables.chAte.relations.chVal.sexualTension.stv += 250;
State.variables.chAte.relations.chVal.submission.stv += 250;
State.variables.chVal.tastes.oral.w += 10;
State.variables.chVal.tastes.usePussy.w += 10;
State.variables.chVal.tastes.targetMouth.w += 20;
State.variables.chAte.tastes.oral.w += 10;
State.variables.chAte.tastes.targetPussy.w += 10;
State.variables.chAte.tastes.useMouth.w += 20;
State.variables.chPlayerCharacter.tastes.oral.w += 10;
State.variables.chPlayerCharacter.tastes.targetPussy.w += 10;
State.variables.chPlayerCharacter.tastes.useMouth.w += 20;
addPointsToDrive(gC(&quot;chAte&quot;).dPleasure,100);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="433" name="SE TGoL Ate&#39;s Pride" tags="" position="8383,319" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wait, but are you really fine with this?&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check1 is true&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Charisma AND empathy check: passed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We were told to bring you food, and she&#39;s using that to her advantage, making you pleasure her for you to get something you were entitled to. Does that seem fair to you?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;No, it isn&#39;t.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;$chPlayerCharacter.name, sweetie, you don&#39;t have to do this.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...But Valtan still has the food.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;That I do.&quot;//&lt;/span&gt; //No! I&#39;m not letting you hold on to that nail.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But! But, if you give in to her blackmail, you will reward her behavior, and she&#39;ll keep doing that in the future. And then they&#39;ll say that the Shapeshifter Candidate has the Aiishen Candidate get on her knees whenever she wants! Would you like that to be said about you?&quot;//&lt;/span&gt;

Valtan&#39;s face retorts in annoyance and stress, as she looks for the words that would let her slip out the mess you&#39;re getting her into.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...I wouldn&#39;t. So you think I should punish her for taking my grapes, right?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That... Would be a solution to this...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Wait, let&#39;s not take hurried decisions h-&quot;//&lt;/span&gt; Valtan&#39;s words are interrupted by an expression of shock and pain. Maaterasu has directed harsh, frozen winds against the Shapeshifter&#39;s nethers, right at the entrance of her pussy. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;S-S-S-st-t-top, I&#39;m s-s-sorry, I&#39;m s-s-sooorryyy.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I think I won&#39;t have grapes after all.&quot;//&lt;/span&gt;

Watching the poor Val cover her genitals in pain and shrink against the cold makes a chill run through your waist, and you almost decide that the punishment was a bit excessive... But you reached your goal. With that happy thought in mind, you leave the Shapeshifter to suffer her misfortune alone.

&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Maaterasu has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Valtan has increased.&lt;/span&gt;
//Maaterasu&#39;s views have grown more favorable towards domination.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chVal.relations.chPlayerCharacter.enmity.stv += 350;
State.variables.chVal.relations.chAte.enmity.stv += 350;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chAte.friendship.stv += 150;
addPointsToDrive(gC(&quot;chAte&quot;).dDomination,100);
applyAlteredState([&quot;chVal&quot;],createFrozenPussy());
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Charisma AND empathy check: failed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So you think that being hungry is worth getting on your knees and eating her out? Doesn&#39;t that sound a bit off to you?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;No, why would it? I&#39;m really hungry right now.&quot;//&lt;/span&gt;

Her conviction at claiming that leaves you disarmed, your mouth half-open as it&#39;s unable to utter any more arguments. You finally sigh, and accept your loss.

[[You leave|SE TGoL Player Leaves]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="434" name="SE TGoL Defy Valtan Player Defeat" tags="" position="8278,537" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chVal&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
The grapes have all fallen through the ground. Some frozen, some burned, others splashed against the dirt. Next to them, you lie defeated.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;So, was this worth ruining my morning happy hour?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You know what?&quot;//&lt;/span&gt; You say as you recover your breath. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It absolutely was. You may have beaten me soundly, but you still didn&#39;t get what you wanted.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You have messed up priorities.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Do I?&quot;//&lt;/span&gt; You take a look around. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And where is Ate?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;She left shortly after we started fighting. She probably didn&#39;t want to eat the grapes out of the ground.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Makes sense.&quot;//&lt;/span&gt;

A short while later, Maaterasu gets a different meal in the dining hall. Word of this reaches Drishtya, and blames both Valtan, Claw and you for not being able to deliver the Aiishen&#39;s breakfast.

&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Valtan has slightly decreased.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Valtan has increased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your rivalry with Valtan has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Claw has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Maaterasu has slightly decreased.&lt;/span&gt;
//Claw, Valtan and you have lost 1 merit.//
//Valtan&#39;s views have grown more favorable towards domination.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chVal.friendship.stv -= 100;
State.variables.chPlayerCharacter.relations.chVal.submission.stv += 400;
State.variables.chPlayerCharacter.relations.chVal.rivalry.stv += 100;
State.variables.chVal.relations.chPlayerCharacter.friendship.stv -= 100;
State.variables.chVal.relations.chPlayerCharacter.domination.stv += 400;
State.variables.chVal.relations.chPlayerCharacter.rivalry.stv += 100;
State.variables.chAte.relations.chPlayerCharacter.friendship.stv -= 150;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv -= 100;
State.variables.chClaw.relations.chVal.enmity.stv += 100;
State.variables.chPlayerCharacter.changeMerit(-1);
State.variables.chVal.changeMerit(-1);
State.variables.chClaw.changeMerit(-1);
addPointsToDrive(gC(&quot;chVal&quot;).dDomination,100);
State.variables.chPlayerCharacter.lust.current = State.variables.chPlayerCharacter.lust.max;
State.variables.chVal.lust.current = State.variables.chVal.lust.max;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="435" name="Img tests" tags="" position="1646,442" size="100,100">&lt;div id=&quot;parent&quot;&gt;
    &lt;img class=&quot;image1&quot; src=&quot;img/logo.png&quot; style=&quot;height:125px; width:125px;&quot;&gt;
    &lt;img class=&quot;image2&quot; src=&quot;img/energyIcon.png&quot; style=&quot;height:20px; width:20px; top:-50px&quot;&gt;
&lt;/div&gt;

&lt;img src=&quot;img/energyIcon.png&quot; style=&quot;height:125px; width:125px;&quot;&gt;</tw-passagedata><tw-passagedata pid="436" name="SE Friend Back At Home Shes Not Valtan" tags="" position="3166,815" size="100,100">&lt;&lt;script&gt;&gt;&lt;&lt;/script&gt;&gt; \
And when she turns her face to you, you discover she&#39;s not Val.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Aah!? Who are you!?&quot;//&lt;/span&gt;

Worry and caution show in her diminutive face, outlined soft and small curves that end in a small chin. Her eyes are small, sincere and beautiful. This is a teal angel.

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/sillan-full.png]]
&lt;/div&gt; \

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;No, don&#39;t worry, please.&quot;//&lt;/span&gt;

[[Continue|SE Friend Back At Home ShesValtan]]</tw-passagedata><tw-passagedata pid="437" name="SE Gleaming Caverns Overview Start" tags="" position="2511,1170" size="100,100">$customRoomIntro
All the Candidates have already finished their breakfast, yet no one is leaving the dining hall. Dutzelt told you that Drishtya had something important to discuss with all of you today, and thus, everyone waits. Nashillbyir, Padmiri, Valtan and you have a lively discussion, and Maaterasu intervenes from time to time. Claw is lost in their own thoughts, pointlessly poking her empty plate - but Dutzelt soon takes her only entertainment away when he cleans the whole table.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I&#39;m sorry for the wait.&quot;//&lt;/span&gt; Drishtya&#39;s voice immediately draws everyone&#39;s attention, putting an abrupt end to your conversation. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Today we will be discussing your first travel as Candidates.&quot;//&lt;/span&gt; She declares as she takes a seat at the end of the table.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Ooh? Will we be parting be soon?&quot;//&lt;/span&gt; Padmiri asks enthusiastically.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;We will leave the Temple in seven days from today, and we&#39;ll be visiting the Shapeshifter tribe.&quot;//&lt;/span&gt;

Padmiri&#39;s face turns from enthusiasm to surprise, then to shock. You turn your eyes towards Valtan, who is starting to lose her usual smile.

//Did I miss something? Did Drishtya say something bad?//

&lt;span style=&quot;color:khaki&quot;&gt;Note: The first adventure is a work in progress. As of version 0.3.0, the first adventure will not start. If you wish to experience the first adventure without starting a new playthrough, you must keep a separate save from a few days before the adventure starts and load it in a future version.&lt;/span&gt;

[[Continue|SE Gleaming Caverns Overview Rules]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="438" name="SE Gleaming Caverns Overview Rules" tags="" position="2623,1170" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;The Shapeshifter tribe will be celebrating the Twisted Festival soon, which is one of their most important traditions. As Candidates to High Priestess, it&#39;s fundamental for you to be familiar with all of the tribes&#39; customs.&quot;//&lt;/span&gt; 

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;The Twisted Festival? That&#39;s quite a strange name.&quot;//&lt;/span&gt; Nashillbyir wonders, oblivious to whatever is worrying Padmiri.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;In our tribe, the act of supplanting the identities of others with ill intent is severely frowned upon. Therefore, those who wish to shapeshift as someone else, must only do so for brief periods, and not allow the lie to live for long.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmm. That&#39;s the most characteristic trait of the Shapeshifters, and you condemn its use?&quot;//&lt;/span&gt; Claw asks with mild disbelief.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Our tribe reached that decision after a period of severe turmoil, intrigues and conflict, when no one could be trusted. It&#39;s a harsh rule, and it goes against our nature, up to some point, but if we didn&#39;t respect it our tribe may return to darker times.&quot;//&lt;/span&gt; Valtan listens quiet to Drishtya&#39;s explanation, in utmost silence. It doesn&#39;t fly over your head that she may be feeling this as a reprimand.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;The exception to this rule is the Twisted Festival: for one day, everyone is allowed to take anyone&#39;s identity and do as they wish, as long as they don&#39;t commit any other serious crimes. It is taken for granted that nothing anyone does during that day should be taken seriously, for it was probably not done by the person you saw doing it.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh, so you weren&#39;t ignoring my question.&quot;//&lt;/span&gt; Drishtya sticks her eyes on Nashillbyir. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;I-I didn&#39;t meant that as... I mean, thank you for answering.&quot;//&lt;/span&gt; The Priestess Regent closes her eyes for a couple of seconds, then continues.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;In top of that, during the Twisted Festival there&#39;s also an improvised play. Unlike the drama plays you&#39;re used to reading, the play of the Twisted Festival has no written script, but some background and a few characters, and everything else is improvised by the performers: characters may come and go, their ideas and affiliations could change, and even the main plot usually takes a couple of unexpected turns. It is preferred for the improvisation to keep a balance between what&#39;s logical and what&#39;s absolutely unexpected, but there are no absolute rights or wrongs. Everyone followed me so far?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I... I think I did, but it sounds fairly strange. I don&#39;t think I&#39;ll understand it until I&#39;ve seen it.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Then you will not be glad to hear that, during the years when there are Candidates in training, they are expected to participate as performers.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh, no. Wait, that will not influence our chances to win the competition, right?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It absolutely will. The tribes&#39; perception of you influence your merit, and participation in their traditions plays a large role in how they perceive you.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...But that&#39;s horrible. I&#39;m a horrible actress, this- I&#39;m going to be a disaster.&quot;//&lt;/span&gt; The realization that not everything in the competition may be solved with a well landed kick hits the Ashwalker like an unblocked punch in the stomach.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;If you feel that strongly about it, I recommend you to dedicate extra time to training in the amphitheater during the following days, as well as to reading.&quot;//&lt;/span&gt;

[[Continue|SE Gleaming Caverns Overview Valtan Crime]]</tw-passagedata><tw-passagedata pid="439" name="SE Gleaming Caverns Overview Valtan Crime" tags="" position="2728,1170" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
Padmiri whispers something to Maaterasu, and she replies with another whisper. Then they nod in agreement, and ask: &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Drishtya, Ate and I had something we wanted to ask about.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Sure, we may begin the turn of questions.&quot;//&lt;/span&gt; Drishtya replies.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Can Valtan even go back to her tribe?&quot;//&lt;/span&gt; The Aiishen says, like a tree falling in top of a house.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Ate! Don&#39;t put it so bluntly!&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Did I say something wrong?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wait, why shouldn&#39;t Valtan be able to...?&quot;//&lt;/span&gt; You turn your eyes yet again towards the blue Shapeshifter, who has stayed silent ever since the moment Drishtya announced your travel. Her expression has finished its transition to complete seriousness. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Is it because she took the place of the other Candidate?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;...&quot;//&lt;/span&gt; The Head Priestess remains silent, waiting for the commotion and the whispers to calm down, somewhat. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Supplanting someone&#39;s identity is a crime in our tribe, supplanting someone&#39;s identity to get something in return is an even more serious crime, and fooling the whole tribe in the process only makes things far worse. Under normal circumstances, such a crime would be punished with exile.&quot;//&lt;/span&gt;

//What!?//

The air in the dining hall turns tense. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;But members of the Passion Temple may only be judged by the head of the Passion Temple, which, due to the circumstances of life, happened to be me a few weeks ago, when I judged Valtan.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You judged Valtan!?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I judged Valtan, and sentenced that her punishment would be to accept the treatment she would receive from her tribe.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Wait, but this...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;If the Shapeshifter tribe refuses to ackownledge her, can she even be their Candidate?&quot;//&lt;/span&gt; Claw strikes with the curiosity and lack of empathy of a feline that plays with wounded prey - //yet there&#39;s a small hint of sincere concern in her face.//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Yes, once a Candidate has been accepted by the Passion Temple, they no longer require the support of their tribe.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Will they let Valtan enter?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;They will. The owe that respect to the Temple. But I wouldn&#39;t count on them treating her kindly.&quot;//&lt;/span&gt;

[[Continue|SE Gleaming Caverns Overview Concern]]</tw-passagedata><tw-passagedata pid="440" name="SE Gleaming Caverns Overview Concern" tags="" position="2835,1170" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chAte&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Valtan, are you feeling ok?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Me? Of course I&#39;m fine. Why wouldn&#39;t I?&quot;//&lt;/span&gt;

Everyone stares at her. Even if it wasn&#39;t a fact as clear as the light of the day that no one believes her, her unusually stoic face betrays what possibly was the most obvious lie of her life - perhaps directed at herself, rather than you.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Sigh.&quot;//&lt;/span&gt; She turns her face to the side for one moment, only to look back to everyone and reassert her position. &lt;span @style=$chVal.colorStyleKey&gt;//&quot;I took a decision while I was fully aware of its implications. I knew the lie wouldn&#39;t last forever, probably not even for very long. I knew all of that and went ahead anyway. I&#39;ve had time to come to terms with this, and, and I&#39;m fine.&quot;//&lt;/span&gt;

Another tense silence follows, but not for long.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Valtan.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Your fist is shaking.&quot;//&lt;/span&gt;

The Shapeshifter quickly hides her hands below the table.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Let&#39;s move on.&quot;//&lt;/span&gt; Drishtya tries to put an end to the conversation.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Yes. Let&#39;s do that.&quot;//&lt;/span&gt;

[[Continue|SE Gleaming Caverns Overview Monsters]]</tw-passagedata><tw-passagedata pid="441" name="SE Gleaming Caverns Overview Monsters" tags="" position="2938,1170" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Are there any other questions?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Are there any monsters near the Gleaming Caverns that we should be aware of?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Not many. The Gleaming Caverns and their surroundings are a very calm area. Just to ensure everyone is on the same page, I&#39;ll remind you that monsters are neither animals nor sentient people, just formations of aether that hunt living beings to feed on their energy.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Monsters are formations of aether?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I don&#39;t fully understand it myself, but it&#39;s on our written tradition since immerorial times, and scholars of magic don&#39;t dispute that claim. Perhaps you can ask Taototh later. In any case, we will follow standard security measures: it&#39;ll be forbidden for you to explore the wilds without anyone by your side. Before you ask me, Claw, this applies to you as well.&quot;//&lt;/span&gt; Claw had her mouth open, but she promptly shuts up. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Right before we leave, I&#39;ll teach you a magical technique that has always been taught to the Temple&#39;s Priestesses and Priests to defend themselves against monsters.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I have another question. Will servitude relationships remain as they are when we leave the Temple?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;An appropriate inquiry. All special agreements and deals you have formed while we&#39;re at the Temple will be declared null and void, and everyone will be freed of any bondage they happen to be locked in, for they could interfere with your goals and duties during the travels. Anything else?&quot;//&lt;/span&gt; A brief silence follows. Drishtya takes it for an answer. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Then I&#39;ll consider this meeting finished. Remember to pay special attention to your training in the social arts if you esteem it appropriate, and consider reading on the Shapeshifter traditions and the Gleaming Caverns in the library, if you haven&#39;t yet. Have a productive day.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:khaki&quot;&gt;The Candidates&#39; affinities are now focused on charisma and empathy.&lt;/span&gt;

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="442" name="SE Post Adventure Placeholder" tags="" position="2963,1045" size="100,100">&lt;span style=&quot;color:khaki&quot;&gt;Placeholder event: The Candidates&#39; affinities have returned to normal.&lt;/span&gt;

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="443" name="SecondDay RitualOfAvatars3c" tags="" position="732,797" size="100,100">Drishtya steps back, and takes a long look at everyone. She opens her arms, hands and palms long and wide, and pulls them, like a puppeteer controlling the very forces of nature.

The mist massages your skin, and your body vibrates. You feel waves running through your body, from your shoulders to your hands, from your waist to your neck, and from your neck to your groin. And it pulsates.

You feel a force right above your clitoris, pushing inside and out of your body. Your abdomen is weak, your legs tremble. Heat consumes you, and pleasure engulfs you.

//Nnn... Gghh... Aaaaa//aaa//aaahh....//

//&lt;span style=&quot;color:red&quot;&gt;You have reached orgasm!&lt;/span&gt;//
&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.lust.current = 100;&lt;&lt;/script&gt;&gt; \

Your breathing had accelerated, but after reaching orgasm, it slowly goes back to normal. You feel disoriented, and you lose half a minute to your dizziness. When you&#39;re fully back to normal, the mist is dissipating.

[[Continue|SecondDay RitualOfAvatars4c]]</tw-passagedata><tw-passagedata pid="444" name="SecondDay RitualOfAvatars3d" tags="" position="852,806" size="100,100">Drishtya steps back, and takes a long look at everyone. She opens her arms, hands and palms long and wide, and pulls them, like a puppeteer controlling the very forces of nature.

The mist massages your skin, and your body vibrates. You feel waves running through your body, from your shoulders to your hands, from your waist to your neck, and from your neck to your groin. And it pulsates.

You feel a force wrapping your legs, your waist, your behinds. And then it enters you. Your abdomen is weak, your legs tremble. Heat consumes you, and pleasure engulfs you.

//Nnn... Gghh... Aaaaa//aaa//aaahh....//

//&lt;span style=&quot;color:red&quot;&gt;You have reached orgasm!&lt;/span&gt;//
&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.lust.current = 100;&lt;&lt;/script&gt;&gt; \

Your breathing had accelerated, but after reaching orgasm, it slowly goes back to normal. You feel disoriented, and you lose half a minute to your dizziness. When you&#39;re fully back to normal, the mist is dissipating.

[[Continue|SecondDay RitualOfAvatars4d]]</tw-passagedata><tw-passagedata pid="445" name="SecondDay RitualOfAvatars4c" tags="" position="740,904" size="100,100">You&#39;re looking down.

//That... Is mine?//

Yes.

//What is it?//

A penis, obviously.

//But I don&#39;t have a penis.//

You do, now.

//Wait, what?//

You send a hand to your groin. Your pussy is still there, as is your clitoris, just below your new tool. You palpate the rest of your body, and it doesn&#39;t look like anything else has changed.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Huh? What&#39;s that?&quot;//&lt;/span&gt;

Short seconds later, everyone&#39;s attention has turned to you. Apparently, no one else had a dick grow between their legs.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It looks like someone reacted differently to the Ritual.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;We can see that.&quot;//&lt;/span&gt; Valtan says, smirking.

//Why do I feel far more naked than earlier!?//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;This is completely normal, albeit unusual. The Goddess has many faces and forms, and sometimes, tuning someone&#39;s spirit with the Goddess comes with surprises. This is a blessing, and I hope you enjoy it as such.&quot;//&lt;/span&gt;

//Wait, do I have no say in this!?// You think to yourself, as you shrink between your shoulders, assaulted by everyone&#39;s interest.

&lt;&lt;script&gt;&gt;
	for ( var charKey of [&quot;chPlayerCharacter&quot;] ) {
		State.variables[charKey].addBodypart(&quot;dick&quot;,&quot;dick&quot;);
	}	
&lt;&lt;/script&gt;&gt; \
[[Continue|SecondDay MeetTempleStaff]]</tw-passagedata><tw-passagedata pid="446" name="SecondDay RitualOfAvatars4d" tags="" position="852,921" size="100,100">Your legs and arms feel weak and numb, your mind is quiet, your whole body rests relaxed, and behind it all, you feel invigorated, as if the mere act of wishing it would allow you to fly.

...But a surprise awaits you as you turn your gaze to the others. Where there were only clitorises, there are now dicks as well.

//Wait, have I...?//

Your nethers, however, are the same.

//But... Why!?//

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Hm, Head Priestess? I think something went wrong with $chPlayerCharacter.name...&quot;//&lt;/span&gt;

Everyone&#39;s eyes turn towards you.

//Why do I feel ever more naked than before!?//

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Don&#39;t worry about it. This is completely normal, albeit unusual. The Goddess has many faces and forms, and sometimes, tuning someone&#39;s spirit with the Goddess comes with exceptions. This is a blessing of the Goddess as all others.&quot;//&lt;/span&gt;

//Do I get no say in this!?//

&lt;&lt;script&gt;&gt;
	for ( var charKey of [&quot;chVal&quot;,&quot;chMir&quot;,&quot;chNash&quot;,&quot;chAte&quot;,&quot;chClaw&quot;] ) {
		State.variables[charKey].addBodypart(&quot;dick&quot;,&quot;dick&quot;);
	}	
&lt;&lt;/script&gt;&gt; \
[[Continue|SecondDay MeetTempleStaff]]</tw-passagedata><tw-passagedata pid="447" name="SE MartialTutorshipI Start" tags="" position="8200,670" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Come on, run! It&#39;s time for your first class!&quot;//&lt;/span&gt; Nash shouts.

//I already noticed that the idea of becoming my tutor excited her... I just hope I don&#39;t get overcome by her enthusiasm.//

&lt;&lt;if $StVars.check1 is &quot;none&quot;&gt;&gt; \
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You still have no weapon.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yeah, well-&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That&#39;s terrible, if I have to be honest. The competition is only going to get more dangerous from now on, and being armed is an advantage you can&#39;t renounce to. ...But I can lend you this, just for today.&quot;//&lt;/span&gt; The Ashwalker hands you a staff of battle, painted by a lighter color than her usual one. You get used to its weight in the little time she grants you. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hold it high, in front of your chest!&quot;//&lt;/span&gt;
&lt;&lt;elseif $StVars.check1 is &quot;staff&quot;&gt;&gt; \
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You have a staff, great. You will need one for today&#39;s lesson. Hold it high, in front of your chest!&quot;//&lt;/span&gt;
&lt;&lt;else&gt;&gt; \
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;For today&#39;s lesson, you&#39;ll need this.&quot;//&lt;/span&gt; The Ashwalker hands you a staff of battle, painted by a lighter color than her usual one. You get used to its weight in the little time she grants you. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hold it high, in front of your chest!&quot;//&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \

You do as you&#39;re told, holding the staff with both hands in front of you... And you immediately hold it tighter, just in time to block Nashillbyir&#39;s hit.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nash, wait-&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Good, you&#39;re awake! That was an easy one, just testing if you were aware. Now focus on the strength of your legs.&quot;//&lt;/span&gt;

//She just isn&#39;t going to give me the time to rest, right?//

[[Continue|SE MartialTutorshipI Balance]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="448" name="SE MartialTutorshipI Balance" tags="" position="8306,667" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;The most fundamental thing in battle is controlling your weight and your inertia. The difference between mastering your control and not paying attention to it is the difference between being as resilient as a tree and tripping over. Move one of your legs back as much as you can, and let the whole weight of your body fall over it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It doesn&#39;t feel too comfortable.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Because you are used to have both of your legs to hold your weight. It&#39;s practical, most of the time, but during the heat of battle you&#39;ll be constantly moving around, being forced to disadvantageous positions, and sometimes making risky, extreme movements to press your advantage. The balance of your weight dictates where you can move, where you can&#39;t move, and even...&quot;//&lt;/span&gt;

Before giving you time to fix your position, she attacks you again.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hey! Don&#39;t do that without warning!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Good block!&quot;//&lt;/span&gt; She doesn&#39;t stop pushing her staff against yours. If she was using all her strength, you would easily fall. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;But you can feel how your position requires you to use more strength to hold against me than I need to push you down, right?&quot;//&lt;/span&gt; Nash stops pressing against you, and you quickly straighten up.

//I think I&#39;m tired already.//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Something else that you should learn from that: the strength in your arms comes from your legs. Now, to put it into practice,&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We will sit down and you tell me about how you trained when you were younger?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Nope! I will chase you down and attack you! You&#39;ll have to run away from me while you block my blows, so you&#39;ll have to keep a balance between running around and maintaining your equilibrium to project your strength against me!&quot;//&lt;/span&gt;

//You child of a...//

[[Some time later|SE MartialTutorshipI Question]]</tw-passagedata><tw-passagedata pid="449" name="SE MartialTutorshipI Question" tags="" position="8418,660" size="100,100">$customRoomIntro
You hold on to your staff, trying to catch your breath. Nashillbyir hasn&#39;t been terribly aggressive against you, but the constant exercise without rest has worn you down.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;So, are you assimilating what I just told you?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m assimilating the fact that you&#39;re a sadist and want to see me suffer.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Damn, I was found out. I&#39;ll have to punish you so you don&#39;t spread the word...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m going to attack you back if you don&#39;t let me rest!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hahaha! Rest easy, rest easy, we were going to have a short break.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You only want me to let my guard down.&quot;//&lt;/span&gt;

Nash shrugs at your comment, her mischievous smile not hiding the fact that she&#39;s enjoying pushing you to your limits.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Regardless, you know that blocking isn&#39;t the only options you have when someone is attacking you. If we weren&#39;t practicing, but in a real fight, and I was just&quot;//&lt;/span&gt;, she moves her staff around, simulating a vertical blow against you, &lt;span @style=$chNash.colorStyleKey&gt;//&quot;about to strike you, what would you do?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Accept my fate and get beaten down, just to have the chance to rest?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And your second option?&quot;//&lt;/span&gt;

[[Block it|SE MartialTutorshipI ResponseBlock]]
[[Evade it|SE MartialTutorshipI ResponseEvade]]
[[Deflect it|SE MartialTutorshipI ResponseDeflect]]
[[Attack back|SE MartialTutorshipI ResponseAttack]]</tw-passagedata><tw-passagedata pid="450" name="SE MartialTutorshipI ResponseBlock" tags="" position="8200,779" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I would block it. It&#39;s the most straightforward choice.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It is a good option, as long as you&#39;re strong enough to take the hit, and it doesn&#39;t require an overly complex technique. But the most effective response is usually deflecting the blow. This way, you require as little strength and energy as possible to push your opponent towards a disadvantageous position, and get yourself ready to attack - but it requires a lot of precision. You may not be ready to do it just yet, but it is the ideal goal. And now that you&#39;ve caught your breath...&quot;//&lt;/span&gt;

Nashillbyir spins her weapon around, takes impulse, and -&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let&#39;s see if you&#39;ve learned something!&quot;//&lt;/span&gt;- charges against you.

&lt;&lt;script&gt;&gt;
State.variables.StVars.check2 = &quot;block&quot;;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;if $StVars.check4 &gt; 27&gt;&gt; \
[[Block|SE MartialTutorshipI ReactionBlock]]
&lt;&lt;else&gt;&gt; \
[[Block|SE MartialTutorshipI ReactionBlockFail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check6 &gt; 26&gt;&gt; \
[[Evade|SE MartialTutorshipI ReactionEvade]]
&lt;&lt;else&gt;&gt; \
[[Evade|SE MartialTutorshipI ReactionEvadeFail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check5 &gt; 43&gt;&gt; \
[[Deflect|SE MartialTutorshipI ReactionDeflect]]
&lt;&lt;else&gt;&gt; \
[[Deflect|SE MartialTutorshipI ReactionDeflectFail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check7 &gt; 25&gt;&gt; \
[[Attack|SE MartialTutorshipI ReactionAttack]]
&lt;&lt;else&gt;&gt; \
[[Attack|SE MartialTutorshipI ReactionAttackFail]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="451" name="SE MartialTutorshipI ResponseEvade" tags="" position="8306,777" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I would evade it. It may take some effort, but it&#39;s the safest choice.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s definitely the safest, as long as you&#39;re agile and perceptive enough. But the most effective response is usually deflecting the blow. This way, you require as little strength and energy as possible to push your opponent towards a disadvantageous position, and get yourself ready to attack - but it requires a lot of precision. You may not be ready to do it just yet, but it is the ideal goal. And now that you&#39;ve caught your breath...&quot;//&lt;/span&gt;

Nashillbyir spins her weapon around, takes impulse, and -&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let&#39;s see if you&#39;ve learned something!&quot;//&lt;/span&gt;- charges against you.

&lt;&lt;script&gt;&gt;
State.variables.StVars.check2 = &quot;evade&quot;;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;if $StVars.check4 &gt; 27&gt;&gt; \
[[Block|SE MartialTutorshipI ReactionBlock]]
&lt;&lt;else&gt;&gt; \
[[Block|SE MartialTutorshipI ReactionBlockFail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check6 &gt; 26&gt;&gt; \
[[Evade|SE MartialTutorshipI ReactionEvade]]
&lt;&lt;else&gt;&gt; \
[[Evade|SE MartialTutorshipI ReactionEvadeFail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check5 &gt; 43&gt;&gt; \
[[Deflect|SE MartialTutorshipI ReactionDeflect]]
&lt;&lt;else&gt;&gt; \
[[Deflect|SE MartialTutorshipI ReactionDeflectFail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check7 &gt; 25&gt;&gt; \
[[Attack|SE MartialTutorshipI ReactionAttack]]
&lt;&lt;else&gt;&gt; \
[[Attack|SE MartialTutorshipI ReactionAttackFail]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="452" name="SE MartialTutorshipI ResponseDeflect" tags="" position="8415,774" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I would deflect it, just enough to get a better position than my opponent.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That would be the ideal reaction! Deflecting leaves your opponent in a disadvantageous position if done properly, and it&#39;s far faster than evading. The only problem is that it requires proper precision and technique, so you&#39;ll need to practice a lot if you want to do it consistently. If you don&#39;t consider yourself ready to execute a proper deflection, don&#39;t be afraid of blocking or moving away, those are safe enough anyway. And now that you&#39;ve caught your breath...&quot;//&lt;/span&gt;

Nashillbyir spins her weapon around, takes impulse, and -&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let&#39;s see if you&#39;ve learned something!&quot;//&lt;/span&gt;- charges against you.

&lt;&lt;script&gt;&gt;
State.variables.StVars.check2 = &quot;deflect&quot;;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;if $StVars.check4 &gt; 27&gt;&gt; \
[[Block|SE MartialTutorshipI ReactionBlock]]
&lt;&lt;else&gt;&gt; \
[[Block|SE MartialTutorshipI ReactionBlockFail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check6 &gt; 26&gt;&gt; \
[[Evade|SE MartialTutorshipI ReactionEvade]]
&lt;&lt;else&gt;&gt; \
[[Evade|SE MartialTutorshipI ReactionEvadeFail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check5 &gt; 43&gt;&gt; \
[[Deflect|SE MartialTutorshipI ReactionDeflect]]
&lt;&lt;else&gt;&gt; \
[[Deflect|SE MartialTutorshipI ReactionDeflectFail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check7 &gt; 25&gt;&gt; \
[[Attack|SE MartialTutorshipI ReactionAttack]]
&lt;&lt;else&gt;&gt; \
[[Attack|SE MartialTutorshipI ReactionAttackFail]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="453" name="SE MartialTutorshipI ResponseAttack" tags="" position="8523,774" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I would just attack back. If they want to hurt me, they&#39;ll get the painful end of the stick as well.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That&#39;s... That&#39;s a terrible choice. Trading your opponent&#39;s pain for yours? The purpose of combat is defeating your opponent, not mutual defeat...//&lt;/span&gt; She gives you a worried look. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Regardless, the ideal option would be deflecting your enemy&#39;s blow. Deflecting leaves your opponent in a disadvantageous position if done properly, and it&#39;s far faster than evading. The only problem is that it requires proper precision and technique, so you&#39;ll need to practice a lot if you want to do it consistently. If you don&#39;t consider yourself ready to execute a proper deflection, don&#39;t be afraid of blocking or moving away, those are safe enough anyway. And now that you&#39;ve caught your breath...//&lt;/span&gt;

Nashillbyir spins her weapon around, takes impulse, and -&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let&#39;s see if you&#39;ve learned something!&quot;//&lt;/span&gt;- charges against you.

&lt;&lt;script&gt;&gt;
State.variables.StVars.check2 = &quot;attack&quot;;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;if $StVars.check4 &gt; 27&gt;&gt; \
[[Block|SE MartialTutorshipI ReactionBlock]]
&lt;&lt;else&gt;&gt; \
[[Block|SE MartialTutorshipI ReactionBlockFail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check6 &gt; 26&gt;&gt; \
[[Evade|SE MartialTutorshipI ReactionEvade]]
&lt;&lt;else&gt;&gt; \
[[Evade|SE MartialTutorshipI ReactionEvadeFail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check5 &gt; 43&gt;&gt; \
[[Deflect|SE MartialTutorshipI ReactionDeflect]]
&lt;&lt;else&gt;&gt; \
[[Deflect|SE MartialTutorshipI ReactionDeflectFail]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check7 &gt; 25&gt;&gt; \
[[Attack|SE MartialTutorshipI ReactionAttack]]
&lt;&lt;else&gt;&gt; \
[[Attack|SE MartialTutorshipI ReactionAttackFail]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="454" name="SE MartialTutorshipI ReactionBlock" tags="" position="8196,885" size="100,100">$customRoomIntro
You slightly slide a leg back and distribute your weight between your front and your back. You rush your staff forwards, placing each hand at one extreme, and hold yourself.

&lt;span style=&quot;color:green&quot;&gt;Resilience AND physique check: passed.&lt;/span&gt;

The blow strikes against you, the energy from the hit flowing into your staff, your arms, your legs, pushing you back... And you hold your ground.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hah...! Hah, take that!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Well done! You barely even flinched!&quot;//&lt;/span&gt; Nash steps back, placing the bottom of her weapon on the ground. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;For all your complaining, you aren&#39;t doing so bad.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hmpf.&quot;//&lt;/span&gt;

She giggles. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;That was a great start, don&#39;t you think? I&#39;ll go easy on you for the rest of the day, but only because you put in the effort.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Nashillbyir has slightly increased.&lt;/span&gt;
You gained 100 resilience experience.
You have gained weapon resistance.
You lost &lt;span style=&quot;color:limegreen&quot;&gt;20 energy.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 20;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chNash.submission.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.domination.stv += 150;
State.variables.chPlayerCharacter.combatAffinities.weapon.resistance += 5;
State.variables.chPlayerCharacter.resilience.experience += 100;
State.variables.chNash.charisma.experience += 200;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="455" name="SE MartialTutorshipI ReactionEvade" tags="" position="8300,885" size="100,100">$customRoomIntro
You project the trajectory of the staff with your eyes, flex your legs, and quickly glance to the side...

&lt;span style=&quot;color:green&quot;&gt;Agility AND perception check: passed.&lt;/span&gt;

And you switfly jump to your left, quickly swinging your staff forwards - but Nash is fast enough to meet it with hers.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Heh, you&#39;re a couple of years late if you want to meet me with my pants down!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Figuratively, I hope.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Figuratively, yes, you can still do it if you come to my room later.&quot;//&lt;/span&gt;

You push your staff harder, but she nimbly deflects it, and takes the lead yet again.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That was a great start, don&#39;t you think? I&#39;ll go easy on you for the rest of the day, but only because you put in the effort.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hmf.&quot;//&lt;/span&gt; You mumble, annoyed that you didn&#39;t get the chance to get back at her.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Nashillbyir has slightly increased.&lt;/span&gt;
You gained 100 agility experience.
You have gained weapon resistance.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chNash.submission.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.domination.stv += 150;
State.variables.chPlayerCharacter.combatAffinities.weapon.resistance += 5;
State.variables.chPlayerCharacter.agility.experience += 100;
State.variables.chNash.charisma.experience += 200;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="456" name="SE MartialTutorshipI ReactionDeflect" tags="" position="8406,884" size="100,100">$customRoomIntro
The staff falls towards you... And that is your chance. You barely move half a step to your side, while your left hand pushes your weapon upwards, seeking to meet Nash&#39;s.

&lt;span style=&quot;color:green&quot;&gt;Agility AND perception AND physique check: passed.&lt;/span&gt;

And the wood slides against the wood, slightly changing the incoming blow&#39;s trajectory. A hit sure to strike you into the ground achieves nothing else than pushing Nashillbyir fowards, your staff ending in top of hers. When she notices this, she attempts to stop the charge, but it&#39;s too late.

//Where&#39;s your disadvantageous position now!?//

For half a second, the Ashwalker is stuck trying to move back, and it&#39;s more than enough for you. You take impulse with your right left, and your left foot flies upwards - kicking Nash&#39;s hand.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Aw!&quot;//&lt;/span&gt;

Your offensive stops there, and your tutor steps back several times, moving her injured hand to her mouth.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hey, that was pretty good!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Does that make me the teacher now?&quot;//&lt;/span&gt;

She smiles challenging. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Don&#39;t try to set off to fly just because you proved you can jump! You still have a lot to learn. Come on, we&#39;ve just barely started the day!&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has slightly increased.&lt;/span&gt;
You gained 100 physique experience.
You have gained weapon resistance.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.combatAffinities.weapon.resistance += 5;
State.variables.chPlayerCharacter.physique.experience += 100;
State.variables.chNash.charisma.experience += 200;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="457" name="SE MartialTutorshipI ReactionAttack" tags="" position="8516,887" size="100,100">$customRoomIntro
The staff falls towards you... And you decide to grab the bull by his horns. You push your weapon forwards, aiming to stab Nashillbyir, and

&lt;span style=&quot;color:green&quot;&gt;Physique AND agility check: passed.&lt;/span&gt;

Your hit and Nashillbyir&#39;s connect at the same time, your sholders receiving the blows in their entirety.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Aaaugh! What the hell was that!?&quot;//&lt;/span&gt;

You promptly drop the staff, your healthy hand moving to cover your pained joint.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That isn&#39;t what we discussed, at all!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yeah, but I hit you as well.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And now look at this! Can you even move your shoulder?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Well, hardly.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Great, so both of us are injured.&quot;//&lt;/span&gt; She sighs annoyed. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;I think we should rest for a while. If you disregard my advice so harshly...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Still, I hurt you as badly as you hurt me, so it&#39;s not your win.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...I can&#39;t believe you.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your enmity with Nashillbyir has increased.&lt;/span&gt;
You have gained weapon attack.
You lost &lt;span style=&quot;color:limegreen&quot;&gt;60 energy.&lt;/span&gt;
You have been injured.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 60;
State.variables.chNash.energy.current -= 40;
State.variables.chPlayerCharacter.relations.chNash.enmity.stv += 350;
State.variables.chNash.relations.chPlayerCharacter.enmity.stv += 350;
State.variables.chPlayerCharacter.combatAffinities.weapon.strength += 5;
State.variables.chNash.charisma.experience += 100;
applyAlteredState([&quot;chPlayerCharacter&quot;],createInjury());
applyAlteredState([&quot;chNash&quot;],createInjury());
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="458" name="SE MartialTutorshipI ReactionBlockFail" tags="" position="8200,1005" size="100,100">$customRoomIntro
You quickly rush to hold your staff forwards, bracing yourself for the impact...

&lt;span style=&quot;color:red&quot;&gt;Resilience AND physique check: failed.&lt;/span&gt;

The blow strikes against you, the energy from the hit flowing into your staff, your arms, your legs, pushing you back... And your muscles fail. You fall backwards.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;$chPlayerCharacter.name! Are you ok!?&quot;//&lt;/span&gt; Nashillbyir throws her staff away and runs to your side. She holds your hand and checks your arms and legs.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It... It hurts... I can move, but not too much...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh, Goddess. I pushed you too hard, didn&#39;t I...? Look, you injured your elbow in the fall.&quot;//&lt;/span&gt;

Taking a look at it, you find some blood and a scar, slowly getting healed.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let me...&quot;//&lt;/span&gt; The Ashwalker takes you by your legs and shoulder, and starts carrying you, not without considerable effort. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;ll take you to the baths, you need to rest for a while. Take it easy for the rest of the day, will you?&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has increased.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Nashillbyir has increased.&lt;/span&gt;
You gained 100 resilience experience.
You have gained weapon resistance.
You lost &lt;span style=&quot;color:limegreen&quot;&gt;60 energy.&lt;/span&gt;
You have been injured.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 60;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 350;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 350;
State.variables.chPlayerCharacter.relations.chNash.submission.stv += 350;
State.variables.chNash.relations.chPlayerCharacter.domination.stv += 350;
State.variables.chPlayerCharacter.combatAffinities.weapon.resistance += 5;
State.variables.chPlayerCharacter.resilience.experience += 100;
State.variables.chNash.charisma.experience += 200;
applyAlteredState([&quot;chPlayerCharacter&quot;],createInjury());
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="459" name="SE MartialTutorshipI ReactionEvadeFail" tags="" position="8306,1004" size="100,100">$customRoomIntro
You project the trayectory of the staff with your eyes, flex your legs, and quickly glance to the side...

&lt;span style=&quot;color:red&quot;&gt;Agility AND perception check: failed.&lt;/span&gt;

And you quickly jump to your left, but in the intensity of the moment, you trip and fall.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;$chPlayerCharacter.name! Are you ok!?&quot;//&lt;/span&gt; Nashillbyir throws her staff away and runs to your side.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It hurts... But I&#39;m fine, I think.&quot;//&lt;/span&gt;

She breathes, relieved. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;It looked more serious. That fall was pretty ugly. I didn&#39;t hit you, right?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;No, you didn&#39;t. So I passed the class anyway.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hah! You sure did. Perhaps this was the least bad choice. Can you get up?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sure, in a minute.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hmm. Despite everything, today was a pretty good start, don&#39;t you think? I&#39;ll go easy on you for the rest of the day, but only because you put in the effort.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Nashillbyir has slightly increased.&lt;/span&gt;
You gained 100 agility experience.
You have gained weapon resistance.
You lost &lt;span style=&quot;color:limegreen&quot;&gt;40 energy.&lt;/span&gt;//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 40;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chNash.submission.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.domination.stv += 150;
State.variables.chPlayerCharacter.combatAffinities.weapon.resistance += 5;
State.variables.chPlayerCharacter.agility.experience += 100;
State.variables.chNash.charisma.experience += 200;
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="460" name="SE MartialTutorshipI ReactionDeflectFail" tags="" position="8413,1005" size="100,100">$customRoomIntro
The staff falls towards you... And that is your chance. You barely move half a step to your side, while your left hand pushes your weapon upwards, seeking to meet Nash&#39;s.

&lt;span style=&quot;color:red&quot;&gt;Agility AND perception AND physique check: failed.&lt;/span&gt;

...But you fail to connect by half a hand. The blow falls towards its intended goal, and you haven&#39;t moved enough to evade it.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ayegh!&quot;//&lt;/span&gt; You rush your hands to your stricken knee, which has received the hit whole.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;$chPlayerCharacter.name! Are you fine?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;No! No, I&#39;m not!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh, Goddess, I think I pushed you too hard there... You&#39;ve got some blood, let me clean it.&quot;//&lt;/span&gt; She grabs a handful of her clothes and presses it slowly against your skin, letting it absorb the blood. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;That scar is going to take a while to heal. Can you walk?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Not easily...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Then I&#39;ll take you to the baths so that you can rest for a while. Let&#39;s take the rest of the day easy, ok?&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Nashillbyir has increased.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Nashillbyir has increased.&lt;/span&gt;
You gained 100 physique experience.
You have gained weapon resistance.
You lost &lt;span style=&quot;color:limegreen&quot;&gt;20 energy.&lt;/span&gt;
You have been injured.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 20;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv += 350;
State.variables.chNash.relations.chPlayerCharacter.friendship.stv += 350;
State.variables.chPlayerCharacter.relations.chNash.submission.stv += 350;
State.variables.chNash.relations.chPlayerCharacter.domination.stv += 350;
State.variables.chPlayerCharacter.combatAffinities.weapon.resistance += 5;
State.variables.chPlayerCharacter.physique.experience += 100;
State.variables.chNash.charisma.experience += 200;
applyAlteredState([&quot;chPlayerCharacter&quot;],createInjury());
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="461" name="SE MartialTutorshipI ReactionAttackFail" tags="" position="8523,1004" size="100,100">$customRoomIntro
The staff falls towards you... And you decide to grab the bull by his horns. You push your weapon forwards, aiming to stab Nashillbyir, and

&lt;span style=&quot;color:red&quot;&gt;Physique AND agility check: failed.&lt;/span&gt;

...Your shoulder receives the blow in its entirety, provoking you to drop your staff.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;$chPlayerCharacter.name! What the hell!?&quot;//&lt;/span&gt; The Ashwalker barely takes a couple of seconds to recover from her shock, then she throws her weapon away and runs over to your side. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;What were you even doing!?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I was... Fighting fire with fire.&quot;//&lt;/span&gt;

Nash covers her face with her hand, perplexed.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That isn&#39;t what we talked about, at all. If you disregard my advice this way... Look, it&#39;s turning purple.&quot;//&lt;/span&gt;

An ugly bruise has formed in your shoulder, but at least you haven&#39;t even bled.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;We should take the rest of the day easy. Come, lean on my shoulder, I&#39;ll take you somewhere else for you to rest.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Nashillbyir has increased a lot.&lt;/span&gt;
You lost &lt;span style=&quot;color:limegreen&quot;&gt;60 energy.&lt;/span&gt;
You have been injured.//

&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.energy.current -= 60;
State.variables.chPlayerCharacter.relations.chNash.submission.stv += 750;
State.variables.chNash.relations.chPlayerCharacter.domination.stv += 750;
State.variables.chNash.charisma.experience += 200;
applyAlteredState([&quot;chPlayerCharacter&quot;],createInjury());
&lt;&lt;/script&gt;&gt; \
$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="462" name="SE FAK Start" tags="" position="8723,202" size="100,100">$customRoomIntro
A snort hits your ears like an annoyed, yet obedient kid would passively protest against their parents. Claw is certainly not a fan of being forced to obey you, but she isn&#39;t actively resisting either. At least, not during the whole day.

She is accompanying you while you traverse the library to reach the training grounds, when you find Padmiri entranced by what appears to be a drama play.

//These two have had their share of conflict, haven&#39;t they? Now that Claw is obeying me... Could I get something out of making her harass Padmiri... In a sexual way?//

[[Make Claw harass Padmiri|SE FAK Telling Claw]]
[[Maybe another day|SE FAK Another Day]]
[[It&#39;s a bad idea|SE FAK Bad Idea]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="463" name="SE FAK Telling Claw" tags="" position="8837,200" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So here&#39;s the plan: you&#39;re going to be harassing Padmiri.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;That isn&#39;t an absolutely terrible idea.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;In a sexual way.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...How about you do it yourself?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nope, you will be doing it. Unless you want me to start the day giving you a good spanking.&quot;//&lt;/span&gt;

The tiger-girl sighs deeply, making an effort to swallow her annoyment. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Do you have a goal in mind? Or are you only doing this because it amuses you?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Let&#39;s provisionally say I want some entertainment.&quot;//&lt;/span&gt;

She rolls her eyes. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Sounds like a waste of time. Let&#39;s just get done with this as fast as possible.&quot;//&lt;/span&gt;

[[Continue|SE FAK Harassment options]]</tw-passagedata><tw-passagedata pid="464" name="SE FAK Another Day" tags="" position="9058,201" size="100,100">$customRoomIntro
//It&#39;s not a bad idea... But I&#39;m not in the mood today.//

You resume your walk, signaling Claw to continue following you. It&#39;s a good plan, but perhaps there are things you want to get ready first.

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.eventsCalendar.playedStoryEvents = arrayMinusA(State.variables.eventsCalendar.playedStoryEvents,&quot;fak0&quot;);
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="465" name="SE FAK Bad Idea" tags="" position="9170,200" size="100,100">$customRoomIntro
//Not, it&#39;s a terrible idea. I don&#39;t need them both to be hating me.//

You resume your walk, signaling Claw to continue following you. You have decided to play your cards safe and not put yourself in the middle of their disputes.

$eventsCalendar.finishEventButton</tw-passagedata><tw-passagedata pid="466" name="SE FAK Harassment options" tags="" position="8946,200" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;
seFaKpadmiriBotheredScore();
&lt;&lt;/script&gt;&gt; \
&lt;&lt;if $StVars.check2 is 0&gt;&gt; \
Padmiri quietly reads the play, unaware of the plots targetting her.
&lt;&lt;elseif $StVars.check2 is 1&gt;&gt; \
Padmiri focuses on the play she&#39;s reading, sporadically looking around.
&lt;&lt;elseif $StVars.check2 is 2&gt;&gt; \
The Leirien is having issues to concentrate, her legs frotting each other from time to time.
&lt;&lt;elseif $StVars.check2 is 3&gt;&gt; \
The flower-girl can barely hide how hot and bothered she is, her breathing is getting heavier and her eyes barely focus on the scroll in her hands.
&lt;&lt;/if&gt;&gt; \

Barely hidden behind some distant shelves, you whisper to Claw:

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You are going to...&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check1[0] is false&gt;&gt; \
[[Show skin|SE FAK Show skin]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already showed skin.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check1[1] is false&gt;&gt; \
[[Masturbate in front of her|SE FAK Masturbate]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already masturbated.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check1[2] is false&gt;&gt; \
[[Eat her out briefly|SE FAK Eat her out]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already ate her out.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check1[3] is false&gt;&gt; \
[[Moan from here|SE FAK Moaning kitty]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already moaned.
&lt;&lt;/if&gt;&gt; \
[[Get used in front of her|SE FAK Using Claw]] &lt;span style=&quot;color:red&quot;&gt;(This option will advance the event)&lt;/span&gt;</tw-passagedata><tw-passagedata pid="467" name="SE FAK Show skin" tags="" position="8719,316" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Walk in front of her and show her your goods.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmm.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Claw has increased very slightly.&lt;/span&gt;
&lt;&lt;script&gt;&gt;State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 50;&lt;&lt;/script&gt;&gt; \

Claw enters the corridor where Padmiri is reading and stands in front of her, displaying a confident and strong demeanor, but without letting go of her clothes. Padmiri has eyed her, but otherwise keeps reading.

You cross eyes with Claw, and signal her to get started. She kills you with her gaze, but promptly obeys. She pulls down the cloth covering her breasts with an abrupt movement, and lets her elbows fall over the table in front of Padmiri, fully displaying her body like a merchant would present her wares - except for her murderous expression. Padmiri doesn&#39;t take note of her face, however, as her eyes get lost in the sudden presentation of Claw&#39;s twins.

The proud tiger-girl suddenly straightens her back and turns around in one fast twirl, provoking her lower clothes to show very clear glimpses of her nethers, and leaves.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Umm... Bye.&quot;//&lt;/span&gt;

//Padmiri is getting nervous.//
&lt;&lt;script&gt;&gt;
applyBarPercentualDamage(&quot;chMir&quot;,&quot;lust&quot;,0.1);
applyBarPercentualDamage(&quot;chMir&quot;,&quot;willpower&quot;,0.05);
State.variables.chMir.relations.chClaw.sexualTension.stv += 150;
State.variables.chMir.mood.aroused += 5;
State.variables.StVars.check1[0] = true;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE FAK Harassment options]]</tw-passagedata><tw-passagedata pid="468" name="SE FAK Masturbate" tags="" position="8827,316" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Get in front of her and masturbate.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Tsch.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Claw has increased very slightly.&lt;/span&gt;
&lt;&lt;script&gt;&gt;State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 75;&lt;&lt;/script&gt;&gt; \

The tiger-girl parades along the library until she is a few meters away from the Leirien, and lets out an annoyed moan, trying to draw her attention. When Padmiri takes her eyes off the scroll, Claw is massaging her own breasts, rubbing them, pinching them, squeezing them.

One of her hands gets behind her loincloth, and starts moving rapidly, leaving the details of her pleasuring to the imagination of the spectators, which gets further stimulated by the obviously forced moans of the Beastkin. Padmiri&#39;s face grows as red as a timid rose, and looks around, looking for somewhere to hide. When she finds you, half-hidden behind a shelf, she quickly understands what&#39;s going on.

//Has Padmiri just hidden a hand under the table? What a dirty girl//, you observe amused, and satisfied. Not much later, Claw comes back to you.

//Padmiri is getting nervous.//
//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri has slightly grown.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
applyBarPercentualDamage(&quot;chMir&quot;,&quot;lust&quot;,0.1);
applyBarPercentualDamage(&quot;chMir&quot;,&quot;willpower&quot;,0.05);
State.variables.chMir.relations.chClaw.sexualTension.stv += 100;
State.variables.chClaw.relations.chMir.sexualTension.stv += 100;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 100;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 100;
State.variables.chMir.mood.aroused += 5;
State.variables.chMir.mood.submissive += 5;
State.variables.StVars.check1[1] = true;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE FAK Harassment options]]</tw-passagedata><tw-passagedata pid="469" name="SE FAK Eat her out" tags="" position="8944,314" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Get under her table and give her some tongue. Have no mercy.&quot;//&lt;/span&gt;

Claw was about to complain, but she thinks twice for a moment and decides to let it go.

&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Claw has increased very slightly.&lt;/span&gt;
&lt;&lt;script&gt;&gt;State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 50;&lt;&lt;/script&gt;&gt; \

Padmiri hears the steps of Claw, but chooses not to pay her attention. She gets suddenly startled, however, when a sudden intruder explores her legs. When she lets the scroll down, her face displays her thoughts like an open book: &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Please tell me she isn&#39;t under the table.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue to scene|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
fakClawOralsPadmiriInit();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \</tw-passagedata><tw-passagedata pid="470" name="SE FAK Moaning kitty" tags="" position="9054,314" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We&#39;ll remain hidden here while I have my way with you for a little while... Make sure she hears you.&quot;//&lt;/span&gt;

Claw looks away, grumpy as always, not letting a single opportunity to let you know she doesn&#39;t approve.

&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Claw has increased slightly.&lt;/span&gt;
&lt;&lt;script&gt;&gt;State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 100;&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Lift up your skirt... Fast.&quot;//&lt;/span&gt;

Your unwilling servant bends over, letting the weight of her torso rest against a shelf while she displays her body -but not her eyes- towards you.

&lt;&lt;link [[Continue to scene|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
fakPlayerPleasuresClaw();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \</tw-passagedata><tw-passagedata pid="471" name="SE FAK Using Claw" tags="" position="9167,312" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Let&#39;s gamble it. I&#39;m going to use you right in front of her.&quot;//&lt;/span&gt;

The Beastkin crosses her arms, looking right at your eyes. Finally, she nods and follows you.

&lt;span style=&quot;color:darkred&quot;&gt;Your enmity with Claw has increased.&lt;/span&gt;
&lt;&lt;script&gt;&gt;State.variables.chClaw.relations.chPlayerCharacter.enmity.stv += 150;
seFaKupdatePadmiriSubmissionScore();
&lt;&lt;/script&gt;&gt; \

As you advance through the library&#39;s corridor, you first take Claw&#39;s hand, then move yours to her waist. You giggle briefly, just enough for Padmiri to take notice and observe you for a moment.

When you&#39;re at the opposite side of her table, you push Claw&#39;s back towards Padmiri, bending her over in front of you.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Nnh.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check3 &gt; 12&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: passed.&lt;/span&gt;

Padmiri&#39;s mouth almost falls open when she meets Claw&#39;s subjugated head half a meter away from her, protesting and struggling. Her eyes meets yours for the shortest of seconds, but quickly hide under the scroll.

&lt;&lt;link [[Take Claw|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
fakPlayerTakesClaw();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: failed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Um, excuse me.&quot;//&lt;/span&gt;

Without much of a fight, the Leirien grabs the scroll and gets up from her chair. Claw and you watch her go without much trouble.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Are you happy now?&quot;//&lt;/span&gt; Claw rubs your defeat in your face, her chest still over the table. You clench her arm, despite her protest.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Shut up.&quot;//&lt;/span&gt;

//Not really what I had in mind.//

//&lt;span style=&quot;color:gray&quot;&gt;Your domination towards Padmiri has decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your sexual tension with Padmiri has decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your domination towards Claw has decreased.&lt;/span&gt;//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv -= 200;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv -= 150;
State.variables.chMir.relations.chPlayerCharacter.submission.stv -= 200;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv -= 150;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv -= 200;
State.variables.chClaw.relations.chPlayerCharacter.domination.stv -= 200;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="472" name="SE FAK Eat her out 2" tags="" position="8941,425" size="100,100">$customRoomIntro
Without any former notice, Claw stops dry, and gets out of Padmiri&#39;s legs. The Leirien girl&#39;s face gets torn between relief, desire and embarrassment.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...What... What was that for?&quot;//&lt;/span&gt; She says so meekly that you&#39;re almost unable to hear. Claw doesn&#39;t reply.

//Padmiri is getting nervous.//
//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Claw has grown very slightly.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Claw has grown very slightly.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 50;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 50;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 50;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 50;
State.variables.chMir.relations.chClaw.sexualTension.stv += 100;
State.variables.chClaw.relations.chMir.sexualTension.stv += 100;
State.variables.chMir.relations.chClaw.submission.stv += 100;
State.variables.chClaw.relations.chMir.domination.stv += 100;
State.variables.chMir.mood.aroused += 10;
State.variables.chMir.mood.submissive += 5;
State.variables.chClaw.mood.aroused += 5;
State.variables.chClaw.mood.dominant += 5;
State.variables.StVars.check1[2] = true;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE FAK Harassment options]]</tw-passagedata><tw-passagedata pid="473" name="SE FAK Moaning kitty 2" tags="" position="9053,427" size="100,100">$customRoomIntro
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Aah! Aah! Ah-nyaaah!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What was that?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Ah... What?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Did you just meowd?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;No, I didn&#39;t.&quot;//&lt;/span&gt;

You send an inquisitive glance towards Claw, fairly certain that your ears didn&#39;t lie to you.

//Regardless.//

You lean over to the corner of the shelf, peeking at the corridor where Padmiri is reading. She has moved the scroll even higher, completely hiding her face.

//Someone&#39;s embarrassed//, you think victoriously.

//Padmiri is getting nervous.//
//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Claw has grown very slightly.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Claw has grown very slightly.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
applyBarPercentualDamage(&quot;chMir&quot;,&quot;lust&quot;,0.05);
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 50;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 50;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 50;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 50;
State.variables.chMir.relations.chClaw.sexualTension.stv += 100;
State.variables.chMir.mood.aroused += 5;
State.variables.chClaw.mood.aroused += 5;
State.variables.chClaw.mood.dominant += 5;
State.variables.StVars.check1[3] = true;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE FAK Harassment options]]</tw-passagedata><tw-passagedata pid="474" name="SE FAK Padmiri Gives In" tags="" position="8716,427" size="100,100">$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Wait. Wait, please wait.&quot;//&lt;/span&gt;

The Leirien gets up, showing far more decision than she has ever had during the rest of the morning. Something in her mind has clicked.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Listen, I know what you&#39;re trying to do, and... You win. I&#39;m in.&quot;//&lt;/span&gt;

She slowly walks around the table, getting closer to you.

//She took the bait. Time to reel her in, but she could still get scared if I push her too much...//

[[Let&#39;s share Claw|SE FAK Sharing Claw]]
[[Padmiri has to submit as well|SE FAK Submitting Padmiri]]
[[Claw and you will use Padmiri|SE FAK Using Padmiri]]
&lt;&lt;if $StVars.check4[0] is false&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You can&#39;t equip a collar on Padmiri.
&lt;&lt;else&gt;&gt; \
[[You will lock a collar on her|SE FAK Lock collar]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check4[1] is false&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You can&#39;t equip a chastity belt on Padmiri.
&lt;&lt;else&gt;&gt; \
[[You will put a chastity belt on her|SE FAK Lock belt]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check4[2] is false&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; You can&#39;t equip a chastity cage on Padmiri.
&lt;&lt;else&gt;&gt; \
[[You will put a chastity cage on her|SE FAK Lock cage]]
&lt;&lt;/if&gt;&gt; \
[[She must become your servant|SE FAK Servant Padmiri]]</tw-passagedata><tw-passagedata pid="475" name="SE FAK Sharing Claw" tags="" position="8719,537" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Take a good look at my kitty.&quot;//&lt;/span&gt; You move your hand to your waist, only to briefly touch it and move it back towards Claw&#39;s hips. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She has such a bright skin, soft, appetizing... Are you lusting for her?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I-I am.&quot;//&lt;/span&gt; She admits, right after she gulps.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I wouldn&#39;t like to share her with someone who isn&#39;t that interested. Prove me your interest, with your lips.&quot;//&lt;/span&gt; You give a very soft spank to Claw&#39;s ass, showing Padmiri where she must head to. She obediently kneels, and moves her tongue through Claw&#39;s leg, then through her bottom, licking, tasting, kissing, almost as if she was trying to convince you that she hasn&#39;t had breakfast.

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri and Claw has grown very slightly.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri and Claw has grown very slightly.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chMir.relations.chClaw.sexualTension.stv += 50;
State.variables.chClaw.relations.chMir.sexualTension.stv += 50;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 50;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 50;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 50;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 50;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 50;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 50;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 50;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 50;
State.variables.chMir.mood.aroused += 5;
State.variables.chMir.mood.submissive += 5;
State.variables.chClaw.mood.aroused += 5;
State.variables.chClaw.mood.submissive += 5;
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Come, let&#39;s have her together.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue to scene|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
fakClawGetsShared(&quot;SE FAK Shared Claw&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \</tw-passagedata><tw-passagedata pid="476" name="SE FAK Submitting Padmiri" tags="" position="8831,538" size="100,100">$customRoomIntro
You get between Claw&#39;s vulnerable body and Padmiri, taking your hands to the Leirien&#39;s body.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Poor Mir, unable to contain her urges. She finds her two friends having some fun, and all of a sudden, her body makes her feel...&quot;//&lt;/span&gt; Your touch moves from the side of her torso, down to her abdomen, down to her lower belly, carrying her attention and desires. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Needy.&quot;//&lt;/span&gt;

She moves her eyes between your face and Claw&#39;s. //She wants to get started already.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Of course you can join our fun. You&#39;ll just have to be as obedient as her.&quot;//&lt;/span&gt; You move to the Leirien&#39;s side, giving her full view of Claw&#39;s body while you embrace her waist.

&lt;&lt;if $StVars.check3 &lt; 14&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: failed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Um.&quot;//&lt;/span&gt; She breaks your hug and quickly makes some distance. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;I think I just had a glimpse of clarity? I don&#39;t think I&#39;m that needy, after all.&quot;//&lt;/span&gt; She laughs and smiles, as if she didn&#39;t want to offend you for rejecting your demand for submission. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;But I-I appreciate the offer!&quot;//&lt;/span&gt; Barely giving you any time to reply, she runs off.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;And so your prey just ran away. I hate it when that happens.&quot;//&lt;/span&gt; Most unfortunately for Claw, she&#39;s in a great position for you to pay your frustration with her. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Aw!&quot;//&lt;/span&gt; She complains when she receives a sudden spank.

//&lt;span style=&quot;color:gray&quot;&gt;Your domination towards Padmiri has decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has slightly decreased.&lt;/span&gt;//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv -= 200;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 100;
State.variables.chMir.relations.chPlayerCharacter.submission.stv -= 200;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: passed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Do you want me to... Get right next to her?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That would be lovely.&quot;//&lt;/span&gt;

She doesn&#39;t take long to obey, and you find yourself with both a lovely Leirien and a fierce, yet somewhat tamed Beastkin bending over the table, offering themselves to you.

&lt;&lt;link [[Continue to scene|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
fakMirSubmits(&quot;SE FAK Submitted Mir&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="477" name="SE FAK Using Padmiri" tags="" position="8944,538" size="100,100">$customRoomIntro
You give a small clap to Claw&#39;s ass and signal her to get up, then approach Padmiri, taking your hands to the Leirien&#39;s body.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Poor Mir, unable to contain her urges. She finds her two friends having some fun, and all of a sudden, her body makes her feel...&quot;//&lt;/span&gt; Your touch moves from the side of her torso, down to her abdomen, down to her lower belly, carrying her attention and desires. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Needy.&quot;//&lt;/span&gt;

She moves her eyes between your face and Claw&#39;s. //She wants to get started already.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Of course you can join our fun. You&#39;ll just have to be obedient,&quot;//&lt;/span&gt; You move to the Leirien&#39;s side, putting her between you and your servant. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;to both of us.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check3 &lt; 16&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: failed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Um.&quot;//&lt;/span&gt; She breaks your hug and quickly makes some distance. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;I think I just had a glimpse of clarity? I don&#39;t think I&#39;m that needy, after all.&quot;//&lt;/span&gt; She laughs and smiles, as if she didn&#39;t want to offend you for rejecting your demand for submission. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;But I-I appreciate the offer!&quot;//&lt;/span&gt; Barely giving you any time to reply, she runs off.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;And so your prey just ran away. Just when I had started to like where this was going.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Damnit.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your domination towards Padmiri has decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has slightly decreased.&lt;/span&gt;//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv -= 200;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 100;
State.variables.chMir.relations.chPlayerCharacter.submission.stv -= 200;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: passed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Do you want me to submit to you both?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;re going to love it.&quot;//&lt;/span&gt; You get behind her, your hands envolving her hips, claiming them for yourself.

She gulps, expressing herself not with words, but with her compliance.

&lt;&lt;link [[Continue to scene|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
fakMirGetsShared(&quot;SE FAK Shared Mir&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="478" name="SE FAK Lock collar" tags="" position="9054,534" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Poor Mir, unable to contain her urges. She finds her two friends having some fun, and all of a sudden, her body makes her feel...&quot;//&lt;/span&gt; Your touch moves from the side of her torso, down to her abdomen, down to her lower belly, carrying her attention and desires. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Needy.&quot;//&lt;/span&gt;

She moves her eyes between your face and Claw&#39;s. //She wants to get started already.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I only have one small request from you.&quot;//&lt;/span&gt; You place a collar on the table next to you, the mere act already declaring your intentions. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wear this for me in your pretty neck.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check3 &lt; 18&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: failed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;My-my neck?&quot;//&lt;/span&gt; She breaks your hug and quickly makes some distance. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;I think I just had a glimpse of clarity? I don&#39;t think I&#39;m that needy, after all.&quot;//&lt;/span&gt; She laughs and smiles, as if she didn&#39;t want to offend you for rejecting your demand for submission. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;But I-I appreciate the offer!&quot;//&lt;/span&gt; Barely giving you any time to reply, she runs off.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;And so your prey just ran away. I hate it when that happens. You almost got her!&quot;//&lt;/span&gt; Most unfortunately for Claw, she&#39;s in a great position for you to pay your frustration with her. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Aw!&quot;//&lt;/span&gt; She complains when she receives a sudden spank.

//&lt;span style=&quot;color:gray&quot;&gt;Your domination towards Padmiri has decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has slightly decreased.&lt;/span&gt;//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv -= 200;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 100;
State.variables.chMir.relations.chPlayerCharacter.submission.stv -= 200;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: passed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You want to collar me?&quot;//&lt;/span&gt; She doesn&#39;t stutter, but her voice is crearly trembling.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I want you to be beautiful, for me.&quot;//&lt;/span&gt; Without waiting for her approval, you slowly move the piece of bondage along her back, right to the back of her neck. She gulps right before you lock it.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Delightful.&quot;//&lt;/span&gt; You kiss her neck, right above the collar. You can almost feel her shiver. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Let&#39;s get started.&quot;//&lt;/span&gt;

//You have equipped a collar on Padmiri.//
&lt;&lt;script&gt;&gt;
equipObjectOnWearer(State.variables.StVars.check4[0],&quot;chMir&quot;,State.variables.settings.equipmentDuration);
&lt;&lt;/script&gt;&gt; \

&lt;&lt;link [[Continue to scene|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
fakClawGetsShared(&quot;SE FAK Collared Mir&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="479" name="SE FAK Lock belt" tags="" position="9172,539" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Poor Mir, unable to contain her urges. She finds her two friends having some fun, and all of a sudden, her body makes her feel...&quot;//&lt;/span&gt; Your touch moves from the side of her torso, down to her abdomen, down to her lower belly, carrying her attention and desires. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Needy.&quot;//&lt;/span&gt;

She moves her eyes between your face and Claw&#39;s. //She wants to get started already.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I only have one small request from you.&quot;//&lt;/span&gt; You get closer to her ear, and demand with a very loud whisper: &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You will let me belt your pussy later.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check3 &lt; 20&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: failed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Uh? Uh? Uh?&quot;//&lt;/span&gt; She breaks your hug and quickly makes some distance. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;That is- I can&#39;t- I can&#39;t cross that line.&quot;//&lt;/span&gt; Her face has grown cold, and her expression, frigid. //I&#39;ve scared her too much?// &lt;span @style=$chMir.colorStyleKey&gt;//&quot;But I-I appreciate the offer! I guess. Bye!&quot;//&lt;/span&gt; Barely giving you any time to reply, she runs off.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;And so your prey just ran away. You can&#39;t blame her, you practically showed her the teeth that you were going to devour her with.&quot;//&lt;/span&gt; Most unfortunately for Claw, she&#39;s in a great position for you to pay your frustration with her. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Aw!&quot;//&lt;/span&gt; She complains when she receives a sudden spank.

//&lt;span style=&quot;color:gray&quot;&gt;Your domination towards Padmiri has decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has slightly decreased.&lt;/span&gt;//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv -= 200;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 100;
State.variables.chMir.relations.chPlayerCharacter.submission.stv -= 200;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: passed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I- But that- I can&#39;t-&quot;//&lt;/span&gt; Despite her words, she&#39;s frozen in place.

You finger her with confidence. It&#39;s overwhelmingly wet.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;This part of you seems to be a little more honest.&quot;//&lt;/span&gt; Her breathing finally abandons her, her face turning pale and frigid.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Let&#39;s take that for a yes, then.&quot;//&lt;/span&gt; Says Claw, who has left her position without your permission and has flanked Padmiri by the opposite side. You can&#39;t really be annoyed by her initiative.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Well done, Claw. Let&#39;s enjoy ourselves, will we?&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue to scene|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
fakMirGetsShared(&quot;SE FAK Belted Mir&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="480" name="SE FAK Lock cage" tags="" position="9172,427" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Poor Mir, unable to contain her urges. She finds her two friends having some fun, and all of a sudden, her body makes her feel...&quot;//&lt;/span&gt; Your touch moves from the side of her torso, down to her abdomen, down to her lower belly, carrying her attention and desires. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Needy.&quot;//&lt;/span&gt;

She moves her eyes between your face and Claw&#39;s. //She wants to get started already.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I only have one small request from you.&quot;//&lt;/span&gt; You place a chastity cage on the table next to you, the mere act already declaring your intentions. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You will wear this once we&#39;re done.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check3 &lt; 20&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: failed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Uh? Uh? Uh?&quot;//&lt;/span&gt; She breaks your hug and quickly makes some distance. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;That is- I can&#39;t- I can&#39;t cross that line.&quot;//&lt;/span&gt; Her face has grown cold, and her expression, frigid. //I&#39;ve scared her too much?// &lt;span @style=$chMir.colorStyleKey&gt;//&quot;But I-I appreciate the offer! I guess. Bye!&quot;//&lt;/span&gt; Barely giving you any time to reply, she runs off.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;And so your prey just ran away. You can&#39;t blame her, you practically showed her the teeth that you were going to devour her with.&quot;//&lt;/span&gt; Most unfortunately for Claw, she&#39;s in a great position for you to pay your frustration with her. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Aw!&quot;//&lt;/span&gt; She complains when she receives a sudden spank.

//&lt;span style=&quot;color:gray&quot;&gt;Your domination towards Padmiri has decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has slightly decreased.&lt;/span&gt;//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv -= 200;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 100;
State.variables.chMir.relations.chPlayerCharacter.submission.stv -= 200;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: passed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I- But that- I can&#39;t-&quot;//&lt;/span&gt; Despite her words, she&#39;s frozen in place.

You grab her penis with confidence. It&#39;s leaking precum.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Looks like your little friend thinks otherwise.&quot;//&lt;/span&gt; Her breathing finally abandons her, her face turning pale and frigid.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Let&#39;s take that for a yes, then.&quot;//&lt;/span&gt; Says Claw, who has left her position without your permission and has flanked Padmiri by the opposite side. You can&#39;t really be annoyed by her initiative.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Well done, Claw. Let&#39;s enjoy ourselves, shall we?&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue to scene|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
fakMirGetsShared(&quot;SE FAK Caged Mir&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="481" name="SE FAK Servant Padmiri" tags="" position="9282,205" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Take a good look at my kitty.&quot;//&lt;/span&gt; You move your hand to your waist, only to briefly touch it and move it back towards Claw&#39;s hips. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She has such a bright skin, soft, appetizing... Are you lusting for her?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I-I am.&quot;//&lt;/span&gt; She admits, right after she gulps.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I wouldn&#39;t like to share her with someone who isn&#39;t that interested though...&quot;//&lt;/span&gt; You move away from Claw and hug Mir from behing. You embrace her waist, and grab her chin, inviting her to keep looking at your servant. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;If you truly want her,&quot;//&lt;/span&gt; you whisper, &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Your wouldn&#39;t mind becoming mine for a few days.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check3 &lt; 24&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: failed.&lt;/span&gt;

After a few seconds, she suddenly gasps. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Uh? Did you just say I have to become yours?&quot;//&lt;/span&gt; She breaks your hug and quickly makes some distance. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;I- I have to refuse. That&#39;s a mean offer.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hmm. What a shame. To think that you were so close to get lost in her curves...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;No, and that&#39;s my final decision. If you can&#39;t accept that, we&#39;re done here.&quot;//&lt;/span&gt; And so she starts leaving.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Look at her, walking away. You can&#39;t blame her, you practically showed her the teeth that you were going to devour her with.&quot;//&lt;/span&gt; Most unfortunately for Claw, she&#39;s in a great position for you to pay your frustration with her. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Aw!&quot;//&lt;/span&gt; She complains when she receives a sudden spank.

//&lt;span style=&quot;color:gray&quot;&gt;Your domination towards Padmiri has decreased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has slightly decreased.&lt;/span&gt;//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv -= 200;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 100;
State.variables.chMir.relations.chPlayerCharacter.submission.stv -= 200;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 100;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Nervousness AND submission AND sexual tension AND pleasure drive MINUS enmity check: passed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I... Sure, why not.&quot;//&lt;/span&gt; She replies, possibly not completely aware of what&#39;s she&#39;s just accepted. You grab her left breast and right cheek.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wonderful. We&#39;re going to have so much fun.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue to scene|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
fakClawGetsShared(&quot;SE FAK Subdued Padmiri&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="482" name="SE FAK Shared Claw" tags="" position="8721,645" size="100,100">$customRoomIntro
After such a satisfying exercise, you get in the mood for some cuddling, so you get above Claw&#39;s back and embrace her completely. She barely has the strength to resist.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;See, Claw? It isn&#39;t so bad to be docile for a change.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Pray to the Goddess I don&#39;t show you the sa- Hmpf!&quot;//&lt;/span&gt; The retort meets your fingers, which enter Claw&#39;s mouth in a most casual way.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;No need to ruin such a nice moment.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I almost feel bad for taking advantage of her.&quot;//&lt;/span&gt; The tiger-girl turns her sight to the side, avoiding eye-contact.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She&#39;s actually satisfied with this, even if she&#39;s not willing to admit it. Shush, don&#39;t press your teeth!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What if this was for the best...?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hmm? Did you say something?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;No, it was nothing.&quot;//&lt;/span&gt; Says Padmiri, as she places her hand on Claw&#39;s hair, stroking it and patting her, much to the kitty&#39;s mental exhaustion.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri and Claw has slightly increased.&lt;/span&gt;
Padmiri&#39;s views have grown more favorable towards domination and pleasure.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 250;
State.variables.chMir.relations.chClaw.domination.stv += 250;
State.variables.chClaw.relations.chMir.submission.stv += 250;
State.variables.chClaw.relations.chMir.sexualTension.stv += 150;
State.variables.chMir.relations.chClaw.sexualTension.stv += 150;
addPointsToDrive(gC(&quot;chMir&quot;).dDomination,150);
addPointsToDrive(gC(&quot;chMir&quot;).dPleasure,150);
State.variables.chPlayerCharacter.lust.current = State.variables.chPlayerCharacter.lust.max;
State.variables.chMir.lust.current = State.variables.chMir.lust.max;
State.variables.chClaw.lust.current = State.variables.chClaw.lust.max;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="483" name="SE FAK Submitted Mir" tags="" position="8831,643" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hyaaa! I&#39;m spent.&quot;//&lt;/span&gt; You throw your back to the table, dragging the girls right towards you. Padmiri complies, Claw does too, but she soon turns around and gives you her back.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And I&#39;m certain you loved that too. I saw that face you were making.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You&#39;re not wrong...&quot;//&lt;/span&gt; Mir smiles timidly, trying not too hard to hide her feelings.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Then it&#39;s decided. We&#39;ll be repeating this soon.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;That will be IF I&#39;m still bound.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Look at you, clearly the most timid of the two.&quot;//&lt;/span&gt; You tease her, tickling her leg.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf!&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri and Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri and Claw has slightly increased.&lt;/span&gt;
Padmiri&#39;s views have grown more favorable towards pleasure.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 200;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 200;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 200;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 200;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 200;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 200;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 200;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 200;
State.variables.chClaw.relations.chMir.sexualTension.stv += 200;
State.variables.chMir.relations.chClaw.sexualTension.stv += 200;
addPointsToDrive(gC(&quot;chMir&quot;).dPleasure,100);
State.variables.chPlayerCharacter.lust.current = State.variables.chPlayerCharacter.lust.max;
State.variables.chMir.lust.current = State.variables.chMir.lust.max;
State.variables.chClaw.lust.current = State.variables.chClaw.lust.max;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="484" name="SE FAK Shared Mir" tags="" position="8943,643" size="100,100">$customRoomIntro
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I can&#39;t say I absolutely hated that.&quot;//&lt;/span&gt; The tiger-girl lays back on the table, wildly streching her arms.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Neither can she.&quot;//&lt;/span&gt; You claim, looking straight at Padmiri, who can&#39;t help but attempt to hide from your gaze.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I-I-Uh-I-&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Why don&#39;t you become mine as well? You could serve both me and Claw. Not only would she more docile,&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hiss.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You could also be quite happy with that ride.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I have to leave! I had to meet with... Someone!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You aren&#39;t going to finish the scroll either?&quot;//&lt;/span&gt;

Padmiri&#39;s response is to keep running away.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I have to admit, I like how you played your cards right there. It was almost... Like you were hunting her.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;If you weren&#39;t so stubborn, you could learn a couple of things from me. You could start by not giving me so much trouble for a couple of days, and pay some attention instead.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Not a chance.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It was worth the try.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your enmity with Claw has decreased.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri and Claw has slightly increased.&lt;/span&gt;
Claw&#39;s views have grown more favorable towards pleasure.
Padmiri&#39;s views have grown more favorable towards pleasure.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 200;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 200;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 200;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 200;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 200;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 200;
State.variables.chPlayerCharacter.relations.chClaw.friendship.stv += 200;
State.variables.chClaw.relations.chPlayerCharacter.friendship.stv += 200;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv -= 200;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv -= 200;
State.variables.chClaw.relations.chMir.sexualTension.stv += 200;
State.variables.chMir.relations.chClaw.sexualTension.stv += 200;
State.variables.chClaw.relations.chMir.domination.stv += 200;
State.variables.chMir.relations.chClaw.submission.stv += 200;
addPointsToDrive(gC(&quot;chMir&quot;).dPleasure,100);
addPointsToDrive(gC(&quot;chClaw&quot;).dPleasure,200);
State.variables.chPlayerCharacter.lust.current = State.variables.chPlayerCharacter.lust.max;
State.variables.chMir.lust.current = State.variables.chMir.lust.max;
State.variables.chClaw.lust.current = State.variables.chClaw.lust.max;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="485" name="SE FAK Collared Mir" tags="" position="9051,641" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hyaaa! That was great.&quot;//&lt;/span&gt; You say as you stretch your arms, turning your back to your companions. No one responds to you, and when you turn back, you find Padmiri snuggling, or even hiding, next to Claw&#39;s shoulder. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You suddenly grew timid?&quot;//&lt;/span&gt; You pull her by her collar to force her to face you.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;It... Was... Pretty good.&quot;//&lt;/span&gt; Is her meek response.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Did the collar choke the words in your throat?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I have to admit, you truly played her like a fiddle.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t be mean to our friend, Claw.&quot;//&lt;/span&gt; You pull Padmiri towards you, putting her head next to your neck. She welcomes the chance to hide her face. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She&#39;s a little too meek to be honest to her own desires, but luckily she has me to guide her through them.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;At least it&#39;s going to be fun to watch her melt in your presence.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri and Claw has slightly increased.&lt;/span&gt;
Padmiri&#39;s views have grown more favorable towards pleasure.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 200;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 200;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 200;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 200;
State.variables.chClaw.relations.chMir.domination.stv += 200;
State.variables.chMir.relations.chClaw.submission.stv += 200;
State.variables.chClaw.relations.chMir.sexualTension.stv += 150;
State.variables.chMir.relations.chClaw.sexualTension.stv += 150;
addPointsToDrive(gC(&quot;chMir&quot;).dPleasure,150);
State.variables.chPlayerCharacter.lust.current = State.variables.chPlayerCharacter.lust.max;
State.variables.chMir.lust.current = State.variables.chMir.lust.max;
State.variables.chClaw.lust.current = State.variables.chClaw.lust.max;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="486" name="SE FAK Caged Mir" tags="" position="9283,425" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hyaaa! That was great.&quot;//&lt;/span&gt; You say as you stretch your arms, turning your back to your companions. No one responds to you, and when you turn back, you find Padmiri snuggling, or even hiding, next to Claw&#39;s shoulder. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You suddenly grew timid?&quot;//&lt;/span&gt; You hug her from behind, making it very clear that she isn&#39;t going away. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We have something else to take care of.&quot;//&lt;/span&gt;

The Leirien girl hides her nethers behind her hands. Claw pulls them away, giving you access to her cock. 

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Good job. Now, this goes here and... Done. Your cute dick is in my hands now.&quot;//&lt;/span&gt; You declare, flaunting the key in your hands.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I didn&#39;t take you for someone so merciless, but I guess I can respect your determination. You truly played her like a fiddle.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t be mean to our friend, Claw.&quot;//&lt;/span&gt; You pull Padmiri towards you, putting her head next to your neck. She welcomes the chance to hide her face. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She&#39;s a little too meek to be honest to her own desires, but luckily she has me to guide her through them.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;At least it&#39;s going to be fun to watch her melt in your presence.&quot;//&lt;/span&gt;

//You have equipped a chastity cage on Padmiri.//
&lt;&lt;script&gt;&gt;
equipObjectOnWearer(State.variables.StVars.check4[2],&quot;chMir&quot;,State.variables.settings.equipmentDuration);
&lt;&lt;/script&gt;&gt; \

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri and Claw has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Claw has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity with Padmiri has slightly increased.&lt;/span&gt;
Padmiri&#39;s views have grown more favorable towards pleasure.
Claw&#39;s views have grown more favorable towards domination.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 200;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 200;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 100;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 100;
State.variables.chPlayerCharacter.relations.chMir.enmity.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.enmity.stv += 100;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 200;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 200;
State.variables.chClaw.relations.chMir.domination.stv += 200;
State.variables.chMir.relations.chClaw.submission.stv += 200;
State.variables.chClaw.relations.chMir.sexualTension.stv += 150;
State.variables.chMir.relations.chClaw.sexualTension.stv += 150;
addPointsToDrive(gC(&quot;chMir&quot;).dPleasure,100);
addPointsToDrive(gC(&quot;chClaw&quot;).dDomination,100);
State.variables.chPlayerCharacter.lust.current = State.variables.chPlayerCharacter.lust.max;
State.variables.chMir.lust.current = State.variables.chMir.lust.max;
State.variables.chClaw.lust.current = State.variables.chClaw.lust.max;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="487" name="SE FAK Belted Mir" tags="" position="9283,540" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hyaaa! That was great.&quot;//&lt;/span&gt; You say as you stretch your arms, turning your back to your companions. No one responds to you, and when you turn back, you find Padmiri snuggling, or even hiding, next to Claw&#39;s shoulder. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You suddenly grew timid?&quot;//&lt;/span&gt; You hug her from behind, making it very clear that she isn&#39;t going away. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We have something else to take care of.&quot;//&lt;/span&gt;

The Leirien girl hides her nethers behind her hands. Claw pulls them away, giving you access to her lower entrance. 

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Good job. Now, this goes here and... Done. Your pussy belongs to me now.&quot;//&lt;/span&gt; You declare, flaunting the key in your hands.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I didn&#39;t take you for someone so merciless, but I guess I can respect your determination. You truly played her like a fiddle.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Don&#39;t be mean to our friend, Claw.&quot;//&lt;/span&gt; You pull Padmiri towards you, putting her head next to your neck. She welcomes the chance to hide her face. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She&#39;s a little too meek to be honest to her own desires, but luckily she has me to guide her through them.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;At least it&#39;s going to be fun to watch her melt in your presence.&quot;//&lt;/span&gt;

//You have equipped a chastity belt on Padmiri.//
&lt;&lt;script&gt;&gt;
equipObjectOnWearer(State.variables.StVars.check4[1],&quot;chMir&quot;,State.variables.settings.equipmentDuration);
&lt;&lt;/script&gt;&gt; \

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri and Claw has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Claw has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity with Padmiri has slightly increased.&lt;/span&gt;
Padmiri&#39;s views have grown more favorable towards pleasure.
Claw&#39;s views have grown more favorable towards domination.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 200;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 200;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 100;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 100;
State.variables.chPlayerCharacter.relations.chMir.enmity.stv += 100;
State.variables.chMir.relations.chPlayerCharacter.enmity.stv += 100;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 200;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 200;
State.variables.chClaw.relations.chMir.domination.stv += 200;
State.variables.chMir.relations.chClaw.submission.stv += 200;
State.variables.chClaw.relations.chMir.sexualTension.stv += 150;
State.variables.chMir.relations.chClaw.sexualTension.stv += 150;
addPointsToDrive(gC(&quot;chMir&quot;).dPleasure,100);
addPointsToDrive(gC(&quot;chClaw&quot;).dDomination,100);
State.variables.chPlayerCharacter.lust.current = State.variables.chPlayerCharacter.lust.max;
State.variables.chMir.lust.current = State.variables.chMir.lust.max;
State.variables.chClaw.lust.current = State.variables.chClaw.lust.max;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="488" name="SE FAK Subdued Padmiri" tags="" position="9278,315" size="100,100">$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Wait, that was just a mistake, wasn&#39;t it?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Look at the birdbrain, suddenly having a glimpse of clarity!&quot;//&lt;/span&gt; Claw makes a most diplomatic observation.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;re just mad that I get with words what you can&#39;t get with your fists.&quot;//&lt;/span&gt; You hug the waists of both Padmiri and Claw. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You may as well enjoy yourself for a few days and pay attention to me. Perhaps you&#39;ll learn something.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Tsch! I admit you&#39;re good at those games you&#39;re playing. Just don&#39;t expect them to work on me.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I can&#39;t believe I said yes. What was I thinking?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Perhaps by tomorrow she will have fully grasped the situation.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Shush! Be nice to her, you will be spending some in your knees together later.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Pah.&quot;//&lt;/span&gt;

//Padmiri is now your servant.
&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Padmiri has grown.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri and Claw has slightly increased.&lt;/span&gt;//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
createRelTypeServitudeSub(&quot;chMir&quot;,&quot;chPlayerCharacter&quot;,State.variables.settings.relationshipsDuration);
createRelTypeServitudeDom(&quot;chPlayerCharacter&quot;,&quot;chMir&quot;,State.variables.settings.relationshipsDuration);
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 150;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 250;
State.variables.chClaw.relations.chMir.domination.stv += 100;
State.variables.chMir.relations.chClaw.submission.stv += 100;
State.variables.chClaw.relations.chMir.sexualTension.stv += 100;
State.variables.chMir.relations.chClaw.sexualTension.stv += 100;
State.variables.chPlayerCharacter.lust.current = State.variables.chPlayerCharacter.lust.max;
State.variables.chMir.lust.current = State.variables.chMir.lust.max;
State.variables.chClaw.lust.current = State.variables.chClaw.lust.max;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="489" name="SE ShunnedByHerOwn Start" tags="" position="2511,1277" size="100,100">$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;This is where your misdeeds end, foul villain! You claim to bring love and harmony, to be moved by the highest feelings one may hold, yet what is it what you&#39;ve brought? The greatest chaos, the biggest of pains, for what could the woman you claim to love be feeling if not pain!? Take a look at her!&quot;//&lt;/span&gt; The Red Knight finishes her spech with a grand wave, opening her arm in the direction of Lady Leaf.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I confess, I confess you speak the truth! For my heart is broken in half, yet how else could it be? I once thought I had all the answers, I once thought the puzzle of my life was solved, that I would spend the rest of my springs by your side. But who could keep such a conviction when my heart suffers such falls and tumbles? When the feelings I thought I&#39;d only hold for you are matched or even surpassed by a shooting star?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Lady Leaf, love of my life, light of my soul! We hear accusations of pain, accusations of blame, yet who is truly in guilt here? I&#39;m guilty of evoking your love and admiration, your affection and desire, yet it is only the Red Knight who has made those feelings blossom into sorrow and bad conscience. Rather than challenging me for your love, she has challenged you for your rue.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Stop, Blue Knight! For neither you nor her are to hold the blame. It is my fallible heart, my selfish soul, which has brought the both of you into this conflict, my indecision and my narcissism which deemed you both worthy of playing with your feelings. Curse me! For I deserve no one.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Blue Knight! The longer our struggle lives, the more my love - and perhaps even your love, if you&#39;re not just a lying scoundrel, will suffer. Let us end this!&quot;//&lt;/span&gt;

[[&quot;Raise your weapon! We&#39;ll fight till the last drop of blood!&quot;|SE ShunnedByHerOwn Weapons]]
[[&quot;Lady Leaf doesn&#39;t deserve my love, nor yours! Join me instead, Red Knight.&quot;|SE ShunnedByHerOwn Treason]]
[[&quot;There is only one sensible solution. Let&#39;s all be together!&quot;|SE ShunnedByHerOwn Threesome]]
[[&quot;Lady Leaf is already joined to me in fate, for I&#39;m with her child!&quot;|SE ShunnedByHerOwn Her Child]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="490" name="SE ShunnedByHerOwn Weapons" tags="" position="2619,1277" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Raise your weapon! We&#39;ll fight till the last drop of blood!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You&#39;re finally speaking my language.&quot;//&lt;/span&gt; The Red Knight suddenly abandons all her poise, and charges you with her wooden blade. The lightning flashes and loud clashes fill the battlefield. The time of the speeches has perished, the time of blood has been born.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Stop, stop at once, I tell you! My love doesn&#39;t deserve anyone&#39;s death!&quot;//&lt;/span&gt;

Yet the pleas and woes fly without response.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;A tragic fate awaits me, if one of my loved ones departs from this world. My weak, selfish heart wouldn&#39;t be able to take it, and thus, I choose to take my own life before any of you falls!&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check1 &gt; 0&gt;&gt; \
&lt;span style=&quot;color:yellow&quot;&gt;Nashillbyir relation check: $chPlayerCharacter.name.&lt;/span&gt;

They are ignored, even.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Um, hello? Won&#39;t any you valorous knight aid me in this time of sorrow?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Were you saying something?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;ll take my own life before any of you dies!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Can you not wait for a moment? We&#39;re sparring here.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yeah, Pad- Lady Leaf, this is pretty tense.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

[[Continue|SE ShunnedByHerOwn Weapons 2]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:yellow&quot;&gt;Nashillbyir relation check: Padmiri.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Ah? Cry not, my loved one, for I will accompany you in your...&quot;//&lt;/span&gt; The Red Knight parries a most diabolical slash. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Uf! I&#39;ll accompany you in your sorrow! Just give me a moment to finish this fight.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Can you not wait for a moment? We&#39;re about to finish. Any second now.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

[[Continue|SE ShunnedByHerOwn Weapons 2]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="491" name="SE ShunnedByHerOwn Treason" tags="" position="2726,1277" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Could it be? My feelings have surely blinded me, for those words reflect truth. Lady Leaf doesn&#39;t deserve my love, nor yours! It would be a most twisted fate if we clashed in blood when your soul and mine hold such beautiful feelings. Join me instead, Red Knight!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Ah? Wait, I didn&#39;t really mean-&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check1 &gt; 0&gt;&gt; \
&lt;span style=&quot;color:yellow&quot;&gt;Nashillbyir relation check: $chPlayerCharacter.name.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Blindness, indeed, has afflicted me as well! My mind was clouded by your gallantry and daringness, consumed by the notion of my loved one leaving me for someone who matched me in worth. Yet it was but a veil! A veil that prevented me from seeing that I, too, have nothing but admiration for you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Let a new era begin! An era where the Red Knight and the Blue Knight are joined in arms and warmth, in steel and sheets!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I didn&#39;t think that through.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Mir, don&#39;t get lost.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Ahem. Ah, such is the misfortune in which fate dares to drown me! In my indecision and my sorrow, my guilt and my laments, I couldn&#39;t let my heart choose one over another, and now no one would ever choose me.&quot;//&lt;/span&gt;

[[Continue|SE ShunnedByHerOwn Treason 2]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:yellow&quot;&gt;Nashillbyir relation check: Padmiri.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;The debauchery of the Blue Knight is made manifest! With kind, yet poisoned words she made her way into my beloved&#39;s chambers, yet the vermin&#39;s true feelings were so fleeting and fickle that she has no trouble in chasing one or another as soon as the opportunity presents itself! It breaks my heart to reveal this, my love, but you have been deceived by this ruffian.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Oh, Red Knight! What a fool I&#39;ve made of myself! Despite everything we&#39;ve shared, everything we&#39;ve gone through, I allowed myself to be led astray by sweetened lies! Would you ever forgive me?&quot;//&lt;/span&gt;

[[Continue|SE ShunnedByHerOwn Treason 2]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="492" name="SE ShunnedByHerOwn Threesome" tags="" position="2831,1274" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;A soul-devouring sorrow engulfs us, if this conflict continues we all will reach the end of a river of pain, with our hearts broken and our spirits struck down. There is only one sensible solution. Let&#39;s all be together!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...Huh?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;A daring proposal! In the face of jealousy and selfishness, let us double down in our gamble for love! Love not for two, but three! It may not be a path of roses, as we must first bury our mistrust, but won&#39;t our gain be threefold greater?&quot;//&lt;/span&gt;

The Red Knight doubts for a few seconds, her wooden blade high and ready for blood, but she gives in to the pressure and joins you both, lowering her weapon.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Our hearts have spoken, and love charges fiercely towards victory! I stand persuaded by your passion, Blue Knight, and I accept your proposal! Let us join together in a quest to make your dream come true!&quot;//&lt;/span&gt;

[[Continue|SE ShunnedByHerOwn Threesome 2]]</tw-passagedata><tw-passagedata pid="493" name="SE ShunnedByHerOwn Her Child" tags="" position="2936,1274" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m afraid that the unstoppable wind of life has already left you behind, Red Knight, for Lady Leaf is already joined to me in fate: I&#39;m with her child!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What!?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;No way! Um, ahem. We are then between diabolical crossroads, my sworn enemy. Fate has played us both, as I carry Lady Leaf&#39;s child as well!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You too!?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:yellow&quot;&gt;Padmiri relation check: ???žVxÃG4ù×TçE???&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You are so unfair! I have no idea what to do in this situation! Can you not make up something less far fetched?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You aren&#39;t going to have the chance to complain when we&#39;re on stage.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Then what I&#39;m supposed to do!? You&#39;ve led me to a dead end.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Isn&#39;t that the charm of the play, though? To find some way to get out of ridiculous situations?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;So what would YOU do then?&quot;//&lt;/span&gt;

[[Continue|SE ShunnedByHerOwn Her Child 2]]</tw-passagedata><tw-passagedata pid="494" name="SE ShunnedByHerOwn Weapons 2" tags="" position="2616,1382" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Then I will- Hmpff, pmff!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;It&#39;s the time for your repentance, you fools! Unable to see anywhere beyond your childish competition, I&#39;ll snatch your little green trophy right in front of your eyes!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What was that?&quot;//&lt;/span&gt; 

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Who are you, fiend!?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;m your bane and your perdition, I&#39;m the Avenger of the Perished! Ages ago, your parents killed mine, and laid waste to my peoples. Tomorrow, I will repopulate my lands, with your beloved!&quot;//&lt;/span&gt;

The Avenger of the Perished holds Lady Leaf&#39;s mouth shut, and gets her up her shoulder, ready to run away. With a bite, Lady Leaf manages to talk.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Violence deprived you of your life, Avenger of the Perished, but what will you solve with revenge? Hatred begets hat- Aw!&quot;//&lt;/span&gt; Lady Leaf&#39;s speech gets interrupted by a spank in her lower cheeks.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Shut up, you. What right do you have to moralize, you who inherited the vicious crimes of your parents!?&quot;//&lt;/span&gt;

[[Continue|SE ShunnedByHerOwn Enters Ate]]</tw-passagedata><tw-passagedata pid="495" name="SE ShunnedByHerOwn Treason 2" tags="" position="2722,1382" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Unfortunately for you, none of you will come back home with their beloved tonight, for I&#39;m taking the Red Knight!&quot;//&lt;/span&gt; A sinister figure has fallen upon the Red Knight. As you paid attention to Lady Leaf&#39;s speech, you failed to notice the ambush, and this new contender is now holding the other knight&#39;s arms tight on her back.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let go of me, perfidious fiend!&quot;//&lt;/span&gt; 

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And who might you be!?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;m your bane and your perdition, I&#39;m the Avenger of the Perished! Ages ago, your parents killed mine, and laid waste to my peoples. Tomorrow, I will repopulate my lands, with your beloved!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Curses be cast upon you, demon! Your name claims the morals of someone who seeks justice, yet what justice is that which you bring? To punish the innocent heirs of those who wronged you?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;That&#39;s right! You&#39;re just a foul villain!&quot;//&lt;/span&gt; The Red Knight struggles to break free, to no avail.

&lt;&lt;if $StVars.check1 &gt; 0&gt;&gt; \
&lt;span style=&quot;color:yellow&quot;&gt;Padmiri relation check: $chPlayerCharacter.name.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Such is the cruelty of fate, to send such a terrible monster to us! And yet, it does not bring such despair without another healthy dose of hope.&quot;//&lt;/span&gt; Lady Leaf walks towards you, and takes you by your hand. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;In my misery, at least my path is at last clear! I might lose the Red Knight tonight, but the Blue Knight will not allow me to grow lonely.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What do you mean you&#39;ll lose me!? Come to save me already!&quot;//&lt;/span&gt;
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:yellow&quot;&gt;Padmiri relation check: Nashillbyir.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Blue Knight! Let us cast our differences aside, and save the Red Knight from the perverse designs of this sad creature!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Today, righteousness will reign over misguided vengeance! Surrender now or face my might, Avenger of the Perished!&quot;//&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \

[[Continue|SE ShunnedByHerOwn Enters Ate]]</tw-passagedata><tw-passagedata pid="496" name="SE ShunnedByHerOwn Threesome 2" tags="" position="2829,1380" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
An abrupt strike falls upon you: a hand covers your mouth and another surrounds you from behind.
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;There shall be love for none tonight! Your plates are served, and there&#39;s only retribution in them!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And who are you, you who intrude in our happy resolution!?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;m your bane and your perdition, I&#39;m the Avenger of the Perished! Ages ago, your parents killed mine, and laid waste to my peoples. Tomorrow, I will repopulate my lands, with your beloved!&quot;//&lt;/span&gt; You shake around upon hearing about the fate that awaits you, but you can&#39;t manage to break free.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Curses be cast upon you, demon! Your name claims the morals of someone who seeks justice, yet what justice is that which you bring? To punish the innocent heirs of those who wronged you?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Don&#39;t you dare to speak to me of justice! The greatest of your troubles is to whom you will grant your heart, while my life has only ever been continued suffering since the moment I gained conscience. And what was my sin? To be born to the victims of your peoples!? On your justice I spit!&quot;//&lt;/span&gt;

[[Continue|SE ShunnedByHerOwn Enters Ate]]</tw-passagedata><tw-passagedata pid="497" name="SE ShunnedByHerOwn Her Child 2" tags="" position="2936,1379" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Lady Leaf won&#39;t be able to care for any of you, for she is with my child as well!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What!?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;As ridiculous as that is, at least it gets me out of this mess.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Who are you!?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;m your bane and your perdition, I&#39;m the Avenger of the Perished! Ages ago, your parents killed mine, and laid waste to my peoples. Today, I repopulate my lands, with your beloved!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What? But that is...&quot;//&lt;/span&gt;

The Avenger of the Perished locks her eyes on those of Lady Leaf, and she promptly backpedals.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Such is the truth! When I was torn between both of your loves, I learned of the suffering of the Avenger&#39;s peoples, and decided to dedicate my heart and body to her cause!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;How dare you!? How could you do this to me, to us!?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Yeah, don&#39;t you know how hard it is to be a single mother!? And you are leaving not one behind, but TWO!?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Uh, I, uh...&quot;//&lt;/span&gt;

[[Continue|SE ShunnedByHerOwn Enters Ate Alt]]</tw-passagedata><tw-passagedata pid="498" name="SE ShunnedByHerOwn Enters Ate" tags="" position="2511,1381" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chAte.colorStyleKey&gt;//&quot;What is going on here? Are you fighting?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;The horrible vicissitudes of love and violence! What will your role be in this our conflict?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;What are you talking about? Is someone on a challenge or not?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ate, we&#39;re practicing improvised theater for the Twisted Festival. If you enter the stage, you have to create a character and play their role.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Don&#39;t interrupt us if you don&#39;t know what you have to do! You have no idea how much work it was for me to get into character!&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;And how was I supposed to know that?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I didn&#39;t know what they were doing at first, but I caught up.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;It looked to me like you were fighting. You are being unfair.&quot;//&lt;/span&gt;

[[Continue|SE ShunnedByHerOwn Practice Ends]]</tw-passagedata><tw-passagedata pid="499" name="SE ShunnedByHerOwn Enters Ate Alt" tags="" position="2511,1490" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chAte.colorStyleKey&gt;//&quot;What is going on here? Are you fighting?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;The horrible vicissitudes of love and violence! What will your role be in this our conflict?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;What are you talking about? Is someone-&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It isn&#39;t just you the one who twists the fate of others, Lady Leaf! For she is with my child as well!&quot;//&lt;/span&gt; The Red Knight claims, taking the newcomer&#39;s arm.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...What?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And mine too, at the same time! You wouldn&#39;t believe what a crazy night it was!&quot;//&lt;/span&gt; You declare, taking the other arm of the newcomer.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Ok, look, you&#39;re crossing the line already. You can&#39;t just keep on making the plot more and more ridiculous.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What do you mean we can&#39;t? You&#39;ll have to force me.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Can someone explain to me what is going on?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ate, we&#39;re practicing improvised theater for the Twisted Festival. If you enter the stage, you have to create a character and play their role.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Don&#39;t interrupt us if you don&#39;t know what you have to do! You have no idea how much work it was for me to get into character!&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;And how was I supposed to know that?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I didn&#39;t know what they were doing at first, but I caught up.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;It looked to me like you were about to fight. You are being unfair.&quot;//&lt;/span&gt;

[[Continue|SE ShunnedByHerOwn Practice Ends]]</tw-passagedata><tw-passagedata pid="500" name="SE ShunnedByHerOwn Practice Ends" tags="" position="2618,1490" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \
The practice doesn&#39;t go swiftly after Maaterasu&#39;s interruption. She has trouble to decide on a character, to pick a role for it, and to perform it. Nashillbyir grows increasingly anxious and gives up completely. In the end, you decide to call it for a day.

//You have gained 500 charisma experience.
You have gained 500 empathy experience.//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;There&#39;s something I&#39;ve been wondering. Why would Valtan take the place of her tribe&#39;s Candidate, despite the consequences it would have for her?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

Your mind takes you back to the day when you found Valtan shapeshifting as Sillan in the lake. //Should I tell them...?//

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...I&#39;m not sure if it&#39;s my place to tell, but Valtan claims she did it for the sake of their original Candidate. She thought she had the responsability to protect her.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Huh? That&#39;s the same Valtan we&#39;re talking about?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Sounds to me like she fooled you like a child.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check5 &gt; 0&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Padmiri relation AND Valtan drives check: passed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I know it doesn&#39;t sound like her, but I&#39;d really like to believe her.&quot;//&lt;/span&gt; Padmiri stays silent for a moment, the group&#39;s attention still focused on her. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;The... Pushy Valtan, the Valtan who does whatever she wants, the... That clown who is always brewing trouble is real, but I want to believe that there&#39;s also a caring person behind it all. Even if she barely ever shows it.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

//The group&#39;s opinions have been influenced.//
&lt;&lt;script&gt;&gt;
gC(&quot;chNash&quot;).supsValLove += 2;
gC(&quot;chClaw&quot;).supsValLove += 3;
gC(&quot;chAte&quot;).supsValLove += 1;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Padmiri relation AND Valtan drives check: failed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;The truth is I&#39;d really like to believe her, I&#39;d like to think that there&#39;s a selfless person inside all of us, even if we don&#39;t always choose to listen to her, but...&quot;//&lt;/span&gt; Padmiri stays silent for a moment, the group&#39;s attention still focused on her. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;When I think about Valtan, it&#39;s hard for me to maintain that conviction.&quot;//&lt;/span&gt;

A heavy silence weights over everyone&#39;s shoulders.

//The group&#39;s opinions have been influenced.//
&lt;&lt;script&gt;&gt;
gC(&quot;chMir&quot;).relations.chVal.friendship.stv -= 750;
gC(&quot;chMir&quot;).relations.chVal.romance.stv -= 750;
gC(&quot;chMir&quot;).relations.chVal.enmity.stv += 750;
gC(&quot;chMir&quot;).relations.chVal.rivalry.stv += 750;
gC(&quot;chNash&quot;).supsValLove -= 2;
gC(&quot;chClaw&quot;).supsValLove -= 2;
gC(&quot;chAte&quot;).supsValLove -= 2;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;/if&gt;&gt; \

[[Support Valtan|SE ShunnedByHerOwn SupportValtansLove]]
[[Raise doubts over Valtan|SE ShunnedByHerOwn RejectValtansLove]]
[[Stay silent|SE ShunnedByHerOwn Shunned]]</tw-passagedata><tw-passagedata pid="501" name="SE ShunnedByHerOwn SupportValtansLove" tags="" position="2723,1488" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \
&lt;&lt;if $StVars.check6 &gt; 3&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Charisma AND empathy AND luck check: passed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think you&#39;re making a mistake.&quot;//&lt;/span&gt; You say, as you take a step forward. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Who&#39;s the Valtan you know? Pretty much a stranger. I know it might be harsh to say this, but do we really know each other all that much? We&#39;ve only been here for a few weeks.&quot;//&lt;/span&gt; You catch a glimpse of worry among some of the faces listening to you. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So who are we to say what kind of person is or isn&#39;t Valtan, over the few interactions we&#39;ve had with her for a few days? How do we know what kind of person was she with her tribe? With the people she cared about? With the people she loved? I cannot know for certain, but it&#39;s true that she risked a lot by coming here, and none of you would have betrayed your tribes on a whim. Whatever her reason was, I&#39;m sure it was a good one.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf.&quot;//&lt;/span&gt; Claw shows her discomfort with your opinion, but chooses not to argue.

//The group&#39;s opinions have been influenced by your stats.//
&lt;&lt;script&gt;&gt;
gC(&quot;chMir&quot;).supsValLove += State.variables.StVars.check6;
gC(&quot;chNash&quot;).supsValLove += State.variables.StVars.check6;
gC(&quot;chClaw&quot;).supsValLove += State.variables.StVars.check6;
gC(&quot;chAte&quot;).supsValLove += State.variables.StVars.check6;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:yellow&quot;&gt;Charisma AND empathy AND luck check: partial pass.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yeah, she&#39;s a renowned liar, so what?&quot;//&lt;/span&gt; You spout. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She can fool around us all she wants, but we didn&#39;t know about the consequences of her crime from her, we knew from Drishtya, so we know those consequences are real. Would any of you betray your tribe, your whole tribe? Despite knowing that they would shun you in doing so? Perhaps she&#39;s lying to us about having a very special someone back home, but we&#39;ll find out about it when we get there anyway - what we know is that she must have had a horribly important reason to do what she did, and we shouldn&#39;t take that lightly.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf.&quot;//&lt;/span&gt; Claw shows her discomfort with your opinion, but chooses not to argue.

//The group&#39;s opinions have been influenced by your stats.//
&lt;&lt;script&gt;&gt;
gC(&quot;chMir&quot;).supsValLove += State.variables.StVars.check6;
gC(&quot;chNash&quot;).supsValLove += State.variables.StVars.check6;
gC(&quot;chClaw&quot;).supsValLove += State.variables.StVars.check6;
gC(&quot;chAte&quot;).supsValLove += State.variables.StVars.check6;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $chNash.supsValLove &gt; 1&gt;&gt; \

&lt;span style=&quot;color:green&quot;&gt;Nash relation AND Nash&#39;s drives check: passed.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You know what? I don&#39;t care if she has lied to us or not. She lies to us, do we lose anything because of it? Nothing at all. But if she&#39;s been sincere just on this one thing, then I admire her courage. Risking getting exiled just for the sake of someone you love? Even if that choice breaks you two apart? That&#39;s amazing.&quot;//&lt;/span&gt;

//The group&#39;s opinions have been influenced.//
&lt;&lt;script&gt;&gt;
gC(&quot;chNash&quot;).relations.chVal.friendship.stv += 750;
gC(&quot;chMir&quot;).supsValLove += 1;
gC(&quot;chClaw&quot;).supsValLove += 1;
gC(&quot;chAte&quot;).supsValLove += 1;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;/if&gt;&gt; \

[[Continue|SE ShunnedByHerOwn Shunned]]</tw-passagedata><tw-passagedata pid="502" name="SE ShunnedByHerOwn RejectValtansLove" tags="" position="2829,1488" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \
&lt;&lt;if $StVars.check6 &gt; 3&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Charisma AND empathy AND luck check: passed.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Perhaps the lie isn&#39;t as obvious as we think.&quot;//&lt;/span&gt; You ponder, still trying to put in order the thoughts your mind is going through. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Perhaps she really had a special relationship with the original Shapeshifter Candidate - that would explain why she managed to convince her to go along with the plan. But that doesn&#39;t mean her reasons were honest and pure. Perhaps she would have been as equally hurt if the original Candidate had to come to the Temple as she would have been if she herself had to leave her own life behind, and in front of that choice, she simply decided she didn&#39;t like her own tribe all that much. If that were the case, what would be adding an extra lie to the pile, if that makes her look sympathetic to us?&quot;//&lt;/span&gt; The faces on everyone look hurt and gloomy, as if they were accepting a painful truth.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That&#39;s...&quot;//&lt;/span&gt; Padmiri&#39;s expression betrays her aching.

//The group&#39;s opinions have been influenced by your stats.//
&lt;&lt;script&gt;&gt;
gC(&quot;chNash&quot;).relations.chVal.friendship.stv -= 250;
gC(&quot;chMir&quot;).relations.chVal.friendship.stv -= 250;
gC(&quot;chClaw&quot;).relations.chVal.friendship.stv -= 250;
gC(&quot;chAte&quot;).relations.chVal.friendship.stv -= 250;
gC(&quot;chAte&quot;).relations.chVal.romance.stv -= 250;
gC(&quot;chClaw&quot;).relations.chVal.romance.stv -= 250;
gC(&quot;chMir&quot;).relations.chVal.romance.stv -= 250;
gC(&quot;chNash&quot;).relations.chVal.romance.stv -= 250;
gC(&quot;chMir&quot;).supsValLove -= State.variables.StVars.check6;
gC(&quot;chNash&quot;).supsValLove -= State.variables.StVars.check6;
gC(&quot;chClaw&quot;).supsValLove -= State.variables.StVars.check6;
gC(&quot;chAte&quot;).supsValLove -= State.variables.StVars.check6;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;if $chNash.supsValLove &gt; 1&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Nash relation AND Nash&#39;s drives check: passed.&lt;/span&gt;

Nashillbyir, however, doesn&#39;t look convinced.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You know what? I don&#39;t care if she has lied to us or not. She lies to us, do we lose anything because of it? Nothing at all. But if she&#39;s been sincere just on this one thing, then I admire her courage. Risking getting exiled just for the sake of someone you love? Even if that choice breaks you two apart? That&#39;s amazing.&quot;//&lt;/span&gt;

//The group&#39;s opinions have been influenced.//
&lt;&lt;script&gt;&gt;
gC(&quot;chNash&quot;).relations.chVal.friendship.stv += 750;
gC(&quot;chMir&quot;).supsValLove += 1;
gC(&quot;chClaw&quot;).supsValLove += 1;
gC(&quot;chAte&quot;).supsValLove += 1;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;/if&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:yellow&quot;&gt;Charisma AND empathy AND luck check: partial pass.&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I don&#39;t know why we&#39;re doubting over this. It&#39;s Valtan. She&#39;s lied to us at every opportunity she&#39;s had.&quot;//&lt;/span&gt; You say, as if it was the most obvious fact in the world. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;If she was willing to get on the bad side of her tribe, she must not have liked it there all that much. And one good day, the opportunity to get away from them, for the rest of her life, presents itself, you think she wouldn&#39;t take it? And what&#39;s adding one more lie to the pile, if that makes her look sympathetic to us?&quot;//&lt;/span&gt; The faces on everyone look hurt and gloomy, as if they were accepting a painful truth.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That&#39;s...&quot;//&lt;/span&gt; Padmiri&#39;s expression betrays her aching.

//The group&#39;s opinions have been influenced.//
&lt;&lt;script&gt;&gt;
gC(&quot;chNash&quot;).relations.chVal.friendship.stv -= 250;
gC(&quot;chMir&quot;).relations.chVal.friendship.stv -= 250;
gC(&quot;chClaw&quot;).relations.chVal.friendship.stv -= 250;
gC(&quot;chAte&quot;).relations.chVal.friendship.stv -= 250;
gC(&quot;chAte&quot;).relations.chVal.romance.stv -= 250;
gC(&quot;chClaw&quot;).relations.chVal.romance.stv -= 250;
gC(&quot;chMir&quot;).relations.chVal.romance.stv -= 250;
gC(&quot;chNash&quot;).relations.chVal.romance.stv -= 250;
gC(&quot;chMir&quot;).supsValLove -= State.variables.StVars.check6;
gC(&quot;chNash&quot;).supsValLove -= State.variables.StVars.check6;
gC(&quot;chClaw&quot;).supsValLove -= State.variables.StVars.check6;
gC(&quot;chAte&quot;).supsValLove -= State.variables.StVars.check6;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;if $chNash.supsValLove &gt; 1&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Nash relation AND Nash&#39;s drives check: passed.&lt;/span&gt;

Nashillbyir, however, doesn&#39;t look convinced.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You know what? I don&#39;t care if she has lied to us or not. She lies to us, do we lose anything because of it? Nothing at all. But if she&#39;s been sincere just on this one thing, then I admire her courage. Risking getting exiled just for the sake of someone you love? Even if that choice breaks you two apart? That&#39;s amazing.&quot;//&lt;/span&gt;

//The group&#39;s opinions have been influenced by your stats.//
&lt;&lt;script&gt;&gt;
gC(&quot;chNash&quot;).relations.chVal.friendship.stv += 750;
gC(&quot;chMir&quot;).supsValLove += 1;
gC(&quot;chClaw&quot;).supsValLove += 1;
gC(&quot;chAte&quot;).supsValLove += 1;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;/if&gt;&gt; \
&lt;&lt;/if&gt;&gt; \

[[Continue|SE ShunnedByHerOwn Shunned]]</tw-passagedata><tw-passagedata pid="503" name="SE ShunnedByHerOwn Shunned" tags="" position="2509,1598" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Regardless.&quot;//&lt;/span&gt; Maaterasu takes the floor. &lt;span @style=$chAte.colorStyleKey&gt;//&quot;We should also decide what to do regarding Valtan&#39;s position in her tribe.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What do you mean?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Valtan is the only Candidate who isn&#39;t supported by her tribe.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And... You think we might have the chance to influence that?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Yes.&quot;//&lt;/span&gt; She replies plainly.

&lt;&lt;if $StVars.check4 &lt; 1&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Claw relation and Claw&#39;s drives check: failed.&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Isn&#39;t it obvious?&quot;//&lt;/span&gt; Claw raises a palm, as if holding an invisible answer on it. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;We stay silent and watch. She should face the consequences of her actions, and we aren&#39;t her allies on this. A Candidate without the support of her tribe is a Candidate who is going to lose the competition, plain and simple. As things stand now, each of us only has four competitors, not five. Let&#39;s let things stay that way.&quot;//&lt;/span&gt;

//The group&#39;s opinions have been influenced.//
&lt;&lt;script&gt;&gt;
gC(&quot;chNash&quot;).supsValPardon -= 1;
gC(&quot;chMir&quot;).supsValPardon -= 1;
gC(&quot;chAte&quot;).supsValPardon -= 2;
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;It&#39;s not that simple.&quot;//&lt;/span&gt; Maaterasu argues back. &lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Claw relation and Claw&#39;s drives check: passed.&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;m... I&#39;m torn on this.&quot;//&lt;/span&gt; Such doubt isn&#39;t usual on Claw. Your attention is trapped. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;The answer should be obvious, right? A Candidate without the support of her tribe, is a Candidate who has lost the competition. As things stand right now, each of us only has four competitors, not five, but...&quot;//&lt;/span&gt; A brief silence interrupts the sentence. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I&#39;d be lying if I said it sits well with me to let her be shunned.&quot;//&lt;/span&gt;

//The group&#39;s opinions have been influenced.//
&lt;&lt;script&gt;&gt;
gC(&quot;chNash&quot;).supsValPardon += 1;
gC(&quot;chMir&quot;).supsValPardon += 2;
gC(&quot;chAte&quot;).supsValPardon += 1;
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Not only that.&quot;//&lt;/span&gt; Maaterasu adds. &lt;&lt;/if&gt;&gt; \
 &lt;span @style=$chAte.colorStyleKey&gt;//&quot;No matter who wins the competition, the current situation isn&#39;t positive for the Passion Temple, and neither is for us, as priestesses. The authority of the Temple is respected due to the trust each tribe places on their Candidate. A whole generation of a tribe who despises their Candidate is dangerous.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And a Candidate they didn&#39;t choose themselves, at that.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And one they wanted to put on trial, but couldn&#39;t.&quot;//&lt;/span&gt;

Everyone meditates in silence over the weight of the situation.

//The group&#39;s opinions have been influenced.//
&lt;&lt;script&gt;&gt;
gC(&quot;chNash&quot;).supsValPardon += 2;
gC(&quot;chMir&quot;).supsValPardon += 2;
&lt;&lt;/script&gt;&gt; \

[[We have to find the way to repair Valtan&#39;s image|SE ShunnedByHerOwn RepairHerImage]]
[[We may not have the chance to do anything, anyway|SE ShunnedByHerOwn NotAChance]]
[[We should let the Shapeshifters judge Valtan|SE ShunnedByHerOwn JudgeValtan]]</tw-passagedata><tw-passagedata pid="504" name="SE ShunnedByHerOwn RepairHerImage" tags="" position="2614,1598" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;
State.variables.StVarsList.push(&quot;repairValsImage&quot;);
&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We have to repair her image, then.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;And how do you plan on doing that?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We&#39;ll find out when we get there. We may not know how yet, but it&#39;s clear that this is our first responsability as priestesses-to-be.&quot;//&lt;/span&gt;

//The group&#39;s opinions have been influenced.//
&lt;&lt;script&gt;&gt;
gC(&quot;chClaw&quot;).supsValPardon += (State.variables.StVars.check6 * 0.5);
gC(&quot;chNash&quot;).supsValPardon += (State.variables.StVars.check6 * 0.5);
gC(&quot;chMir&quot;).supsValPardon += (State.variables.StVars.check6 * 0.5);
gC(&quot;chAte&quot;).supsValPardon += (State.variables.StVars.check6 * 0.5);
&lt;&lt;/script&gt;&gt; \

&lt;&lt;if $chMir.supsValPardon &gt; 1&gt;&gt; \
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;$chPlayerCharacter.name is right. Regardless of what we can actually achieve, it&#39;s clear what our job is. We can&#39;t give up before we even try.&quot;//&lt;/span&gt;
&lt;&lt;elseif $chNash.supsValPardon &gt; 1&gt;&gt; \
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Well said, $chPlayerCharacter.name! Sometimes you have to charge at problems head-on, or they&#39;ll run over you. I&#39;m sure we&#39;ll find a way.&quot;//&lt;/span&gt;
&lt;&lt;elseif $chAte.supsValPardon &gt; 1&gt;&gt; \
&lt;span @style=$chAte.colorStyleKey&gt;//&quot;It would be troublesome if we let the Temple get damaged because we put the competition first.&quot;//&lt;/span&gt;
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Group&#39;s opinions check: failed.&lt;/span&gt;

The others welcome your initiative with a tense silence. Self-doubt, personal frictions or even excessive ambition might stop them from following you in your quest.
&lt;&lt;/if&gt;&gt; \

[[Continue|SE ShunnedByHerOwn End]]</tw-passagedata><tw-passagedata pid="505" name="SE ShunnedByHerOwn NotAChance" tags="" position="2723,1598" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;
State.variables.StVarsList.push(&quot;undecidedValsImage&quot;);
&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We may not have the chance to do anything. We don&#39;t even know what&#39;s going on among the Shapeshifters.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;That doesn&#39;t change the fact that it&#39;s in the interest of the Temple to support Valtan.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Is it, really? What if getting our heads in this conflict makes them antagonize us as well? Perhaps they&#39;d be willing to support any Head Priestess other than Val, as long as they respect her.&quot;//&lt;/span&gt;
&lt;&lt;if $chMir.supsValPardon &lt; 1&gt;&gt; \

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I agree with that. We should play our cards safe.&quot;//&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $chClaw.supsValPardon &lt; 0&gt;&gt; \

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;It&#39;s pointless to risk everyone&#39;s reputation with the Shapeshifters for the sake of Valtan. Don&#39;t count on me for help.&quot;//&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $chAte.supsValPardon &gt; 1&gt;&gt; \

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;...It&#39;s still a mistake.&quot;//&lt;/span&gt; The Aiishen doesn&#39;t elaborate further.
&lt;&lt;/if&gt;&gt; \

[[Continue|SE ShunnedByHerOwn End]]</tw-passagedata><tw-passagedata pid="506" name="SE ShunnedByHerOwn JudgeValtan" tags="" position="2833,1596" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;
State.variables.StVarsList.push(&quot;judgeValsImage&quot;);
&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You know, I think our best bet is letting the Shapeshifters judge her.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What!?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It&#39;s not a wild idea. It&#39;s clear that the Shapeshifters must be angry about not being able to judge someone who has wronged them all, what&#39;s in for us to gain from that? Their resentment towards the Temple? If they actually got the chance to judge her, we could at least prevent them from feeling wronged by us as well.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;That&#39;s a terrible idea. They have already been deprived of that by Drishtya, if she backed down, her authority would be put in doubt.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It must already be in doubt.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...And what would happen to Val after that?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She can remain with us. Even if she&#39;s exiled from her tribe, she&#39;ll still be a priestess. I don&#39;t think anything would change for her - and I think she&#39;s already accepted that fate anyway.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

//The group&#39;s opinions have been influenced.//
&lt;&lt;script&gt;&gt;
gC(&quot;chClaw&quot;).supsValPardon -= (State.variables.StVars.check6 * 0.5);
gC(&quot;chNash&quot;).supsValPardon -= (State.variables.StVars.check6 * 0.5);
gC(&quot;chMir&quot;).supsValPardon -= (State.variables.StVars.check6 * 0.5);
gC(&quot;chAte&quot;).supsValPardon -= (State.variables.StVars.check6 * 0.5);
&lt;&lt;/script&gt;&gt; \
&lt;&lt;if $chAte.supsValPardon &gt; 1&gt;&gt; \

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;You&#39;re still wrong.&quot;//&lt;/span&gt; The Aiishen doesn&#39;t elaborate further.
&lt;&lt;/if&gt;&gt; \

[[Continue|SE ShunnedByHerOwn End]]</tw-passagedata><tw-passagedata pid="507" name="SE ShunnedByHerOwn End" tags="" position="2939,1596" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;In any case, I hope you don&#39;t mention that I explained what she told me. I thought you deserved to know in order to make up your minds, but...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You don&#39;t want her to know you betrayed her trust.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Can you not put it that way?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;It&#39;s still what happened, though.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Sigh. I admit it is. But I think my reasons were good. Please do it for me.&quot;//&lt;/span&gt;

Padmiri is met with silence for a response, but you don&#39;t think they will actually tell Valtan. Instead, the heavy athmosphere is caused by the fact that everyone is coming to terms with the weight of your discussion. //&quot;Can the Shapeshifters really lose their trust in the Passion Temple?&quot;// That question lingers in your mind.

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
State.variables.chNash.relations.chMir.friendship.stv -= 500;
State.variables.chNash.relations.chMir.enmity.stv += 500;
State.variables.chClaw.relations.chMir.friendship.stv -= 500;
State.variables.chClaw.relations.chMir.enmity.stv += 500;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="508" name="SE BoAw Start" tags="" position="8660,754" size="100,100">$customRoomIntro
The limbs of nature extend in all directions, a web of aether keeps the whole world connected. Your legs, folded over the grass, discover the almost indistinguishable tremors of the earth, as natural and common during your average day as the birds&#39; flapping of their wings-

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Would you be more careful!? You almost hit me!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Almost hit you? You were at least two meters away.&quot;//&lt;/span&gt;

//...//

The waters dance unperturbed by the chaos of the Valley. Except for the events taking place in their most immediate borders, nothing alters them, and they alter nothing, save for your submerged hands. The bottom of the lake-

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;If you&#39;re trying to get back at me, I told you I wasn&#39;t going to hit you! Put the staff away!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;If you don&#39;t want me to hit you, you can move somewhere else! This place doesn&#39;t belong to you!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You little-&quot;//&lt;/span&gt;

//.........//

Quiet flaming waves bathe your face, seducing the pores of your skin, and entering them. You can feel the light of the Sun cleansing your body in-

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You&#39;re going to complain about that? How about you leave yourself, if that annoyed you so much?&quot;//&lt;/span&gt;

[[Continue|SE BoAw OpenedEyes]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="509" name="SE BoAw OpenedEyes" tags="" position="8773,754" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;We aren&#39;t going to get much meditation done if this goes on.&quot;//&lt;/span&gt;

Padmiri&#39;s words give you the last push, and you decide to stop your training and open your eyes.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And why would it have to be ME the one who leaves? I was just doing my usual exercises, you&#39;re the one who started this whole fight.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Are you for real? Are you saying that right after you swung your weapon against me?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Do you think they&#39;re still angry at each other after their fight the other day?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Could be. I haven&#39;t heard of anything else that explains why they&#39;re acting like children.&quot;//&lt;/span&gt;

[[Complain to Padmiri|SE BoAw Complain]]
[[Ask Padmiri to get them tied up in vines|SE BoAw AskPadmiri]]
[[Confront Claw and Nash|SE BoAw Confrontation]]
[[Suggest to meditate somewhere else|SE BoAw SuggestToLeave]]</tw-passagedata><tw-passagedata pid="510" name="SE BoAw Complain" tags="" position="8656,870" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;They&#39;re so annoying. Couldn&#39;t they just take their fighting somewhere else?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Maybe they haven&#39;t noticed they&#39;re bothering us?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Would they even care?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...I&#39;d like to think they would.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your opinion of Claw and Nashillbyir has decreased.&lt;/span&gt;
Padmiri is growing annoyed.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chNash.friendship.stv -= 250;
State.variables.chPlayerCharacter.relations.chClaw.friendship.stv -= 250;
State.variables.chMir.relations.chNash.friendship.stv -= 250;
State.variables.chMir.relations.chClaw.friendship.stv -= 250;
State.variables.StVars.check8[0] = true;
State.variables.StVars.check1 += 3;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;if $StVars.check8[1] is false&gt;&gt; \
[[Ask Padmiri to get them tied up in vines|SE BoAw AskPadmiri]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already asked Padmiri for help.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check8[2] is false&gt;&gt; \
[[Confront Claw and Nash|SE BoAw Confrontation]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already confronted Claw and Nash.
&lt;&lt;/if&gt;&gt; \
[[Suggest to meditate somewhere else|SE BoAw SuggestToLeave]]</tw-passagedata><tw-passagedata pid="511" name="SE BoAw AskPadmiri" tags="" position="8771,870" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hey, Mir.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I was thinking...&quot;//&lt;/span&gt;

[[Order Padmiri to get them in vines|SE BoAw AskPadmiriOrder]]
[[Beg Padmiri to get them in vines|SE BoAw AskPadmiriBeg]]
&lt;&lt;if $StVars.check4 is false&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; $chPlayerCharacter.name cannot use hypnosis.
&lt;&lt;else&gt;&gt; \
[[Hypnotize Padmiri|SE BoAw AskPadmiriHypnosis]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;script&gt;&gt;
State.variables.StVars.check8[1] = true;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="512" name="SE BoAw Confrontation" tags="" position="8887,872" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Fine. Let&#39;s handle this head-on...&quot;//&lt;/span&gt; You walk towards the noisy duo, decided to put an end to this yourself.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hey, hello, in case you haven&#39;t noticed...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You are going to take that back!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Why should I? It&#39;s the truth.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Listen to me! You two...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Don&#39;t //&lt;/span&gt;&lt;span @style=$chClaw.colorStyleKey&gt;//get //&lt;/span&gt;&lt;span @style=$chNash.colorStyleKey&gt;//into //&lt;/span&gt;&lt;span @style=$chClaw.colorStyleKey&gt;//this!&quot;//&lt;/span&gt; They say in unison, mere seconds right before going back to attacking each other.

//...Diplomacy failed, then.//

//Padmiri is growing annoyed.//
&lt;&lt;script&gt;&gt;
State.variables.StVars.check8[2] = true;
State.variables.StVars.check1 += 6;
&lt;&lt;/script&gt;&gt; \

[[Join the discussion|SE BoAw EscalateDiscussion]]
&lt;&lt;if $StVars.check2 is false&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; $chPlayerCharacter.name cannot cast atherial bondage.
&lt;&lt;else&gt;&gt; \
[[Cast chains against them|SE BoAw AetherialChains]]
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check8[0] is false&gt;&gt; \
[[Complain to Padmiri|SE BoAw Complain]] &lt;span style=&quot;color:firebrick&quot;&gt;(This option will disable direct confrontation choices)&lt;/span&gt;
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already complained to Padmiri.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check8[1] is false&gt;&gt; \
[[Ask Padmiri to get them tied up in vines|SE BoAw AskPadmiri]] &lt;span style=&quot;color:firebrick&quot;&gt;(This option will disable direct confrontation choices)&lt;/span&gt;
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already asked Padmiri for help.
&lt;&lt;/if&gt;&gt; \
[[Suggest to meditate somewhere else|SE BoAw SuggestToLeave]]</tw-passagedata><tw-passagedata pid="513" name="SE BoAw SuggestToLeave" tags="" position="9001,872" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
Having decided you can do nothing else in here worth trying to improve your situtation, you finally give up.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ve had enough, let&#39;s leave to the forest.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check1 &lt; 10&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Drives AND annoyance check: failed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Seems like it&#39;s the best we can do. It&#39;s a pity, really, that they can&#39;t let go of such a petty quarrel.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your opinion of Claw and Nashillbyir has decreased.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity towards Claw and Nashillbyir has increased.&lt;/span&gt;
Padmiri&#39;s views have grown more favorable to ambition.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
addPointsToDrive(gC(&quot;chMir&quot;).dAmbition,100)
State.variables.chPlayerCharacter.relations.chNash.friendship.stv -= 250;
State.variables.chPlayerCharacter.relations.chClaw.friendship.stv -= 250;
State.variables.chMir.relations.chNash.friendship.stv -= 250;
State.variables.chMir.relations.chClaw.friendship.stv -= 250;
State.variables.chPlayerCharacter.relations.chNash.enmity.stv += 250;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv += 250;
State.variables.chMir.relations.chNash.enmity.stv += 250;
State.variables.chMir.relations.chClaw.enmity.stv += 250;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Drives AND annoyance check: passed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;No, wait... I&#39;ve made up my mind.&quot;//&lt;/span&gt; The Leirien Candidate replies as she gets up from her meditating position, getting closer to her quarreling peers.

[[Continue|SE BoAw PadmirisVines PadmiriLeads]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="514" name="SE BoAw AskPadmiriOrder" tags="" position="8656,989" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You have to get them trapped between vines, then we&#39;ll teach them a lesson.&quot;//&lt;/span&gt;

The Leirien fixates her eyes on you, intently listening.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;They&#39;re so enraptured with their discussion that they won&#39;t notice your attack until you&#39;re already tying up their feet. They won&#39;t see it coming.&quot;//&lt;/span&gt;

&lt;&lt;if ($StVars.check9 + $StVars.check1) &lt; 5&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Submission AND friendship AND romance AND drives AND annoyance MINUS enmity check: failed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;d rather not do that. Those two are trouble today, and I don&#39;t want to see myself getting dragged into it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And you&#39;re fine with them not letting you finish your training?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...It&#39;s just not worth the trouble.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has slightly decreased.&lt;/span&gt;
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 150;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 150;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;if $StVars.check8[0] is false&gt;&gt; \
[[Complain to Padmiri|SE BoAw Complain]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already complained to Padmiri.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check8[2] is false&gt;&gt; \
[[Confront Claw and Nash|SE BoAw Confrontation]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already confronted Claw and Nash.
&lt;&lt;/if&gt;&gt; \
[[Suggest to meditate somewhere else|SE BoAw SuggestToLeave]]
&lt;&lt;elseif ($StVars.check9 + $StVars.check1) &lt; 10&gt;&gt; \
&lt;span style=&quot;color:yellow&quot;&gt;Submission AND friendship AND romance AND drives AND annoyance MINUS enmity check: partial pass.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...I see your point, but...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You hesitate? You know you have good reasons to do it.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I know, but is it really worth the trouble?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;If you don&#39;t do it, you&#39;re declaring it&#39;s fine for them to step on you if they feel like it.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Um.&quot;//&lt;/span&gt; The Leirien&#39;s face shows discomfort, clearly disliking how you make her see herself, but she is still undecided.

//&lt;span style=&quot;color:purple&quot;&gt;Your dominance towards Padmiri has increased.&lt;/span&gt;
Padmiri is growing annoyed.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 250;
State.variables.StVars.check1 += 5;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;if $StVars.check8[0] is false&gt;&gt; \
[[Complain to Padmiri|SE BoAw Complain]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already complained to Padmiri.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check8[2] is false&gt;&gt; \
[[Confront Claw and Nash|SE BoAw Confrontation]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already confronted Claw and Nash.
&lt;&lt;/if&gt;&gt; \
[[Suggest to meditate somewhere else|SE BoAw SuggestToLeave]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Submission AND friendship AND romance AND drives AND annoyance MINUS enmity check: passed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...You&#39;re right. I can do it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You can, you must and you will. I&#39;ll protect you if anything goes wrong.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Fine, I&#39;ll count on you.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your dominance towards Padmiri has increased.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 250;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE BoAw PadmirisVines PlayerLeads]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="515" name="SE BoAw AskPadmiriBeg" tags="" position="8771,989" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Perhaps you could put them in their place? Please? For me?&quot;//&lt;/span&gt;

The Leirien blinks twice, a bit perplexed. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;You expect me to go against both of them on my own?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;They aren&#39;t paying attention to you. If you moved some vines around them they probably wouldn&#39;t notice until you got their feet tied up.&quot;//&lt;/span&gt;

&lt;&lt;if ($StVars.check10 + $StVars.check1) &lt; 5&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Domination AND friendship AND romance AND drives AND annoyance MINUS enmity check: failed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;d rather not do that. Those two are trouble today, and I don&#39;t want to see myself getting dragged into it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But... They won&#39;t let us finish our training.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...It&#39;s just not worth it.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has slightly decreased.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 150;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 150;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;if $StVars.check8[0] is false&gt;&gt; \
[[Complain to Padmiri|SE BoAw Complain]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already complained to Padmiri.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check8[2] is false&gt;&gt; \
[[Confront Claw and Nash|SE BoAw Confrontation]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already confronted Claw and Nash.
&lt;&lt;/if&gt;&gt; \
[[Suggest to meditate somewhere else|SE BoAw SuggestToLeave]]
&lt;&lt;elseif ($StVars.check9 + $StVars.check1) &lt; 10&gt;&gt; \
&lt;span style=&quot;color:yellow&quot;&gt;Domination AND friendship AND romance AND drives AND annoyance MINUS enmity check: partial pass.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Perhaps I could do it, but...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Please? We aren&#39;t going to get any training done at this rate.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I know, I know, but... It&#39;s not as easy to say it as it is to do it, ok? Give me some time.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has increased.&lt;/span&gt;
Padmiri is growing annoyed.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 250;
State.variables.StVars.check1 += 8;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;if $StVars.check8[0] is false&gt;&gt; \
[[Complain to Padmiri|SE BoAw Complain]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already complained to Padmiri.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check8[2] is false&gt;&gt; \
[[Confront Claw and Nash|SE BoAw Confrontation]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already confronted Claw and Nash.
&lt;&lt;/if&gt;&gt; \
[[Suggest to meditate somewhere else|SE BoAw SuggestToLeave]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Domination AND friendship AND romance AND drives AND annoyance MINUS enmity check: passed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;You know what? Perhaps I will do that. It isn&#39;t really my style, but perhaps this is the kind of situation that calls for it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I knew I could count on you! You&#39;re the best, Padmiri.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Hehe. Don&#39;t cheer me up so much, I haven&#39;t done anything yet.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has increased.&lt;/span&gt;//
//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has increased.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 250;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 250;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE BoAw PadmirisVines PadmiriLeads]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="516" name="SE BoAw AskPadmiriHypnosis" tags="" position="8886,985" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;This isn&#39;t fair, not fair at all, is it, Padmiri? Look at me.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Of course it isn&#39;t.&quot;//&lt;/span&gt; She replies, her eyes fixated on yours, and ready for the taking.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And that&#39;s why we&#39;re going to put an end to it. Follow my instructions and we&#39;ll teach those two to behave.&quot;//&lt;/span&gt;

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;if ($StVars.check5 + $StVars.check1) &lt; 6&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Charisma AND will AND romance AND Padmiri&#39;s submission AND Padmiri&#39;s drives AND annoyance MINUS enmity check: failed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Are you...?&quot;//&lt;/span&gt; Padmiri breaks the eye contact with you, covering her face. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Are you doing something to my head?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What do you mean? I have a plan to get them in their place, if you just...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Then you should have asked like any normal person.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has decreased.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity with Padmiri has increased.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 250;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 250;
State.variables.chPlayerCharacter.relations.chMir.enmity.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.enmity.stv += 250;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;if $StVars.check8[0] is false&gt;&gt; \
[[Complain to Padmiri|SE BoAw Complain]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already complained to Padmiri.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check8[2] is false&gt;&gt; \
[[Confront Claw and Nash|SE BoAw Confrontation]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already confronted Claw and Nash.
&lt;&lt;/if&gt;&gt; \
[[Suggest to meditate somewhere else|SE BoAw SuggestToLeave]]
&lt;&lt;elseif ($StVars.check9 + $StVars.check1) &lt; 11&gt;&gt; \
&lt;span style=&quot;color:yellow&quot;&gt;Charisma AND will AND romance AND Padmiri&#39;s submission AND Padmiri&#39;s drives AND annoyance MINUS enmity check: partial pass.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What is... Why does my head feel fuzzy...?&quot;//&lt;/span&gt; Padmiri breaks eye contact with you, taking a hand to her face.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Mir, focus, keep looking at me.&quot;//&lt;/span&gt; She obeys, but your grip on her mind is feeble.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Yes, I&#39;m listening.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;If you move your vines towards them, they won&#39;t even notice until you&#39;re already tying up their feet.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And why... But why would I do that...?&quot;//&lt;/span&gt; She attempts from time to time to stop looking at you, sometimes getting close.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Because they are being rude to us, remember? Get them tied up for me and I&#39;ll teach them to behave appropriately.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Perhaps... I should do that...&quot;//&lt;/span&gt;

//That didn&#39;t go as well as I wanted.//

//&lt;span style=&quot;color:purple&quot;&gt;Your dominance towards Padmiri has increased.&lt;/span&gt;
Padmiri is growing annoyed.//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 250;
State.variables.StVars.check1 += 10;
&lt;&lt;/script&gt;&gt; \

&lt;&lt;if $StVars.check8[0] is false&gt;&gt; \
[[Complain to Padmiri|SE BoAw Complain]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already complained to Padmiri.
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $StVars.check8[2] is false&gt;&gt; \
[[Confront Claw and Nash|SE BoAw Confrontation]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;Locked:&lt;/span&gt; Already confronted Claw and Nash.
&lt;&lt;/if&gt;&gt; \
[[Suggest to meditate somewhere else|SE BoAw SuggestToLeave]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Charisma AND will AND romance AND Padmiri&#39;s submission AND Padmiri&#39;s drives AND annoyance MINUS enmity check: passed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Your instructions...? What do you want me to do?&quot;//&lt;/span&gt; Your grip on her isn&#39;t tight, but she appears willing to listen to you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Move your vines towards them, and they won&#39;t even notice until you&#39;re already tying up their feet. When you&#39;re got them all wrapped up, hand them over to me and I&#39;ll teach them to be good girls.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Do you have to teach them to be good girls...? Why...?&quot;//&lt;/span&gt; She asks, her mind half-absent.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Because they&#39;re rude, and don&#39;t respect their friends, they don&#39;t respect you, or me. That&#39;s not how they should behave, right?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;No... They have to respect us. I&#39;ll go get them.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Good girl.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your dominance towards Padmiri has increased.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chMir.domination.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.submission.stv += 250;
&lt;&lt;/script&gt;&gt; \

[[Continue|SE BoAw PadmirisVines PlayerLeads]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="517" name="SE BoAw PadmirisVines PadmiriLeads" tags="" position="8771,1095" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;ve had it with you and your bullshit! If you won&#39;t be reasonable when I ask you to be...&quot;//&lt;/span&gt;
&lt;&lt;script&gt;&gt;
applyVinesBondageToChars([&quot;chNash&quot;,&quot;chClaw&quot;],4,1);
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Can you even get your legs to stop trembling? I was certain you were just about to run away crying.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Now you&#39;ve done it, take this...!&quot;//&lt;/span&gt;

But Claw doesn&#39;t take anything. When Nashillbyir is about to swing her left, she completely loses the balance, or rather, something pulls her feet back. By the time the astounded Claw has time to realize what&#39;s just happened, Padmiri&#39;s vines are pulling her feet away as well.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And now...&quot;//&lt;/span&gt;

But the vines don&#39;t stop there. They ensnare the feet of both girls, then their knees, and then their arms. When they start to shout, complaining and menacing, the plants block their mouths as well, acting as gags.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That should do it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Well done, Mir. Let&#39;s...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;No, I did all the work, and it&#39;s my call now. About you...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Grr.&quot;//&lt;/span&gt; &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hrmpf, prrfmh!&quot;//&lt;/span&gt; They manage to mumble.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;This will not do at all. You&#39;re free to have your differences, your disputes, to hate each other even, if you&#39;re too immature to find a way to establish peace. But if you reach the point where your fighting bothers the others, then you&#39;ll have crossed me.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check6 &lt; 4&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Padmiri&#39;s pleasure drive AND sexual tension check: failed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...And that&#39;s why you&#39;re going to spend the rest of the day in these things.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Mmp!?&quot;//&lt;/span&gt; &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hmpf!&quot;//&lt;/span&gt; &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Nngh!&quot;//&lt;/span&gt; &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Nnmpf, nnfmpf!&quot;//&lt;/span&gt; The duo trapped in bondage suddenly gets nervous.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I know it&#39;s perhaps a bit too excessive, but if I let you go now, you won&#39;t learn your lesson.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;re making a good call.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Ggrrmnphfg!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Now let us finish the meditation in peace, or I&#39;ll have to raise the stakes.&quot;//&lt;/span&gt;

//Padmiri&#39;s drives have grown more favorable towards cooperation, domination and ambition.
Nash&#39;s and Claw&#39;s drives have grown less favorable towards domination.
Padmiri&#39;s preferences have grown more favorable to bondage.//
//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has increased.&lt;/span&gt;//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
addPointsToDrive(gC(&quot;chMir&quot;).dCooperation,100);
addPointsToDrive(gC(&quot;chMir&quot;).dDomination,100);
addPointsToDrive(gC(&quot;chMir&quot;).dAmbition,100);
addPointsToDrive(gC(&quot;chNash&quot;).dDomination,-100);
addPointsToDrive(gC(&quot;chClaw&quot;).dDomination,-100);
gC(&quot;chMir&quot;).tastes.bondage.w += 65;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 250;
State.variables.chMir.relations.chNash.rivalry.stv += 150;
State.variables.chNash.relations.chMir.rivalry.stv += 150;
State.variables.chMir.relations.chClaw.rivalry.stv += 150;
State.variables.chClaw.relations.chMir.rivalry.stv += 150;
State.variables.chNash.relations.chMir.submission.stv += 750;
State.variables.chMir.relations.chNash.domination.stv += 750;
State.variables.chClaw.relations.chMir.submission.stv += 750;
State.variables.chMir.relations.chClaw.domination.stv += 750;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 150;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Padmiri&#39;s pleasure drive AND sexual tension check: passed.&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...And that&#39;s why I&#39;ll have to punish you. I didn&#39;t want it to come to this, but I don&#39;t think you&#39;re going to learn any other way than by teaching your body the consequences. $chPlayerCharacter.name, come here.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sure!&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
BoAwPairAbusesDuo(&quot;SE BoAw PairAbusesDuo&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="518" name="SE BoAw PadmirisVines PlayerLeads" tags="" position="8655,1099" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I&#39;ve had it with you and your bullshit! If you won&#39;t be reasonable when I ask you to be...&quot;//&lt;/span&gt;
&lt;&lt;script&gt;&gt;
applyVinesBondageToChars([&quot;chNash&quot;,&quot;chClaw&quot;],4,1);
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Can you even get your legs to stop trembling? I was certain you were just about to run away crying.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Now you&#39;ve done it, take this...!&quot;//&lt;/span&gt;

But Claw doesn&#39;t take anything. When Nashillbyir is about to swing her left, she completely loses the balance, or rather, something pulls her feet back. By the time the astounded Claw has time to realize what&#39;s just happened, Padmiri&#39;s vines are pulling her feet away as well.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And now...&quot;//&lt;/span&gt;

But the vines don&#39;t stop there. They ensnare the feet of both girls, then their knees, and then their arms. When they start to shout, complaining and menacing, the plants block their mouths as well, acting as gags.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That should do it.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Well done, Mir. Let me handle the rest. Hey, you two!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Grr.&quot;//&lt;/span&gt; &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hrmpf, prrfmh!&quot;//&lt;/span&gt; They manage to mumble.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;ve done it, you&#39;ve got in trouble. You had the chance to stop bothering your friends, who had wronged none of you, but did that stop you? Not at all! You put your little dispute above the needs of whoever else you could be bothering. And as punishment, now...&quot;//&lt;/span&gt;

[[You&#39;ll stay like that the whole day|SE BoAw PlayerChains FastEnd]]
&lt;&lt;link [[I&#39;m going to have my way with you|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
BoAwPlayerAbusesDuo(&quot;SE BoAw PlayerAbusesDuo&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Padmiri and I will have our way with you|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
BoAwPairAbusesDuo(&quot;SE BoAw PairAbusesDuo&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \</tw-passagedata><tw-passagedata pid="519" name="SE BoAw EscalateDiscussion" tags="" position="9000,982" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You know what!? You both are a pair of children!&quot;//&lt;/span&gt; For a few short seconds, you manage to tear some silence out of them.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Are you saying I&#39;m as much in fault as she is?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;That&#39;s my line.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes! You had a dispute a few days ago, there was a fight, someone won, someone lost, now get over it!&quot;//&lt;/span&gt;

No response. //Is that it? I convinced them?//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;How dare you!?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Have you just interrupted us just to berate us both?&quot;//&lt;/span&gt;

//Here we go again.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I have, and I&#39;d do it again! Why did you have to choose this exact place to have your stupid fight in? While there were other people trying to focus on their training? Do you have no-&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You too think I should leave!? You&#39;re also going that road!?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;If you were looking for a fight, you could have said so from the very beginning. Now you&#39;re going to... What is this?&quot;//&lt;/span&gt;

Both Claw and Nashillbyir lose a bit of their balance, then they fall completely. A few vines have trapped their ankles together, and further vines are heading towards their arms.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, Mir, you did it!&quot;//&lt;/span&gt;

[[Continue|SE BoAw Trapped Trio]]</tw-passagedata><tw-passagedata pid="520" name="SE BoAw AetherialChains" tags="" position="9109,873" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
Just as you move back some steps, both girls gladly go back to ignore you and fight each other, which is an optimal situation for your attack to still be surprising. You spend a fair amount of time concentrating, visualizing the aether, its form, its trayectory, its integrity - and you launch it.

&lt;&lt;if $StVars.check3 &lt; 59&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Intelligence AND will AND luck check: failed.&lt;/span&gt;

But both of your targets jump away, barely getting grazed. Their personal quarrels suddenly washed away, Claw crackles her knuckles, and Nashillbyir swings her staff: they both are now united against you. Not much longer after your eyes cross each other, they start charging, and so you start fleeing.

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;20 willpower.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 20;
&lt;&lt;/script&gt;&gt; \

//I&#39;m not getting away if these two are the ones chasing me!//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Ouch!&quot;//&lt;/span&gt; The Ashwalker complains after a sonorous &quot;plof&quot;: Padmiri has used vines to hinder their pursuit, but it isn&#39;t a foolproof solution.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Keep running! Let&#39;s just get out of here!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes!&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Claw and Nashillbyir has decreased.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your enmity towards Claw and Nashillbyir has increased.&lt;/span&gt;
Claw&#39;s and Nash&#39;s views have grown less favorable to cooperation.//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
addPointsToDrive(gC(&quot;chNash&quot;).dCooperation,-100);
addPointsToDrive(gC(&quot;chClaw&quot;).dCooperation,-100);
State.variables.chPlayerCharacter.relations.chNash.friendship.stv -= 250;
State.variables.chPlayerCharacter.relations.chClaw.friendship.stv -= 250;
State.variables.chMir.relations.chNash.friendship.stv -= 250;
State.variables.chMir.relations.chClaw.friendship.stv -= 250;
State.variables.chPlayerCharacter.relations.chNash.enmity.stv += 250;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv += 250;
State.variables.chMir.relations.chNash.enmity.stv += 250;
State.variables.chMir.relations.chClaw.enmity.stv += 250;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:yellow&quot;&gt;Intelligence AND will AND luck check: partial pass.&lt;/span&gt;

Both of your targets jump right away - but the chains still graze Nashillbyir, and they rotate around her, ensnaring her, until she&#39;s completely immobile. The Beastkin, however, evades the attack completely, and runs straight against you, ready to attack.

//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;10 willpower.&lt;/span&gt;//
&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= 10;
applyAetherialBondageToChars([&quot;chNash&quot;],4,1);
applyVinesBondageToChars([&quot;chClaw&quot;],4,1);
&lt;&lt;/script&gt;&gt; \

//Come to me, I&#39;ll-!//

But her charge doesn&#39;t get realized, for she gets hit, gripped and completely trapped by several vines.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Good job, Mir!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Don&#39;t mention it.&quot;//&lt;/span&gt;

[[Continue|SE BoAw PlayerChains]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="521" name="SE BoAw PlayerAbusesDuo" tags="" position="8806,1209" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m almost going to regret it if you behave from now on, I wouldn&#39;t like losing an excuse to punish you like this!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I, on the other hand, would pretty much prefer it if you lost that excuse.&quot;//&lt;/span&gt;

Your victims&#39; faces don&#39;t hide the fact that they completely agree.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;We can still meditate for a little while. Otherwise this all would have been for nothing.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Right, for nothing.&quot;//&lt;/span&gt;

//Padmiri&#39;s drives have grown more favorable towards cooperation and ambition, and less favorable towards pleasure.
Nash&#39;s and Claw&#39;s drives have grown less favorable towards domination.
Padmiri&#39;s preferences have grown more favorable to bondage.//
//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Nashillbyir and Claw has increased considerably.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir and Claw has increased.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Nashillbyir and Claw has increased slightly.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has slightly increased.&lt;/span&gt;//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
addPointsToDrive(gC(&quot;chMir&quot;).dCooperation,100);
addPointsToDrive(gC(&quot;chMir&quot;).dPleasure,-100);
addPointsToDrive(gC(&quot;chMir&quot;).dAmbition,100);
addPointsToDrive(gC(&quot;chNash&quot;).dDomination,-100);
addPointsToDrive(gC(&quot;chClaw&quot;).dDomination,-100);
gC(&quot;chMir&quot;).tastes.bondage.w += 65;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chNash.rivalry.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.rivalry.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 150;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chMir.relations.chNash.rivalry.stv += 150;
State.variables.chNash.relations.chMir.rivalry.stv += 150;
State.variables.chMir.relations.chClaw.rivalry.stv += 150;
State.variables.chClaw.relations.chMir.rivalry.stv += 150;
State.variables.chNash.relations.chMir.submission.stv += 500;
State.variables.chMir.relations.chNash.domination.stv += 500;
State.variables.chClaw.relations.chMir.submission.stv += 500;
State.variables.chMir.relations.chClaw.domination.stv += 500;
State.variables.chNash.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chNash.domination.stv += 500;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 500;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="522" name="SE BoAw PairAbusesDuo" tags="" position="8915,1210" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m almost going to regret it if you behave from now on, I wouldn&#39;t like losing an excuse to punish you like this!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I, on the other hand-&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I have the feeling you would regret it as well, actually.&quot;//&lt;/span&gt;

The bound Claw and Nash mumble and nod in agreement.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Everything I&#39;ve just done had the clear purpose of instilling good values among our friends.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Right...&quot;//&lt;/span&gt;

//Padmiri&#39;s drives have grown more favorable towards pleasure, domination and ambition.
Nash&#39;s and Claw&#39;s drives have grown less favorable towards domination.
Padmiri&#39;s preferences have grown far more favorable to bondage.//
//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Nashillbyir and Claw has increased considerably.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir and Claw has increased.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Nashillbyir and Claw has increased slightly.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has slightly increased.&lt;/span&gt;//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
addPointsToDrive(gC(&quot;chMir&quot;).dDomination,100);
addPointsToDrive(gC(&quot;chMir&quot;).dPleasure,100);
addPointsToDrive(gC(&quot;chMir&quot;).dAmbition,100);
addPointsToDrive(gC(&quot;chNash&quot;).dDomination,-100);
addPointsToDrive(gC(&quot;chClaw&quot;).dDomination,-100);
gC(&quot;chMir&quot;).tastes.bondage.w += 85;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 150;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chNash.rivalry.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.rivalry.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 150;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.relations.chClaw.sexualTension.stv += 250;
State.variables.chClaw.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chMir.relations.chNash.rivalry.stv += 150;
State.variables.chNash.relations.chMir.rivalry.stv += 150;
State.variables.chMir.relations.chClaw.rivalry.stv += 150;
State.variables.chClaw.relations.chMir.rivalry.stv += 150;
State.variables.chNash.relations.chMir.submission.stv += 500;
State.variables.chMir.relations.chNash.domination.stv += 500;
State.variables.chClaw.relations.chMir.submission.stv += 500;
State.variables.chMir.relations.chClaw.domination.stv += 500;
State.variables.chNash.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chNash.domination.stv += 500;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 500;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="523" name="SE BoAw Trapped Trio" tags="" position="8997,1097" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
But the world suddenly falls to the side - or rather, your body falls to the ground, and your celebration meets an abrupt end. Claw and Nash aren&#39;t the only ones getting trapped by Padmiri&#39;s vines.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Are you serious, $chPlayerCharacter.name!? Are you for real!?&quot;//&lt;/span&gt; The Leirien shouts angry. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;You claim you&#39;re going to stop them from causing a ruckus and you join them!?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What!? I was trying to get them to shut up!&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;By JOINING them in their shouting!?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That isn&#39;t- Brurrmbgh-&quot;//&lt;/span&gt; A few extra vines have now entered your mouth, and get a tight grip on your tongue. Padmiri stands above you, looking at you with disgust, and placing her foot in your stomach.

//Your arms, legs and mouth are now locked.//
&lt;&lt;script&gt;&gt;
State.variables.chMir.willpower.current -= 60;
applyVinesBondageToChars([&quot;chPlayerCharacter&quot;,&quot;chNash&quot;,&quot;chClaw&quot;],4,1);
&lt;&lt;/script&gt;&gt; \

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;In all honesty, I almost could understand them two having a pointless fight, but you had no reason to join- At all!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hmmppf!&quot;//&lt;/span&gt;

Your captor eyes both Claw and Nash. &lt;span @style=$chMir.colorStyleKey&gt;//&quot;Not that you&#39;re blameless here. You should be ashamed to consider your pointless argument important enough to disregard the fact that you were annoying your fellow Candidates. So you are all getting punished.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check7 &lt; 5&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Padmiri&#39;s pleasure drive AND sexual tension check: failed.&lt;/span&gt;

The vines strangling your arms and legs both get tighter, streching to form a few extra knots. You try pulling your arms and legs apart, but you only manage to graze a couple of ivies, hurting your skin. You aren&#39;t getting out of them on your own any time soon.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I hope you&#39;re far more sensible in the future.&quot;//&lt;/span&gt; Is her final message, before leaving you all behind, still bound and helpless.

//Padmiri&#39;s drives have grown more favorable towards domination and ambition.
Padmiri&#39;s preferences have grown far more favorable to bondage.//
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has increased a lot.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has decreased.&lt;/span&gt;

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
addPointsToDrive(gC(&quot;chMir&quot;).dDomination,250);
addPointsToDrive(gC(&quot;chMir&quot;).dAmbition,250);
gC(&quot;chMir&quot;).tastes.bondage.w += 85;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 250;
State.variables.chNash.relations.chMir.friendship.stv -= 250;
State.variables.chClaw.relations.chMir.friendship.stv -= 250;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 250;
State.variables.chMir.relations.chNash.friendship.stv -= 250;
State.variables.chMir.relations.chClaw.friendship.stv -= 250;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 750;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 750;
State.variables.chNash.relations.chMir.submission.stv += 750;
State.variables.chMir.relations.chNash.domination.stv += 750;
State.variables.chClaw.relations.chMir.submission.stv += 750;
State.variables.chMir.relations.chClaw.domination.stv += 750;
&lt;&lt;/script&gt;&gt; \
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Padmiri&#39;s pleasure drive AND sexual tension check: passed.&lt;/span&gt;

The vines strangling your limbs increase their grip on you, trapping you harder, and forcing you to lie on your back, with your legs open.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;A punishment that you won&#39;t forget too soon.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue to scene|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
BoAwPadmiriAbusesTrio();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="524" name="SE BoAw Trapped Trio PostSex" tags="" position="9030,1204" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That was good... That was pretty good... I mean, I hope you learned your lesson.&quot;//&lt;/span&gt;

You move your itchy legs, anxious for pleasure after seeing it get taken and dispensed beyond your control.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hmmf, hmm, hmpf, mpff.&quot;//&lt;/span&gt; While none of her noises actually form any words, Nash&#39;s annoyed expression gives enough context to understand their meaning. After Mir waves a hand in an abrupt move, a lone vine strikes at Nash&#39;s butt.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Nash, watch your language.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Pfff.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;m going to leave you like that for the rest of the day. It may sound a bit harsh, but hopefully it will help you reflect on your actions.&quot;//&lt;/span&gt;

//Padmiri&#39;s drives have grown more favorable towards pleasure, domination and ambition.
Padmiri&#39;s preferences have grown far more favorable to bondage.//
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Padmiri has increased a lot.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Padmiri has increased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your friendship with Padmiri has decreased.&lt;/span&gt;

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
addPointsToDrive(gC(&quot;chMir&quot;).dDomination,250);
addPointsToDrive(gC(&quot;chMir&quot;).dAmbition,250);
gC(&quot;chMir&quot;).tastes.bondage.w += 85;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv -= 250;
State.variables.chNash.relations.chMir.friendship.stv -= 250;
State.variables.chClaw.relations.chMir.friendship.stv -= 250;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv -= 250;
State.variables.chMir.relations.chNash.friendship.stv -= 250;
State.variables.chMir.relations.chClaw.friendship.stv -= 250;
State.variables.chPlayerCharacter.relations.chMir.submission.stv += 750;
State.variables.chMir.relations.chPlayerCharacter.domination.stv += 750;
State.variables.chNash.relations.chMir.submission.stv += 750;
State.variables.chMir.relations.chNash.domination.stv += 750;
State.variables.chClaw.relations.chMir.submission.stv += 750;
State.variables.chMir.relations.chClaw.domination.stv += 750;
State.variables.chPlayerCharacter.relations.chMir.sexualTension.stv += 250;
State.variables.chNash.relations.chMir.sexualTension.stv += 250;
State.variables.chClaw.relations.chMir.sexualTension.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chMir.relations.chNash.sexualTension.stv += 250;
State.variables.chMir.relations.chClaw.sexualTension.stv += 250;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="525" name="SE BoAw PlayerChains" tags="" position="9108,982" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Screw off, this isn&#39;t your fight.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Oh, right, I was missing something.&quot;//&lt;/span&gt;

You form some more solidified aether, and tie it up around Nash&#39;s mouth, gagging her.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Much better now.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Frfncg ryfuf!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We normally wouldn&#39;t care about you two being unable to behave around each other, but if you can&#39;t respect everyone else around you, we&#39;ll have to take matters into our own hands.&quot;//&lt;/span&gt;

Claw and Nash look at you, no longer attempting to make any noise, but the intent to murder you with their eyes is crystal clear.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And that&#39;s why...&quot;//&lt;/span&gt;

[[You&#39;ll stay like that the whole day|SE BoAw PlayerChains FastEnd]]
&lt;&lt;link [[I&#39;m going to have my way with you|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
BoAwPlayerAbusesDuo(&quot;SE BoAw PlayerAbusesDuo&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Padmiri and I will have our way with you, as punishment|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
BoAwPairAbusesDuo(&quot;SE BoAw PairAbusesDuo&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt; \</tw-passagedata><tw-passagedata pid="526" name="SE BoAw PlayerChains FastEnd" tags="" position="9108,1095" size="100,100">&lt;&lt;script&gt;&gt;
setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;ll stay like that the whole day.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmmpff!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What do you expect to achieve that way? It&#39;s not like you&#39;re going to persuade me while you can&#39;t talk.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;The whole day may be somewhat excessive.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Maybe, but that will make it a better lesson as well.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...I have to admit, it feels nice not to hear their shouts anymore. Should we continue our meditation?&quot;//&lt;/span&gt;

//Padmiri&#39;s drives have grown more favorable towards cooperation, domination and ambition.
Nash&#39;s and Claw&#39;s drives have grown less favorable towards domination.
Padmiri&#39;s preferences have grown more favorable to bondage.//
//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Nashillbyir and Claw has increased considerably.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Nashillbyir and Claw has increased slightly.&lt;/span&gt;
&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Padmiri has slightly increased.&lt;/span&gt;//

$eventsCalendar.finishEventButton
&lt;&lt;script&gt;&gt;
addPointsToDrive(gC(&quot;chMir&quot;).dCooperation,100);
addPointsToDrive(gC(&quot;chMir&quot;).dDomination,100);
addPointsToDrive(gC(&quot;chMir&quot;).dAmbition,100);
addPointsToDrive(gC(&quot;chNash&quot;).dDomination,-100);
addPointsToDrive(gC(&quot;chClaw&quot;).dDomination,-100);
gC(&quot;chMir&quot;).tastes.bondage.w += 65;
State.variables.chPlayerCharacter.relations.chMir.friendship.stv += 250;
State.variables.chMir.relations.chPlayerCharacter.friendship.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.rivalry.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.rivalry.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 150;
State.variables.chMir.relations.chNash.rivalry.stv += 150;
State.variables.chNash.relations.chMir.rivalry.stv += 150;
State.variables.chMir.relations.chClaw.rivalry.stv += 150;
State.variables.chClaw.relations.chMir.rivalry.stv += 150;
State.variables.chNash.relations.chMir.submission.stv += 500;
State.variables.chMir.relations.chNash.domination.stv += 500;
State.variables.chClaw.relations.chMir.submission.stv += 500;
State.variables.chMir.relations.chClaw.domination.stv += 500;
State.variables.chNash.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chNash.domination.stv += 500;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 500;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 500;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="527" name="More quickstarts 1" tags="" position="1993,200" size="100,100">&lt;&lt;link [[SE Gleaming Caverns Overview|SE Gleaming Caverns Overview Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
initializeGleamingCavernsOverview();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[SE The Grapes of Lust|SE TGoL Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
initializeSeTGoL();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[SE The Grapes of Lust More charisma|SE TGoL Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.charisma.value = 24;
State.variables.chVal.lust.current = 1;
initializeSeTGoL();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[SE Post Adventure Placeholder|SE Post Adventure Placeholder]]&gt;&gt;&lt;&lt;script&gt;&gt;
initializePostAdventurePlaceholder();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[SE Martial Tutorship I|SE MartialTutorshipI Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
initializeMartialTutorshipI();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[SE Martial Tutorship I WithStaff|SE MartialTutorshipI Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
createEquipment(&quot;w0&quot;,&quot;chPlayerCharacter&quot;);
equipObjectOnWearer(1,&quot;chPlayerCharacter&quot;,2);
initializeMartialTutorshipI();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[SE Martial Tutorship I WithOtherWeapon|SE MartialTutorshipI Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.physique.value = 20;
State.variables.chPlayerCharacter.agility.value = 20;
State.variables.chPlayerCharacter.resilience.value = 20;
State.variables.chPlayerCharacter.perception.value = 20;
createEquipment(&quot;w1&quot;,&quot;chPlayerCharacter&quot;);
equipObjectOnWearer(1,&quot;chPlayerCharacter&quot;,2);
initializeMartialTutorshipI();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Flaunting A Kitty|SE FAK Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
initializeSeFaK();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Flaunting A Kitty Extra Relationships|SE FAK Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chMir.relations.chPlayerCharacter.submission.level = 10;
initializeSeFaK();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Flaunting A Kitty Extra Bondage|SE FAK Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chMir.relations.chPlayerCharacter.submission.level = 25;
initializeSeFaK();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Flaunting A Kitty Mir Gives In Low sub|SE FAK Padmiri Gives In]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chMir.relations.chPlayerCharacter.submission.level = 10;
initializeSeFaK();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Flaunting A Kitty Mir Gives In Extra Bondage Low sub|SE FAK Padmiri Gives In]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chMir.relations.chPlayerCharacter.submission.level = 9;
createEquipment(&quot;b0&quot;,&quot;chPlayerCharacter&quot;);
createEquipment(&quot;b7&quot;,&quot;chPlayerCharacter&quot;);
createEquipment(&quot;b8&quot;,&quot;chPlayerCharacter&quot;);
initializeSeFaK();
seFaKupdatePadmiriSubmissionScore();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Flaunting A Kitty Mir Gives In Extra Bondage High sub|SE FAK Padmiri Gives In]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chMir.relations.chPlayerCharacter.submission.level = 25;
createEquipment(&quot;b0&quot;,&quot;chPlayerCharacter&quot;);
createEquipment(&quot;b7&quot;,&quot;chPlayerCharacter&quot;);
createEquipment(&quot;b8&quot;,&quot;chPlayerCharacter&quot;);
gC(&quot;chMir&quot;).addBodypart(&quot;dick&quot;,&quot;dick&quot;);
initializeSeFaK();
seFaKupdatePadmiriSubmissionScore();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Shunned By Her Own Stats 1|SE ShunnedByHerOwn Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chNash.relations.chPlayerCharacter.romance.level = 10;
initializeShunnedByHerOwn();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Shunned By Her Own Stats 2|SE ShunnedByHerOwn Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chNash.relations.chMir.romance.level = 10;
State.variables.chPlayerCharacter.charisma.value = 70;
State.variables.chNash.relations.chVal.friendship.level = 7;
initializeShunnedByHerOwn();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Bondage Awakening|SE BoAw Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
initializeBondageAwakening();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Bondage Awakening Stats+|SE BoAw Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
initializeBondageAwakening();
State.variables.StVars.check1 += 7;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Bondage Awakening Stats++|SE BoAw Start]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chMir.relations.chNash.sexualTension.level = 10;
State.variables.chPlayerCharacter.will.value = 50;
initializeBondageAwakening();
State.variables.StVars.check1 += 20;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
</tw-passagedata><tw-passagedata pid="528" name="First Adventure Tests" tags="" position="1786,425" size="100,100">&lt;&lt;link [[Flying Lookout|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
var mon0 = createFlyingLookout(2,0,1);
var mon1 = createFlyingLookout(2,0,2);
State.variables.sc.startScene(
	&quot;bs&quot;,&quot;fixed&quot;,[&quot;chPlayerCharacter&quot;,&quot;chNash&quot;],[mon0,mon1],&quot;__Field__\nThis is the clearest area in the training grounds. You&#39;re guaranteed to find a spot in which you can unleash hellflames without destroying anything.&quot;,createEndConditionStoryBattleWithDraw(&quot;Quickstarts&quot;,&quot;Quickstarts&quot;,&quot;Quickstarts&quot;),6,
	&quot;SE BKIF Player Victory&quot;);
	gC(&quot;chNash&quot;).aiAlgorythm = createAiEarlyStrategic();
	gC(mon0).aiAlgorythm = createAiEarlyStrategic();
	gC(mon1).aiAlgorythm = createAiEarlyStrategic();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Essence-sucker|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
var mon0 = createEssenceSucker(1,0,1);
var mon1 = createEssenceSucker(1,0,2);
State.variables.sc.startScene(
	&quot;bs&quot;,&quot;fixed&quot;,[&quot;chPlayerCharacter&quot;,&quot;chNash&quot;],[mon0,mon1],&quot;__Field__\nThis is the clearest area in the training grounds. You&#39;re guaranteed to find a spot in which you can unleash hellflames without destroying anything.&quot;,createEndConditionStoryBattleWithDraw(&quot;Quickstarts&quot;,&quot;Quickstarts&quot;,&quot;Quickstarts&quot;),6,
	&quot;SE BKIF Player Victory&quot;);
	gC(&quot;chNash&quot;).aiAlgorythm = createAiEarlyStrategic();
	gC(mon0).aiAlgorythm = createAiEarlyStrategic();
	gC(mon1).aiAlgorythm = createAiEarlyStrategic();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;script&gt;&gt;
charactersLearnSceneActions([&quot;chPlayerCharacter&quot;],returnBaList());
&lt;&lt;/script&gt;&gt;</tw-passagedata><tw-passagedata pid="529" name="FA ReachedTheSwamp Start" tags="" position="3085,1180" size="100,100">$customRoomIntro
//A power granted by the Goddess to vanquish monsters.//

Despite being in a new, unknown world, your mind drifts back to a couple of days ago. Before leaving the Passion Temple to meet the Shapeshifter tribe, Drishtya taught you all a new technique to protect yourselves against monsters. By entrusting yourself to the Goddess, you were able to draw her power to unleash raw, unaltered energy.

The price, however, still undermines your self-confidence.

//Why would the Goddess ask for such a painful sacrifice to protect ourselves from monsters...?//

As soon as you casted the new technique, your flesh burned as if it was submerged in heated ashes. You proved masterful technique right on your first attempt, Drishtya had said later - but your mind was so focused on the pain that you didn&#39;t even watch the results. There wasn&#39;t a second attempt.

You shake your head, and its intrusive thoughts out of it. It&#39;s time to become acquaintanced with these confines of the Valley.

//You have learned Holy Blast.//

[[Continue|FA ReachedTheSwamp 2]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="530" name="FA ReachedTheSwamp 2" tags="" position="3195,1179" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLP4&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;We&#39;re just about to enter the swamps, aren&#39;t we? Even the color of the grass is turning grayer.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Yes, we&#39;re just a few hours away from the Caverns. We should find the first lakes soon enough. ...Look, there&#39;s one over there.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I can see it!&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;We won&#39;t detour to get a closer look, there are far bigger lakes up ahead.&quot;//&lt;/span&gt; Drishtya sentences.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;We have been quite lucky we haven&#39;t met any monsters yet.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Very. I had several encounters with them on my way to the Passion Temple.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It appears our good luck has come to an end.&quot;//&lt;/span&gt;

[[Continue|FA ReachedTheSwamp 3]]</tw-passagedata><tw-passagedata pid="531" name="FA ReachedTheSwamp 3" tags="" position="3301,1177" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLP4&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I can see them.&quot;//&lt;/span&gt;

Drishtya and Padmiri both are looking towards some backwaters to the left of the path. What initially appeared to be a large withering plant surprises you when you see it crawling.

Even though its colors may be in harmony with the sad, brownish shades of this zone&#39;s vegetation, no plant that you&#39;ve ever met before was entirely painted in gray. A large cylinder of giant leaves completely covers the sides of its body, and you can barely notice some ropes that fall from its top.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;There are two... No, three of them. It looks like they have not seen us.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;We could slip by then, and avoid the fight.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Hmm... You&#39;re going to attack them.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;I like that idea, I needed some exercise already.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;But why?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Because you need a taste of what fighting against monsters is like, you can take these ones by surprise, and we&#39;re far more than them. If anything gets out of hand, I&#39;ll be there to take you out of trouble.&quot;//&lt;/span&gt;

[[Continue|FA ReachedTheSwamp 4]]</tw-passagedata><tw-passagedata pid="532" name="FA ReachedTheSwamp 4" tags="" position="3410,1175" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLPlake&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;You&#39;ll separate by pairs. Nashillbyir and Valtan, Fiercest Claw and Padmiri, Maaterasu and $chPlayerCharacter.name, each group will focus on one of them. Keep in mind that fighting monsters and fighting tribespeoples are nothing alike: there&#39;s no use in grappling with monsters, but they will take full advantage of your weaknesses. Do not be afraid of using the technique I taught you at the Temple, and call for help if you&#39;re getting overwhelmed. Everything clear?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Understood.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;We&#39;ll beat them in no time!&quot;//&lt;/span&gt;

&lt;&lt;link [[Attack|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
ccsFAplayerAteFightOneSucker();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="533" name="FA SuckerVictory 1" tags="" position="3411,1402" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLPlake&quot;);
deleteAllMonsters();&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It&#39;s too strong!&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;We must fall back.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Let me take care of this one.&quot;//&lt;/span&gt;

As if things weren&#39;t going bad enough, several new essence-suckers appear, flanking the Candidates who are still fighting. Maaterasu and you are still providing ranged cover, but Drishtya decides she must intervene before things get too out of hand.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Make some distance, Claw, I will attack that one.&quot;//&lt;/span&gt;

The Beastkin returns a small nod in acknowledgement and feints its enemy, before kicking it into the ground and jumping away.

The old Shapeshifter has finished her preparations, and casts a technique that only by chance you recognize as Holy Blast.

[[Continue|FA SuckerVictory 2]]</tw-passagedata><tw-passagedata pid="534" name="FA BeatenSucker 1" tags="" position="3088,1294" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLPlake&quot;);
deleteAllMonsters();&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
The foul creature lies before you, sporadically trying to get up in spasms. The rush of victory fills your veins, and you are filled with the conviction that you&#39;d be able to overcome any obstacle.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;We did it!&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;How is everyone else?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Watch out over there!&quot;//&lt;/span&gt;

A quick look around you reveals the bad news: more essence-suckers are coming and surrounding you.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Hold your positions and don&#39;t panic. We have everything under control.&quot;//&lt;/span&gt;

&lt;&lt;link [[Hold on|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
ccsFAplayerAteFightTwoSuckers();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="535" name="FA BeatenSucker 2" tags="" position="3195,1294" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLPlake&quot;);
deleteAllMonsters();&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
A blast of blinding light passes right besides you, hitting both monsters at the same time. When you&#39;re able to see them again, many of their leaves are calcined, reduced to a mere fraction of what they were a few seconds ago.

Your heart pumps, instinctively shrinking at the sight of such power. The fear of becoming the target of such an attack freezes you in place.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Give me a moment, I&#39;ll deal with the rest of them as well.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;There&#39;s one running away, leave it to me.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Don&#39;t chase after them!&quot;//&lt;/span&gt;

The warning falls to deaf ears, the Aiishen already focused on chasing her enemy.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;$chPlayerCharacter.name, catch Maaterasu and bring her back. There might be more monsters that we haven&#39;t spotted yet.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Leave it to me.&quot;//&lt;/span&gt;

[[Continue|FA AmbushingEye]]</tw-passagedata><tw-passagedata pid="536" name="FA AmbushingEye" tags="" position="3301,1292" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLriver2&quot;);
deleteAllMonsters();
gC(&quot;chPlayerCharacter&quot;).willpower.current -= 10;&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
You don&#39;t think twice and chase after Maaterasu, shouting her to stop. At some point, she stops running along the shore and enters a grove besides it.

//These things jump surprisingly fast, but has it really fled all the way here?//

You&#39;re about to lose sight of Maaterasu, so you try jumping above some reeds to take a shortcut, but you miscalculate the distance and fall right at the border of a small pond of water. You lose your balance, fall deeper, and when you rise your eyes, you can no longer see the Aiishen. Not about to be defeated by this, you take a hold on the ground, get out of the water, and-

//!!!!!//

A giant eye is suddenly in front of you, holding you in place with the mere power of its will. It doesn&#39;t move, and neither do you, and you soon realize that the strange beast is floating. An eye as long as an arm and a half is floating right in front of you, and menacing tentacles connected to its sides and back are agitated by the wind the same way the algae dance with the tides of the water.

You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;//10 willpower//&lt;/span&gt;.
You lost //3 control//.

After managing to get out of its mindlock, you try kicking it. It merely flies a couple of meters away, but you&#39;re back on your feet to give it a proper fight.

&lt;&lt;link [[Attack|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
ccsFAplayerFightsFlyingLookout();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="537" name="FA EntersArtume" tags="" position="3083,1404" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLriver2&quot;);
deleteAllMonsters();&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
You quickly get back on your feet and raise your arms, ready to continue fighting. The monster doesn&#39;t entertain your enthusiasm, and simply flees away. You don&#39;t chase it.

//Was that an arrow? Who has...?//

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Hey! Are you fine?&quot;//&lt;/span&gt;

You turn to the sound of the voice, and find a familiar face.

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/artume-full.png]]
&lt;/div&gt; \

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Artume!? Is that you?&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;$chPlayerCharacter.name! I can&#39;t believe it!&quot;//&lt;/span&gt;

[[Greet Artume|FA GreetArtume]]</tw-passagedata><tw-passagedata pid="538" name="FA GreetArtume" tags="" position="3196,1404" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLriver2&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chArt&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I can&#39;t believe I&#39;ve found you here, of all places!&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;And I still can&#39;t believe you&#39;re the Gaanidan Candidate! I come back to the tribe one good day, and they tell me you&#39;re gone. It was all so sudden! And why are you here right now?&quot;//&lt;/span&gt;

//Right, I&#39;m in the middle of something.//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wait, we can&#39;t chat just yet. I have to find Maaterasu... And the others were also fighting monsters.&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Where did this Maaterasu go?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She&#39;s the Aiishen Candidate, I was following her track when she entered that grove over there...&quot;//&lt;/span&gt;

Just as if she was waiting for you to mention it, the purple girl comes out of the trees.

[[Continue|FA GreetArtume2]]</tw-passagedata><tw-passagedata pid="539" name="FA GreetArtume2" tags="" position="3303,1402" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLriver2&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chArt&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Ate! You&#39;re there! We have to come back!&quot;//&lt;/span&gt;

She walks towards you without much of a hurry, and only replies when she&#39;s close enough to not to have the need to shout.

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I couldn&#39;t find it.&quot;//&lt;/span&gt;

A short scolding and a stoic introduction follows, as you still have to regroup with Drishtya. Fortunately, thanks to the Priestess Regent no one else went through too much trouble.

[[Continue|FA GreetArtume3]]</tw-passagedata><tw-passagedata pid="540" name="FA GreetArtume3" tags="" position="3081,1512" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLPlake&quot;);
deleteAllMonsters();&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chArt&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It was most fortunate that you were so close. You have my sincere gratitude for aiding the Candidates.&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;I was already tracking that monster, so it was no issue. It&#39;s a shame that it got away though...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;You wanted... To catch a monster? On your own?&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Well, to be truthful, yes.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;That is... Most unusual. Would you join us for the day? I&#39;d like to inquire about your goals, and I&#39;m sure $chPlayerCharacter.name would love to speak with another Gaanidan for a while.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes! Come with us, Artume.&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;You&#39;re going to the Gleaming Caverns, right?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Precisely.&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Then I&#39;ll join you. I had already planned to spend the few following days in the area.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Wonderful. I&#39;ll leave you some time to properly greet each other. Before anything else, there&#39;s someone I have to scold. Maaterasu, come here.&quot;//&lt;/span&gt;

//Maaterasu has lost 3 merit.//&lt;&lt;script&gt;&gt;gC(&quot;chAte&quot;).merit -= 3;&lt;&lt;/script&gt;&gt;

[[Continue|FA GreetArtume4]]</tw-passagedata><tw-passagedata pid="541" name="FA SuckerVictory 2" tags="" position="3408,1292" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLPlake&quot;);
deleteAllMonsters();&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
The blast of blinding light passes right besides you, obliterating the monster. When you&#39;re able to see it again, many of its leaves are calcined, reduced to a mere fraction of what they were a few seconds ago.

Your heart pumps, instinctively shrinking at the sight of such power. The fear of becoming the target of such an attack freezes you in place.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Give me a moment, I&#39;ll deal with the rest of them as well.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;There&#39;s one running away, leave it to me.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Don&#39;t chase after them! You&#39;re in no condition to keep fighting!&quot;//&lt;/span&gt;

The warning falls to deaf ears, the Aiishen already focused on chasing her enemy.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Everyone else is still busy, $chPlayerCharacter.name, catch her and bring her back. There might be more monsters that we haven&#39;t spotted yet. Avoid fighting.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Fine. Leave it to me.&quot;//&lt;/span&gt;

[[Continue|FA AmbushingEye]]</tw-passagedata><tw-passagedata pid="542" name="FA GreetArtume4" tags="" position="3193,1510" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLP1&quot;);
deleteAllMonsters();&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chArt&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Would you introduce us?&quot;//&lt;/span&gt; Nash asks you after the group resumes the hike.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sure! This is Artume, a huntress from my tribe, and a friend as well. This is Nashillbyir, the Ashwalker Candidate, and... That one is Claw. Pardon her timidness, I&#39;m sure she&#39;s also interested in you.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf&quot;//&lt;/span&gt; Claw crosses her arms, protesting your joke.

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;I&#39;m glad to meet you both!&quot;//&lt;/span&gt; 

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Likewise!&quot;//&lt;/span&gt; 

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Even though Artume is a few years older than me, we used to spend a lot of time together a few years ago. Then she started her hunting trips...&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;It&#39;s true that I don&#39;t spend that much time in the tribe anymore.&quot;//&lt;/span&gt; 

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;At first, she used to be away for one, maybe even two days. But her expeditions got longer and longer, and she&#39;s usually away for several weeks, these days...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You hunt on your own for weeks? That&#39;s amazing.&quot;//&lt;/span&gt; 

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Haha.&quot;//&lt;/span&gt; 

[[Continue|FA GreetArtume5]]</tw-passagedata><tw-passagedata pid="543" name="FA GreetArtume5" tags="" position="3303,1509" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLP1&quot;);
deleteAllMonsters();&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chArt&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;What was that about trapping monsters?&quot;//&lt;/span&gt; Claw drops a blunt question, secure about where she wants to take the conversation.

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;I&#39;m glad you ask! Monsters are the reason I spend so much time in the wilds, I&#39;m trying to learn as much about them as I can.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Why? Did you have a bad experience with them?&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Uh? No. Well, yes. But that&#39;s besides the point. We know a lot about the world, about the Valley, if you think about it. The plants feed on soil and water, and seek the Sun, animals feed on plants and on each other, they sleep, they have whelps, they feel fear and hunger. The people of the tribes are similar to them in many ways, we need sustance to keep on living, we need to rest, we feel love and lust... But what do we know about monsters?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;They feed on aether.&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Yes, but what do they need it for? Do they thirst for it? Do they die without it? Can they even die?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;We can leave them crippled, and deform them for a long while... But they always recover their shape.&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Exactly. They are completely different from plants, from animals, from the tribespeoples. Why are they even here? What&#39;s their role in the Valley, in the world?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You are //quite// enthusiastic about this.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s Artume for you. Now you&#39;ll have to listen to her for hours.&quot;//&lt;/span&gt;

[[Continue|FA GreetArtume6]]</tw-passagedata><tw-passagedata pid="544" name="FA GreetArtume6" tags="" position="3410,1509" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLbridge&quot;);
deleteAllMonsters();&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chArt&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;But how were you planning to trap one?&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;I&#39;m still working out on the logistics... But the plan right now is tying them up.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Why don&#39;t you just beat them?&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Been there, done that. The problem is that monsters behave erratically after they receive enough damage, but I want to learn more about their normal behavior.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And what do you expect to learn once you&#39;ve captured one?&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Well, right now... I&#39;m trying to replicate their magic.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Their magic?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Can you do that!?&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Sure, lend me your hands.&quot;//&lt;/span&gt;

Nash offers her hands without blinking. Claw doubts for a long while, but her curiosity makes her give in.

Artume puts her own hands a couple of palms above theirs, and begins pulling aether. A weak fog takes form, gains intensity and, very slowly, turns solid. The Ashwalker and the Beastkin are now chained to each other by their wrists.

[[Continue|FA GreetArtume7]]</tw-passagedata><tw-passagedata pid="545" name="FA GreetArtume7" tags="" position="3081,1619" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshLbridge&quot;);
deleteAllMonsters();&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chArt&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I don&#39;t think that was a great idea...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What did you just do!?&quot;//&lt;/span&gt;

Both Candidates start pulling their arms away, only to struggle against each other.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;How dare you!? I hope for your sake that these come off...&quot;//&lt;/span&gt; The Beastkin tries scratching her chains, to no avail.

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Dont worry, don&#39;t worry! They&#39;ll come off on their own. This is a spell used by Oppressive Yokes.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;When did you even learn to cast magic? Certainly not at the tribe...&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;A couple of Leirien were kind enough to teach me, a long time ago.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And... This?&quot;//&lt;/span&gt; Nash raises her wrist, showing off the aetherial chain. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;How did you learn the spell of a monster?&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;That&#39;s a longer story...&quot;//&lt;/span&gt;
&lt;&lt;script&gt;&gt;
State.variables.StVars.check1 = false;
if ( State.variables.StVarsList.includes(&quot;monActUs&quot;) ) { State.variables.StVars.check1 = true; }
&lt;&lt;/script&gt;&gt; \
&lt;&lt;if $StVars.check1 is true&gt;&gt; \

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Wait, didn&#39;t $chPlayerCharacter.name use the spell of a monster as well...?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Uh?&quot;//&lt;/span&gt; A chill runs down your spine.
&lt;&lt;/if&gt;&gt; \

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Hello, Artume, nice to meet you.&quot;//&lt;/span&gt; The Leirien Candidate comes from Drishtya&#39;s position.

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;I think I remember you. Was your name Padmiri?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;That&#39;s me. Drishtya wants to talk to you already, up ahead.&quot;//&lt;/span&gt;

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Then I better leave.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You better do before these come off, or else.&quot;//&lt;/span&gt;

[[Continue|FA AnotherAmbush1]]</tw-passagedata><tw-passagedata pid="546" name="FA AnotherAmbush1" tags="" position="3191,1619" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshMP2&quot;);
deleteAllMonsters();&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
Since she&#39;s probably going to repeat her explanations once again to Drishtya, you decide against accompanying Artume for the time being. Claw&#39;s and Nash&#39;s chains don&#39;t take long to fall off, and the conversation resumes.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Oppressive Yokes are quite the large creatures. If you wanted to tie a monster in ropes, it should definitely not be your first choice.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Where are you going with this?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;She didn&#39;t learn that spell from a monster she had subdued.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;How can you even learn a spell from a monster, anyway?&quot;//&lt;/span&gt;

The image of Varyonte invades your mind, forcing you to choose among one of her so called &quot;boons&quot;. It doesn&#39;t take you long to realize that the vast majority of the magic you&#39;ve seen her cast is used by monsters as well.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I guess I&#39;ll have to keep asking Artume later. $chPlayerCharacter.name, do you know how she manages to live for so long on the wilds, on her own?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;She told us some stories, but I don&#39;t think they hold all the details you&#39;d need to make it by yourself. She mentioned that she constantly had to be attentive to all details, keeping an ear always searching for dangers, making sure not to make too much noise...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Now that you mention it, we should all be doing the same, even if Drishtya is protecting us.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I bet Claw does all that.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Is that true, Claw? Claw?&quot;//&lt;/span&gt;

Claw isn&#39;t besides you anymore.

[[Continue|FA AnotherAmbush2]]</tw-passagedata><tw-passagedata pid="547" name="FA AnotherAmbush2" tags="" position="3303,1619" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshMP2&quot;);
deleteAllMonsters();&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
When you look back, you find Claw in a fighting stance, jumping away from a flare. The attacker is further beyond.

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/hope-full.png]]
&lt;/div&gt; \

Another Beastkin, proud in her pose and defiant in her attitude, is attacking your peer without holding back.

&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
ccsFAhopeAttacksClaw();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="548" name="FA AnotherAmbush3" tags="" position="3410,1619" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshMP2&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Who&#39;s that?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I don&#39;t know, but we can&#39;t stay here with our arms crossed! Let&#39;s go help Claw!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes!&quot;//&lt;/span&gt;

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;Not so fast.&quot;//&lt;/span&gt; Someone runs in front of you two, blocking your way.

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/rock-full.png]]
&lt;/div&gt; \

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;This isn&#39;t your fight. Stay back.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And let a stranger attack one of our own? You&#39;re dreaming!&quot;//&lt;/span&gt;

&lt;&lt;link [[Attack|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;
ccsFArockInYourWay();
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="549" name="FA CeasedFire" tags="" position="3540,1164" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshMP2&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chHope&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chRock&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Stop this at once! This isn&#39;t befitting of you!&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;What&#39;s the matter in here?&quot;//&lt;/span&gt;

Two women are approaching the battlefield from both sides. One of them is Drishtya, who has turned back after noticing the commotion. The other one is an old Beastkin woman, wearing robes most similar to the fox-girl who was fighting Claw mere seconds ago, and whose head is crowned by tiger ears, much like those of your peer from the Temple.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;What, you...?&quot;//&lt;/span&gt;

&lt;span @style=$chHope.colorStyleKey&gt;//&quot;I&#39;m just settling an old grudge, that&#39;s all.&quot;//&lt;/span&gt; The fox-girl replies, immediately turned more docile.

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;This isn&#39;t what we came here for, and...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt; The young and the old tiger women cross eyes, and everyone remains quiet staring at the scene.

Drishtya passes by your side, clearly not in a hurry to take the spotlight now that the fighting has stopped. The male Beastkin that you&#39;ve just fought doesn&#39;t attempt to stop her.

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Oh, Carine, you&#39;ve grown so much.&quot;//&lt;/span&gt; The lady&#39;s voice leaves a clear trail of nostalgia, and her cheeks and a single tear falling through her face betray her joy. She welcomes Claw in her arms.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Wait, is that... Claw&#39;s mother?&quot;//&lt;/span&gt; Nashillbyir asks you, almost whispering, her mouth wide-open.

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;You don&#39;t know how much I&#39;ve missed you... I&#39;m so glad to see you well.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...Likewise.&quot;//&lt;/span&gt;

[[Continue|FA CeasedFire2]]</tw-passagedata><tw-passagedata pid="550" name="FA CeasedFire2" tags="" position="3651,1160" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshMP2&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chHope&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chRock&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It&#39;s good to see you all safe, Leap.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Greetings, Drishtya. Please, excuse the rash attitude of my pupil.&quot;//&lt;/span&gt;

&lt;span @style=$chHope.colorStyleKey&gt;//&quot;Hmm.&quot;//&lt;/span&gt; The fox-girl cleans her throat.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I&#39;m sure we&#39;ll have time to discuss that later. What are you doing here?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;I heard you had parted to visit the Gleaming Caverns, and I considered it a good opportunity for Hope to get to know the Valley as well.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I trust you&#39;re keeping an eye out for any... Potential danger.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Absolutely. We&#39;re currently camping in a secret site close to here. We&#39;d be honoured if you visited us.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;We can&#39;t pass up the opportunity. Some of the Candidates must be exhausted, and it&#39;s been a long time since we had the opportunity to talk.&quot;//&lt;/span&gt;

Drishtya takes a look at Claw, and so does Leap. The Candidate keeps her arms closed, perhaps more tense than when she was fighting. The tiger-girl shuns the Regent&#39;s gaze.

[[Continue|FA CeasedFire3]]</tw-passagedata><tw-passagedata pid="551" name="FA CeasedFire3" tags="" position="3760,1162" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshMP2&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chRock&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I hope you don&#39;t raise a wall to leave us behind.&quot;//&lt;/span&gt; Nash pokes the gray-haired Beastkin.

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;Hahaha. If the Priestess invited you, you will be most welcomed.&quot;//&lt;/span&gt; 

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Is that woman a Priestess?&quot;//&lt;/span&gt;

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;Yes, she&#39;s the spiritual leader of our tribe, and she was our Candidate for High Priestess in the previous generation.&quot;//&lt;/span&gt; 

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Was she!? Then she&#39;s friends with Drishtya and Shrezdill? Or...&quot;//&lt;/span&gt; Nashillbyir quickly takes her words back.

//They may as well hate each other&#39;s guts.//

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;I think they are, yes.&quot;//&lt;/span&gt; 

Drishtya interrupts your conversation. &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I trust you must have heard us, we&#39;ll accompany Fearsome Leap and her pupils and rest in their camp. Let&#39;s not waste any time.&quot;//&lt;/span&gt;

[[Continue|FA ToTheCamp 1]]</tw-passagedata><tw-passagedata pid="552" name="FA ToTheCamp 1" tags="" position="3868,1162" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshNP4&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chRock&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chHope&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
After regrouping with Padmiri, Valtan, Maaterasu and Artume, the group turns towards the north, switching its course. Drishtya and Leap stay ahead, and it isn&#39;t long until there&#39;s a clear distance between the new pair of young Beastkins and the others. The wolf-boy attempts to cross that bridge.

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;It&#39;s been a while, Carine.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;That will be Fiercest Claw for you, Nou.&quot;//&lt;/span&gt;

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;Fiercest Claw. It fits you. My name is now Sturdiest Rock, and Ruri&#39;s is Warmest Hope.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Do you switch names in the Beastkin tribe?&quot;//&lt;/span&gt; Valtan interjects.

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;Yes, we do. We receive a name from our parents when we&#39;re born, like everyone else, but after reaching maturity and passing a trial, we are free to choose a new name for ourselves.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I like that! Maybe I should pick a name for myself. What do you think about... I bring your doom.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...It doesn&#39;t sound too practical.&quot;//&lt;/span&gt; Padmiri moderates her honesty with diplomacy.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And you didn&#39;t know each other&#39;s chosen names? Have you been apart for a long time?&quot;//&lt;/span&gt;

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;I think I mentioned it earlier, didn&#39;t I? We ran away from our tribe.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Why?&quot;//&lt;/span&gt;

&lt;span @style=$chHope.colorStyleKey&gt;//&quot;Because the disgusting father of that grumpy cat decided that the lives of those he didn&#39;t like were worthless.&quot;//&lt;/span&gt; Hope jumps in to reply.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Don&#39;t you dare to speak of my father that way, or not even the Goddess&#39; blessing will be able to fix your face.&quot;//&lt;/span&gt;

&lt;span @style=$chHope.colorStyleKey&gt;//&quot;I speak only the truth, and you know it.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;If you didn&#39;t like how things were, you could have stepped up. And what did you do? You abandoned your tribe, you ran away with the tail between your legs.&quot;//&lt;/span&gt;

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;Hey, hey, not is not the time for a discussion... Sorry, but perhaps you can ask Leap to answer that later.&quot;//&lt;/span&gt;

[[Continue|FA ToTheCamp 2]]</tw-passagedata><tw-passagedata pid="553" name="FA ToTheCamp 2" tags="saveAllowed" position="3978,1160" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;hiddenCamp&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chArt&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
The conversation quickly perishes after that, and Hope and Rock mostly keep to themselves. If it wasn&#39;t for Artume and your mutual desire to know about the other&#39;s recent experiences, things wouldn&#39;t be much livelier by your side either.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;And how about... Flurry of Kicks?&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I&#39;m not calling you by that name.&quot;//&lt;/span&gt;

Save for the occasional attempt of Nashillbyir to rename herself.

At some point, Leap leads you all through a bothersome thicket, revealing a hidden path leading to a hill that otherwise looked unscalable. At the top, you find the Beastkins&#39; campment, and you are taken inside.

&lt;span style=&quot;color:green&quot;&gt;You can save the game!&lt;/span&gt;

[[Continue|FA LeapsStory1]]</tw-passagedata><tw-passagedata pid="554" name="FA LeapsStory1" tags="" position="3538,1274" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;hiddenCamp&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
Leap invites all of her guests to take seats around the camp, and asks Hope and Rock to bring you supplies from the tents in order to comply with the demands of courtesy.

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;I heard you were asking earlier why we&#39;ve left the Beastkin tribe. It&#39;s important for all Candidates to understand what&#39;s the situation in all corners of the Valley. Just to make sure, does any of you know what happened to the previous High Priestess?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What could have happened to her? She died, otherwise there wouldn&#39;t be new Candidates.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Of course, but has Drishtya explained to you how it happened?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I haven&#39;t yet. I considered they already had enough in their minds with getting used to their lives. But perhaps it&#39;s about time.&quot;//&lt;/span&gt;

Claw is looking outwards, to the ranges of the swamp. She already knows this story.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;At some points of the borders of the Confined Valley there are entrances to a web of grottos, tunnels that extend under the mountains. Inside them, a different kind of monster than any of the ones you&#39;ve seen so far, roams free. They&#39;re the Lizardlins.&quot;//&lt;/span&gt; Drishtya takes a moment to rest, and Leap takes the lead, resuming the explanation.

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;These... Monsters,&quot;//&lt;/span&gt; the Beastkin lets these words linger, &lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;the Lizardlins, have been living there for centuries, they were there even before the human tribes joined us in the Valley. Unlike the other monsters you&#39;ve met, they hold weapons, they plot, they communicate. For some periods in our history, they mostly kept to themselves, but they&#39;ve also been known to wage war against the tribes.&quot;//&lt;/span&gt;

[[Continue|FA LeapsStory2]]</tw-passagedata><tw-passagedata pid="555" name="FA LeapsStory2" tags="" position="3646,1269" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;hiddenCamp&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
Hope and Rock are handing out edibles that they&#39;ve brought from the tents. You receive some berries from the fox-girl.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;The previous High Priestess, Flenya, took the decision to attempt to negotiate with them.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;She was a Leirien. I have fond memories of her.&quot;//&lt;/span&gt; And sad memories of the moment she stopped appearing, Padmiri&#39;s expression adds.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Negotiate, with monsters? After what we&#39;ve just gone through I simply can&#39;t imagine monsters being able to talk, let alone negotiate.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Like Drishtya mentioned earlier, the capacity to communicate of these creatures is far closer to the tribespeoples&#39; than it is to that of the other monsters you&#39;ve encountered.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It was after several skirmishes between the tribes and the Lizardlins that were scaling in magnitude. Flenya thought that it would be better for everyone to attempt to find peace with words. Those beasts took her life, and those of everyone who were with her.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What? But that&#39;s not possible. Doesn&#39;t the Goddess prevent everyone from dying for any reason other than old age?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Yes, but only within the limits of the Confined Valley. If you take someone far enough, it becomes possible to rob them of their life.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;And there are also... Sacrilegious methods... That suspend the powers of the Goddess, even within the Valley. But that&#39;s an entirely different matter.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;That day, Flenya had taken Sanesh with her, the old Aiishen Candidate, as well as my son, with her.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Your son? Claw&#39;s brother? Why?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;My son was one of the best warriors of our tribe, and we had already struggled a fair share against the Lizardlins. His father sent him to aid Flenya in everything he could, to help her goals be fulfilled.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So Claw had a brother... And he died.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt; &lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;...That&#39;s correct.&quot;//&lt;/span&gt; Both sister and mother take your observation with stoicism.

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;He was a man with a noble heart. The whole tribe mourned his loss.&quot;//&lt;/span&gt;

[[Continue|FA LeapsStory3]]</tw-passagedata><tw-passagedata pid="556" name="FA LeapsStory3" tags="" position="3753,1265" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;hiddenCamp&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chHope&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;After their crime, the Lizardlins marauded and pillaged whatever corners of the Valley they could reach, and the Beastkin and the Aiishen tribes, the different Temples, and to some extent the Leirien as well, initiated campaigns of retribution against them. It was the closest we had been to war in ages.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;In the end, we decided to collapse all the entrances to their grottos, as it was done many times by our ancestors. But they always come back.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Shall the earth swallow them one day, for good.&quot;//&lt;/span&gt;

Both women stay in silence for a while, bathing in their own resentment.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;As for the Beastkin tribe...&quot;//&lt;/span&gt; Padmiri tries to get them to continue their explanation.

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Yes. The death of my son left our tribe shaken, and my old partner, Scourge... Took it the hardest.&quot;//&lt;/span&gt;

&lt;span @style=$chHope.colorStyleKey&gt;//&quot;You shouldn&#39;t paint him in a positive light.&quot;//&lt;/span&gt; Hope protests.

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;I&#39;m not trying to. Scourge had always had a somewhat elitist attitude. He didn&#39;t hate weak people, but he took them for granted, and he didn&#39;t take them into consideration as much as he listened to the stronger warriors.&quot;//&lt;/span&gt;

[[Continue|FA LeapsStory4]]</tw-passagedata><tw-passagedata pid="557" name="FA LeapsStory4" tags="" position="3863,1267" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;hiddenCamp&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chHope&quot;),getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;After the death of the High Priestess, he gained further conviction in those ideas.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;The strong must receive from the weak as much as they provide for them. The equality between the weak and the strong is the tyranny of the weak against the strong.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;...That&#39;s exactly how he&#39;d put it.&quot;//&lt;/span&gt; Leap replies with a deeply saddened face, unsure if she was talking to her daughter or to Scourge. Hope becomes agitated, but doesn&#39;t open her mouth. &lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Scourge was, and is, the chieftain of the Beastkin tribe. As such, he has full say on our laws, and he decided that those who couldn&#39;t pass the Coming-of-age Trial would lose their right to personhood.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;What does that mean?&quot;//&lt;/span&gt; Maaterasu asks, the specifics of the concept of personhood not being exactly clear.

Hope hurries to provide the answer: &lt;span @style=$chHope.colorStyleKey&gt;//&quot;It means that anyone who wasn&#39;t strong enough could be taken as a slave by the warriors.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;What!?&quot;//&lt;/span&gt; Padmiri&#39;s discomposure becomes generalized among the other Candidates.

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;In short, that&#39;s exactly how it is. If you don&#39;t prove yourself to be worthy, you lose all your rights, and any free Beastkin may challenge you to force you to become their servant.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;And that was... Simply accepted? No one refused to comply?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Usually, the Beastkin chieftain chooses a heir to take their place after their death, but it is also accepted that anyone who defeats them in a clean challenge for the position may supplant the current chieftain.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Many challenged my father, and all of them lost.&quot;//&lt;/span&gt;

[[Continue|FA LeapsStory5]]</tw-passagedata><tw-passagedata pid="558" name="FA 0.3.2 early ending" tags="saveAllowed" position="3410,1732" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([]);
checkForGleamingCavernsUpdates();&lt;&lt;/script&gt;&gt; \
Welcome to a newer version! You can continue the story since you last left it at version 0.3.2.

&lt;span style=&quot;color:green&quot;&gt;You can save the game!&lt;/span&gt;

[[Continue the story|FA LeavingCampment]]</tw-passagedata><tw-passagedata pid="559" name="FA LeapsStory5" tags="" position="3978,1269" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;hiddenCamp&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chRock&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chHope&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Of course, that doesn&#39;t mean everyone accepted the new state of affairs. Many of the younger Beastkin who still had to pass their Coming-of-age Trial, and some adverse-minded older ones decided to leave the tribe in secret, with me at their head.&quot;//&lt;/span&gt;

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;Basically put, we&#39;re fugitives right now.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;...And you can&#39;t go back to your tribe.&quot;//&lt;/span&gt; Valtan says, empathetic.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Can&#39;t the Passion Temple do anything about this? I loathe the idea of knowing about this situation and stay quiet.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;The Passion Temple is expected to mediate in conflicts between the tribes, not to rule above their rulers, although it&#39;s true that we have done that in the past as well. Since we don&#39;t even have a High Priestess right now, the authority of the Temple is even further limited.&quot;//&lt;/span&gt;

&lt;span @style=$chHope.colorStyleKey&gt;//&quot;Claw.&quot;//&lt;/span&gt; Warmest Hope speaks to Claw directly, without averting her eyes a single inch. Claw matches the defiance in her own eyes.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;What?&quot;//&lt;/span&gt;

&lt;span @style=$chHope.colorStyleKey&gt;//&quot;I want to hear you speak out loud what you think about this.&quot;//&lt;/span&gt;

[[Continue|FA LeapsStory6]]</tw-passagedata><tw-passagedata pid="560" name="FA LeapsStory6" tags="" position="3536,1382" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;hiddenCamp&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chHope&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Did anyone defeat Relentless Scourge?&quot;//&lt;/span&gt;

&lt;span @style=$chHope.colorStyleKey&gt;//&quot;What does that have to do with anything?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;If no one defeated the chieftain, what I think doesn&#39;t matter.&quot;//&lt;/span&gt;

&lt;span @style=$chHope.colorStyleKey&gt;//&quot;Of course it matters. You&#39;re her only daughter now, for starters,&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hmpf.&quot;//&lt;/span&gt;

&lt;span @style=$chHope.colorStyleKey&gt;//&quot;And you intend to become the Valley&#39;s High Priestess. Of course what you think is important, so don&#39;t avoid the question. What do you think about your father&#39;s rule?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...Why would anyone want to fight for our tribe if they were to receive no reward? Our warriors no longer risk just the humilliation of defeat, of the pain of monsters sucking out their aether, they also risk death. Why should anyone risk their own life just for the sake of letting everyone else live?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;Claw...&quot;//&lt;/span&gt; She already expected this, but this woman has just been deeply disappointed by her daughter, her last living child. Claw&#39;s face flinches.

&lt;span @style=$chHope.colorStyleKey&gt;//&quot;And that justifies turning our own people into slaves?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;If you don&#39;t agree, you only have to take down Scourge.&quot;//&lt;/span&gt; Claw&#39;s and Hope&#39;s previously verbal clash continues for some seconds, this time in silence, until Hope decides to change her target.

[[Continue|FA ChallengedCandidacy1]]</tw-passagedata><tw-passagedata pid="561" name="FA ChallengedCandidacy1" tags="" position="3646,1380" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;hiddenCamp&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chHope&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chHope.colorStyleKey&gt;//&quot;You have all heard her.&quot;//&lt;/span&gt; This time, she speaks to the rest of the Candidates. &lt;span @style=$chHope.colorStyleKey&gt;//&quot;This woman is fine with her own people enslaving each other, and she intends to become the Confined Valley&#39;s High Priestess, the highest representative of the Goddess for us all. I want you all to consider the implicit dangers in allowing her to triumph, not just for yourselves, but also for your peoples.&quot;//&lt;/span&gt;

Padmiri takes her eyes down, Nashillbyir and Valtan don&#39;t know where to hide their faces. Maaterasu listens to it all with stoicism, and Artume sends you a worried look.

&lt;span @style=$chHope.colorStyleKey&gt;//&quot;And now that that is clear, Fearsome Leap had something she wanted to tell Drishtya.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;...&quot;//&lt;/span&gt; The older Beastkin doesn&#39;t hide her contained ire, nor her determination, but she takes a short while to take the word. &lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;That&#39;s correct. Drishtya, Priestess Regent, and my friend. As the spiritual leader of the Beastkin, I must request you to retire the Candidacy of Fiercest Claw, and to accept my pupil, Warmest Hope, as the new Candidate of the Beastkin.&quot;//&lt;/span&gt;

Claw fights with all her strength to contain her grimace, but fails. Drishtya sighs, and looks at her old companion in the eye.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Leap, my friend... We have already discussed this, and my answer remains the same. It is not the privilege of the servants of the Goddess to choose the Candidates, but the tribes&#39;. And Scourge, as of this day, is the law of the Beastkin. This is a fact.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;And would you condemn half my people to live as slaves?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I cannot defy the rules of the Goddess, and I cannot let a whole tribe to position itself against the Passion Temple. These are the kind of decisions that ignite wars. And besides, Claw was already initiated as your tribe&#39;s Candidate.&quot;//&lt;/span&gt;

[[Continue|FA ChallengedCandidacy2]]</tw-passagedata><tw-passagedata pid="562" name="FA ChallengedCandidacy2" tags="" position="3751,1377" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;hiddenCamp&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chRock&quot;)]);
checkForGleamingCavernsUpdates();&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;...Fine. Then I think that will be all.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It will be, yes. Get up, everyone, we have to leave soon to reach the Gleaming Caverns today. Thank you for helping me with the explanation, Leap. It was good to see you.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:peachpuff&quot;&gt;//&quot;...Likewise.&quot;//&lt;/span&gt;

Claw does as Drishtya says and starts walking away, not about to bid farewell to anyone. Her mother and Hope do not stop her, but Rock does.

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;Claw! I wish you the best, despite everything.&quot;//&lt;/span&gt; 

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Go to hide between Ruri&#39;s legs, it fits you better.&quot;//&lt;/span&gt; 

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;Before you leave, I wanted to ask you, how&#39;s Oren?&quot;//&lt;/span&gt; 

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;He&#39;s... ...Fine.&quot;//&lt;/span&gt; 

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt; 

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt; 

&lt;span @style=$chRock.colorStyleKey&gt;//&quot;I&#39;ll take your word for it. You do well.&quot;//&lt;/span&gt; 

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt; 

[[Continue|FA LeavingCampment]]</tw-passagedata><tw-passagedata pid="563" name="FA LeavingCampment" tags="" position="3859,1377" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;hiddenCamp&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chArt&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Hey, $chPlayerCharacter.name? I&#39;m going to ask the Beastkin to let me stay with them. I hear there aren&#39;t any monsters in the Caverns, so staying here will save me a lot of time, if they allow me to.&quot;//&lt;/span&gt; Artume hastily reaches out to you, fairly aware that the events that just unfolded require your group to leave.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Is that so? Well, I&#39;m glad I could meet you, Artume.&quot;//&lt;/span&gt; 

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You&#39;re staying? But I still had questions for you.&quot;//&lt;/span&gt; 

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;If you have the time, come back to see me in the following days! In fact, I was going to ask you for help with the monsters.&quot;//&lt;/span&gt; 

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You want our help? What did you have in mind?&quot;//&lt;/span&gt; 

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Didn&#39;t I tell you earlier? I want to get the monsters tied up and under control, but lively enough for them to keep attempting to behave as usual.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Do you think you could learn their techniques that way?&quot;//&lt;/span&gt; 

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;My intent is both to learn them and to teach them to you. That would be useful for you as Candidates, right?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Are you kidding? That would be great! Beating everyone else would be so easy if I could drain them like those essence-suckers.&quot;//&lt;/span&gt; 

//...//

&lt;span @style=$chArt.colorStyleKey&gt;//&quot;Then I&#39;ll be glad to welcome your help! I&#39;ll see you tomorrow!&quot;//&lt;/span&gt;

With that, the Gaanidan runs away to talk to Leap, apparently fairly certain that she&#39;ll be welcomed in the camp. You continue your journey with Drishtya and the Candidates.

[[Continue|FA LeavingCampment2]]</tw-passagedata><tw-passagedata pid="564" name="FA 0.3.3 Placeholder Story Event" tags="" position="3521,1735" size="100,100">Placeholder Story Event

$eventsCalendar.finishEventButton
\
&lt;&lt;script&gt;&gt;
State.variables.personalRoom.initializeNewDay();
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="565" name="FA LeavingCampment3" tags="" position="3536,1492" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;cavernMP3&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chVal&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
A dim cyan light beckons you into entering the cave. At the first turn between the walls of rock, the wind ceases, the air turns chilly, and you find the origin of the lights.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Are these gleaming crystals?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Precisely. Once they get charged up with sunlight, they spend years reflecting it back. It&#39;s only thanks to them that we don&#39;t need any extra illumination in the Caverns. Besides...&quot;//&lt;/span&gt;

The Priestess Regent places her hands a few inches above one of them, and short seconds later, the crystal twists and bends with her movements.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;They&#39;re easy to give shape to for someone with some experience at casting magic. Which leads us to...&quot;//&lt;/span&gt;

Drishtya then points to further ahead in the Caverns, up to some glowing ceramic tiles attached to the walls. The tiles have geometrical figures painted in them, trying to resemble nothing but the beauty of pure forms and shapes.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;The tiles. These are crafted at the tribe to mark the way through the tunnels, and they have crystals embedded in them to ensure that they&#39;re clearly visible.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Beware of the crystals though,&quot;//&lt;/span&gt; Valtan warns, &lt;span @style=$chVal.colorStyleKey&gt;//&quot;whenever you touch them directly, the flow of aether through your body gets disrupted, which makes you unable to cast magic.&quot;//&lt;/span&gt;

Your march through the Caverns continues peacefully, meeting no people, meeting no souls, just the ever quiet collection of Shapeshifter art. From time to time, the appreciation for the merely abstract gives place to paintings of people, travelling, eating, working, making love and waging war. Which ones of these refer to real, historic events, and which ones come from the imagination of their artists, not even Drishtya can always tell for sure.

[[Continue|FA EnteringSsTribe1]]</tw-passagedata><tw-passagedata pid="566" name="FA LeavingCampment2" tags="" position="3974,1378" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;marshSP1&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
A fair while after leaving the hidden campment, the spirits are still decayed. Judging by her gestures, you&#39;d claim that Valtan has attempted to talk to Claw several times, but backed off at the first word. Padmiri has been remarkably quiet, mostly looking to her own feet, rather than the marshes she had never set a foot in.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;These bugs are going to eat me alive!&quot;//&lt;/span&gt; Nashillbyir complains, shaking her arms against a small swarm of flying insects.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;It&#39;ll get better soon, we&#39;re just about to reach the Caverns.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;There are no insects inside?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;There are no animals, no plants and no monsters. The only living things in the Caverns are us Shapeshifters... And maybe the Caverns themselves.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;The Caverns are alive?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I wouldn&#39;t call them alive, but you could say that they breathe and drink.&quot;//&lt;/span&gt; Drishtya intervenes, expanding your doubts instead of solving them.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...What does that even mean?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Many of the walls of the Caverns are highly permeable, and it&#39;s nothing uncommon to find water falling from the ceilings and forming rivers and even lakes. This could make them difficult to traverse on its own, but many of its minerals also have strong reactions to aether. And when enough aether is carried by the water...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;The tunnels move.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...That sounds like we could easily get lost.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Not just lost, but trapped as well.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Fortunately, not all the Caverns are the same. There are a handful of tunnels and sections that almost always stay the same, so our tribe marked them and used them to build our homes.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;If you DO enter the unmarked tunnels, however, it may be dangerous for you.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;I think I can see the entrance.&quot;//&lt;/span&gt;

[[Continue|FA LeavingCampment3]]</tw-passagedata><tw-passagedata pid="567" name="FA EnteringSsTribe1" tags="" position="3646,1488" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;mainStreet1&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;And we&#39;re finally here.&quot;//&lt;/span&gt;

At some point of your path, the tunnel ends, giving birth to a gargantuan room both wide, large and tall. Within it, decens of buildings made of clay form streets in all directions.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Oh, you are...&quot;//&lt;/span&gt; A young Shapeshifter woman finds you, her face showing surprise, and no other emotions. &lt;span style=&quot;color:gray&quot;&gt;//&quot;Drishtya, and... Valtan. The rest of you must be the Candidates, right?&quot;//&lt;/span&gt;

It isn&#39;t long before a small crowd surrounds you, their general mood hard to describe as anything other than cautious.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I&#39;m glad to meet you all. Mersche, Tsalvin... A lot of faces I don&#39;t recognize.&quot;//&lt;/span&gt; Drishtya greets them openly and welcoming, in contrast with their coldness.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;We should call the judges.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Of course, a formal welcome would be in order.&quot;//&lt;/span&gt; A couple of persons from the tribe leave through the streets.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Are they bringing judges...? Should we be worried?&quot;//&lt;/span&gt; Nashillbyir asks her peers, wary of drawing attention from Drishtya in this situation, now that she&#39;s making sure to become the focus of everyone around you.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;I don&#39;t think so, stay calm for now.&quot;//&lt;/span&gt;

[[Continue|FA EnteringSsTribe2]]</tw-passagedata><tw-passagedata pid="568" name="FA EnteringSsTribe2" tags="" position="3749,1488" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;mainStreet1&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chClaw&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;Drishtya, honey! You look stunning!&quot;//&lt;/span&gt; A green Shapeshifter man, effeminate in his mannerisms and somewhat decayed in the complexion of his skin, is allowed to pass through the crowd and shows no restraint to get closer to the Priestess Regent. They exchange kisses in each other&#39;s cheeks.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;You&#39;re looking great yourself, Melesh.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;They are the current generation of Candidates, right? You all look divine as well.&quot;//&lt;/span&gt; Drishtya visibly contains a smirk at what probably is the worst pun she has heard in the whole week. &lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;As the oldest Shapeshifter judge in office, it is my pleasure to welcome you all to our tribe.&quot;//&lt;/span&gt; No special salute is offered to Valtan. No one has directed any word to her so far.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;You&#39;re a judge right now?&quot;//&lt;/span&gt; The purple Shapeshifter stops herself right before commenting on the matter. Instead, she neutrally asks: &lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Is the job treating you well?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;I can&#39;t complain about it.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:palevioletred&quot;&gt;//&quot;Drishtya!&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;...Literally.&quot;//&lt;/span&gt;

Another purple woman, younger than your mentor, but full of drive and authority nonetheless, charges in and demands to be heard.

&lt;span style=&quot;color:palevioletred&quot;&gt;//&quot;You can&#39;t disrespect our tribe, your own tribe, like this! Our traditions demand a trial against the impostor!&quot;//&lt;/span&gt; The muttering of the crowd soars. Even though they&#39;re visibly altered, no one else dares to draw attention to themself. Valtan, for the first time since you reached the tribe, is trying to hide her face.

&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;Seeria, we have already discussed this. This was a matter for the Temple to judge, not ours.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:palevioletred&quot;&gt;//&quot;And why is that? Because Drishtya decided to play along with the game of the impostor? What a sorry excuse, what a farce!&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Greetings Seeria, it&#39;s good to see you. The person you refer to has been accepted by the Goddess as a Candidate. It is no longer the duty of our tribe to judge her, or to give her punishment. I assume you have been named a judge?&quot;//&lt;/span&gt; Drishtya replies, maintaining her composure at all times.

&lt;span style=&quot;color:palevioletred&quot;&gt;//&quot;I have, and it is my duty to make sure the law of the Shapeshifters is upheld!&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;And it is being upheld. Someone who committed a crime in our tribe is now committed to the service of the Goddess, and in the name of the Goddess, I have cast my judgement upon her. You may rest at ease.&quot;//&lt;/span&gt; The crowd, which had ceased in its muttering, turns wild once again.

&lt;span style=&quot;color:palevioletred&quot;&gt;//&quot;You have... What...?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;Let us pass through, everyone! I must show the Candidates the way to their rooms!&quot;//&lt;/span&gt; Melesh fights to be heard and take control of the situation. A small corridor is opened to let you advance, and the protests of Seeria are dissolved within the uncontrolled noise of the masses.

[[Continue|FA EnteringSsTribe3]]</tw-passagedata><tw-passagedata pid="569" name="FA EnteringSsTribe3" tags="" position="3856,1486" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;templeShrine&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
You hurriedly traverse the tribe, led by Melesh and Drishtya, and followed by some curious Shapeshifters, which Padmiri and Nashillbyir salute briefly. While these aren&#39;t the best circumstances to examine the town in detail, you get a good view of the building you&#39;re heading towards: the pillars of a large stone dome keep its entrance open to all, like carelessly large teeth would keep a maw unclosable.

Inside, you meet a statue of the Goddess, much like the one at the Passion Temple.

&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;Welcome to the Temple of Harmony, Candidates.&quot;//&lt;/span&gt; The judge says, soon, to be interrupted.

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;That&#39;s my line, Melesh.&quot;//&lt;/span&gt;

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/nersmias-full.png]]
&lt;/div&gt; \

Another purple Shapeshifter is fast to get in front of all of you. You immediately notice his robes, similar to Valtan&#39;s in almost every detail. His character, however, couldn&#39;t be any more different. Serious and severe, his eyes stare at your very being as if they were judging the fate of your soul. His hands remains behind his back, contained yet serene, not just about to make a gesture of friendliness.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Greetings, Nersmias.&quot;//&lt;/span&gt; Drishtya breaks the silence.

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;Welcome, Priestess Regent of the Passion Temple. Welcome, Candidates, and Valtan. Melesh. I&#39;m the priest in charge of the Temple of Harmony.&quot;//&lt;/span&gt; He replies.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Hello.&quot;//&lt;/span&gt; Valtan says most plainly.

//Is it just me or is this the first time I hear Valtan&#39;s name since we arrived?//

&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;You&#39;re so charming, Nersmias.&quot;//&lt;/span&gt; The judge compliments him in sarcasm.

[[Continue|FA AtTheTemple1]]</tw-passagedata><tw-passagedata pid="570" name="FA AtTheTemple1" tags="" position="3976,1488" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;templeShrine&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNer&quot;),getPresentCharByKey(&quot;chVal&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;We&#39;ve come to the Temple to receive accommodation during our stay at the tribe.&quot;//&lt;/span&gt;

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;I thought so. That will be a problem, you see, as all the rooms in the Temple are currently being used. But do not worry, I have prepared proper beddings for you in the storage.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Really? And how is it that all rooms are occupied?&quot;//&lt;/span&gt;

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;We have someone in dire need of spiritual healing, someone who might risk her recovery were she to get in contact with... Some of our guests.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;And who is this person?&quot;//&lt;/span&gt;

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;You might have not heard of her, given your actions, but she&#39;s the rightful Shapeshifter Candidate: Sillan.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What did you say?&quot;//&lt;/span&gt; Valtan immediately snaps at the mention of her friend.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;If she&#39;s in need of spiritial healing, it would be best for me to meet her.&quot;//&lt;/span&gt;

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;You, the one person who denied her the right to represent the Goddess? That is not going to happen.&quot;//&lt;/span&gt; The athmosphere turns colder by the moment, its tension almost as tangible as any material object.

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Are you going to refuse the Head Priestess entrance to the Temple of Harmony? Do I need to remind you of our laws?&quot;//&lt;/span&gt;

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;Do I need to remind you? You are the Priestess Regent, a charge devoid of the full authority of the Head Priestess. As such, you don&#39;t have the power to order me around, and I will not allow you to provoke further harm to our pious.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

The only thing preventing this verbal clash from advancing into a violent one is Drishtya&#39;s restraint. Any simple flash could fire this conflict-

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Fine.&quot;//&lt;/span&gt;

...But it doesn&#39;t come, and the Priestess Regent takes a decision.

[[Continue|FA AtTheTemple2]]</tw-passagedata><tw-passagedata pid="571" name="FA AtTheTemple2" tags="" position="3531,1605" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;templeShrine&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chVal&quot;),getPresentCharByKey(&quot;chNer&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Yeah, fine, I&#39;m going to see Sillan.&quot;//&lt;/span&gt; Valtan declares as she begins to walk.

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;Leave immediately, Valtan.&quot;//&lt;/span&gt; But Nersmias stands in front of her.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Get out of my way! You have no right to forbid me to see her!&quot;//&lt;/span&gt; The Shapeshifter Candidate defies the priest with all the might of her gaze, angry as you have never seen her before.

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;No, you&#39;re the one who has renounced to any right to speak to her.&quot;//&lt;/span&gt; His eyes return the challenge, immovable.

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;What are you talking about!? Move away!&quot;//&lt;/span&gt;

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;You have hurt her.&quot;//&lt;/span&gt; He states, and Valtan freezes in place. &lt;span @style=$chNer.colorStyleKey&gt;//&quot;You were her dearest friend in the whole world, that&#39;s for certain. Not that you ever did anything to deserve it. You dragged her along in every of your petty plans, no matter whoever got hurt in the way, nor how much...&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;You... Have no idea...&quot;//&lt;/span&gt;

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;Someone so innocent, someone so pure, defiled by your selfishness, degraded by your debauchery. Always a tool at your disposal. But that isn&#39;t the most unfair side of this disgusting mess, is it?&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Shut up...&quot;//&lt;/span&gt;

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;The worst side of it all is that, in the end, the last person you got to hurt was her. Her chance to shine above everyone in our tribe, above everyone in the Valley, to have the sacred privilege to guide us closer to the Goddess, and you took it from her... The one person she trusted the most.&quot;//&lt;/span&gt;

&lt;span @style=$chVal.colorStyleKey&gt;//&quot;Just shut up...&quot;//&lt;/span&gt;

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;Leave.&quot;//&lt;/span&gt;

Valtan turns back towards the rest of you, and you see her eyes shut, and her cheeks full of tears.

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;And don&#39;t ever come back.&quot;//&lt;/span&gt;

[[Continue|FA AtTheTemple3]]</tw-passagedata><tw-passagedata pid="572" name="FA AtTheTemple3" tags="" position="3642,1601" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;templeStorage&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;Are you sure that&#39;s all you need?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;It is, Melesh, you have been very kind.&quot;//&lt;/span&gt;

You have set up camp at the Temple&#39;s storage, cramped between boxes and dizzied by the smell of salfis flowers. Valtan and Claw have hidden further inside between the wares, but you can clearly hear Valtan&#39;s sobs from time to time. When the group tried to appease her earlier, she wanted to hear nothing.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...It&#39;s been quite the troubling day.&quot;//&lt;/span&gt; Nashillbyir says.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;To put it mildly. This isn&#39;t exactly how I expected our first travel to be like. At least, I didn&#39;t expect so a few weeks ago.&quot;//&lt;/span&gt;

Maaterasu nods in silence, sometimes turning her head towards the corners where Valtan and Claw went to.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;At least, from now on, things can only get better...&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;...Let&#39;s hope so.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue|Personal Room]]&gt;&gt;&lt;&lt;script&gt;&gt;State.variables.personalRoom.initPersonalRoom();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="573" name="FA VaryontesOffer1" tags="" position="4099,1247" size="100,100">&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/nersmias-avatar.png]]
&lt;/div&gt; \

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;Leave.&quot;//&lt;/span&gt;

His words have pierced your defenses, stricken you where you expected it the least. You no longer have the power to keep on fighting, to keep on trying.

&lt;span @style=$chNer.colorStyleKey&gt;//&quot;And don&#39;t ever come back.&quot;//&lt;/span&gt;

You&#39;re unable to contain your weeping, and your eyes get flooded. You turn away and run, run, run as far away as your legs will let you. Which is nowhere, because you&#39;re not in the real world. None of this is real.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Aren&#39;t you having quite the interesting dream?&quot;//&lt;/span&gt; You hear from behind.

[[Continue|FA VaryonteOffer2]]
&lt;&lt;removeclass &quot;#right-ui-bar&quot; &quot;stowed&quot;&gt;&gt; \</tw-passagedata><tw-passagedata pid="574" name="FA VaryonteOffer2" tags="" position="4209,1245" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chGoddessHerald&quot;)]);
State.variables.StVars.check1 = gC(&quot;chPlayerCharacter&quot;).lust.max * 0.1;
gC(&quot;chPlayerCharacter&quot;).lust.current -= State.variables.StVars.check1;
State.variables.StVars.check1 = State.variables.StVars.check1.toFixed(1);
&lt;&lt;/script&gt;&gt; \
A phantom of fear races through your body, reminding you of the powerlessness this being has made you feel, how small and insignificant you see yourself next to her might and tricks, and you react without thinking. You call upon the power of the Goddess, and you throw everything you have against her.

You have lost &lt;span style=&quot;color:lightcoral&quot;&gt;//$StVars.check1 lust//&lt;/span&gt;.

She takes the whole hit. You catch a glimpse of pain in her face, but that&#39;s as far as it goes.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Weak.&quot;//&lt;/span&gt;

She doesn&#39;t hide her inconvenience, but she&#39;s as far as you could ever be from being maimed.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Were you expecting something else to happen?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s a holy attack, blessed by the Goddess... If it didn&#39;t hurt you...&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;A holy attack?&quot;//&lt;/span&gt; She smirks agitatedly, perhaps containing a whole laughter. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;There is nothing holy in this world.&quot;//&lt;/span&gt;

//Nothing... Holy?//

[[Continue|FA VaryonteOffer3]]</tw-passagedata><tw-passagedata pid="575" name="FA VaryonteOffer3" tags="" position="4316,1245" size="100,100">&lt;&lt;script&gt;&gt;State.variables.StVars.check2 = false;
if ( State.variables.StVarsList.contains(&quot;monActUs&quot;) ) {
State.variables.check2 = true;
}
&lt;&lt;/script&gt;&gt; \
&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Besides, is that the proper way to greet someone who has helped you get here? Given what I just saw in your mind, I thought you&#39;d be far happier to see someone willing to lend you a hand. Again.&quot;//&lt;/span&gt; &lt;&lt;if $StVars.check2 is true&gt;&gt;&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;It&#39;s not like you have contained yourself from using my gifts, either.&quot;//&lt;/span&gt;

//...That is true.//&lt;&lt;/if&gt;&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What do you want from me?&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;This isn&#39;t about what I want, but about what you need. You saw it, didn&#39;t you? His hypnosis.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What are you talking about?&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Don&#39;t tell me... You didn&#39;t notice?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I think I didn&#39;t.&quot;//&lt;/span&gt;

Varyonte sighs, and extends both hands to her sides, facing upwards. Above them, two familiar faces take shape out of thing fog.

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/nersmias-avatar.png]] [img[img/portraits/val-avatar.png]]
&lt;/div&gt; \

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;When the Shapeshifter Candidate was arguing with that priest... They never stopped looking at each other. The Candidate went into that fight confident and full of herself, but she ended up defeated, broken, at the verge of tears.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But that&#39;s because Nersmias made her see herself as someone horrible, someone who had betrayed someone she holds dear.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;And why should he be able to do that? Is the Candidate&#39;s link with her friend so weak that someone&#39;s words would undermine her confidence so easily? Does she look like the kind of person who&#39;d let herself be defeated by words, at such an important moment?&quot;//&lt;/span&gt;

//She has a point... But it&#39;s also true that Valtan went through a lot yesterday.//

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;You seem undecided. Let me be clear: if you intend to go over that priest, you need my help.&quot;//&lt;/span&gt;

[[I will do it without you|FA VaryonteOffer WithoutYou]]
[[What are you offering?|FA VaryonteOffer WhatDoYouOffer]]
[[This isn&#39;t my fight|FA VaryonteOffer NotMyFight]]</tw-passagedata><tw-passagedata pid="576" name="FA VaryonteOffer WithoutYou" tags="" position="4096,1357" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Whatever it is I&#39;ll have to face, I&#39;ll do it without your help.&quot;//&lt;/span&gt;

&lt;&lt;if $StVars.check2 is true&gt;&gt;&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Oh, my. Mighty words, coming from you.&quot;//&lt;/span&gt; She chuckles.&lt;&lt;else&gt;&gt;&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Sticking to your pride?&quot;//&lt;/span&gt; She smirks.&lt;&lt;/if&gt;&gt; &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Don&#39;t you understand the situation of that Shapeshifter? She&#39;s only now starting to realize the consequences of her actions, of how utterly alone she is. She hasn&#39;t just become a pariah among her own people, she&#39;s completely lost the person who mattered the most to her, the one she thought she was sacrificing her old life for. The one thing she needs in her life is her friend to come back to her... And you&#39;re telling me that you&#39;d refuse my offer to help?&quot;//&lt;/span&gt;

//That&#39;s not...//

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;What is it that moves you? Your pride? Fear? Or is it... That you&#39;re insecure on whether you&#39;re able to make it on your own? That you need to prove to yourself that  you don&#39;t need my help?&quot;//&lt;/span&gt;

//...//

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;And you would put any of those petty feelings over what that Shapeshifter needs?&quot;//&lt;/span&gt;

[[Ask about her offer|FA VaryonteOffer WhatDoYouOfferAlt]]
[[Reject her again|FA VaryonteOffer WithoutYouPlus]]</tw-passagedata><tw-passagedata pid="577" name="FA VaryonteOffer WhatDoYouOffer" tags="" position="4094,1464" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...What are you offering?&quot;//&lt;/span&gt;

Varyonte dedicates you a clear smile as she hears your response.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I will fortify your willpower, making you stronger against suggestion and hypnosis - and to many kinds of magic, to some extent.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...You&#39;re willing to do that? Why?&quot;//&lt;/span&gt; You ask perplexed. //Would this woman really make me more resilient against one of her own powers?//

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Because I want to see you thrive, plain and simple.&quot;//&lt;/span&gt;

[[Accept the boon|FA VaryonteOffer AcceptBoon]]
[[Reject the offer|FA VaryonteOffer RejectOffer]]</tw-passagedata><tw-passagedata pid="578" name="FA VaryonteOffer NotMyFight" tags="" position="4428,1245" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And who told you that I intend to take a part in this mess? This isn&#39;t my fight.&quot;//&lt;/span&gt;

Varyonte&#39;s eyes open wide, her astonishment almost catching you by surprise.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Hoo? We&#39;ve got quite the cold-hearted witch.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m not going to help Valtan here, so I don&#39;t need your help. It&#39;s just that simple. Now leave me be.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Hehehe... Have it as you wish.&quot;//&lt;/span&gt;

Without further arguing, she snaps her fingers, and you wake up.

[[Continue|FA SecondDay Start]]</tw-passagedata><tw-passagedata pid="579" name="FA VaryonteOffer AcceptBoon" tags="" position="4318,1350" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...I accept.&quot;//&lt;/span&gt; //Despite whatever it is you&#39;re hiding from me.//

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Good girl.&quot;//&lt;/span&gt;

She places a hand on your forehead, casting magic through it. Your muscles tighten involuntarily, your veins become tense, your vision gets cloudy. You feel your mind being touched.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nnggh...&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Don&#39;t resist, accept it.&quot;//&lt;/span&gt;

You do your best to relax, much against the best efforts of your body. In the end, you gasp, freeing yourself from the tension, your blood allowed to run again, your senses returning to you in full.

//Your willpower has risen by 5.//
//Your resistance to hypnosis has risen by 50.//
You lost &lt;span style=&quot;color:limegreen&quot;&gt;//10 energy//&lt;/span&gt;.
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;//10 willpower//&lt;/span&gt;.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;There you go... All ready to put up a fight. You may feel dizzy now, but you will be far more focused in a few minutes.

...Still recovering your breath? That&#39;s fine, you can thank me later. I wouldn&#39;t want you to be late to the matters you have to attend to.&quot;//&lt;/span&gt;

Varyonte snaps her fingers, and you wake up.

[[Continue|FA SecondDay Start]]
&lt;&lt;script&gt;&gt;
applyAlteredState([&quot;chPlayerCharacter&quot;],createHypnosisResistanceBoon());
addCharsSpecialExperience(&quot;chPlayerCharacter&quot;,&quot;VarDom&quot;,10);
State.variables.chPlayerCharacter.energy.current -= 10;
State.variables.chPlayerCharacter.willpower.current -= 10;
&lt;&lt;/script&gt;&gt; \</tw-passagedata><tw-passagedata pid="580" name="FA VaryonteOffer RejectOffer" tags="" position="4317,1457" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;No, I won&#39;t accept.&quot;//&lt;/span&gt;

The winged woman raises an eyebrow, certainly not expecting this response.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Fine. But you won&#39;t be able to come back crying to me when your companion ends up broken, a hollow shell of her former shell.&quot;//&lt;/span&gt;

Dedicating you a frustrated expression, she snaps her fingers, and you wake up.

[[Continue|FA SecondDay Start]]</tw-passagedata><tw-passagedata pid="581" name="FA SecondDay Start" tags="" position="4431,1349" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;templeStorage&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I will discuss everything with the judges, keep things under control...&quot;//&lt;/span&gt; You groggily hear from your bed, your mind still recovering orientation. There are faint voices coming from the back of the storage.

&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;I will be there with you. There are a few who are restless right now, but we can smooth-talk enough of them to turn things in our favour.&quot;//&lt;/span&gt;

In front of Drishtya, there&#39;s an old Shapeshifter woman with somewhat familiar robes.

&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;You woke up already? Your name was $chPlayerCharacter.name, right?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It is... And who are you?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;Hmm? Oh, sorry, perhaps you&#39;ll recognize me with this face?&quot;//&lt;/span&gt; The woman&#39;s body and face rapidly change shapes to those of a man.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Melesh?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumaquamarine&quot;&gt;//&quot;I&#39;m glad to hear you remember my name.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Melesh feels the need to change his looks... Basically on a daily basis. But we can discuss it later. You should get going, everyone else is outside, about to leave.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Fine. I hope things go smoothly in the tribe.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;I&#39;m sure they will. But don&#39;t save on efforts to fall on their good side. Do your best to get in touch with our customs, to learn about our home. You will find people who will teach you, one way or another.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Understood.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:mediumvioletred&quot;&gt;//&quot;Now, if you excuse us...&quot;//&lt;/span&gt;

[[Continue|FA SecondDay Start2]]</tw-passagedata><tw-passagedata pid="582" name="FA VaryonteOffer WithoutYouPlus" tags="" position="4209,1352" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I don&#39;t need to tell you my reasons, the answer is still no.&quot;//&lt;/span&gt;

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Foolish child.&quot;//&lt;/span&gt; Varyonte rolls her eyes, annoyed. &lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Fine. But you won&#39;t be able to come back crying to me when your companion ends up broken, a hollow shell of her former shell.&quot;//&lt;/span&gt;

She snaps her fingers, and you wake up.

[[Continue|FA SecondDay Start]]</tw-passagedata><tw-passagedata pid="583" name="FA VaryonteOffer WhatDoYouOfferAlt" tags="" position="4206,1459" size="100,100">&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...What are you offering?&quot;//&lt;/span&gt;

Varyonte dedicates you a clear smile as she hears your response, victorious on your backing down.

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;I will fortify your willpower, making you stronger against suggestion and hypnosis - and to many kinds of magic, to some extent.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...You&#39;re willing to do that? Why?&quot;//&lt;/span&gt; You ask perplexed. //Would this woman really make me more resilient against one of her own powers?//

&lt;span @style=$chGoddessHerald.colorStyleKey&gt;//&quot;Because you need it.&quot;//&lt;/span&gt;

[[Accept the boon|FA VaryonteOffer AcceptBoon]]
[[Reject the offer|FA VaryonteOffer RejectOffer]]</tw-passagedata><tw-passagedata pid="584" name="FA 0.3.3 early ending" tags="saveAllowed" position="3639,1735" size="100,100">&lt;&lt;script&gt;&gt;setPasChars([]);
State.variables.eventsCalendar.activeEvent = false;
State.variables.logL1 = [];
&lt;&lt;/script&gt;&gt; \
You have reached the end of the current story of the first adventure! It is advised to keep a separate savefile at this passage to continue playing from here in future versions.

At the moment, you can choose between continuing the game through the intended path, which will allow you to freely roam the maps of the Gleaming Caverns (which have a few actions available, but no story content) and skipping to a separate passage that will take you to the main game loop, right after you choose which secondary characters you want to bring to the Temple as guests.

&lt;span style=&quot;color:green&quot;&gt;You can save the game!&lt;/span&gt;

&lt;&lt;link [[Don&#39;t skip time, explore the Gleaming Caverns maps|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.eventsCalendar.newDayScript();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Skip a week and choose which characters you&#39;ll bring to the Passion Temple|FA 0.3.3 SkipToPassionTemple]]&gt;&gt;&lt;&lt;script&gt;&gt;State.variables.activeSimulationCharacters = [&quot;chPlayerCharacter&quot;,&quot;chVal&quot;,&quot;chNash&quot;,&quot;chMir&quot;,&quot;chAte&quot;,&quot;chClaw&quot;];&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="585" name="FA 0.3.3 SkipToPassionTemple" tags="" position="3754,1737" size="100,100">Selecting characters to bring to the Temple

Active characters (variable names, meanings below): $activeSimulationCharacters

&lt;&lt;link [[The characters above are fine, proceed to the Temple|Personal Room]]&gt;&gt;&lt;&lt;script&gt;&gt;State.variables.daycycle.month = 2;
State.variables.daycycle.day = 4;
finishGleamingCavernsAdventure();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

&lt;&lt;link [[Add Artume|FA 0.3.3 SkipToPassionTemple]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chArt&quot;) == false ) {
State.variables.activeSimulationCharacters.push(&quot;chArt&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Hope|FA 0.3.3 SkipToPassionTemple]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chHope&quot;) == false ) {
State.variables.activeSimulationCharacters.push(&quot;chHope&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Rock|FA 0.3.3 SkipToPassionTemple]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chRock&quot;) == false ) {
State.variables.activeSimulationCharacters.push(&quot;chRock&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Sillan|FA 0.3.3 SkipToPassionTemple]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chSil&quot;) == false ) {
State.variables.activeSimulationCharacters.push(&quot;chSil&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Nersmias|FA 0.3.3 SkipToPassionTemple]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chNer&quot;) == false ) {
State.variables.activeSimulationCharacters.push(&quot;chNer&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Add Mesquelles|FA 0.3.3 SkipToPassionTemple]]&gt;&gt;&lt;&lt;script&gt;&gt;
if ( State.variables.activeSimulationCharacters.includes(&quot;chMes&quot;) == false ) {
State.variables.activeSimulationCharacters.push(&quot;chMes&quot;);
}
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;

Variables names:
chPlayerCharacter: Player Character
chNash: Nashillbyir
chMir: Padmiri
chVal: Valtan
chAte: Maaterasu
chClaw: Claw
chArt: Artume
chHope: Hope
chRock: Rock
chSil: Sillan
chNer: Nersmias
chMes: Mesquelles</tw-passagedata><tw-passagedata pid="586" name="FA SecondDay Start2" tags="" position="4426,1459" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;templeShrine&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chNash&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chAte&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
You take the exit to the outskirts of the Temple, and you find Claw, Padmiri, Nashillbyir and Maaterasu.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Morning... It is morning, right?&quot;//&lt;/span&gt; You ask raising your eyes, trying to find the Sun in the ceiling of the Caverns.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Sure it is. Probably.&quot;//&lt;/span&gt; Nashillbyir frees you not of your doubt.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Where&#39;s Valtan?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;She woke up and left while we were sleeping.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And you have no idea where she went to...&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;No one went after her, so no.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Now that all of us are here... What will we do with Nersmias?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;About that-&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Take it off me, take it off!&quot;//&lt;/span&gt; A wild voice down the streets interrupts you. Since it sounds like an emergency, you all part with haste to find out what&#39;s it about.

[[Continue|FA SecondDay Start3]]</tw-passagedata><tw-passagedata pid="587" name="FA SecondDay Start3" tags="" position="4537,1244" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;mainStreet2&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chNash&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
Around the center of the town, a crowd of Shapeshifters has gathered around something. Your group has little issue to make their way through the people, and what you find is frankly dissapointing.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;It&#39;s attacking me! It won&#39;t let go!&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;We can&#39;t do anything if you don&#39;t calm down first...&quot;//&lt;/span&gt; A passerby comments.

A woman is flailing her robes around. Her purpose: to kick out a rat that has clawed into them, probably more scared than the woman herself. Your Beastkin companion lets out a sound snort, and calmly walks towards them.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;STOP MOVING!!!&quot;//&lt;/span&gt; She lashes out in a sudden turn.

Both the woman and the rat freeze in place, and Claw quickly grabs the rat by its back. When she takes it off the woman&#39;s clothes, her robes stay attached to the rat&#39;s paws.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Stop pulling! Everyone is going to see my private parts!&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;But you go to the public baths every day...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Fine.&quot;//&lt;/span&gt; Without further consideration, the Beastkin respects the wishes of the woman and tears the patch of cloth that the rat is holding, separating them at last.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Nooo! Don&#39;t torn my clothes!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;She&#39;s certainly hard to please...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Let&#39;s take it out of the village.&quot;//&lt;/span&gt;

[[Continue|FA SecondDay Start4]]</tw-passagedata><tw-passagedata pid="588" name="FA SecondDay Start4" tags="" position="4536,1352" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;mainStreet3&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chMir&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
At the edge of the tribe, Claw crouches and lets the frightened rat go, but then and only then you all notice that the rat has difficulty to walk.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Is it limping?&quot;//&lt;/span&gt;

Claw grabs the rat again, much to its agony, and inspects its paws.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Blazes, what is this thing?&quot;//&lt;/span&gt; Everyone, including the few tribespeoples who are still curious about the Candidates, lean their heads towards the rat, trying to see what&#39;s so surprising. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;A pointed pebble has pierced one of its hind legs.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Oh, no...&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;And it&#39;s a large one as well. If I take it out, it&#39;ll bleed to death. It&#39;s clear that it won&#39;t make it very far, so I&#39;m going to...&quot;//&lt;/span&gt; Claw moves back her free hand, taking aim to deal a fatal blow to the creature.

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Hold on!&quot;//&lt;/span&gt; One of the curious Shapeshifters shouts, running towards Claw. &lt;span @style=$chMes.colorStyleKey&gt;//&quot;There&#39;s another way.&quot;//&lt;/span&gt;

&lt;div align=&#39;center&#39;&gt;\
[img[img/portraits/mesquelles-full.png]]
&lt;/div&gt; \

A barrage of bright pinks and reds are shot against your eyes, the woman in front of you being a giant magnet for attention. Her hair waves around freely as it tries to keep on with her long steps, flying almost as wildly as the wind. Her clothes are tight and humble in their dimensions, but boastful of the wearer&#39;s figure. It is hard to explain how this woman didn&#39;t stand up among the previous crowds you&#39;ve seen.

[[Continue|FA SecondDay Start5]]</tw-passagedata><tw-passagedata pid="589" name="FA SecondDay Start5" tags="" position="4536,1457" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;mainStreet3&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chMes&quot;),getPresentCharByKey(&quot;chClaw&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chMes.colorStyleKey&gt;//&quot;I may be able to heal the animal. Would you bring it closer to me?&quot;//&lt;/span&gt;

Claw inspects the Shapeshifter, wary as always, but promptly decides to present the rat. The pink woman takes a closer look at the injured leg, then envolves it whole with one of her hands. The rat attempts to revolve around, but it is humbled down when Claw tightens her grip on its back. A faint pink fog is formed around the stranger&#39;s hands, clouding everyone&#39;s vision - even though your heads are getting closer and closer by the moment, desiring to see what&#39;s happening.

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;There.&quot;//&lt;/span&gt;

The Shapeshifter moves her hands away, the fog dissolves. She points to the leg of the rat with a palm, showing it perfectly healthy, then displays the pointed pebble in her other hand. Everyone&#39;s faces cringe a little when they find it to be bathed in blood, including the stranger&#39;s. But the rat squeaks and shakes its legs, full of vitality.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Greatly done, Mesquelles!&quot;//&lt;/span&gt; Someone in the crowd shouts, revealing her name, along with some applause.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That was great! How did you do it?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;It was... Transformation magic?&quot;//&lt;/span&gt; Maaterasu guesses.

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;The Aiishen is correct! I&#39;m learning to practice transformation magic, it&#39;s a wonderful art.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Transformation magic...? Didn&#39;t Drishtya use it, a few weeks ago?&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;She did. The Ritual of Avatars involves a lot of transformation magic. Though the execution was different...&quot;//&lt;/span&gt;

[[Continue|FA SecondDay Start6]]</tw-passagedata><tw-passagedata pid="590" name="FA SecondDay Start6" tags="" position="4644,1244" size="100,100">&lt;&lt;script&gt;&gt;setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;mainStreet3&quot;);&lt;&lt;/script&gt;&gt; \
&lt;&lt;script&gt;&gt;setPasChars([getPresentCharByKey(&quot;chMes&quot;),getPresentCharByKey(&quot;chMir&quot;),getPresentCharByKey(&quot;chAte&quot;)]);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Isn&#39;t there something that sounds off here...?&quot;//&lt;/span&gt; Padmiri wonders.

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;I must mention it: I&#39;m glad to meet the Candidates of the Passion Temple, and so closely. My name is Mesquelles, as you have just heard.&quot;//&lt;/span&gt;

Everyone in your group introduces themself to Mesquelles.

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Now I get what&#39;s wrong. Why would a Shapeshifter learn transformation magic? If there&#39;s someone who won&#39;t ever need it, it&#39;s your tribe.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Why would someone learn the amatory arts? For the sake of beauty, of course. The world is a canvas to be filled with our creativity, with our ideas, and I&#39;ve merely chosen an unusual brush to master.&quot;//&lt;/span&gt;

&lt;span @style=$chAte.colorStyleKey&gt;//&quot;Transformation magic is one of the hardest forms of magic to cast properly. You must be very talented.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Terribly dedicated to my passion, I&#39;d say. Besides, transformation magic is easier for Shapeshifters to learn. In truth, it is just a different form of our natural skills.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Do not be so modest, girl,&quot;//&lt;/span&gt; an aged man intervenes, &lt;span style=&quot;color:gray&quot;&gt;//&quot;in all of my years, never would I have imagined myself transforming any other living being, much less at my age.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;I also have my teacher to thank. I could have never been able to do it alone.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;Who is your teacher?&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;A kind hermit who lives close to the entrance of the Caverns, you should come to visit.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;He&#39;s an odd one, for sure. Living by himself for so many years...&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;He prefers to live closer to the wildlife outside of the Caverns, that&#39;s all. Speaking of which...&quot;//&lt;/span&gt; She takes the rat off the hands of Claw, who had kept the poor animal within her grasp for all this time. &lt;span @style=$chMes.colorStyleKey&gt;//&quot;Since I&#39;m going to see him, I might as well take this little thing to the exit. We wouldn&#39;t want it to get lost.&quot;//&lt;/span&gt;

&lt;span @style=$chMir.colorStyleKey&gt;//&quot;It was a pleasure to meet you.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Likewise! I hope we see each other again during these days.&quot;//&lt;/span&gt;

[[Early ending|FA 0.3.3 early ending]]</tw-passagedata><tw-passagedata pid="591" name="FASE BbC Start" tags="" position="4761,1245" size="100,100">$customRoomIntro
Your heart jumps out of your chest, your throat shrunken like that of a child who&#39;s been caught during their mischief. You turn around like a scared cat who&#39;s just noticed a tiger about to prey on them, and you find Claw, casting a severe expression upon you.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;What would they think if they found out you&#39;re spying on them having sex in private? What would the word be around the tribe?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;m too far away to be recognized, I wouldn&#39;t be found.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;And we&#39;ve got a prize for the flimsiest excuse of the day. How can you say that with a straight face when you&#39;ve just been caught?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;By you, not by them... And you don&#39;t want the Shapeshifters to lump us all together, right?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Right, I don&#39;t... So I think it&#39;s high time for you to receive some discipline, to make sure you won&#39;t repeat this mistake. Turn around, and get on all fours, or I&#39;ll tell everyone about what you just did.&quot;//&lt;/span&gt;

[[Obey Claw|FASE BbC Obey]]
[[Refuse and leave|FASE BbC Refuse]]
&lt;&lt;if $StVars.check1 &gt; 44&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Empathy AND intelligence AND will check: passed.&lt;/span&gt;
[[Blackmail her back|FASE BbC Fight]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Empathy AND intelligence AND will check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="592" name="FASE BbC Obey" tags="" position="4989,1253" size="100,100">$customRoomIntro
Your ears catch the faint noise of your teeth gritting, a result of the time it takes for your mind to reach a resolution.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Well?&quot;//&lt;/span&gt; Claw asks with the tone of a warning.

You turn around, your waist falls back, and you get on your knees, aparting yourself from the cliff. Then you feel a hand on your neck, forcing you to move forwards.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;No, move closer to the edge.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;If I do they&#39;ll be able to see me! Wasn&#39;t the whole point of this to punish me for endangering the Temple with my recklessness?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;It is, but you&#39;ll learn your lesson better if you&#39;re running the risk of those strangers below watching the dumb face you make when I fuck your brains out.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You&#39;re just making up excuses to make me do what you want! Yipp!&quot;//&lt;/span&gt; You shout in response to a sudden spank in your bottom.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Less complaining, more sticking your ass out. And don&#39;t shout too much if you don&#39;t want anyone to turn their heads here.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue|Scene]]&gt;&gt;
&lt;&lt;script&gt;&gt;
bbCdommedByClaw(&quot;FASE BbC Obey Result&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="593" name="FASE BbC Refuse" tags="" position="4764,1358" size="100,100">$customRoomIntro
//This is bad. Real bad. I can&#39;t let her get her way with me with this blackmail...//

You look around nerviously. The orography of the ridge has put you in a seriously complicated spot, as Claw is blocking your only way out of here.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Oh, no, you won&#39;t.&quot;//&lt;/span&gt; She sentences as she begins approaching you, closing the gap that separates you.

//She&#39;s read what I was planning!?//

You&#39;ve ran out of time, if you&#39;re going to run away, you have to do it now. You take impulse and sprint towards her flank...

&lt;&lt;if $StVars.check2 &gt; 59&gt;&gt; \
[[Continue|FASE BbC Refuse Success]]
&lt;&lt;else&gt;&gt; \
[[Continue|FASE BbC Refuse Failure]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="594" name="FASE BbC Fight" tags="" position="4879,1248" size="100,100">$customRoomIntro
//Does she really have an upper hand here, though?//

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Well?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You will tell everyone? And what if say it was you who was spying on them, instead?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Huh?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What proof do you have, your word? Well, so do I. So I&#39;ll just go and propagate the same rumours about you.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You&#39;d drop such bold lies? I didn&#39;t take you for that type of person. ...What am I saying? It&#39;s an obvious bluff, there&#39;s no way you&#39;d do that.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Right, I wouldn&#39;t. So I&#39;ll just be on my way to totally not tell everyone about how I&#39;ve found you here, presumably to violate the Shapeshifters&#39; intimacy.&quot;//&lt;/span&gt;

You step forward, but Claw stands in your way. She isn&#39;t going to let you go that easily.

&lt;&lt;link [[Fight|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;bbCfightingClaw();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="595" name="FASE BbC Refuse Success" tags="" position="4764,1465" size="100,100">$customRoomIntro
As it couldn&#39;t be any other way, the Beastkin attempts to block you, stepping in front of you and getting ready to pounce against you-

&lt;span style=&quot;color:green&quot;&gt;Physique AND agility AND perception AND luck check: passed.&lt;/span&gt;

-but you manage to jump down just in time. Falling on your back hurts you greatly, but get a glimpse of Claw&#39;s horrified face as she realizes that her jump has been a grave mistake.

Like a flying fish that has just jumped straight into a pelican&#39;s open mouth, Claw falls down the cliff. You hear her splashing against the water, certifying her demise, and a couple of surprised screams immediately follow.

You decide to leave the place immediately, before anyone can find about your involvement in the incident.

//Claw&#39;s respect in the Shapeshifter tribe has fallen greatly.
The Shapeshifter&#39;s tribe respect for the Passion Temple has fallen.//
//You lost &lt;span style=&quot;color:limegreen&quot;&gt;5 energy&lt;/span&gt;.//
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Claw has grown slightly.&lt;/span&gt;

&lt;&lt;link [[Continue|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chClaw.ssRsp -= 50;
State.variables.tribes.ssRpt -= 20;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 150;
State.variables.compass.moveCharsToRoom([&quot;chClaw&quot;],&quot;unionLakeWest&quot;);
applyBarDamage(&quot;chPlayerCharacter&quot;,&quot;energy&quot;,-5);
applyBarDamage(&quot;chClaw&quot;,&quot;energy&quot;,-25);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="596" name="FASE BbC Refuse Failure" tags="" position="4762,1575" size="100,100">$customRoomIntro
As it couldn&#39;t be any other way, the Beastkin attempts to block you, stepping in front of you and getting ready to pounce against you-

&lt;span style=&quot;color:red&quot;&gt;Physique AND agility AND perception AND luck check: failed.&lt;/span&gt;

-and you receive the tackle in its entirety, pushing you back so hard that you seem to believe that you&#39;re falling off the cliff.

//Wait, I&#39;m actually falling-//

The lake below you welcomes you with a painful splash, alerting everyone around of your presence, as a couple of surprised screams make fairly clear. Once you overcome the shock of the fall, you realize that the pain isn&#39;t big enough to prevent you from moving freely, and you decide to leave as soon as possible.

You send a last glance to the platform above, and find that Claw had good enough sense to make herself scarce before you could point at her.

//Your respect in the Shapeshifter tribe has fallen greatly.
The Shapeshifter&#39;s tribe respect for the Passion Temple has fallen.//
//You lost &lt;span style=&quot;color:limegreen&quot;&gt;25 energy&lt;/span&gt;.//
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Claw has grown slightly.&lt;/span&gt;

&lt;&lt;link [[Continue|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.ssRsp -= 50;
State.variables.tribes.ssRpt -= 20;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 150;
State.variables.compass.moveCharsToRoom([&quot;chPlayerCharacter&quot;],&quot;unionLakeWest&quot;);
applyBarDamage(&quot;chClaw&quot;,&quot;energy&quot;,-5);
applyBarDamage(&quot;chPlayerCharacter&quot;,&quot;energy&quot;,-25);&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="597" name="FASE BbC Obey Result" tags="" position="4992,1363" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You.. Were trying to make them notice me!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;And it was well deserved, I&#39;d say.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And all that about protecting the reputation of the Temple? What a load of rubbish! You just wanted to humilliate me!&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Call it humilliation, call it disciplining, it&#39;s all the same to me.&quot;//&lt;/span&gt; She replies, unfazed from your accusations. &lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You better remember about this for the next time you decide to do something foolish.&quot;//&lt;/span&gt;

//&quot;I won&#39;t forget it... And I&#39;ll serve it back to you, you can be certain.&quot;// You avoid saying out loud.

//&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Claw has grown.&lt;/span&gt;//

&lt;&lt;link [[Continue|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 300;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 100;
State.variables.chPlayerCharacter.relations.chClaw.submission.stv += 300;
State.variables.chClaw.relations.chPlayerCharacter.domination.stv += 300;&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="598" name="FASE BbC Fight Victory" tags="" position="4880,1465" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You sure talk a lot for how little of a fight you can put up.&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Hah... Screw you.&quot;//&lt;/span&gt;

Claw lies before you, defeated and unable to keep resisting.

[[Make her taste her own medicine|FASE BbC Victory Punishment]]
[[Pardon Claw|FASE BbC Victory Merciful]]</tw-passagedata><tw-passagedata pid="599" name="FASE BbC Fight Defeat" tags="" position="4881,1357" size="100,100">$customRoomIntro
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Nngh... So, that was it?&quot;//&lt;/span&gt;

You stand silent, unable to keep resisting.

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Are you done with your little tantrum?&quot;//&lt;/span&gt; She insists.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes... I guess you win.&quot;//&lt;/span&gt; 

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Then don&#39;t make me repeat myself and get yourself ready.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Claw has grown.&lt;/span&gt;//

&lt;&lt;link [[Get on all fours|Scene]]&gt;&gt;
&lt;&lt;script&gt;&gt;
bbCdommedByClaw(&quot;FASE BbC Obey Result&quot;);
State.variables.chPlayerCharacter.relations.chClaw.submission.stv += 300;
State.variables.chClaw.relations.chPlayerCharacter.domination.stv += 300;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="600" name="FASE BbC Dommed Claw" tags="" position="4986,1575" size="100,100">$customRoomIntro
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;You didn&#39;t hold back, you little... Were you trying to get me caught?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It would have been an insipid revenge otherwise, don&#39;t you think?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;Tsch. Let me go already, you&#39;ve had what you wanted.&quot;//&lt;/span&gt; She demands, hiding her shame in an attempt to finish this situation as soon as possible.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sure, I&#39;ll let you go...&quot;//&lt;/span&gt; You approach her head, and whisper next to her ear: &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But I&#39;m not leaving your mind for the rest of the day.&quot;//&lt;/span&gt;

She shakes, angry at the realization that you&#39;re right. Her damaged pride will not let her think about anything else for a while. Despite that, she leaves without any more of a fuss after you let her.

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Claw has grown.&lt;/span&gt;
&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Claw has grown.&lt;/span&gt;//

&lt;&lt;link [[Continue|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv += 100;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv += 300;
State.variables.chPlayerCharacter.relations.chClaw.domination.stv += 300;
State.variables.chClaw.relations.chPlayerCharacter.submission.stv += 300;&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="601" name="FASE BbC Victory Punishment" tags="" position="4992,1466" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;So... What was what you were ordering me to do a few minutes ago?&quot;//&lt;/span&gt; You ask as you get closer to Claw and grab the back of her neck. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Getting closer to the edge...&quot;//&lt;/span&gt; You apart your eyes towards the cliff. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And get on all fours?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt; The beastkin&#39;s expression is an open book: she&#39;s clearly tasting the humilliation, the defeat, feeling powerless at your mercy. She&#39;s all but comfortable.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Looks like a fitting punishment for trying to blackmail me, don&#39;t you think?&quot;//&lt;/span&gt;

Not uttering a single word, Claw starts moving towards the edge of the cliff. You allow her to, and follow close behind.

&lt;&lt;link [[Continue|Scene]]&gt;&gt;
&lt;&lt;script&gt;&gt;
bbCdommingClaw(&quot;FASE BbC Obey Result&quot;);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="602" name="FASE BbC Victory Merciful" tags="" position="4878,1572" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You know what? I&#39;m going to let you go. Just this once.&quot;//&lt;/span&gt;

She returns your gaze with clear skepticism. 
&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...You&#39;re serious?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Sure. I&#39;m going to be extra generous: I&#39;m even going to believe that you were truly doing this for the sake of the Temple. But return me the favor and behave yourself from now on, alright?&quot;//&lt;/span&gt;

&lt;span @style=$chClaw.colorStyleKey&gt;//&quot;...Fine.&quot;//&lt;/span&gt; She replies simply, any other words she may have in her mind choking on her throat. She leaves calmly, not just about to disturb you again.

//&lt;span style=&quot;color:khaki&quot;&gt;Your friendship with Claw has slightly grown.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your submission towards Claw has diminished.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your rivalry with Claw has diminished.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your enmity with Claw has diminished.&lt;/span&gt;
Claw&#39;s drives have grown less favorable towards domination.
Claw owes you extra favour.//

&lt;&lt;link [[Continue|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.relations.chClaw.friendship.stv += 150;
State.variables.chClaw.relations.chPlayerCharacter.friendship.stv += 150;
State.variables.chPlayerCharacter.relations.chClaw.rivalry.stv -= 250;
State.variables.chClaw.relations.chPlayerCharacter.rivalry.stv -= 250;
State.variables.chPlayerCharacter.relations.chClaw.enmity.stv -= 250;
State.variables.chClaw.relations.chPlayerCharacter.enmity.stv -= 250;
State.variables.chPlayerCharacter.relations.chClaw.submission.stv -= 250;
State.variables.chClaw.relations.chPlayerCharacter.domination.stv -= 250;
addPointsToDrive(gC(&quot;chClaw&quot;).dDomination,-100);
payFavorDebt(&quot;chClaw&quot;,&quot;chPlayerCharacter&quot;,3);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="603" name="FASE Crafting a Dildo" tags="" position="5103,1252" size="100,100">$customRoomIntro
As the hours go by molding the clay, you become used to the process and it becomes a mechanical task, but a time-consuming one nonetheless. Your mind cannot avoid jumping from one idea to another, and it goes over the situation of this tribe, your first encounters with monsters, your relationships with the other Candidates, and...

//Could I actually make something a bit more interesting with this?//

Rather than the usual square or rectangle, you make a long cylinder, slightly bent along its length and funnily crowned at both its ends.

//Wait, this is too obvious, right?//

You move your chair to put yourself between your creation and everyone else in the room - you don&#39;t want anyone else to see you making a &quot;tile&quot; this phallic.

As soon as the shapeshifter using the oven leaves, you take your piece and place it on the plate above the flames. Drying the clay is fundamental for it to turn properly solid, and it must be done with great patience, as rushing the process may provoke the piece to end up cracked. However, you deem not being caught as more important than doing things safely, so you cast embers into the oven to speed things up.

When you notice someone approaching the furnace, you infuse the clay with ice, confident in your decision that you&#39;ve waited enough. You take it in your hands and hastily walk away, offering a tense smile to the hopefully unaware shapeshifter, as you gulp down your throat the heat in your hands.

[[Run away to the workshops&#39; warehouse|FASE Crafting a Dildo 2]]</tw-passagedata><tw-passagedata pid="604" name="FASE Crafting a Dildo 2" tags="" position="5102,1362" size="100,100">$customRoomIntro
&lt;&lt;script&gt;&gt;State.variables.chPlayerCharacter.willpower.changeValue(-40);
State.variables.chPlayerCharacter.energy.changeValue(-20);
if ( gC(&quot;chPlayerCharacter&quot;).willpower.current &lt; 0 ) { gC(&quot;chPlayerCharacter&quot;).willpower.current = 0; }
if ( gC(&quot;chPlayerCharacter&quot;).energy.current &lt; 0 ) { gC(&quot;chPlayerCharacter&quot;).energy.current = 0; }&lt;&lt;/script&gt;&gt; \
Your eyes are filled with tears and you have to kick the floor, but you&#39;ve resisted the burning hot clay and successfully taken your creation to the warehouse.

//Goddess, what a disaster. After rushing the drying so much, it&#39;ll be a miracle if this doesn&#39;t have over a dozen cracks...// You think as you regret that you might have acted a little too carelessly. However, as you examine the piece, you find it to be on a suspiciously good state. You place a finger on it, worried that it may still be somewhat malleable, but the texture is, indeed, solid and hardy. ...Too hardy, perhaps.

//This is too rough to the touch. Could I have something around here to cover it...?//

Fortune smiles at you once again, and soon after you begin thrashing around in the warehouse, you find some silk fabrics gentle with the skin and decently permeable. You boldly decide to take them borrowed for the rest of your life and turn them into the wrapper of your new toy.

//You have gained a Dildo.//

//You lost &lt;span style=&quot;color:limegreen&quot;&gt;20 energy&lt;/span&gt;.
You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;40 willpower&lt;/span&gt;.//

[[Leave|Map]]
&lt;&lt;link [[Equip the dildo and leave|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;
unequipToolTypeFromChar(&quot;weaponID&quot;,&quot;chPlayerCharacter&quot;);
equipObjectOnWearer(State.variables.StVars.check1,&quot;chPlayerCharacter&quot;,-1);
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;&lt;span title=&quot;Weapon. Increases physique and agility, as well as sex strength and weakness. Provides with several actions in sex and combat scenes.&quot;&gt;^^(?)^^&lt;/span&gt;
&lt;&lt;link [[Play with it|FASE Dildo Play 1]]&gt;&gt;&lt;&lt;script&gt;&gt;
&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;&lt;span title=&quot;You may also do this at a later time.&quot;&gt;^^(?)^^&lt;/span&gt;</tw-passagedata><tw-passagedata pid="605" name="FASE Dildo Play 1" tags="" position="5103,1468" size="100,100">&lt;&lt;script&gt;&gt;
initializeFaSeDildoPlay();
&lt;&lt;/script&gt;&gt; \ 
$customRoomIntro
After finding a well hidden spot among the warehouse&#39;s stockpiles of clay, dyes, fabrics and ores, you sit on the ground and take your new toy to your groin. You begin by pushing it against your pussy lips, massaging them, while your free hand plays with your clitoris. Thanks to the anticipation of this moment, it barely takes any effort for your lower parts to turn wet, and the time for the main dish comes.

You slowly push the dildo inside, savoring its texture and thickness. Your arm and hips fight a small battle to push against each other, until the dildo finally makes it all the way inside.

//The silk was a great choice, wasnt it?//

Your body asks you to speed things a bit, and you&#39;re happy to comply. The first penetration is soon followed by another one, and another, and another, each faster than the previous one, your mind now focused on the success of your work and the petty deviousness of your current endeavor, engulfed by the moment between the thrusts and-

//You lost &lt;span style=&quot;color:lightcoral&quot;&gt;$StVars.check4 lust.&lt;/span&gt;//

&lt;&lt;if $StVars.check2 == &quot;botNash&quot;&gt;&gt; \
[[Continue|FASE DldPly BotNash]]
&lt;&lt;else&gt;&gt; \
[[Continue|FASE DldPly TopNash]]
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="606" name="FASE DldPly BotNash" tags="" position="5326,1251" size="100,100">&lt;&lt;script&gt;&gt;
State.variables.compass.characterEventEndsPrematurely(&quot;chNash&quot;);
State.variables.compass.moveCharsToRoom([&quot;chNash&quot;],&quot;workshop&quot;);
setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);
State.variables.eventsCalendar.activeEvent = true;
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What a sight.&quot;//&lt;/span&gt; Nashillbyir appears before your eyes.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wh- Wha-&quot;//&lt;/span&gt; You pull back your arm from the shock, involuntarily impaling yourself in the dildo. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nngh!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Oh my, someone&#39;s happy to see me.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What... What are you doing here?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;The workshop was running low on supplies and I came to gather some, then I heard someone&#39;s voice in the backroom, and wondered if they might need help.&quot;//&lt;/span&gt;

//I must have moaned. That was careless of me.//

&lt;span style=&quot;color:yellow&quot;&gt;Nashillbyir relation and drives check.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...But it was you, having fun! I didn&#39;t know you could craft toys.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...Neither did I. This is my first one.&quot;//&lt;/span&gt; You reply, taking the attention away from your shame, even though you&#39;re clearly putting quite the effort to cover yourself.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Sounded like you&#39;re have talent then. How about we both have some fun with it?&quot;//&lt;/span&gt; She suggests, crouching closer to your height, then crawling towards you.

[[Accept her offer|FASE DldPly EgaPlayerDld Alt]]
[[Accept her offer and lend her the dildo|FASE DldPly EgaNashDld Alt]]
&lt;&lt;if $chPlayerCharacter.willpower.current &gt;= $StVars.check3&gt;&gt; \
[[She can only stay if she&#39;s obedient|FASE DldPly PlayerTakesControl]] (Costs &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check3 willpower&lt;/span&gt;)
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;-Locked: You need $StVars.check3 willpower to unlock this choice.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $chPlayerCharacter.willpower.current &gt;= $StVars.check3&gt;&gt; \
[[Swallow your lust and leave|FASE DldPly Leave Early]] (Costs &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check3 willpower&lt;/span&gt;)
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;-Locked: You need $StVars.check3 willpower to unlock this choice.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="607" name="FASE DldPly TopNash" tags="" position="5215,1253" size="100,100">&lt;&lt;script&gt;&gt;
State.variables.compass.characterEventEndsPrematurely(&quot;chNash&quot;);
State.variables.compass.moveCharsToRoom([&quot;chNash&quot;],&quot;workshop&quot;);
setPasChars([getPresentCharByKey(&quot;chNash&quot;)]);
State.variables.eventsCalendar.activeEvent = true;
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What a sight.&quot;//&lt;/span&gt; Nashillbyir appears before your eyes.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wh- Wha-&quot;//&lt;/span&gt; You pull back your arm from the shock, involuntarily impaling yourself in the dildo. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Nngh!&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Wow, you truly are happy to see me.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What... What are you doing here?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;The workshop was running low on supplies and I came to gather some, then I heard someone&#39;s voice in the backroom, and wondered if they might need help.&quot;//&lt;/span&gt;

//I must have moaned. That was careless of me.//

&lt;span style=&quot;color:yellow&quot;&gt;Nashillbyir relation and drives check.&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...And it looks like I was right.&quot;//&lt;/span&gt; She decides confidently, not dissimulating the fact that her eyes are penetrating your flooding groin, covered only by your hands. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;You&#39;ll have far more fun when it&#39;s me who&#39;s holding that for you.&quot;//&lt;/span&gt;

[[Let Nash play with you|FASE DldPly NashTakesControl]]
&lt;&lt;if $chPlayerCharacter.willpower.current &gt;= $StVars.check3&gt;&gt; \
[[Hand Nash the dildo and tell her to get on her knees|FASE DldPly EgaNashDld]] (Costs &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check3 willpower&lt;/span&gt;)
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;-Locked: You need $StVars.check3 willpower to unlock this choice.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $chPlayerCharacter.willpower.current &gt;= $StVars.check3&gt;&gt; \
[[Tell Nash that she&#39;s welcome to taste the toy, but it won&#39;t be leaving your hands|FASE DldPly EgaPlayerDld]] (Costs &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check3 willpower&lt;/span&gt;)
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;-Locked: You need $StVars.check3 willpower to unlock this choice.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \
&lt;&lt;if $chPlayerCharacter.willpower.current &gt;= $StVars.check3&gt;&gt; \
[[Swallow your lust and leave|FASE DldPly Leave Early]] (Costs &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check3 willpower&lt;/span&gt;)
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:firebrick&quot;&gt;-Locked: You need $StVars.check3 willpower to unlock this choice.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \</tw-passagedata><tw-passagedata pid="608" name="FASE DldPly NashTakesControl" tags="" position="5216,1363" size="100,100">$customRoomIntro
You&#39;re unable -or unwilling- to reply to her with anything more than your gasps, and she meets no resistance when she takes the dildo off your hands. The Ashwalker kneels in front of you, and opens your legs wide.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hmm.&quot;//&lt;/span&gt; She thoroughly licks the toy, enjoying your taste, while her other hand plays with your lower lips. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;I caught you at a busy moment, right? I think we can skip the foreplay this time.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;dldPlyNashTopsPlayer();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="609" name="FASE DldPly EgaNashDld" tags="" position="5326,1361" size="100,100">&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= State.variables.StVars.check3;
if ( State.variables.chPlayerCharacter.willpower.current &lt; 0 ) { State.variables.chPlayerCharacter.willpower.current = 0; }
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check3 willpower.&lt;/span&gt;//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Fine, take it. It&#39;s only fair that you finish what you interrupted.&quot;//&lt;/span&gt; You manage to overcome the heat engulfing your body and take back some control in the situation. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Get on your knees next to me.&quot;//&lt;/span&gt;

Nashillbyir takes the dildo and gives it one long lick, tasting whatever&#39;s left of you. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Given how wet this is, I think I can skip foreplay.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You can, but hurry up already!&quot;//&lt;/span&gt;

She teases you by making deliberately slow movements, but ultimately complies.

&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;dldPlyEgaNashHasDildo();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="610" name="FASE DldPly EgaPlayerDld" tags="" position="5326,1470" size="100,100">&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= State.variables.StVars.check3;
if ( State.variables.chPlayerCharacter.willpower.current &lt; 0 ) { State.variables.chPlayerCharacter.willpower.current = 0; }
State.variables.chNash.relations.chPlayerCharacter.rivalry.stv += 150;
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check3 willpower.&lt;/span&gt;//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;If you&#39;re so eager to have fun, you&#39;re welcome to get closer, but it&#39;ll be my hands which thrust it inside you.&quot;//&lt;/span&gt; You manage to utter between gasps.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Are you sure you don&#39;t prefer to climax already? You seem to be so close, that it&#39;d be a shame that you&#39;d have to turn your attention to me...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;If you don&#39;t like it, you can also leave.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Nash has slightly increased.&lt;/span&gt;//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;...Fine.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;dldPlyEgaPlayerHasDildo();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="611" name="FASE DldPly Leave Early" tags="" position="5211,1583" size="100,100">&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= State.variables.StVars.check3;
if ( State.variables.chPlayerCharacter.willpower.current &lt; 0 ) { State.variables.chPlayerCharacter.willpower.current = 0; }
State.variables.chNash.relations.chPlayerCharacter.rivalry.stv += 150;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv -= 350;
State.variables.chPlayerCharacter.relations.chNash.rivalry.stv += 150;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv -= 350;
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check3 willpower.&lt;/span&gt;//

Ironing your will, you begin to dress yourself, and stand up to leave the room.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;What a cold answer.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I lost the enthusiasm with that scare. I&#39;m not in the mood to keep going.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hmpf. Your choice.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:red&quot;&gt;Your rivalry with Nash has slightly increased.&lt;/span&gt;
&lt;span style=&quot;color:gray&quot;&gt;Your sexual tension with Nash has decreased.&lt;/span&gt;//

&lt;&lt;link [[Continue|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;finishFaSeDildoPlay();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="612" name="FASE DldPly PlayerTakesControl" tags="" position="5215,1471" size="100,100">&lt;&lt;script&gt;&gt;
State.variables.chPlayerCharacter.willpower.current -= State.variables.StVars.check3;
if ( State.variables.chPlayerCharacter.willpower.current &lt; 0 ) { State.variables.chPlayerCharacter.willpower.current = 0; }
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
//You lost &lt;span style=&quot;color:darkslateblue&quot;&gt;$StVars.check3 willpower.&lt;/span&gt;//

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You want me... To share the fun with you? After you interrupted me? After you scared all of a sudden?&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;If you put it like that-&quot;//&lt;/span&gt; She&#39;s immediately taken aback, not expecting you to turn so confrontational.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;It&#39;s alright, it&#39;s alright. You&#39;ll get your share of fun.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I will?&quot;//&lt;/span&gt;

//She bit the hook. And now...// &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Yes, but you will have to do as I say. This thing&quot;//&lt;/span&gt;, you intercalate a little lick to the dildo in the middle of your words, &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;is going so deep inside you that you&#39;re going to see the starry sky without leaving the Cavern, but I&#39;m going to see your face defeated by pleasure as compensation.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;T-that&#39;s-&quot;//&lt;/span&gt; She takes some seconds to realize how much of her arm you&#39;re taking, after she offered you her hand. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;...looks fine to me.&quot;//&lt;/span&gt;

You don&#39;t let her think twice.

&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;dldPlyPlayerTopsNash();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="613" name="FASE DldPly EgaPlayerDld Alt" tags="" position="5435,1466" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...An interesting idea.&quot;//&lt;/span&gt; You reply, more confident now that Nash has opened herself. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;d love to get a second opinion.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Just what I wanted to hear.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;dldPlyEgaPlayerHasDildo();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="614" name="FASE DldPly EgaNashDld Alt" tags="" position="5436,1363" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...A timely proposition. I was thinking that you should make up to me for your interruption.&quot;//&lt;/span&gt; You reply, more confident now that she&#39;s opened up herself. You hand the dildo over to her. &lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Take it, and help me finish.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;So greedy, wanting all the pleasure for yourself.&quot;//&lt;/span&gt; She acts deliberately slowly, teasing you, as if to compensate for your sudden bossiness.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hurry up already...&quot;//&lt;/span&gt;

But ultimately complies. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;Since you asked me so nicely.&quot;//&lt;/span&gt;

&lt;&lt;link [[Continue|Scene]]&gt;&gt;&lt;&lt;script&gt;&gt;dldPlyEgaNashHasDildo();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="615" name="FASE DldPly NashTakesControl End" tags="" position="5665,1254" size="100,100">&lt;&lt;script&gt;&gt;
if ( State.variables.chPlayerCharacter.willpower.current &lt; 0 ) { State.variables.chPlayerCharacter.willpower.current = 0; }
State.variables.chNash.relations.chPlayerCharacter.domination.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.submission.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 250;
addPointsToDrive(gC(&quot;chNash&quot;).dPleasure,50);
addPointsToDrive(gC(&quot;chNash&quot;).dDomination,50);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You know, I&#39;ve taken quite the liking to this... Staff of yours.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;That&#39;s... Great to hear.&quot;//&lt;/span&gt; You reply, recovering your energy.

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;You did a great job at crafting it! But perhaps you should recognize the value in letting it be wielded by someone with more experience with them.&quot;//&lt;/span&gt; Nashillbyir slowly waves it around, as if it was a weapon made to deflect imaginary blows.

//...Is she implying that she&#39;s going to steal it from me?//

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Hahaha! Just kidding, just kidding. No need to keep that face on.&quot;//&lt;/span&gt; She returns the dildo to your hands. &lt;span @style=$chNash.colorStyleKey&gt;//&quot;But I wouldn&#39;t oppose you if you wanted to make another one for me.&quot;//&lt;/span&gt;

//&lt;span style=&quot;color:purple&quot;&gt;Your submission towards Nashillbyir has increased.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has increased.&lt;/span&gt;
Nashillbyir&#39;s drives have grown more favorable towards domination and pleasure.//

&lt;&lt;link [[Continue|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;finishFaSeDildoPlay();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="616" name="FASE DldPly EgaNashDld End" tags="" position="5551,1257" size="100,100">&lt;&lt;script&gt;&gt;
if ( State.variables.chPlayerCharacter.willpower.current &lt; 0 ) { State.variables.chPlayerCharacter.willpower.current = 0; }
State.variables.chNash.relations.chPlayerCharacter.romance.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.romance.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 250;
addPointsToDrive(gC(&quot;chNash&quot;).dPleasure,40);
addPointsToDrive(gC(&quot;chNash&quot;).dLove,40);
addPointsToDrive(gC(&quot;chNash&quot;).dCooperation,40);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I think I&#39;m in love with this thing. Would you mind if I took it with me?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Alright, I think that was enough play for you. You can give it back.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Just for a few days? A week at most?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Maybe one night during the travel back to the Temple.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ll think about it.&quot;//&lt;/span&gt; The Ashwalker decides to take that noncommittal response as a minor victory, and returns you the toy.

//&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Nashillbyir has increased.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has increased.&lt;/span&gt;
Nashillbyir&#39;s drives have grown more favorable towards pleasure, love and cooperation.//

&lt;&lt;link [[Continue|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;finishFaSeDildoPlay();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="617" name="FASE DldPly EgaPlayerDld End" tags="" position="5551,1360" size="100,100">&lt;&lt;script&gt;&gt;
if ( State.variables.chPlayerCharacter.willpower.current &lt; 0 ) { State.variables.chPlayerCharacter.willpower.current = 0; }
State.variables.chNash.relations.chPlayerCharacter.romance.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.romance.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 250;
addPointsToDrive(gC(&quot;chNash&quot;).dPleasure,40);
addPointsToDrive(gC(&quot;chNash&quot;).dLove,40);
addPointsToDrive(gC(&quot;chNash&quot;).dCooperation,40);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chNash.colorStyleKey&gt;//&quot;I think I&#39;m in love with this thing. Would you mind if I took it with me?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Alright, I think that was enough play for you. You can give it back.&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Just for a few days? A week at most?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...&quot;//&lt;/span&gt;

&lt;span @style=$chNash.colorStyleKey&gt;//&quot;Maybe one night during the travel back to the Temple.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ll think about it.&quot;//&lt;/span&gt; The Ashwalker decides to take that noncommittal response as a minor victory, and stops pestering you about it.

//&lt;span style=&quot;color:lightcoral&quot;&gt;Your romance with Nashillbyir has increased.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has increased.&lt;/span&gt;
Nashillbyir&#39;s drives have grown more favorable towards pleasure, love and cooperation.//

&lt;&lt;link [[Continue|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;finishFaSeDildoPlay();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="618" name="FASE DldPly PlayerTakesControl End" tags="" position="5661,1357" size="100,100">&lt;&lt;script&gt;&gt;
if ( State.variables.chPlayerCharacter.willpower.current &lt; 0 ) { State.variables.chPlayerCharacter.willpower.current = 0; }
State.variables.chNash.relations.chPlayerCharacter.submission.stv += 250;
State.variables.chNash.relations.chPlayerCharacter.sexualTension.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.domination.stv += 250;
State.variables.chPlayerCharacter.relations.chNash.sexualTension.stv += 250;
addPointsToDrive(gC(&quot;chNash&quot;).dPleasure,100);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
Nashillbyir&#39;s face shows that she has, indeed, seen the stars.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Looks like my toy took your breath away.&quot;//&lt;/span&gt;

Still gasping, the Ashwalker doesn&#39;t have enough energy to reply to you with anything other than her gaze.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I&#39;ll take it as a sign that you liked it. ...And I guess we can consider your debt settled.&quot;//&lt;/span&gt; Nash nods.

//If she&#39;s enjoyed it this much, I&#39;ll probably be able to leverage the dildo with her in the future.// You think as you leave her behind recovering her breath, the most playful side of your mind focusing on the new possibilities opening before you.

//&lt;span style=&quot;color:purple&quot;&gt;Your domination towards Nashillbyir has increased.&lt;/span&gt;
&lt;span style=&quot;color:lightcoral&quot;&gt;Your sexual tension with Nashillbyir has increased.&lt;/span&gt;
Nashillbyir&#39;s drives have grown more favorable towards pleasure.//

&lt;&lt;link [[Continue|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;finishFaSeDildoPlay();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="619" name="FASE MorphHut Init" tags="" position="5800,1234" size="100,100">&lt;&lt;script&gt;&gt;
setRoomIntro(&quot;mapGleamingCaverns&quot;,&quot;hiddenHut&quot;);
setPasChars([getPresentCharByKey(&quot;chMes&quot;)]);
State.variables.StVars.check1 = gC(&quot;chPlayerCharacter&quot;).intelligence.value + gC(&quot;chPlayerCharacter&quot;).perception.value;
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
Following Mesquelles&#39; indications, you find a relatively hidden tunel near the entrance of the Caverns. In the room at its end, you reach a mud hut humble in size, but boastful in decorations. A diminute stream of water fills a puddle a couple of meters away from the house, and an even smaller river flows in the opposite direction, until the water gets lost in different cracks. The hut&#39;s door opens.

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Oh! You&#39;re one of the human Candidates.&quot;//&lt;/span&gt; Mesquelles says when she meets you.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Hey, hello there. I was curious about the magic you used earlier.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;You&#39;re interested? That&#39;s great!&quot;//&lt;/span&gt; Her face beams. &lt;span @style=$chMes.colorStyleKey&gt;//&quot;Perhaps you&#39;d like to experience a transformation yourself? I&#39;d love to have you as a canvas!&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;As a what...?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Do we have visit?&quot;//&lt;/span&gt; A Shapeshifter man with grayish blue colours and a slow, tired voice leaves the hut. &lt;span style=&quot;color:gray&quot;&gt;//&quot;You must be from the Passion Temple.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I am. My name is $chPlayerCharacter.name, and I&#39;m the Gaanidan Candidate. I was told by Mesquelles that you&#39;re teaching her transformation magic.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;And you came to see me? Ho, ho, ho...&quot;//&lt;/span&gt; He laughs with some effort, as if the mere act of moving his throat was a challenge. &lt;span style=&quot;color:gray&quot;&gt;//&quot;My name is Veshmren, young lady. It&#39;s true, I&#39;m Mesquelles&#39; teacher. I mastered the art of transformation magic many decades ago, after a whole life of committing myself to discipline the love for beauty...&quot;//&lt;/span&gt; &lt;if $StVars.check1 gte 30&gt;

&lt;span style=&quot;color:green&quot;&gt;Intelligence AND perception check: passed.&lt;/span&gt;

//He spent a whole life learning, and has lived for decades after that? How old is he...?//

&lt;/if&gt;&lt;span style=&quot;color:gray&quot;&gt;//&quot;Now, I have one last wish in life, and that&#39;s to leave as much of my knowledge as I possibly can with my tribe.&quot;//&lt;/span&gt;

[[Continue|FASE MorphHut Init2]]</tw-passagedata><tw-passagedata pid="620" name="FASE MorphHut Init2" tags="" position="5906,1234" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And that&#39;s where Mesquelles comes in.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Indeed... It&#39;s not easy for me to find committed students. Mesquelles has endured a few years so far.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;And I&#39;m determined to continue as many years as possible! That&#39;s why, if you were so kind, would you let me practice with you?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You wanted to transform me.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Please excuse Mesquelles&#39; enthusiasm. Our art is easy for us Shapeshifters to practice on ourselves, and after some years it becomes as easy as walking, or talking. But when it comes to anything other than Shapeshifters, it requires a large degree of mastery over aether. And it isn&#39;t easy for us to find appropriate living beings to work with.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I think I like myself as I am...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Mesquelles isn&#39;t yet adept enough to perform a permanent transformation on you, so don&#39;t worry about that.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Think of it as wearing a mask.&quot;//&lt;/span&gt; She covers her face with her hands, then uncovers it - but the facial features of a smiling Valtan appear over a puddle of pink. &lt;span @style=$chMes.colorStyleKey&gt;//&quot;I bet you must have wondered how it would feel to be someone else, at least to everyone&#39;s eyes.&quot;//&lt;/span&gt; And the face of your peer slowly fades into Mesquelles&#39;.

[[Continue|FASE MorphHut Init3]]</tw-passagedata><tw-passagedata pid="621" name="FASE MorphHut Init3" tags="" position="6014,1230" size="100,100">&lt;&lt;script&gt;&gt;addToStVarsList(&quot;mphInit&quot;);&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I guess we could try a small one.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Yes! Please, come to the bath.&quot;//&lt;/span&gt; The pink apprentice eagerly takes your hand and brings you next to the puddle of water. Thanks to the illumation of some crystals, your reflections are completely clear.

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Mesquelles will start by examining your aethereal structure.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What&#39;s that?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;All living creatures have it, and it&#39;s the very essence of their being, as I see it. The form your body must take, how it must grow, how it must heal itself, is determined by your aethereal structure.&quot;//&lt;/span&gt; As Veshmren talks, Mesquelles moves her hands a few inches above your skin, as if she was feeling something surrounding you. &lt;span style=&quot;color:gray&quot;&gt;//&quot;Our magic alters that structure, molds it as if it was clay, and makes it change the physical manifestation of your being.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...And what do you see in mine?&quot;//&lt;/span&gt; You ask, curious, moving your eyes from the teacher to the student, whose eyes are frowned, restless.

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;I... This must be wrong. I must be doing something wrong.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;What is it, Mesq?&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;I sense her structure to be weak, even weaker than the rat&#39;s I told you about.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;As weak as that of a Shapeshifter?&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;It comes close.&quot;//&lt;/span&gt;

//What does that mean? Are they going to melt me?//

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Then be soft in your touch.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Maybe I&#39;m reading it wrong.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Perhaps. That&#39;s why a cautious approach is most appropriate here, as you will do no damage either way and you&#39;ll test if your examination is correct.&quot;//&lt;/span&gt;

//They are going to melt me - with caution.//

Despite your dramatic inner monologue, Mesquelles&#39; technique isn&#39;t just not painful - you discover it to be even pleasant. Her hands gently massage your ears with the care and precision of a painter obsessed to extenutation with the thinnest of brushes that will give form to a minimum detail almost no one will ever notice. In the reflection of the water, your ears are now pointed.

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;And... I&#39;m finished.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;A creative idea. Was it that hard in the end?&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Not really.&quot;//&lt;/span&gt; She replies, her confidence floating back to surface after a job well done.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Does that mean I&#39;m safe?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Ho, ho... You were always safe, my dear.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Your ears will go back to normal in a few minutes, I hope you liked the demonstration. If you were so kind, we could also try... Bolder changes.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;For what it&#39;s worth,&quot;//&lt;/span&gt; the tired-looking Shapeshifter adds, &lt;span style=&quot;color:gray&quot;&gt;//&quot;it would mean a lot to me if you could assist my student.&quot;//&lt;/span&gt;

[[Questions and transformations|FASE MorphHut Main]]</tw-passagedata><tw-passagedata pid="622" name="FASE MorphHut Main" tags="" position="5801,1344" size="100,100">&lt;&lt;script&gt;&gt;State.variables.StVars.check1 = gC(&quot;chPlayerCharacter&quot;).intelligence.value + gC(&quot;chPlayerCharacter&quot;).perception.value;
State.variables.compass.pushAllTimeToAdvance();
if ( isStVarOn(&quot;mphFsTf&quot;) == true ) { State.variables.StVars.check2 = true; }
else { State.variables.StVars.check2 = false; }
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
Mesquelles brims with anticipation, wishing to get the opportunity to lay her hands on you again.

[[Weak aetherial structure?|FASE MorphHut WAS]]
[[Learning transformation magic|FASE MorphHut Learning]]
&lt;&lt;if $StVars.check1 gte 30&gt;&gt; \
&lt;span style=&quot;color:green&quot;&gt;Intelligence AND perception check: passed.&lt;/span&gt;
[[How old is Veshmren?|FASE MorphHut VeshremAge]]
&lt;&lt;else&gt;&gt; \
&lt;span style=&quot;color:red&quot;&gt;Intelligence AND perception check: failed.&lt;/span&gt;
&lt;&lt;/if&gt;&gt; \

&lt;&lt;if $StVars.check2 is false&gt;&gt; \
[[I have a transformation in mind|FASE MorphHut FirstTransformation]]
&lt;&lt;else&gt;&gt; \
[[I have a transformation in mind|FASE MorphHut MorphMenu]]
&lt;&lt;/if&gt;&gt; \

[[Leave|Map]]</tw-passagedata><tw-passagedata pid="623" name="FASE MorphHut WAS" tags="" position="5914,1459" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You mentioned that my... Aetherial structure is weak. What does it mean? Is that dangerous?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;As I told you earlier, all living beings have an aetherial structure of their own, but each of them have different degrees of robustness. Those with weak ones may be easily transformed, and permanent transformations would be easier to perform.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And I guess that mine is too weak for a human.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Small animals are supposed to have far weaker structures than Leiriens, Aiishen, humans... But yours was weaker than any animal I&#39;ve examined. That means I have to be more careful when I perform transformations on you.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;What would happen if you were too careless?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;It could hurt you, but nothing beyond that. Transformations that twist one&#39;s body to the point of making life impossible simply don&#39;t get finished.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;I wonder why $chPlayerCharacter.name&#39;s structure is so weak...&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Are you particularly weak to magic?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;About as much as the other Candidates. Maybe less than Maaterasu, the Aiishen.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Continued exposure to transformation magic might weaken the structure, or at least make it more malleable. But that isn&#39;t your case, right?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Definitely not.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;The Ritual of Avatars uses transformation magic, but it shouldn&#39;t be able to provoke such drastic effects.&quot;//&lt;/span&gt; The grayish man gets lost in his own thoughts for a short while. &lt;span style=&quot;color:gray&quot;&gt;//&quot;It&#39;s definitely intriguing. Maybe I should talk to Drishtya while I still have the chance.&quot;//&lt;/span&gt;

[[Continue|FASE MorphHut Main]]</tw-passagedata><tw-passagedata pid="624" name="FASE MorphHut VeshremAge" tags="" position="5914,1349" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I hope you don&#39;t mind me asking, but... How old are you, Veshmren?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;How old... You&#39;re asking me for a number of years, right? We don&#39;t keep track of time like the other tribes do.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Uh.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;But maybe I could answer your question if I tell you that I&#39;ve outlived three High Priestesses, so the one from your generation will be the fourth during my lifetime.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Wait, how is that even possible? That would make you... Probably over a hundred years old! Do all Shapeshifters live that long?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Ho, ho, ho... No, we definitely don&#39;t.&quot;//&lt;/span&gt; His laugh is even more tired than the others, and he lets out a long breath afterwards.

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Veshmren has been artificially prolonging his own life using magic.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;You can use magic to do that? Why aren&#39;t more people doing it, then?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;The form of your body, anyone&#39;s body,&quot;//&lt;/span&gt; he decides to explain, &lt;span style=&quot;color:gray&quot;&gt;//&quot;is determined by your aetherial structure. Each day from the moment you reach adulthood, it degrades, and with it, your own body. It&#39;s possible to repair it, but it gets harder with time... And tiresome... And painful.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;But... You&#39;re well on your way to live two lives.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;The length of one&#39;s life loses importance when each day becomes harder and harder to walk... To make love... And even to breathe. It&#39;s not as much of an appealing fate as you think, and if it were, where are the others like me?&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And yet, you&#39;re extending your own life.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;I think I told you earlier... I have one final wish. If I took my final sleep before I was done, I&#39;d probably force my eyes open again.&quot;//&lt;/span&gt; He dedicates you a tired smile.

[[Continue|FASE MorphHut Main]]</tw-passagedata><tw-passagedata pid="625" name="FASE MorphHut Learning" tags="" position="5799,1449" size="100,100">$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Could I learn transformation magic?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;It&#39;s possible you will, at some point.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Is it?&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;As a priestess of the Passion Temple, it&#39;s useful for you to be capable of performing the Ritual of Avatars, just in case you have to become the regent for the generation that comes after yours.&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Oh! That makes sense.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;...However, I doubt it&#39;ll be any time soon. This discipline requires a lot of dedication for a long time, and a new generation of Candidates has different priorities during their early years.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Maybe it&#39;s easier for $chPlayerCharacter.name to learn it, since she&#39;s predisposed to be transformed herself.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;That certainly helps, but do not look ignore how many Shapeshifters, with their natural affinity towards transformation magic, give up from further honing their own skill as soon as it&#39;s good enough to transform themselves.&quot;//&lt;/span&gt;

[[Continue|FASE MorphHut Main]]</tw-passagedata><tw-passagedata pid="626" name="FASE MorphHut MorphMenu" tags="" position="6022,1450" size="100,100">&lt;&lt;script&gt;&gt;
if ( State.variables.tfTarget == undefined ) {
setupTfMenu(&quot;chPlayerCharacter&quot;,&quot;chMes&quot;,&quot;FASE MorphHut MorphMenu&quot;);
}
updateSelectedTransformationsText(&quot;chPlayerCharacter&quot;,&quot;chMes&quot;,&quot;FASE MorphHut MorphMenu&quot;);&lt;&lt;/script&gt;&gt; \
Mesquelles will transform $chPlayerCharacter.name. Define the transformation.

$tfMenuString

&lt;&lt;link [[Cancel, back to conversation options|FASE MorphHut Main]]&gt;&gt;&lt;&lt;script&gt;&gt;cleanTfMenu();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;
&lt;&lt;link [[Cancel, back to map|Map]]&gt;&gt;&lt;&lt;script&gt;&gt;cleanTfMenu();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata><tw-passagedata pid="627" name="FASE MorphHut FirstTransformation" tags="" position="6019,1340" size="100,100">&lt;&lt;script&gt;&gt;
addToStVarsList(&quot;mphFsTf&quot;);
&lt;&lt;/script&gt;&gt; \
$customRoomIntro
&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;I want to try a larger transformation.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;That&#39;s fantastic! You are going to love what I do with you.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Mesquelles. Since you will be transforming a person from a different tribe, it&#39;s probably about time for you to start using advanced techniques.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;...!&quot;//&lt;/span&gt; Mesquelles covers her mouth, quickly turning towards her teacher. &lt;span @style=$chMes.colorStyleKey&gt;//&quot;That is... I understand.&quot;//&lt;/span&gt;

&lt;span style=&quot;color:gray&quot;&gt;//&quot;Very good. Then I&#39;ll take my leave for a while, it&#39;ll be better for both of you.&quot;//&lt;/span&gt; Veshmren sentences before he heads for the exit.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;...That was eerie. What are these mysterious techniques you were talking about?&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;Come.&quot;//&lt;/span&gt; She replies, taking your hand and bringing you closer to her. &lt;span @style=$chMes.colorStyleKey&gt;//&quot;As you know, transformation magic alters your aetherial structure...&quot;//&lt;/span&gt;

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;Aha.&quot;//&lt;/span&gt;

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;And that&#39;s easier to do when the aether of the person to be transformed is... Flowing freely.&quot;//&lt;/span&gt; You feel one of Mesquelles&#39; fingers slowly tracing a line across your face. The softness and delicaly of her touch turns your skin receptive, longing for further caresses.

&lt;span @style=$chPlayerCharacter.colorStyleKey&gt;//&quot;And you&#39;ll make me activate my flow of aether by...&quot;//&lt;/span&gt; You interrupt the phrase as her face comes closer to yours, planting a quiet kiss on your cheek.

&lt;span @style=$chMes.colorStyleKey&gt;//&quot;You must know this already, coming from the Temple. Aether flows better when someone&#39;s in deep touch with their feelings.&quot;//&lt;/span&gt; Mesquelles places a hand on your waist, the other at your neck, and on its opposite side, she thoroughly licks. &lt;span @style=$chMes.colorStyleKey&gt;//&quot;Such as joy, courage, harmony... And passion.&quot;//&lt;/span&gt;

You accept her.

[[Continue|FASE MorphHut MorphMenu]]</tw-passagedata><tw-passagedata pid="628" name="TF Select Avatar" tags="" position="1427,591" size="100,100">$tfAvatarMenuString</tw-passagedata><tw-passagedata pid="629" name="TF Std Menu" tags="" position="1546,589" size="100,100">&lt;&lt;script&gt;&gt;
if ( State.variables.tfTarget == undefined ) {
setupTfMenu(&quot;chPlayerCharacter&quot;,&quot;chMes&quot;,&quot;TF Std Menu&quot;);
State.variables.tfTarget = &quot;chPlayerCharacter&quot;;
State.variables.tfActor = &quot;chVal&quot;;
}
updateSelectedTransformationsText(State.variables.tfTarget,State.variables.tfActor,&quot;TF Std Menu&quot;);
State.variables.StVars.check1 = gC(State.variables.tfTarget).getFormattedName();&lt;&lt;/script&gt;&gt; \
Define the transformation for $StVars.check1.

$tfMenuString

&lt;&lt;link [[Cancel, back to conversation|Social Interactions Specifics]]&gt;&gt;&lt;&lt;script&gt;&gt;cleanTfMenu();&lt;&lt;/script&gt;&gt;&lt;&lt;/link&gt;&gt;</tw-passagedata></tw-storydata>
	<script id="script-sugarcube" type="text/javascript">
	/*! SugarCube JS */
	if(document.documentElement.getAttribute("data-init")==="loading"){!function(window,document,jQuery,undefined){"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_slicedToArray=function(){function e(e,t){var r=[],n=!0,a=!1,i=undefined;try{for(var o,s=e[Symbol.iterator]();!(n=(o=s.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){a=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(a)throw i}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},errorPrologRegExp=/^(?:(?:uncaught\s+(?:exception:\s+)?)?\w*(?:error|exception|_err):\s+)+/i,Alert=function(){function e(e,t,r,n){var a="fatal"===e,i="Apologies! "+(a?"A fatal":"An")+" error has occurred.";i+=a?" Aborting.":" You may be able to continue, but some parts may not work properly.",null==t&&null==r||(i+="\n\nError",null!=t&&(i+=" ["+t+"]"),i+=null!=r?": "+r.replace(errorPrologRegExp,"")+".":": unknown error."),"object"===(void 0===n?"undefined":_typeof(n))&&n.stack&&(i+="\n\nStack Trace:\n"+n.stack),window.alert(i)}function t(t,r,n){e(null,t,r,n)}function r(t,r,n){e("fatal",t,r,n)}return function(e){window.onerror=function(n,a,i,o,s){"complete"===document.readyState?t(null,n,s):(r(null,n,s),window.onerror=e,"function"==typeof window.onerror&&window.onerror.apply(this,arguments))}}(window.onerror),Object.freeze(Object.defineProperties({},{error:{value:t},fatal:{value:r}}))}(),Patterns=function(){var e=function(){var e=new Map([[" ","\\u0020"],["\f","\\f"],["\n","\\n"],["\r","\\r"],["\t","\\t"],["\v","\\v"],[" ","\\u00a0"],[" ","\\u1680"],["᠎","\\u180e"],[" ","\\u2000"],[" ","\\u2001"],[" ","\\u2002"],[" ","\\u2003"],[" ","\\u2004"],[" ","\\u2005"],[" ","\\u2006"],[" ","\\u2007"],[" ","\\u2008"],[" ","\\u2009"],[" ","\\u200a"],["\u2028","\\u2028"],["\u2029","\\u2029"],[" ","\\u202f"],[" ","\\u205f"],["　","\\u3000"],["\ufeff","\\ufeff"]]),t=/^\s$/,r="";return e.forEach(function(e,n){t.test(n)||(r+=e)}),r?"[\\s"+r+"]":"\\s"}(),t="\\s"===e?"\\S":e.replace(/^\[/,"[^"),r="[0-9A-Z_a-z\\-\\u00c0-\\u00d6\\u00d8-\\u00f6\\u00f8-\\u00ff\\u0150\\u0170\\u0151\\u0171]",n=r.replace("\\-",""),a=function(){return"("+r+"+)\\(([^\\)\\|\\n]+)\\):|("+r+"+):([^;\\|\\n]+);|((?:\\."+r+"+)+);|((?:#"+r+"+)+);"}();return Object.freeze({space:e,spaceNoTerminator:"[\\u0020\\f\\t\\v\\u00a0\\u1680\\u180e\\u2000-\\u200a\\u202f\\u205f\\u3000\\ufeff]",lineTerminator:"[\\n\\r\\u2028\\u2029]",notSpace:t,anyChar:"(?:.|[\\n\\r\\u2028\\u2029])",anyLetter:r,anyLetterStrict:n,identifierFirstChar:"[$A-Z_a-z]",identifierNextChar:"[$0-9A-Z_a-z]",identifier:"[$A-Z_a-z][$0-9A-Z_a-z]*",variableSigil:"[$_]",variable:"[$_][$A-Z_a-z][$0-9A-Z_a-z]*",macroName:"[A-Za-z][\\w-]*|[=-]",templateName:"[A-Za-z][\\w-]*",cssImage:"\\[[<>]?[Ii][Mm][Gg]\\[(?:\\s|\\S)*?\\]\\]+",inlineCss:a,url:"(?:file|https?|mailto|ftp|javascript|irc|news|data):[^\\s'\"]+"})}();!function(){!function(e){if(e&&e.prototype&&null==e.prototype.firstElementChild){var t=Node.ELEMENT_NODE;Object.defineProperty(e.prototype,"firstElementChild",{get:function(){for(var e=this.childNodes,r=0;r<e.length;++r){var n=e[r];if(n.nodeType===t)return n}return null}})}}(window.Node||window.Element)}(),function(){function e(e,t){var r=Number.parseInt(e,10)||0;if(r<1)return"";var n=void 0===t?"":String(t);for(""===n&&(n=" ");n.length<r;){var a=n.length,i=r-a;n+=a>i?n.slice(0,i):n}return n.length>r&&(n=n.slice(0,r)),n}var t=function(){function e(e,n){var a=String(e);if(!a)return a;switch(n){case"start":return t.test(a)?a.replace(t,""):a;case"end":return r.test(a)?a.replace(r,""):a;default:throw new Error('_trimString called with incorrect where parameter value: "'+n+'"')}}var t=new RegExp("^"+Patterns.space+Patterns.space+"*"),r=new RegExp(""+Patterns.space+Patterns.space+"*$");return e}();Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,writable:!0,value:function(){function e(){if(null==this)throw new TypeError("Array.prototype.flat called on null or undefined");var t=0===arguments.length?1:Number(arguments[0])||0;return t<1?Array.prototype.slice.call(this):Array.prototype.reduce.call(this,function(r,n){return n instanceof Array?r.push.apply(r,_toConsumableArray(e.call(n,t-1))):r.push(n),r},[])}return e}()}),Array.prototype.flatMap||Object.defineProperty(Array.prototype,"flatMap",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.flatMap called on null or undefined");return Array.prototype.map.apply(this,arguments).flat()}}),Array.prototype.includes||Object.defineProperty(Array.prototype,"includes",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.includes called on null or undefined");if(0===arguments.length)return!1;var e=this.length>>>0;if(0===e)return!1;var t=arguments[0],r=Number(arguments[1])||0;for(r<0&&(r=Math.max(0,e+r));r<e;++r){var n=this[r];if(n===t||n!==n&&t!==t)return!0}return!1}}),Object.entries||Object.defineProperty(Object,"entries",{configurable:!0,writable:!0,value:function(e){if("object"!==(void 0===e?"undefined":_typeof(e))||null===e)throw new TypeError("Object.entries object parameter must be an object");return Object.keys(e).map(function(t){return[t,e[t]]})}}),Object.fromEntries||Object.defineProperty(Object,"fromEntries",{configurable:!0,writable:!0,value:function(e){return Array.from(e).reduce(function(e,t){if(Object(t)!==t)throw new TypeError("Object.fromEntries iterable parameter must yield objects");return t[0]in e?Object.defineProperty(e,t[0],{configurable:!0,enumerable:!0,writable:!0,value:t[1]}):e[t[0]]=t[1],e},{})}}),Object.getOwnPropertyDescriptors||Object.defineProperty(Object,"getOwnPropertyDescriptors",{configurable:!0,writable:!0,value:function(e){if(null==e)throw new TypeError("Object.getOwnPropertyDescriptors object parameter is null or undefined");var t=Object(e);return Reflect.ownKeys(t).reduce(function(e,r){var n=Object.getOwnPropertyDescriptor(t,r);return void 0!==n&&(r in e?Object.defineProperty(e,r,{configurable:!0,enumerable:!0,writable:!0,value:n}):e[r]=n),e},{})}}),Object.values||Object.defineProperty(Object,"values",{configurable:!0,writable:!0,value:function(e){if("object"!==(void 0===e?"undefined":_typeof(e))||null===e)throw new TypeError("Object.values object parameter must be an object");return Object.keys(e).map(function(t){return e[t]})}}),String.prototype.padStart||Object.defineProperty(String.prototype,"padStart",{configurable:!0,writable:!0,value:function(t,r){if(null==this)throw new TypeError("String.prototype.padStart called on null or undefined");var n=String(this),a=n.length,i=Number.parseInt(t,10);return i<=a?n:e(i-a,r)+n}}),String.prototype.padEnd||Object.defineProperty(String.prototype,"padEnd",{configurable:!0,writable:!0,value:function(t,r){if(null==this)throw new TypeError("String.prototype.padEnd called on null or undefined");var n=String(this),a=n.length,i=Number.parseInt(t,10);return i<=a?n:n+e(i-a,r)}}),String.prototype.trimStart||Object.defineProperty(String.prototype,"trimStart",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimStart called on null or undefined");return t(this,"start")}}),String.prototype.trimLeft||Object.defineProperty(String.prototype,"trimLeft",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimLeft called on null or undefined");return t(this,"start")}}),String.prototype.trimEnd||Object.defineProperty(String.prototype,"trimEnd",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimEnd called on null or undefined");return t(this,"end")}}),String.prototype.trimRight||Object.defineProperty(String.prototype,"trimRight",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.trimRight called on null or undefined");return t(this,"end")}})}(),function(){function _random(){var e=void 0,t=void 0;switch(arguments.length){case 0:throw new Error("_random called with insufficient parameters");case 1:e=0,t=arguments[0];break;default:e=arguments[0],t=arguments[1]}if(e>t){var r=[t,e];e=r[0],t=r[1]}return Math.floor(_nativeMathRandom()*(t-e+1))+e}function _randomIndex(e,t){var r=void 0,n=void 0;switch(t.length){case 1:r=0,n=e-1;break;case 2:r=0,n=Math.trunc(t[1]);break;default:r=Math.trunc(t[1]),n=Math.trunc(t[2])}return Number.isNaN(r)?r=0:!Number.isFinite(r)||r>=e?r=e-1:r<0&&(r=e+r)<0&&(r=0),Number.isNaN(n)?n=0:!Number.isFinite(n)||n>=e?n=e-1:n<0&&(n=e+n)<0&&(n=e-1),_random(r,n)}function _getCodePointStartAndEnd(e,t){var r=e.charCodeAt(t);if(Number.isNaN(r))return{char:"",start:-1,end:-1};if(r<55296||r>57343)return{char:e.charAt(t),start:t,end:t};if(r>=55296&&r<=56319){var n=t+1;if(n>=e.length)throw new Error("high surrogate without trailing low surrogate");var a=e.charCodeAt(n);if(a<56320||a>57343)throw new Error("high surrogate without trailing low surrogate");return{char:e.charAt(t)+e.charAt(n),start:t,end:n}}if(0===t)throw new Error("low surrogate without leading high surrogate");var i=t-1,o=e.charCodeAt(i);if(o<55296||o>56319)throw new Error("low surrogate without leading high surrogate");return{char:e.charAt(i)+e.charAt(t),start:i,end:t}}var _nativeMathRandom=Math.random;Object.defineProperty(Array,"random",{configurable:!0,writable:!0,value:function(e){if("object"!==(void 0===e?"undefined":_typeof(e))||null===e||!Object.prototype.hasOwnProperty.call(e,"length"))throw new TypeError("Array.random array parameter must be an array or array-lke object");var t=e.length>>>0;if(0!==t){return e[0===arguments.length?_random(0,t-1):_randomIndex(t,Array.prototype.slice.call(arguments,1))]}}}),Object.defineProperty(Array.prototype,"concatUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.concatUnique called on null or undefined");var e=Array.from(this);if(0===arguments.length)return e;var t=Array.prototype.reduce.call(arguments,function(e,t){return e.concat(t)},[]),r=t.length;if(0===r)return e;for(var n=Array.prototype.indexOf,a=Array.prototype.push,i=0;i<r;++i){var o=t[i];-1===n.call(e,o)&&a.call(e,o)}return e}}),Object.defineProperty(Array.prototype,"count",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.count called on null or undefined");for(var e=Array.prototype.indexOf,t=arguments[0],r=Number(arguments[1])||0,n=0;-1!==(r=e.call(this,t,r));)++n,++r;return n}}),Object.defineProperty(Array.prototype,"delete",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.delete called on null or undefined");if(0===arguments.length)return[];var e=this.length>>>0;if(0===e)return[];for(var t=Array.prototype.concat.apply([],arguments),r=t.length,n=[],a=0;a<e;++a)for(var i=this[a],o=0;o<r;++o){var s=t[o];if(i===s||i!==i&&s!==s){n.push(a);break}}for(var u=[],l=0,c=n.length;l<c;++l)u[l]=this[n[l]];for(var d=Array.prototype.splice,f=n.length-1;f>=0;--f)d.call(this,n[f],1);return u}}),Object.defineProperty(Array.prototype,"deleteAt",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.deleteAt called on null or undefined");if(0===arguments.length)return[];var e=this.length>>>0;if(0===e)return[];for(var t=Array.prototype.splice,r=[].concat(_toConsumableArray(new Set(Array.prototype.concat.apply([],arguments).map(function(t){return t<0?Math.max(0,e+t):t})).values())),n=[].concat(_toConsumableArray(r)).sort(function(e,t){return t-e}),a=[],i=0,o=r.length;i<o;++i)a[i]=this[r[i]];for(var s=0,u=n.length;s<u;++s)t.call(this,n[s],1);return a}}),Object.defineProperty(Array.prototype,"deleteWith",{configurable:!0,writable:!0,value:function(e,t){if(null==this)throw new TypeError("Array.prototype.deleteWith called on null or undefined");if("function"!=typeof e)throw new Error("Array.prototype.deleteWith predicate parameter must be a function");var r=this.length>>>0;if(0===r)return[];for(var n=Array.prototype.splice,a=[],i=[],o=0;o<r;++o)e.call(t,this[o],o,this)&&(i.push(this[o]),a.push(o));for(var s=a.length-1;s>=0;--s)n.call(this,a[s],1);return i}}),Object.defineProperty(Array.prototype,"first",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.first called on null or undefined");if(0!=this.length>>>0)return this[0]}}),Object.defineProperty(Array.prototype,"includesAll",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.includesAll called on null or undefined");if(1===arguments.length)return Array.isArray(arguments[0])?Array.prototype.includesAll.apply(this,arguments[0]):Array.prototype.includes.apply(this,arguments);for(var e=0,t=arguments.length;e<t;++e)if(!Array.prototype.some.call(this,function(e){return e===this.val||e!==e&&this.val!==this.val},{val:arguments[e]}))return!1;return!0}}),Object.defineProperty(Array.prototype,"includesAny",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.includesAny called on null or undefined");if(1===arguments.length)return Array.isArray(arguments[0])?Array.prototype.includesAny.apply(this,arguments[0]):Array.prototype.includes.apply(this,arguments);for(var e=0,t=arguments.length;e<t;++e)if(Array.prototype.some.call(this,function(e){return e===this.val||e!==e&&this.val!==this.val},{val:arguments[e]}))return!0;return!1}}),Object.defineProperty(Array.prototype,"last",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.last called on null or undefined");var e=this.length>>>0;if(0!==e)return this[e-1]}}),Object.defineProperty(Array.prototype,"pluck",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.pluck called on null or undefined");var e=this.length>>>0;if(0!==e){var t=0===arguments.length?_random(0,e-1):_randomIndex(e,[].concat(Array.prototype.slice.call(arguments)));return Array.prototype.splice.call(this,t,1)[0]}}}),Object.defineProperty(Array.prototype,"pluckMany",{configurable:!0,writable:!0,value:function(e){if(null==this)throw new TypeError("Array.prototype.pluckMany called on null or undefined");var t=this.length>>>0;if(0===t)return[];var r=Math.trunc(e);if(!Number.isInteger(r))throw new Error("Array.prototype.pluckMany want parameter must be an integer");if(r<1)return[];r>t&&(r=t);var n=Array.prototype.splice,a=[],i=t-1;do{a.push(n.call(this,_random(0,i--),1)[0])}while(a.length<r);return a}}),Object.defineProperty(Array.prototype,"pushUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.pushUnique called on null or undefined");var e=arguments.length;if(0===e)return this.length>>>0;for(var t=Array.prototype.indexOf,r=Array.prototype.push,n=0;n<e;++n){var a=arguments[n];-1===t.call(this,a)&&r.call(this,a)}return this.length>>>0}}),Object.defineProperty(Array.prototype,"random",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.random called on null or undefined");var e=this.length>>>0;if(0!==e){return this[0===arguments.length?_random(0,e-1):_randomIndex(e,[].concat(Array.prototype.slice.call(arguments)))]}}}),Object.defineProperty(Array.prototype,"randomMany",{configurable:!0,writable:!0,value:function(e){if(null==this)throw new TypeError("Array.prototype.randomMany called on null or undefined");var t=this.length>>>0;if(0===t)return[];var r=Math.trunc(e);if(!Number.isInteger(r))throw new Error("Array.prototype.randomMany want parameter must be an integer");if(r<1)return[];r>t&&(r=t);var n=new Map,a=[],i=t-1;do{var o=void 0;do{o=_random(0,i)}while(n.has(o));n.set(o,!0),a.push(this[o])}while(a.length<r);return a}}),Object.defineProperty(Array.prototype,"shuffle",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.shuffle called on null or undefined");var e=this.length>>>0;if(0===e)return this;for(var t=e-1;t>0;--t){var r=Math.floor(_nativeMathRandom()*(t+1));if(t!==r){var n=this[t];this[t]=this[r],this[r]=n}}return this}}),Object.defineProperty(Array.prototype,"unshiftUnique",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.unshiftUnique called on null or undefined");var e=arguments.length;if(0===e)return this.length>>>0;for(var t=Array.prototype.indexOf,r=Array.prototype.unshift,n=0;n<e;++n){var a=arguments[n];-1===t.call(this,a)&&r.call(this,a)}return this.length>>>0}}),Object.defineProperty(Function.prototype,"partial",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Function.prototype.partial called on null or undefined");var e=Array.prototype.slice,t=this,r=e.call(arguments,0);return function(){for(var n=[],a=0,i=0;i<r.length;++i)n.push(r[i]===undefined?arguments[a++]:r[i]);return t.apply(this,n.concat(e.call(arguments,a)))}}}),Object.defineProperty(Math,"clamp",{configurable:!0,writable:!0,value:function(e,t,r){var n=Number(e);return Number.isNaN(n)?NaN:n.clamp(t,r)}}),Object.defineProperty(Math,"easeInOut",{configurable:!0,writable:!0,value:function(e){return 1-(Math.cos(Number(e)*Math.PI)+1)/2}}),Object.defineProperty(Number.prototype,"clamp",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Number.prototype.clamp called on null or undefined");if(2!==arguments.length)throw new Error("Number.prototype.clamp called with an incorrect number of parameters");var e=Number(arguments[0]),t=Number(arguments[1]);if(e>t){var r=[t,e];e=r[0],t=r[1]}return Math.min(Math.max(this,e),t)}}),RegExp.escape||function(){var e=/[\\^$*+?.()|[\]{}]/g,t=new RegExp(e.source);Object.defineProperty(RegExp,"escape",{configurable:!0,writable:!0,value:function(r){var n=String(r);return n&&t.test(n)?n.replace(e,"\\$&"):n}})}(),function(){var e=/{(\d+)(?:,([+-]?\d+))?}/g,t=new RegExp(e.source);Object.defineProperty(String,"format",{configurable:!0,writable:!0,value:function(r){function n(e,t,r){if(!t)return e;var n=Math.abs(t)-e.length;if(n<1)return e;var a=String(r).repeat(n);return t<0?e+a:a+e}if(arguments.length<2)return 0===arguments.length?"":r;var a=2===arguments.length&&Array.isArray(arguments[1])?[].concat(_toConsumableArray(arguments[1])):Array.prototype.slice.call(arguments,1);return 0===a.length?r:t.test(r)?(e.lastIndex=0,r.replace(e,function(e,t,r){var i=a[t];if(null==i)return"";for(;"function"==typeof i;)i=i();switch(void 0===i?"undefined":_typeof(i)){case"string":break;case"object":i=JSON.stringify(i);break;default:i=String(i)}return n(i,r?Number.parseInt(r,10):0," ")})):r}})}(),Object.defineProperty(String.prototype,"contains",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.contains called on null or undefined");return-1!==String.prototype.indexOf.apply(this,arguments)}}),Object.defineProperty(String.prototype,"count",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.count called on null or undefined");var e=String(arguments[0]||"");if(""===e)return 0;for(var t=String.prototype.indexOf,r=e.length,n=Number(arguments[1])||0,a=0;-1!==(n=t.call(this,e,n));)++a,n+=r;return a}}),Object.defineProperty(String.prototype,"first",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.first called on null or undefined");return _getCodePointStartAndEnd(String(this),0).char}}),Object.defineProperty(String.prototype,"last",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.last called on null or undefined");var e=String(this);return _getCodePointStartAndEnd(e,e.length-1).char}}),Object.defineProperty(String.prototype,"splice",{configurable:!0,writable:!0,value:function(e,t,r){if(null==this)throw new TypeError("String.prototype.splice called on null or undefined");var n=this.length>>>0;if(0===n)return"";var a=Number(e);Number.isSafeInteger(a)?a<0&&(a+=n)<0&&(a=0):a=0,a>n&&(a=n);var i=Number(t);(!Number.isSafeInteger(i)||i<0)&&(i=0);var o=this.slice(0,a);return void 0!==r&&(o+=r),a+i<n&&(o+=this.slice(a+i)),o}}),Object.defineProperty(String.prototype,"splitOrEmpty",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.splitOrEmpty called on null or undefined");return""===String(this)?[]:String.prototype.split.apply(this,arguments)}}),Object.defineProperty(String.prototype,"toLocaleUpperFirst",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.toLocaleUpperFirst called on null or undefined");var e=String(this),t=_getCodePointStartAndEnd(e,0),r=t.char,n=t.end;return-1===n?"":r.toLocaleUpperCase()+e.slice(n+1)}}),Object.defineProperty(String.prototype,"toUpperFirst",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.toUpperFirst called on null or undefined");var e=String(this),t=_getCodePointStartAndEnd(e,0),r=t.char,n=t.end;return-1===n?"":r.toUpperCase()+e.slice(n+1)}}),Object.defineProperty(Date.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:date)",this.toISOString()]}}),Object.defineProperty(Function.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:eval)","("+this.toString()+")"]}}),Object.defineProperty(Map.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:map)",[].concat(_toConsumableArray(this))]}}),Object.defineProperty(RegExp.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:eval)",this.toString()]}}),Object.defineProperty(Set.prototype,"toJSON",{configurable:!0,writable:!0,value:function(){return["(revive:set)",[].concat(_toConsumableArray(this))]}}),Object.defineProperty(JSON,"reviveWrapper",{configurable:!0,writable:!0,value:function(e,t){if("string"!=typeof e)throw new TypeError("JSON.reviveWrapper code parameter must be a string");return["(revive:eval)",[e,t]]}}),Object.defineProperty(JSON,"_real_parse",{value:JSON.parse}),Object.defineProperty(JSON,"parse",{configurable:!0,writable:!0,value:function value(text,reviver){return JSON._real_parse(text,function(key,val){var value=val;if(Array.isArray(value)&&2===value.length)switch(value[0]){case"(revive:set)":value=new Set(value[1]);break;case"(revive:map)":value=new Map(value[1]);break;case"(revive:date)":value=new Date(value[1]);break;case"(revive:eval)":try{if(Array.isArray(value[1])){var $ReviveData$=value[1][1];value=eval(value[1][0])}else value=eval(value[1])}catch(e){}}else if("string"==typeof value&&"@@revive@@"===value.slice(0,10))try{value=eval(value.slice(10))}catch(e){}if("function"==typeof reviver)try{value=reviver(key,value)}catch(e){}return value})}}),Object.defineProperty(Array.prototype,"contains",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.contains called on null or undefined");return Array.prototype.includes.apply(this,arguments)}}),Object.defineProperty(Array.prototype,"containsAll",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.containsAll called on null or undefined");return Array.prototype.includesAll.apply(this,arguments)}}),Object.defineProperty(Array.prototype,"containsAny",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.containsAny called on null or undefined");return Array.prototype.includesAny.apply(this,arguments)}}),Object.defineProperty(Array.prototype,"flatten",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("Array.prototype.flatten called on null or undefined");return Array.prototype.flat.call(this,1/0)}}),Object.defineProperty(String.prototype,"readBracketedList",{configurable:!0,writable:!0,value:function(){if(null==this)throw new TypeError("String.prototype.readBracketedList called on null or undefined");for(var e=new RegExp("(?:\\[\\[((?:\\s|\\S)*?)\\]\\])|([^\"'\\s]\\S*)","gm"),t=[],r=void 0;null!==(r=e.exec(this));)r[1]?t.push(r[1]):r[2]&&t.push(r[2]);return t}})}();var Browser=function(){var e=navigator.userAgent.toLowerCase(),t=e.includes("windows phone"),r=Object.freeze({Android:!t&&e.includes("android"),BlackBerry:/blackberry|bb10/.test(e),iOS:!t&&/ip(?:hone|ad|od)/.test(e),Opera:!t&&("object"===_typeof(window.operamini)||e.includes("opera mini")),Windows:t||/iemobile|wpdesktop/.test(e),any:function(){return r.Android||r.BlackBerry||r.iOS||r.Opera||r.Windows}}),n=!r.Windows&&!/khtml|trident|edge/.test(e)&&e.includes("gecko"),a=!e.includes("opera")&&/msie|trident/.test(e),i=a?function(){var t=/(?:msie\s+|rv:)(\d+\.\d)/.exec(e);return t?Number(t[1]):0}():null,o=e.includes("opera")||e.includes(" opr/"),s=o?function(){var t=new RegExp((/khtml|chrome/.test(e)?"opr":"version")+"\\/(\\d+\\.\\d+)"),r=t.exec(e);return r?Number(r[1]):0}():null,u=e.includes("vivaldi");return Object.freeze({userAgent:e,isMobile:r,isGecko:n,isIE:a,ieVersion:i,isOpera:o,operaVersion:s,isVivaldi:u})}(),Has=function(){var e=function(){try{return"function"==typeof document.createElement("audio").canPlayType}catch(e){}return!1}(),t=e&&function(){try{var e=document.createElement("audio").play();return e.catch(function(){}),e instanceof Promise}catch(e){}return!1}(),r=function(){try{return"Blob"in window&&"File"in window&&"FileList"in window&&"FileReader"in window&&!Browser.isMobile.any()&&(!Browser.isOpera||Browser.operaVersion>=15)}catch(e){}return!1}(),n=function(){try{return"geolocation"in navigator&&"function"==typeof navigator.geolocation.getCurrentPosition&&"function"==typeof navigator.geolocation.watchPosition}catch(e){}return!1}(),a=function(){try{return"MutationObserver"in window&&"function"==typeof window.MutationObserver}catch(e){}return!1}(),i=function(){try{return"performance"in window&&"function"==typeof window.performance.now}catch(e){}return!1}(),o=function(){try{return"ontouchstart"in window||!!window.DocumentTouch&&document instanceof window.DocumentTouch||!!navigator.maxTouchPoints||!!navigator.msMaxTouchPoints}catch(e){}return!1}(),s=function(){try{for(var e=new Map([["transition","transitionend"],["MSTransition","msTransitionEnd"],["WebkitTransition","webkitTransitionEnd"],["MozTransition","transitionend"]]),t=[].concat(_toConsumableArray(e.keys())),r=document.createElement("div"),n=0;n<t.length;++n)if(r.style[t[n]]!==undefined)return e.get(t[n])}catch(e){}return!1}();return Object.freeze({audio:e,audioPromise:t,fileAPI:r,geolocation:n,mutationObserver:a,performance:i,touch:o,transitionEndEvent:s})}(),Visibility=function(){function e(){return Boolean(r&&document[r.hiddenProperty])}function t(){return r&&document[r.stateProperty]||"visible"}var r=function(){try{return Object.freeze([{hiddenProperty:"hidden",stateProperty:"visibilityState",changeEvent:"visibilitychange"},{hiddenProperty:"webkitHidden",stateProperty:"webkitVisibilityState",changeEvent:"webkitvisibilitychange"},{hiddenProperty:"mozHidden",stateProperty:"mozVisibilityState",changeEvent:"mozvisibilitychange"},{hiddenProperty:"msHidden",stateProperty:"msVisibilityState",changeEvent:"msvisibilitychange"}].find(function(e){return e.hiddenProperty in document}))}catch(e){}return null}();return Object.freeze(Object.defineProperties({},{isHidden:{value:e},state:{value:t},hiddenProperty:{value:r.hiddenProperty},stateProperty:{value:r.stateProperty},changeEvent:{value:r.changeEvent}}))}(),_ref3=function(){function e(t){if("object"!==(void 0===t?"undefined":_typeof(t))||null===t)return t;if(t instanceof String)return String(t);if(t instanceof Number)return Number(t);if(t instanceof Boolean)return Boolean(t);if("function"==typeof t.clone)return t.clone(!0);if(t.nodeType&&"function"==typeof t.cloneNode)return t.cloneNode(!0);var r=void 0;return t instanceof Array?r=new Array(t.length):t instanceof Date?r=new Date(t.getTime()):t instanceof Map?(r=new Map,t.forEach(function(t,n){return r.set(n,e(t))})):t instanceof RegExp?r=new RegExp(t):t instanceof Set?(r=new Set,t.forEach(function(t){return r.add(e(t))})):r=Object.create(Object.getPrototypeOf(t)),Object.keys(t).forEach(function(n){return r[n]=e(t[n])}),r}function t(e){for(var t=document.createDocumentFragment(),r=document.createElement("p"),n=void 0;null!==(n=e.firstChild);){if(n.nodeType===Node.ELEMENT_NODE){switch(n.nodeName.toUpperCase()){case"BR":if(null!==n.nextSibling&&n.nextSibling.nodeType===Node.ELEMENT_NODE&&"BR"===n.nextSibling.nodeName.toUpperCase()){e.removeChild(n.nextSibling),e.removeChild(n),t.appendChild(r),r=document.createElement("p");continue}if(!r.hasChildNodes()){e.removeChild(n);continue}break;case"ADDRESS":case"ARTICLE":case"ASIDE":case"BLOCKQUOTE":case"CENTER":case"DIV":case"DL":case"FIGURE":case"FOOTER":case"FORM":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"HEADER":case"HR":case"MAIN":case"NAV":case"OL":case"P":case"PRE":case"SECTION":case"TABLE":case"UL":r.hasChildNodes()&&(t.appendChild(r),r=document.createElement("p")),t.appendChild(n);continue}}r.appendChild(n)}r.hasChildNodes()&&t.appendChild(r),e.appendChild(t)}function r(){try{return document.activeElement||null}catch(e){return null}}function n(e,t,r){var n="object"===(void 0===e?"undefined":_typeof(e))?e:document.getElementById(e);if(null==n)return null;var a=Array.isArray(t)?t:[t];jQuery(n).empty();for(var i=0,o=a.length;i<o;++i)if(Story.has(a[i]))return new Wikifier(n,Story.get(a[i]).processText().trim()),n;if(null!=r){var s=String(r).trim();""!==s&&new Wikifier(n,s)}return n}function a(e,t,r){var n=jQuery(document.createElement("div")),a=jQuery(document.createElement("button")),i=jQuery(document.createElement("pre")),o=L10n.get("errorTitle")+": "+(t||"unknown error");return a.addClass("error-toggle").ariaClick({label:L10n.get("errorToggle")},function(){a.hasClass("enabled")?(a.removeClass("enabled"),i.attr({"aria-hidden":!0,hidden:"hidden"})):(a.addClass("enabled"),i.removeAttr("aria-hidden hidden"))}).appendTo(n),jQuery(document.createElement("span")).addClass("error").text(o).appendTo(n),jQuery(document.createElement("code")).text(r).appendTo(i),i.addClass("error-source").attr({"aria-hidden":!0,hidden:"hidden"}).appendTo(n),n.addClass("error-view").appendTo(e),console.warn(o+"\n\t"+r.replace(/\n/g,"\n\t")),!1}function i(e,t){var r=i;switch(void 0===e?"undefined":_typeof(e)){case"number":if(Number.isNaN(e))return t;break;case"object":if(null===e)return t;if(Array.isArray(e))return e.map(function(e){return r(e,t)}).join(", ");if(e instanceof Set)return[].concat(_toConsumableArray(e)).map(function(e){return r(e,t)}).join(", ");if(e instanceof Map){return"{ "+[].concat(_toConsumableArray(e)).map(function(e){var n=_slicedToArray(e,2),a=n[0],i=n[1];return r(a,t)+" → "+r(i,t)}).join(", ")+" }"}return e instanceof Date?e.toLocaleString():"function"==typeof e.toString?e.toString():Object.prototype.toString.call(e);case"function":case"undefined":return t}return String(e)}return Object.freeze(Object.defineProperties({},{clone:{value:e},convertBreaks:{value:t},safeActiveElement:{value:r},setPageElement:{value:n},throwError:{value:a},toStringOrDefault:{value:i}}))
}(),clone=_ref3.clone,convertBreaks=_ref3.convertBreaks,safeActiveElement=_ref3.safeActiveElement,setPageElement=_ref3.setPageElement,throwError=_ref3.throwError,toStringOrDefault=_ref3.toStringOrDefault;!function(){function e(e){13!==e.which&&32!==e.which||(e.preventDefault(),jQuery(safeActiveElement()||this).trigger("click"))}function t(e){return function(){var t=jQuery(this);t.ariaIsDisabled()||(t.is("[aria-pressed]")&&t.attr("aria-pressed","true"===t.attr("aria-pressed")?"false":"true"),e.apply(this,arguments))}}function r(e){return t(function(){jQuery(this).off(".aria-clickable").removeAttr("tabindex aria-controls aria-pressed").not("a,button").removeAttr("role").end().filter("button").prop("disabled",!0),e.apply(this,arguments)})}jQuery.fn.extend({ariaClick:function(n,a){if(0===this.length||0===arguments.length)return this;var i=n,o=a;return null==o&&(o=i,i=undefined),i=jQuery.extend({namespace:undefined,one:!1,selector:undefined,data:undefined,controls:undefined,pressed:undefined,label:undefined},i),"string"!=typeof i.namespace?i.namespace="":"."!==i.namespace[0]&&(i.namespace="."+i.namespace),"boolean"==typeof i.pressed&&(i.pressed=i.pressed?"true":"false"),this.filter("button").prop("type","button"),this.not("a,button").attr("role","button"),this.attr("tabindex",0),null!=i.controls&&this.attr("aria-controls",i.controls),null!=i.pressed&&this.attr("aria-pressed",i.pressed),null!=i.label&&this.attr({"aria-label":i.label,title:i.label}),this.not("button").on("keypress.aria-clickable"+i.namespace,i.selector,e),this.on("click.aria-clickable"+i.namespace,i.selector,i.data,i.one?r(o):t(o)),this},ariaDisabled:function(e){if(0===this.length||0===arguments.length)return this;var t=this.not("button,fieldset,input,menuitem,optgroup,option,select,textarea"),r=this.filter("button,fieldset,input,menuitem,optgroup,option,select,textarea");return e?(t.each(function(){this.setAttribute("disabled",""),this.setAttribute("aria-disabled","")}),r.each(function(){this.disabled=!0,this.setAttribute("aria-disabled","")})):(t.each(function(){this.removeAttribute("disabled"),this.removeAttribute("aria-disabled")}),r.each(function(){this.disabled=!1,this.removeAttribute("aria-disabled")})),this},ariaIsDisabled:function(){return this.is("[disabled]")}})}(),function(){jQuery.extend({wikiWithOptions:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];if(0!==r.length){var a=document.createDocumentFragment();r.forEach(function(t){return new Wikifier(a,t,e)});var i=[].concat(_toConsumableArray(a.querySelectorAll(".error"))).map(function(e){return e.textContent.replace(errorPrologRegExp,"")});if(i.length>0)throw new Error(i.join("; "))}},wiki:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.wikiWithOptions.apply(this,[undefined].concat(t))}}),jQuery.fn.extend({wikiWithOptions:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];if(0===this.length||0===r.length)return this;var a=document.createDocumentFragment();return r.forEach(function(t){return new Wikifier(a,t,e)}),this.append(a),this},wiki:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.wikiWithOptions.apply(this,[undefined].concat(t))}})}();var Util=function(){function e(e){if(e instanceof Array)return Object.freeze(e.reduce(function(e,t,r){return e[t]=r,e},Object.create(null)));if(e instanceof Object)return Object.freeze(Object.assign(Object.create(null),e));throw new TypeError("Util.toEnum obj parameter must be an array or generic object")}function t(e){return Object.prototype.toString.call(e).slice(8,-1)}function r(e){if(null===e)return"null";var t=void 0===e?"undefined":_typeof(e);return"object"===t?Object.prototype.toString.call(e).slice(8,-1):t}function n(e){var t=void 0;switch(void 0===e?"undefined":_typeof(e)){case"number":t=e;break;case"string":t=Number(e);break;default:return!1}return!Number.isNaN(t)&&Number.isFinite(t)}function a(e){return"boolean"==typeof e||"string"==typeof e&&("true"===e||"false"===e)}function i(e,t){return e===t||e!==e&&t!==t}function o(e){var t=String(e).trim(),r=t.replace(/[^\w\s\u2013\u2014-]+/g,"").replace(/[_\s\u2013\u2014-]+/g,"-").toLocaleLowerCase();return v.test(r)?t.replace(m,"").replace(/[_\s\u2013\u2014-]+/g,"-"):r}function s(e){if(null==e)return"";var t=String(e);return t&&b.test(t)?t.replace(y,function(e){return w[e]}):t}function u(e){if(null==e)return"";var t=String(e);return t&&S.test(t)?t.replace(k,function(e){return E[e.toLowerCase()]}):t}function l(e,t){var r=String(e),n=Math.trunc(t),a=r.charCodeAt(n);if(Number.isNaN(a))return{char:"",start:-1,end:-1};var i={char:r.charAt(n),start:n,end:n};if(a<55296||a>57343)return i;if(a>=55296&&a<=56319){var o=n+1;if(o>=r.length)return i;var s=r.charCodeAt(o);return s<56320||s>57343?i:(i.char=i.char+r.charAt(o),i.end=o,i)}if(0===n)return i;var u=n-1,l=r.charCodeAt(u);return l<55296||l>56319?i:(i.char=r.charAt(u)+i.char,i.start=u,i)}function c(){return j.now()}function d(e){var t=x.exec(String(e));if(null===t)throw new SyntaxError('invalid time value syntax: "'+e+'"');var r=Number(t[1]);if(1===t[2].length&&(r*=1e3),Number.isNaN(r)||!Number.isFinite(r))throw new RangeError('invalid time value: "'+e+'"');return r}function f(e){if("number"!=typeof e||Number.isNaN(e)||!Number.isFinite(e)){var r=void 0;switch(void 0===e?"undefined":_typeof(e)){case"string":r='"'+e+'"';break;case"number":r=String(e);break;default:r=t(e)}throw new Error("invalid milliseconds: "+r)}return e+"ms"}function p(e){if(!e.includes("-"))switch(e){case"bgcolor":return"backgroundColor";case"float":return"cssFloat";default:return e}return("-ms-"===e.slice(0,4)?e.slice(1):e).split("-").map(function(e,t){return 0===t?e:e.toUpperFirst()}).join("")}function h(e){var t=document.createElement("a"),r=Object.create(null);t.href=e,t.search&&t.search.replace(/^\?/,"").splitOrEmpty(/(?:&(?:amp;)?|;)/).forEach(function(e){var t=e.split("="),n=_slicedToArray(t,2),a=n[0],i=n[1];r[a]=i});var n=t.host&&"/"!==t.pathname[0]?"/"+t.pathname:t.pathname;return{href:t.href,protocol:t.protocol,host:t.host,hostname:t.hostname,port:t.port,path:""+n+t.search,pathname:n,query:t.search,search:t.search,queries:r,searches:r,hash:t.hash}}function g(e,t,r){if("object"!==(void 0===e?"undefined":_typeof(e))||null===e)throw new Error("Util.newExceptionFrom original parameter must be an object");if("function"!=typeof t)throw new Error("Util.newExceptionFrom exceptionType parameter must be an error type constructor");var n=new t(e.message);void 0!==e.name&&(n.name=e.name),void 0!==e.code&&(n.code=e.code),void 0!==e.columnNumber&&(n.columnNumber=e.columnNumber),void 0!==e.description&&(n.description=e.description),void 0!==e.fileName&&(n.fileName=e.fileName),void 0!==e.lineNumber&&(n.lineNumber=e.lineNumber),void 0!==e.number&&(n.number=e.number),void 0!==e.stack&&(n.stack=e.stack);var a=void 0===r?"undefined":_typeof(r);if("undefined"!==a)if("object"===a&&null!==r)Object.assign(n,r);else{if("string"!==a)throw new Error("Util.newExceptionFrom override parameter must be an object or string");n.message=r}return n}var m=/[\x00-\x1f"#$%&'*+,\/:;<=>?\\^`|\x7f-\x9f]+/g,v=/^-*$/,y=/[&<>"'`]/g,b=new RegExp(y.source),w=Object.freeze({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"}),k=/&(?:amp|#38|#x26|lt|#60|#x3c|gt|#62|#x3e|quot|#34|#x22|apos|#39|#x27|#96|#x60);/gi,S=new RegExp(k.source,"i"),E=Object.freeze({"&amp;":"&","&#38;":"&","&#x26;":"&","&lt;":"<","&#60;":"<","&#x3c;":"<","&gt;":">","&#62;":">","&#x3e;":">","&quot;":'"',"&#34;":'"',"&#x22;":'"',"&apos;":"'","&#39;":"'","&#x27;":"'","&#96;":"`","&#x60;":"`"}),j=Has.performance?performance:Date,x=/^([+-]?(?:\d*\.)?\d+)([Mm]?[Ss])$/;return Object.freeze(Object.defineProperties({},{toEnum:{value:e},toStringTag:{value:t},getType:{value:r},isNumeric:{value:n},isBoolean:{value:a},sameValueZero:{value:i},slugify:{value:o},escape:{value:s},unescape:{value:u},charAndPosAt:{value:l},fromCssTime:{value:d},toCssTime:{value:f},fromCssProperty:{value:p},parseUrl:{value:h},newExceptionFrom:{value:g},now:{value:c},random:{value:Math.random},entityEncode:{value:s},entityDecode:{value:u},evalExpression:{value:function(){return Scripting.evalJavaScript.apply(Scripting,arguments)}},evalStatements:{value:function(){return Scripting.evalJavaScript.apply(Scripting,arguments)}}}))}(),SimpleStore=function(){function e(e,n){if(r)return r.create(e,n);for(var a=0;a<t.length;++a)if(t[a].init(e,n))return r=t[a],r.create(e,n);throw new Error("no valid storage adapters found")}var t=[],r=null;return Object.freeze(Object.defineProperties({},{adapters:{value:t},create:{value:e}}))}();SimpleStore.adapters.push(function(){function e(){function e(e){try{var t=window[e],r="_sc_"+String(Date.now());t.setItem(r,r);var n=t.getItem(r)===r;return t.removeItem(r),n}catch(e){}return!1}return r=e("localStorage")&&e("sessionStorage")}function t(e,t){if(!r)throw new Error("adapter not initialized");return new n(e,t)}var r=!1,n=function(){function e(t,r){_classCallCheck(this,e);var n=t+".",a=null,i=null;r?(a=window.localStorage,i="localStorage"):(a=window.sessionStorage,i="sessionStorage"),Object.defineProperties(this,{_engine:{value:a},_prefix:{value:n},_prefixRe:{value:new RegExp("^"+RegExp.escape(n))},name:{value:i},id:{value:t},persistent:{value:!!r}})}return _createClass(e,[{key:"size",value:function(){return this.keys().length}},{key:"keys",value:function(){for(var e=[],t=0;t<this._engine.length;++t){var r=this._engine.key(t);this._prefixRe.test(r)&&e.push(r.replace(this._prefixRe,""))}return e}},{key:"has",value:function(e){return!("string"!=typeof e||!e)&&this._engine.hasOwnProperty(this._prefix+e)}},{key:"get",value:function(t){if("string"!=typeof t||!t)return null;var r=this._engine.getItem(this._prefix+t);return null==r?null:e._deserialize(r)}},{key:"set",value:function(t,r){if("string"!=typeof t||!t)return!1;try{this._engine.setItem(this._prefix+t,e._serialize(r))}catch(e){if(/quota.?(?:exceeded|reached)/i.test(e.name+e.message))throw Util.newExceptionFrom(e,Error,this.name+" quota exceeded");throw e}return!0}},{key:"delete",value:function(e){return!("string"!=typeof e||!e)&&(this._engine.removeItem(this._prefix+e),!0)}},{key:"clear",value:function(){for(var e=this.keys(),t=0,r=e.length;t<r;++t)this.delete(e[t]);return!0}},{key:"length",get:function(){return this.keys().length}}],[{key:"_serialize",value:function(e){return LZString.compressToUTF16(JSON.stringify(e))}},{key:"_deserialize",value:function(e){return JSON.parse(LZString.decompressFromUTF16(e))}}]),e}();return Object.freeze(Object.defineProperties({},{init:{value:e},create:{value:t}}))}()),SimpleStore.adapters.push(function(){function e(e){try{var t="_sc_"+String(Date.now());o._setCookie(t,o._serialize(t),undefined),i=o._deserialize(o._getCookie(t))===t,o._setCookie(t,undefined,a)}catch(e){i=!1}return i&&r(e),i}function t(e,t){if(!i)throw new Error("adapter not initialized");return new o(e,t)}function r(e){if(""!==document.cookie)for(var t=e+".",r=new RegExp("^"+RegExp.escape(t)),i=e+"!.",s=e+"*.",u=/\.(?:state|rcWarn)$/,l=document.cookie.split(/;\s*/),c=0;c<l.length;++c){var d=l[c].split("="),f=decodeURIComponent(d[0]);if(r.test(f)){var p=decodeURIComponent(d[1]);""!==p&&function(){var e=!u.test(f);o._setCookie(f,undefined,a),o._setCookie(f.replace(r,function(){return e?i:s}),p,e?n:undefined)}()}}}var n="Tue, 19 Jan 2038 03:14:07 GMT",a="Thu, 01 Jan 1970 00:00:00 GMT",i=!1,o=function(){function e(t,r){_classCallCheck(this,e);var n=t+(r?"!":"*")+".";Object.defineProperties(this,{_prefix:{value:n},_prefixRe:{value:new RegExp("^"+RegExp.escape(n))},name:{value:"cookie"},id:{value:t},persistent:{value:!!r}})}return _createClass(e,[{key:"size",value:function(){return this.keys().length}},{key:"keys",value:function(){if(""===document.cookie)return[];for(var e=document.cookie.split(/;\s*/),t=[],r=0;r<e.length;++r){var n=e[r].split("="),a=decodeURIComponent(n[0]);if(this._prefixRe.test(a)){""!==decodeURIComponent(n[1])&&t.push(a.replace(this._prefixRe,""))}}return t}},{key:"has",value:function(t){return!("string"!=typeof t||!t)&&null!==e._getCookie(this._prefix+t)}},{key:"get",value:function(t){if("string"!=typeof t||!t)return null;var r=e._getCookie(this._prefix+t);return null===r?null:e._deserialize(r)}},{key:"set",value:function(t,r){if("string"!=typeof t||!t)return!1;try{if(e._setCookie(this._prefix+t,e._serialize(r),this.persistent?n:undefined),!this.has(t))throw new Error("unknown validation error during set")}catch(e){throw Util.newExceptionFrom(e,Error,"cookie error: "+e.message)}return!0}},{key:"delete",value:function(t){if("string"!=typeof t||!t||!this.has(t))return!1;try{if(e._setCookie(this._prefix+t,undefined,a),this.has(t))throw new Error("unknown validation error during delete")}catch(e){throw Util.newExceptionFrom(e,Error,"cookie error: "+e.message)}return!0}},{key:"clear",value:function(){for(var e=this.keys(),t=0,r=e.length;t<r;++t)this.delete(e[t]);return!0}},{key:"length",get:function(){return this.keys().length}}],[{key:"_getCookie",value:function(e){if(!e||""===document.cookie)return null;for(var t=document.cookie.split(/;\s*/),r=0;r<t.length;++r){var n=t[r].split("=");if(e===decodeURIComponent(n[0])){return decodeURIComponent(n[1])||null}}return null}},{key:"_setCookie",value:function(e,t,r){if(e){var n=encodeURIComponent(e)+"=";null!=t&&(n+=encodeURIComponent(t)),null!=r&&(n+="; expires="+r),n+="; path=/",document.cookie=n}}},{key:"_serialize",value:function(e){return LZString.compressToBase64(JSON.stringify(e))}},{key:"_deserialize",value:function(e){return JSON.parse(LZString.decompressFromBase64(e))}}]),e}();return Object.freeze(Object.defineProperties({},{init:{value:e},create:{value:t}}))}());var DebugView=function(){return function(){function e(t,r,n,a){_classCallCheck(this,e),Object.defineProperties(this,{parent:{value:t},view:{value:document.createElement("span")},break:{value:document.createElement("wbr")}}),jQuery(this.view).attr({title:a,"aria-label":a,"data-type":null!=r?r:"","data-name":null!=n?n:""}).addClass("debug"),jQuery(this.break).addClass("debug hidden"),this.parent.appendChild(this.view),this.parent.appendChild(this.break)}return _createClass(e,[{key:"append",value:function(e){return jQuery(this.view).append(e),this}},{key:"modes",value:function(e){if(null==e){var t={};return this.view.className.splitOrEmpty(/\s+/).forEach(function(e){"debug"!==e&&(t[e]=!0)}),t}if("object"===(void 0===e?"undefined":_typeof(e)))return Object.keys(e).forEach(function(t){this[e[t]?"addClass":"removeClass"](t)},jQuery(this.view)),this;throw new Error("DebugView.prototype.modes options parameter must be an object or null/undefined")}},{key:"remove",value:function(){var e=jQuery(this.view);this.view.hasChildNodes()&&e.contents().appendTo(this.parent),e.remove(),jQuery(this.break).remove()}},{key:"output",get:function(){return this.view}},{key:"type",get:function(){return this.view.getAttribute("data-type")},set:function(e){this.view.setAttribute("data-type",null!=e?e:"")}},{key:"name",get:function(){return this.view.getAttribute("data-name")},set:function(e){this.view.setAttribute("data-name",null!=e?e:"")}},{key:"title",get:function(){return this.view.title},set:function(e){this.view.title=e}}],[{key:"isEnabled",value:function(){return"enabled"===jQuery(document.documentElement).attr("data-debug-view")}},{key:"enable",value:function(){jQuery(document.documentElement).attr("data-debug-view","enabled"),jQuery.event.trigger(":debugviewupdate")}},{key:"disable",value:function(){jQuery(document.documentElement).removeAttr("data-debug-view"),jQuery.event.trigger(":debugviewupdate")}},{key:"toggle",value:function(){"enabled"===jQuery(document.documentElement).attr("data-debug-view")?e.disable():e.enable()}}]),e}()}(),PRNGWrapper=function(){return function(){function e(t,r){_classCallCheck(this,e),Object.defineProperties(this,new Math.seedrandom(t,r,function(e,t){return{_prng:{value:e},seed:{writable:!0,value:t},pull:{writable:!0,value:0},random:{value:function(){return++this.pull,this._prng()}}}}))}return _createClass(e,null,[{key:"marshal",value:function(e){if(!e||!e.hasOwnProperty("seed")||!e.hasOwnProperty("pull"))throw new Error("PRNG is missing required data");return{seed:e.seed,pull:e.pull}}},{key:"unmarshal",value:function(t){if(!t||!t.hasOwnProperty("seed")||!t.hasOwnProperty("pull"))throw new Error("PRNG object is missing required data");for(var r=new e(t.seed,!1),n=t.pull;n>0;--n)r.random();return r}}]),e}()}(),StyleWrapper=function(){var e=new RegExp(Patterns.cssImage,"g"),t=new RegExp(Patterns.cssImage);return function(){function r(e){if(_classCallCheck(this,r),null==e)throw new TypeError("StyleWrapper style parameter must be an HTMLStyleElement object");Object.defineProperties(this,{style:{value:e}})}return _createClass(r,[{key:"isEmpty",value:function(){return 0===this.style.cssRules.length}},{key:"set",value:function(e){this.clear(),this.add(e)}},{key:"add",value:function(r){var n=r;t.test(n)&&(e.lastIndex=0,n=n.replace(e,function(e){var t=Wikifier.helpers.parseSquareBracketedMarkup({source:e,matchStart:0});if(t.hasOwnProperty("error")||t.pos<e.length)return e;var r=t.source;if("data:"!==r.slice(0,5)&&Story.has(r)){var n=Story.get(r);n.tags.includes("Twine.image")&&(r=n.text.trim())}return'url("'+r.replace(/"/g,"%22")+'")'})),this.style.styleSheet?this.style.styleSheet.cssText+=n:this.style.appendChild(document.createTextNode(n))}},{key:"clear",value:function(){this.style.styleSheet?this.style.styleSheet.cssText="":jQuery(this.style).empty()}}]),r}()}(),Diff=function(){function e(t,n){for(var a=Object.prototype.toString,i=t instanceof Array,o=[].concat(Object.keys(t),Object.keys(n)).sort().filter(function(e,t,r){return 0===t||r[t-1]!==e}),s={},u=void 0,l=function(e){return e===u},c=0,d=o.length;c<d;++c){var f=o[c],p=t[f],h=n[f];if(t.hasOwnProperty(f))if(n.hasOwnProperty(f)){if(p===h)continue;if((void 0===p?"undefined":_typeof(p))===(void 0===h?"undefined":_typeof(h)))if("function"==typeof p)p.toString()!==h.toString()&&(s[f]=[r.Copy,h]);else if("object"!==(void 0===p?"undefined":_typeof(p))||null===p)s[f]=[r.Copy,h];else{var g=a.call(p),m=a.call(h);if(g===m)if(p instanceof Date)Number(p)!==Number(h)&&(s[f]=[r.Copy,clone(h)]);else if(p instanceof Map)s[f]=[r.Copy,clone(h)];else if(p instanceof RegExp)p.toString()!==h.toString()&&(s[f]=[r.Copy,clone(h)]);else if(p instanceof Set)s[f]=[r.Copy,clone(h)];else if("[object Object]"!==g)s[f]=[r.Copy,clone(h)];else{var v=e(p,h);null!==v&&(s[f]=v)}else s[f]=[r.Copy,clone(h)]}else s[f]=[r.Copy,"object"!==(void 0===h?"undefined":_typeof(h))||null===h?h:clone(h)]}else if(i&&Util.isNumeric(f)){var y=Number(f);if(!u){u="";do{u+="~"}while(o.some(l));s[u]=[r.SpliceArray,y,y]}y<s[u][1]&&(s[u][1]=y),y>s[u][2]&&(s[u][2]=y)}else s[f]=r.Delete;else s[f]=[r.Copy,"object"!==(void 0===h?"undefined":_typeof(h))||null===h?h:clone(h)]}return Object.keys(s).length>0?s:null}function t(e,n){for(var a=Object.keys(n||{}),i=clone(e),o=0,s=a.length;o<s;++o){var u=a[o],l=n[u];if(l===r.Delete)delete i[u];else if(l instanceof Array)switch(l[0]){case r.SpliceArray:i.splice(l[1],l[2]-l[1]+1);break;case r.Copy:i[u]=clone(l[1]);break;case r.CopyDate:i[u]=new Date(l[1])}else i[u]=t(i[u],l)}return i}var r=Util.toEnum({Delete:0,SpliceArray:1,Copy:2,CopyDate:3});return Object.freeze(Object.defineProperties({},{Op:{value:r},diff:{value:e},patch:{value:t}}))}(),L10n=function(){function e(){r()}function t(e,t){if(!e)return"";var r=function(e){var t=void 0;return e.some(function(e){return!!l10nStrings.hasOwnProperty(e)&&(t=e,!0)}),t}(Array.isArray(e)?e:[e]);if(!r)return"";for(var i=l10nStrings[r],o=0;a.test(i);){if(++o>50)throw new Error("L10n.get exceeded maximum replacement iterations, probable infinite loop");n.lastIndex=0,i=i.replace(n,function(e){var r=e.slice(1,-1);return t&&t.hasOwnProperty(r)?t[r]:l10nStrings.hasOwnProperty(r)?l10nStrings[r]:void 0})}return i}function r(){strings&&Object.keys(strings).length>0&&Object.keys(l10nStrings).forEach(function(e){try{var t=void 0;switch(e){case"identity":t=strings.identity;break;case"aborting":t=strings.aborting;break;case"cancel":t=strings.cancel;break;case"close":t=strings.close;break;case"ok":t=strings.ok;break;case"errorTitle":t=strings.errors.title;break;case"errorNonexistentPassage":t=strings.errors.nonexistentPassage;break;case"errorSaveMissingData":t=strings.errors.saveMissingData;break;case"errorSaveIdMismatch":t=strings.errors.saveIdMismatch;break;case"warningDegraded":t=strings.warnings.degraded;break;case"debugViewTitle":t=strings.debugView.title;break;case"debugViewToggle":t=strings.debugView.toggle;break;case"uiBarToggle":t=strings.uiBar.toggle;break;case"uiBarBackward":t=strings.uiBar.backward;break;case"uiBarForward":t=strings.uiBar.forward;break;case"uiBarJumpto":t=strings.uiBar.jumpto;break;case"jumptoTitle":t=strings.jumpto.title;break;case"jumptoTurn":t=strings.jumpto.turn;break;case"jumptoUnavailable":t=strings.jumpto.unavailable;break;case"savesTitle":t=strings.saves.title;break;case"savesDisallowed":t=strings.saves.disallowed;break;case"savesIncapable":t=strings.saves.incapable;break;case"savesLabelAuto":t=strings.saves.labelAuto;break;case"savesLabelDelete":t=strings.saves.labelDelete;break;case"savesLabelExport":t=strings.saves.labelExport;break;case"savesLabelImport":t=strings.saves.labelImport;break;case"savesLabelLoad":t=strings.saves.labelLoad;break;case"savesLabelClear":t=strings.saves.labelClear;break;case"savesLabelSave":t=strings.saves.labelSave;break;case"savesLabelSlot":t=strings.saves.labelSlot;break;case"savesUnavailable":t=strings.saves.unavailable;break;case"savesUnknownDate":t=strings.saves.unknownDate;break;case"settingsTitle":t=strings.settings.title;break;case"settingsOff":t=strings.settings.off;break;case"settingsOn":t=strings.settings.on;break;case"settingsReset":t=strings.settings.reset;break;case"restartTitle":t=strings.restart.title;break;case"restartPrompt":t=strings.restart.prompt;break;case"shareTitle":t=strings.share.title;break;case"autoloadTitle":t=strings.autoload.title;break;case"autoloadCancel":t=strings.autoload.cancel;break;case"autoloadOk":t=strings.autoload.ok;break;case"autoloadPrompt":t=strings.autoload.prompt;break;case"macroBackText":t=strings.macros.back.text;break;case"macroReturnText":t=strings.macros.return.text}t&&(l10nStrings[e]=t.replace(/%\w+%/g,function(e){return"{"+e.slice(1,-1)+"}"}))}catch(e){}})}var n=/\{\w+\}/g,a=new RegExp(n.source);return Object.freeze(Object.defineProperties({},{init:{value:e},get:{value:t}}))}(),strings={errors:{},warnings:{},debugView:{},uiBar:{},jumpto:{},saves:{},settings:{},restart:{},share:{},autoload:{},macros:{back:{},return:{}}},l10nStrings={identity:"game",aborting:"Aborting",cancel:"Cancel",close:"Close",ok:"OK",errorTitle:"Error",errorToggle:"Toggle the error view",errorNonexistentPassage:'the passage "{passage}" does not exist',errorSaveMissingData:"save is missing required data. Either the loaded file is not a save or the save has become corrupted",errorSaveIdMismatch:"save is from the wrong {identity}",_warningIntroLacking:"Your browser either lacks or has disabled",_warningOutroDegraded:", so this {identity} is running in a degraded mode. You may be able to continue, however, some parts may not work properly.",warningNoWebStorage:"{_warningIntroLacking} the Web Storage API{_warningOutroDegraded}",warningDegraded:"{_warningIntroLacking} some of the capabilities required by this {identity}{_warningOutroDegraded}",debugBarToggle:"Toggle the debug bar",debugBarNoWatches:"— no watches set —",debugBarAddWatch:"Add watch",debugBarDeleteWatch:"Delete watch",debugBarWatchAll:"Watch all",debugBarWatchNone:"Delete all",debugBarLabelAdd:"Add",debugBarLabelWatch:"Watch",debugBarLabelTurn:"Turn",debugBarLabelViews:"Views",debugBarViewsToggle:"Toggle the debug views",debugBarWatchToggle:"Toggle the watch panel",uiBarToggle:"Toggle the UI bar",uiBarBackward:"Go backward within the {identity} history",uiBarForward:"Go forward within the {identity} history",uiBarJumpto:"Jump to a specific point within the {identity} history",jumptoTitle:"Jump To",jumptoTurn:"Turn",jumptoUnavailable:"No jump points currently available…",savesTitle:"Saves",savesDisallowed:"Saving has been disallowed on this passage.",savesIncapable:"{_warningIntroLacking} the capabilities required to support saves, so saves have been disabled for this session.",savesLabelAuto:"Autosave",savesLabelDelete:"Delete",savesLabelExport:"Save to Disk…",savesLabelImport:"Load from Disk…",savesLabelLoad:"Load",savesLabelClear:"Delete All",savesLabelSave:"Save",savesLabelSlot:"Slot",savesUnavailable:"No save slots found…",savesUnknownDate:"unknown",settingsTitle:"Settings",settingsOff:"Off",settingsOn:"On",settingsReset:"Reset to Defaults",restartTitle:"Restart",restartPrompt:"Are you sure that you want to restart? Unsaved progress will be lost.",shareTitle:"Share",autoloadTitle:"Autoload",autoloadCancel:"Go to start",autoloadOk:"Load autosave",autoloadPrompt:"An autosave exists. Load it now or go to the start?",macroBackText:"Back",macroReturnText:"Return"},Config=function(){function e(){throw new Error("Config.history.mode has been deprecated and is no longer used by SugarCube, please remove it from your code")}function t(){throw new Error("Config.history.tracking has been deprecated, use Config.history.maxStates instead")}var r=!1,n=!1,a=!1,i=0,o=!0,s=!0,u=!0,l=100,c=!0,d=1e3,f=void 0,p=void 0,h=!1,g=!1,m=void 0,v=void 0,y=void 0,b=void 0,w=void 0,k="untitled-story",S=void 0,E=void 0,j=void 0,x=8,O=void 0,T=800,C=!0;return Object.freeze({get debug(){return r},set debug(e){r=Boolean(e)},get addVisitedLinkClass(){return n},set addVisitedLinkClass(e){n=Boolean(e)},get cleanupWikifierOutput(){return a},set cleanupWikifierOutput(e){a=Boolean(e)},get loadDelay(){return i},set loadDelay(e){if(!Number.isSafeInteger(e)||e<0)throw new RangeError("Config.loadDelay must be a non-negative integer");i=e},audio:Object.freeze({get pauseOnFadeToZero(){return o},set pauseOnFadeToZero(e){o=Boolean(e)},get preloadMetadata(){return s},set preloadMetadata(e){s=Boolean(e)}}),history:Object.freeze({get controls(){return u},set controls(e){if((u=Boolean(e))&&1===l)throw u=!1,new Error("Config.history.controls must be false when Config.history.maxStates is 1")},get maxStates(){return l},set maxStates(e){if(!Number.isSafeInteger(e)||e<0)throw new RangeError("Config.history.maxStates must be a non-negative integer");l=e,u&&1===e&&(u=!1)},get mode(){e()},set mode(t){e()},get tracking(){t()},set tracking(e){t()}}),macros:Object.freeze({get ifAssignmentError(){return c},set ifAssignmentError(e){c=Boolean(e)},get maxLoopIterations(){return d},set maxLoopIterations(e){if(!Number.isSafeInteger(e)||e<0)throw new RangeError("Config.macros.maxLoopIterations must be a non-negative integer");d=e}}),navigation:Object.freeze({get override(){return f},set override(e){if(!(null==e||e instanceof Function))throw new TypeError("Config.navigation.override must be a function or null/undefined (received: "+Util.getType(e)+")");f=e}}),passages:Object.freeze({get descriptions(){return p},set descriptions(e){if(null!=e){var t=Util.getType(e);if("boolean"!==t&&"Object"!==t&&"function"!==t)throw new TypeError("Config.passages.descriptions must be a boolean, object, function, or null/undefined (received: "+t+")")}p=e},get displayTitles(){return h},set displayTitles(e){h=Boolean(e)},get nobr(){return g},set nobr(e){g=Boolean(e)},get onProcess(){return v},set onProcess(e){if(null!=e){var t=Util.getType(e);if("function"!==t)throw new TypeError("Config.passages.onProcess must be a function or null/undefined (received: "+t+")")}v=e},get start(){return m},set start(e){if(null!=e){var t=Util.getType(e);if("string"!==t)throw new TypeError("Config.passages.start must be a string or null/undefined (received: "+t+")")}m=e},get transitionOut(){return y},set transitionOut(e){if(null!=e){var t=Util.getType(e);if("string"!==t&&("number"!==t||!Number.isSafeInteger(e)||e<0))throw new TypeError("Config.passages.transitionOut must be a string, non-negative integer, or null/undefined (received: "+t+")")}y=e}}),saves:Object.freeze({get autoload(){return b},set autoload(e){if(null!=e){var t=Util.getType(e);if("boolean"!==t&&"string"!==t&&"function"!==t)throw new TypeError("Config.saves.autoload must be a boolean, string, function, or null/undefined (received: "+t+")")}b=e},get autosave(){return w},set autosave(e){if(null!=e){var t=Util.getType(e);if("string"===t)return void(w=[e]);if("boolean"!==t&&("Array"!==t||!e.every(function(e){return"string"==typeof e}))&&"function"!==t)throw new TypeError("Config.saves.autosave must be a boolean, Array of strings, function, or null/undefined (received: "+t+("Array"===t?" of mixed":"")+")")}w=e},get id(){return k},set id(e){if("string"!=typeof e||""===e)throw new TypeError("Config.saves.id must be a non-empty string (received: "+Util.getType(e)+")");k=e},get isAllowed(){return S},set isAllowed(e){if(!(null==e||e instanceof Function))throw new TypeError("Config.saves.isAllowed must be a function or null/undefined (received: "+Util.getType(e)+")");S=e},get onLoad(){return E},set onLoad(e){if(!(null==e||e instanceof Function))throw new TypeError("Config.saves.onLoad must be a function or null/undefined (received: "+Util.getType(e)+")");E=e},get onSave(){return j},set onSave(e){if(!(null==e||e instanceof Function))throw new TypeError("Config.saves.onSave must be a function or null/undefined (received: "+Util.getType(e)+")");j=e},get slots(){return x},set slots(e){if(!Number.isSafeInteger(e)||e<0)throw new RangeError("Config.saves.slots must be a non-negative integer");x=e},get version(){return O},set version(e){O=e}}),ui:Object.freeze({get stowBarInitially(){return T},set stowBarInitially(e){var t=Util.getType(e);if("boolean"!==t&&("number"!==t||!Number.isSafeInteger(e)||e<0))throw new TypeError("Config.passages.transitionOut must be a boolean or non-negative integer (received: "+t+")");T=e},get updateStoryElements(){return C},set updateStoryElements(e){C=Boolean(e)}})})}(),SimpleAudio=function(){function e(){if(arguments.length<2){var e=[];throw arguments.length<1&&e.push("track ID"),arguments.length<2&&e.push("sources"),new Error("no "+e.join(" or ")+" specified")}var t=String(arguments[0]).trim(),r='track ID "'+t+'"';if(_.test(t))throw new Error("invalid "+r+": track IDs must not contain colons or whitespace");var n=Array.isArray(arguments[1])?Array.from(arguments[1]):Array.from(arguments).slice(1),a=void 0;try{a=T(n)}catch(e){throw new Error(r+": error during track initialization: "+e.message)}if(Config.debug&&!a.hasSource())throw new Error(r+": no supported audio sources found");N.has(t)&&N.get(t)._destroy(),N.set(t,a)}function t(e){return N.has(e)&&N.get(e)._destroy(),N.delete(e)}function r(){N.forEach(function(e){return e._destroy()}),N.clear()}function n(e){return N.has(e)}function a(e){return N.get(e)||null}function i(){if(arguments.length<2){var e=[];throw arguments.length<1&&e.push("group ID"),arguments.length<2&&e.push("track IDs"),new Error("no "+e.join(" or ")+" specified")}var t=String(arguments[0]).trim(),r='group ID "'+t+'"';if(":"!==t[0]||_.test(t.slice(1)))throw new Error("invalid "+r+": group IDs must start with a colon and must not contain colons or whitespace");if(A.includes(t))throw new Error("cannot clobber special "+r);var n=Array.isArray(arguments[1])?Array.from(arguments[1]):Array.from(arguments).slice(1),a=void 0;try{a=new Set(n.map(function(e){if(!N.has(e))throw new Error('track "'+e+'" does not exist');return e}))}catch(e){throw new Error(r+": error during group initialization: "+e.message)}I.set(t,Object.freeze(Array.from(a)))}function o(e){return I.delete(e)}function s(){I.clear()}function u(e){return I.has(e)}function l(e){return I.get(e)||null}function c(){if(arguments.length<2){var e=[];throw arguments.length<1&&e.push("list ID"),
arguments.length<2&&e.push("track IDs"),new Error("no "+e.join(" or ")+" specified")}var t=String(arguments[0]).trim(),r='list ID "'+t+'"';if(_.test(t))return this.error("invalid "+r+": list IDs must not contain colons or whitespace");var n=Array.isArray(arguments[1])?Array.from(arguments[1]):Array.from(arguments).slice(1),a=void 0;try{a=new B(n.map(function(e){if(null===e)throw new Error("track descriptor must be a string or object (type: null)");switch(void 0===e?"undefined":_typeof(e)){case"string":e={id:e};break;case"object":if(!e.hasOwnProperty("id")&&!e.hasOwnProperty("sources"))throw new Error('track descriptor must contain one of either an "id" or a "sources" property');if(e.hasOwnProperty("id")&&e.hasOwnProperty("sources"))throw new Error('track descriptor must contain either an "id" or a "sources" property, not both');break;default:throw new Error("track descriptor must be a string or object (type: "+(void 0===e?"undefined":_typeof(e))+")")}var t=void 0,r=void 0,n=void 0;if(e.hasOwnProperty("id")){if("string"!=typeof e.id)throw new Error('"id" property must be a string');if(!N.has(e.id))throw new Error('track "'+e.id+'" does not exist');r=N.get(e.id)}else if(e.hasOwnProperty("sources")){if(!Array.isArray(e.sources)||0===e.sources.length)throw new Error('"sources" property must be a non-empty array');if(e.hasOwnProperty("own"))throw new Error('"own" property is not allowed with the "sources" property');try{r=T(e.sources),t=!0}catch(e){throw new Error("error during track initialization: "+e.message)}if(Config.debug&&!r.hasSource())throw new Error("no supported audio sources found")}if(e.hasOwnProperty("own")){if("boolean"!=typeof e.own)throw new Error('"own" property must be a boolean');t=e.own,t&&(r=r.clone())}if(e.hasOwnProperty("volume")){if("number"!=typeof e.volume||Number.isNaN(e.volume)||!Number.isFinite(e.volume)||e.volume<0)throw new Error('"volume" property must be a non-negative finite number');n=e.volume}return{own:null!=t&&t,track:r,volume:null!=n?n:r.volume()}}))}catch(e){throw new Error(r+": error during playlist initialization: "+e.message)}D.has(t)&&D.get(t)._destroy(),D.set(t,a)}function d(e){return D.has(e)&&D.get(e)._destroy(),D.delete(e)}function f(){D.forEach(function(e){return e._destroy()}),D.clear()}function p(e){return D.has(e)}function h(e){return D.get(e)||null}function g(){if(0===arguments.length)throw new Error("no track selector specified");var e=String(arguments[0]).trim(),t=new Set;try{var r=function e(t){var r=t.id,a=void 0;switch(r){case":all":a=n;break;case":looped":a=n.filter(function(e){return N.get(e).loop()});break;case":muted":a=n.filter(function(e){return N.get(e).mute()});break;case":paused":a=n.filter(function(e){return N.get(e).isPaused()});break;case":playing":a=n.filter(function(e){return N.get(e).isPlaying()});break;default:a=":"===r[0]?I.get(r):[r]}if(t.hasOwnProperty("not")){var i=t.not.map(function(t){return e(t)}).flat(1/0);a=a.filter(function(e){return!i.includes(e)})}return a},n=Array.from(N.keys());V(e).forEach(function(e){return r(e).forEach(function(e){if(!N.has(e))throw new Error('track "'+e+'" does not exist');t.add(e)})})}catch(e){throw new Error("error during runner initialization: "+e.message)}return new U(t)}function m(){O("load")}function v(){O("loadwithscreen")}function y(e){if(null==e)return R;R=!!e,O("mute",R)}function b(e){if(null==e)return W;if(W=!!e){var t=Visibility.changeEvent+".SimpleAudio_masterMuteOnHidden";jQuery(document).off(t).on(t,function(){return y(Visibility.isHidden())}),Visibility.isHidden()&&y(!0)}else jQuery(document).off(".SimpleAudio_masterMuteOnHidden")}function w(e){if(null==e)return M;if("number"!=typeof e||Number.isNaN(e)||!Number.isFinite(e))throw new Error("rate must be a finite number");M=Math.clamp(e,.2,5),O("rate",M)}function k(){O("stop")}function S(){O("unload")}function E(e){if(null==e)return Q;if("number"!=typeof e||Number.isNaN(e)||!Number.isFinite(e))throw new Error("volume must be a finite number");Q=Math.clamp(e,0,1),O("volume",Q)}function j(e,t){if("function"!=typeof t)throw new Error("callback parameter must be a function");L.set(e,t)}function x(e){L.delete(e)}function O(e,t){L.forEach(function(r){return r(e,t)})}function T(e){return new F(e.map(function(e){if("data:"!==e.slice(0,5)&&Story.has(e)){var t=Story.get(e);if(t.tags.includes("Twine.audio"))return t.text.trim()}var r=P.exec(e);return null===r?e:{format:r[1],src:r[2]}}))}var C=Object.freeze(["click","contextmenu","dblclick","keyup","mouseup","pointerup","touchend"]),A=Object.freeze([":not",":all",":looped",":muted",":paused",":playing"]),P=/^([\w-]+)\s*\|\s*(\S.*)$/,_=/[:\s]/,N=new Map,I=new Map,D=new Map,L=new Map,M=1,Q=1,R=!1,W=!1,F=function(){function e(t){if(_classCallCheck(this,e),t instanceof Array)this._create(t);else{if(!(t instanceof e))throw new Error("sources parameter must be either an array, of URIs or source objects, or an AudioTrack instance");this._copy(t)}}return _createClass(e,[{key:"_create",value:function(t){var r=/^data:\s*audio\/([^;,]+)\s*[;,]/i,n=/\.([^.\/\\]+)$/,a=e.getType,i=[],o=document.createElement("audio");o.preload="none",t.forEach(function(e){var t=null;switch(void 0===e?"undefined":_typeof(e)){case"string":var s=void 0;if("data:"===e.slice(0,5)){if(null===(s=r.exec(e)))throw new Error("source data URI missing media type")}else if(null===(s=n.exec(Util.parseUrl(e).pathname)))throw new Error("source URL missing file extension");var u=a(s[1]);null!==u&&(t={src:e,type:u});break;case"object":if(null===e)throw new Error("source object cannot be null");if(!e.hasOwnProperty("src"))throw new Error('source object missing required "src" property');if(!e.hasOwnProperty("format"))throw new Error('source object missing required "format" property');var l=a(e.format);null!==l&&(t={src:e.src,type:l});break;default:throw new Error("invalid source value (type: "+(void 0===e?"undefined":_typeof(e))+")")}if(null!==t){Browser.isOpera&&(t.type=t.type.replace(/;.*$/,""));var c=document.createElement("source");c.src=t.src,c.type=t.type,o.appendChild(c),i.push(t)}}),o.hasChildNodes()&&Config.audio.preloadMetadata&&(o.preload="metadata"),this._finalize(o,i,clone(t))}},{key:"_copy",value:function(e){this._finalize(e.audio.cloneNode(!0),clone(e.sources),clone(e.originals))}},{key:"_finalize",value:function(e,t,r){var n=this;Object.defineProperties(this,{audio:{configurable:!0,value:e},sources:{value:Object.freeze(t)},originals:{value:Object.freeze(r)},_error:{writable:!0,value:!1},_faderId:{writable:!0,value:null},_mute:{writable:!0,value:!1},_rate:{writable:!0,value:1},_volume:{writable:!0,value:1}}),jQuery(this.audio).on("loadstart.AudioTrack",function(){return n._error=!1}).on("error.AudioTrack",function(){return n._error=!0}).find("source:last-of-type").on("error.AudioTrack",function(){return n._trigger("error")}),j(this,function(e){if(!n.audio)return void x(n);switch(e){case"loadwithscreen":if(n.hasSource()){var t=LoadScreen.lock();n.one("canplaythrough.AudioTrack_loadwithscreen error.AudioTrack_loadwithscreen",function(){jQuery(this).off(".AudioTrack_loadwithscreen"),LoadScreen.unlock(t)}).load()}break;case"load":n.load();break;case"mute":n._updateAudioMute();break;case"rate":n._updateAudioRate();break;case"stop":n.stop();break;case"volume":n._updateAudioVolume();break;case"unload":n.unload()}}),this._updateAudioMute(),this._updateAudioRate(),this._updateAudioVolume()}},{key:"_trigger",value:function(e){jQuery(this.audio).triggerHandler(e)}},{key:"_destroy",value:function(){x(this),this.audio&&(jQuery(this.audio).off(),this.unload(),this._error=!0,delete this.audio)}},{key:"clone",value:function(){return new e(this)}},{key:"load",value:function(){var e=this;if(this.fadeStop(),this.audio.pause(),!this.audio.hasChildNodes()){if(0===this.sources.length)return;this.sources.forEach(function(t){var r=document.createElement("source");r.src=t.src,r.type=t.type,e.audio.appendChild(r)})}"auto"!==this.audio.preload&&(this.audio.preload="auto"),this.isLoading()||this.audio.load()}},{key:"unload",value:function(){this.fadeStop(),this.stop();var e=this.audio;for(e.preload="none";e.hasChildNodes();)e.removeChild(e.firstChild);e.load()}},{key:"play",value:function(){var e=this;return this.hasSource()?this.isUnloaded()?Promise.reject(new Error("no sources are loaded")):this.isFailed()?Promise.reject(new Error("failed to load any of the sources")):("auto"!==this.audio.preload&&(this.audio.preload="auto"),Has.audioPromise?this.audio.play():new Promise(function(t,r){jQuery(e.audio).off(".AudioTrack_play").one("error.AudioTrack_play playing.AudioTrack_play",function(n){jQuery(e).off(".AudioTrack_play"),"error"===n.type?r(new Error("unknown error")):t()}),e.audio.play()})):Promise.reject(new Error("none of the candidate sources were acceptable"))}},{key:"playWhenAllowed",value:function(){var e=this;this.play().catch(function(){var t=C.map(function(e){return e+".AudioTrack_playWhenAllowed"}).join(" ");jQuery(document).one(t,function(){jQuery(document).off(".AudioTrack_playWhenAllowed"),e.audio.play()})})}},{key:"pause",value:function(){this.audio.pause()}},{key:"stop",value:function(){this.audio.pause(),this.time(0),this._trigger(":stopped")}},{key:"fade",value:function(e,t,r){var n=this;if("number"!=typeof e)throw new TypeError("duration parameter must be a number");if("number"!=typeof t)throw new TypeError("toVolume parameter must be a number");if(null!=r&&"number"!=typeof r)throw new TypeError("fromVolume parameter must be a number");if(!this.hasSource())return Promise.reject(new Error("none of the candidate sources were acceptable"));if(this.isUnloaded())return Promise.reject(new Error("no sources are loaded"));if(this.isFailed())return Promise.reject(new Error("failed to load any of the sources"));this.fadeStop();var a=Math.clamp(null==r?this.volume():r,0,1),i=Math.clamp(t,0,1);return a!==i?(this.volume(a),jQuery(this.audio).off("timeupdate.AudioTrack_fade").one("timeupdate.AudioTrack_fade",function(){var t=void 0,r=void 0;a<i?(t=a,r=i):(t=i,r=a);var o=Math.max(e,1),s=(i-a)/(o/.025);n._trigger(":fading"),n._faderId=setInterval(function(){if(!n.isPlaying())return void n.fadeStop();n.volume(Math.clamp(n.volume()+s,t,r)),Config.audio.pauseOnFadeToZero&&0===n.volume()&&n.pause(),n.volume()===i&&(n.fadeStop(),n._trigger(":faded"))},25)}),this.play()):void 0}},{key:"fadeIn",value:function(e,t){return this.fade(e,1,t)}},{key:"fadeOut",value:function(e,t){return this.fade(e,0,t)}},{key:"fadeStop",value:function(){null!==this._faderId&&(clearInterval(this._faderId),this._faderId=null)}},{key:"loop",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){return null==e?this.audio.loop:(this.audio.loop=!!e,this)})},{key:"mute",value:function(e){return null==e?this._mute:(this._mute=!!e,this._updateAudioMute(),this)}},{key:"_updateAudioMute",value:function(){this.audio.muted=this._mute||R}},{key:"rate",value:function(e){if(null==e)return this._rate;if("number"!=typeof e)throw new TypeError("rate parameter must be a number");return this._rate=Math.clamp(e,.2,5),this._updateAudioRate(),this}},{key:"_updateAudioRate",value:function(){this.audio.playbackRate=Math.clamp(this._rate*M,.2,5)}},{key:"time",value:function(e){var t=this;if(null==e)return this.audio.currentTime;if("number"!=typeof e)throw new TypeError("time parameter must be a number");return this.hasMetadata()?this.audio.currentTime=e:jQuery(this.audio).off("loadedmetadata.AudioTrack_time").one("loadedmetadata.AudioTrack_time",function(){return t.audio.currentTime=e}),this}},{key:"volume",value:function(e){if(null==e)return this._volume;if("number"!=typeof e)throw new TypeError("volume parameter must be a number");return this._volume=Math.clamp(e,0,1),this._updateAudioVolume(),this}},{key:"_updateAudioVolume",value:function(){this.audio.volume=Math.clamp(this._volume*Q,0,1)}},{key:"duration",value:function(){return this.audio.duration}},{key:"remaining",value:function(){return this.audio.duration-this.audio.currentTime}},{key:"isFailed",value:function(){return this._error}},{key:"isLoading",value:function(){return this.audio.networkState===HTMLMediaElement.NETWORK_LOADING}},{key:"isUnloaded",value:function(){return!this.audio.hasChildNodes()}},{key:"isUnavailable",value:function(){return!this.hasSource()||this.isUnloaded()||this.isFailed()}},{key:"isPlaying",value:function(){return!this.audio.paused&&this.hasSomeData()}},{key:"isPaused",value:function(){return this.audio.paused&&(this.audio.duration===1/0||this.audio.currentTime>0)&&!this.audio.ended}},{key:"isStopped",value:function(){return this.audio.paused&&0===this.audio.currentTime}},{key:"isEnded",value:function(){return this.audio.ended}},{key:"isFading",value:function(){return null!==this._faderId}},{key:"isSeeking",value:function(){return this.audio.seeking}},{key:"hasSource",value:function(){return this.sources.length>0}},{key:"hasNoData",value:function(){return this.audio.readyState===HTMLMediaElement.HAVE_NOTHING}},{key:"hasMetadata",value:function(){return this.audio.readyState>=HTMLMediaElement.HAVE_METADATA}},{key:"hasSomeData",value:function(){return this.audio.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA}},{key:"hasData",value:function(){return this.audio.readyState===HTMLMediaElement.HAVE_ENOUGH_DATA}},{key:"on",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return jQuery.fn.on.apply(jQuery(this.audio),t),this}},{key:"one",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return jQuery.fn.one.apply(jQuery(this.audio),t),this}},{key:"off",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return jQuery.fn.off.apply(jQuery(this.audio),t),this}}],[{key:"_verifyType",value:function(t){if(!t||!Has.audio)return null;var r=e._types;if(!r.hasOwnProperty(t)){var n=document.createElement("audio");r[t]=""!==n.canPlayType(t).replace(/^no$/i,"")}return r[t]?t:null}},{key:"getType",value:function(t){if(!t||!Has.audio)return null;var r=e.formats,n=t.toLowerCase(),a=r.hasOwnProperty(n)?r[n]:"audio/"+n;return e._verifyType(a)}},{key:"canPlayFormat",value:function(t){return null!==e.getType(t)}},{key:"canPlayType",value:function(t){return null!==e._verifyType(t)}}]),e}();Object.defineProperties(F,{formats:{value:{aac:"audio/aac",caf:"audio/x-caf","x-caf":"audio/x-caf",mp3:'audio/mpeg; codecs="mp3"',mpeg:'audio/mpeg; codecs="mp3"',m4a:"audio/mp4",mp4:"audio/mp4","x-m4a":"audio/mp4","x-mp4":"audio/mp4",oga:"audio/ogg",ogg:"audio/ogg",opus:'audio/ogg; codecs="opus"',wav:"audio/wav",wave:"audio/wav",weba:"audio/webm",webm:"audio/webm"}},_types:{value:{}}});var B=function(){function e(t){if(_classCallCheck(this,e),t instanceof Array)this._create(t);else{if(!(t instanceof e))throw new Error("tracks parameter must be either an array, of track objects, or an AudioTrack instance");this._copy(t)}}return _createClass(e,[{key:"_create",value:function(e){var t=this;this._finalize(e.map(function(e){if("object"!==(void 0===e?"undefined":_typeof(e)))throw new Error("tracks parameter array members must be objects");var r=void 0,n=void 0,a=void 0,i=void 0;if(e instanceof F)r=!0,n=e.rate(),a=e.clone(),i=e.volume();else{if(!e.hasOwnProperty("track"))throw new Error('track object missing required "track" property');if(!(e.track instanceof F))throw new Error('track object\'s "track" property must be an AudioTrack object');r=e.hasOwnProperty("own")&&e.own,n=e.hasOwnProperty("rate")?e.rate:e.track.rate(),a=e.track,i=e.hasOwnProperty("volume")?e.volume:e.track.volume()}return a.stop(),a.loop(!1),a.mute(!1),a.rate(n),a.volume(i),a.on("ended.AudioList",function(){return t._onEnd()}),{own:r,track:a,volume:i,rate:n}}))}},{key:"_copy",value:function(e){this._finalize(clone(e.tracks))}},{key:"_finalize",value:function(e){Object.defineProperties(this,{tracks:{configurable:!0,value:Object.freeze(e)},queue:{configurable:!0,value:[]},current:{writable:!0,value:null},_rate:{writable:!0,value:1},_volume:{writable:!0,value:1},_mute:{writable:!0,value:!1},_loop:{writable:!0,value:!1},_shuffle:{writable:!0,value:!1}})}},{key:"_destroy",value:function(){this.stop(),this.tracks.filter(function(e){return e.own}).forEach(function(e){return e.track._destroy()}),delete this.tracks,delete this.queue}},{key:"load",value:function(){this.tracks.forEach(function(e){return e.track.load()})}},{key:"unload",value:function(){this.stop(),this.tracks.forEach(function(e){return e.track.unload()})}},{key:"play",value:function(){return null!==this.current&&!this.current.track.isUnavailable()&&!this.current.track.isEnded()||(0===this.queue.length&&this._fillQueue(),this._next())?this.current.track.play():Promise.reject(new Error("no tracks were available"))}},{key:"playWhenAllowed",value:function(){var e=this;this.play().catch(function(){var t=C.map(function(e){return e+".AudioList_playWhenAllowed"}).join(" ");jQuery(document).one(t,function(){jQuery(document).off(".AudioList_playWhenAllowed"),e.play()})})}},{key:"pause",value:function(){null!==this.current&&this.current.track.pause()}},{key:"stop",value:function(){null!==this.current&&(this.current.track.stop(),this.current=null),this._drainQueue()}},{key:"skip",value:function(){this._next()?this.current.track.play():this._loop&&this.play()}},{key:"fade",value:function(e,t,r){if("number"!=typeof e)throw new TypeError("duration parameter must be a number");if("number"!=typeof t)throw new TypeError("toVolume parameter must be a number");if(null!=r&&"number"!=typeof r)throw new TypeError("fromVolume parameter must be a number");if(0===this.queue.length&&this._fillQueue(),null!==this.current&&!this.current.track.isUnavailable()&&!this.current.track.isEnded()||this._next()){var n=Math.clamp(t,0,1)*this.current.volume,a=void 0;return null!=r&&(a=Math.clamp(r,0,1)*this.current.volume),this._volume=t,this.current.track.fade(e,n,a)}}},{key:"fadeIn",value:function(e,t){return this.fade(e,1,t)}},{key:"fadeOut",value:function(e,t){return this.fade(e,0,t)}},{key:"fadeStop",value:function(){null!==this.current&&this.current.track.fadeStop()}},{key:"loop",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){return null==e?this._loop:(this._loop=!!e,this)})},{key:"mute",value:function(e){return null==e?this._mute:(this._mute=!!e,null!==this.current&&this.current.track.mute(this._mute),this)}},{key:"rate",value:function(e){if(null==e)return this._rate;if("number"!=typeof e)throw new TypeError("rate parameter must be a number");return this._rate=Math.clamp(e,.2,5),null!==this.current&&this.current.track.rate(this._rate*this.current.rate),this}},{key:"shuffle",value:function(e){var t=this;if(null==e)return this._shuffle;if(this._shuffle=!!e,this.queue.length>0&&(this._fillQueue(),!this._shuffle&&null!==this.current&&this.queue.length>1)){var r=this.queue.findIndex(function(e){return e===t.current});if(-1!==r){var n;(n=this.queue).push.apply(n,_toConsumableArray(this.queue.splice(0,r+1)))}}return this}},{key:"volume",value:function(e){if(null==e)return this._volume;if("number"!=typeof e)throw new TypeError("volume parameter must be a number");return this._volume=Math.clamp(e,0,1),null!==this.current&&this.current.track.volume(this._volume*this.current.volume),this}},{key:"duration",value:function(){if(arguments.length>0)throw new Error("duration takes no parameters");return this.tracks.map(function(e){return e.track.duration()}).reduce(function(e,t){return e+t},0)}},{key:"remaining",value:function(){if(arguments.length>0)throw new Error("remaining takes no parameters");var e=this.queue.map(function(e){return e.track.duration()}).reduce(function(e,t){return e+t},0);return null!==this.current&&(e+=this.current.track.remaining()),e}},{key:"time",value:function(){if(arguments.length>0)throw new Error("time takes no parameters");return this.duration()-this.remaining()}},{key:"isPlaying",value:function(){return null!==this.current&&this.current.track.isPlaying()}},{key:"isPaused",value:function(){return null===this.current||this.current.track.isPaused()}},{key:"isStopped",value:function(){return 0===this.queue.length&&null===this.current}},{key:"isEnded",value:function(){return 0===this.queue.length&&(null===this.current||this.current.track.isEnded())}},{key:"isFading",value:function(){return null!==this.current&&this.current.track.isFading()}},{key:"_next",value:function(){null!==this.current&&(this.current.track.stop(),this.current=null);for(var e=void 0;e=this.queue.shift();)if(!e.track.isUnavailable()){this.current=e;break}return null!==this.current&&(this.current.track.mute(this._mute),this.current.track.rate(this._rate*this.current.rate),this.current.track.volume(this._volume*this.current.volume),this.current.track.loop(!1),!0)}},{key:"_onEnd",value:function(){if(0===this.queue.length){if(!this._loop)return;this._fillQueue()}this._next()&&this.current.track.play()}},{key:"_drainQueue",value:function(){this.queue.splice(0)}},{key:"_fillQueue",value:function(){var e;this._drainQueue(),(e=this.queue).push.apply(e,_toConsumableArray(this.tracks.filter(function(e){return!e.track.isUnavailable()}))),0!==this.queue.length&&this._shuffle&&(this.queue.shuffle(),this.queue.length>1&&this.queue[0]===this.current&&this.queue.push(this.queue.shift()))}}]),e}(),U=function(){function e(t){if(_classCallCheck(this,e),!(t instanceof Set||t instanceof e))throw new TypeError("list parameter must be a Set or a AudioRunner instance");Object.defineProperties(this,{trackIds:{value:new Set(t instanceof e?t.trackIds:t)}})}return _createClass(e,[{key:"load",value:function(){e._run(this.trackIds,F.prototype.load)}},{key:"unload",value:function(){e._run(this.trackIds,F.prototype.unload)}},{key:"play",value:function(){e._run(this.trackIds,F.prototype.play)}},{key:"playWhenAllowed",value:function(){e._run(this.trackIds,F.prototype.playWhenAllowed)}},{key:"pause",value:function(){e._run(this.trackIds,F.prototype.pause)}},{key:"stop",value:function(){e._run(this.trackIds,F.prototype.stop)}},{key:"fade",value:function(t,r,n){if(null==t||null==r)throw new Error("fade requires parameters");e._run(this.trackIds,F.prototype.fade,t,r,n)}},{key:"fadeIn",value:function(t,r){if(null==t)throw new Error("fadeIn requires a parameter");e._run(this.trackIds,F.prototype.fadeIn,t,1,r)}},{key:"fadeOut",value:function(t,r){if(null==t)throw new Error("fadeOut requires a parameter");e._run(this.trackIds,F.prototype.fadeOut,t,0,r)}},{key:"fadeStop",value:function(){e._run(this.trackIds,F.prototype.fadeStop)}},{key:"loop",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(t){if(null==t)throw new Error("loop requires a parameter");return e._run(this.trackIds,F.prototype.loop,t),this})},{key:"mute",value:function(t){if(null==t)throw new Error("mute requires a parameter");return e._run(this.trackIds,F.prototype.mute,t),this}},{key:"rate",value:function(t){if(null==t)throw new Error("rate requires a parameter");return e._run(this.trackIds,F.prototype.rate,t),this}},{key:"time",value:function(t){if(null==t)throw new Error("time requires a parameter");return e._run(this.trackIds,F.prototype.time,t),this}},{key:"volume",value:function(t){if(null==t)throw new Error("volume requires a parameter");return e._run(this.trackIds,F.prototype.volume,t),this}},{key:"on",value:function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return e._run.apply(e,[this.trackIds,F.prototype.on].concat(r)),this}},{key:"one",value:function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return e._run.apply(e,[this.trackIds,F.prototype.one].concat(r)),this}},{key:"off",value:function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return e._run.apply(e,[this.trackIds,F.prototype.off].concat(r)),this}}],[{key:"_run",value:function(e,t){for(var r=arguments.length,n=Array(r>2?r-2:0),a=2;a<r;a++)n[a-2]=arguments[a];e.forEach(function(e){var r=N.get(e);r&&t.apply(r,n)})}}]),e}(),V=function(){function e(e,t){var a=void 0;if(r.lastIndex=t,null===(a=r.exec(e))||"("!==a[0])throw new Error('invalid ":not()" syntax: missing parentheticals');n.lastIndex=r.lastIndex;for(var i=r.lastIndex,o={str:"",nextMatch:-1},s=1;null!==(a=n.exec(e));)if("("===a[0]?++s:--s,s<1){o.nextMatch=n.lastIndex,o.str=e.slice(i,o.nextMatch-1);break}return o}function t(r){for(var n=[],a=/:?[^\s:()]+/g,i=void 0;null!==(i=a.exec(r));){var o=i[0];if(":not"===o){if(0===n.length)throw new Error('invalid negation: no group ID preceded ":not()"');var s=n[n.length-1];if(":"!==s.id[0])throw new Error('invalid negation of track "'+s.id+'": only groups may be negated with ":not()"');var u=e(r,a.lastIndex);if(-1===u.nextMatch)throw new Error('unknown error parsing ":not()"');a.lastIndex=u.nextMatch,s.not=t(u.str)}else n.push({id:o})}return n}var r=/\S/g,n=/[()]/g;return t}();return Object.freeze(Object.defineProperties({},{tracks:{value:Object.freeze(Object.defineProperties({},{add:{value:e},delete:{value:t},clear:{value:r},has:{value:n},get:{value:a}}))},groups:{value:Object.freeze(Object.defineProperties({},{add:{value:i},delete:{value:o},clear:{value:s},has:{value:u},get:{value:l}}))},lists:{value:Object.freeze(Object.defineProperties({},{add:{value:c},delete:{value:d},clear:{value:f},has:{value:p},get:{value:h}}))},select:{value:g},load:{value:m},loadWithScreen:{value:v},mute:{value:y},muteOnHidden:{value:b},rate:{value:w},stop:{value:k},unload:{value:S},volume:{value:E}}))}(),State=function(){function e(){session.delete("state"),$=[],J=c(),G=-1,Z=[],Y=null===Y?null:new PRNGWrapper(Y.seed,!1)}function t(){if(session.has("state")){var e=session.get("state");return null!=e&&(n(e),!0)}return!1}function r(e){var t={index:G};return e?t.history=clone($):t.delta=A($),Z.length>0&&(t.expired=[].concat(_toConsumableArray(Z))),null!==Y&&(t.seed=Y.seed),t}function n(e,t){if(null==e)throw new Error("state object is null or undefined");if(!e.hasOwnProperty(t?"history":"delta")||0===e[t?"history":"delta"].length)throw new Error("state object has no history or history is empty");if(!e.hasOwnProperty("index"))throw new Error("state object has no index");if(null!==Y&&!e.hasOwnProperty("seed"))throw new Error("state object has no seed, but PRNG is enabled");if(null===Y&&e.hasOwnProperty("seed"))throw new Error("state object has seed, but PRNG is disabled");$=t?clone(e.history):P(e.delta),G=e.index,Z=e.hasOwnProperty("expired")?[].concat(_toConsumableArray(e.expired)):[],e.hasOwnProperty("seed")&&(Y.seed=e.seed),g(G)}function a(){return r(!0)}function i(e){return n(e,!0)}function o(){return Z}function s(){return Z.length+v()}function u(){return Z.concat($.slice(0,v()).map(function(e){return e.title}))}function l(e){return null!=e&&""!==e&&(!!Z.includes(e)||!!$.slice(0,v()).some(function(t){return t.title===e}))}function c(e,t){return{title:null==e?"":String(e),variables:null==t?{}:clone(t)}}function d(){return J}function f(){return G}function p(){return J.title}function h(){return J.variables}function g(e){if(null==e)throw new Error("moment activation attempted with null or undefined");switch(void 0===e?"undefined":_typeof(e)){case"object":J=clone(e);break;case"number":if(b())throw new Error("moment activation attempted with index on empty history");if(e<0||e>=y())throw new RangeError("moment activation attempted with out-of-bounds index; need [0, "+(y()-1)+"], got "+e);J=clone($[e]);break;default:throw new TypeError('moment activation attempted with a "'+(void 0===e?"undefined":_typeof(e))+'"; must be an object or valid history stack index')}return null!==Y&&(Y=PRNGWrapper.unmarshal({seed:Y.seed,pull:J.pull})),session.set("state",r()),jQuery.event.trigger(":historyupdate"),J}function m(){return $}function v(){return G+1}function y(){return $.length}function b(){return 0===$.length}function w(){return $.length>0?$[G]:null}function k(){return $.length>0?$[$.length-1]:null}function S(){return $.length>0?$[0]:null}function E(e){return b()||e<0||e>G?null:$[e]}function j(e){if(b())return null;var t=1+(e?Math.abs(e):0);return t>v()?null:$[v()-t]}function x(e){if(b()||null==e||""===e)return!1;for(var t=G;t>=0;--t)if($[t].title===e)return!0;return!1}function O(e){if(v()<y()&&$.splice(v(),y()-v()),$.push(c(e,J.variables)),Y&&(k().pull=Y.pull),Config.history.maxStates>0)for(;y()>Config.history.maxStates;)Z.push($.shift().title);return G=y()-1,g(G),v()}function T(e){return!(null==e||e<0||e>=y()||e===G)&&(G=e,g(G),!0)}function C(e){return null!=e&&0!==e&&T(G+e)}function A(e){if(!Array.isArray(e))return null;if(0===e.length)return[];for(var t=[clone(e[0])],r=1,n=e.length;r<n;++r)t.push(Diff.diff(e[r-1],e[r]));return t}function P(e){if(!Array.isArray(e))return null;if(0===e.length)return[];for(var t=[clone(e[0])],r=1,n=e.length;r<n;++r)t.push(Diff.patch(t[r-1],e[r]));return t}function _(e,t){if(!b()){var r=void 0;throw r="the Story JavaScript",new Error("State.initPRNG must be called during initialization, within either "+r+" or the StoryInit special passage")}Y=new PRNGWrapper(e,t),J.pull=Y.pull}function N(){return null!==Y}function I(){return Y?Y.pull:NaN}function D(){return Y?Y.seed:null}function L(){return Y?Y.random():Math.random()}function M(){K={},TempVariables=K}function Q(){return K}function R(e){var t=F(e);if(null!==t){for(var r=t.names,n=t.store,a=0,i=r.length;a<i;++a){if(void 0===n[r[a]])return;n=n[r[a]]}return n}}function W(e,t){var r=F(e);if(null===r)return!1;for(var n=r.names,a=n.pop(),i=r.store,o=0,s=n.length;o<s;++o){if(void 0===i[n[o]])return!1;i=i[n[o]]}return i[a]=t,!0}function F(e){for(var t={store:"$"===e[0]?State.variables:State.temporary,names:[]},r=e,n=void 0;null!==(n=X.exec(r));)r=r.slice(n[0].length),n[1]?t.names.push(n[1]):n[2]?t.names.push(n[2]):n[3]?t.names.push(n[3]):n[4]?t.names.push(n[4]):n[5]?t.names.push(R(n[5])):n[6]&&t.names.push(Number(n[6]));return""===r?t:null}function B(){storage.delete(ee)}function U(e){if("string"!=typeof e)throw new TypeError("State.metadata.delete key parameter must be a string (received: "+(void 0===e?"undefined":_typeof(e))+")");var t=storage.get(ee);t&&t.hasOwnProperty(e)&&(1===Object.keys(t).length?storage.delete(ee):(delete t[e],storage.set(ee,t)))}function V(e){if("string"!=typeof e)throw new TypeError("State.metadata.get key parameter must be a string (received: "+(void 0===e?"undefined":_typeof(e))+")");var t=storage.get(ee);return t&&t.hasOwnProperty(e)?t[e]:undefined}function z(e){if("string"!=typeof e)throw new TypeError("State.metadata.has key parameter must be a string (received: "+(void 0===e?"undefined":_typeof(e))+")");var t=storage.get(ee);return t&&t.hasOwnProperty(e)}function q(e,t){if("string"!=typeof e)throw new TypeError("State.metadata.set key parameter must be a string (received: "+(void 0===e?"undefined":_typeof(e))+")");if(void 0===t)U(e);else{var r=storage.get(ee)||{};r[e]=t,storage.set(ee,r)}}function H(){var e=storage.get(ee);return e?Object.keys(e).length:0}var $=[],J=c(),G=-1,Z=[],Y=null,K={},X=new RegExp("^(?:"+Patterns.variableSigil+"("+Patterns.identifier+")|\\.("+Patterns.identifier+")|\\[(?:(?:\"((?:\\\\.|[^\"\\\\])+)\")|(?:'((?:\\\\.|[^'\\\\])+)')|("+Patterns.variableSigil+Patterns.identifierFirstChar+".*)|(\\d+))\\])"),ee="metadata";return Object.freeze(Object.defineProperties({},{reset:{value:e},restore:{value:t},marshalForSave:{value:a},unmarshalForSave:{value:i},expired:{get:o},turns:{get:s},passages:{get:u},hasPlayed:{value:l},active:{get:d},activeIndex:{get:f},passage:{get:p},variables:{get:h},history:{get:m},length:{get:v},size:{get:y},isEmpty:{value:b},current:{get:w},top:{get:k},bottom:{get:S},index:{value:E},peek:{value:j},has:{value:x},create:{value:O},goTo:{value:T},go:{value:C},deltaEncode:{value:A},deltaDecode:{value:P},prng:{value:Object.freeze(Object.defineProperties({},{init:{value:_},isEnabled:{value:N},pull:{get:I},seed:{get:D}}))},random:{value:L},clearTemporary:{value:M},temporary:{get:Q},getVar:{
value:R},setVar:{value:W},metadata:{value:Object.freeze(Object.defineProperties({},{clear:{value:B},delete:{value:U},get:{value:V},has:{value:z},set:{value:q},size:{get:H}}))},initPRNG:{value:_},restart:{value:function(){return Engine.restart()}},backward:{value:function(){return Engine.backward()}},forward:{value:function(){return Engine.forward()}},display:{value:function(){return Engine.display.apply(Engine,arguments)}},show:{value:function(){return Engine.show.apply(Engine,arguments)}},play:{value:function(){return Engine.play.apply(Engine,arguments)}}}))}(),Scripting=function(){function addAccessibleClickHandler(e,t,r,n,a){if(arguments.length<2)throw new Error("addAccessibleClickHandler insufficient number of parameters");var i=void 0,o=void 0;if("function"==typeof t?(i=t,o={namespace:n,one:!!r}):(i=r,o={namespace:a,one:!!n,selector:t}),"function"!=typeof i)throw new TypeError("addAccessibleClickHandler handler parameter must be a function");return jQuery(e).ariaClick(o,i)}function insertElement(e,t,r,n,a,i){var o=jQuery(document.createElement(t));return r&&o.attr("id",r),n&&o.addClass(n),i&&o.attr("title",i),a&&o.text(a),e&&o.appendTo(e),o[0]}function insertText(e,t){jQuery(e).append(document.createTextNode(t))}function removeChildren(e){jQuery(e).empty()}function removeElement(e){jQuery(e).remove()}function fade(e,t){function r(){i+=.05*a,n(o,Math.easeInOut(i)),(1===a&&i>=1||-1===a&&i<=0)&&(e.style.visibility="in"===t.fade?"visible":"hidden",o.parentNode.replaceChild(e,o),o=null,window.clearInterval(s),t.onComplete&&t.onComplete())}function n(e,t){e.style.zoom=1,e.style.filter="alpha(opacity="+Math.floor(100*t)+")",e.style.opacity=t}var a="in"===t.fade?1:-1,i=void 0,o=e.cloneNode(!0),s=void 0;e.parentNode.replaceChild(o,e),"in"===t.fade?(i=0,o.style.visibility="visible"):i=1,n(o,i),s=window.setInterval(r,25)}function scrollWindowTo(e,t){function r(){l+=a,window.scroll(0,i+u*(s*Math.easeInOut(l))),l>=1&&window.clearInterval(c)}function n(e){for(var t=0;e.offsetParent;)t+=e.offsetTop,e=e.offsetParent;return t}var a=null!=t?Number(t):.1;Number.isNaN(a)||!Number.isFinite(a)||a<0?a=.1:a>1&&(a=1);var i=window.scrollY?window.scrollY:document.body.scrollTop,o=function(e){var t=n(e),r=t+e.offsetHeight,a=window.scrollY?window.scrollY:document.body.scrollTop,i=window.innerHeight?window.innerHeight:document.body.clientHeight,o=a+i;return t>=a&&r>o&&e.offsetHeight<i?t-(i-e.offsetHeight)+20:t}(e),s=Math.abs(i-o),u=i>o?-1:1,l=0,c=void 0;c=window.setInterval(r,25)}function either(){if(0!==arguments.length)return Array.prototype.concat.apply([],arguments).random()}function forget(e){if("string"!=typeof e)throw new TypeError("forget key parameter must be a string (received: "+Util.getType(e)+")");State.metadata.delete(e)}function hasVisited(){if(0===arguments.length)throw new Error("hasVisited called with insufficient parameters");if(State.isEmpty())return!1;for(var e=Array.prototype.concat.apply([],arguments),t=State.passages,r=0,n=e.length;r<n;++r)if(!t.includes(e[r]))return!1;return!0}function lastVisited(){if(0===arguments.length)throw new Error("lastVisited called with insufficient parameters");if(State.isEmpty())return-1;for(var e=Array.prototype.concat.apply([],arguments),t=State.passages,r=t.length-1,n=State.turns,a=0,i=e.length;a<i&&n>-1;++a){var o=t.lastIndexOf(e[a]);n=Math.min(n,-1===o?-1:r-o)}return n}function memorize(e,t){if("string"!=typeof e)throw new TypeError("memorize key parameter must be a string (received: "+Util.getType(e)+")");State.metadata.set(e,t)}function passage(){return State.passage}function previous(){var e=State.passages;if(arguments.length>0){var t=Number(arguments[0]);if(!Number.isSafeInteger(t)||t<1)throw new RangeError("previous offset parameter must be a positive integer greater than zero");return e.length>t?e[e.length-1-t]:""}for(var r=e.length-2;r>=0;--r)if(e[r]!==State.passage)return e[r];return""}function random(){var e=void 0,t=void 0;switch(arguments.length){case 0:throw new Error("random called with insufficient parameters");case 1:e=0,t=Math.trunc(arguments[0]);break;default:e=Math.trunc(arguments[0]),t=Math.trunc(arguments[1])}if(!Number.isInteger(e))throw new Error("random min parameter must be an integer");if(!Number.isInteger(t))throw new Error("random max parameter must be an integer");if(e>t){var r=[t,e];e=r[0],t=r[1]}return Math.floor(State.random()*(t-e+1))+e}function randomFloat(){var e=void 0,t=void 0;switch(arguments.length){case 0:throw new Error("randomFloat called with insufficient parameters");case 1:e=0,t=Number(arguments[0]);break;default:e=Number(arguments[0]),t=Number(arguments[1])}if(Number.isNaN(e)||!Number.isFinite(e))throw new Error("randomFloat min parameter must be a number");if(Number.isNaN(t)||!Number.isFinite(t))throw new Error("randomFloat max parameter must be a number");if(e>t){var r=[t,e];e=r[0],t=r[1]}return State.random()*(t-e)+e}function recall(e,t){if("string"!=typeof e)throw new TypeError("recall key parameter must be a string (received: "+Util.getType(e)+")");return State.metadata.has(e)?State.metadata.get(e):t}function tags(){if(0===arguments.length)return Story.get(State.passage).tags.slice(0);for(var e=Array.prototype.concat.apply([],arguments),t=[],r=0,n=e.length;r<n;++r)t=t.concat(Story.get(e[r]).tags);return t}function temporary(){return State.temporary}function time(){return null===Engine.lastPlay?0:Util.now()-Engine.lastPlay}function turns(){return State.turns}function variables(){return State.variables}function visited(){if(State.isEmpty())return 0;for(var e=Array.prototype.concat.apply([],0===arguments.length?[State.passage]:arguments),t=State.passages,r=State.turns,n=0,a=e.length;n<a&&r>0;++n)r=Math.min(r,t.count(e[n]));return r}function visitedTags(){if(0===arguments.length)throw new Error("visitedTags called with insufficient parameters");if(State.isEmpty())return 0;for(var e=Array.prototype.concat.apply([],arguments),t=e.length,r=State.passages,n=new Map,a=0,i=0,o=r.length;i<o;++i){var s=r[i];if(n.has(s))n.get(s)&&++a;else{var u=Story.get(s).tags;if(u.length>0){for(var l=0,c=0;c<t;++c)u.includes(e[c])&&++l;l===t?(++a,n.set(s,!0)):n.set(s,!1)}}}return a}function evalJavaScript(code,output){return function(code,output){return eval(code)}.call(output?{output:output}:null,String(code),output)}function evalTwineScript(code,output){return function(code,output){return eval(code)}.call(output?{output:output}:null,parse(String(code)),output)}var _ref8=function(){function e(e){return Util.parseUrl(e).path.replace(/^[^\w]+|[^\w]+$/g,"").replace(/[^\w]+/g,"-").toLocaleLowerCase()}function t(t){return new Promise(function(r,n){jQuery(document.createElement("script")).one("load abort error",function(e){jQuery(e.target).off(),"load"===e.type?r(e.target):n(new Error('importScripts failed to load the script "'+t+'".'))}).appendTo(document.head).attr({id:"script-imported-"+e(t),type:"text/javascript",src:t})})}function r(t){return new Promise(function(r,n){jQuery(document.createElement("link")).one("load abort error",function(e){jQuery(e.target).off(),"load"===e.type?r(e.target):n(new Error('importStyles failed to load the stylesheet "'+t+'".'))}).appendTo(document.head).attr({id:"style-imported-"+e(t),rel:"stylesheet",href:t})})}function n(e){return e.reduce(function(e,t){return e=e.then(t)},Promise.resolve())}function a(){for(var e=arguments.length,r=Array(e),a=0;a<e;a++)r[a]=arguments[a];return Promise.all(r.map(function(e){return Array.isArray(e)?n(e.map(function(e){return function(){return t(e)}})):t(e)}))}function i(){for(var e=arguments.length,t=Array(e),a=0;a<e;a++)t[a]=arguments[a];return Promise.all(t.map(function(e){return Array.isArray(e)?n(e.map(function(e){return function(){return r(e)}})):r(e)}))}return{importScripts:a,importStyles:i}}(),importScripts=_ref8.importScripts,importStyles=_ref8.importStyles,parse=function(){function e(e){if(0!==r.lastIndex)throw new RangeError("Scripting.parse last index is non-zero at start");for(var a=e,i=void 0;null!==(i=r.exec(a));)if(i[5]){var o=i[5];if("$"===o||"_"===o)continue;if(n.test(o))o=o[0];else if("is"===o){var s=r.lastIndex,u=a.slice(s);/^\s+not\b/.test(u)&&(a=a.splice(s,u.search(/\S/)),o="isnot")}t.hasOwnProperty(o)&&(a=a.splice(i.index,o.length,t[o]),r.lastIndex+=t[o].length-o.length)}return a}var t=Object.freeze({$:"State.variables.",_:"State.temporary.",to:"=",eq:"==",neq:"!=",is:"===",isnot:"!==",gt:">",gte:">=",lt:"<",lte:"<=",and:"&&",or:"||",not:"!",def:'"undefined" !== typeof',ndef:'"undefined" === typeof'}),r=new RegExp(["(\"\"|'')",'("(?:\\\\.|[^"\\\\])+")',"('(?:\\\\.|[^'\\\\])+')","([=+\\-*\\/%<>&\\|\\^~!?:,;\\(\\)\\[\\]{}]+)","([^\"'=+\\-*\\/%<>&\\|\\^~!?:,;\\(\\)\\[\\]{}\\s]+)"].join("|"),"g"),n=new RegExp("^"+Patterns.variable);return e}();return Object.freeze(Object.defineProperties({},{parse:{value:parse},evalJavaScript:{value:evalJavaScript},evalTwineScript:{value:evalTwineScript}}))}(),_ref9=function(){return{EOF:-1,Lexer:function(){function e(t,r){if(_classCallCheck(this,e),arguments.length<2)throw new Error("Lexer constructor called with too few parameters (source:string , initialState:function)");Object.defineProperties(this,{source:{value:t},initial:{value:r},state:{writable:!0,value:r},start:{writable:!0,value:0},pos:{writable:!0,value:0},depth:{writable:!0,value:0},items:{writable:!0,value:[]},data:{writable:!0,value:{}}})}return _createClass(e,[{key:"reset",value:function(){this.state=this.initial,this.start=0,this.pos=0,this.depth=0,this.items=[],this.data={}}},{key:"run",value:function(){for(;null!==this.state;)this.state=this.state(this);return this.items}},{key:"nextItem",value:function(){for(;0===this.items.length&&null!==this.state;)this.state=this.state(this);return this.items.shift()}},{key:"next",value:function(){return this.pos>=this.source.length?-1:this.source[this.pos++]}},{key:"peek",value:function(){return this.pos>=this.source.length?-1:this.source[this.pos]}},{key:"backup",value:function(e){this.pos-=e||1}},{key:"forward",value:function(e){this.pos+=e||1}},{key:"ignore",value:function(){this.start=this.pos}},{key:"accept",value:function(e){var t=this.next();return-1!==t&&(!!e.includes(t)||(this.backup(),!1))}},{key:"acceptRe",value:function(e){var t=this.next();return-1!==t&&(!!e.test(t)||(this.backup(),!1))}},{key:"acceptRun",value:function(e){for(;;){var t=this.next();if(-1===t)return;if(!e.includes(t))break}this.backup()}},{key:"acceptRunRe",value:function(e){for(;;){var t=this.next();if(-1===t)return;if(!e.test(t))break}this.backup()}},{key:"emit",value:function(e){this.items.push({type:e,text:this.source.slice(this.start,this.pos),start:this.start,pos:this.pos}),this.start=this.pos}},{key:"error",value:function(e,t){if(arguments.length<2)throw new Error("Lexer.prototype.error called with too few parameters (type:number , message:string)");return this.items.push({type:e,message:t,text:this.source.slice(this.start,this.pos),start:this.start,pos:this.pos}),null}}],[{key:"enumFromNames",value:function(e){var t=e.reduce(function(e,t,r){return e[t]=r,e},{});return Object.freeze(Object.assign(Object.create(null),t))}}]),e}()}}(),EOF=_ref9.EOF,Lexer=_ref9.Lexer,Wikifier=function(){var e=0,t=function(){function t(r,n,a){_classCallCheck(this,t),t.Parser.Profile.isEmpty()&&t.Parser.Profile.compile(),Object.defineProperties(this,{source:{value:String(n)},options:{writable:!0,value:Object.assign({profile:"all"},a)},nextMatch:{writable:!0,value:0},output:{writable:!0,value:null},_rawArgs:{writable:!0,value:""}}),null==r?this.output=document.createDocumentFragment():r.jquery?this.output=r[0]:this.output=r;try{++e,this.subWikify(this.output),1===e&&Config.cleanupWikifierOutput&&convertBreaks(this.output)}finally{--e}}return _createClass(t,[{key:"subWikify",value:function(e,r,n){var a=this.output,i=void 0;this.output=e,null!=n&&"object"===(void 0===n?"undefined":_typeof(n))&&(i=this.options,this.options=Object.assign({},this.options,n));var o=t.Parser.Profile.get(this.options.profile),s=r?new RegExp("(?:"+r+")",this.options.ignoreTerminatorCase?"gim":"gm"):null,u=void 0,l=void 0;do{if(o.parserRegExp.lastIndex=this.nextMatch,s&&(s.lastIndex=this.nextMatch),l=o.parserRegExp.exec(this.source),(u=s?s.exec(this.source):null)&&(!l||u.index<=l.index))return u.index>this.nextMatch&&this.outputText(this.output,this.nextMatch,u.index),this.matchStart=u.index,this.matchLength=u[0].length,this.matchText=u[0],this.nextMatch=s.lastIndex,this.output=a,void(i&&(this.options=i));if(l){l.index>this.nextMatch&&this.outputText(this.output,this.nextMatch,l.index),this.matchStart=l.index,this.matchLength=l[0].length,this.matchText=l[0],this.nextMatch=o.parserRegExp.lastIndex;for(var c=void 0,d=1,f=l.length;d<f;++d)if(l[d]){c=d-1;break}if(o.parsers[c].handler(this),null!=TempState.break)break}}while(u||l);null==TempState.break?this.nextMatch<this.source.length&&(this.outputText(this.output,this.nextMatch,this.source.length),this.nextMatch=this.source.length):this.output.lastChild&&this.output.lastChild.nodeType===Node.ELEMENT_NODE&&"BR"===this.output.lastChild.nodeName.toUpperCase()&&jQuery(this.output.lastChild).remove(),this.output=a,i&&(this.options=i)}},{key:"outputText",value:function(e,t,r){jQuery(e).append(document.createTextNode(this.source.substring(t,r)))}},{key:"rawArgs",value:function(){return this._rawArgs}},{key:"fullArgs",value:function(){return Scripting.parse(this._rawArgs)}}],[{key:"wikifyEval",value:function(e){var r=document.createDocumentFragment();new t(r,e);var n=r.querySelector(".error");if(null!==n)throw new Error(n.textContent.replace(errorPrologRegExp,""));return r}},{key:"createInternalLink",value:function(e,t,r,n){var a=jQuery(document.createElement("a"));return null!=t&&(a.attr("data-passage",t),Story.has(t)?(a.addClass("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(t)&&a.addClass("link-visited")):a.addClass("link-broken"),a.ariaClick({one:!0},function(){"function"==typeof n&&n(),Engine.play(t)})),r&&a.append(document.createTextNode(r)),e&&a.appendTo(e),a[0]}},{key:"createExternalLink",value:function(e,t,r){var n=jQuery(document.createElement("a")).attr("target","_blank").addClass("link-external").text(r).appendTo(e);return null!=t&&n.attr({href:t,tabindex:0}),n[0]}},{key:"isExternalLink",value:function(e){return!Story.has(e)&&(new RegExp("^"+Patterns.url,"gim").test(e)||/[\/.?#]/.test(e))}}]),t}();return Object.defineProperty(t,"Parser",{value:function(){function e(){return d}function t(e){if("object"!==(void 0===e?"undefined":_typeof(e)))throw new Error("Wikifier.Parser.add parser parameter must be an object");if(!e.hasOwnProperty("name"))throw new Error('parser object missing required "name" property');if("string"!=typeof e.name)throw new Error('parser object "name" property must be a string');if(!e.hasOwnProperty("match"))throw new Error('parser object missing required "match" property');if("string"!=typeof e.match)throw new Error('parser object "match" property must be a string');if(!e.hasOwnProperty("handler"))throw new Error('parser object missing required "handler" property');if("function"!=typeof e.handler)throw new Error('parser object "handler" property must be a function');if(e.hasOwnProperty("profiles")&&!Array.isArray(e.profiles))throw new Error('parser object "profiles" property must be an array');if(a(e.name))throw new Error('cannot clobber existing parser "'+e.name+'"');d.push(e)}function r(e){var t=d.find(function(t){return t.name===e});t&&d.delete(t)}function n(){return 0===d.length}function a(e){return!!d.find(function(t){return t.name===e})}function i(e){return d.find(function(t){return t.name===e})||null}function o(){return f}function s(){var e=d,t=e.filter(function(e){return!Array.isArray(e.profiles)||e.profiles.includes("core")});return f=Object.freeze({all:{parsers:e,parserRegExp:new RegExp(e.map(function(e){return"("+e.match+")"}).join("|"),"gm")},core:{parsers:t,parserRegExp:new RegExp(t.map(function(e){return"("+e.match+")"}).join("|"),"gm")}})}function u(){return"object"!==(void 0===f?"undefined":_typeof(f))||0===Object.keys(f).length}function l(e){if("object"!==(void 0===f?"undefined":_typeof(f))||!f.hasOwnProperty(e))throw new Error('nonexistent parser profile "'+e+'"');return f[e]}function c(e){return"object"===(void 0===f?"undefined":_typeof(f))&&f.hasOwnProperty(e)}var d=[],f=void 0;return Object.freeze(Object.defineProperties({},{parsers:{get:e},add:{value:t},delete:{value:r},isEmpty:{value:n},has:{value:a},get:{value:i},Profile:{value:Object.freeze(Object.defineProperties({},{profiles:{get:o},compile:{value:s},isEmpty:{value:u},has:{value:c},get:{value:l}}))}}))}()}),Object.defineProperties(t,{helpers:{value:{}},getValue:{value:State.getVar},setValue:{value:State.setVar},parse:{value:Scripting.parse},evalExpression:{value:Scripting.evalTwineScript},evalStatements:{value:Scripting.evalTwineScript},textPrimitives:{value:Patterns}}),Object.defineProperties(t.helpers,{inlineCss:{value:function(){function e(e){var r={classes:[],id:"",styles:{}},n=void 0;do{t.lastIndex=e.nextMatch;var a=t.exec(e.source);n=a&&a.index===e.nextMatch,n&&(a[1]?r.styles[Util.fromCssProperty(a[1])]=a[2].trim():a[3]?r.styles[Util.fromCssProperty(a[3])]=a[4].trim():a[5]?r.classes=r.classes.concat(a[5].slice(1).split(/\./)):a[6]&&(r.id=a[6].slice(1).split(/#/).pop()),e.nextMatch=t.lastIndex)}while(n);return r}var t=new RegExp(Patterns.inlineCss,"gm");return e}()},evalText:{value:function(e){var t=void 0;try{switch(t=Scripting.evalTwineScript(e),void 0===t?"undefined":_typeof(t)){case"string":""===t.trim()&&(t=e);break;case"number":t=String(t);break;default:t=e}}catch(r){t=e}return t}},evalPassageId:{value:function(e){return null==e||Story.has(e)?e:t.helpers.evalText(e)}},hasBlockContext:{value:function(e){for(var t="function"==typeof window.getComputedStyle,r=e.length-1;r>=0;--r){var n=e[r];switch(n.nodeType){case Node.ELEMENT_NODE:var a=n.nodeName.toUpperCase();if("BR"===a)return!0;var i=t?window.getComputedStyle(n,null):n.currentStyle;if(i&&i.display){if("none"===i.display)continue;return"block"===i.display}switch(a){case"ADDRESS":case"ARTICLE":case"ASIDE":case"BLOCKQUOTE":case"CENTER":case"DIV":case"DL":case"FIGURE":case"FOOTER":case"FORM":case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"HEADER":case"HR":case"MAIN":case"NAV":case"OL":case"P":case"PRE":case"SECTION":case"TABLE":case"UL":return!0}return!1;case Node.COMMENT_NODE:continue;default:return!1}}return!0}},createShadowSetterCallback:{value:function(){function e(){if(!a&&!(a=t.Parser.get("macro")))throw new Error('cannot find "macro" parser');return a}function r(){for(var t=a||e(),r=new Set,n=t.context;null!==n;n=n.parent)n._shadows&&n._shadows.forEach(function(e){return r.add(e)});return[].concat(_toConsumableArray(r))}function n(e){var t={};return r().forEach(function(e){var r=e.slice(1),n="$"===e[0]?State.variables:State.temporary;t[e]=n[r]}),function(){var r=Object.keys(t),n=r.length>0?{}:null;try{return r.forEach(function(e){var r=e.slice(1),a="$"===e[0]?State.variables:State.temporary;a.hasOwnProperty(r)&&(n[r]=a[r]),a[r]=t[e]}),Scripting.evalJavaScript(e)}finally{r.forEach(function(e){var r=e.slice(1),a="$"===e[0]?State.variables:State.temporary;t[e]=a[r],n.hasOwnProperty(r)?a[r]=n[r]:delete a[r]})}}}var a=null;return n}()},parseSquareBracketedMarkup:{value:function(){function e(e,t){e:for(;;)switch(e.next()){case"\\":var r=e.next();if(r!==EOF&&"\n"!==r)break;case EOF:case"\n":return EOF;case t:break e}return e.pos}function t(e){if(!e.accept("["))return e.error(o.Error,"malformed square-bracketed markup");if(e.accept("["))e.data.isLink=!0,e.emit(o.LinkMeta);else{if(e.accept("<>"),!(e.accept("Ii")&&e.accept("Mm")&&e.accept("Gg")&&e.accept("[")))return e.error(o.Error,"malformed square-bracketed markup");e.data.isLink=!1,e.emit(o.ImageMeta)}return e.depth=2,r}function r(t){for(var r=t.data.isLink?"link":"image",i=s.None;;)switch(t.next()){case EOF:case"\n":return t.error(o.Error,"unterminated "+r+" markup");case'"':if(e(t,'"')===EOF)return t.error(o.Error,"unterminated double quoted string in "+r+" markup");break;case"|":i===s.None&&(i=s.LTR,t.backup(),t.emit(o.Text),t.forward(),t.emit(o.DelimLTR));break;case"-":i===s.None&&">"===t.peek()&&(i=s.LTR,t.backup(),t.emit(o.Text),t.forward(2),t.emit(o.DelimLTR));break;case"<":i===s.None&&"-"===t.peek()&&(i=s.RTL,t.backup(),t.emit(t.data.isLink?o.Link:o.Source),t.forward(2),t.emit(o.DelimRTL));break;case"[":++t.depth;break;case"]":if(1===--t.depth)switch(t.peek()){case"[":return++t.depth,t.backup(),i===s.RTL?t.emit(o.Text):t.emit(t.data.isLink?o.Link:o.Source),t.forward(2),t.emit(o.InnerMeta),t.data.isLink?a:n;case"]":return--t.depth,t.backup(),i===s.RTL?t.emit(o.Text):t.emit(t.data.isLink?o.Link:o.Source),t.forward(2),t.emit(o.RightMeta),null;default:return t.error(o.Error,"malformed "+r+" markup")}}}function n(t){for(var r=t.data.isLink?"link":"image";;)switch(t.next()){case EOF:case"\n":return t.error(o.Error,"unterminated "+r+" markup");case'"':if(e(t,'"')===EOF)return t.error(o.Error,"unterminated double quoted string in "+r+" markup link component");break;case"[":++t.depth;break;case"]":if(1===--t.depth)switch(t.peek()){case"[":return++t.depth,t.backup(),t.emit(o.Link),t.forward(2),t.emit(o.InnerMeta),a;case"]":return--t.depth,t.backup(),t.emit(o.Link),t.forward(2),t.emit(o.RightMeta),null;default:return t.error(o.Error,"malformed "+r+" markup")}}}function a(t){for(var r=t.data.isLink?"link":"image";;)switch(t.next()){case EOF:case"\n":return t.error(o.Error,"unterminated "+r+" markup");case'"':if(e(t,'"')===EOF)return t.error(o.Error,"unterminated double quoted string in "+r+" markup setter component");break;case"'":if(e(t,"'")===EOF)return t.error(o.Error,"unterminated single quoted string in "+r+" markup setter component");break;case"[":++t.depth;break;case"]":if(1===--t.depth)return"]"!==t.peek()?t.error(o.Error,"malformed "+r+" markup"):(--t.depth,t.backup(),t.emit(o.Setter),t.forward(2),t.emit(o.RightMeta),null)}}function i(e){var r=new Lexer(e.source,t);r.start=r.pos=e.matchStart;var n={},a=r.run(),i=a.last();return i&&i.type===o.Error?n.error=i.message:a.forEach(function(e){var t=e.text.trim();switch(e.type){case o.ImageMeta:n.isImage=!0,"<"===t[1]?n.align="left":">"===t[1]&&(n.align="right");break;case o.LinkMeta:n.isLink=!0;break;case o.Link:"~"===t[0]?(n.forceInternal=!0,n.link=t.slice(1)):n.link=t;break;case o.Setter:n.setter=t;break;case o.Source:n.source=t;break;case o.Text:n.text=t}}),n.pos=r.pos,n}var o=Lexer.enumFromNames(["Error","DelimLTR","DelimRTL","InnerMeta","ImageMeta","LinkMeta","Link","RightMeta","Setter","Source","Text"]),s=Lexer.enumFromNames(["None","LTR","RTL"]);return i}()}}),t}();!function(){function e(e){this.lookahead.lastIndex=e.matchStart;var t=this.lookahead.exec(e.source);t&&t.index===e.matchStart&&(e.nextMatch=this.lookahead.lastIndex,jQuery(document.createDocumentFragment()).append(t[1]).appendTo(e.output))}Wikifier.Parser.add({name:"quoteByBlock",profiles:["block"],match:"^<<<\\n",terminator:"^<<<\\n",handler:function(e){if(!Wikifier.helpers.hasBlockContext(e.output.childNodes))return void jQuery(e.output).append(document.createTextNode(e.matchText));e.subWikify(jQuery(document.createElement("blockquote")).appendTo(e.output).get(0),this.terminator)}}),Wikifier.Parser.add({name:"quoteByLine",profiles:["block"],match:"^>+",lookahead:/^>+/gm,terminator:"\\n",handler:function(e){if(!Wikifier.helpers.hasBlockContext(e.output.childNodes))return void jQuery(e.output).append(document.createTextNode(e.matchText));var t=[e.output],r=0,n=e.matchLength,a=void 0,i=void 0;do{if(n>r)for(i=r;i<n;++i)t.push(jQuery(document.createElement("blockquote")).appendTo(t[t.length-1]).get(0));else if(n<r)for(i=r;i>n;--i)t.pop();r=n,e.subWikify(t[t.length-1],this.terminator),jQuery(document.createElement("br")).appendTo(t[t.length-1]),this.lookahead.lastIndex=e.nextMatch;var o=this.lookahead.exec(e.source);a=o&&o.index===e.nextMatch,a&&(n=o[0].length,e.nextMatch+=o[0].length)}while(a)}}),Wikifier.Parser.add({name:"macro",profiles:["core"],match:"<<",lookahead:new RegExp("<<(/?"+Patterns.macroName+")(?:\\s*)((?:(?:`(?:\\\\.|[^`\\\\])*`)|(?:\"(?:\\\\.|[^\"\\\\])*\")|(?:'(?:\\\\.|[^'\\\\])*')|(?:\\[(?:[<>]?[Ii][Mm][Gg])?\\[[^\\r\\n]*?\\]\\]+)|[^>]|(?:>(?!>)))*)>>","gm"),working:{source:"",name:"",arguments:"",index:0},context:null,handler:function(e){var t=this.lookahead.lastIndex=e.matchStart;if(this.parseTag(e)){var r=e.nextMatch,n=this.working.name,a=this.working.arguments,i=void 0;try{if(!(i=Macro.get(n))){if(Macro.tags.has(n)){var o=Macro.tags.get(n);return throwError(e.output,"child tag <<"+n+">> was found outside of a call to its parent macro"+(1===o.length?"":"s")+" <<"+o.join(">>, <<")+">>",e.source.slice(t,e.nextMatch))}return throwError(e.output,"macro <<"+n+">> does not exist",e.source.slice(t,e.nextMatch))}var s=null;if(i.hasOwnProperty("tags")&&!(s=this.parseBody(e,i)))return e.nextMatch=r,throwError(e.output,"cannot find a closing tag for macro <<"+n+">>",e.source.slice(t,e.nextMatch)+"…");if("function"!=typeof i.handler)return throwError(e.output,"macro <<"+n+">> handler function "+(i.hasOwnProperty("handler")?"is not a function":"does not exist"),e.source.slice(t,e.nextMatch));var u=s?s[0].args:this.createArgs(a,this.skipArgs(i,i.name));if(i.hasOwnProperty("_MACRO_API")){this.context=new MacroContext({macro:i,name:n,args:u,payload:s,source:e.source.slice(t,e.nextMatch),parent:this.context,parser:e});try{i.handler.call(this.context)}finally{this.context=this.context.parent}}else{var l=e._rawArgs;e._rawArgs=a;try{i.handler(e.output,n,u,e,s)}finally{e._rawArgs=l}}}catch(r){return throwError(e.output,"cannot execute "+(i&&i.isWidget?"widget":"macro")+" <<"+n+">>: "+r.message,e.source.slice(t,e.nextMatch))}finally{this.working.source="",this.working.name="",this.working.arguments="",this.working.index=0}}else e.outputText(e.output,e.matchStart,e.nextMatch)},parseTag:function(e){var t=this.lookahead.exec(e.source);return!(!t||t.index!==e.matchStart||!t[1])&&(e.nextMatch=this.lookahead.lastIndex,this.working.source=e.source.slice(t.index,this.lookahead.lastIndex),this.working.name=t[1],this.working.arguments=t[2],this.working.index=t.index,!0)},parseBody:function(e,t){for(var r=this.working.name,n="/"+r,a="end"+r,i=!!Array.isArray(t.tags)&&t.tags,o=[],s=-1,u=1,l=this.working.source,c=this.working.name,d=this.working.arguments,f=e.nextMatch;-1!==(e.matchStart=e.source.indexOf(this.match,e.nextMatch));)if(this.parseTag(e)){var p=this.working.source,h=this.working.name,g=this.working.arguments,m=this.working.index,v=e.nextMatch;switch(h){case r:++u;break;case a:case n:--u;break;default:if(1===u&&i)for(var y=0,b=i.length;y<b;++y)h===i[y]&&(o.push({source:l,name:c,arguments:d,args:this.createArgs(d,this.skipArgs(t,c)),contents:e.source.slice(f,m)}),l=p,c=h,d=g,f=v)}if(0===u){o.push({source:l,name:c,arguments:d,args:this.createArgs(d,this.skipArgs(t,c)),contents:e.source.slice(f,m)}),s=v;break}}else this.lookahead.lastIndex=e.nextMatch=e.matchStart+this.match.length;return-1!==s?(e.nextMatch=s,o):null},createArgs:function(e,t){var r=t?[]:this.parseArgs(e);return Object.defineProperties(r,{raw:{value:e},full:{value:Scripting.parse(e)}}),r},skipArgs:function(e,t){if(e.hasOwnProperty("skipArgs")){var r=e.skipArgs;return"boolean"==typeof r&&r||Array.isArray(r)&&r.includes(t)}return!!e.hasOwnProperty("skipArg0")&&(e.skipArg0&&e.name===t)},parseArgs:function(){function e(e,t){e:for(;;)switch(e.next()){case"\\":var r=e.next();if(r!==EOF&&"\n"!==r)break;case EOF:case"\n":return EOF;case t:break e}return e.pos}function t(e){var t=e.source.slice(e.pos).search(c);if(t===EOF)return null;switch(0!==t&&(e.pos+=t,e.ignore()),e.next()){case"`":return r;case'"':return n;case"'":return a;case"[":return i;default:return o}}function r(r){return e(r,"`")===EOF?r.error(u.Error,"unterminated backquote expression"):(r.emit(u.Expression),t)}function n(r){return e(r,'"')===EOF?r.error(u.Error,"unterminated double quoted string"):(r.emit(u.String),t)}function a(r){return e(r,"'")===EOF?r.error(u.Error,"unterminated single quoted string"):(r.emit(u.String),t)}function i(e){var r=void 0;if(e.accept("<>IiMmGg")?(r="image",e.acceptRun("<>IiMmGg")):r="link",!e.accept("["))return e.error(u.Error,"malformed "+r+" markup");e.depth=2;e:for(;;)switch(e.next()){case"\\":var n=e.next();if(n!==EOF&&"\n"!==n)break;case EOF:case"\n":return e.error(u.Error,"unterminated "+r+" markup");case"[":++e.depth;break;case"]":if(--e.depth<0)return e.error(u.Error,"unexpected right square bracket ']'");if(1===e.depth){if("]"===e.next()){--e.depth;break e}e.backup()}}return e.emit(u.SquareBracket),t}function o(e){var r=e.source.slice(e.pos).search(l);return e.pos=r===EOF?e.source.length:e.pos+r,e.emit(u.Bareword),r===EOF?null:t}function s(e){var r=new Lexer(e,t),n=[];return r.run().forEach(function(e){var t=e.text;switch(e.type){case u.Error:throw new Error('unable to parse macro argument "'+t+'": '+e.message);case u.Bareword:if(d.test(t))t=State.getVar(t);else if(/^(?:settings|setup)[.[]/.test(t))try{t=Scripting.evalTwineScript(t)}catch(e){throw new Error('unable to parse macro argument "'+t+'": '+e.message)}else if("null"===t)t=null;else if("undefined"===t)t=undefined;else if("true"===t)t=!0;else if("false"===t)t=!1;else if("NaN"===t)t=NaN;else{var r=Number(t);Number.isNaN(r)||(t=r)}break;case u.Expression:if(""===(t=t.slice(1,-1).trim()))t=undefined;else try{t=Scripting.evalTwineScript("("+t+")")}catch(e){throw new Error('unable to parse macro argument expression "'+t+'": '+e.message)}break;case u.String:try{t=Scripting.evalJavaScript(t)}catch(e){throw new Error('unable to parse macro argument string "'+t+'": '+e.message)}break;case u.SquareBracket:var a=Wikifier.helpers.parseSquareBracketedMarkup({source:t,matchStart:0});if(a.hasOwnProperty("error"))throw new Error('unable to parse macro argument "'+t+'": '+a.error);if(a.pos<t.length)throw new Error('unable to parse macro argument "'+t+'": unexpected character(s) "'+t.slice(a.pos)+'" (pos: '+a.pos+")");a.isLink?(t={isLink:!0},t.count=a.hasOwnProperty("text")?2:1,t.link=Wikifier.helpers.evalPassageId(a.link),t.text=a.hasOwnProperty("text")?Wikifier.helpers.evalText(a.text):t.link,t.external=!a.forceInternal&&Wikifier.isExternalLink(t.link),t.setFn=a.hasOwnProperty("setter")?Wikifier.helpers.createShadowSetterCallback(Scripting.parse(a.setter)):null):a.isImage&&(t=function(e){var t={source:e,isImage:!0};if("data:"!==e.slice(0,5)&&Story.has(e)){var r=Story.get(e);r.tags.includes("Twine.image")&&(t.source=r.text,t.passage=r.title)}return t}(Wikifier.helpers.evalPassageId(a.source)),a.hasOwnProperty("align")&&(t.align=a.align),a.hasOwnProperty("text")&&(t.title=Wikifier.helpers.evalText(a.text)),a.hasOwnProperty("link")&&(t.link=Wikifier.helpers.evalPassageId(a.link),t.external=!a.forceInternal&&Wikifier.isExternalLink(t.link)),t.setFn=a.hasOwnProperty("setter")?Wikifier.helpers.createShadowSetterCallback(Scripting.parse(a.setter)):null)}n.push(t)}),n}var u=Lexer.enumFromNames(["Error","Bareword","Expression","String","SquareBracket"]),l=new RegExp(Patterns.space),c=new RegExp(Patterns.notSpace),d=new RegExp("^"+Patterns.variable);return s}()}),Wikifier.Parser.add({name:"link",profiles:["core"],match:"\\[\\[[^[]",handler:function(e){var t=Wikifier.helpers.parseSquareBracketedMarkup(e);if(t.hasOwnProperty("error"))return void e.outputText(e.output,e.matchStart,e.nextMatch);e.nextMatch=t.pos;var r=Wikifier.helpers.evalPassageId(t.link),n=t.hasOwnProperty("text")?Wikifier.helpers.evalText(t.text):r,a=t.hasOwnProperty("setter")?Wikifier.helpers.createShadowSetterCallback(Scripting.parse(t.setter)):null,i=(Config.debug?new DebugView(e.output,"link-markup","[[link]]",e.source.slice(e.matchStart,e.nextMatch)):e).output;t.forceInternal||!Wikifier.isExternalLink(r)?Wikifier.createInternalLink(i,r,n,a):Wikifier.createExternalLink(i,r,n)}}),Wikifier.Parser.add({name:"urlLink",profiles:["core"],match:Patterns.url,handler:function(e){
e.outputText(Wikifier.createExternalLink(e.output,e.matchText),e.matchStart,e.nextMatch)}}),Wikifier.Parser.add({name:"image",profiles:["core"],match:"\\[[<>]?[Ii][Mm][Gg]\\[",handler:function(e){var t=Wikifier.helpers.parseSquareBracketedMarkup(e);if(t.hasOwnProperty("error"))return void e.outputText(e.output,e.matchStart,e.nextMatch);e.nextMatch=t.pos;var r=void 0;Config.debug&&(r=new DebugView(e.output,"image-markup",t.hasOwnProperty("link")?"[img[][link]]":"[img[]]",e.source.slice(e.matchStart,e.nextMatch)),r.modes({block:!0}));var n=t.hasOwnProperty("setter")?Wikifier.helpers.createShadowSetterCallback(Scripting.parse(t.setter)):null,a=(Config.debug?r:e).output,i=void 0;if(t.hasOwnProperty("link")){var o=Wikifier.helpers.evalPassageId(t.link);a=t.forceInternal||!Wikifier.isExternalLink(o)?Wikifier.createInternalLink(a,o,null,n):Wikifier.createExternalLink(a,o),a.classList.add("link-image")}if(a=jQuery(document.createElement("img")).appendTo(a).get(0),i=Wikifier.helpers.evalPassageId(t.source),"data:"!==i.slice(0,5)&&Story.has(i)){var s=Story.get(i);s.tags.includes("Twine.image")&&(a.setAttribute("data-passage",s.title),i=s.text.trim())}a.src=i,t.hasOwnProperty("text")&&(a.title=Wikifier.helpers.evalText(t.text)),t.hasOwnProperty("align")&&(a.align=t.align)}}),Wikifier.Parser.add({name:"monospacedByBlock",profiles:["block"],match:"^\\{\\{\\{\\n",lookahead:/^\{\{\{\n((?:^[^\n]*\n)+?)(^\}\}\}$\n?)/gm,handler:function(e){this.lookahead.lastIndex=e.matchStart;var t=this.lookahead.exec(e.source);if(t&&t.index===e.matchStart){var r=jQuery(document.createElement("pre"));jQuery(document.createElement("code")).text(t[1]).appendTo(r),r.appendTo(e.output),e.nextMatch=this.lookahead.lastIndex}}}),Wikifier.Parser.add({name:"formatByChar",profiles:["core"],match:"''|//|__|\\^\\^|~~|==|\\{\\{\\{",handler:function(e){switch(e.matchText){case"''":e.subWikify(jQuery(document.createElement("strong")).appendTo(e.output).get(0),"''");break;case"//":e.subWikify(jQuery(document.createElement("em")).appendTo(e.output).get(0),"//");break;case"__":e.subWikify(jQuery(document.createElement("u")).appendTo(e.output).get(0),"__");break;case"^^":e.subWikify(jQuery(document.createElement("sup")).appendTo(e.output).get(0),"\\^\\^");break;case"~~":e.subWikify(jQuery(document.createElement("sub")).appendTo(e.output).get(0),"~~");break;case"==":e.subWikify(jQuery(document.createElement("s")).appendTo(e.output).get(0),"==");break;case"{{{":var t=/\{\{\{((?:.|\n)*?)\}\}\}/gm;t.lastIndex=e.matchStart;var r=t.exec(e.source);r&&r.index===e.matchStart&&(jQuery(document.createElement("code")).text(r[1]).appendTo(e.output),e.nextMatch=t.lastIndex)}}}),Wikifier.Parser.add({name:"customStyle",profiles:["core"],match:"@@",terminator:"@@",blockRe:/\s*\n/gm,handler:function(e){var t=Wikifier.helpers.inlineCss(e);this.blockRe.lastIndex=e.nextMatch;var r=this.blockRe.exec(e.source),n=r&&r.index===e.nextMatch,a=jQuery(document.createElement(n?"div":"span")).appendTo(e.output);0===t.classes.length&&""===t.id&&0===Object.keys(t.styles).length?a.addClass("marked"):(t.classes.forEach(function(e){return a.addClass(e)}),""!==t.id&&a.attr("id",t.id),a.css(t.styles)),n?(e.nextMatch+=r[0].length,e.subWikify(a[0],"\\n?"+this.terminator)):e.subWikify(a[0],this.terminator)}}),Wikifier.Parser.add({name:"verbatimText",profiles:["core"],match:'"{3}|<[Nn][Oo][Ww][Ii][Kk][Ii]>',lookahead:/(?:"{3}((?:.|\n)*?)"{3})|(?:<[Nn][Oo][Ww][Ii][Kk][Ii]>((?:.|\n)*?)<\/[Nn][Oo][Ww][Ii][Kk][Ii]>)/gm,handler:function(e){this.lookahead.lastIndex=e.matchStart;var t=this.lookahead.exec(e.source);t&&t.index===e.matchStart&&(e.nextMatch=this.lookahead.lastIndex,jQuery(document.createElement("span")).addClass("verbatim").text(t[1]||t[2]).appendTo(e.output))}}),Wikifier.Parser.add({name:"horizontalRule",profiles:["core"],match:"^----+$\\n?|<[Hh][Rr]\\s*/?>\\n?",handler:function(e){jQuery(document.createElement("hr")).appendTo(e.output)}}),Wikifier.Parser.add({name:"emdash",profiles:["core"],match:"--",handler:function(e){jQuery(document.createTextNode("—")).appendTo(e.output)}}),Wikifier.Parser.add({name:"doubleDollarSign",profiles:["core"],match:"\\${2}",handler:function(e){jQuery(document.createTextNode("$")).appendTo(e.output)}}),Wikifier.Parser.add({name:"nakedVariable",profiles:["core"],match:Patterns.variable+"(?:(?:\\."+Patterns.identifier+")|(?:\\[\\d+\\])|(?:\\[\"(?:\\\\.|[^\"\\\\])+\"\\])|(?:\\['(?:\\\\.|[^'\\\\])+'\\])|(?:\\["+Patterns.variable+"\\]))*",handler:function(e){var t=toStringOrDefault(State.getVar(e.matchText),null);null===t?jQuery(document.createTextNode(e.matchText)).appendTo(e.output):new Wikifier((Config.debug?new DebugView(e.output,"variable",e.matchText,e.matchText):e).output,t)}}),Wikifier.Parser.add({name:"template",profiles:["core"],match:"\\?"+Patterns.templateName,handler:function(e){var t=e.matchText.slice(1),r=Template.get(t),n=null;switch(r instanceof Array&&(r=r.random()),void 0===r?"undefined":_typeof(r)){case"function":try{n=toStringOrDefault(r.call({name:t}),null)}catch(r){return throwError(e.output,"cannot execute function template ?"+t+": "+r.message,e.source.slice(e.matchStart,e.nextMatch))}break;case"string":n=r}null===n?jQuery(document.createTextNode(e.matchText)).appendTo(e.output):new Wikifier((Config.debug?new DebugView(e.output,"template",e.matchText,e.matchText):e).output,n)}}),Wikifier.Parser.add({name:"heading",profiles:["block"],match:"^!{1,6}",terminator:"\\n",handler:function(e){if(!Wikifier.helpers.hasBlockContext(e.output.childNodes))return void jQuery(e.output).append(document.createTextNode(e.matchText));e.subWikify(jQuery(document.createElement("h"+e.matchLength)).appendTo(e.output).get(0),this.terminator)}}),Wikifier.Parser.add({name:"table",profiles:["block"],match:"^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",lookahead:/^\|([^\n]*)\|([fhck]?)$/gm,rowTerminator:"\\|(?:[cfhk]?)$\\n?",cellPattern:"(?:\\|([^\\n\\|]*)\\|)|(\\|[cfhk]?$\\n?)",cellTerminator:"(?:\\u0020*)\\|",rowTypes:{c:"caption",f:"tfoot",h:"thead","":"tbody"},handler:function(e){if(!Wikifier.helpers.hasBlockContext(e.output.childNodes))return void jQuery(e.output).append(document.createTextNode(e.matchText));var t=jQuery(document.createElement("table")).appendTo(e.output).get(0),r=[],n=null,a=null,i=0,o=void 0;e.nextMatch=e.matchStart;do{this.lookahead.lastIndex=e.nextMatch;var s=this.lookahead.exec(e.source);if(o=s&&s.index===e.nextMatch){var u=s[2];"k"===u?(t.className=s[1],e.nextMatch+=s[0].length+1):(u!==n&&(n=u,a=jQuery(document.createElement(this.rowTypes[u])).appendTo(t)),"c"===n?(a.css("caption-side",0===i?"top":"bottom"),e.nextMatch+=1,e.subWikify(a[0],this.rowTerminator)):this.rowHandler(e,jQuery(document.createElement("tr")).appendTo(a).get(0),r),++i)}}while(o)},rowHandler:function(e,t,r){var n=this,a=new RegExp(this.cellPattern,"gm"),i=0,o=1,s=void 0;do{a.lastIndex=e.nextMatch;var u=a.exec(e.source);if(s=u&&u.index===e.nextMatch){if("~"===u[1]){var l=r[i];l&&(++l.rowCount,l.$element.attr("rowspan",l.rowCount).css("vertical-align","middle")),e.nextMatch=u.index+u[0].length-1}else if(">"===u[1])++o,e.nextMatch=u.index+u[0].length-1;else{if(u[2]){e.nextMatch=u.index+u[0].length;break}!function(){++e.nextMatch;for(var a=Wikifier.helpers.inlineCss(e),s=!1,u=!1,l=void 0;" "===e.source.substr(e.nextMatch,1);)s=!0,++e.nextMatch;"!"===e.source.substr(e.nextMatch,1)?(l=jQuery(document.createElement("th")).appendTo(t),++e.nextMatch):l=jQuery(document.createElement("td")).appendTo(t),r[i]={rowCount:1,$element:l},o>1&&(l.attr("colspan",o),o=1),e.subWikify(l[0],n.cellTerminator)," "===e.matchText.substr(e.matchText.length-2,1)&&(u=!0),a.classes.forEach(function(e){return l.addClass(e)}),""!==a.id&&l.attr("id",a.id),s&&u?a.styles["text-align"]="center":s?a.styles["text-align"]="right":u&&(a.styles["text-align"]="left"),l.css(a.styles),e.nextMatch=e.nextMatch-1}()}++i}}while(s)}}),Wikifier.Parser.add({name:"list",profiles:["block"],match:"^(?:(?:\\*+)|(?:#+))",lookahead:/^(?:(\*+)|(#+))/gm,terminator:"\\n",handler:function(e){if(!Wikifier.helpers.hasBlockContext(e.output.childNodes))return void jQuery(e.output).append(document.createTextNode(e.matchText));e.nextMatch=e.matchStart;var t=[e.output],r=null,n=0,a=void 0,i=void 0;do{this.lookahead.lastIndex=e.nextMatch;var o=this.lookahead.exec(e.source);if(a=o&&o.index===e.nextMatch){var s=o[2]?"ol":"ul",u=o[0].length;if(e.nextMatch+=o[0].length,u>n)for(i=n;i<u;++i)t.push(jQuery(document.createElement(s)).appendTo(t[t.length-1]).get(0));else if(u<n)for(i=n;i>u;--i)t.pop();else u===n&&s!==r&&(t.pop(),t.push(jQuery(document.createElement(s)).appendTo(t[t.length-1]).get(0)));n=u,r=s,e.subWikify(jQuery(document.createElement("li")).appendTo(t[t.length-1]).get(0),this.terminator)}}while(a)}}),Wikifier.Parser.add({name:"commentByBlock",profiles:["core"],match:"(?:/(?:%|\\*))|(?:\x3c!--)",lookahead:/(?:\/(%|\*)(?:(?:.|\n)*?)\1\/)|(?:<!--(?:(?:.|\n)*?)-->)/gm,handler:function(e){this.lookahead.lastIndex=e.matchStart;var t=this.lookahead.exec(e.source);t&&t.index===e.matchStart&&(e.nextMatch=this.lookahead.lastIndex)}}),Wikifier.Parser.add({name:"lineContinuation",profiles:["core"],match:"\\\\"+Patterns.spaceNoTerminator+"*\\n|\\n"+Patterns.spaceNoTerminator+"*\\\\|\\n?\\\\"+Patterns.spaceNoTerminator+"*$|^"+Patterns.spaceNoTerminator+"*\\\\\\n?",handler:function(e){e.nextMatch=e.matchStart+e.matchLength}}),Wikifier.Parser.add({name:"lineBreak",profiles:["core"],match:"\\n|<[Bb][Rr]\\s*/?>",handler:function(e){e.options.nobr||jQuery(document.createElement("br")).appendTo(e.output)}}),Wikifier.Parser.add({name:"htmlCharacterReference",profiles:["core"],match:"(?:(?:&#?[0-9A-Za-z]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9A-Fa-f]|1D[C-Fc-f][0-9A-Fa-f]|20[D-Fd-f][0-9A-Fa-f]|FE2[0-9A-Fa-f])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[0-9A-Za-z]{2,8};)",handler:function(e){jQuery(document.createDocumentFragment()).append(e.matchText).appendTo(e.output)}}),Wikifier.Parser.add({name:"xmlProlog",profiles:["core"],match:"<\\?[Xx][Mm][Ll][^>]*\\?>",handler:function(e){e.nextMatch=e.matchStart+e.matchLength}}),Wikifier.Parser.add({name:"verbatimHtml",profiles:["core"],match:"<[Hh][Tt][Mm][Ll]>",lookahead:/<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/gm,handler:e}),Wikifier.Parser.add({name:"verbatimSvgTag",profiles:["core"],match:"<[Ss][Vv][Gg][^>]*>",lookahead:/(<[Ss][Vv][Gg][^>]*>(?:.|\n)*?<\/[Ss][Vv][Gg]>)/gm,handler:e}),Wikifier.Parser.add({name:"verbatimScriptTag",profiles:["core"],match:"<[Ss][Cc][Rr][Ii][Pp][Tt][^>]*>",lookahead:/(<[Ss][Cc][Rr][Ii][Pp][Tt]*>(?:.|\n)*?<\/[Ss][Cc][Rr][Ii][Pp][Tt]>)/gm,handler:e}),Wikifier.Parser.add({name:"styleTag",profiles:["core"],match:"<[Ss][Tt][Yy][Ll][Ee][^>]*>",lookahead:/(<[Ss][Tt][Yy][Ll][Ee]*>)((?:.|\n)*?)(<\/[Ss][Tt][Yy][Ll][Ee]>)/gm,imageMarkup:new RegExp(Patterns.cssImage,"g"),hasImageMarkup:new RegExp(Patterns.cssImage),handler:function(e){this.lookahead.lastIndex=e.matchStart;var t=this.lookahead.exec(e.source);if(t&&t.index===e.matchStart){e.nextMatch=this.lookahead.lastIndex;var r=t[2];this.hasImageMarkup.test(r)&&(this.imageMarkup.lastIndex=0,r=r.replace(this.imageMarkup,function(e){var t=Wikifier.helpers.parseSquareBracketedMarkup({source:e,matchStart:0});if(t.hasOwnProperty("error")||t.pos<e.length)return e;var r=t.source;if("data:"!==r.slice(0,5)&&Story.has(r)){var n=Story.get(r);n.tags.includes("Twine.image")&&(r=n.text)}return'url("'+r.replace(/"/g,"%22")+'")'})),jQuery(document.createDocumentFragment()).append(t[1]+r+t[3]).appendTo(e.output)}}}),Wikifier.Parser.add({name:"htmlTag",profiles:["core"],match:"<\\w+(?:\\s+[^\\u0000-\\u001F\\u007F-\\u009F\\s\"'>\\/=]+(?:\\s*=\\s*(?:\"[^\"]*?\"|'[^']*?'|[^\\s\"'=<>`]+))?)*\\s*\\/?>",tagRe:/^<(\w+)/,mediaElements:["audio","img","source","track","video"],nobrElements:["audio","colgroup","datalist","dl","figure","ol","optgroup","picture","select","table","tbody","tfoot","thead","tr","ul","video"],voidElements:["area","base","br","col","embed","hr","img","input","keygen","link","menuitem","meta","param","source","track","wbr"],handler:function(e){var t=this.tagRe.exec(e.matchText),r=t&&t[1],n=r&&r.toLowerCase();if(n){var a=this.voidElements.includes(n)||e.matchText.endsWith("/>"),i=this.nobrElements.includes(n),o=void 0,s=void 0;if(!a){o="<\\/"+n+"\\s*>";var u=new RegExp(o,"gim");u.lastIndex=e.matchStart,s=u.exec(e.source)}if(!a&&!s)return throwError(e.output,"cannot find a closing tag for HTML <"+r+">",e.matchText+"…");var l=e.output,c=document.createElement(e.output.tagName),d=void 0;for(c.innerHTML=e.matchText;c.firstChild;)c=c.firstChild;try{this.processAttributeDirectives(c)}catch(t){return throwError(e.output,"<"+n+">: "+t.message,e.matchText+"…")}c.hasAttribute("data-passage")&&(this.processDataAttributes(c,n),Config.debug&&(d=new DebugView(e.output,"html-"+n,n,e.matchText),d.modes({block:"img"===n,nonvoid:s}),l=d.output)),s&&(e.subWikify(c,o,{ignoreTerminatorCase:!0,nobr:i}),d&&jQuery(c).find(".debug.block").length>0&&d.modes({block:!0})),l.appendChild("track"===n?c.cloneNode(!0):c)}},processAttributeDirectives:function(e){[].concat(_toConsumableArray(e.attributes)).forEach(function(t){var r=t.name,n=t.value,a="@"===r[0];if(a||r.startsWith("sc-eval:")){var i=r.slice(a?1:8),o=void 0;try{o=Scripting.evalTwineScript(n)}catch(e){throw new Error('bad evaluation from attribute directive "'+r+'": '+e.message)}try{e.setAttribute(i,o),e.removeAttribute(r)}catch(e){throw new Error('cannot transform attribute directive "'+r+'" into attribute "'+i+'"')}}})},processDataAttributes:function(e,t){var r=e.getAttribute("data-passage");if(null!=r){var n=Wikifier.helpers.evalPassageId(r);if(n!==r&&(r=n,e.setAttribute("data-passage",n)),""!==r)if(this.mediaElements.includes(t)){if("data:"!==r.slice(0,5)&&Story.has(r)){r=Story.get(r);var a=void 0,i=void 0;switch(t){case"audio":case"video":i="Twine."+t;break;case"img":i="Twine.image";break;case"track":i="Twine.vtt";break;case"source":var o=$(e).closest("audio,picture,video");o.length&&(a=o.get(0).tagName.toLowerCase(),i="Twine."+("picture"===a?"image":a))}r.tags.includes(i)&&(e["picture"===a?"srcset":"src"]=r.text.trim())}}else{var s=e.getAttribute("data-setter"),u=void 0;null!=s&&""!==(s=String(s).trim())&&(u=Wikifier.helpers.createShadowSetterCallback(Scripting.parse(s))),Story.has(r)?(e.classList.add("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(r)&&e.classList.add("link-visited")):e.classList.add("link-broken"),jQuery(e).ariaClick({one:!0},function(){"function"==typeof u&&u.call(this),Engine.play(r)})}}}})}();var Template=function(){function e(e,t){if(!(s(t)||t instanceof Array&&t.length>0&&t.every(s)))throw new Error("invalid template type ("+e+"); templates must be: functions, strings, or an array of either");(e instanceof Array?e:[e]).forEach(function(e){if(i.has(e))throw new Error("cannot clobber existing template ?"+e);if(!o.test(e))throw new Error('invalid template name "'+e+'"');i.set(e,t)})}function t(e){(e instanceof Array?e:[e]).forEach(function(e){return i.delete(e)})}function r(e){return i.has(e)?i.get(e):null}function n(e){return i.has(e)}function a(){return i.size}var i=new Map,o=new RegExp("^(?:"+Patterns.templateName+")$"),s=function(e){var t=void 0===e?"undefined":_typeof(e);return"function"===t||"string"===t};return Object.freeze(Object.defineProperties({},{add:{value:e},delete:{value:t},get:{value:r},has:{value:n},size:{get:a}}))}(),Macro=function(){function e(t,r,a){if(Array.isArray(t))return void t.forEach(function(t){return e(t,r,a)});if(!f.test(t))throw new Error('invalid macro name "'+t+'"');if(n(t))throw new Error("cannot clobber existing macro <<"+t+">>");if(u(t))throw new Error("cannot clobber child tag <<"+t+">> of parent macro"+(1===d[t].length?"":"s")+" <<"+d[t].join(">>, <<")+">>");try{if("object"===(void 0===r?"undefined":_typeof(r)))c[t]=a?clone(r):r;else{if(!n(r))throw new Error("cannot create alias of nonexistent macro <<"+r+">>");c[t]=a?clone(c[r]):c[r]}Object.defineProperty(c,t,{writable:!1}),c[t]._MACRO_API=!0}catch(e){throw"TypeError"===e.name?new Error("cannot clobber protected macro <<"+t+">>"):new Error("unknown error when attempting to add macro <<"+t+">>: ["+e.name+"] "+e.message)}if(c[t].hasOwnProperty("tags"))if(null==c[t].tags)o(t);else{if(!Array.isArray(c[t].tags))throw new Error('bad value for "tags" property of macro <<'+t+">>");o(t,c[t].tags)}}function t(e){if(Array.isArray(e))return void e.forEach(function(e){return t(e)});if(n(e)){c[e].hasOwnProperty("tags")&&s(e);try{Object.defineProperty(c,e,{writable:!0}),delete c[e]}catch(t){throw new Error("unknown error removing macro <<"+e+">>: "+t.message)}}else if(u(e))throw new Error("cannot remove child tag <<"+e+">> of parent macro <<"+d[e]+">>")}function r(){return 0===Object.keys(c).length}function n(e){return c.hasOwnProperty(e)}function a(e){var t=null;return n(e)&&"function"==typeof c[e].handler?t=c[e]:macros.hasOwnProperty(e)&&"function"==typeof macros[e].handler&&(t=macros[e]),t}function i(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"init";Object.keys(c).forEach(function(t){"function"==typeof c[t][e]&&c[t][e](t)}),Object.keys(macros).forEach(function(t){"function"==typeof macros[t][e]&&macros[t][e](t)})}function o(e,t){if(!e)throw new Error("no parent specified");for(var r=["/"+e,"end"+e],a=[].concat(r,Array.isArray(t)?t:[]),i=0;i<a.length;++i){var o=a[i];if(n(o))throw new Error("cannot register tag for an existing macro");u(o)?d[o].includes(e)||(d[o].push(e),d[o].sort()):d[o]=[e]}}function s(e){if(!e)throw new Error("no parent specified");Object.keys(d).forEach(function(t){var r=d[t].indexOf(e);-1!==r&&(1===d[t].length?delete d[t]:d[t].splice(r,1))})}function u(e){return d.hasOwnProperty(e)}function l(e){return u(e)?d[e]:null}var c={},d={},f=new RegExp("^(?:"+Patterns.macroName+")$");return Object.freeze(Object.defineProperties({},{add:{value:e},delete:{value:t},isEmpty:{value:r},has:{value:n},get:{value:a},init:{value:i},tags:{value:Object.freeze(Object.defineProperties({},{register:{value:o},unregister:{value:s},has:{value:u},get:{value:l}}))},evalStatements:{value:function(){return Scripting.evalJavaScript.apply(Scripting,arguments)}}}))}(),MacroContext=function(){return function(){function e(t){_classCallCheck(this,e);var r=Object.assign({parent:null,macro:null,name:"",args:null,payload:null,parser:null,source:""},t);if(null===r.macro||""===r.name||null===r.parser)throw new TypeError("context object missing required properties");Object.defineProperties(this,{self:{value:r.macro},name:{value:r.name},args:{value:r.args},payload:{value:r.payload},source:{value:r.source},parent:{value:r.parent},parser:{value:r.parser},_output:{value:r.parser.output},_shadows:{writable:!0,value:null},_debugView:{writable:!0,value:null},_debugViewEnabled:{writable:!0,value:Config.debug}})}return _createClass(e,[{key:"contextHas",value:function(e){for(var t=this;null!==(t=t.parent);)if(e(t))return!0;return!1}},{key:"contextSelect",value:function(e){for(var t=this;null!==(t=t.parent);)if(e(t))return t;return null}},{key:"contextSelectAll",value:function(e){for(var t=[],r=this;null!==(r=r.parent);)e(r)&&t.push(r);return t}},{key:"addShadow",value:function(){var e=this;this._shadows||(this._shadows=new Set);for(var t=new RegExp("^"+Patterns.variable+"$"),r=arguments.length,n=Array(r),a=0;a<r;a++)n[a]=arguments[a];n.flat(1/0).forEach(function(r){if("string"!=typeof r)throw new TypeError("variable name must be a string; type: "+(void 0===r?"undefined":_typeof(r)));if(!t.test(r))throw new Error('invalid variable name "'+r+'"');e._shadows.add(r)})}},{key:"createShadowWrapper",value:function(e,t,r){var n=this,a=void 0;return"function"==typeof e&&(a={},this.shadowView.forEach(function(e){var t=e.slice(1),r="$"===e[0]?State.variables:State.temporary;a[e]=r[t]})),function(){for(var i=arguments.length,o=Array(i),s=0;s<i;s++)o[s]=arguments[s];if("function"==typeof r&&r.apply(this,o),"function"==typeof e){var u=Object.keys(a),l=u.length>0?{}:null,c=Wikifier.Parser.get("macro"),d=void 0;try{u.forEach(function(e){var t=e.slice(1),r="$"===e[0]?State.variables:State.temporary;r.hasOwnProperty(t)&&(l[t]=r[t]),r[t]=a[e]}),d=c.context,c.context=n,e.apply(this,o)}finally{d!==undefined&&(c.context=d),u.forEach(function(e){var t=e.slice(1),r="$"===e[0]?State.variables:State.temporary;a[e]=r[t],l.hasOwnProperty(t)?r[t]=l[t]:delete r[t]})}}"function"==typeof t&&t.apply(this,o)}}},{key:"createDebugView",value:function(e,t){return this._debugView=new DebugView(this._output,"macro",e||this.name,t||this.source),null!==this.payload&&this.payload.length>0&&this._debugView.modes({nonvoid:!0}),this._debugViewEnabled=!0,this._debugView}},{key:"removeDebugView",value:function(){null!==this._debugView&&(this._debugView.remove(),this._debugView=null),this._debugViewEnabled=!1}},{key:"error",value:function(e,t){return throwError(this._output,"<<"+this.name+">>: "+e,t||this.source)}},{key:"output",get:function(){return this._debugViewEnabled?this.debugView.output:this._output}},{key:"shadows",get:function(){return[].concat(_toConsumableArray(this._shadows))}},{key:"shadowView",get:function(){var e=new Set;return this.contextSelectAll(function(e){return e._shadows}).forEach(function(t){return t._shadows.forEach(function(t){return e.add(t)})}),[].concat(_toConsumableArray(e))}},{key:"debugView",get:function(){return this._debugViewEnabled?null!==this._debugView?this._debugView:this.createDebugView():null}}]),e}()}();!function(){if(Macro.add("capture",{skipArgs:!0,tags:null,handler:function(){if(0===this.args.raw.length)return this.error("no story/temporary variable list specified");var e={};try{for(var t=new RegExp("("+Patterns.variable+")","g"),r=void 0;null!==(r=t.exec(this.args.raw));){var n=r[1],a=n.slice(1),i="$"===n[0]?State.variables:State.temporary;i.hasOwnProperty(a)&&(e[a]=i[a]),this.addShadow(n)}new Wikifier(this.output,this.payload[0].contents)}finally{this.shadows.forEach(function(t){var r=t.slice(1),n="$"===t[0]?State.variables:State.temporary;e.hasOwnProperty(r)?n[r]=e[r]:delete n[r]})}}}),Macro.add("set",{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no expression specified");try{Scripting.evalJavaScript(this.args.full)}catch(e){return this.error("bad evaluation: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("unset",{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no story/temporary variable list specified");for(var e=new RegExp("State\\.(variables|temporary)\\.("+Patterns.identifier+")","g"),t=void 0;null!==(t=e.exec(this.args.full));){var r=State[t[1]],n=t[2];r.hasOwnProperty(n)&&delete r[n]}Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("remember",{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no expression specified");try{Scripting.evalJavaScript(this.args.full)}catch(e){return this.error("bad evaluation: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}for(var e=storage.get("remember")||{},t=new RegExp("State\\.variables\\.("+Patterns.identifier+")","g"),r=void 0;null!==(r=t.exec(this.args.full));){var n=r[1];e[n]=State.variables[n]}if(!storage.set("remember",e))return this.error("unknown error, cannot remember: "+this.args.raw);Config.debug&&this.debugView.modes({hidden:!0})},init:function(){var e=storage.get("remember");e&&Object.keys(e).forEach(function(t){return State.variables[t]=e[t]})}}),Macro.add("forget",{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no story variable list specified");for(var e=storage.get("remember"),t=new RegExp("State\\.variables\\.("+Patterns.identifier+")","g"),r=void 0,n=!1;null!==(r=t.exec(this.args.full));){var a=r[1];State.variables.hasOwnProperty(a)&&delete State.variables[a],e&&e.hasOwnProperty(a)&&(n=!0,delete e[a])}if(n)if(0===Object.keys(e).length){if(!storage.delete("remember"))return this.error("unknown error, cannot update remember store")}else if(!storage.set("remember",e))return this.error("unknown error, cannot update remember store");Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("run","set"),Macro.add("script",{skipArgs:!0,tags:null,handler:function(){var e=document.createDocumentFragment();try{Scripting.evalJavaScript(this.payload[0].contents,e)}catch(e){return this.error("bad evaluation: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e),this.source+this.payload[0].contents+"<</"+this.name+">>")}Config.debug&&this.createDebugView(),e.hasChildNodes()&&this.output.appendChild(e)}}),Macro.add("include",{handler:function(){if(0===this.args.length)return this.error("no passage specified");var e=void 0;if(e="object"===_typeof(this.args[0])?this.args[0].link:this.args[0],!Story.has(e))return this.error('passage "'+e+'" does not exist');Config.debug&&this.debugView.modes({block:!0}),e=Story.get(e);var t=void 0;t=this.args[1]?jQuery(document.createElement(this.args[1])).addClass(e.domId+" macro-"+this.name).attr("data-passage",e.title).appendTo(this.output):jQuery(this.output),t.wiki(e.processText())}}),Macro.add("nobr",{skipArgs:!0,tags:null,handler:function(){new Wikifier(this.output,this.payload[0].contents.replace(/^\n+|\n+$/g,"").replace(/\n+/g," "))}}),Macro.add(["print","=","-"],{skipArgs:!0,handler:function(){if(0===this.args.full.length)return this.error("no expression specified");try{var e=toStringOrDefault(Scripting.evalJavaScript(this.args.full),null);null!==e&&new Wikifier(this.output,"-"===this.name?Util.escape(e):e)}catch(e){return this.error("bad evaluation: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}}}),Macro.add("silently",{skipArgs:!0,tags:null,handler:function(){var e=document.createDocumentFragment();if(new Wikifier(e,this.payload[0].contents.trim()),Config.debug)this.debugView.modes({hidden:!0}),this.output.appendChild(e);else{var t=[].concat(_toConsumableArray(e.querySelectorAll(".error"))).map(function(e){return e.textContent});if(t.length>0)return this.error("error"+(1===t.length?"":"s")+" within contents ("+t.join("; ")+")",this.source+this.payload[0].contents+"<</"+this.name+">>")}}}),Macro.add("display","include"),Macro.add("if",{skipArgs:!0,tags:["elseif","else"],handler:function(){var e=void 0;try{var t=this.payload.length;for(e=0;e<t;++e)switch(this.payload[e].name){case"else":if(this.payload[e].args.raw.length>0)return/^\s*if\b/i.test(this.payload[e].args.raw)?this.error('whitespace is not allowed between the "else" and "if" in <<elseif>> clause'+(e>0?" (#"+e+")":"")):this.error("<<else>> does not accept a conditional expression (perhaps you meant to use <<elseif>>), invalid: "+this.payload[e].args.raw);if(e+1!==t)return this.error("<<else>> must be the final clause");break;default:if(0===this.payload[e].args.full.length)return this.error("no conditional expression specified for <<"+this.payload[e].name+">> clause"+(e>0?" (#"+e+")":""));if(Config.macros.ifAssignmentError&&/[^!=&^|<>*\/%+-]=[^=]/.test(this.payload[e].args.full))return this.error("assignment operator found within <<"+this.payload[e].name+">> clause"+(e>0?" (#"+e+")":"")+" (perhaps you meant to use an equality operator: ==, ===, eq, is), invalid: "+this.payload[e].args.raw)}var r=Scripting.evalJavaScript,n=!1;for(e=0;e<t;++e){if(Config.debug&&this.createDebugView(this.payload[e].name,this.payload[e].source).modes({nonvoid:!1}),"else"===this.payload[e].name||r(this.payload[e].args.full)){n=!0,new Wikifier(this.output,this.payload[e].contents);break}Config.debug&&this.debugView.modes({hidden:!0,invalid:!0})}if(Config.debug){for(++e;e<t;++e)this.createDebugView(this.payload[e].name,this.payload[e].source).modes({nonvoid:!1,hidden:!0,invalid:!0});this.createDebugView("/"+this.name,"<</"+this.name+">>").modes({nonvoid:!1,hidden:!n,invalid:!n})}}catch(t){return this.error("bad conditional expression in <<"+(0===e?"if":"elseif")+">> clause"+(e>0?" (#"+e+")":"")+": "+("object"===(void 0===t?"undefined":_typeof(t))?t.message:t))}}}),Macro.add("switch",{skipArgs:["switch"],tags:["case","default"],handler:function(){if(0===this.args.full.length)return this.error("no expression specified");var e=this.payload.length;if(1===e)return this.error("no cases specified");var t=void 0;for(t=1;t<e;++t)switch(this.payload[t].name){case"default":if(this.payload[t].args.length>0)return this.error("<<default>> does not accept values, invalid: "+this.payload[t].args.raw);if(t+1!==e)return this.error("<<default>> must be the final case");break;default:if(0===this.payload[t].args.length)return this.error("no value(s) specified for <<"+this.payload[t].name+">> (#"+t+")")}var r=void 0;try{r=Scripting.evalJavaScript(this.args.full)}catch(e){return this.error("bad evaluation: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}var n=this.debugView,a=!1;for(Config.debug&&n.modes({nonvoid:!1,hidden:!0}),t=1;t<e;++t){if(Config.debug&&this.createDebugView(this.payload[t].name,this.payload[t].source).modes({nonvoid:!1}),"default"===this.payload[t].name||this.payload[t].args.some(function(e){return e===r})){a=!0,new Wikifier(this.output,this.payload[t].contents);break}Config.debug&&this.debugView.modes({hidden:!0,invalid:!0})}if(Config.debug){for(++t;t<e;++t)this.createDebugView(this.payload[t].name,this.payload[t].source).modes({nonvoid:!1,hidden:!0,invalid:!0});n.modes({nonvoid:!1,hidden:!0,invalid:!a}),this.createDebugView("/"+this.name,"<</"+this.name+">>").modes({nonvoid:!1,hidden:!0,invalid:!a})}}}),Macro.add("for",{skipArgs:!0,tags:null,_hasRangeRe:new RegExp("^\\S"+Patterns.anyChar+"*?\\s+range\\s+\\S"+Patterns.anyChar+"*?$"),_rangeRe:new RegExp("^(?:State\\.(variables|temporary)\\.("+Patterns.identifier+")\\s*,\\s*)?State\\.(variables|temporary)\\.("+Patterns.identifier+")\\s+range\\s+(\\S"+Patterns.anyChar+"*?)$"),_3PartRe:/^([^;]*?)\s*;\s*([^;]*?)\s*;\s*([^;]*?)$/,handler:function(){var e=this.args.full.trim(),t=this.payload[0].contents.replace(/\n$/,"");if(0===e.length)this.self._handleFor.call(this,t,null,!0,null);else if(this.self._hasRangeRe.test(e)){var r=e.match(this.self._rangeRe);if(null===r)return this.error("invalid range form syntax, format: [index ,] value range collection");this.self._handleForRange.call(this,t,{type:r[1],name:r[2]},{type:r[3],name:r[4]},r[5])}else{var n=void 0,a=void 0,i=void 0;if(-1===e.indexOf(";")){if(/^\S+\s+in\s+\S+/i.test(e))return this.error("invalid syntax, for…in is not supported; see: for…range");if(/^\S+\s+of\s+\S+/i.test(e))return this.error("invalid syntax, for…of is not supported; see: for…range");a=e}else{var o=e.match(this.self._3PartRe);if(null===o)return this.error("invalid 3-part conditional form syntax, format: [init] ; [condition] ; [post]");n=o[1],a=o[2].trim(),i=o[3],0===a.length&&(a=!0)}this.self._handleFor.call(this,t,n,a,i)}},_handleFor:function(e,t,r,n){var a=Scripting.evalJavaScript,i=!0,o=Config.macros.maxLoopIterations;Config.debug&&this.debugView.modes({block:!0});try{if(TempState.break=null,t)try{a(t)}catch(e){return this.error("bad init expression: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}for(;a(r);){if(--o<0)return this.error("exceeded configured maximum loop iterations ("+Config.macros.maxLoopIterations+")");if(new Wikifier(this.output,i?e.replace(/^\n/,""):e),i&&(i=!1),null!=TempState.break)if(1===TempState.break)TempState.break=null;else if(2===TempState.break){TempState.break=null;break}if(n)try{a(n)}catch(e){return this.error("bad post expression: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}}}catch(e){return this.error("bad conditional expression: "+("object"===(void 0===e?"undefined":_typeof(e))?e.message:e))}finally{TempState.break=null}},_handleForRange:function(e,t,r,n){var a=!0,i=void 0;try{i=this.self._toRangeList(n)}catch(e){return this.error(e.message)}Config.debug&&this.debugView.modes({block:!0});try{TempState.break=null;for(var o=0;o<i.length;++o)if(t.name&&(State[t.type][t.name]=i[o][0]),
State[r.type][r.name]=i[o][1],new Wikifier(this.output,a?e.replace(/^\n/,""):e),a&&(a=!1),null!=TempState.break)if(1===TempState.break)TempState.break=null;else if(2===TempState.break){TempState.break=null;break}}catch(e){return this.error("object"===(void 0===e?"undefined":_typeof(e))?e.message:e)}finally{TempState.break=null}},_toRangeList:function(e){var t=Scripting.evalJavaScript,r=void 0;try{r=t("{"===e[0]?"("+e+")":e)}catch(e){if("object"!==(void 0===e?"undefined":_typeof(e)))throw new Error("bad range expression: "+e);throw e.message="bad range expression: "+e.message,e}var n=void 0;switch(void 0===r?"undefined":_typeof(r)){case"string":n=[];for(var a=0;a<r.length;){var i=Util.charAndPosAt(r,a);n.push([a,i.char]),a=1+i.end}break;case"object":if(Array.isArray(r))n=r.map(function(e,t){return[t,e]});else if(r instanceof Set)n=[].concat(_toConsumableArray(r)).map(function(e,t){return[t,e]});else if(r instanceof Map)n=[].concat(_toConsumableArray(r.entries()));else{if("Object"!==Util.toStringTag(r))throw new Error("unsupported range expression type: "+Util.toStringTag(r));n=Object.keys(r).map(function(e){return[e,r[e]]})}break;default:throw new Error("unsupported range expression type: "+(void 0===r?"undefined":_typeof(r)))}return n}}),Macro.add(["break","continue"],{skipArgs:!0,handler:function(){if(!this.contextHas(function(e){return"for"===e.name}))return this.error("must only be used in conjunction with its parent macro <<for>>");TempState.break="continue"===this.name?1:2,Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add(["button","link"],{isAsync:!0,tags:null,handler:function(){var e=this;if(0===this.args.length)return this.error("no "+("button"===this.name?"button":"link")+" text specified");var t=jQuery(document.createElement("button"===this.name?"button":"a")),r=void 0;if("object"===_typeof(this.args[0]))if(this.args[0].isImage){var n=jQuery(document.createElement("img")).attr("src",this.args[0].source).appendTo(t);this.args[0].hasOwnProperty("passage")&&n.attr("data-passage",this.args[0].passage),this.args[0].hasOwnProperty("title")&&n.attr("title",this.args[0].title),this.args[0].hasOwnProperty("align")&&n.attr("align",this.args[0].align),this.args[0].hasOwnProperty("link")&&(r=this.args[0].link),r=this.args[0].link}else t.append(document.createTextNode(this.args[0].text)),r=this.args[0].link;else t.wikiWithOptions({profile:"core"},this.args[0]),r=this.args.length>1?this.args[1]:undefined;null!=r?(t.attr("data-passage",r),Story.has(r)?(t.addClass("link-internal"),Config.addVisitedLinkClass&&State.hasPlayed(r)&&t.addClass("link-visited")):t.addClass("link-broken")):t.addClass("link-internal"),t.addClass("macro-"+this.name).ariaClick({namespace:".macros",one:null!=r},this.createShadowWrapper(""!==this.payload[0].contents?function(){return Wikifier.wikifyEval(e.payload[0].contents.trim())}:null,null!=r?function(){return Engine.play(r)}:null)).appendTo(this.output)}}),Macro.add("checkbox",{isAsync:!0,handler:function(){if(this.args.length<3){var e=[];return this.args.length<1&&e.push("variable name"),this.args.length<2&&e.push("unchecked value"),this.args.length<3&&e.push("checked value"),this.error("no "+e.join(" or ")+" specified")}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var r=Util.slugify(t),n=this.args[1],a=this.args[2],i=document.createElement("input");jQuery(i).attr({id:this.name+"-"+r,name:this.name+"-"+r,type:"checkbox",tabindex:0}).addClass("macro-"+this.name).on("change.macros",this.createShadowWrapper(function(){State.setVar(t,this.checked?a:n)})).appendTo(this.output),this.args.length>3&&"checked"===this.args[3]?(i.checked=!0,State.setVar(t,a)):State.setVar(t,n)}}),Macro.add(["cycle","listbox"],{isAsync:!0,skipArgs:["optionsfrom"],tags:["option","optionsfrom"],handler:function(){var e=this;if(0===this.args.length)return this.error("no variable name specified");if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var r=Util.slugify(t),n=this.payload.length;if(1===n)return this.error("no options specified");for(var a=this.args.length>1&&"autoselect"===this.args[1],i=[],o={option:0,optionsfrom:0},s=-1,u=1;u<n;++u){var l=this.payload[u];if("option"===l.name){if(++o.option,0===l.args.length)return this.error("no arguments specified for <<"+l.name+">> (#"+o.option+")");if(i.push({label:String(l.args[0]),value:1===l.args.length?l.args[0]:l.args[1]}),l.args.length>2&&"selected"===l.args[2]){if(a)return this.error("cannot specify both the autoselect and selected keywords");if(-1!==s)return this.error("multiple selected keywords specified for <<"+l.name+">> (#"+(s+1)+" & #"+o.option+")");s=i.length-1}}else{var c=function(){if(++o.optionsfrom,0===l.args.full.length)return{v:e.error("no expression specified for <<"+l.name+">> (#"+o.optionsfrom+")")};var t=void 0;try{var r=l.args.full;t=Scripting.evalJavaScript("{"===r[0]?"("+r+")":r)}catch(t){return{v:e.error("bad evaluation: "+("object"===(void 0===t?"undefined":_typeof(t))?t.message:t))}}if("object"!==(void 0===t?"undefined":_typeof(t))||null===t)return{v:e.error("expression must yield a supported collection or generic object (type: "+(null===t?"null":void 0===t?"undefined":_typeof(t))+")")};if(t instanceof Array||t instanceof Set)t.forEach(function(e){return i.push({label:String(e),value:e})});else if(t instanceof Map)t.forEach(function(e,t){return i.push({label:String(t),value:e})});else{var n=Util.toStringTag(t);if("Object"!==n)return{v:e.error("expression must yield a supported collection or generic object (object type: "+n+")")};Object.keys(t).forEach(function(e){return i.push({label:e,value:t[e]})})}}();if("object"===(void 0===c?"undefined":_typeof(c)))return c.v}}if(-1===s)if(a){var d=Util.sameValueZero,f=State.getVar(t),p=i.findIndex(function(e){return d(e.value,f)});s=-1===p?0:p}else s=0;if("cycle"===this.name){var h=s;jQuery(document.createElement("a")).wikiWithOptions({profile:"core"},i[s].label).addClass("macro-"+this.name).ariaClick({namespace:".macros"},this.createShadowWrapper(function(){h=(h+1)%i.length,$(this).empty().wikiWithOptions({profile:"core"},i[h].label),State.setVar(t,i[h].value)})).appendTo(this.output)}else{var g=jQuery(document.createElement("select"));i.forEach(function(e,t){jQuery(document.createElement("option")).val(t).text(e.label).appendTo(g)}),g.attr({id:this.name+"-"+r,name:this.name+"-"+r,tabindex:0}).addClass("macro-"+this.name).val(s).on("change.macros",this.createShadowWrapper(function(){State.setVar(t,i[Number(this.value)].value)})).appendTo(this.output)}State.setVar(t,i[s].value)}}),Macro.add(["linkappend","linkprepend","linkreplace"],{isAsync:!0,tags:null,handler:function(){var e=this;if(0===this.args.length)return this.error("no link text specified");var t=jQuery(document.createElement("a")),r=jQuery(document.createElement("span")),n=this.args.length>1&&/^(?:transition|t8n)$/.test(this.args[1]);t.wikiWithOptions({profile:"core"},this.args[0]).addClass("link-internal macro-"+this.name).ariaClick({namespace:".macros",one:!0},this.createShadowWrapper(function(){if("linkreplace"===e.name?t.remove():t.wrap('<span class="macro-'+e.name+'"></span>').replaceWith(function(){return t.html()}),""!==e.payload[0].contents){var a=document.createDocumentFragment();new Wikifier(a,e.payload[0].contents),r.append(a)}n&&setTimeout(function(){return r.removeClass("macro-"+e.name+"-in")},Engine.minDomActionDelay)})).appendTo(this.output),r.addClass("macro-"+this.name+"-insert"),n&&r.addClass("macro-"+this.name+"-in"),"linkprepend"===this.name?r.insertBefore(t):r.insertAfter(t)}}),Macro.add("radiobutton",{isAsync:!0,handler:function(){if(this.args.length<2){var e=[];return this.args.length<1&&e.push("variable name"),this.args.length<2&&e.push("checked value"),this.error("no "+e.join(" or ")+" specified")}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');var r=Util.slugify(t),n=this.args[1],a=document.createElement("input");TempState.hasOwnProperty(this.name)||(TempState[this.name]={}),TempState[this.name].hasOwnProperty(r)||(TempState[this.name][r]=0),jQuery(a).attr({id:this.name+"-"+r+"-"+TempState[this.name][r]++,name:this.name+"-"+r,type:"radio",tabindex:0}).addClass("macro-"+this.name).on("change.macros",this.createShadowWrapper(function(){this.checked&&State.setVar(t,n)})).appendTo(this.output),this.args.length>2&&"checked"===this.args[2]&&(a.checked=!0,State.setVar(t,n))}}),Macro.add("textarea",{isAsync:!0,handler:function(){if(this.args.length<2){var e=[];return this.args.length<1&&e.push("variable name"),this.args.length<2&&e.push("default value"),this.error("no "+e.join(" or ")+" specified")}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');Config.debug&&this.debugView.modes({block:!0});var r=Util.slugify(t),n=this.args[1],a="autofocus"===this.args[2],i=document.createElement("textarea");jQuery(i).attr({id:this.name+"-"+r,name:this.name+"-"+r,rows:4,tabindex:0}).addClass("macro-"+this.name).on("change.macros",this.createShadowWrapper(function(){State.setVar(t,this.value)})).appendTo(this.output),State.setVar(t,n),i.textContent=n,a&&(i.setAttribute("autofocus","autofocus"),postdisplay["#autofocus:"+i.id]=function(e){delete postdisplay[e],setTimeout(function(){return i.focus()},Engine.minDomActionDelay)})}}),Macro.add("textbox",{isAsync:!0,handler:function(){if(this.args.length<2){var e=[];return this.args.length<1&&e.push("variable name"),this.args.length<2&&e.push("default value"),this.error("no "+e.join(" or ")+" specified")}if("string"!=typeof this.args[0])return this.error("variable name argument is not a string");var t=this.args[0].trim();if("$"!==t[0]&&"_"!==t[0])return this.error('variable name "'+this.args[0]+'" is missing its sigil ($ or _)');Config.debug&&this.debugView.modes({block:!0});var r=Util.slugify(t),n=this.args[1],a=document.createElement("input"),i=!1,o=void 0;this.args.length>3?(o=this.args[2],i="autofocus"===this.args[3]):this.args.length>2&&("autofocus"===this.args[2]?i=!0:o=this.args[2]),"object"===(void 0===o?"undefined":_typeof(o))&&(o=o.link),jQuery(a).attr({id:this.name+"-"+r,name:this.name+"-"+r,type:"text",tabindex:0}).addClass("macro-"+this.name).on("change.macros",this.createShadowWrapper(function(){State.setVar(t,this.value)})).on("keypress.macros",this.createShadowWrapper(function(e){13===e.which&&(e.preventDefault(),State.setVar(t,this.value),null!=o&&Engine.play(o))})).appendTo(this.output),State.setVar(t,n),a.value=n,i&&(a.setAttribute("autofocus","autofocus"),postdisplay["#autofocus:"+a.id]=function(e){delete postdisplay[e],setTimeout(function(){return a.focus()},Engine.minDomActionDelay)})}}),Macro.add("click","link"),Macro.add("actions",{handler:function(){for(var e=jQuery(document.createElement("ul")).addClass(this.name).appendTo(this.output),t=0;t<this.args.length;++t){var r=void 0,n=void 0,a=void 0,i=void 0;"object"===_typeof(this.args[t])?this.args[t].isImage?(a=jQuery(document.createElement("img")).attr("src",this.args[t].source),this.args[t].hasOwnProperty("passage")&&a.attr("data-passage",this.args[t].passage),this.args[t].hasOwnProperty("title")&&a.attr("title",this.args[t].title),this.args[t].hasOwnProperty("align")&&a.attr("align",this.args[t].align),r=this.args[t].link,i=this.args[t].setFn):(n=this.args[t].text,r=this.args[t].link,i=this.args[t].setFn):n=r=this.args[t],State.variables.hasOwnProperty("#actions")&&State.variables["#actions"].hasOwnProperty(r)&&State.variables["#actions"][r]||jQuery(Wikifier.createInternalLink(jQuery(document.createElement("li")).appendTo(e),r,null,function(e,t){return function(){State.variables.hasOwnProperty("#actions")||(State.variables["#actions"]={}),State.variables["#actions"][e]=!0,"function"==typeof t&&t()}}(r,i))).addClass("macro-"+this.name).append(a||document.createTextNode(n))}}}),Macro.add(["back","return"],{handler:function(){if(this.args.length>1)return this.error("too many arguments specified, check the documentation for details");var e=-1,t=void 0,r=void 0,n=void 0;if(1===this.args.length&&("object"===_typeof(this.args[0])?this.args[0].isImage?(n=jQuery(document.createElement("img")).attr("src",this.args[0].source),this.args[0].hasOwnProperty("passage")&&n.attr("data-passage",this.args[0].passage),this.args[0].hasOwnProperty("title")&&n.attr("title",this.args[0].title),this.args[0].hasOwnProperty("align")&&n.attr("align",this.args[0].align),this.args[0].hasOwnProperty("link")&&(t=this.args[0].link)):1===this.args[0].count?t=this.args[0].link:(r=this.args[0].text,t=this.args[0].link):1===this.args.length&&(r=this.args[0])),null==t){for(var a=State.length-2;a>=0;--a)if(State.history[a].title!==State.passage){e=a,t=State.history[a].title;break}if(null==t&&"return"===this.name)for(var i=State.expired.length-1;i>=0;--i)if(State.expired[i]!==State.passage){t=State.expired[i];break}}else{if(!Story.has(t))return this.error('passage "'+t+'" does not exist');if("back"===this.name){for(var o=State.length-2;o>=0;--o)if(State.history[o].title===t){e=o;break}if(-1===e)return this.error('cannot find passage "'+t+'" in the current story history')}}if(null==t)return this.error("cannot find passage");var s=void 0;s="back"!==this.name||-1!==e?jQuery(document.createElement("a")).addClass("link-internal").ariaClick({one:!0},"return"===this.name?function(){return Engine.play(t)}:function(){return Engine.goTo(e)}):jQuery(document.createElement("span")).addClass("link-disabled"),s.addClass("macro-"+this.name).append(n||document.createTextNode(r||L10n.get("macro"+this.name.toUpperFirst()+"Text"))).appendTo(this.output)}}),Macro.add("choice",{handler:function(){if(0===this.args.length)return this.error("no passage specified");var e=State.passage,t=void 0,r=void 0,n=void 0,a=void 0;if(1===this.args.length?"object"===_typeof(this.args[0])?this.args[0].isImage?(n=jQuery(document.createElement("img")).attr("src",this.args[0].source),this.args[0].hasOwnProperty("passage")&&n.attr("data-passage",this.args[0].passage),this.args[0].hasOwnProperty("title")&&n.attr("title",this.args[0].title),this.args[0].hasOwnProperty("align")&&n.attr("align",this.args[0].align),t=this.args[0].link,a=this.args[0].setFn):(r=this.args[0].text,t=this.args[0].link,a=this.args[0].setFn):r=t=this.args[0]:(t=this.args[0],r=this.args[1]),State.variables.hasOwnProperty("#choice")&&State.variables["#choice"].hasOwnProperty(e)&&State.variables["#choice"][e])return void jQuery(document.createElement("span")).addClass("link-disabled macro-"+this.name).attr("tabindex",-1).append(n||document.createTextNode(r)).appendTo(this.output);jQuery(Wikifier.createInternalLink(this.output,t,null,function(){State.variables.hasOwnProperty("#choice")||(State.variables["#choice"]={}),State.variables["#choice"][e]=!0,"function"==typeof a&&a()})).addClass("macro-"+this.name).append(n||document.createTextNode(r))}}),Macro.add(["addclass","toggleclass"],{handler:function(){if(this.args.length<2){var e=[];return this.args.length<1&&e.push("selector"),this.args.length<2&&e.push("class names"),this.error("no "+e.join(" or ")+" specified")}var t=jQuery(this.args[0]);if(0===t.length)return this.error('no elements matched the selector "'+this.args[0]+'"');switch(this.name){case"addclass":t.addClass(this.args[1].trim());break;case"toggleclass":t.toggleClass(this.args[1].trim())}Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("removeclass",{handler:function(){if(0===this.args.length)return this.error("no selector specified");var e=jQuery(this.args[0]);if(0===e.length)return this.error('no elements matched the selector "'+this.args[0]+'"');this.args.length>1?e.removeClass(this.args[1].trim()):e.removeClass(),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("copy",{handler:function(){if(0===this.args.length)return this.error("no selector specified");var e=jQuery(this.args[0]);if(0===e.length)return this.error('no elements matched the selector "'+this.args[0]+'"');jQuery(this.output).append(e.html()),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add(["append","prepend","replace"],{tags:null,handler:function(){var e=this;if(0===this.args.length)return this.error("no selector specified");var t=jQuery(this.args[0]);if(0===t.length)return this.error('no elements matched the selector "'+this.args[0]+'"');if(""!==this.payload[0].contents){var r=this.args.length>1&&/^(?:transition|t8n)$/.test(this.args[1]),n=void 0;switch(r?(n=jQuery(document.createElement("span")),n.addClass("macro-"+this.name+"-insert macro-"+this.name+"-in"),setTimeout(function(){return n.removeClass("macro-"+e.name+"-in")},Engine.minDomActionDelay)):n=jQuery(document.createDocumentFragment()),n.wiki(this.payload[0].contents),this.name){case"replace":t.empty();case"append":t.append(n);break;case"prepend":t.prepend(n)}}else"replace"===this.name&&t.empty();Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("remove",{handler:function(){if(0===this.args.length)return this.error("no selector specified");var e=jQuery(this.args[0]);if(0===e.length)return this.error('no elements matched the selector "'+this.args[0]+'"');e.remove(),Config.debug&&this.debugView.modes({hidden:!0})}}),Has.audio){var e=function(e,t){return'only one playback action allowed per invocation, "'+e+'" cannot be combined with "'+t+'"'};Macro.add("audio",{handler:function(){if(this.args.length<2){var t=[];return this.args.length<1&&t.push("track and/or group IDs"),this.args.length<2&&t.push("actions"),this.error("no "+t.join(" or ")+" specified")}var r=void 0;try{r=SimpleAudio.select(this.args[0])}catch(e){return this.error(e.message)}for(var n=this.args.slice(1),a=void 0,i=5,o=void 0,s=void 0,u=void 0,l=void 0,c=void 0,d=void 0;n.length>0;){var f=n.shift(),p=void 0;switch(f){case"load":case"pause":case"play":case"stop":case"unload":if(a)return this.error(e(f,a));a=f;break;case"fadein":if(a)return this.error(e(f,a));a="fade",o=1;break;case"fadeout":if(a)return this.error(e(f,a));a="fade",o=0;break;case"fadeto":if(a)return this.error(e(f,a));if(0===n.length)return this.error("fadeto missing required level value");if(a="fade",p=n.shift(),o=Number.parseFloat(p),Number.isNaN(o)||!Number.isFinite(o))return this.error("cannot parse fadeto: "+p);break;case"fadeoverto":if(a)return this.error(e(f,a));if(n.length<2){var h=[];return n.length<1&&h.push("seconds"),n.length<2&&h.push("level"),this.error("fadeoverto missing required "+h.join(" and ")+" value"+(h.length>1?"s":""))}if(a="fade",p=n.shift(),i=Number.parseFloat(p),Number.isNaN(i)||!Number.isFinite(i))return this.error("cannot parse fadeoverto: "+p);if(p=n.shift(),o=Number.parseFloat(p),Number.isNaN(o)||!Number.isFinite(o))return this.error("cannot parse fadeoverto: "+p);break;case"volume":if(0===n.length)return this.error("volume missing required level value");if(p=n.shift(),d=Number.parseFloat(p),Number.isNaN(d)||!Number.isFinite(d))return this.error("cannot parse volume: "+p);break;case"mute":case"unmute":u="mute"===f;break;case"time":if(0===n.length)return this.error("time missing required seconds value");if(p=n.shift(),c=Number.parseFloat(p),Number.isNaN(c)||!Number.isFinite(c))return this.error("cannot parse time: "+p);break;case"loop":case"unloop":s="loop"===f;break;case"goto":if(0===n.length)return this.error("goto missing required passage title");if(p=n.shift(),l="object"===(void 0===p?"undefined":_typeof(p))?p.link:p,!Story.has(l))return this.error('passage "'+l+'" does not exist');break;default:return this.error("unknown action: "+f)}}try{if(null!=d&&r.volume(d),null!=c&&r.time(c),null!=u&&r.mute(u),null!=s&&r.loop(s),null!=l){var g="ended.macros.macro-"+this.name+"_goto";r.off(g).one(g,function(){r.off(g),Engine.play(l)})}switch(a){case"fade":r.fade(i,o);break;case"load":r.load();break;case"pause":r.pause();break;case"play":r.play();break;case"stop":r.stop();break;case"unload":r.unload()}Config.debug&&this.debugView.modes({hidden:!0})}catch(e){return this.error("error executing action: "+e.message)}}}),Macro.add("cacheaudio",{handler:function(){var e=this;if(this.args.length<2){var t=[];return this.args.length<1&&t.push("track ID"),this.args.length<2&&t.push("sources"),this.error("no "+t.join(" or ")+" specified")}var r=String(this.args[0]).trim(),n=/^format:\s*([\w-]+)\s*;\s*/i;try{SimpleAudio.tracks.add(r,this.args.slice(1).map(function(t){if(n.test(t)){if(Config.debug)return e.error('track ID "'+r+'": format specifier migration required, "format:formatId;" → "formatId|"');t=t.replace(n,"$1|")}return t}))}catch(e){return this.error(e.message)}if(Config.debug&&!SimpleAudio.tracks.get(r).hasSource())return this.error('track ID "'+r+'": no supported audio sources found');Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("createaudiogroup",{tags:["track"],handler:function(){if(0===this.args.length)return this.error("no group ID specified");if(1===this.payload.length)return this.error("no tracks defined via <<track>>");Config.debug&&this.debugView.modes({nonvoid:!1,hidden:!0});for(var e=String(this.args[0]).trim(),t=[],r=1,n=this.payload.length;r<n;++r){if(this.payload[r].args.length<1)return this.error("no track ID specified");t.push(String(this.payload[r].args[0]).trim()),Config.debug&&this.createDebugView(this.payload[r].name,this.payload[r].source).modes({nonvoid:!1,hidden:!0})}try{SimpleAudio.groups.add(e,t)}catch(e){return this.error(e.message)}Config.debug&&this.createDebugView("/"+this.name,"<</"+this.name+">>").modes({nonvoid:!1,hidden:!0})}}),Macro.add("createplaylist",{tags:["track"],handler:function(){if(0===this.args.length)return this.error("no list ID specified");if(1===this.payload.length)return this.error("no tracks defined via <<track>>");var e=Macro.get("playlist");if(null!==e.from&&"createplaylist"!==e.from)return this.error("a playlist has already been defined with <<setplaylist>>");Config.debug&&this.debugView.modes({nonvoid:!1,hidden:!0});for(var t=String(this.args[0]).trim(),r=[],n=1,a=this.payload.length;n<a;++n){if(0===this.payload[n].args.length)return this.error("no track ID specified");for(var i={id:String(this.payload[n].args[0]).trim()},o=this.payload[n].args.slice(1);o.length>0;){var s=o.shift(),u=void 0,l=void 0;switch(s){case"copy":case"own":i.own=!0;break;case"rate":o.length>0&&o.shift();break;case"volume":if(0===o.length)return this.error("volume missing required level value");if(u=o.shift(),l=Number.parseFloat(u),Number.isNaN(l)||!Number.isFinite(l))return this.error("cannot parse volume: "+u);i.volume=l;break;default:return this.error("unknown action: "+s)}}r.push(i),Config.debug&&this.createDebugView(this.payload[n].name,this.payload[n].source).modes({nonvoid:!1,hidden:!0})}try{SimpleAudio.lists.add(t,r)}catch(e){return this.error(e.message)}null===e.from&&(e.from="createplaylist"),Config.debug&&this.createDebugView("/"+this.name,"<</"+this.name+">>").modes({nonvoid:!1,hidden:!0})}}),Macro.add("masteraudio",{handler:function(){if(0===this.args.length)return this.error("no actions specified");for(var t=this.args.slice(0),r=void 0,n=void 0,a=void 0,i=void 0;t.length>0;){var o=t.shift(),s=void 0;switch(o){case"load":case"stop":case"unload":if(r)return this.error(e(o,r));r=o;break;case"mute":case"unmute":n="mute"===o;break;case"muteonhide":case"nomuteonhide":a="muteonhide"===o;break;case"volume":if(0===t.length)return this.error("volume missing required level value");if(s=t.shift(),i=Number.parseFloat(s),Number.isNaN(i)||!Number.isFinite(i))return this.error("cannot parse volume: "+s);break;default:return this.error("unknown action: "+o)}}try{switch(null!=n&&SimpleAudio.mute(n),null!=a&&SimpleAudio.muteOnHidden(a),null!=i&&SimpleAudio.volume(i),r){case"load":SimpleAudio.load();break;case"stop":SimpleAudio.stop();break;case"unload":SimpleAudio.unload()}Config.debug&&this.debugView.modes({hidden:!0})}catch(e){return this.error("error executing action: "+e.message)}}}),Macro.add("playlist",{from:null,handler:function(){var t=this.self.from;if(null===t)return this.error("no playlists have been created");var r=void 0,n=void 0;if("createplaylist"===t){if(this.args.length<2){var a=[];return this.args.length<1&&a.push("list ID"),this.args.length<2&&a.push("actions"),this.error("no "+a.join(" or ")+" specified")}var i=String(this.args[0]).trim();if(!SimpleAudio.lists.has(i))return this.error('playlist "'+i+'" does not exist');r=SimpleAudio.lists.get(i),n=this.args.slice(1)}else{if(0===this.args.length)return this.error("no actions specified");r=SimpleAudio.lists.get("setplaylist"),n=this.args.slice(0)}for(var o=void 0,s=5,u=void 0,l=void 0,c=void 0,d=void 0,f=void 0;n.length>0;){var p=n.shift(),h=void 0;switch(p){case"load":case"pause":case"play":case"skip":case"stop":case"unload":if(o)return this.error(e(p,o));o=p;break;case"fadein":if(o)return this.error(e(p,o));o="fade",u=1;break;case"fadeout":if(o)return this.error(e(p,o));o="fade",u=0;break;case"fadeto":if(o)return this.error(e(p,o));if(0===n.length)return this.error("fadeto missing required level value");if(o="fade",h=n.shift(),u=Number.parseFloat(h),Number.isNaN(u)||!Number.isFinite(u))return this.error("cannot parse fadeto: "+h);break;case"fadeoverto":if(o)return this.error(e(p,o));if(n.length<2){var g=[];return n.length<1&&g.push("seconds"),n.length<2&&g.push("level"),this.error("fadeoverto missing required "+g.join(" and ")+" value"+(g.length>1?"s":""))}if(o="fade",h=n.shift(),s=Number.parseFloat(h),Number.isNaN(s)||!Number.isFinite(s))return this.error("cannot parse fadeoverto: "+h);if(h=n.shift(),u=Number.parseFloat(h),Number.isNaN(u)||!Number.isFinite(u))return this.error("cannot parse fadeoverto: "+h);break;case"volume":if(0===n.length)return this.error("volume missing required level value");if(h=n.shift(),f=Number.parseFloat(h),Number.isNaN(f)||!Number.isFinite(f))return this.error("cannot parse volume: "+h);break;case"mute":case"unmute":c="mute"===p;break;case"loop":case"unloop":l="loop"===p;break;case"shuffle":case"unshuffle":d="shuffle"===p;break;default:return this.error("unknown action: "+p)}}try{switch(null!=f&&r.volume(f),null!=c&&r.mute(c),null!=l&&r.loop(l),null!=d&&r.shuffle(d),o){case"fade":r.fade(s,u);break;case"load":r.load();break;case"pause":r.pause();break;case"play":r.play();break;case"skip":r.skip();break;case"stop":r.stop();break;case"unload":r.unload()}Config.debug&&this.debugView.modes({hidden:!0})}catch(e){return this.error("error executing action: "+e.message)}}}),Macro.add("removeaudiogroup",{handler:function(){if(0===this.args.length)return this.error("no group ID specified");var e=String(this.args[0]).trim();if(!SimpleAudio.groups.has(e))return this.error('group "'+e+'" does not exist');SimpleAudio.groups.delete(e),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("removeplaylist",{handler:function(){if(0===this.args.length)return this.error("no list ID specified");var e=String(this.args[0]).trim();if(!SimpleAudio.lists.has(e))return this.error('playlist "'+e+'" does not exist');SimpleAudio.lists.delete(e),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("waitforaudio",{skipArgs:!0,handler:function(){SimpleAudio.loadWithScreen()}}),Macro.add("setplaylist",{handler:function(){if(0===this.args.length)return this.error("no track ID(s) specified");var e=Macro.get("playlist");if(null!==e.from&&"setplaylist"!==e.from)return this.error("playlists have already been defined with <<createplaylist>>");try{SimpleAudio.lists.add("setplaylist",this.args.slice(0))}catch(e){return this.error(e.message)}null===e.from&&(e.from="setplaylist"),Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("stopallaudio",{skipArgs:!0,handler:function(){SimpleAudio.select(":all").stop(),Config.debug&&this.debugView.modes({hidden:!0})}})}else Macro.add(["audio","cacheaudio","createaudiogroup","createplaylist","masteraudio","playlist","removeaudiogroup","removeplaylist","waitforaudio","setplaylist","stopallaudio"],{skipArgs:!0,handler:function(){Config.debug&&this.debugView.modes({hidden:!0})}});Macro.add("goto",{handler:function(){if(0===this.args.length)return this.error("no passage specified");var e=void 0;if(e="object"===_typeof(this.args[0])?this.args[0].link:this.args[0],!Story.has(e))return this.error('passage "'+e+'" does not exist');setTimeout(function(){return Engine.play(e)},Engine.minDomActionDelay)}}),Macro.add("repeat",{isAsync:!0,tags:null,timers:new Set,handler:function(){var e=this;if(0===this.args.length)return this.error("no time value specified");var t=void 0;try{t=Math.max(Engine.minDomActionDelay,Util.fromCssTime(this.args[0]))}catch(e){return this.error(e.message)}Config.debug&&this.debugView.modes({block:!0});var r=this.args.length>1&&/^(?:transition|t8n)$/.test(this.args[1]),n=jQuery(document.createElement("span")).addClass("macro-"+this.name).appendTo(this.output);this.self.registerInterval(this.createShadowWrapper(function(){var t=document.createDocumentFragment();new Wikifier(t,e.payload[0].contents);var a=n;r&&(a=jQuery(document.createElement("span")).addClass("macro-repeat-insert macro-repeat-in").appendTo(a)),a.append(t),r&&setTimeout(function(){return a.removeClass("macro-repeat-in")},Engine.minDomActionDelay)}),t)},registerInterval:function(e,t){var r=this;if("function"!=typeof e)throw new TypeError("callback parameter must be a function");var n=State.turns,a=this.timers,i=null;i=setInterval(function(){if(n!==State.turns)return clearInterval(i),void a.delete(i);var t=void 0;try{TempState.break=null,TempState.hasOwnProperty("repeatTimerId")&&(t=TempState.repeatTimerId),TempState.repeatTimerId=i,e.call(r)}finally{void 0!==t?TempState.repeatTimerId=t:delete TempState.repeatTimerId,TempState.break=null}},t),a.add(i),prehistory.hasOwnProperty("#repeat-timers-cleanup")||(prehistory["#repeat-timers-cleanup"]=function(e){delete prehistory[e],a.forEach(function(e){return clearInterval(e)}),a.clear()})}}),Macro.add("stop",{skipArgs:!0,handler:function(){if(!TempState.hasOwnProperty("repeatTimerId"))return this.error("must only be used in conjunction with its parent macro <<repeat>>");var e=Macro.get("repeat").timers,t=TempState.repeatTimerId;clearInterval(t),e.delete(t),TempState.break=2,Config.debug&&this.debugView.modes({hidden:!0})}}),Macro.add("timed",{isAsync:!0,tags:["next"],timers:new Set,handler:function(){if(0===this.args.length)return this.error("no time value specified in <<timed>>");var e=[];try{e.push({name:this.name,source:this.source,delay:Math.max(Engine.minDomActionDelay,Util.fromCssTime(this.args[0])),content:this.payload[0].contents})}catch(e){return this.error(e.message+" in <<timed>>")}if(this.payload.length>1){var t=void 0;try{var r=void 0;for(t=1,r=this.payload.length;t<r;++t)e.push({name:this.payload[t].name,source:this.payload[t].source,delay:0===this.payload[t].args.length?e[e.length-1].delay:Math.max(Engine.minDomActionDelay,Util.fromCssTime(this.payload[t].args[0])),content:this.payload[t].contents})}catch(e){return this.error(e.message+" in <<next>> (#"+t+")")}}Config.debug&&this.debugView.modes({block:!0});var n=this.args.length>1&&/^(?:transition|t8n)$/.test(this.args[1]),a=jQuery(document.createElement("span")).addClass("macro-"+this.name).appendTo(this.output);this.self.registerTimeout(this.createShadowWrapper(function(e){var t=document.createDocumentFragment();new Wikifier(t,e.content);var r=a;Config.debug&&"next"===e.name&&(r=jQuery(new DebugView(r[0],"macro",e.name,e.source).output)),
n&&(r=jQuery(document.createElement("span")).addClass("macro-timed-insert macro-timed-in").appendTo(r)),r.append(t),n&&setTimeout(function(){return r.removeClass("macro-timed-in")},Engine.minDomActionDelay)}),e)},registerTimeout:function(e,t){if("function"!=typeof e)throw new TypeError("callback parameter must be a function");var r=State.turns,n=this.timers,a=null,i=t.shift(),o=function o(){if(n.delete(a),r===State.turns){var s=i;null!=(i=t.shift())&&(a=setTimeout(o,i.delay),n.add(a)),e.call(this,s)}};a=setTimeout(o,i.delay),n.add(a),prehistory.hasOwnProperty("#timed-timers-cleanup")||(prehistory["#timed-timers-cleanup"]=function(e){delete prehistory[e],n.forEach(function(e){return clearTimeout(e)}),n.clear()})}}),Macro.add("widget",{tags:null,handler:function(){if(0===this.args.length)return this.error("no widget name specified");var e=this.args[0];if(Macro.has(e)){if(!Macro.get(e).isWidget)return this.error('cannot clobber existing macro "'+e+'"');Macro.delete(e)}try{Macro.add(e,{isWidget:!0,handler:function(e){return function(){var t=void 0;try{State.variables.hasOwnProperty("args")&&(t=State.variables.args),State.variables.args=[].concat(_toConsumableArray(this.args)),State.variables.args.raw=this.args.raw,State.variables.args.full=this.args.full,this.addShadow("$args");var r=document.createDocumentFragment(),n=[];if(new Wikifier(r,e),Array.from(r.querySelectorAll(".error")).forEach(function(e){n.push(e.textContent)}),0!==n.length)return this.error("error"+(n.length>1?"s":"")+" within widget contents ("+n.join("; ")+")");this.output.appendChild(r)}catch(e){return this.error("cannot execute widget: "+e.message)}finally{void 0!==t?State.variables.args=t:delete State.variables.args}}}(this.payload[0].contents)}),Config.debug&&this.debugView.modes({hidden:!0})}catch(t){return this.error('cannot create widget macro "'+e+'": '+t.message)}}})}();var Dialog=function(){function e(e,t,r,n,a){return jQuery(e).ariaClick(function(e){e.preventDefault(),"function"==typeof r&&r(e),o(t,a),"function"==typeof n&&n(e)})}function t(){var e;return(e=g).append.apply(e,arguments),Dialog}function r(){return g.get(0)}function n(e){return g.trigger(":dialogclosing"),jQuery(document).off(".dialog-close"),y?(y.disconnect(),y=null):g.off(".dialog-resize"),jQuery(window).off(".dialog-resize"),p.removeClass("open").css({left:"",right:"",top:"",bottom:""}),jQuery("#ui-bar,#story").find("[tabindex=-2]").removeAttr("aria-hidden").attr("tabindex",0),jQuery("body>[tabindex=-3]").removeAttr("aria-hidden").removeAttr("tabindex"),f.removeClass("open"),jQuery(document.documentElement).removeAttr("data-dialog"),h.empty(),g.empty().removeClass(),null!==m&&(jQuery(m).focus(),m=null),e&&e.data&&"function"==typeof e.data.closeFn&&e.data.closeFn(e),g.trigger(":dialogclose"),g.trigger(":dialogclosed"),Dialog}function a(){if(!document.getElementById("ui-dialog")){v=function(){var e=void 0;try{var t=document.createElement("p"),r=document.createElement("div");t.style.width="100%",t.style.height="200px",r.style.position="absolute",r.style.left="0px",r.style.top="0px",r.style.width="100px",r.style.height="100px",r.style.visibility="hidden",r.style.overflow="hidden",r.appendChild(t),document.body.appendChild(r);var n=t.offsetWidth;r.style.overflow="auto";var a=t.offsetWidth;n===a&&(a=r.clientWidth),document.body.removeChild(r),e=n-a}catch(e){}return e||17}();var e=jQuery(document.createDocumentFragment()).append('<div id="ui-overlay" class="ui-close"></div><div id="ui-dialog" tabindex="0" role="dialog" aria-labelledby="ui-dialog-title"><div id="ui-dialog-titlebar"><h1 id="ui-dialog-title"></h1><button id="ui-dialog-close" class="ui-close" tabindex="0" aria-label="'+L10n.get("close")+'"></button></div><div id="ui-dialog-body"></div></div>');f=jQuery(e.find("#ui-overlay").get(0)),p=jQuery(e.find("#ui-dialog").get(0)),h=jQuery(e.find("#ui-dialog-title").get(0)),g=jQuery(e.find("#ui-dialog-body").get(0)),e.insertBefore("body>script#script-sugarcube")}}function i(e){return p.hasClass("open")&&(!e||e.splitOrEmpty(/\s+/).every(function(e){return g.hasClass(e)}))}function o(e,t){g.trigger(":dialogopening");var r=jQuery.extend({top:50},e),a=r.top;return i()||(m=safeActiveElement()),jQuery(document.documentElement).attr("data-dialog","open"),f.addClass("open"),null!==g[0].querySelector("img")&&g.imagesLoaded().always(function(){return d({data:{top:a}})}),jQuery("body>:not(script,#store-area,tw-storydata,#ui-bar,#ui-overlay,#ui-dialog)").attr("tabindex",-3).attr("aria-hidden",!0),jQuery("#ui-bar,#story").find("[tabindex]:not([tabindex^=-])").attr("tabindex",-2).attr("aria-hidden",!0),p.css(c(a)).addClass("open").focus(),jQuery(window).on("resize.dialog-resize",null,{top:a},jQuery.throttle(40,d)),Has.mutationObserver?(y=new MutationObserver(function(e){for(var t=0;t<e.length;++t)if("childList"===e[t].type){d({data:{top:a}});break}}),y.observe(g[0],{childList:!0,subtree:!0})):g.on("DOMNodeInserted.dialog-resize DOMNodeRemoved.dialog-resize",null,{top:a},jQuery.throttle(40,d)),jQuery(document).on("click.dialog-close",".ui-close",{closeFn:t},n).on("keypress.dialog-close",".ui-close",function(e){13!==e.which&&32!==e.which||jQuery(this).trigger("click")}),g.trigger(":dialogopen"),g.trigger(":dialogopened"),Dialog}function s(e){return d("object"===(void 0===e?"undefined":_typeof(e))?{data:e}:undefined)}function u(e,t){return g.empty().removeClass(),null!=t&&g.addClass(t),h.empty().append((null!=e?String(e):"")||" "),g.get(0)}function l(){var e;return(e=g).wiki.apply(e,arguments),Dialog}function c(e){var t=null!=e?e:50,r=jQuery(window),n={left:"",right:"",top:"",bottom:""};p.css(n);var a=r.width()-p.outerWidth(!0)-1,i=r.height()-p.outerHeight(!0)-1;return a<=32+v&&(i-=v),i<=32+v&&(a-=v),n.left=n.right=a<=32?16:a/2>>0,n.top=i<=32?n.bottom=16:i/2>t?t:n.bottom=i/2>>0,Object.keys(n).forEach(function(e){""!==n[e]&&(n[e]+="px")}),n}function d(e){var t=e&&e.data&&void 0!==e.data.top?e.data.top:50;"block"===p.css("display")&&(p.css({display:"none"}),p.css(jQuery.extend({display:""},c(t))))}var f=null,p=null,h=null,g=null,m=null,v=0,y=null;return Object.freeze(Object.defineProperties({},{append:{value:t},body:{value:r},close:{value:n},init:{value:a},isOpen:{value:i},open:{value:o},resize:{value:s},setup:{value:u},wiki:{value:l},addClickHandler:{value:e}}))}(),Engine=function(){function e(){jQuery("#init-no-js,#init-lacking").remove(),function(){var e=jQuery(document.createDocumentFragment()),t=Story.has("StoryInterface")&&Story.get("StoryInterface").text.trim();if(t){if(UIBar.destroy(),jQuery(document.head).find("#style-core-display").remove(),e.append(t),0===e.find("#passages").length)throw new Error('no element with ID "passages" found within "StoryInterface" special passage');var r=[];e.find("[data-passage]").each(function(e,t){if("passages"===t.id)throw new Error('"StoryInterface" element <'+t.nodeName.toLowerCase()+' id="passages"> must not contain a "data-passage" content attribute');var n=t.getAttribute("data-passage").trim();if(null!==t.firstElementChild)throw new Error('"StoryInterface" element <'+t.nodeName.toLowerCase()+' data-passage="'+n+'"> contains child elements');Story.has(n)&&r.push({passage:n,element:t})}),r.length>0&&(E=r),Config.ui.updateStoryElements=!1}else e.append('<div id="story" role="main"><div id="passages"></div></div>');e.insertBefore("body>script#script-sugarcube")}(),S=new StyleWrapper(function(){return jQuery(document.createElement("style")).attr({id:"style-aria-outlines",type:"text/css"}).appendTo(document.head).get(0)}()),jQuery(document).on("mousedown.aria-outlines keydown.aria-outlines",function(e){return"keydown"===e.type?m():g()})}function t(){if(Story.has("StoryInit"))try{var e=Wikifier.wikifyEval(Story.get("StoryInit").text);if(Config.debug){var t=new DebugView(document.createDocumentFragment(),"special","StoryInit","StoryInit");t.modes({hidden:!0}),t.append(e),k=t.output}}catch(e){console.error(e),Alert.error("StoryInit",e.message)}if(null==Config.passages.start)throw new Error("starting passage not selected");if(!Story.has(Config.passages.start))throw new Error('starting passage ("'+Config.passages.start+'") not found');if(jQuery(document.documentElement).focus(),State.restore())f();else{var r=!0;switch(_typeof(Config.saves.autoload)){case"boolean":Config.saves.autoload&&Save.autosave.ok()&&Save.autosave.has()&&(r=!Save.autosave.load());break;case"string":"prompt"===Config.saves.autoload&&Save.autosave.ok()&&Save.autosave.has()&&(r=!1,UI.buildAutoload(),Dialog.open());break;case"function":Save.autosave.ok()&&Save.autosave.has()&&Config.saves.autoload()&&(r=!Save.autosave.load())}r&&p(Config.passages.start)}}function r(){LoadScreen.show(),window.scroll(0,0),State.reset(),jQuery.event.trigger(":enginerestart"),window.location.reload()}function n(){return b}function a(){return b===v.Idle}function i(){return b!==v.Idle}function o(){return b===v.Rendering}function s(){return w}function u(e){var t=State.goTo(e);return t&&f(),t}function l(e){var t=State.go(e);return t&&f(),t}function c(){return l(-1)}function d(){return l(1)}function f(){return p(State.passage,!0)}function p(e,t){var r=e;b=v.Playing,TempState={},State.clearTemporary();var n=void 0,a=void 0;if("function"==typeof Config.navigation.override)try{var i=Config.navigation.override(r);i&&(r=i)}catch(e){}var o=Story.get(r);if(jQuery.event.trigger({type:":passageinit",passage:o}),Object.keys(prehistory).forEach(function(e){"function"==typeof prehistory[e]&&prehistory[e].call(this,e)},o),t||State.create(o.title),w=Util.now(),document.body.className&&(document.body.className=""),Object.keys(predisplay).forEach(function(e){"function"==typeof predisplay[e]&&predisplay[e].call(this,e)},o),Story.has("PassageReady"))try{n=Wikifier.wikifyEval(Story.get("PassageReady").text)}catch(e){console.error(e),Alert.error("PassageReady",e.message)}b=v.Rendering;var s=jQuery(o.render()),u=document.getElementById("passages");if(u.hasChildNodes()&&("number"==typeof Config.passages.transitionOut||"string"==typeof Config.passages.transitionOut&&""!==Config.passages.transitionOut&&Has.transitionEndEvent?[].concat(_toConsumableArray(u.childNodes)).forEach(function(e){var t=jQuery(e);if(e.nodeType===Node.ELEMENT_NODE&&t.hasClass("passage")){if(t.hasClass("passage-out"))return;t.attr("id","out-"+t.attr("id")).addClass("passage-out"),"string"==typeof Config.passages.transitionOut?t.on(Has.transitionEndEvent,function(e){e.originalEvent.propertyName===Config.passages.transitionOut&&t.remove()}):setTimeout(function(){return t.remove()},Math.max(y,Config.passages.transitionOut))}else t.remove()}):jQuery(u).empty()),s.addClass("passage-in").appendTo(u),setTimeout(function(){return s.removeClass("passage-in")},y),Config.passages.displayTitles&&o.title!==Config.passages.start&&(document.title=o.title+" | "+Story.title),window.scroll(0,0),b=v.Playing,Story.has("PassageDone"))try{a=Wikifier.wikifyEval(Story.get("PassageDone").text)}catch(e){console.error(e),Alert.error("PassageDone",e.message)}if(jQuery.event.trigger({type:":passagedisplay",passage:o}),Object.keys(postdisplay).forEach(function(e){"function"==typeof postdisplay[e]&&postdisplay[e].call(this,e)},o),null!==E?E.forEach(function(e){jQuery(e.element).empty(),new Wikifier(e.element,Story.get(e.passage).processText().trim())}):Config.ui.updateStoryElements&&UIBar.update(),Config.debug){var l=void 0;null!=n&&(l=new DebugView(document.createDocumentFragment(),"special","PassageReady","PassageReady"),l.modes({hidden:!0}),l.append(n),s.prepend(l.output)),null!=a&&(l=new DebugView(document.createDocumentFragment(),"special","PassageDone","PassageDone"),l.modes({hidden:!0}),l.append(a),s.append(l.output)),1===State.turns&&null!=k&&s.prepend(k)}switch(g(),jQuery("#story").find("a[href]:not(.link-external)").addClass("link-external").end().find("a,link,button,input,select,textarea").not("[tabindex]").attr("tabindex",0),_typeof(Config.saves.autosave)){case"boolean":Config.saves.autosave&&Save.autosave.save();break;case"object":o.tags.some(function(e){return Config.saves.autosave.includes(e)})&&Save.autosave.save();break;case"function":Config.saves.autosave()&&Save.autosave.save()}return jQuery.event.trigger({type:":passageend",passage:o}),b=v.Idle,w=Util.now(),s[0]}function h(e,t,r){var n=!1;switch(r){case undefined:break;case"replace":case"back":n=!0;break;default:throw new Error('Engine.display option parameter called with obsolete value "'+r+'"; please notify the developer')}p(e,n)}function g(){S.set("*:focus{outline:none}")}function m(){S.clear()}var v=Util.toEnum({Idle:"idle",Playing:"playing",Rendering:"rendering"}),y=40,b=v.Idle,w=null,k=null,S=null,E=null;return Object.freeze(Object.defineProperties({},{States:{value:v},minDomActionDelay:{value:y},init:{value:e},start:{value:t},restart:{value:r},state:{get:n},isIdle:{value:a},isPlaying:{value:i},isRendering:{value:o},lastPlay:{get:s},goTo:{value:u},go:{value:l},backward:{value:c},forward:{value:d},show:{value:f},play:{value:p},display:{value:h}}))}(),Passage=function(){var e=void 0;e=/^(?:debug|nobr|passage|widget|twine\..*)$/i;return function(){function t(r,n){var a=this;_classCallCheck(this,t),Object.defineProperties(this,{title:{value:Util.unescape(r)},element:{value:n||null},tags:{value:Object.freeze(n&&n.hasAttribute("tags")?n.getAttribute("tags").trim().splitOrEmpty(/\s+/).sort().filter(function(e,t,r){return 0===t||r[t-1]!==e}):[])},_excerpt:{writable:!0,value:null}}),Object.defineProperties(this,{domId:{value:"passage-"+Util.slugify(this.title)},classes:{value:Object.freeze(0===this.tags.length?[]:function(){return a.tags.filter(function(t){return!e.test(t)}).map(function(e){return Util.slugify(e)})}())}})}return _createClass(t,[{key:"description",value:function(){var e=Config.passages.descriptions;if(null!=e)switch(void 0===e?"undefined":_typeof(e)){case"boolean":if(e)return this.title;break;case"object":if(e instanceof Map&&e.has(this.title))return e.get(this.title);if(e.hasOwnProperty(this.title))return e[this.title];break;case"function":var r=e.call(this);if(r)return r;break;default:throw new TypeError("Config.passages.descriptions must be a boolean, object, or function")}return null===this._excerpt&&(this._excerpt=t.getExcerptFromText(this.text)),this._excerpt}},{key:"processText",value:function(){if(null==this.element)return this.text;if(this.tags.includes("Twine.image"))return"[img["+this.text+"]]";var e=this.text;return Config.passages.onProcess&&(e=Config.passages.onProcess.call(null,{title:this.title,tags:this.tags,text:e})),(Config.passages.nobr||this.tags.includes("nobr"))&&(e=e.replace(/^\n+|\n+$/g,"").replace(/\n+/g," ")),e}},{key:"render",value:function(){var e=this,r=this.tags.length>0?this.tags.join(" "):null,n=document.createElement("div");return jQuery(n).attr({id:this.domId,"data-passage":this.title,"data-tags":r}).addClass("passage "+this.className),jQuery(document.body).attr("data-tags",r).addClass(this.className),jQuery(document.documentElement).attr("data-tags",r),jQuery.event.trigger({type:":passagestart",content:n,passage:this}),Object.keys(prerender).forEach(function(t){"function"==typeof prerender[t]&&prerender[t].call(e,n,t)}),Story.has("PassageHeader")&&new Wikifier(n,Story.get("PassageHeader").processText()),new Wikifier(n,this.processText()),Story.has("PassageFooter")&&new Wikifier(n,Story.get("PassageFooter").processText()),jQuery.event.trigger({type:":passagerender",content:n,passage:this}),Object.keys(postrender).forEach(function(t){"function"==typeof postrender[t]&&postrender[t].call(e,n,t)}),this._excerpt=t.getExcerptFromNode(n),n}},{key:"className",get:function(){return this.classes.join(" ")}},{key:"text",get:function(){if(null==this.element){var e=Util.escape(this.title);return'<div class="error-view"><span class="error">'+(L10n.get("errorTitle")+": "+L10n.get("errorNonexistentPassage",{passage:e}))+"</span></div>"}return this.element.textContent.replace(/\r/g,"")}}],[{key:"getExcerptFromNode",value:function(e,t){if(!e.hasChildNodes())return"";var r=e.textContent.trim();if(""!==r){var n=new RegExp("(\\S+(?:\\s+\\S+){0,"+(t>0?t-1:7)+"})");r=r.replace(/\s+/g," ").match(n)}return r?r[1]+"…":"…"}},{key:"getExcerptFromText",value:function(e,t){if(""===e)return"";var r=new RegExp("(\\S+(?:\\s+\\S+){0,"+(t>0?t-1:7)+"})"),n=e.replace(/<<.*?>>/g," ").replace(/<.*?>/g," ").trim().replace(/^\s*\|.*\|.*?$/gm,"").replace(/\[[<>]?img\[[^\]]*\]\]/g,"").replace(/\[\[([^|\]]*?)(?:(?:\||->|<-)[^\]]*)?\]\]/g,"$1").replace(/^\s*!+(.*?)$/gm,"$1").replace(/'{2}|\/{2}|_{2}|@{2}/g,"").trim().replace(/\s+/g," ").match(r);return n?n[1]+"…":"…"}}]),t}()}(),Save=function(){function e(){if("cookie"===storage.name)return n(),Config.saves.autoload=undefined,Config.saves.autosave=undefined,Config.saves.isAllowed=undefined,Config.saves.onLoad=undefined,Config.saves.onSave=undefined,Config.saves.slots=0,!1;var e=r(),t=!1;Array.isArray(e)&&(e={autosave:null,slots:e},t=!0),Config.saves.slots!==e.slots.length&&(Config.saves.slots<e.slots.length?(e.slots.reverse(),e.slots=e.slots.filter(function(e){return!(null===e&&this.count>0)||(--this.count,!1)},{count:e.slots.length-Config.saves.slots}),e.slots.reverse()):Config.saves.slots>e.slots.length&&j(e.slots,Config.saves.slots-e.slots.length),t=!0),T(e.autosave)&&(t=!0);for(var a=0;a<e.slots.length;++a)T(e.slots[a])&&(t=!0);return x(e)&&(storage.delete("saves"),t=!1),t&&O(e),P=e.slots.length-1,!0}function t(){return{autosave:null,slots:j([],Config.saves.slots)}}function r(){var e=storage.get("saves");return null===e?t():e}function n(){return storage.delete("saves"),!0}function a(){return i()||d()}function i(){return"cookie"!==storage.name&&void 0!==Config.saves.autosave}function o(){return null!==r().autosave}function s(){return r().autosave}function u(){var e=r();return null!==e.autosave&&A(e.autosave)}function l(e,t){if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed())return!1;var n=r(),a={title:e||Story.get(State.passage).description(),date:Date.now()};return null!=t&&(a.metadata=t),n.autosave=C(a),O(n)}function c(){var e=r();return e.autosave=null,O(e)}function d(){return"cookie"!==storage.name&&-1!==P}function f(){return P+1}function p(){if(!d())return 0;for(var e=r(),t=0,n=0,a=e.slots.length;n<a;++n)null!==e.slots[n]&&++t;return t}function h(){return 0===p()}function g(e){if(e<0||e>P)return!1;var t=r();return!(e>=t.slots.length||null===t.slots[e])}function m(e){if(e<0||e>P)return null;var t=r();return e>=t.slots.length?null:t.slots[e]}function v(e){if(e<0||e>P)return!1;var t=r();return!(e>=t.slots.length||null===t.slots[e])&&A(t.slots[e])}function y(e,t,n){if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed())return Dialog.isOpen()?$(document).one(":dialogclosed",function(){return UI.alert(L10n.get("savesDisallowed"))}):UI.alert(L10n.get("savesDisallowed")),!1;if(e<0||e>P)return!1;var a=r();if(e>=a.slots.length)return!1;var i={title:t||Story.get(State.passage).description(),date:Date.now()};return null!=n&&(i.metadata=n),a.slots[e]=C(i),O(a)}function b(e){if(e<0||e>P)return!1;var t=r();return!(e>=t.slots.length)&&(t.slots[e]=null,O(t))}function w(e,t){if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed())return void(Dialog.isOpen()?$(document).one(":dialogclosed",function(){return UI.alert(L10n.get("savesDisallowed"))}):UI.alert(L10n.get("savesDisallowed")));var r=null==e?Story.domId:Util.slugify(e),n=r+"-"+function(){var e=new Date,t=e.getMonth()+1,r=e.getDate(),n=e.getHours(),a=e.getMinutes(),i=e.getSeconds();return t<10&&(t="0"+t),r<10&&(r="0"+r),n<10&&(n="0"+n),a<10&&(a="0"+a),i<10&&(i="0"+i),""+e.getFullYear()+t+r+"-"+n+a+i}()+".save",a=null==t?{}:{metadata:t},i=LZString.compressToBase64(JSON.stringify(C(a)));saveAs(new Blob([i],{type:"text/plain;charset=UTF-8"}),n)}function k(e){var t=e.target.files[0],r=new FileReader;jQuery(r).on("load",function(e){var r=e.currentTarget;if(r.result){var n=void 0;try{n=JSON.parse(/\.json$/i.test(t.name)||/^\{/.test(r.result)?r.result:LZString.decompressFromBase64(r.result))}catch(e){}A(n)}}),r.readAsText(t)}function S(e){if("function"==typeof Config.saves.isAllowed&&!Config.saves.isAllowed())return Dialog.isOpen()?$(document).one(":dialogclosed",function(){return UI.alert(L10n.get("savesDisallowed"))}):UI.alert(L10n.get("savesDisallowed")),null;var t=null==e?{}:{metadata:e};return LZString.compressToBase64(JSON.stringify(C(t)))}function E(e){var t=void 0;try{t=JSON.parse(LZString.decompressFromBase64(e))}catch(e){}return A(t)?t.metadata:null}function j(e,t){for(var r=0;r<t;++r)e.push(null);return e}function x(e){for(var t=e.slots,r=!0,n=0,a=t.length;n<a;++n)if(null!==t[n]){r=!1;break}return null===e.autosave&&r}function O(e){return x(e)?(storage.delete("saves"),!0):storage.set("saves",e)}function T(e){if(null==e||"object"!==(void 0===e?"undefined":_typeof(e)))return!1;var t=!1;return e.hasOwnProperty("state")&&e.state.hasOwnProperty("delta")&&e.state.hasOwnProperty("index")||(e.hasOwnProperty("data")?(delete e.mode,e.state={delta:State.deltaEncode(e.data)},delete e.data):e.state.hasOwnProperty("delta")?e.state.hasOwnProperty("index")||delete e.state.mode:(delete e.state.mode,e.state.delta=State.deltaEncode(e.state.history),delete e.state.history),e.state.index=e.state.delta.length-1,t=!0),e.state.hasOwnProperty("rseed")&&(e.state.seed=e.state.rseed,delete e.state.rseed,e.state.delta.forEach(function(e,t,r){r[t].hasOwnProperty("rcount")&&(r[t].pull=r[t].rcount,delete r[t].rcount)}),t=!0),(e.state.hasOwnProperty("expired")&&"number"==typeof e.state.expired||e.state.hasOwnProperty("unique")||e.state.hasOwnProperty("last"))&&(e.state.hasOwnProperty("expired")&&"number"==typeof e.state.expired&&delete e.state.expired,(e.state.hasOwnProperty("unique")||e.state.hasOwnProperty("last"))&&(e.state.expired=[],e.state.hasOwnProperty("unique")&&(e.state.expired.push(e.state.unique),delete e.state.unique),e.state.hasOwnProperty("last")&&(e.state.expired.push(e.state.last),delete e.state.last)),t=!0),t}function C(e){if(null!=e&&"object"!==(void 0===e?"undefined":_typeof(e)))throw new Error("supplemental parameter must be an object");var t=Object.assign({},e,{id:Config.saves.id,state:State.marshalForSave()});return Config.saves.version&&(t.version=Config.saves.version),"function"==typeof Config.saves.onSave&&Config.saves.onSave(t),t.state.delta=State.deltaEncode(t.state.history),delete t.state.history,t}function A(e){try{if(T(e),!e||!e.hasOwnProperty("id")||!e.hasOwnProperty("state"))throw new Error(L10n.get("errorSaveMissingData"));if(e.state.history=State.deltaDecode(e.state.delta),delete e.state.delta,"function"==typeof Config.saves.onLoad&&Config.saves.onLoad(e),e.id!==Config.saves.id)throw new Error(L10n.get("errorSaveIdMismatch"));State.unmarshalForSave(e.state),Engine.show()}catch(e){return UI.alert(e.message.toUpperFirst()+".</p><p>"+L10n.get("aborting")+"."),!1}return!0}var P=-1;return Object.freeze(Object.defineProperties({},{init:{value:e},get:{value:r},clear:{value:n},ok:{value:a},autosave:{value:Object.freeze(Object.defineProperties({},{ok:{value:i},has:{value:o},get:{value:s},load:{value:u},save:{value:l},delete:{value:c}}))},slots:{value:Object.freeze(Object.defineProperties({},{ok:{value:d},length:{get:f},isEmpty:{value:h},count:{value:p},has:{value:g},get:{value:m},load:{value:v},save:{value:y},delete:{value:b}}))},export:{value:w},import:{value:k},serialize:{value:S},deserialize:{value:E}}))}(),Setting=function(){function e(){if(storage.has("options")){var e=storage.get("options");null!==e&&(window.SugarCube.settings=settings=Object.assign(t(),e)),r(),storage.delete("options")}n(),m.forEach(function(e){if(e.hasOwnProperty("onInit")){var t={name:e.name,value:settings[e.name],default:e.default};e.hasOwnProperty("list")&&(t.list=e.list),e.onInit.call(t)}})}function t(){return Object.create(null)}function r(){var e=t();return Object.keys(settings).length>0&&m.filter(function(e){return e.type!==v.Header&&settings[e.name]!==e.default}).forEach(function(t){return e[t.name]=settings[t.name]}),0===Object.keys(e).length?(storage.delete("settings"),!0):storage.set("settings",e)}function n(){var e=t(),r=storage.get("settings")||t();m.filter(function(e){return e.type!==v.Header}).forEach(function(t){return e[t.name]=t.default}),window.SugarCube.settings=settings=Object.assign(e,r)}function a(){return window.SugarCube.settings=settings=t(),storage.delete("settings"),!0}function i(e){if(0===arguments.length)a(),n();else{if(null==e||!p(e))throw new Error('nonexistent setting "'+e+'"');var t=h(e);t.type!==v.Header&&(settings[e]=t.default)}return r()}function o(e,t){m.forEach(e,t)}function s(e,t,r){if(arguments.length<3){var n=[];throw arguments.length<1&&n.push("type"),arguments.length<2&&n.push("name"),arguments.length<3&&n.push("definition"),new Error("missing parameters, no "+n.join(" or ")+" specified")}if("object"!==(void 0===r?"undefined":_typeof(r)))throw new TypeError("definition parameter must be an object");if(p(t))throw new Error('cannot clobber existing setting "'+t+'"');var a={type:e,name:t,label:"string"==typeof r.label?r.label.trim():""};if("string"==typeof r.desc){var i=r.desc.trim();""!==i&&(a.desc=i)}switch(e){case v.Header:break;case v.Toggle:a.default=!!r.default;break;case v.List:if(!r.hasOwnProperty("list"))throw new Error("no list specified");if(!Array.isArray(r.list))throw new TypeError("list must be an array");if(0===r.list.length)throw new Error("list must not be empty");if(a.list=Object.freeze(r.list),null==r.default)a.default=r.list[0];else{var o=r.list.indexOf(r.default);if(-1===o)throw new Error("list does not contain default");a.default=r.list[o]}break;case v.Range:if(!r.hasOwnProperty("min"))throw new Error("no min specified");if("number"!=typeof r.min||Number.isNaN(r.min)||!Number.isFinite(r.min))throw new TypeError("min must be a finite number");if(!r.hasOwnProperty("max"))throw new Error("no max specified");if("number"!=typeof r.max||Number.isNaN(r.max)||!Number.isFinite(r.max))throw new TypeError("max must be a finite number");if(!r.hasOwnProperty("step"))throw new Error("no step specified");if("number"!=typeof r.step||Number.isNaN(r.step)||!Number.isFinite(r.step)||r.step<=0)throw new TypeError("step must be a finite number greater than zero");var s=function(){var e=String(r.step),t=e.lastIndexOf(".");return-1===t?0:e.length-t-1}();if(function(e){if(s>0){var t=Number(r.min+"e"+s),n=Number(r.step+"e"+s),a=Number(e+"e"+s)-t;return Number(a-a%n+t+"e-"+s)}var i=e-r.min;return i-i%r.step+r.min}(r.max)!==r.max)throw new RangeError("max ("+r.max+") is not a multiple of the step ("+r.step+") plus the min ("+r.min+")");if(a.max=r.max,a.min=r.min,a.step=r.step,null==r.default)a.default=r.max;else{if("number"!=typeof r.default||Number.isNaN(r.default)||!Number.isFinite(r.default))throw new TypeError("default must be a finite number");if(r.default<r.min)throw new RangeError("default ("+r.default+") is less than min ("+r.min+")");if(r.default>r.max)throw new RangeError("default ("+r.default+") is greater than max ("+r.max+")");a.default=r.default}break;default:throw new Error("unknown Setting type: "+e)}"function"==typeof r.onInit&&(a.onInit=Object.freeze(r.onInit)),"function"==typeof r.onChange&&(a.onChange=Object.freeze(r.onChange)),m.push(Object.freeze(a))}function u(e,t){s(v.Header,e,{desc:t})}function l(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];s.apply(undefined,[v.Toggle].concat(t))}function c(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];s.apply(undefined,[v.List].concat(t))}function d(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];s.apply(undefined,[v.Range].concat(t))}function f(){return 0===m.length}function p(e){return m.some(function(t){return t.name===e})}function h(e){return m.find(function(t){return t.name===e})}function g(e){p(e)&&delete settings[e];for(var t=0;t<m.length;++t)if(m[t].name===e){m.splice(t,1),g(e);break}}var m=[],v=Util.toEnum({Header:0,Toggle:1,List:2,Range:3});return Object.freeze(Object.defineProperties({},{Types:{value:v},init:{value:e},create:{value:t},save:{value:r},load:{value:n},clear:{value:a},reset:{value:i},forEach:{value:o},add:{value:s},addHeader:{value:u},addToggle:{value:l},addList:{value:c},addRange:{value:d},isEmpty:{value:f},has:{value:p},get:{value:h},delete:{value:g}}))}(),Story=function(){function e(){function e(e){if(e.tags.includesAny(n))throw new Error('starting passage "'+e.title+'" contains illegal tags; invalid: "'+e.tags.filter(function(e){return n.includes(e)}).sort().join('", "')+'"')}function t(e){if(a.includes(e.title)&&e.tags.includesAny(n))throw new Error('special passage "'+e.title+'" contains illegal tags; invalid: "'+e.tags.filter(function(e){return n.includes(e)}).sort().join('", "')+'"')}var n=["widget"],a=["PassageDone","PassageFooter","PassageHeader","PassageReady","StoryAuthor","StoryBanner","StoryCaption","StoryInit","StoryMenu","StoryShare","StorySubtitle"],i=jQuery("tw-storydata"),o=i.attr("startnode")||"";Config.passages.start=null,Config.debug=/\bdebug\b/.test(i.attr("options")),i.children("style").each(function(e){d.push(new Passage("tw-user-style-"+e,this))}),i.children("script").each(function(e){f.push(new Passage("tw-user-script-"+e,this))}),i.children('tw-passagedata:not([tags~="Twine.private"],[tags~="annotation"])').each(function(){var r=jQuery(this),n=r.attr("pid")||"",a=new Passage(r.attr("name"),this);n===o&&""!==o?(Config.passages.start=a.title,e(a),c[a.title]=a):a.tags.includes("widget")?p.push(a):(t(a),c[a.title]=a)}),g=i.attr("ifid"),r("Unholy Arts v0.3"),Config.saves.id=Story.domId}function t(){!function(){var e=document.createElement("style");new StyleWrapper(e).add(d.map(function(e){return e.text.trim()}).join("\n")),jQuery(e).appendTo(document.head).attr({id:"style-story",type:"text/css"})}();for(var e=0;e<f.length;++e)try{Scripting.evalJavaScript(f[e].text)}catch(t){console.error(t),Alert.error(f[e].title,"object"===(void 0===t?"undefined":_typeof(t))?t.message:t)}for(var t=0;t<p.length;++t)try{Wikifier.wikifyEval(p[t].processText())}catch(e){console.error(e),Alert.error(p[t].title,"object"===(void 0===e?"undefined":_typeof(e))?e.message:e)}}function r(e){if(null==e||""===e)throw new Error("story title cannot be null or empty");if(document.title=h=Util.unescape(e),""===(m=Util.slugify(h)))if(""!==g)m=g;else for(var t=0,r=h.length;t<r;++t){var n=Util.charAndPosAt(h,t),a=n.char,i=n.start,o=n.end;m+=a.codePointAt(0).toString(16),t+=o-i}}function n(){return h}function a(){return m}function i(){return g}function o(e){var t=void 0===e?"undefined":_typeof(e);switch(t){case"number":case"string":return c.hasOwnProperty(String(e));case"boolean":case"function":t="a "+t;break;case"undefined":break;default:t=null===e?"null":"an "+t}throw new TypeError("Story.has title parameter cannot be "+t)}function s(e){var t=void 0===e?"undefined":_typeof(e);switch(t){case"number":case"string":var r=String(e);return c.hasOwnProperty(r)?c[r]:new Passage(r||"(unknown)");case"boolean":case"function":t="a "+t;break;case"undefined":break;default:t=null===e?"null":"an "+t}throw new TypeError("Story.get title parameter cannot be "+t)}function u(e,t){for(var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"title",n=Object.keys(c),a=[],i=0;i<n.length;++i){var o=c[n[i]];if(o.hasOwnProperty(e))switch(_typeof(o[e])){case"undefined":break;case"object":o[e]instanceof Array&&o[e].some(function(e){return e==t})&&a.push(o);break;default:o[e]==t&&a.push(o)}}return a.sort(function(e,t){return e[r]==t[r]?0:e[r]<t[r]?-1:1}),a}function l(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"title";if("function"!=typeof e)throw new Error("Story.lookupWith filter parameter must be a function");for(var r=Object.keys(c),n=[],a=0;a<r.length;++a){var i=c[r[a]];e(i)&&n.push(i)}return n.sort(function(e,r){return e[t]==r[t]?0:e[t]<r[t]?-1:1}),n}var c={},d=[],f=[],p=[],h="",g="",m="";return Object.freeze(Object.defineProperties({},{passages:{value:c},styles:{value:d},scripts:{value:f},
widgets:{value:p},load:{value:e},init:{value:t},title:{get:n},domId:{get:a},ifId:{get:i},has:{value:o},get:{value:s},lookup:{value:u},lookupWith:{value:l}}))}(),UI=function(){function e(e,t){var r=t,n=Config.debug,a=Config.cleanupWikifierOutput;Config.debug=!1,Config.cleanupWikifierOutput=!1;try{null==r&&(r=document.createElement("ul"));var i=document.createDocumentFragment();new Wikifier(i,Story.get(e).processText().trim());var o=[].concat(_toConsumableArray(i.querySelectorAll(".error"))).map(function(e){return e.textContent.replace(errorPrologRegExp,"")});if(o.length>0)throw new Error(o.join("; "));for(;i.hasChildNodes();){var s=i.firstChild;if(s.nodeType===Node.ELEMENT_NODE&&"A"===s.nodeName.toUpperCase()){var u=document.createElement("li");r.appendChild(u),u.appendChild(s)}else i.removeChild(s)}}finally{Config.cleanupWikifierOutput=a,Config.debug=n}return r}function t(e){jQuery(Dialog.setup("Alert","alert")).append("<p>"+e+'</p><ul class="buttons"><li><button id="alert-ok" class="ui-close">'+L10n.get(["alertOk","ok"])+"</button></li></ul>");for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];Dialog.open.apply(Dialog,r)}function r(){u(),Dialog.open.apply(Dialog,arguments)}function n(){l(),Dialog.open.apply(Dialog,arguments)}function a(){c(),Dialog.open.apply(Dialog,arguments)}function i(){d(),Dialog.open.apply(Dialog,arguments)}function o(){f(),Dialog.open.apply(Dialog,arguments)}function s(){return jQuery(Dialog.setup(L10n.get("autoloadTitle"),"autoload")).append("<p>"+L10n.get("autoloadPrompt")+'</p><ul class="buttons"><li><button id="autoload-ok" class="ui-close">'+L10n.get(["autoloadOk","ok"])+'</button></li><li><button id="autoload-cancel" class="ui-close">'+L10n.get(["autoloadCancel","cancel"])+"</button></li></ul>"),jQuery(document).one("click.autoload",".ui-close",function(e){var t="autoload-ok"===e.target.id;jQuery(document).one(":dialogclosed",function(){t&&Save.autosave.load()||Engine.play(Config.passages.start)})}),!0}function u(){var e=document.createElement("ul");jQuery(Dialog.setup(L10n.get("jumptoTitle"),"jumpto list")).append(e);for(var t=State.expired.length,r=State.size-1;r>=0;--r)if(r!==State.activeIndex){var n=Story.get(State.history[r].title);n&&n.tags.includes("bookmark")&&jQuery(document.createElement("li")).append(jQuery(document.createElement("a")).ariaClick({one:!0},function(e){return function(){return jQuery(document).one(":dialogclosed",function(){return Engine.goTo(e)})}}(r)).addClass("ui-close").text(L10n.get("jumptoTurn")+" "+(t+r+1)+": "+n.description())).appendTo(e)}e.hasChildNodes()||jQuery(e).append("<li><a><em>"+L10n.get("jumptoUnavailable")+"</em></a></li>")}function l(){return jQuery(Dialog.setup(L10n.get("restartTitle"),"restart")).append("<p>"+L10n.get("restartPrompt")+'</p><ul class="buttons"><li><button id="restart-ok">'+L10n.get(["restartOk","ok"])+'</button></li><li><button id="restart-cancel" class="ui-close">'+L10n.get(["restartCancel","cancel"])+"</button></li></ul>").find("#restart-ok").ariaClick({one:!0},function(){jQuery(document).one(":dialogclosed",function(){return Engine.restart()}),Dialog.close()}),!0}function c(){function e(e,t,r,n){var a=jQuery(document.createElement("button")).attr("id","saves-"+e).html(r);return t&&a.addClass(t),n?a.ariaClick(n):a.ariaDisabled(!0),jQuery(document.createElement("li")).append(a)}var r=jQuery(Dialog.setup(L10n.get("savesTitle"),"saves")),n=Save.ok();if(n&&r.append(function(){function e(e,t,r,n,a){var i=jQuery(document.createElement("button")).attr("id","saves-"+e+"-"+n).addClass(e).html(r);return t&&i.addClass(t),a?"auto"===n?i.ariaClick({label:r+" "+L10n.get("savesLabelAuto")},function(){return a()}):i.ariaClick({label:r+" "+L10n.get("savesLabelSlot")+" "+(n+1)},function(){return a(n)}):i.ariaDisabled(!0),i}var t=Save.get(),r=jQuery(document.createElement("tbody"));if(Save.autosave.ok()){var n=jQuery(document.createElement("td")),a=jQuery(document.createElement("td")),i=jQuery(document.createElement("td")),o=jQuery(document.createElement("td"));jQuery(document.createElement("b")).attr({title:L10n.get("savesLabelAuto"),"aria-label":L10n.get("savesLabelAuto")}).text("A").appendTo(n),t.autosave?(a.append(e("load","ui-close",L10n.get("savesLabelLoad"),"auto",function(){jQuery(document).one(":dialogclosed",function(){return Save.autosave.load()})})),jQuery(document.createElement("div")).text(t.autosave.title).appendTo(i),jQuery(document.createElement("div")).addClass("datestamp").html(t.autosave.date?""+new Date(t.autosave.date).toLocaleString():"<em>"+L10n.get("savesUnknownDate")+"</em>").appendTo(i),o.append(e("delete",null,L10n.get("savesLabelDelete"),"auto",function(){Save.autosave.delete(),c()}))):(a.append(e("load",null,L10n.get("savesLabelLoad"),"auto")),i.addClass("empty").text("•  •  •"),o.append(e("delete",null,L10n.get("savesLabelDelete"),"auto"))),jQuery(document.createElement("tr")).append(n).append(a).append(i).append(o).appendTo(r)}for(var s=0,u=t.slots.length;s<u;++s){var l=jQuery(document.createElement("td")),d=jQuery(document.createElement("td")),f=jQuery(document.createElement("td")),p=jQuery(document.createElement("td"));l.append(document.createTextNode(s+1)),t.slots[s]?(d.append(e("load","ui-close",L10n.get("savesLabelLoad"),s,function(e){jQuery(document).one(":dialogclosed",function(){return Save.slots.load(e)})})),jQuery(document.createElement("div")).text(t.slots[s].title).appendTo(f),jQuery(document.createElement("div")).addClass("datestamp").html(t.slots[s].date?""+new Date(t.slots[s].date).toLocaleString():"<em>"+L10n.get("savesUnknownDate")+"</em>").appendTo(f),p.append(e("delete",null,L10n.get("savesLabelDelete"),s,function(e){Save.slots.delete(e),c()}))):(d.append(e("save","ui-close",L10n.get("savesLabelSave"),s,Save.slots.save)),f.addClass("empty").text("•  •  •"),p.append(e("delete",null,L10n.get("savesLabelDelete"),s))),jQuery(document.createElement("tr")).append(l).append(d).append(f).append(p).appendTo(r)}return jQuery(document.createElement("table")).attr("id","saves-list").append(r)}()),n||Has.fileAPI){var a=jQuery(document.createElement("ul")).addClass("buttons").appendTo(r);return Has.fileAPI&&(a.append(e("export","ui-close",L10n.get("savesLabelExport"),function(){return Save.export()})),a.append(e("import",null,L10n.get("savesLabelImport"),function(){return r.find("#saves-import-file").trigger("click")})),jQuery(document.createElement("input")).css({display:"block",visibility:"hidden",position:"fixed",left:"-9999px",top:"-9999px",width:"1px",height:"1px"}).attr({type:"file",id:"saves-import-file",tabindex:-1,"aria-hidden":!0}).on("change",function(e){jQuery(document).one(":dialogclosed",function(){return Save.import(e)}),Dialog.close()}).appendTo(r)),n&&a.append(e("clear",null,L10n.get("savesLabelClear"),Save.autosave.has()||!Save.slots.isEmpty()?function(){Save.clear(),c()}:null)),!0}return t(L10n.get("savesIncapable")),!1}function d(){var e=jQuery(Dialog.setup(L10n.get("settingsTitle"),"settings"));return Setting.forEach(function(t){if(t.type===Setting.Types.Header){var r=t.name,n=Util.slugify(r),a=jQuery(document.createElement("div")),i=jQuery(document.createElement("h2"));return a.attr("id","header-body-"+n).append(i).appendTo(e),i.attr("id","header-heading-"+n).wiki(r),void(t.desc&&jQuery(document.createElement("p")).attr("id","header-desc-"+n).wiki(t.desc).appendTo(a))}var o=t.name,s=Util.slugify(o),u=jQuery(document.createElement("div")),l=jQuery(document.createElement("label")),c=jQuery(document.createElement("div")),d=void 0;switch(jQuery(document.createElement("div")).append(l).append(c).appendTo(u),t.desc&&jQuery(document.createElement("p")).attr("id","setting-desc-"+s).wiki(t.desc).appendTo(u),l.attr({id:"setting-label-"+s,for:"setting-control-"+s}).wiki(t.label),null==settings[o]&&(settings[o]=t.default),t.type){case Setting.Types.Toggle:d=jQuery(document.createElement("button")),settings[o]?d.addClass("enabled").text(L10n.get("settingsOn")):d.text(L10n.get("settingsOff")),d.ariaClick(function(){settings[o]?(jQuery(this).removeClass("enabled").text(L10n.get("settingsOff")),settings[o]=!1):(jQuery(this).addClass("enabled").text(L10n.get("settingsOn")),settings[o]=!0),Setting.save(),t.hasOwnProperty("onChange")&&t.onChange.call({name:o,value:settings[o],default:t.default})});break;case Setting.Types.List:d=jQuery(document.createElement("select"));for(var f=0,p=t.list.length;f<p;++f)jQuery(document.createElement("option")).val(f).text(t.list[f]).appendTo(d);d.val(t.list.indexOf(settings[o])).attr("tabindex",0).on("change",function(){settings[o]=t.list[Number(this.value)],Setting.save(),t.hasOwnProperty("onChange")&&t.onChange.call({name:o,value:settings[o],default:t.default,list:t.list})});break;case Setting.Types.Range:d=jQuery(document.createElement("input")),d.attr({type:"range",min:t.min,max:t.max,step:t.step,value:settings[o],tabindex:0}).on("change input",function(){settings[o]=Number(this.value),Setting.save(),t.hasOwnProperty("onChange")&&t.onChange.call({name:o,value:settings[o],default:t.default,min:t.min,max:t.max,step:t.step})}).on("keypress",function(e){13===e.which&&(e.preventDefault(),d.trigger("change"))})}d.attr("id","setting-control-"+s).appendTo(c),u.attr("id","setting-body-"+s).appendTo(e)}),e.append('<ul class="buttons"><li><button id="settings-ok" class="ui-close">'+L10n.get(["settingsOk","ok"])+'</button></li><li><button id="settings-reset">'+L10n.get("settingsReset")+"</button></li></ul>").find("#settings-reset").ariaClick({one:!0},function(){jQuery(document).one(":dialogclosed",function(){Setting.reset(),window.location.reload()}),Dialog.close()}),!0}function f(){try{jQuery(Dialog.setup(L10n.get("shareTitle"),"share list")).append(e("StoryShare"))}catch(e){return console.error(e),Alert.error("StoryShare",e.message),!1}return!0}return Object.freeze(Object.defineProperties({},{assembleLinkList:{value:e},alert:{value:t},jumpto:{value:r},restart:{value:n},saves:{value:a},settings:{value:i},share:{value:o},buildAutoload:{value:s},buildJumpto:{value:u},buildRestart:{value:l},buildSaves:{value:c},buildSettings:{value:d},buildShare:{value:f},stow:{value:function(){return UIBar.stow()}},unstow:{value:function(){return UIBar.unstow()}},setStoryElements:{value:function(){return UIBar.update()}},isOpen:{value:function(){return Dialog.isOpen.apply(Dialog,arguments)}},body:{value:function(){return Dialog.body()}},setup:{value:function(){return Dialog.setup.apply(Dialog,arguments)}},addClickHandler:{value:function(){return Dialog.addClickHandler.apply(Dialog,arguments)}},open:{value:function(){return Dialog.open.apply(Dialog,arguments)}},close:{value:function(){return Dialog.close.apply(Dialog,arguments)}},resize:{value:function(){return Dialog.resize()}},buildDialogAutoload:{value:s},buildDialogJumpto:{value:u},buildDialogRestart:{value:l},buildDialogSaves:{value:c},buildDialogSettings:{value:d},buildDialogShare:{value:f},buildLinkListFromPassage:{value:e}}))}(),UIBar=function(){function e(){c&&(c.hide(),jQuery(document).off(".ui-bar"),jQuery(document.head).find("#style-ui-bar").remove(),c.remove(),c=null)}function t(){return c&&c.hide(),this}function r(){if(!document.getElementById("ui-bar")){var e=function(){var e=L10n.get("uiBarToggle"),t=L10n.get("uiBarBackward"),r=L10n.get("uiBarJumpto"),n=L10n.get("uiBarForward");return jQuery(document.createDocumentFragment()).append('<div id="ui-bar"><div id="ui-bar-tray"><button id="ui-bar-toggle" tabindex="0" title="'+e+'" aria-label="'+e+'"></button><div id="ui-bar-history"><button id="history-backward" tabindex="0" title="'+t+'" aria-label="'+t+'"></button><button id="history-jumpto" tabindex="0" title="'+r+'" aria-label="'+r+'"></button><button id="history-forward" tabindex="0" title="'+n+'" aria-label="'+n+'"></button></div></div><div id="ui-bar-body"><header id="title" role="banner"><div id="story-banner"></div><h1 id="story-title"></h1><div id="story-subtitle"></div><div id="story-title-separator"></div><p id="story-author"></p></header><div id="story-caption"></div><nav id="menu" role="navigation"><ul id="menu-story"></ul><ul id="menu-core"><li id="menu-item-saves"><a tabindex="0">'+L10n.get("savesTitle")+'</a></li><li id="menu-item-settings"><a tabindex="0">'+L10n.get("settingsTitle")+'</a></li><li id="menu-item-restart"><a tabindex="0">'+L10n.get("restartTitle")+'</a></li><li id="menu-item-share"><a tabindex="0">'+L10n.get("shareTitle")+"</a></li></ul></nav></div></div>")}();c=jQuery(e.find("#ui-bar").get(0)),e.insertBefore("body>script#script-sugarcube"),jQuery(document).on(":historyupdate.ui-bar",function(e,t){return function(){e.ariaDisabled(State.length<2),t.ariaDisabled(State.length===State.size)}}(jQuery("#history-backward"),jQuery("#history-forward")))}}function n(){return c&&"none"===c.css("display")}function a(){return c&&c.hasClass("stowed")}function i(){return c&&c.show(),this}function o(){c&&(("boolean"==typeof Config.ui.stowBarInitially?Config.ui.stowBarInitially:jQuery(window).width()<=Config.ui.stowBarInitially)&&function(){var e=jQuery(c).add("#story");e.addClass("no-transition"),c.addClass("stowed"),setTimeout(function(){return e.removeClass("no-transition")},Engine.minDomActionDelay)}(),jQuery("#ui-bar-toggle").ariaClick({label:L10n.get("uiBarToggle")},function(){return c.toggleClass("stowed")}),Config.history.controls?(jQuery("#history-backward").ariaDisabled(State.length<2).ariaClick({label:L10n.get("uiBarBackward")},function(){return Engine.backward()}),Story.lookup("tags","bookmark").length>0?jQuery("#history-jumpto").ariaClick({label:L10n.get("uiBarJumpto")},function(){return UI.jumpto()}):jQuery("#history-jumpto").remove(),jQuery("#history-forward").ariaDisabled(State.length===State.size).ariaClick({label:L10n.get("uiBarForward")},function(){return Engine.forward()})):jQuery("#ui-bar-history").remove(),jQuery("#story-title").text(Story.title),Story.has("StoryCaption")||jQuery("#story-caption").remove(),Story.has("StoryMenu")||jQuery("#menu-story").remove(),Config.ui.updateStoryElements||l(),jQuery("#menu-item-saves a").ariaClick(function(e){e.preventDefault(),UI.buildSaves(),Dialog.open()}).text(L10n.get("savesTitle")),Setting.isEmpty()?jQuery("#menu-item-settings").remove():jQuery("#menu-item-settings a").ariaClick(function(e){e.preventDefault(),UI.buildSettings(),Dialog.open()}).text(L10n.get("settingsTitle")),jQuery("#menu-item-restart a").ariaClick(function(e){e.preventDefault(),UI.buildRestart(),Dialog.open()}).text(L10n.get("restartTitle")),Story.has("StoryShare")?jQuery("#menu-item-share a").ariaClick(function(e){e.preventDefault(),UI.buildShare(),Dialog.open()}).text(L10n.get("shareTitle")):jQuery("#menu-item-share").remove())}function s(e){if(c&&!c.hasClass("stowed")){var t=void 0;e&&(t=jQuery("#story"),t.addClass("no-transition"),c.addClass("no-transition")),c.addClass("stowed"),e&&setTimeout(function(){t.removeClass("no-transition"),c.removeClass("no-transition")},Engine.minDomActionDelay)}return this}function u(e){if(c&&c.hasClass("stowed")){var t=void 0;e&&(t=jQuery("#story"),t.addClass("no-transition"),c.addClass("no-transition")),c.removeClass("stowed"),e&&setTimeout(function(){t.removeClass("no-transition"),c.removeClass("no-transition")},Engine.minDomActionDelay)}return this}function l(){if(c){setPageElement("story-banner","StoryBanner"),setPageElement("story-subtitle","StorySubtitle"),setPageElement("story-author","StoryAuthor"),setPageElement("story-caption","StoryCaption");var e=document.getElementById("menu-story");if(null!==e&&(jQuery(e).empty(),Story.has("StoryMenu")))try{UI.assembleLinkList("StoryMenu",e)}catch(e){console.error(e),Alert.error("StoryMenu",e.message)}}}var c=null;return Object.freeze(Object.defineProperties({},{destroy:{value:e},hide:{value:t},init:{value:r},isHidden:{value:n},isStowed:{value:a},show:{value:i},start:{value:o},stow:{value:s},unstow:{value:u},update:{value:l},setStoryElements:{value:l}}))}(),DebugBar=function(){function e(){var e=L10n.get("debugBarToggle"),t=L10n.get("debugBarAddWatch"),o=L10n.get("debugBarWatchAll"),u=L10n.get("debugBarWatchNone"),c=L10n.get("debugBarWatchToggle"),h=L10n.get("debugBarViewsToggle");jQuery(document.createDocumentFragment()).append('<div id="debug-bar"><div id="debug-bar-watch" aria-hidden="true" hidden="hidden"><div>'+L10n.get("debugBarNoWatches")+'</div>></div><div><button id="debug-bar-watch-toggle" tabindex="0" title="'+c+'" aria-label="'+c+'">'+L10n.get("debugBarLabelWatch")+'</button><label id="debug-bar-watch-label" for="debug-bar-watch-input">'+L10n.get("debugBarLabelAdd")+'</label><input id="debug-bar-watch-input" name="debug-bar-watch-input" type="text" list="debug-bar-watch-list" tabindex="0"><datalist id="debug-bar-watch-list" aria-hidden="true" hidden="hidden"></datalist><button id="debug-bar-watch-add" tabindex="0" title="'+t+'" aria-label="'+t+'"></button><button id="debug-bar-watch-all" tabindex="0" title="'+o+'" aria-label="'+o+'"></button><button id="debug-bar-watch-none" tabindex="0" title="'+u+'" aria-label="'+u+'"></button></div><div><button id="debug-bar-views-toggle" tabindex="0" title="'+h+'" aria-label="'+h+'">'+L10n.get("debugBarLabelViews")+'</button><label id="debug-bar-turn-label" for="debug-bar-turn-select">'+L10n.get("debugBarLabelTurn")+'</label><select id="debug-bar-turn-select" tabindex="0"></select></div><button id="debug-bar-toggle" tabindex="0" title="'+e+'" aria-label="'+e+'"></button></div><div id="debug-bar-hint"></div>').appendTo("body"),y=jQuery("#debug-bar"),b=jQuery(y.find("#debug-bar-watch").get(0)),w=jQuery(y.find("#debug-bar-watch-list").get(0)),k=jQuery(y.find("#debug-bar-turn-select").get(0));var g=jQuery(y.find("#debug-bar-toggle").get(0)),m=jQuery(y.find("#debug-bar-watch-toggle").get(0)),v=jQuery(y.find("#debug-bar-watch-input").get(0)),E=jQuery(y.find("#debug-bar-watch-add").get(0)),j=jQuery(y.find("#debug-bar-watch-all").get(0)),x=jQuery(y.find("#debug-bar-watch-none").get(0)),O=jQuery(y.find("#debug-bar-views-toggle").get(0));g.ariaClick(function(){S?n():r(),S=!S,l()}),m.ariaClick(function(){b.attr("hidden")?b.removeAttr("aria-hidden hidden"):b.attr({"aria-hidden":!0,hidden:"hidden"}),l()}),v.on(":addwatch",function(){a(this.value.trim()),this.value=""}).on("keypress",function(e){13===e.which&&(e.preventDefault(),v.trigger(":addwatch"))}),E.ariaClick(function(){return v.trigger(":addwatch")}),j.ariaClick(i),x.ariaClick(s),k.on("change",function(){Engine.goTo(Number(this.value))}),O.ariaClick(function(){DebugView.toggle(),l()}),jQuery(document).on(":historyupdate.debug-bar",p).on(":passageend.debug-bar",function(){d(),f()}).on(":enginerestart.debug-bar",function(){session.delete("debugState")})}function t(){u(),c(),p(),d(),f()}function r(){y.css("right","-"+y.outerWidth()+"px"),l()}function n(){y.css("right",0),l()}function a(e){g.test(e)&&(v.pushUnique(e),v.sort(),d(),f(),l())}function i(){Object.keys(State.variables).map(function(e){return v.pushUnique("$"+e)}),Object.keys(State.temporary).map(function(e){return v.pushUnique("_"+e)}),v.sort(),d(),f(),l()}function o(e){v.delete(e),d(),f(),l()}function s(){for(var e=v.length-1;e>=0;--e)v.pop();d(),f(),l()}function u(){if(session.has("debugState")){var e=session.get("debugState");S=e.stowed,v.push.apply(v,_toConsumableArray(e.watchList)),e.watchEnabled?b.removeAttr("aria-hidden hidden"):b.attr({"aria-hidden":!0,hidden:"hidden"}),e.viewsEnabled?DebugView.enable():DebugView.disable()}}function l(){session.set("debugState",{stowed:S,watchList:v,watchEnabled:!b.attr("hidden"),viewsEnabled:DebugView.isEnabled()})}function c(){S?r():n()}function d(){if(0===v.length)return void b.empty().append("<div>"+L10n.get("debugBarNoWatches")+"</div>");for(var e=L10n.get("debugBarDeleteWatch"),t=jQuery(document.createElement("table")),r=jQuery(document.createElement("tbody")),n=0,a=v.length;n<a;++n)!function(t,n){var a=v[t],i=a.slice(1),s="$"===a[0]?State.variables:State.temporary,u=jQuery(document.createElement("tr")),l=jQuery(document.createElement("button")),c=jQuery(document.createElement("code"));l.addClass("watch-delete").attr("data-name",a).ariaClick({one:!0,label:e},function(){return o(a)}),c.text(h(s[i])),jQuery(document.createElement("td")).append(l).appendTo(u),jQuery(document.createElement("td")).text(a).appendTo(u),jQuery(document.createElement("td")).append(c).appendTo(u),u.appendTo(r)}(n);t.append(r),b.empty().append(t)}function f(){var e=Object.keys(State.variables),t=Object.keys(State.temporary);if(0===e.length&&0===t.length)return void w.empty();var r=[].concat(_toConsumableArray(e.map(function(e){return"$"+e})),_toConsumableArray(t.map(function(e){return"_"+e}))).sort(),n=document.createDocumentFragment();r.delete(v);for(var a=0,i=r.length;a<i;++a)jQuery(document.createElement("option")).val(r[a]).appendTo(n);w.empty().append(n)}function p(){for(var e=State.size,t=State.expired.length,r=document.createDocumentFragment(),n=0;n<e;++n)jQuery(document.createElement("option")).val(n).text(t+n+1+". "+Util.escape(State.history[n].title)).appendTo(r);k.empty().ariaDisabled(e<2).append(r).val(State.activeIndex)}function h(e){if(null===e)return"null";switch(void 0===e?"undefined":_typeof(e)){case"number":if(Number.isNaN(e))return"NaN";if(!Number.isFinite(e))return"Infinity";case"boolean":case"symbol":case"undefined":return String(e);case"string":return JSON.stringify(e);case"function":return"Function"}var t=Util.toStringTag(e);if("Date"===t)return"Date {"+e.toLocaleString()+"}";if("RegExp"===t)return"RegExp "+e.toString();var r=[];if(e instanceof Array||e instanceof Set){for(var n=e instanceof Array?e:Array.from(e),a=0,i=n.length;a<i;++a)r.push(n.hasOwnProperty(a)?h(n[a]):"<empty>");return Object.keys(n).filter(function(e){return!m.test(e)}).forEach(function(e){return r.push(h(e)+": "+h(n[e]))}),t+"("+n.length+") ["+r.join(", ")+"]"}return e instanceof Map?(e.forEach(function(e,t){return r.push(h(t)+" → "+h(e))}),t+"("+e.size+") {"+r.join(", ")+"}"):(Object.keys(e).forEach(function(t){return r.push(h(t)+": "+h(e[t]))}),t+" {"+r.join(", ")+"}")}var g=new RegExp("^"+Patterns.variable+"$"),m=/^\d+$/,v=[],y=null,b=null,w=null,k=null,S=!0;return Object.freeze(Object.defineProperties({},{init:{value:e},start:{value:t},stow:{value:r},unstow:{value:n},watch:{value:a},watchAll:{value:i},unwatch:{value:o},unwatchAll:{value:s}}))}(),LoadScreen=function(){function e(){jQuery(document).on("readystatechange.SugarCube",function(){o.size>0||("complete"===document.readyState?"loading"===jQuery(document.documentElement).attr("data-init")&&(Config.loadDelay>0?setTimeout(function(){0===o.size&&r()},Math.max(Engine.minDomActionDelay,Config.loadDelay)):r()):n())})}function t(){jQuery(document).off("readystatechange.SugarCube"),o.clear(),r()}function r(){jQuery(document.documentElement).removeAttr("data-init")}function n(){jQuery(document.documentElement).attr("data-init","loading")}function a(){return++s,o.add(s),n(),s}function i(e){if(null==e)throw new Error("LoadScreen.unlock called with a null or undefined ID");o.has(e)&&o.delete(e),0===o.size&&jQuery(document).trigger("readystatechange")}var o=new Set,s=0;return Object.freeze(Object.defineProperties({},{init:{value:e},clear:{value:t},hide:{value:r},show:{value:n},lock:{value:a},unlock:{value:i}}))}(),version=Object.freeze({title:"SugarCube",major:2,minor:30,patch:0,prerelease:null,build:9082,date:new Date("2019-09-26T20:43:20.257Z"),extensions:{},toString:function(){var e=this.prerelease?"-"+this.prerelease:"";return this.major+"."+this.minor+"."+this.patch+e+"+"+this.build},short:function(){var e=this.prerelease?"-"+this.prerelease:"";return this.title+" (v"+this.major+"."+this.minor+"."+this.patch+e+")"},long:function(){return this.title+" v"+this.toString()+" ("+this.date.toUTCString()+")"}}),TempState={},macros={},postdisplay={},postrender={},predisplay={},prehistory={},prerender={},session=null,settings={},setup={},storage=null,browser=Browser,config=Config,has=Has,History=State,state=State,tale=Story,TempVariables=State.temporary;window.SugarCube={},jQuery(function(){try{var e=LoadScreen.lock();LoadScreen.init(),document.normalize&&document.normalize(),Story.load(),storage=SimpleStore.create(Story.domId,!0),session=SimpleStore.create(Story.domId,!1),Dialog.init(),UIBar.init(),Engine.init(),Story.init(),L10n.init(),session.has("rcWarn")||"cookie"!==storage.name||(session.set("rcWarn",1),window.alert(L10n.get("warningNoWebStorage"))),Save.init(),Setting.init(),Macro.init(),Engine.start(),Config.debug&&DebugBar.init();var t=$(window),r=setInterval(function(){t.width()&&(clearInterval(r),setTimeout(function(){UIBar.start(),Config.debug&&DebugBar.start(),LoadScreen.unlock(e)},Engine.minDomActionDelay))},Engine.minDomActionDelay);window.SugarCube={Browser:Browser,Config:Config,Dialog:Dialog,Engine:Engine,Has:Has,L10n:L10n,Macro:Macro,Passage:Passage,Save:Save,Scripting:Scripting,Setting:Setting,SimpleAudio:SimpleAudio,State:State,Story:Story,UI:UI,UIBar:UIBar,DebugBar:DebugBar,Util:Util,Visibility:Visibility,Wikifier:Wikifier,session:session,settings:settings,setup:setup,storage:storage,version:version}}catch(e){return console.error(e),LoadScreen.clear(),Alert.fatal(null,e.message,e)}})}(window,window.document,jQuery);}
	</script>
</body>
</html>
